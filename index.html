
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ ğŸ‡¸ğŸ‡© | SDM Token</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --navy: #131921; --orange: #febd69; --bg: #f0f2f5; --blue: #1a73e8; --green: #2ecc71; --red: #e74c3c; --gold: #ffd700; --crypto: #627eea; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; direction: rtl; }
        .hidden { display: none !important; }
        header { background: var(--navy); padding: 15px; color: white; text-align: center; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: center; }
        .nav-bar { background: #232f3e; color: white; padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
        .sdm-bar { background: linear-gradient(90deg, #131921, #1e3a8a); color: white; padding: 8px; text-align: center; font-size: 13px; border-bottom: 2px solid var(--gold); }
        .sdm-link { color: var(--gold); text-decoration: none; font-weight: bold; border: 1px solid var(--gold); padding: 2px 8px; border-radius: 4px; margin-right: 5px; }

        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px; }
        .card { background: white; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; border: 1px solid #ddd; }
        .post { background: white; margin: 15px; border-radius: 15px; overflow: hidden; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .sold-tag { position: absolute; top: 40%; left: 10%; transform: rotate(-15deg); background: var(--red); color: white; padding: 5px 15px; font-weight: bold; border-radius: 5px; z-index: 5; }
        input, select, textarea { width: 90%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; }
        .btn-main { background: var(--blue); color: white; border: none; padding: 12px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-crypto { background: var(--crypto); color: white; text-decoration: none; display: block; text-align: center; padding: 10px; border-radius: 8px; margin-top: 10px; font-weight: bold; }
        .btn-wa { background: var(--green); color: white; text-decoration: none; display: block; text-align: center; padding: 10px; border-radius: 8px; margin-top: 5px; font-weight: bold; }
        .vip-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px; background: #fffdeb; }
        .vip-card { background: white; border: 2px solid var(--gold); border-radius: 10px; padding: 8px; position: relative; }
        .online-dot { width: 10px; height: 10px; background: var(--green); border-radius: 50%; display: inline-block; margin-left: 5px; border: 2px solid white; }
        .stars { color: var(--gold); font-weight: bold; }
        .bottom-tabs { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; padding: 10px 0; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .tab-btn { flex: 1; text-align: center; font-size: 14px; cursor: pointer; color: #555; font-weight: bold; transition: 0.3s; }
        .tab-btn i { font-size: 20px; display: block; margin-bottom: 2px; color: var(--navy); }
        .profile-pic { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--blue); margin-bottom: 10px; }
    </style>
</head>
<body onload="checkAuth()">

<div id="auth-screen">
    <div style="padding:40px; text-align:center;">
        <h2>Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† ğŸ‡¸ğŸ‡©</h2>
        <div id="reg-box">
            <div id="pic-preview"></div>
            <input type="text" id="rn" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
            <input type="tel" id="rp" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
            <input type="password" id="rs" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
            <p style="font-size: 12px; color: #666;">Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ:</p>
            <input type="file" id="r-pic" onchange="encodeProfile(this)">
            <button class="btn-main" onclick="doRegister()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
            <p onclick="toggleAuth(true)" style="cursor:pointer; color:var(--blue)">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø¯Ø®ÙˆÙ„</p>
        </div>
        <div id="log-box" class="hidden">
            <input type="tel" id="lp" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
            <input type="password" id="ls" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
            <button class="btn-main" onclick="doLogin()">Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±</button>
            <p onclick="toggleAuth(false)" style="cursor:pointer; color:var(--blue)">Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ØŸ Ø³Ø¬Ù„ Ù‡Ù†Ø§</p>
        </div>
    </div>
</div>

<div id="app-screen" class="hidden">
    <header>
        <span onclick="goBack()" style="font-size:24px; cursor:pointer">ğŸ“±</span>
        <b>Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†</b>
        <span id="my-stars" class="stars"></span>
    </header>

    <div class="sdm-bar">
        ğŸ’° Ø¹Ù…Ù„Ø© Ø§Ù„Ø³ÙˆØ¯Ø§Ù† Ù…Ø§Ø±ÙƒØª (SDM) Ø­ÙŠØ© Ø§Ù„Ø¢Ù†! 
        <a href="https://pump.fun/BWK9RnTo4XWvM66pQ61nNUnCid7tL6R65UvLhM1Bv7sN" target="_blank" class="sdm-link">Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø© ğŸš€</a>
    </div>

    <div id="admin-panel" class="hidden" style="background:#ffebee; padding:15px; border:2px solid red; margin:10px; border-radius:10px;">
        <h4 style="margin:0; color:red;">Ø¥Ø¯Ø§Ø±Ø© Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¹Ø·ÙŠ</h4>
        <div id="admin-list"></div>
    </div>

    <div class="nav-bar">
        <span onclick="goBack()" style="cursor:pointer">ğŸ”™ Ø¹ÙˆØ¯Ø©</span>
        <b id="p-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</b>
        <span onclick="doLogout()" style="color:var(--red); cursor:pointer">Ø®Ø±ÙˆØ¬</span>
    </div>

    <div id="main-view"></div>

    <div class="bottom-tabs">
        <div class="tab-btn" onclick="nav('home')"><i class="fas fa-home"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="tab-btn" onclick="nav('vip')"><i class="fas fa-gem" style="color: gold;"></i>VIP</div>
        <div class="tab-btn" onclick="nav('profile')"><i class="fas fa-user-circle"></i>Ù…Ù„ÙÙŠ</div>
    </div>
</div>

<script>
    // Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ø¹Ù…Ù„ØªÙƒ Ø¹Ù„Ù‰ Pump.fun
    const SDM_URL = "https://pump.fun/BWK9RnTo4XWvM66pQ61nNUnCid7tL6R65UvLhM1Bv7sN";
    // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù‚Ø¯ (CA) Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
    const SDM_CA = "BWK9RnTo4XWvM66pQ61nNUnCid7tL6R65UvLhM1Bv7sN";

    const firebaseConfig = { databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const ADMIN = "0126205674";
    let me = null, tempImg = '', profileImg = '', curC = '', curS = '', hStack = JSON.parse(localStorage.getItem('hStack')) || ['home'];

    const cats = {
        "Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„Ø§Øª": {i: "ğŸ“±", s: ["Ø¢ÙŠÙÙˆÙ†", "Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬", "Ù‡ÙˆÙ†Ø±", "ØªÙƒÙ†Ùˆ", "Ø´Ø§ÙˆÙ…ÙŠ"]},
        "Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª": {i: "ğŸš—", s: ["ØªÙˆÙŠÙˆØªØ§", "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "ÙƒÙŠØ§", "Ø£ÙƒØ³Ù†Øª"]},
        "Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª": {i: "ğŸ ", s: ["Ø´Ù‚Ù‚", "Ø¨ÙŠÙˆØª", "Ø£Ø±Ø§Ø¶ÙŠ"]},
        "Ø§Ù„Ù…Ù„Ø§Ø¨Ø³": {i: "ğŸ‘•", s: ["Ø±Ø¬Ø§Ù„ÙŠ", "Ù†Ø³Ø§Ø¦ÙŠ"]},
        "Ø£Ø¯ÙˆØ§Øª Ù…Ù†Ø²Ù„ÙŠØ©": {i: "ğŸ“º", s: ["Ø«Ù„Ø§Ø¬Ø§Øª", "Ù…ÙƒÙŠÙØ§Øª"]},
        "Ø§Ù„Ù…ØºÙ„Ù‚": {i: "âš¡", s: ["ÙƒÙ‡Ø±Ø¨Ø§Ø¡", "Ø³Ø¨Ø§ÙƒØ©"]},
        "ÙƒÙ…Ø¨ÙŠÙˆØªØ±": {i: "ğŸ’»", s: ["Ù„Ø§Ø¨ØªÙˆØ¨"]},
        "Ø®Ø¯Ù…Ø§Øª": {i: "ğŸ› ï¸", s: ["ØµÙŠØ§Ù†Ø©"]},
        "ÙˆØ¸Ø§Ø¦Ù": {i: "ğŸ’¼", s: ["Ø¨Ø­Ø«"]},
        "Ø£Ø«Ø§Ø«": {i: "ğŸ›‹ï¸", s: ["Ø³Ø±Ø§ÙŠØ±"]},
        "Ø­ÙŠÙˆØ§Ù†Ø§Øª": {i: "ğŸ‘", s: ["Ø®Ø±Ø§Ù"]},
        "ØªØ¬Ù…ÙŠÙ„": {i: "ğŸ’„", s: ["Ø¹Ø·ÙˆØ±"]},
        "Ø£Ù„Ø¹Ø§Ø¨": {i: "ğŸ®", s: ["Ø³ÙˆÙ†ÙŠ"]},
        "Ø²Ø±Ø§Ø¹Ø©": {i: "ğŸŒ±", s: ["Ø¨Ø°ÙˆØ±"]},
        "Ø·Ø¨ÙŠØ©": {i: "ğŸ¥", s: ["Ø£Ø¬Ù‡Ø²Ø©"]},
        "Ø±Ø­Ù„Ø§Øª": {i: "ğŸšŒ", s: ["ØªØ°Ø§ÙƒØ±"]},
        "ÙƒØªØ¨": {i: "ğŸ“š", s: ["Ø±ÙˆØ§ÙŠØ§Øª"]},
        "Ù…ØµØ§Ù†Ø¹": {i: "ğŸ­", s: ["Ù…ÙˆÙ„Ø¯Ø§Øª"]},
        "Ø¯Ø±Ø§Ø¬Ø§Øª": {i: "ğŸï¸", s: ["Ù…ÙˆØ§ØªØ±"]},
        "Ø£Ø®Ø±Ù‰": {i: "ğŸ“¦", s: ["Ù…Ù†ÙˆØ¹Ø§Øª"]}
    };

    function checkAuth() {
        const s = localStorage.getItem('user_sd');
        if(s) {
            me = JSON.parse(s);
            db.ref('users/'+me.p).on('value', snap => {
                if(snap.exists()) {
                    me = snap.val();
                    if(me.status === 'banned' && me.banUntil > Date.now()) {
                        document.body.innerHTML = `<div style="text-align:center; padding:50px;"><h2>Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù‚ÙŠØ¯ Ù…Ø¤Ù‚ØªØ§Ù‹</h2><p>Ø¨Ø³Ø¨Ø¨ ÙƒØ«Ø±Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§ØªØŒ ØªÙ… ØªÙ‚ÙŠÙŠØ¯ Ø­Ø³Ø§Ø¨Ùƒ Ø­ØªÙ‰ ${new Date(me.banUntil).toLocaleString()}</p></div>`;
                        return;
                    }
                    db.ref('users/'+me.p).update({ online: true, lastSeen: Date.now() });
                    db.ref('users/'+me.p).onDisconnect().update({ online: false });
                    
                    let statusLabel = me.rating >= 100 ? ' <span class="badge-pro">Ù…Ù…ÙŠØ²</span>' : (me.rating >= 50 ? ' <span class="badge-good">Ø¬ÙŠØ¯</span>' : '');
                    document.getElementById('my-stars').innerHTML = 'â­'.repeat(Math.min(5, Math.floor(me.rating/10) || 1)) + ` (${me.rating})${statusLabel}`;
                    
                    if(me.p === ADMIN) { document.getElementById('admin-panel').classList.remove('hidden'); loadAdmin(); }
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app-screen').classList.remove('hidden');
                    render(hStack[hStack.length-1]);
                }
            });
        }
    }

    async function doRegister() {
        const n=document.getElementById('rn').value, p=document.getElementById('rp').value, s=document.getElementById('rs').value;
        if(!n || !p || !s) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','warning');
        
        const snap = await db.ref('users').once('value');
        let exists = false;
        snap.forEach(u => { if(u.key === p || u.val().n === n) exists = true; });
        if(exists) return Swal.fire('Ø®Ø·Ø£','Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹','error');

        const user = { n, p, ps:s, rating:0, reports:0, vipStatus:'none', online: true, pic: profileImg || 'https://via.placeholder.com/150' };
        await db.ref('users/'+p).set(user);
        localStorage.setItem('user_sd', JSON.stringify(user));
        window.location.replace(window.location.href);
    }

    function doLogin() {
        const p=document.getElementById('lp').value, s=document.getElementById('ls').value;
        db.ref('users/'+p).once('value', snap => {
            if(snap.exists() && snap.val().ps === s) {
                localStorage.setItem('user_sd', JSON.stringify(snap.val()));
                window.location.replace(window.location.href);
            } else Swal.fire('Ø®Ø·Ø£','Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©','error');
        });
    }

    function doLogout() {
        db.ref('users/'+me.p).update({ online: false }).then(() => {
            localStorage.clear();
            window.location.replace(window.location.href);
        });
    }

    function nav(page, data=null) {
        if(hStack[hStack.length-1] !== page) hStack.push(page);
        localStorage.setItem('hStack', JSON.stringify(hStack));
        render(page, data);
    }

    function goBack() {
        if(hStack.length > 1) { 
            hStack.pop(); 
            localStorage.setItem('hStack', JSON.stringify(hStack)); 
            render(hStack[hStack.length-1]); 
        }
    }

    function render(view, extra) {
        const area = document.getElementById('main-view');
        document.getElementById('p-title').innerText = view;
        
        if(view === 'home') {
            area.innerHTML = `
                <div style="padding:10px; font-weight:bold;">ğŸ’ Ø¹Ø±ÙˆØ¶ VIP Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</div>
                <div class="vip-grid" id="vg"></div>
                <div class="grid" id="cg"></div>`;
            document.getElementById('cg').innerHTML = Object.keys(cats).map(k => `<div class="card" onclick="nav('sub','${k}')"><span>${cats[k].i}</span><br><b>${k}</b></div>`).join('');
            loadVipHome();
        } else if(view === 'sub') {
            curC = extra || curC;
            area.innerHTML = `<div class="grid">${cats[curC].s.map(s => `<div class="card" onclick="nav('feed','${s}')"><b>${s}</b></div>`).join('')}</div>`;
        } else if(view === 'feed') {
            curS = extra || curS;
            area.innerHTML = `<div style="padding:15px; background:white; margin:10px; border-radius:12px;">
                <h4>Ù†Ø´Ø± ÙÙŠ ${curS}</h4>
                <input id="pt" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬"><input id="pp" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                <input id="ph" placeholder="Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„ØªÙˆØ§ØµÙ„" value="${me.p}">
                <textarea id="pd" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬"></textarea>
                <input type="file" onchange="encode(this)"><button class="btn-main" onclick="publish()">Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
            </div><div id="pl"></div>`;
            loadPosts(curS);
        } else if(view === 'vip') renderVipView(area);
        else if(view === 'profile') openProfile(extra || me.p);
    }

    function publish() {
        const t=document.getElementById('pt').value, p=document.getElementById('pp').value, h=document.getElementById('ph').value, d=document.getElementById('pd').value;
        if(!t || !tempImg) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø·Ù„ÙˆØ¨Ø§Ù†','warning');
        db.ref('posts').push({ t, pr:p, ph:h, de:d, img:tempImg, uP:me.p, uN:me.n, sub:curS, sold:false, uRating:me.rating, createdAt: Date.now() });
        Swal.fire('ØªÙ…','Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­','success');
    }

    function loadPosts(s) {
        db.ref('posts').on('value', snap => {
            const l = document.getElementById('pl'); if(!l) return; l.innerHTML = "";
            snap.forEach(c => { if(c.val().sub === s) renderCard(c.val(), l, c.key, false); });
        });
    }

    function renderCard(p, area, key, isVip) {
        let coms = ""; if(p.comments) Object.values(p.comments).forEach(c => coms += `<div><b>${c.uN}:</b> ${c.txt}</div>`);
        const stars = 'â­'.repeat(Math.min(5, Math.floor(p.uRating/10) || 1));
        const time = new Date(p.createdAt).toLocaleTimeString('ar-EG', {hour:'2-digit', minute:'2-digit'});

        area.insertAdjacentHTML('afterbegin', `<div class="post">
            ${p.sold ? '<div class="sold-tag">ØªÙ… Ø§Ù„Ø¨ÙŠØ¹</div>' : ''}
            <div style="padding:10px; display:flex; align-items:center;">
                <div id="dot-${key}"></div><b onclick="nav('profile','${p.uP}')" style="cursor:pointer">${p.uN}</b> <span class="stars">${stars}</span>
                <div style="flex:1"></div>
                <button onclick="reportPost('${p.uP}','${key}')" style="color:red; background:none; border:none; font-size:12px;"><i class="fas fa-flag"></i> Ø¨Ù„Ø§Øº</button>
                ${p.uP===me.p?`<button onclick="manage('${key}',${p.sold},${isVip})">â‹®</button>`:''}
            </div>
            <img src="${p.img}" style="width:100%">
            <div style="padding:15px">
                <b>${p.t}</b> <br> <span style="color:green; font-weight:bold">${p.pr} Ø¬.Ø³</span>
                <div style="font-size:10px; color:#888;">Ù†ÙØ´Ø±: ${time}</div>
                <p style="font-size:13px">${p.de || ''}</p>
                <a href="https://wa.me/249${p.ph}" class="btn-wa">ØªÙˆØ§ØµÙ„ ÙˆØ§ØªØ³Ø§Ø¨</a>
                <button onclick="rate('${p.uP}')" style="width:100%; border:1px solid gold; background:none; margin-top:5px; border-radius:5px; padding:5px;">â­ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¨Ø§Ø¦Ø¹</button>
                <div class="comment-box"><div id="c-${key}">${coms}</div>
                <div style="display:flex; margin-top:5px;"><input id="i-${key}" placeholder="ØªØ¹Ù„ÙŠÙ‚..." style="margin:0; flex:1"><button onclick="addCom('${key}')">âœ“</button></div></div>
            </div>
        </div>`);
        db.ref('users/'+p.uP+'/online').on('value', s => { 
            const d = document.getElementById(`dot-${key}`); if(d) d.innerHTML = s.val() ? '<span class="online-dot"></span>' : ''; 
        });
    }

    function loadVipHome() {
        db.ref('vip_posts').on('value', snap => {
            const v = document.getElementById('vg'); if(!v) return; v.innerHTML = "";
            snap.forEach(c => {
                const d = c.val(); if(Date.now() > d.exp) { db.ref('vip_posts/'+c.key).remove(); return; }
                const tid = `t-${c.key}`;
                v.innerHTML += `<div class="vip-card">
                    <span style="background:red; color:white; padding:2px; font-size:10px; position:absolute;">${d.d}% Ø®ØµÙ…</span>
                    <div style="text-align:left;">${d.uP===me.p?`<span onclick="manage('${c.key}',${d.sold},true)">â‹®</span>`:''}</div>
                    <img src="${d.img}" style="width:100%; height:80px; object-fit:cover; border-radius:5px;">
                    <div style="font-size:11px;"><b>${d.t}</b><br><s style="color:red">${d.pr}</s> <b style="color:green">${d.pr - (d.pr*d.d/100)}</b></div>
                    <div id="${tid}" style="font-size:9px; color:red; font-weight:bold;"></div>
                    <a href="https://wa.me/249${d.ph}" class="btn-wa" style="font-size:10px; padding:5px;">ÙˆØ§ØªØ³Ø§Ø¨</a>
                </div>`;
                setInterval(() => {
                    const rem = d.exp - Date.now();
                    const el = document.getElementById(tid);
                    if(el) el.innerText = rem > 0 ? `ÙŠÙ†ØªÙ‡ÙŠ: ${Math.floor(rem/3600000)}Ø³ ${Math.floor((rem%3600000)/60000)}Ø¯` : "Ø§Ù†ØªÙ‡Ù‰";
                }, 1000);
            });
        });
    }

    function renderVipView(area) {
        if(me.vipStatus === 'active') {
            area.innerHTML = `<div style="padding:20px; text-align:center;"><h3>Ù†Ø´Ø± VIP ğŸ’</h3>
                <input id="vt" placeholder="Ø§Ù„Ù…Ù†ØªØ¬"><input id="vp" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                <input id="vd" type="number" placeholder="Ø§Ù„Ø®ØµÙ… %">
                <select id="vdur"><option value="3600000">Ø³Ø§Ø¹Ø©</option><option value="86400000">ÙŠÙˆÙ… ÙƒØ§Ù…Ù„</option></select>
                <input type="file" onchange="encode(this)"><button class="btn-main" onclick="vipPub()">Ù†Ø´Ø± Ø§Ù„Ø¹Ø±Ø¶</button></div>`;
        } else {
            area.innerHTML = `<div style="padding:20px; text-align:center;"><h3>Ø¨Ø§Ù‚Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ VIP ğŸ’</h3>
                <select id="v-plan" onchange="showPlanPrice(this.value)">
                    <option value="">Ø§Ø®ØªØ± Ø¨Ø§Ù‚Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</option>
                    <option value="1">Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (1000 Ø¬)</option>
                    <option value="7">Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© (7000 Ø¬)</option>
                    <option value="30">Ø§Ù„Ø¨Ø§Ù‚Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© (30000 Ø¬)</option>
                </select>
                <div id="plan-info" style="margin:10px; font-weight:bold; color:var(--blue);"></div>
                <p>Ø­ÙˆÙ„ Ù„Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¹Ø·ÙŠ (Ø¨Ù†ÙƒÙƒ: 4426148)</p>
                <input type="file" id="vrec">
                <button class="btn-main" onclick="vipReq()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø¯ÙØ¹</button></div>`;
        }
    }

    function showPlanPrice(val) {
        let price = "";
        if(val == "1") price = "Ø§Ù„Ø³Ø¹Ø±: 1000 Ø¬Ù†ÙŠÙ‡";
        if(val == "7") price = "Ø§Ù„Ø³Ø¹Ø±: 7000 Ø¬Ù†ÙŠÙ‡";
        if(val == "30") price = "Ø§Ù„Ø³Ø¹Ø±: 30000 Ø¬Ù†ÙŠÙ‡";
        document.getElementById('plan-info').innerText = price;
        if(val) Swal.fire('Ø³Ø¹Ø± Ø§Ù„Ø¨Ø§Ù‚Ø©', price, 'info');
    }

    function vipPub() {
        const t=document.getElementById('vt').value, p=document.getElementById('vp').value, d=document.getElementById('vd').value, dur=document.getElementById('vdur').value;
        db.ref('vip_posts').push({ t, pr:p, d, img:tempImg, uP:me.p, uN:me.n, uRating:me.rating, exp:Date.now()+parseInt(dur), createdAt:Date.now(), ph:me.p, sold:false });
        Swal.fire('ØªÙ…','Ù†Ø´Ø± Ø¹Ø±Ø¶ VIP','success');
    }

    function openProfile(phone) {
        db.ref('users/'+phone).once('value', snap => {
            const u = snap.val();
            const area = document.getElementById('main-view');
            let statusLabel = u.rating >= 100 ? ' <span class="badge-pro">Ù…Ù…ÙŠØ²</span>' : (u.rating >= 50 ? ' <span class="badge-good">Ø¬ÙŠØ¯</span>' : '');
            const stars = 'â­'.repeat(Math.min(5, Math.floor(u.rating/10) || 1));
            
            area.innerHTML = `<div style="text-align:center; padding:20px; background:white; border-bottom:2px solid var(--blue);">
                <img src="${u.pic || 'https://via.placeholder.com/150'}" class="profile-pic" id="p-img"><br>
                <div class="${u.online?'online-dot':''}"></div> <h3>${u.n}</h3>
                <p class="stars">${stars} (${u.rating} ØªÙ‚ÙŠÙŠÙ…) ${statusLabel}</p>
                
                <div style="background:#f9f9f9; padding:10px; border-radius:10px; border:1px dashed #627eea; margin:10px;">
                    <small style="color:#666">Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„Ù„Ù…ØªØ¬Ø± (SDM)</small><br>
                    <a href="${SDM_URL}" target="_blank" class="btn-crypto">Ø´Ø±Ø§Ø¡ SDM Ø§Ù„Ø¢Ù† ğŸš€</a>
                    <p style="font-size:10px; color:#999; word-break:break-all; margin-top:5px;">CA: ${SDM_CA}</p>
                </div>

                ${u.p === me.p ? 
                    `<input type="file" id="change-pic" style="display:none" onchange="updateProfilePic(this)">
                     <button onclick="document.getElementById('change-pic').click()" class="btn-main" style="background:var(--orange)">ØªØºÙŠÙŠØ± ØµÙˆØ±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</button>` : 
                    `<a href="https://wa.me/249${u.p}" class="btn-wa">Ù…Ø±Ø§Ø³Ù„Ø© ÙÙˆØ±ÙŠØ©</a>`
                }
            </div><div id="u-posts"></div>`;
            db.ref('posts').once('value', ps => {
                const list = document.getElementById('u-posts');
                ps.forEach(c => { if(c.val().uP === phone) renderCard(c.val(), list, c.key, false); });
            });
        });
    }

    function updateProfilePic(input) {
        const r = new FileReader();
        r.readAsDataURL(input.files[0]);
        r.onload = e => {
            const newImg = e.target.result;
            db.ref('users/'+me.p).update({ pic: newImg }).then(() => {
                document.getElementById('p-img').src = newImg;
                Swal.fire('ØªÙ…', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            });
        };
    }

    function loadAdmin() {
        db.ref('vip_reqs').on('value', s => {
            const l = document.getElementById('admin-list'); if(!l) return; l.innerHTML = "";
            s.forEach(c => {
                const r = c.val();
                l.innerHTML += `<div style="background:white; margin:5px; padding:10px; border-radius:10px;">
                    <b>${r.uN}</b> (Ø¨Ø§Ù‚Ø©: ${r.plan} ÙŠÙˆÙ…)<br><img src="${r.img}" width="150"><br>
                    <button class="btn-main" style="background:var(--green); width:45%" onclick="approve('${r.uP}',${r.plan})">Ù…ÙˆØ§ÙÙ‚</button>
                    <button class="btn-main" style="background:var(--red); width:45%" onclick="reject('${r.uP}')">Ø±ÙØ¶</button>
                </div>`;
            });
        });
    }

    function approve(p, d) { 
        db.ref('users/'+p).update({ vipStatus:'active', vipExp:Date.now()+(d*86400000) }); 
        db.ref('vip_reqs/'+p).remove();
        Swal.fire('Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', 'ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù†Ø´Ø± ÙÙŠ Ø§Ù„vip', 'success');
    }
    function reject(p) { 
        db.ref('vip_reqs/'+p).remove(); 
        db.ref('users/'+p).update({ vipStatus:'none' }); 
        Swal.fire('Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©', 'error');
    }

    function manage(k, s, v) { 
        Swal.fire({title:'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†', showDenyButton:true, confirmButtonText:s?'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨ÙŠØ¹':'ØªÙ… Ø§Ù„Ø¨ÙŠØ¹', denyButtonText:'Ø­Ø°Ù'}).then(r => {
            const p = v ? 'vip_posts/' : 'posts/';
            if(r.isConfirmed) db.ref(p+k).update({sold:!s}); else if(r.isDenied) db.ref(p+k).remove();
        });
    }

    function rate(p) { 
        if(p===me.p) return;
        db.ref('ratings/'+p+'/'+me.p).once('value', snap => {
            if(snap.exists()) {
                Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªÙ‚ÙŠÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®Øµ Ù…Ø³Ø¨Ù‚Ø§Ù‹','info');
            } else {
                db.ref('users/'+p+'/rating').transaction(c => (c||0)+1);
                db.ref('ratings/'+p+'/'+me.p).set(true);
                Swal.fire('Ø´ÙƒØ±Ø§Ù‹','ØªÙ… ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØ§Ø¬Ø± Ø¨Ù†Ø¬Ø§Ø­','success');
            }
        });
    }

    function reportPost(targetPhone, postKey) {
        Swal.fire({
            title: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø´ÙˆØ±ØŸ',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø¨Ù„Ø§Øº'
        }).then(res => {
            if(res.isConfirmed) {
                db.ref('users/'+targetPhone+'/reports').transaction(c => {
                    let newCount = (c || 0) + 1;
                    if(newCount >= 20) {
                        db.ref('users/'+targetPhone).update({ status: 'banned', banUntil: Date.now() + (7 * 24 * 60 * 60 * 1000) });
                    }
                    return newCount;
                });
                Swal.fire('ØªÙ…','ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§Øº ÙˆØ³ÙˆÙ ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹ØªÙ‡','success');
            }
        });
    }

    function addCom(k) { 
        const i=document.getElementById('i-'+k); if(!i.value) return;
        db.ref('posts/'+k+'/comments').push({uN:me.n, txt:i.value}); i.value=""; 
    }

    function encode(i) { const r=new FileReader(); r.readAsDataURL(i.files[0]); r.onload=e=>tempImg=e.target.result; }
    
    function encodeProfile(i) { 
        const r=new FileReader(); 
        r.readAsDataURL(i.files[0]); 
        r.onload=e=>{
            profileImg=e.target.result;
            document.getElementById('pic-preview').innerHTML = `<img src="${profileImg}" style="width:80px; height:80px; border-radius:50%; margin-bottom:10px;">`;
        }; 
    }

    function vipReq() { 
        const plan = document.getElementById('v-plan').value;
        const f=document.getElementById('vrec').files[0]; 
        if(!plan) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø§Ù‚Ø© Ø£ÙˆÙ„Ø§Ù‹','warning');
        if(!f) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø±ÙØ§Ù‚ ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„','warning');
        
        Swal.fire({
            title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨',
            text: 'Ù‡Ù„ Ù‚Ù…Øª Ø¨Ø§Ù„Ø¯ÙØ¹ Ù„Ù„ØªØ§Ø¬Ø± ÙˆØªØ±ÙŠØ¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ØŸ',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Ù…ÙˆØ§ÙÙ‚'
        }).then(res => {
            if(res.isConfirmed) {
                const r=new FileReader(); r.readAsDataURL(f); 
                r.onload=()=> {
                    db.ref('vip_reqs/'+me.p).set({uN:me.n, uP:me.p, img:r.result, plan: plan});
                    db.ref('users/'+me.p).update({ vipStatus: 'pending' });
                    Swal.fire('ØªÙ…','ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©ØŒ Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©','success');
                }
            }
        });
    }

    function toggleAuth(l) { document.getElementById('log-box').classList.toggle('hidden',!l); document.getElementById('reg-box').classList.toggle('hidden',l); }
</script>
</body>
</html>

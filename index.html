<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDM Market | Ø¬ÙˆÙ‡Ø±Ø© Ø³ÙˆÙ„Ø§Ù†Ø§ ğŸ‡¸ğŸ‡©</title>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³ (Ø§Ù„Ù†Ø³Ø®Ø© 8) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- ØªØµÙ…ÙŠÙ… ÙˆØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --navy: #0d1117; --gold: #ffc107; --blue: #007bff; --bg: #f4f6f9; --white: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); padding-bottom: 75px; direction: rtl; user-select: none; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        
        header { background: var(--navy); color: white; padding: 10px 15px; display: flex; flex-direction: column; gap: 10px; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid var(--gold); box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        
        .btn-main, .btn-google { border: none; padding: 12px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 15px; transition: 0.2s; color: white; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-main { background: var(--blue); }
        .btn-google { background: #db4437; color: white; }
        
        .card { background: white; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; border: 1px solid #eee; margin-bottom: 10px; }
        .post { background: white; margin: 15px; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .bottom-tabs { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; padding: 8px 0; z-index: 1000; }
        .tab-btn { flex: 1; text-align: center; color: #666; cursor: pointer; font-size: 10px; }
        input, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #auth-screen { display: flex; align-items: center; justify-content: center; height: 100vh; background: var(--bg); }
        .auth-box { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
    </style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (Google) -->
<div id="auth-screen">
    <div class="auth-box">
        <h2 style="color:var(--navy); margin-bottom: 10px;">Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† & SDM ğŸ’</h2>
        <p style="color:#666; margin-bottom: 30px;">Ø¨ÙŠØ¹ØŒ Ø§Ø´ØªØ±ÙŠØŒ ÙˆØªØ¯Ø§ÙˆÙ„ Ø¨Ø£Ù…Ø§Ù†</p>
        
        <button class="btn-google" onclick="loginWithGoogle()">
            <i class="fab fa-google"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ø¨Ø± Google
        </button>
        
        <button class="btn-main" style="background:#6c757d; margin-top:15px;" onclick="enterGuestMode()">
            <i class="fas fa-user-secret"></i> ØªØµÙØ­ ÙƒØ²Ø§Ø¦Ø±
        </button>
        
        <p style="font-size:11px; color:#999; margin-top:20px;">Ø¨ØªØ³Ø¬ÙŠÙ„Ùƒ Ø£Ù†Øª ØªÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</p>
    </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
<div id="app-screen" class="hidden">
    <header>
        <div class="header-top">
            <span onclick="goBack()" style="cursor:pointer; font-size:20px;">ğŸ”™</span>
            <b id="head-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</b>
            <div style="font-size:12px; color:var(--gold)" id="user-role-badge"></div>
        </div>
    </header>

    <div id="content-area" style="padding-bottom: 20px;"></div>

    <div class="bottom-tabs">
        <div class="tab-btn" onclick="nav('home')"><i class="fas fa-home"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="tab-btn" onclick="checkAuthAction('wallet')"><i class="fas fa-wallet" style="color:#007bff"></i>SDM</div>
        <div class="tab-btn" onclick="checkAuthAction('profile')"><i class="fas fa-user-circle"></i>Ù…Ù„ÙÙŠ</div>
    </div>
</div>

<script>
    // âš ï¸ Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù…Ù† Firebase Console
    const firebaseConfig = { 
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT.firebaseapp.com",
        databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT.appspot.com",
        messagingSenderId: "...",
        appId: "..."
    };
    
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
    let currentUser = null;
    let userUid = null;
    let isGuest = false;
    let hStack = ['home'];
    let tempImg = '';
    const SDM_PRICE = 1000;

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù…Ù† (Google) ---
    function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).then((result) => {
            // Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¯Ø®ÙˆÙ„
            handleUserLogin(result.user);
        }).catch((error) => {
            Swal.fire('Ø®Ø·Ø£', error.message, 'error');
        });
    }

    // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
    function handleUserLogin(user) {
        userUid = user.uid;
        db.ref('users/' + userUid).once('value').then(snap => {
            if (snap.exists()) {
                // Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ÙŠÙ…: ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø¸Ù‡ÙˆØ± ÙÙ‚Ø·
                db.ref('users/' + userUid).update({ lastSeen: firebase.database.ServerValue.TIMESTAMP });
                startApp();
            } else {
                // Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯: Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø¬ÙˆØ¬Ù„
                const newUserData = {
                    n: user.displayName,
                    email: user.email,
                    pic: user.photoURL, // ØµÙˆØ±Ø© Ø¬ÙˆØ¬Ù„
                    uid: userUid,
                    sdmBalance: 0,
                    role: 'user',
                    joined: firebase.database.ServerValue.TIMESTAMP
                };
                db.ref('users/' + userUid).set(newUserData).then(() => startApp());
            }
        });
    }

    // Ù…Ø±Ø§Ù‚Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù„Ù„Ø¨Ù‚Ø§Ø¡ Ù…Ø³Ø¬Ù„Ø§Ù‹)
    auth.onAuthStateChanged(user => {
        if (user) {
            userUid = user.uid;
            db.ref('users/' + userUid).on('value', snap => {
                currentUser = snap.val();
                if(currentUser && currentUser.role === 'admin') {
                    document.getElementById('user-role-badge').innerText = 'ğŸ‘‘ Admin';
                }
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø­ÙØ¸Ø©
                if(hStack[hStack.length-1] === 'wallet') renderWallet(document.getElementById('content-area'));
            });
            startApp();
        } else {
            if(!isGuest) {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        }
    });

    function enterGuestMode() {
        isGuest = true;
        currentUser = { n: 'Ø²Ø§Ø¦Ø±', role: 'guest', sdmBalance: 0 };
        startApp();
    }

    function startApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        render('home');
    }

    // --- Ø¶ØºØ· Ø§Ù„ØµÙˆØ± (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©) ---
    function compressImage(file, callback) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function(event) {
            const img = new Image();
            img.src = event.target.result;
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 600; // ØªØµØºÙŠØ± Ø§Ù„Ø¹Ø±Ø¶ Ø¥Ù„Ù‰ 600 Ø¨ÙƒØ³Ù„
                const scaleSize = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scaleSize;
                
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                // Ø¶ØºØ· Ø§Ù„Ø¬ÙˆØ¯Ø© Ø¥Ù„Ù‰ 70% JPEG
                const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                callback(dataUrl);
            }
        }
    }

    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            Swal.fire({
                title: 'Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©...',
                allowOutsideClick: false,
                didOpen: () => Swal.showLoading()
            });
            compressImage(input.files[0], (compressedData) => {
                tempImg = compressedData;
                Swal.close();
                Swal.fire('ØªÙ…', 'ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            });
        }
    }

    // --- Ø§Ù„ØªÙ†Ù‚Ù„ ÙˆØ§Ù„Ø¹Ø±Ø¶ ---
    function checkAuthAction(view, extra) {
        if (isGuest) return Swal.fire('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¹Ø¨Ø± Ø¬ÙˆØ¬Ù„ Ù„Ù„Ø§Ø³ØªÙØ§Ø¯Ø© Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©', 'warning');
        nav(view, extra);
    }
    
    function nav(v, e) { hStack.push(v); render(v, e); }
    function goBack() { if(hStack.length > 1) { hStack.pop(); render(hStack[hStack.length-1]); } }
    function escapeHtml(text) { return text ? text.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m])) : text; }

    function render(view, extra) {
        const area = document.getElementById('content-area');
        document.getElementById('head-title').innerText = (view==='wallet'?'Ø§Ù„Ù…Ø­ÙØ¸Ø©':(view==='profile'?'Ù…Ù„ÙÙŠ':'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'));

        if (view === 'home') {
            area.innerHTML = `
                <div style="padding:10px;">
                    <img src="https://i.ibb.co/3ykXvBv/SDM-Coin.jpg" style="width:100%; border-radius:15px;">
                </div>
                <div style="padding:10px;">
                    <div class="card" onclick="nav('feed','Mobiles')">ğŸ“± Ù…ÙˆØ¨Ø§ÙŠÙ„Ø§Øª</div>
                    <div class="card" onclick="nav('feed','Cars')">ğŸš— Ø³ÙŠØ§Ø±Ø§Øª</div>
                    <div class="card" onclick="nav('feed','General')">ğŸ“¦ Ù…Ù†ÙˆØ¹Ø§Øª</div>
                </div>`;
        } else if (view === 'feed') {
            let form = isGuest ? '' : `
                <div style="background:white; padding:15px; margin:10px; border-radius:10px;">
                    <h4>Ø¨ÙŠØ¹ ÙÙŠ ${extra}</h4>
                    <input id="pt" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
                    <input id="pp" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± (SDM)">
                    <input id="pwa" type="tel" placeholder="Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„ØªÙˆØ§ØµÙ„">
                    <textarea id="pd" placeholder="Ø§Ù„ÙˆØµÙ"></textarea>
                    <input type="file" accept="image/*" onchange="handleFileSelect(this)">
                    <button class="btn-main" onclick="publish('${extra}')">Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
                </div>`;
            area.innerHTML = form + '<div id="posts-list"></div>';
            loadPosts(extra);
        } else if (view === 'wallet') {
            area.innerHTML = `
                <div style="background: linear-gradient(135deg, #0d1117, #1e3a8a); color: white; padding: 30px; margin: 15px; border-radius: 20px; text-align: center;">
                    <h1>${currentUser.sdmBalance || 0} SDM</h1>
                    <p>Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø¢Ù…Ù†Ø©</p>
                    <button class="btn-main" style="background:#28a745; border:2px solid white" onclick="showTransfer()">ØªØ­ÙˆÙŠÙ„ Ø±ØµÙŠØ¯</button>
                </div>
                <div id="tx-list" style="padding:15px;"></div>`;
            loadTransactions();
        } else if (view === 'profile') {
            area.innerHTML = `
                <div style="text-align:center; padding:40px;">
                    <img src="${currentUser.pic}" style="width:100px; height:100px; border-radius:50%; margin-bottom:10px;">
                    <h3>${currentUser.n}</h3>
                    <p style="color:#666">${currentUser.email}</p>
                    <button class="btn-main" style="background:#dc3545" onclick="firebase.auth().signOut().then(()=>location.reload())">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                </div>`;
        }
    }

    // --- Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ---
    function publish(cat) {
        const t = escapeHtml(document.getElementById('pt').value);
        const pr = Math.abs(parseInt(document.getElementById('pp').value));
        const wa = escapeHtml(document.getElementById('pwa').value);
        const d = escapeHtml(document.getElementById('pd').value);

        if (!t || !pr || !wa || !tempImg) return Swal.fire('Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©', 'Ø§Ù…Ù„Ø£ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ£Ø¶Ù ØµÙˆØ±Ø©', 'warning');

        db.ref('posts').push({
            t, pr, d, wa, cat, img: tempImg,
            uN: currentUser.n, uid: userUid, // Ø¢Ù…Ù†
            date: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
            Swal.fire('ØªÙ… Ø§Ù„Ù†Ø´Ø±', '', 'success');
            tempImg = '';
            render('feed', cat);
        });
    }

    function loadPosts(cat) {
        db.ref('posts').orderByChild('cat').equalTo(cat).limitToLast(15).on('value', snap => {
            const list = document.getElementById('posts-list');
            if(!list) return;
            list.innerHTML = "";
            let posts = [];
            snap.forEach(c => posts.unshift(c.val()));
            posts.forEach(p => {
                list.innerHTML += `
                <div class="post">
                    <img src="${p.img}" style="width:100%; height:200px; object-fit:cover;">
                    <div style="padding:15px;">
                        <h4>${p.t}</h4>
                        <div style="color:#28a745; font-weight:bold">${p.pr} SDM</div>
                        <p style="font-size:13px; color:#555">${p.d}</p>
                        <a href="https://wa.me/${p.wa}" class="btn-main" style="background:#25d366; text-decoration:none; display:block; text-align:center;">ÙˆØ§ØªØ³Ø§Ø¨</a>
                    </div>
                </div>`;
            });
        });
    }

    // --- Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¢Ù…Ù† (Transactions) ---
    function showTransfer() {
        Swal.fire({
            title: 'ØªØ­ÙˆÙŠÙ„ SDM',
            html: `
                <input id="re-email" placeholder="Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…Ø³ØªÙ„Ù… (Gmail)" class="swal2-input">
                <input id="re-amt" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" class="swal2-input">
            `,
            showCancelButton: true,
            confirmButtonText: 'Ø¥Ø±Ø³Ø§Ù„',
            preConfirm: () => {
                const em = document.getElementById('re-email').value;
                const amt = parseInt(document.getElementById('re-amt').value);
                if(!em || !amt || amt<=0) Swal.showValidationMessage('Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø·Ø£');
                if(amt > currentUser.sdmBalance) Swal.showValidationMessage('Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§Ù');
                return { em, amt };
            }
        }).then(async (res) => {
            if(res.isConfirmed) {
                const { em, amt } = res.value;
                // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªÙ„Ù… Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
                const snap = await db.ref('users').orderByChild('email').equalTo(em).once('value');
                if(!snap.exists()) return Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
                
                const recUid = Object.keys(snap.val())[0];
                
                // Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø®ØµÙ… ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø°Ø±ÙŠØ©
                db.ref('users/' + userUid + '/sdmBalance').transaction(val => (val||0) - amt, (err, comm) => {
                    if(comm) {
                        db.ref('users/' + recUid + '/sdmBalance').transaction(val => (val||0) + amt);
                        db.ref('transactions').push({
                            from: userUid, to: recUid, amt, 
                            date: firebase.database.ServerValue.TIMESTAMP
                        });
                        Swal.fire('ØªÙ…', 'ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    }
                });
            }
        });
    }

    function loadTransactions() {
        db.ref('transactions').limitToLast(20).on('value', snap => {
            const list = document.getElementById('tx-list');
            if(!list) return;
            list.innerHTML = "<h4>Ø§Ù„Ø³Ø¬Ù„</h4>";
            let txs = [];
            snap.forEach(c => txs.unshift(c.val()));
            txs.filter(t => t.from === userUid || t.to === userUid).forEach(t => {
                const isSent = t.from === userUid;
                list.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between"><span>${isSent?'Ø¥Ù„Ù‰':'Ù…Ù†'} Ù…Ø³ØªØ®Ø¯Ù…</span><span style="color:${isSent?'red':'green'}">${isSent?'-':'+'}${t.amt}</span></div>`;
            });
        });
    }
</script>
</body>
</html>

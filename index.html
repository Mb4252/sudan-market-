<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SDM Market Pro | منصة تداول MRK/SDM</title>
    
    <!-- خطوط عربية -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
    
    <!-- مكتبات خارجية -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- OneSignal -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({ appId: "74a3085c-32b9-4c35-bc32-e67c3a2506c3" });
      });
    </script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --bg-dark: #0a0e17;
            --bg-card: #151b29;
            --primary: #3b82f6;
            --accent: #f59e0b;
            --neon-blue: #00f3ff;
            --text-main: #ffffff;
            --text-sec: #94a3b8;
            --border: #1e293b;
            --red: #ef4444; 
            --green: #10b981;
            --buy-bg: rgba(16, 185, 129, 0.1);
            --sell-bg: rgba(239, 68, 68, 0.1);
            --orderbook-bg: #0d111c;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline:none; 
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Tajawal', sans-serif; 
            background: var(--bg-dark); 
            color: var(--text-main);
            min-height: 100vh;
            user-select: none;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-card); }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        .hidden { display: none !important; }
        .search-hidden { display: none !important; }

        /* Header */
        header {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            padding: 12px 16px;
            position: sticky; 
            top: 0; 
            z-index: 1000;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }
        
        .header-top { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            width: 100%; 
            margin-bottom: 12px;
        }
        
        .search-container { 
            position: relative; 
            width: 100%; 
        }
        
        .search-container input {
            width: 100%; 
            padding: 12px 45px 12px 15px;
            border-radius: 10px; 
            border: 1px solid var(--border);
            font-size: 14px; 
            background: rgba(255,255,255,0.05); 
            color: white;
            transition: 0.3s; 
            font-family: 'Tajawal';
        }
        
        .search-container i { 
            position: absolute; 
            right: 15px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--accent); 
        }

        /* Pro Trading Interface */
        .pro-trading-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 180px);
            padding: 12px;
            gap: 12px;
        }

        .market-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .market-pair {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .market-pair-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--accent), var(--primary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .market-stats {
            display: flex;
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-sec);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 14px;
            font-weight: bold;
        }

        .trading-layout {
            display: flex;
            flex: 1;
            gap: 12px;
            min-height: 400px;
        }

        .chart-section {
            flex: 3;
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .chart-toolbar {
            display: flex;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.3);
        }

        .timeframe-btn {
            padding: 6px 12px;
            font-size: 12px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-sec);
            border-radius: 6px;
            cursor: pointer;
            margin-right: 6px;
        }

        .timeframe-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .chart-container {
            flex: 1;
            position: relative;
        }

        .orderbook-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--orderbook-bg);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
            min-width: 250px;
        }

        .orderbook-header {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.3);
        }

        .orderbook-tabs {
            display: flex;
            margin-bottom: 8px;
        }

        .ob-tab {
            flex: 1;
            text-align: center;
            padding: 6px;
            font-size: 12px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .ob-tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }

        .orderbook-list {
            flex: 1;
            overflow-y: auto;
            font-size: 12px;
        }

        .orderbook-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 12px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .orderbook-row:hover {
            background: rgba(255,255,255,0.05);
        }

        .orderbook-depth {
            position: absolute;
            top: 0;
            height: 100%;
            opacity: 0.15;
            z-index: 0;
        }

        .orderbook-content {
            display: flex;
            justify-content: space-between;
            width: 100%;
            position: relative;
            z-index: 1;
        }

        .bid-row .orderbook-depth {
            right: 0;
            background: var(--green);
        }

        .ask-row .orderbook-depth {
            left: 0;
            background: var(--red);
        }

        .trading-panel {
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border);
            padding: 16px;
            margin-top: 12px;
        }

        .order-tabs {
            display: flex;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 16px;
        }

        .order-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .order-tab.buy.active {
            background: var(--green);
            color: white;
        }

        .order-tab.sell.active {
            background: var(--red);
            color: white;
        }

        .order-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 12px;
            color: var(--text-sec);
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
        }

        .form-input {
            padding: 10px 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-family: 'Tajawal';
            font-size: 14px;
        }

        .form-input:focus {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }

        .percentage-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .pct-btn {
            padding: 8px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pct-btn:hover {
            background: rgba(59, 130, 246, 0.2);
            border-color: var(--primary);
        }

        .balance-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 16px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }

        .execute-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .execute-btn:active {
            transform: scale(0.98);
        }

        .execute-btn.buy {
            background: linear-gradient(135deg, var(--green), #059669);
            color: white;
        }

        .execute-btn.sell {
            background: linear-gradient(135deg, var(--red), #b91c1c);
            color: white;
        }

        /* General UI Elements */
        .btn-main { 
            background: linear-gradient(90deg, var(--primary), #2563eb); 
            color: white; 
            border: none; 
            padding: 14px; 
            width: 100%; 
            border-radius: 10px; 
            font-weight: bold; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); 
            transition: 0.2s; 
        }
        
        .btn-main:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }
        
        .btn-guest { 
            background: transparent; 
            border: 1px solid var(--text-sec); 
            color: var(--text-sec); 
            width: 100%; 
            padding: 12px; 
            border-radius: 10px; 
            margin-top: 10px; 
            cursor: pointer; 
        }

        /* Bottom Nav */
        .bottom-tabs { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: var(--bg-card); 
            backdrop-filter: blur(15px); 
            display: flex; 
            justify-content: space-around; 
            padding: 10px 0; 
            box-shadow: 0 -4px 20px rgba(0,0,0,0.5); 
            border-top: 1px solid var(--border); 
            z-index: 1000; 
        }
        
        .tab-btn { 
            color: var(--text-sec); 
            text-align: center; 
            font-size: 10px; 
            flex: 1; 
            cursor: pointer; 
            transition: 0.3s; 
            padding: 5px;
        }
        
        .tab-btn.active { 
            color: var(--neon-blue); 
        }
        
        .tab-btn i { 
            font-size: 20px; 
            margin-bottom: 4px; 
            display: block; 
        }

        /* Auth & Offline */
        #offline-guard { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: var(--bg-dark); 
            z-index: 99999; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            backdrop-filter: blur(15px); 
        }
        
        #auth-screen { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: var(--bg-dark); 
            z-index: 2000; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
        }
        
        /* Animations */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .animate-slide {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body>

<!-- حماية الاتصال -->
<div id="offline-guard" class="hidden">
    <i class="fas fa-wifi" style="font-size:50px; color:var(--red); margin-bottom:20px;"></i>
    <h3 style="color:white;">لا يوجد اتصال</h3>
    <p style="color:var(--text-sec); text-align:center; padding:20px;">
        يرجى التحقق من اتصالك بالإنترنت<br>
        ثم إعادة تحميل الصفحة
    </p>
</div>

<!-- شاشة الدخول -->
<div id="auth-screen">
    <div style="text-align:center; padding:20px;">
        <div style="width:100px; height:100px; background:linear-gradient(45deg, var(--accent), var(--primary)); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px;">
            <i class="fas fa-chart-line" style="font-size:50px; color:white;"></i>
        </div>
        <h2 style="margin:0; background:linear-gradient(45deg, var(--neon-blue), var(--accent)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-size:32px;">
            SDM Market Pro
        </h2>
        <p style="color:var(--text-sec); margin-top:10px;">منصة تداول MRK/SDM الاحترافية</p>
    </div>
    <div style="width:100%; max-width:350px; padding:20px;">
        <button onclick="loginWithGoogle()" class="btn-main" style="display:flex; align-items:center; justify-content:center; gap:10px;">
            <i class="fab fa-google"></i> دخول بواسطة Google
        </button>
        <button class="btn-guest" onclick="enterGuestMode()">
            <i class="fas fa-eye"></i> تصفح كزائر
        </button>
    </div>
</div>

<!-- التطبيق الرئيسي -->
<div id="app-screen" class="hidden">
    <header>
        <div class="header-top">
            <span onclick="goBack()" style="cursor:pointer; font-size:22px; color:var(--text-sec); width:40px; height:40px; display:flex; align-items:center; justify-content:center;">
                <i class="fas fa-arrow-right"></i>
            </span>
            <span id="head-title" style="font-weight: 800; font-size: 18px; color: var(--text-main);">
                منصة التداول
            </span>
            <div style="display:flex; align-items:center; gap:8px;">
                <div style="background:rgba(255,255,255,0.1); padding:6px 12px; border-radius:20px; display:flex; align-items:center; gap:5px;">
                    <i class="fas fa-star" style="color:var(--accent); font-size:12px;"></i>
                    <span id="u-stars" style="font-size:12px; font-weight:bold;">0.0</span>
                </div>
                <div id="user-avatar" onclick="checkGuestAccess('profile')" style="width:40px; height:40px; border-radius:50%; background:var(--primary); display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden;">
                    <i class="fas fa-user" style="color:white;"></i>
                </div>
            </div>
        </div>
        <div class="search-container" id="main-search">
            <i class="fas fa-search"></i>
            <input type="text" id="store-search" placeholder="ابحث في السوق..." oninput="filterContent(this.value)">
        </div>
    </header>

    <div id="admin-notifications-area"></div>
    <div id="content-area"></div>

    <div class="bottom-tabs">
        <div class="tab-btn active" onclick="nav('home'); highlightTab(this)">
            <i class="fas fa-home"></i>
            الرئيسية
        </div>
        <div class="tab-btn" onclick="checkGuestAccess('trade'); highlightTab(this)">
            <i class="fas fa-chart-line"></i>
            التداول
        </div>
        <div class="tab-btn" onclick="checkGuestAccess('wallet'); highlightTab(this)">
            <i class="fas fa-wallet"></i>
            المحفظة
        </div>
        <div class="tab-btn" onclick="checkGuestAccess('profile'); highlightTab(this)">
            <i class="fas fa-user"></i>
            الملف
        </div>
    </div>
</div>

<script>
    // --- 1. الإعدادات والتهيئة ---
    const firebaseConfig = {
      apiKey: "AIzaSyAI_mUhuPNoO-XC0Q-VNoWft8UWFbAbIGg",
      authDomain: "sudan-market-6b122.firebaseapp.com",
      databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com",
      projectId: "sudan-market-6b122",
      storageBucket: "sudan-market-6b122.firebasestorage.app",
      messagingSenderId: "66729481566",
      appId: "1:66729481566:web:93393f28dc22d32cceebcf"
    };
    
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const ADMIN_EMAIL = "mb425262@gmail.com";
    const OPENING_PRICE = 0.05;
    const TOTAL_SUPPLY = 30000000;
    const SDM_RATE = 1000;

    let me = null;
    let hStack = ['home'];
    let curC = '', curS = '';
    let isGuest = false;
    let chartInstance = null;
    let currentTradeMode = 'buy';
    let marketPrice = OPENING_PRICE;
    let lastActionTime = 0;
    let realtimeInterval = null;
    let currentTimeframe = '15m';
    
    // صور المستخدم
    let userPic = 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
    
    // --- 2. النظام والدخول ---
    db.ref('system/status/active').on('value', snap => {
        if(!snap.val()) {
            document.getElementById('offline-guard').classList.remove('hidden');
        } else {
            document.getElementById('offline-guard').classList.add('hidden');
        }
    });

    auth.onAuthStateChanged(user => {
        if (user) {
            const uid = user.uid;
            db.ref('users/' + uid).on('value', snap => {
                if(snap.exists()) {
                    let u = snap.val();
                    if (user.email === ADMIN_EMAIL && u.role !== 'admin') {
                        u.role = 'admin';
                        db.ref('users/' + uid).update({ role: 'admin' });
                    }
                    me = u; 
                    me.p = uid;
                    updateUserAvatar();
                    
                    if(me.role === 'admin') {
                        checkSystemInit();
                        initAdminMarketControls();
                    }
                    startApp(uid);
                } else {
                    const newUser = { 
                        n: user.displayName || 'مستخدم جديد', 
                        email: user.email, 
                        pic: user.photoURL || userPic, 
                        sdmBalance: 0, 
                        mrkBalance: 0, 
                        role: (user.email === ADMIN_EMAIL ? 'admin' : 'user'), 
                        rating: 5.0, 
                        vipStatus: 'none', 
                        reportCount: 0, 
                        verified: true,
                        lastSeen: Date.now(),
                        walletAddress: '',
                        phone: ''
                    };
                    db.ref('users/' + uid).set(newUser).then(() => { 
                        me = newUser; 
                        updateUserAvatar();
                        startApp(uid); 
                    });
                }
            });
            // تحديث حالة الاتصال
            setInterval(() => { 
                if(me) db.ref('users/' + uid).update({ lastSeen: Date.now() }); 
            }, 60000);
        } else {
            if(!isGuest) { 
                document.getElementById('auth-screen').classList.remove('hidden'); 
                document.getElementById('app-screen').classList.add('hidden'); 
            }
        }
    });

    function updateUserAvatar() {
        const avatar = document.getElementById('user-avatar');
        if (avatar && me && me.pic) {
            avatar.innerHTML = `<img src="${me.pic}" style="width:100%; height:100%; object-fit:cover;">`;
        }
    }

    function checkSystemInit() {
        db.ref('system/init').once('value', snap => {
            if (!snap.exists()) {
                // تهيئة النظام
                db.ref('system').set({
                    init: true,
                    status: { active: true },
                    market: {
                        openingPrice: OPENING_PRICE,
                        totalSupply: TOTAL_SUPPLY,
                        lastPrice: OPENING_PRICE,
                        volume24h: 0,
                        high24h: OPENING_PRICE,
                        low24h: OPENING_PRICE
                    }
                });
            }
        });
    }

    function loginWithGoogle() { 
        auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
            .catch(e => Swal.fire('خطأ', e.message, 'error')); 
    }
    
    function doLogout() { 
        auth.signOut().then(() => location.reload()); 
    }
    
    function enterGuestMode() { 
        isGuest = true; 
        me = { 
            n: 'زائر', 
            p: 'guest', 
            role: 'guest', 
            sdmBalance: 0, 
            mrkBalance: 0, 
            lastSeen: Date.now(),
            pic: userPic
        }; 
        document.getElementById('auth-screen').classList.add('hidden'); 
        document.getElementById('app-screen').classList.remove('hidden'); 
        document.getElementById('u-stars').innerText = "زائر"; 
        updateUserAvatar();
        render('home'); 
    }

    function checkGuestAccess(view, extra) { 
        if (isGuest && view !== 'home') { 
            Swal.fire({ 
                title: 'عذراً', 
                text: 'هذه الميزة تتطلب تسجيل دخول', 
                icon: 'warning', 
                confirmButtonText: 'حسناً', 
                background: '#151b29', 
                color: '#fff' 
            }); 
            return; 
        } 
        nav(view, extra); 
    }
    
    function highlightTab(el) { 
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); 
        el.classList.add('active'); 
    }

    function startApp(uid) {
        isGuest = false; 
        hStack = ['home'];
        
        // الاستماع لتحديثات السوق في الوقت الحقيقي
        db.ref('market/stats/lastPrice').on('value', s => { 
            marketPrice = s.val() || OPENING_PRICE; 
            updateMarketDisplay();
        });
        
        // الاستماع للتنبيهات
        listenForAlerts();
        
        document.getElementById('auth-screen').classList.add('hidden'); 
        document.getElementById('app-screen').classList.remove('hidden');
        render('home');
    }

    function listenForAlerts() {
        db.ref(`alerts/${me.p}`).on('child_added', snap => {
            const msg = snap.val();
            Swal.fire({ 
                title: msg.type === 'error' ? 'تنبيه' : 'نجاح', 
                text: msg.msg, 
                icon: msg.type, 
                toast: true, 
                position: 'top', 
                timer: 4000, 
                showConfirmButton: false, 
                background: '#151b29', 
                color: '#fff' 
            });
            snap.ref.remove();
        });
    }

    // --- 3. التنقل والعرض ---
    function nav(view, extra) {
        // إيقاف التحديثات السابقة
        if (realtimeInterval) clearInterval(realtimeInterval);
        if (chartInstance) { 
            chartInstance.destroy(); 
            chartInstance = null; 
        }
        
        hStack.push(view); 
        const area = document.getElementById('content-area');
        const adminArea = document.getElementById('admin-notifications-area');
        const searchEl = document.getElementById('main-search');
        
        // تحديث العناوين
        const titles = {
            'home': 'الرئيسية',
            'trade': 'تداول MRK/SDM',
            'wallet': 'المحفظة',
            'profile': 'الملف الشخصي'
        };
        
        document.getElementById('head-title').innerText = titles[view] || view;
        document.getElementById('u-stars').innerText = isGuest ? "زائر" : (me.rating || 0).toFixed(1);
        
        if (view === 'home' || view === 'trade') {
            searchEl.classList.remove('search-hidden');
        } else {
            searchEl.classList.add('search-hidden');
        }
        
        if(view === 'home') {
            area.innerHTML = `
                <div style="padding:20px; text-align:center;">
                    <div style="width:120px; height:120px; background:linear-gradient(45deg, var(--accent), var(--primary)); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px;">
                        <i class="fas fa-chart-line" style="font-size:60px; color:white;"></i>
                    </div>
                    <h2 style="color:white; margin-bottom:10px;">مرحباً بك في SDM Market Pro</h2>
                    <p style="color:var(--text-sec); margin-bottom:30px;">
                        منصة تداول MRK/SDM الاحترافية<br>
                        شفافية عالية · أمان كامل · سرعة تنفيذ
                    </p>
                    
                    <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:15px; margin-bottom:30px;">
                        <div class="card" onclick="checkGuestAccess('trade')" style="background:var(--bg-card); border-radius:12px; padding:20px; text-align:center; border:1px solid var(--border); cursor:pointer; transition:0.3s;">
                            <i class="fas fa-chart-line" style="font-size:32px; color:var(--neon-blue); margin-bottom:10px;"></i>
                            <h4 style="color:white;">بدء التداول</h4>
                            <p style="font-size:12px; color:var(--text-sec);">تداول MRK مقابل SDM</p>
                        </div>
                        <div class="card" onclick="checkGuestAccess('wallet')" style="background:var(--bg-card); border-radius:12px; padding:20px; text-align:center; border:1px solid var(--border); cursor:pointer; transition:0.3s;">
                            <i class="fas fa-wallet" style="font-size:32px; color:var(--accent); margin-bottom:10px;"></i>
                            <h4 style="color:white;">المحفظة</h4>
                            <p style="font-size:12px; color:var(--text-sec);">إدارة أصولك</p>
                        </div>
                    </div>
                    
                    <div style="background:var(--bg-card); border-radius:12px; padding:20px; border:1px solid var(--border); margin-bottom:20px;">
                        <h4 style="color:white; margin-bottom:15px; display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-info-circle" style="color:var(--primary);"></i>
                            معلومات السوق
                        </h4>
                        <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:10px;">
                            <div>
                                <p style="font-size:12px; color:var(--text-sec);">السعر الحالي</p>
                                <p style="font-size:18px; color:var(--green); font-weight:bold;">${marketPrice.toFixed(4)} SDM</p>
                            </div>
                            <div>
                                <p style="font-size:12px; color:var(--text-sec);">العرض الكلي</p>
                                <p style="font-size:18px; color:white; font-weight:bold;">${TOTAL_SUPPLY.toLocaleString()} MRK</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
        } else if (view === 'trade') {
            area.innerHTML = adminSellPanel() + `
                <div class="pro-trading-container">
                    <!-- رأس السوق -->
                    <div class="market-header">
                        <div class="market-pair">
                            <div class="market-pair-icon">M/S</div>
                            <div>
                                <h3 style="color:white; font-size:16px;">MRK/SDM</h3>
                                <p style="font-size:12px; color:var(--text-sec);">Sudan Market Token</p>
                            </div>
                        </div>
                        <div class="market-stats">
                            <div class="stat-item">
                                <div class="stat-label">السعر</div>
                                <div class="stat-value" id="disp-price" style="color:var(--green)">${marketPrice.toFixed(4)}</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">تغيير 24س</div>
                                <div class="stat-value" id="disp-change">0.00%</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-label">الحجم</div>
                                <div class="stat-value" id="disp-vol">0 SDM</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- تخطيط التداول -->
                    <div class="trading-layout">
                        <!-- قسم الرسم البياني -->
                        <div class="chart-section">
                            <div class="chart-toolbar">
                                <div class="timeframe-btn ${currentTimeframe==='1m'?'active':''}" onclick="changeTimeframe('1m')">1m</div>
                                <div class="timeframe-btn ${currentTimeframe==='5m'?'active':''}" onclick="changeTimeframe('5m')">5m</div>
                                <div class="timeframe-btn ${currentTimeframe==='15m'?'active':''}" onclick="changeTimeframe('15m')">15m</div>
                                <div class="timeframe-btn ${currentTimeframe==='1h'?'active':''}" onclick="changeTimeframe('1h')">1h</div>
                                <div class="timeframe-btn ${currentTimeframe==='4h'?'active':''}" onclick="changeTimeframe('4h')">4h</div>
                                <div class="timeframe-btn ${currentTimeframe==='1d'?'active':''}" onclick="changeTimeframe('1d')">1d</div>
                            </div>
                            <div class="chart-container">
                                <div id="chart-area" style="width:100%; height:100%;"></div>
                            </div>
                        </div>
                        
                        <!-- دفتر الطلبات -->
                        <div class="orderbook-section">
                            <div class="orderbook-header">
                                <div class="orderbook-tabs">
                                    <div class="ob-tab active" onclick="changeOrderBookDepth('full')">دفتر كامل</div>
                                    <div class="ob-tab" onclick="changeOrderBookDepth('compact')">مختصر</div>
                                </div>
                                <div style="display:flex; justify-content:space-between; font-size:11px; color:var(--text-sec);">
                                    <span>السعر (SDM)</span>
                                    <span>الكمية (MRK)</span>
                                </div>
                            </div>
                            <div class="orderbook-list" id="orderbook-asks"></div>
                            <div style="padding:8px 12px; background:rgba(0,0,0,0.3); border-top:1px solid var(--border); border-bottom:1px solid var(--border);">
                                <div style="display:flex; justify-content:space-between; font-size:12px;">
                                    <span style="color:var(--text-sec)">أقل سعر بيع</span>
                                    <span id="best-ask" style="color:var(--red); font-weight:bold;">${marketPrice.toFixed(4)}</span>
                                </div>
                            </div>
                            <div class="orderbook-list" id="orderbook-bids"></div>
                        </div>
                    </div>
                    
                    <!-- لوحة التنفيذ -->
                    <div class="trading-panel">
                        <div class="order-tabs">
                            <div id="tab-buy" class="order-tab buy active" onclick="setTradeMode('buy')">
                                <i class="fas fa-arrow-up"></i> شراء MRK
                            </div>
                            <div id="tab-sell" class="order-tab sell" onclick="setTradeMode('sell')">
                                <i class="fas fa-arrow-down"></i> بيع MRK
                            </div>
                        </div>
                        
                        <div class="order-form">
                            <div class="form-group">
                                <label class="form-label">
                                    <span>السعر (SDM)</span>
                                    <span id="price-hint" style="color:var(--text-sec);">السوق: ${marketPrice.toFixed(4)}</span>
                                </label>
                                <input type="number" id="trade-price" class="form-input" value="${marketPrice.toFixed(4)}" step="0.0001" min="0">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">
                                    <span>الكمية (MRK)</span>
                                    <span id="balance-hint" style="color:var(--text-sec);">المتاح: 0</span>
                                </label>
                                <input type="number" id="trade-amount" class="form-input" placeholder="0.0" step="0.01" min="0">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">الإجمالي (SDM)</label>
                                <input type="text" id="trade-total" class="form-input" readonly value="0.00">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">النوع</label>
                                <select id="order-type" class="form-input">
                                    <option value="limit">أمر محدد</option>
                                    <option value="market">سعر السوق</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="percentage-buttons">
                            <div class="pct-btn" onclick="calcPct(0.25)">25%</div>
                            <div class="pct-btn" onclick="calcPct(0.50)">50%</div>
                            <div class="pct-btn" onclick="calcPct(0.75)">75%</div>
                            <div class="pct-btn" onclick="calcPct(1.0)">100%</div>
                            <div class="pct-btn" onclick="useMarketPrice()">
                                <i class="fas fa-bolt"></i> سوق
                            </div>
                        </div>
                        
                        <div class="balance-info">
                            <div>
                                <div style="font-size:11px; color:var(--text-sec);">رصيد SDM</div>
                                <div style="font-weight:bold;" id="sdm-balance">${(me.sdmBalance || 0).toFixed(2)}</div>
                            </div>
                            <div>
                                <div style="font-size:11px; color:var(--text-sec);">رصيد MRK</div>
                                <div style="font-weight:bold;" id="mrk-balance">${(me.mrkBalance || 0).toFixed(4)}</div>
                            </div>
                        </div>
                        
                        <button id="execute-trade-btn" class="execute-btn buy" onclick="executeTrade()">
                            <i class="fas fa-rocket"></i>
                            <span id="execute-btn-text">تنفيذ أمر الشراء</span>
                        </button>
                        
                        <div style="font-size:10px; text-align:center; margin-top:12px; color:var(--text-sec);">
                            <i class="fas fa-shield-alt"></i> Sudan Market - تداول آمن وشفاف
                        </div>
                    </div>
                </div>
            `;
            
            // تهيئة المكونات
            initProChart();
            listenToOrderBook();
            listenToMarketStats();
            startRealtimeUpdates();
            
            // إضافة مستمعين للحقول
            document.getElementById('trade-amount').addEventListener('input', updateTradeTotal);
            document.getElementById('trade-price').addEventListener('input', updateTradeTotal);
            document.getElementById('order-type').addEventListener('change', handleOrderTypeChange);
            
            // تحديث الرصيد
            updateBalanceDisplay();
            setTradeMode('buy');
            
        } else if(view === 'wallet') {
            const cash = me.sdmBalance || 0;
            const coins = me.mrkBalance || 0;
            const coinValue = coins * marketPrice;
            const totalEquity = cash + coinValue;
            
            area.innerHTML = `
                <div style="padding:20px;">
                    <div style="background:linear-gradient(135deg, var(--primary), #2563eb); border-radius:16px; padding:25px; text-align:center; margin-bottom:20px;">
                        <p style="color:rgba(255,255,255,0.9); font-size:14px; margin-bottom:5px;">إجمالي القيمة</p>
                        <h1 style="color:white; font-size:36px; margin:0;">${totalEquity.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</h1>
                        <p style="color:rgba(255,255,255,0.8); font-size:14px; margin-top:5px;">SDM</p>
                        <p style="font-size:12px; color:rgba(255,255,255,0.7); margin-top:10px;">
                            ≈ ${(totalEquity * SDM_RATE).toLocaleString()} جنيه سوداني
                        </p>
                    </div>
                    
                    <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:15px; margin-bottom:20px;">
                        <div style="background:var(--bg-card); border-radius:12px; padding:20px; border:1px solid var(--border);">
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                                <div style="width:40px; height:40px; background:var(--green); border-radius:50%; display:flex; align-items:center; justify-content:center;">
                                    <i class="fas fa-dollar-sign" style="color:white;"></i>
                                </div>
                                <div>
                                    <p style="font-size:12px; color:var(--text-sec);">رصيد SDM</p>
                                    <p style="font-size:20px; font-weight:bold; color:white;">${cash.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                                </div>
                            </div>
                            <p style="font-size:11px; color:var(--text-sec);">العملة الأساسية للشراء</p>
                        </div>
                        
                        <div style="background:var(--bg-card); border-radius:12px; padding:20px; border:1px solid var(--border);">
                            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                                <div style="width:40px; height:40px; background:var(--accent); border-radius:50%; display:flex; align-items:center; justify-content:center;">
                                    <i class="fas fa-coins" style="color:white;"></i>
                                </div>
                                <div>
                                    <p style="font-size:12px; color:var(--text-sec);">رصيد MRK</p>
                                    <p style="font-size:20px; font-weight:bold; color:white;">${coins.toLocaleString(undefined, {minimumFractionDigits: 4, maximumFractionDigits: 4})}</p>
                                </div>
                            </div>
                            <p style="font-size:11px; color:var(--text-sec);">قيمتها: ${coinValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} SDM</p>
                        </div>
                    </div>
                    
                    <div style="background:var(--bg-card); border-radius:12px; padding:20px; border:1px solid var(--border); margin-bottom:20px;">
                        <h3 style="color:white; margin-bottom:15px; display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-exchange-alt" style="color:var(--primary);"></i>
                            عمليات سريعة
                        </h3>
                        <div style="display:flex; gap:10px;">
                            <button class="btn-main" style="flex:1;" onclick="showDepositModal()">
                                <i class="fas fa-plus-circle"></i> إيداع
                            </button>
                            <button class="btn-main" style="flex:1; background:var(--accent);" onclick="showWithdrawModal()">
                                <i class="fas fa-minus-circle"></i> سحب
                            </button>
                            <button class="btn-main" style="flex:1; background:var(--green);" onclick="showTransferModal()">
                                <i class="fas fa-paper-plane"></i> تحويل
                            </button>
                        </div>
                    </div>
                    
                    <div style="background:var(--bg-card); border-radius:12px; padding:20px; border:1px solid var(--border);">
                        <h3 style="color:white; margin-bottom:15px; display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-history" style="color:var(--text-sec);"></i>
                            آخر العمليات
                        </h3>
                        <div id="transactions-history" style="font-size:12px; min-height:100px;">
                            <div style="text-align:center; padding:30px; color:var(--text-sec);">
                                <i class="fas fa-clock" style="font-size:24px; margin-bottom:10px;"></i>
                                <p>جاري تحميل السجل...</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            loadTransactions();
            
        } else if(view === 'profile') {
            const isVip = me.vipStatus === 'active';
            const vipExpiry = me.vipExpiry ? new Date(me.vipExpiry).toLocaleDateString('ar-SA') : 'غير مشترك';
            
            area.innerHTML = `
                <div style="padding:20px;">
                    <div style="text-align:center; margin-bottom:30px;">
                        <div id="profile-avatar" style="width:100px; height:100px; border-radius:50%; margin:0 auto 15px; overflow:hidden; border:3px solid var(--primary);">
                            <img src="${me.pic || userPic}" style="width:100%; height:100%; object-fit:cover;">
                        </div>
                        <label style="font-size:12px; color:var(--accent); cursor:pointer; display:inline-block; margin-bottom:10px;">
                            <i class="fas fa-camera"></i> تغيير الصورة
                            <input type="file" hidden onchange="updateProfilePicture(this)">
                        </label>
                        <h2 style="color:white; margin-bottom:5px;">${escapeHtml(me.n)}</h2>
                        <p style="color:var(--text-sec); font-size:12px; margin-bottom:15px;">
                            ${isGuest ? 'زائر' : (me.email || '')}
                        </p>
                        <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;">
                            <span style="background:rgba(59, 130, 246, 0.2); color:var(--primary); padding:6px 12px; border-radius:20px; font-size:12px; border:1px solid var(--primary);">
                                <i class="fas fa-star"></i> ${(me.rating || 5.0).toFixed(1)}
                            </span>
                            ${isVip ? `
                                <span style="background:rgba(245, 158, 11, 0.2); color:var(--accent); padding:6px 12px; border-radius:20px; font-size:12px; border:1px solid var(--accent);">
                                    <i class="fas fa-crown"></i> VIP حتى ${vipExpiry}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div style="background:var(--bg-card); border-radius:12px; padding:20px; border:1px solid var(--border); margin-bottom:20px;">
                        <h3 style="color:white; margin-bottom:15px; display:flex; align-items:center; gap:10px;">
                            <i class="fas fa-id-card" style="color:var(--text-sec);"></i>
                            المعلومات الشخصية
                        </h3>
                        <div style="display:flex; flex-direction:column; gap:12px;">
                            <div>
                                <label style="font-size:12px; color:var(--text-sec); display:block; margin-bottom:5px;">معرف المستخدم</label>
                                <div style="display:flex; align-items:center; gap:10px;">
                                    <input type="text" value="${me.p}" readonly style="flex:1; padding:10px; background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:8px; color:white; font-family:monospace;">
                                    <button onclick="copyToClipboard('${me.p}')" style="background:var(--primary); color:white; border:none; padding:10px 15px; border-radius:8px; cursor:pointer;">
                                        <i class="far fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            
                            ${me.walletAddress ? `
                                <div>
                                    <label style="font-size:12px; color:var(--text-sec); display:block; margin-bottom:5px;">عنوان المحفظة</label>
                                    <div style="display:flex; align-items:center; gap:10px;">
                                        <input type="text" value="${me.walletAddress}" readonly style="flex:1; padding:10px; background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:8px; color:white; font-family:monospace; direction:ltr;">
                                        <button onclick="copyToClipboard('${me.walletAddress}')" style="background:var(--accent); color:white; border:none; padding:10px 15px; border-radius:8px; cursor:pointer;">
                                            <i class="far fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div style="display:flex; gap:10px;">
                        <button class="btn-main" style="flex:1;" onclick="showEditProfileModal()">
                            <i class="fas fa-edit"></i> تعديل الملف
                        </button>
                        <button class="btn-main" style="flex:1; background:rgba(239, 68, 68, 0.2); color:#ef4444; border:1px solid #ef4444;" onclick="doLogout()">
                            <i class="fas fa-sign-out-alt"></i> تسجيل خروج
                        </button>
                    </div>
                </div>
            `;
        }
        
        // إضافة تأثير الدخول
        area.classList.add('animate-slide');
        setTimeout(() => area.classList.remove('animate-slide'), 300);
    }

    // --- 4. منطق التداول المتقدم ---
    function setTradeMode(mode) {
        currentTradeMode = mode;
        const buyTab = document.getElementById('tab-buy');
        const sellTab = document.getElementById('tab-sell');
        const executeBtn = document.getElementById('execute-trade-btn');
        const executeText = document.getElementById('execute-btn-text');
        
        // تحديث التبويبات
        buyTab.classList.toggle('active', mode === 'buy');
        sellTab.classList.toggle('active', mode === 'sell');
        
        // تحديث زر التنفيذ
        if (mode === 'buy') {
            executeBtn.className = 'execute-btn buy';
            executeBtn.style.background = 'linear-gradient(135deg, var(--green), #059669)';
            executeText.innerText = 'تنفيذ أمر الشراء';
        } else {
            executeBtn.className = 'execute-btn sell';
            executeBtn.style.background = 'linear-gradient(135deg, var(--red), #b91c1c)';
            executeText.innerText = 'تنفيذ أمر البيع';
        }
        
        // تحديث عرض الرصيد
        updateBalanceDisplay();
        updateTradeTotal();
    }
    
    function updateBalanceDisplay() {
        if (!me) return;
        
        const sdmBalance = document.getElementById('sdm-balance');
        const mrkBalance = document.getElementById('mrk-balance');
        const balanceHint = document.getElementById('balance-hint');
        
        if (sdmBalance) sdmBalance.innerText = (me.sdmBalance || 0).toFixed(2);
        if (mrkBalance) mrkBalance.innerText = (me.mrkBalance || 0).toFixed(4);
        
        if (balanceHint) {
            if (currentTradeMode === 'buy') {
                balanceHint.innerText = `المتاح: ${(me.sdmBalance || 0).toFixed(2)} SDM`;
            } else {
                balanceHint.innerText = `المتاح: ${(me.mrkBalance || 0).toFixed(4)} MRK`;
            }
        }
    }
    
    function updateTradeTotal() {
        const price = parseFloat(document.getElementById('trade-price').value) || 0;
        const amount = parseFloat(document.getElementById('trade-amount').value) || 0;
        const total = price * amount;
        const totalElement = document.getElementById('trade-total');
        
        if (totalElement) {
            totalElement.value = total.toFixed(2);
        }
        
        // تحديث تلميح السعر
        const priceHint = document.getElementById('price-hint');
        if (priceHint) {
            const diff = ((price - marketPrice) / marketPrice * 100).toFixed(2);
            const diffText = diff >= 0 ? `+${diff}%` : `${diff}%`;
            const diffColor = diff >= 0 ? 'var(--green)' : 'var(--red)';
            priceHint.innerHTML = `السوق: ${marketPrice.toFixed(4)} <span style="color:${diffColor}">(${diffText})</span>`;
        }
    }
    
    function calcPct(pct) {
        const orderType = document.getElementById('order-type')?.value || 'limit';
        
        if (orderType === 'market') {
            if (currentTradeMode === 'buy') {
                const available = me.sdmBalance || 0;
                const marketPriceElement = document.getElementById('trade-price');
                if (marketPriceElement) {
                    marketPriceElement.value = marketPrice.toFixed(4);
                }
                document.getElementById('trade-amount').value = ((available * pct) / marketPrice).toFixed(4);
            } else {
                document.getElementById('trade-amount').value = ((me.mrkBalance || 0) * pct).toFixed(4);
            }
        } else {
            const price = parseFloat(document.getElementById('trade-price').value) || marketPrice;
            
            if (currentTradeMode === 'buy') {
                const available = me.sdmBalance || 0;
                document.getElementById('trade-amount').value = ((available * pct) / price).toFixed(4);
            } else {
                document.getElementById('trade-amount').value = ((me.mrkBalance || 0) * pct).toFixed(4);
            }
        }
        
        updateTradeTotal();
    }
    
    function useMarketPrice() {
        document.getElementById('trade-price').value = marketPrice.toFixed(4);
        document.getElementById('order-type').value = 'market';
        updateTradeTotal();
    }
    
    function handleOrderTypeChange() {
        const orderType = document.getElementById('order-type').value;
        const priceInput = document.getElementById('trade-price');
        
        if (orderType === 'market') {
            priceInput.value = marketPrice.toFixed(4);
            priceInput.readOnly = true;
            priceInput.style.background = 'rgba(0,0,0,0.2)';
            priceInput.style.color = 'var(--text-sec)';
        } else {
            priceInput.readOnly = false;
            priceInput.style.background = '';
            priceInput.style.color = '';
        }
        
        updateTradeTotal();
    }
    
    async function executeTrade() {
        if (Date.now() - lastActionTime < 2000) {
            Swal.fire({
                title: 'تمهل قليلاً',
                text: 'انتظر بين العمليات',
                icon: 'warning',
                toast: true,
                position: 'top',
                timer: 2000,
                showConfirmButton: false,
                background: '#151b29',
                color: '#fff'
            });
            return;
        }
        
        lastActionTime = Date.now();
        
        const orderType = document.getElementById('order-type').value;
        let price = parseFloat(document.getElementById('trade-price').value);
        const amount = parseFloat(document.getElementById('trade-amount').value);
        
        if (orderType === 'market') {
            price = marketPrice;
        }
        
        if (!price || !amount || price <= 0 || amount <= 0) {
            Swal.fire({
                title: 'بيانات غير صحيحة',
                text: 'يرجى التحقق من السعر والكمية',
                icon: 'error',
                background: '#151b29',
                color: '#fff'
            });
            return;
        }
        
        const total = price * amount;
        
        // التحقق من الرصيد
        if (currentTradeMode === 'buy') {
            if ((me.sdmBalance || 0) < total) {
                Swal.fire({
                    title: 'رصيد غير كاف',
                    text: 'رصيد SDM غير كافٍ لإتمام الصفقة',
                    icon: 'error',
                    background: '#151b29',
                    color: '#fff'
                });
                return;
            }
        } else {
            if ((me.mrkBalance || 0) < amount) {
                Swal.fire({
                    title: 'رصيد غير كاف',
                    text: 'رصيد MRK غير كافٍ لإتمام الصفقة',
                    icon: 'error',
                    background: '#151b29',
                    color: '#fff'
                });
                return;
            }
        }
        
        const btn = document.getElementById('execute-trade-btn');
        const originalText = btn.innerHTML;
        
        try {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري المعالجة...';
            
            // إنشاء أمر التداول
            const orderData = {
                uP: me.p,
                uN: me.n,
                type: currentTradeMode,
                orderType: orderType,
                price: price,
                amount: amount,
                total: total,
                date: Date.now(),
                status: 'pending',
                executed: false
            };
            
            // حفظ الأمر في قاعدة البيانات
            const orderRef = await db.ref('market/orders/' + currentTradeMode).push(orderData);
            const orderId = orderRef.key;
            
            // محاولة مطابقة الأمر فوراً
            await tryMatchOrder(orderId, orderData);
            
            Swal.fire({
                title: 'تم الإرسال',
                text: 'تم إرسال أمر التداول بنجاح',
                icon: 'success',
                toast: true,
                position: 'top',
                timer: 3000,
                showConfirmButton: false,
                background: '#151b29',
                color: '#fff'
            });
            
            // إعادة تعيين الحقول
            document.getElementById('trade-amount').value = '';
            updateTradeTotal();
            
        } catch (error) {
            console.error('Error executing trade:', error);
            Swal.fire({
                title: 'خطأ',
                text: 'فشل في تنفيذ الصفقة',
                icon: 'error',
                background: '#151b29',
                color: '#fff'
            });
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }
    
    async function tryMatchOrder(orderId, orderData) {
        const oppositeType = orderData.type === 'buy' ? 'sell' : 'buy';
        const oppositeOrdersRef = db.ref('market/orders/' + oppositeType);
        
        const snapshot = await oppositeOrdersRef.orderByChild('price').once('value');
        const orders = [];
        
        snapshot.forEach(child => {
            const order = child.val();
            if (order.status === 'pending' && !order.executed) {
                orders.push({
                    id: child.key,
                    ...order
                });
            }
        });
        
        // ترتيب الأوامر حسب السعر
        if (orderData.type === 'buy') {
            orders.sort((a, b) => a.price - b.price); // أرخص أوامر البيع أولاً
        } else {
            orders.sort((a, b) => b.price - a.price); // أغلى أوامر الشراء أولاً
        }
        
        let remainingAmount = orderData.amount;
        
        for (const oppositeOrder of orders) {
            if (remainingAmount <= 0) break;
            
            // التحقق من شروط المطابقة
            let canMatch = false;
            if (orderData.type === 'buy') {
                canMatch = orderData.price >= oppositeOrder.price;
            } else {
                canMatch = orderData.price <= oppositeOrder.price;
            }
            
            if (canMatch) {
                const matchAmount = Math.min(remainingAmount, oppositeOrder.amount);
                const matchPrice = oppositeOrder.price;
                const matchTotal = matchAmount * matchPrice;
                
                // تنفيذ الصفقة
                await executeTradeMatch(
                    orderId,
                    orderData,
                    oppositeOrder.id,
                    oppositeOrder,
                    matchAmount,
                    matchPrice,
                    matchTotal
                );
                
                remainingAmount -= matchAmount;
            }
        }
        
        // إذا بقي جزء من الأمر
        if (remainingAmount > 0) {
            await db.ref('market/orders/' + orderData.type + '/' + orderId).update({
                amount: remainingAmount,
                total: remainingAmount * orderData.price,
                status: 'partial'
            });
        } else {
            await db.ref('market/orders/' + orderData.type + '/' + orderId).update({
                status: 'completed',
                executed: true,
                completedAt: Date.now()
            });
        }
    }
    
    async function executeTradeMatch(buyOrderId, buyOrder, sellOrderId, sellOrder, amount, price, total) {
        // تحديث سجل الصفقات
        const tradeRef = await db.ref('market/trades').push({
            buyOrderId: buyOrderId,
            sellOrderId: sellOrderId,
            buyerId: buyOrder.uP,
            sellerId: sellOrder.uP,
            price: price,
            amount: amount,
            total: total,
            date: Date.now(),
            type: 'matched'
        });
        
        // تحديث أرصدة المشتري
        await db.ref('users/' + buyOrder.uP).update({
            mrkBalance: firebase.database.ServerValue.increment(amount),
            sdmBalance: firebase.database.ServerValue.increment(-total)
        });
        
        // تحديث أرصدة البائع
        await db.ref('users/' + sellOrder.uP).update({
            mrkBalance: firebase.database.ServerValue.increment(-amount),
            sdmBalance: firebase.database.ServerValue.increment(total)
        });
        
        // تحديث إحصائيات السوق
        await db.ref('market/stats').update({
            lastPrice: price,
            volume24h: firebase.database.ServerValue.increment(total),
            lastTrade: Date.now()
        });
        
        // تحديث حالة أوامر البيع
        const remainingSellAmount = sellOrder.amount - amount;
        if (remainingSellAmount > 0) {
            await db.ref('market/orders/sell/' + sellOrderId).update({
                amount: remainingSellAmount,
                total: remainingSellAmount * sellOrder.price,
                status: 'partial'
            });
        } else {
            await db.ref('market/orders/sell/' + sellOrderId).update({
                status: 'completed',
                executed: true,
                completedAt: Date.now()
            });
        }
        
        // إرسال إشعارات للمستخدمين
        const buyerMessage = `تم تنفيذ صفقة شراء ${amount.toFixed(4)} MRK بسعر ${price.toFixed(4)} SDM`;
        const sellerMessage = `تم تنفيذ صفقة بيع ${amount.toFixed(4)} MRK بسعر ${price.toFixed(4)} SDM`;
        
        await db.ref('alerts/' + buyOrder.uP).push({
            type: 'success',
            msg: buyerMessage,
            date: Date.now()
        });
        
        await db.ref('alerts/' + sellOrder.uP).push({
            type: 'success',
            msg: sellerMessage,
            date: Date.now()
        });
        
        // تحديث بياناتي المحلية
        if (me.p === buyOrder.uP) {
            me.mrkBalance = (me.mrkBalance || 0) + amount;
            me.sdmBalance = (me.sdmBalance || 0) - total;
        } else if (me.p === sellOrder.uP) {
            me.mrkBalance = (me.mrkBalance || 0) - amount;
            me.sdmBalance = (me.sdmBalance || 0) + total;
        }
        
        updateBalanceDisplay();
    }
    
    // --- 5. دفتر الطلبات في الوقت الحقيقي ---
    function listenToOrderBook() {
        // الاستماع لأوامر البيع (مرتبة من الأقل سعراً)
        db.ref('market/orders/sell')
            .orderByChild('price')
            .limitToFirst(20)
            .on('value', snapshot => renderOrderBook(snapshot, 'orderbook-asks', 'ask'));
        
        // الاستماع لأوامر الشراء (مرتبة من الأعلى سعراً)
        db.ref('market/orders/buy')
            .orderByChild('price')
            .limitToLast(20)
            .on('value', snapshot => renderOrderBook(snapshot, 'orderbook-bids', 'bid'));
    }
    
    function renderOrderBook(snapshot, elementId, type) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        element.innerHTML = '';
        const orders = [];
        
        snapshot.forEach(child => {
            const order = child.val();
            if (order.status === 'pending' || order.status === 'partial') {
                orders.push(order);
            }
        });
        
        // حساب الحجم الكلي للعرض/الطلب
        let totalVolume = 0;
        orders.forEach(order => totalVolume += order.amount);
        
        // عرض الأوامر
        orders.forEach((order, index) => {
            const depthPercentage = (order.amount / totalVolume) * 100;
            
            const row = document.createElement('div');
            row.className = `orderbook-row ${type}-row`;
            row.style.position = 'relative';
            
            row.innerHTML = `
                <div class="orderbook-depth" style="width: ${depthPercentage}%;"></div>
                <div class="orderbook-content">
                    <span style="color: ${type === 'bid' ? 'var(--green)' : 'var(--red)'};">
                        ${order.price.toFixed(4)}
                    </span>
                    <span style="color: white;">
                        ${order.amount.toFixed(4)}
                    </span>
                </div>
            `;
            
            row.onclick = () => {
                document.getElementById('trade-price').value = order.price.toFixed(4);
                document.getElementById('trade-amount').value = order.amount.toFixed(4);
                updateTradeTotal();
                setTradeMode(type === 'bid' ? 'sell' : 'buy');
            };
            
            element.appendChild(row);
        });
        
        // تحديث أفضل سعر
        if (orders.length > 0) {
            const bestPrice = type === 'bid' 
                ? Math.max(...orders.map(o => o.price))
                : Math.min(...orders.map(o => o.price));
            
            if (type === 'ask') {
                document.getElementById('best-ask').innerText = bestPrice.toFixed(4);
            }
        }
    }
    
    function changeOrderBookDepth(depth) {
        document.querySelectorAll('.ob-tab').forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');
        // يمكن إضافة منطق إضافي هنا لتغيير عمق العرض
    }
    
    function changeTimeframe(timeframe) {
        currentTimeframe = timeframe;
        document.querySelectorAll('.timeframe-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        // إعادة تحميل البيانات حسب الإطار الزمني
        loadChartData(timeframe);
    }
    
    // --- 6. الرسم البياني المتقدم ---
    function initProChart() {
        const options = {
            series: [{
                data: []
            }],
            chart: {
                type: 'candlestick',
                height: '100%',
                background: 'transparent',
                toolbar: {
                    show: true,
                    tools: {
                        download: true,
                        selection: true,
                        zoom: true,
                        zoomin: true,
                        zoomout: true,
                        pan: true,
                        reset: true
                    }
                },
                zoom: {
                    enabled: true
                },
                animations: {
                    enabled: true,
                    speed: 800
                }
            },
            theme: {
                mode: 'dark'
            },
            xaxis: {
                type: 'datetime',
                labels: {
                    style: {
                        colors: '#94a3b8',
                        fontSize: '11px'
                    }
                },
                axisBorder: {
                    show: false
                },
                axisTicks: {
                    show: false
                }
            },
            yaxis: {
                tooltip: {
                    enabled: true
                },
                opposite: true,
                labels: {
                    style: {
                        colors: '#94a3b8',
                        fontSize: '11px'
                    },
                    formatter: function(value) {
                        return value.toFixed(4);
                    }
                }
            },
            grid: {
                borderColor: '#1e293b',
                strokeDashArray: 4,
                xaxis: {
                    lines: {
                        show: true
                    }
                },
                yaxis: {
                    lines: {
                        show: true
                    }
                }
            },
            plotOptions: {
                candlestick: {
                    colors: {
                        upward: '#10b981',
                        downward: '#ef4444'
                    },
                    wick: {
                        useFillColor: true
                    }
                }
            },
            tooltip: {
                enabled: true,
                theme: 'dark',
                style: {
                    fontSize: '12px',
                    fontFamily: 'Tajawal'
                },
                x: {
                    format: 'dd MMM yyyy HH:mm'
                },
                y: {
                    formatter: function(value) {
                        return value.toFixed(4) + ' SDM';
                    }
                }
            }
        };
        
        chartInstance = new ApexCharts(document.querySelector("#chart-area"), options);
        chartInstance.render();
        
        // تحميل البيانات الأولية
        loadChartData(currentTimeframe);
    }
    
    function loadChartData(timeframe) {
        // حساب الفترة الزمنية بالميلي ثانية
        let interval = 15 * 60 * 1000; // 15 دقيقة افتراضياً
        
        switch(timeframe) {
            case '1m': interval = 1 * 60 * 1000; break;
            case '5m': interval = 5 * 60 * 1000; break;
            case '15m': interval = 15 * 60 * 1000; break;
            case '1h': interval = 60 * 60 * 1000; break;
            case '4h': interval = 4 * 60 * 60 * 1000; break;
            case '1d': interval = 24 * 60 * 60 * 1000; break;
        }
        
        // جلب البيانات من Firebase
        db.ref('market/trades')
            .orderByChild('date')
            .limitToLast(100)
            .once('value')
            .then(snapshot => {
                const trades = [];
                snapshot.forEach(child => {
                    const trade = child.val();
                    trades.push({
                        x: trade.date,
                        y: [trade.price, trade.price, trade.price, trade.price] // سيفود, هاي, لو, كلوز
                    });
                });
                
                // تحويل البيانات إلى شموع
                const candles = convertToCandles(trades, interval);
                
                // تحديث الرسم البياني
                chartInstance.updateSeries([{
                    data: candles
                }]);
            });
    }
    
    function convertToCandles(trades, interval) {
        const candles = {};
        
        trades.forEach(trade => {
            const candleTime = Math.floor(trade.x / interval) * interval;
            
            if (!candles[candleTime]) {
                candles[candleTime] = {
                    x: candleTime,
                    open: trade.y[3], // close price as open for new candle
                    high: trade.y[1],
                    low: trade.y[2],
                    close: trade.y[3],
                    volume: 1
                };
            } else {
                const candle = candles[candleTime];
                candle.high = Math.max(candle.high, trade.y[1]);
                candle.low = Math.min(candle.low, trade.y[2]);
                candle.close = trade.y[3];
                candle.volume++;
            }
        });
        
        return Object.values(candles).map(c => ({
            x: c.x,
            y: [c.open, c.high, c.low, c.close]
        }));
    }
    
    // --- 7. تحديثات السوق في الوقت الحقيقي ---
    function startRealtimeUpdates() {
        if (realtimeInterval) clearInterval(realtimeInterval);
        
        realtimeInterval = setInterval(() => {
            updateMarketDisplay();
            updateChartWithLatestData();
        }, 1000);
    }
    
    function updateMarketDisplay() {
        // تحديث السعر الحالي
        const priceElement = document.getElementById('disp-price');
        if (priceElement) {
            priceElement.innerText = marketPrice.toFixed(4);
            priceElement.style.color = marketPrice >= OPENING_PRICE ? 'var(--green)' : 'var(--red)';
        }
        
        // تحديث تغيير 24 ساعة
        db.ref('market/stats').once('value').then(snapshot => {
            const stats = snapshot.val() || {};
            const changeElement = document.getElementById('disp-change');
            const volumeElement = document.getElementById('disp-vol');
            
            if (changeElement && stats.lastPrice && stats.openingPrice) {
                const change = ((stats.lastPrice - stats.openingPrice) / stats.openingPrice * 100).toFixed(2);
                changeElement.innerText = change + '%';
                changeElement.style.color = change >= 0 ? 'var(--green)' : 'var(--red)';
            }
            
            if (volumeElement && stats.volume24h) {
                volumeElement.innerText = stats.volume24h.toLocaleString(undefined, {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }) + ' SDM';
            }
        });
    }
    
    function updateChartWithLatestData() {
        db.ref('market/trades')
            .orderByChild('date')
            .limitToLast(1)
            .once('value')
            .then(snapshot => {
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const trade = child.val();
                        // يمكن إضافة المنطق هنا لتحديث الرسم البياني بآخر صفقة
                    });
                }
            });
    }
    
    function listenToMarketStats() {
        db.ref('market/stats').on('value', snapshot => {
            const stats = snapshot.val() || {};
            marketPrice = stats.lastPrice || OPENING_PRICE;
            updateMarketDisplay();
        });
    }
    
    // --- 8. وظائف المساعدة ---
    function goBack() { 
        if (hStack.length > 1) { 
            hStack.pop(); 
            nav(hStack[hStack.length - 1]); 
        } 
    }
    
    function escapeHtml(text) { 
        if (!text) return text; 
        return String(text)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;"); 
    }
    
    function filterContent(q) { 
        q = q.toLowerCase(); 
        document.querySelectorAll('.card, .post').forEach(el => {
            el.style.display = el.innerText.toLowerCase().includes(q) ? 'block' : 'none';
        }); 
    }
    
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            Swal.fire({
                title: 'تم النسخ',
                icon: 'success',
                toast: true,
                position: 'top',
                timer: 2000,
                showConfirmButton: false,
                background: '#151b29',
                color: '#fff'
            });
        });
    }
    
    // --- 9. إدارة المحفظة ---
    function showDepositModal() {
        Swal.fire({
            title: 'إيداع SDM',
            html: `
                <div style="text-align:center; padding:20px;">
                    <div style="background:rgba(59, 130, 246, 0.1); padding:20px; border-radius:12px; margin-bottom:20px;">
                        <i class="fas fa-university" style="font-size:40px; color:var(--primary); margin-bottom:10px;"></i>
                        <h3 style="color:white; margin-bottom:10px;">بنك الخرطوم</h3>
                        <p style="color:var(--text-sec); font-size:14px; margin-bottom:5px;">رقم الحساب:</p>
                        <p style="color:white; font-size:24px; font-weight:bold; font-family:monospace;">4426148</p>
                        <p style="color:var(--text-sec); font-size:12px;">اسم الحساب: محمد</p>
                    </div>
                    
                    <div style="margin-top:20px;">
                        <p style="color:var(--text-sec); font-size:12px; margin-bottom:10px;">
                            بعد التحويل، يرجى إرفاق صورة الإشعار:
                        </p>
                        <input type="file" id="deposit-receipt" accept="image/*" class="form-input" style="margin-bottom:15px;">
                        <input type="number" id="deposit-amount" placeholder="المبلغ (SDM)" class="form-input" style="margin-bottom:15px;">
                        <button onclick="submitDeposit()" class="btn-main" style="width:100%;">
                            <i class="fas fa-check-circle"></i> تأكيد الإيداع
                        </button>
                    </div>
                </div>
            `,
            background: '#151b29',
            color: '#fff',
            showCloseButton: true,
            showConfirmButton: false,
            width: 500
        });
    }
    
    async function submitDeposit() {
        const amount = parseFloat(document.getElementById('deposit-amount').value);
        const receipt = document.getElementById('deposit-receipt');
        
        if (!amount || amount <= 0) {
            Swal.fire({
                title: 'خطأ',
                text: 'يرجى إدخال مبلغ صحيح',
                icon: 'error',
                background: '#151b29',
                color: '#fff'
            });
            return;
        }
        
        if (!receipt.files[0]) {
            Swal.fire({
                title: 'خطأ',
                text: 'يرجى إرفاق صورة الإشعار',
                icon: 'error',
                background: '#151b29',
                color: '#fff'
            });
            return;
        }
        
        try {
            // تحويل الصورة إلى base64
            const reader = new FileReader();
            reader.onload = async (e) => {
                const receiptData = e.target.result;
                
                await db.ref('deposit_requests').push({
                    userId: me.p,
                    userName: me.n,
                    amount: amount,
                    receipt: receiptData,
                    date: Date.now(),
                    status: 'pending'
                });
                
                Swal.fire({
                    title: 'تم الإرسال',
                    text: 'تم إرسال طلب الإيداع بنجاح',
                    icon: 'success',
                    background: '#151b29',
                    color: '#fff'
                });
                
                Swal.close();
            };
            reader.readAsDataURL(receipt.files[0]);
            
        } catch (error) {
            Swal.fire({
                title: 'خطأ',
                text: 'فشل في إرسال الطلب',
                icon: 'error',
                background: '#151b29',
                color: '#fff'
            });
        }
    }
    
    function showWithdrawModal() {
        Swal.fire({
            title: 'سحب SDM',
            html: `
                <div style="text-align:center; padding:20px;">
                    <div style="margin-bottom:20px;">
                        <i class="fas fa-wallet" style="font-size:40px; color:var(--accent); margin-bottom:10px;"></i>
                        <p style="color:var(--text-sec);">الرصيد المتاح: <b style="color:white;">${(me.sdmBalance || 0).toFixed(2)} SDM</b></p>
                    </div>
                    
                    <div style="margin-top:20px;">
                        <input type="number" id="withdraw-amount" placeholder="المبلغ (SDM)" class="form-input" style="margin-bottom:15px;" max="${me.sdmBalance || 0}">
                        <input type="text" id="withdraw-bank" placeholder="اسم البنك" class="form-input" style="margin-bottom:15px;">
                        <input type="text" id="withdraw-account" placeholder="رقم الحساب" class="form-input" style="margin-bottom:15px;">
                        <button onclick="submitWithdraw()" class="btn-main" style="width:100%; background:var(--accent);">
                            <i class="fas fa-paper-plane"></i> طلب السحب
                        </button>
                    </div>
                </div>
            `,
            background: '#151b29',
            color: '#fff',
            showCloseButton: true,
            showConfirmButton: false,
            width: 500
        });
    }
    
    async function submitWithdraw() {
        const amount = parseFloat(document.getElementById('withdraw-amount').value);
        const bank = document.getElementById('withdraw-bank').value;
        const account = document.getElementById('withdraw-account').value;
        
        if (!amount || amount <= 0) {
            Swal.fire({
                title: 'خطأ',
                text: 'يرجى إدخال مبلغ صحيح',
                icon: 'error',
                background: '#151b29',
                color: '#fff'
            });
            return;
        }
        
        if (amount > (me.sdmBalance || 0)) {
            Swal.fire({
                title: 'خطأ',
                text: 'المبلغ المطلوب أكبر من الرصيد المتاح',
                icon: 'error',
                background: '#151b29',
                color: '#fff'
            });
            return;
        }
        
        if (!bank || !account) {
            Swal.fire({
                title: 'خطأ',
                text: 'يرجى إدخال معلومات البنك والحساب',
                icon: 'error',
                background: '#151b29',
                color: '#fff'
            });
            return;
        }
        
        try {
            await db.ref('withdraw_requests').push({
                userId: me.p,
                userName: me.n,
                amount: amount,
                bank: bank,
                account: account,
                date: Date.now(),
                status: 'pending'
            });
            
            Swal.fire({
                title: 'تم الإرسال',
                text: 'تم إرسال طلب السحب بنجاح',
                icon: 'success',
                background: '#151b29',
                color: '#fff'
            });
            
            Swal.close();
            
        } catch (error) {
            Swal.fire({
                title: 'خطأ',
                text: 'فشل في إرسال الطلب',
                icon: 'error',
                background: '#151b29',
                color: '#fff'
            });
        }
    }
    
    function showTransferModal() {
        Swal.fire({
            title: 'تحويل SDM',
            html: `
                <div style="text-align:center; padding:20px;">
                    <div style="margin-bottom:20px;">
                        <i class="fas fa-exchange-alt" style="font-size:40px; color:var(--green); margin-bottom:10px;"></i>
                        <p style="color:var(--text-sec);">الرصيد المتاح: <b style="color:white;">${(me.sdmBalance || 0).toFixed(2)} SDM</b></p>
                    </div>
                    
                    <div style="margin-top:20px;">
                        <input type="text" id="transfer-userid" placeholder="معرف المستلم" class="form-input" style="margin-bottom:15px;">
                        <input type="number" id="transfer-amount" placeholder="المبلغ (SDM)" class="form-input" style="margin-bottom:15px;" max="${me.sdmBalance || 0}">
                        <div id="receiver-info" style="display:none; background:rgba(0,0,0,0.3); padding:15px; border-radius:8px; margin-bottom:15px;">
                            <p style="color:var(--text-sec); margin:0;" id="receiver-name"></p>
                        </div>
                        <button onclick="submitTransfer()" class="btn-main" style="width:100%; background:var(--green);">
                            <i class="fas fa-check-circle"></i> تأكيد التحويل
                        </button>
                    </div>
                </div>
            `,
            background: '#151b29',
            color: '#fff',
            showCloseButton: true,
            showConfirmButton: false,
            width: 500,
            didOpen: () => {
                document.getElementById('transfer-userid').addEventListener('input', async (e) => {
                    const userId = e.target.value.trim();
                    if (userId && userId.length > 5) {
                        const snapshot = await db.ref('users/' + userId).once('value');
                        if (snapshot.exists()) {
                            const user = snapshot.val();
                            document.getElementById('receiver-info').style.display = 'block';
                            document.getElementById('receiver-name').innerText = `المستلم: ${escapeHtml(user.n)}`;
                        } else {
                            document.getElementById('receiver-info').style.display = 'none';
                        }
                    } else {
                        document.getElementById('receiver-info').style.display = 'none';
                    }
                });
            }
        });
    }
    
    async function submitTransfer() {
        const userId = document.getElementById('transfer-userid').value.trim();
        const amount = parseFloat(document.getElementById('transfer-amount').value);
        
        if (!userId) {
            Swal.fire({
                title: 'خطأ',
                text: 'يرجى إدخال معرف المستلم',
                icon: 'error',
                background: '#151b29',
                color: '#fff'
            });
            return;
        }
        
        if (!amount || amount <= 0) {
            Swal.fire({
                title: 'خطأ',
                text: 'يرجى إدخال مبلغ صحيح',
                icon: 'error',
                background: '#151b29',
                color: '#fff'
            });
            return;
        }
        
        if (amount > (me.sdmBalance || 0)) {
            Swal.fire({
                title: 'خطأ',
                text: 'المبلغ المطلوب أكبر من الرصيد المتاح',
                icon: 'error',
                background: '#151b29',
                color: '#fff'
            });
            return;
        }
        
        try {
            // التحقق من وجود المستلم
            const receiverSnapshot = await db.ref('users/' + userId).once('value');
            if (!receiverSnapshot.exists()) {
                Swal.fire({
                    title: 'خطأ',
                    text: 'المستخدم غير موجود',
                    icon: 'error',
                    background: '#151b29',
                    color: '#fff'
                });
                return;
            }
            
            // تسجيل العملية
            const transferRef = await db.ref('transactions').push({
                from: me.p,
                fromName: me.n,
                to: userId,
                toName: receiverSnapshot.val().n,
                amount: amount,
                type: 'transfer',
                date: Date.now(),
                status: 'completed'
            });
            
            // تحديث أرصدة المرسل
            await db.ref('users/' + me.p).update({
                sdmBalance: firebase.database.ServerValue.increment(-amount)
            });
            
            // تحديث أرصدة المستلم
            await db.ref('users/' + userId).update({
                sdmBalance: firebase.database.ServerValue.increment(amount)
            });
            
            // إرسال إشعار للمستلم
            await db.ref('alerts/' + userId).push({
                type: 'info',
                msg: `استلمت تحويلاً بقيمة ${amount.toFixed(2)} SDM من ${me.n}`,
                date: Date.now()
            });
            
            // تحديث بياناتي المحلية
            me.sdmBalance = (me.sdmBalance || 0) - amount;
            updateBalanceDisplay();
            
            Swal.fire({
                title: 'تم التحويل',
                text: `تم تحويل ${amount.toFixed(2)} SDM بنجاح`,
                icon: 'success',
                background: '#151b29',
                color: '#fff'
            });
            
            Swal.close();
            
        } catch (error) {
            Swal.fire({
                title: 'خطأ',
                text: 'فشل في إتمام التحويل',
                icon: 'error',
                background: '#151b29',
                color: '#fff'
            });
        }
    }
    
    function loadTransactions() {
        const historyElement = document.getElementById('transactions-history');
        if (!historyElement) return;
        
        // جلب التحويلات الصادرة
        db.ref('transactions')
            .orderByChild('from')
            .equalTo(me.p)
            .limitToLast(10)
            .once('value')
            .then(snapshot => {
                let transactions = [];
                
                snapshot.forEach(child => {
                    const transaction = child.val();
                    transaction.id = child.key;
                    transaction.direction = 'out';
                    transactions.push(transaction);
                });
                
                // جلب التحويلات الواردة
                return db.ref('transactions')
                    .orderByChild('to')
                    .equalTo(me.p)
                    .limitToLast(10)
                    .once('value')
                    .then(snapshot => {
                        snapshot.forEach(child => {
                            const transaction = child.val();
                            transaction.id = child.key;
                            transaction.direction = 'in';
                            transactions.push(transaction);
                        });
                        
                        // ترتيب حسب التاريخ
                        transactions.sort((a, b) => b.date - a.date);
                        
                        // عرض العمليات
                        displayTransactions(transactions);
                    });
            });
    }
    
    function displayTransactions(transactions) {
        const historyElement = document.getElementById('transactions-history');
        if (!historyElement) return;
        
        if (transactions.length === 0) {
            historyElement.innerHTML = `
                <div style="text-align:center; padding:30px; color:var(--text-sec);">
                    <i class="fas fa-exchange-alt" style="font-size:32px; margin-bottom:10px;"></i>
                    <p>لا توجد عمليات سابقة</p>
                </div>
            `;
            return;
        }
        
        historyElement.innerHTML = transactions.map(transaction => `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid var(--border);">
                <div>
                    <div style="color:white; font-size:14px; margin-bottom:4px;">
                        ${transaction.type === 'transfer' ? 'تحويل' : 'صفقة تداول'}
                    </div>
                    <div style="font-size:11px; color:var(--text-sec);">
                        ${new Date(transaction.date).toLocaleDateString('ar-SA')}
                        ${transaction.direction === 'out' ? `إلى: ${escapeHtml(transaction.toName || '')}` : `من: ${escapeHtml(transaction.fromName || '')}`}
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="color:${transaction.direction === 'out' ? 'var(--red)' : 'var(--green)'}; font-size:16px; font-weight:bold;">
                        ${transaction.direction === 'out' ? '-' : '+'}${transaction.amount.toFixed(2)}
                    </div>
                    <div style="font-size:11px; color:var(--text-sec);">
                        SDM
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    // --- 10. إدارة الملف الشخصي ---
    async function updateProfilePicture(input) {
        if (!input.files[0]) return;
        
        try {
            // تحويل الصورة إلى base64
            const reader = new FileReader();
            reader.onload = async (e) => {
                const imageData = e.target.result;
                
                // تحديث صورة المستخدم
                await db.ref('users/' + me.p).update({
                    pic: imageData
                });
                
                // تحديث بياناتي المحلية
                me.pic = imageData;
                
                // تحديث العرض
                const avatar = document.getElementById('profile-avatar');
                if (avatar) {
                    avatar.innerHTML = `<img src="${imageData}" style="width:100%; height:100%; object-fit:cover;">`;
                }
                
                updateUserAvatar();
                
                Swal.fire({
                    title: 'تم التحديث',
                    text: 'تم تحديث صورة الملف الشخصي',
                    icon: 'success',
                    toast: true,
                    position: 'top',
                    timer: 2000,
                    showConfirmButton: false,
                    background: '#151b29',
                    color: '#fff'
                });
            };
            reader.readAsDataURL(input.files[0]);
            
        } catch (error) {
            Swal.fire({
                title: 'خطأ',
                text: 'فشل في تحديث الصورة',
                icon: 'error',
                background: '#151b29',
                color: '#fff'
            });
        }
    }
    
    function showEditProfileModal() {
        Swal.fire({
            title: 'تعديل الملف الشخصي',
            html: `
                <div style="padding:20px;">
                    <div style="margin-bottom:20px;">
                        <label style="display:block; color:var(--text-sec); font-size:12px; margin-bottom:8px;">الاسم</label>
                        <input type="text" id="edit-name" value="${escapeHtml(me.n)}" class="form-input" style="margin-bottom:15px;">
                        
                        <label style="display:block; color:var(--text-sec); font-size:12px; margin-bottom:8px;">عنوان المحفظة</label>
                        <input type="text" id="edit-wallet" value="${me.walletAddress || ''}" class="form-input" style="margin-bottom:15px; direction:ltr;">
                        
                        <label style="display:block; color:var(--text-sec); font-size:12px; margin-bottom:8px;">رقم الهاتف</label>
                        <input type="text" id="edit-phone" value="${me.phone || ''}" class="form-input" style="margin-bottom:20px;">
                    </div>
                </div>
            `,
            background: '#151b29',
            color: '#fff',
            showCancelButton: true,
            confirmButtonText: 'حفظ',
            cancelButtonText: 'إلغاء',
            width: 500,
            preConfirm: () => {
                const name = document.getElementById('edit-name').value.trim();
                const wallet = document.getElementById('edit-wallet').value.trim();
                const phone = document.getElementById('edit-phone').value.trim();
                
                if (!name) {
                    Swal.showValidationMessage('الرجاء إدخال الاسم');
                    return false;
                }
                
                return { name, wallet, phone };
            }
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const updates = {
                        n: result.value.name,
                        walletAddress: result.value.wallet,
                        phone: result.value.phone,
                        updatedAt: Date.now()
                    };
                    
                    await db.ref('users/' + me.p).update(updates);
                    
                    // تحديث بياناتي المحلية
                    me.n = result.value.name;
                    me.walletAddress = result.value.wallet;
                    me.phone = result.value.phone;
                    
                    Swal.fire({
                        title: 'تم التحديث',
                        text: 'تم تحديث الملف الشخصي بنجاح',
                        icon: 'success',
                        background: '#151b29',
                        color: '#fff'
                    });
                    
                    // إعادة تحميل الصفحة الحالية
                    nav('profile');
                    
                } catch (error) {
                    Swal.fire({
                        title: 'خطأ',
                        text: 'فشل في تحديث الملف الشخصي',
                        icon: 'error',
                        background: '#151b29',
                        color: '#fff'
                    });
                }
            }
        });
    }
    
    // --- 11. لوحة التحكم الإدارية ---
    function initAdminMarketControls() {
        if (me.role !== 'admin') return;
        
        // إعطاء الإدارة 30 مليون MRK إذا لم يكن موجوداً
        if (!me.mrkBalance || me.mrkBalance < 30000000) {
            db.ref('users/' + me.p).update({
                mrkBalance: 30000000
            }).then(() => {
                me.mrkBalance = 30000000;
                updateBalanceDisplay();
            });
        }
        
        // الاستماع لطلبات الإيداع والسحب
        listenForAdminRequests();
    }
    
    function adminSellPanel() {
        if (me.role !== 'admin') return '';
        
        return `
            <div style="background:rgba(245, 158, 11, 0.1); border:2px solid var(--accent); border-radius:12px; padding:16px; margin:12px;">
                <h3 style="color:var(--accent); margin-top:0; margin-bottom:15px; display:flex; align-items:center; gap:10px;">
                    <i class="fas fa-user-shield"></i>
                    لوحة التحكم الإدارية
                </h3>
                <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:12px; margin-bottom:15px;">
                    <div>
                        <label style="font-size:12px; color:var(--text-sec); display:block; margin-bottom:5px;">سعر البيع (SDM)</label>
                        <input type="number" id="admin-sell-price" value="${marketPrice.toFixed(4)}" class="form-input" step="0.0001">
                    </div>
                    <div>
                        <label style="font-size:12px; color:var(--text-sec); display:block; margin-bottom:5px;">الكمية (MRK)</label>
                        <input type="number" id="admin-sell-amount" class="form-input" placeholder="الكمية" min="1">
                    </div>
                </div>
                <div style="font-size:12px; color:var(--text-sec); margin-bottom:15px;">
                    الرصيد المتاح: <b style="color:var(--accent)">${(me.mrkBalance || 0).toLocaleString()} MRK</b>
                </div>
                <button onclick="executeAdminSell()" class="btn-main" style="background:var(--accent); color:black;">
                    <i class="fas fa-coins"></i> وضع أمر بيع إداري
                </button>
            </div>
        `;
    }
    
    async function executeAdminSell() {
        const price = parseFloat(document.getElementById('admin-sell-price').value);
        const amount = parseFloat(document.getElementById('admin-sell-amount').value);
        
        if (!price || !amount || price <= 0 || amount <= 0) {
            Swal.fire({
                title: 'خطأ',
                text: 'يرجى إدخال سعر وكمية صحيحين',
                icon: 'error',
                background: '#151b29',
                color: '#fff'
            });
            return;
        }
        
        if (amount > (me.mrkBalance || 0)) {
            Swal.fire({
                title: 'خطأ',
                text: 'الكمية المطلوبة أكبر من الرصيد المتاح',
                icon: 'error',
                background: '#151b29',
                color: '#fff'
            });
            return;
        }
        
        try {
            const orderData = {
                uP: me.p,
                uN: me.n + ' (إدارة)',
                type: 'sell',
                orderType: 'limit',
                price: price,
                amount: amount,
                total: price * amount,
                date: Date.now(),
                status: 'pending',
                executed: false,
                isAdmin: true
            };
            
            await db.ref('market/orders/sell').push(orderData);
            
            Swal.fire({
                title: 'تم',
                text: 'تم وضع أمر البيع الإداري بنجاح',
                icon: 'success',
                background: '#151b29',
                color: '#fff'
            });
            
            document.getElementById('admin-sell-amount').value = '';
            
        } catch (error) {
            Swal.fire({
                title: 'خطأ',
                text: 'فشل في وضع أمر البيع',
                icon: 'error',
                background: '#151b29',
                color: '#fff'
            });
        }
    }
    
    function listenForAdminRequests() {
        if (me.role !== 'admin') return;
        
        const adminArea = document.getElementById('admin-notifications-area');
        if (!adminArea) return;
        
        // الاستماع لطلبات الإيداع
        db.ref('deposit_requests')
            .orderByChild('status')
            .equalTo('pending')
            .on('value', snapshot => {
                let html = '';
                snapshot.forEach(child => {
                    const request = child.val();
                    html += `
                        <div style="background:rgba(59, 130, 246, 0.1); border:1px solid var(--primary); border-radius:12px; padding:15px; margin:10px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                <div>
                                    <h4 style="color:white; margin:0;">طلب إيداع</h4>
                                    <p style="color:var(--text-sec); font-size:12px; margin:5px 0;">
                                        ${escapeHtml(request.userName)} - ${request.amount} SDM
                                    </p>
                                </div>
                                <div style="display:flex; gap:10px;">
                                    <button onclick="approveRequest('deposit_requests', '${child.key}', ${request.amount}, '${request.userId}')" style="background:var(--green); color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer;">
                                        قبول
                                    </button>
                                    <button onclick="rejectRequest('deposit_requests', '${child.key}')" style="background:var(--red); color:white; border:none; padding:8px 15px; border-radius:8px; cursor:pointer;">
                                        رفض
                                    </button>
                                </div>
                            </div>
                            <div style="text-align:center;">
                                <img src="${request.receipt}" style="max-width:100%; max-height:200px; border-radius:8px; cursor:pointer;" onclick="viewReceipt('${request.receipt}')">
                            </div>
                        </div>
                    `;
                });
                
                adminArea.innerHTML = html;
            });
    }
    
    function viewReceipt(receiptUrl) {
        Swal.fire({
            imageUrl: receiptUrl,
            imageAlt: 'صورة الإشعار',
            showCloseButton: true,
            background: '#151b29',
            color: '#fff'
        });
    }
    
    async function approveRequest(path, requestId, amount, userId) {
        try {
            // تحديث حالة الطلب
            await db.ref(path + '/' + requestId).update({
                status: 'approved',
                processedAt: Date.now(),
                processedBy: me.p
            });
            
            // إذا كان طلب إيداع، زيادة رصيد المستخدم
            if (path === 'deposit_requests') {
                await db.ref('users/' + userId).update({
                    sdmBalance: firebase.database.ServerValue.increment(amount)
                });
                
                // إرسال إشعار للمستخدم
                await db.ref('alerts/' + userId).push({
                    type: 'success',
                    msg: `تمت الموافقة على إيداعك بقيمة ${amount} SDM`,
                    date: Date.now()
                });
            }
            
            Swal.fire({
                title: 'تمت الموافقة',
                text: 'تمت معالجة الطلب بنجاح',
                icon: 'success',
                background: '#151b29',
                color: '#fff'
            });
            
        } catch (error) {
            Swal.fire({
                title: 'خطأ',
                text: 'فشل في معالجة الطلب',
                icon: 'error',
                background: '#151b29',
                color: '#fff'
            });
        }
    }
    
    async function rejectRequest(path, requestId) {
        try {
            await db.ref(path + '/' + requestId).update({
                status: 'rejected',
                processedAt: Date.now(),
                processedBy: me.p
            });
            
            Swal.fire({
                title: 'تم الرفض',
                text: 'تم رفض الطلب',
                icon: 'info',
                background: '#151b29',
                color: '#fff'
            });
            
        } catch (error) {
            Swal.fire({
                title: 'خطأ',
                text: 'فشل في معالجة الطلب',
                icon: 'error',
                background: '#151b29',
                color: '#fff'
            });
        }
    }
</script>
</body>
</html>

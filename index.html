<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>منصة التعليم الذكي | البث الجماعي + المساعد الذكي + رفع الملفات</title>
    
    <!-- خطوط عربية -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
    
    <!-- Firebase (للتوثيق فقط، التخزين بالبوت) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Socket.io -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- UI Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ========== الأنماط الأساسية ========== */
        :root {
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.95);
            --primary: #3b82f6;
            --accent: #f59e0b;
            --neon-blue: #00f3ff;
            --text-main: #f8fafc;
            --text-sec: #94a3b8;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --red: #ef4444; 
            --green: #10b981; 
            --purple: #8b5cf6;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
        }
        
        body {
            font-family: 'Tajawal', sans-serif; 
            margin: 0;
            background: radial-gradient(circle at top, #1e293b, #0f172a); 
            color: var(--text-main);
            padding-bottom: 90px;
            min-height: 100vh;
            user-select: none;
            overflow-x: hidden;
        }

        .hidden { display: none !important; }
        
        /* ========== شاشة تسجيل الدخول ========== */
        .login-screen {
            padding: 40px 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        
        .login-logo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            border: 3px solid var(--neon-blue);
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.3);
        }
        
        .login-title {
            font-size: 42px;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--neon-blue), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            text-align: center;
        }
        
        .login-subtitle {
            color: var(--text-sec);
            margin-bottom: 40px;
            font-size: 16px;
            text-align: center;
        }
        
        .login-form {
            width: 100%;
            max-width: 400px;
        }
        
        .login-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: white;
            font-family: 'Tajawal';
            font-size: 16px;
        }
        
        .login-input:focus {
            border-color: var(--accent);
            outline: none;
            background: rgba(0,0,0,0.4);
        }
        
        .login-btn {
            background: linear-gradient(90deg, var(--primary), #2563eb);
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: 0.3s;
        }
        
        .login-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .login-footer {
            margin-top: 30px;
            color: var(--text-sec);
            text-align: center;
        }
        
        .login-footer a {
            color: var(--neon-blue);
            text-decoration: none;
            cursor: pointer;
        }

        /* ========== الهيدر والبحث ========== */
        header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            padding: 15px 20px;
            position: sticky; 
            top: 0; 
            z-index: 1000;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .header-top { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            width: 100%; 
            margin-bottom: 10px;
        }
        
        .search-container { 
            position: relative; 
            width: 100%; 
        }
        
        .search-container input {
            width: 100%; 
            padding: 12px 45px 12px 15px;
            border-radius: 15px; 
            border: 1px solid var(--border);
            font-size: 14px; 
            background: var(--glass); 
            color: white;
            transition: 0.3s; 
            font-family: 'Tajawal';
        }
        
        .search-container input:focus { 
            background: rgba(255,255,255,0.1); 
            border-color: var(--neon-blue); 
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); 
        }
        
        .search-container i { 
            position: absolute; 
            right: 15px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--accent); 
        }

        /* ========== البطاقات والجريد ========== */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 15px; 
            padding: 15px; 
        }
        
        .card { 
            background: var(--bg-card); 
            border-radius: 18px; 
            padding: 20px; 
            text-align: center; 
            border: 1px solid var(--border); 
            transition: 0.3s; 
            position: relative; 
            overflow: hidden; 
            backdrop-filter: blur(5px); 
            color: var(--text-main); 
            cursor: pointer;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .card:active { transform: scale(0.96); }
        
        .card:hover { 
            border-color: var(--neon-blue); 
            box-shadow: 0 5px 20px rgba(0, 243, 255, 0.15); 
            transform: translateY(-5px); 
        }
        
        .card i { 
            font-size: 32px; 
            margin-bottom: 10px; 
            background: linear-gradient(45deg, #fff, #aaa); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        
        .card-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--accent);
            color: black;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 10px;
            font-weight: bold;
        }

        /* ========== الأزرار ========== */
        .btn-main { 
            background: linear-gradient(90deg, var(--primary), #2563eb); 
            color: white; 
            border: none; 
            padding: 15px; 
            width: 100%; 
            border-radius: 12px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 16px; 
            margin-top: 10px; 
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); 
            transition: 0.3s; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-main:hover { opacity: 0.9; }
        
        .btn-secondary { 
            background: transparent; 
            border: 1px solid var(--text-sec); 
            color: var(--text-sec); 
            width: 100%; 
            padding: 12px; 
            border-radius: 10px; 
            margin-top: 10px; 
            cursor: pointer; 
        }
        
        .btn-danger { 
            background: var(--red); 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 10px; 
            cursor: pointer; 
        }
        
        .btn-success { 
            background: var(--green); 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 10px; 
            cursor: pointer; 
        }

        /* ========== المدخلات ========== */
        input, textarea, select { 
            width: 100%; 
            padding: 15px; 
            margin: 8px 0; 
            background: rgba(0,0,0,0.2); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            color: white; 
            font-family: 'Tajawal'; 
            box-sizing: border-box; 
        }
        
        input:focus, textarea:focus, select:focus { 
            border-color: var(--accent); 
            outline: none; 
            background: rgba(0,0,0,0.4); 
        }

        /* ========== المنشورات والكتب ========== */
        .post { 
            background: var(--bg-card); 
            margin: 15px; 
            border-radius: 20px; 
            overflow: hidden; 
            border: 1px solid var(--border); 
            animation: fadeIn 0.5s ease; 
            position: relative; 
        }
        
        .book-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .book-cover {
            width: 80px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            border: 1px solid var(--accent);
        }
        
        .grade-badge {
            background: var(--purple);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 5px;
        }

        /* ========== التبويبات السفلية ========== */
        .bottom-tabs {
            position: fixed; 
            bottom: 20px; 
            left: 20px; 
            right: 20px; 
            background: rgba(30, 41, 59, 0.95); 
            backdrop-filter: blur(15px); 
            border-radius: 25px; 
            display: flex; 
            justify-content: space-around; 
            padding: 12px 0; 
            box-shadow: var(--shadow);
            border: 1px solid var(--border); 
            z-index: 1000;
        }
        
        .tab-btn { 
            color: var(--text-sec); 
            text-align: center; 
            font-size: 10px; 
            transition: 0.3s; 
            position: relative; 
            flex: 1; 
            cursor: pointer; 
        }
        
        .tab-btn i { 
            font-size: 22px; 
            margin-bottom: 4px; 
            display: block; 
            transition: 0.3s; 
        }
        
        .tab-btn.active { color: var(--neon-blue); }
        .tab-btn.active i { transform: translateY(-5px); text-shadow: 0 0 10px var(--neon-blue); }

        /* ========== البث المباشر - تصميم جديد ========== */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            padding: 15px;
        }
        
        .video-item {
            background: var(--bg-card);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid var(--border);
        }
        
        .video-header {
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .video-player {
            width: 100%;
            height: 200px;
            background: #000;
            object-fit: cover;
        }
        
        .video-controls {
            padding: 10px;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .live-badge {
            background: var(--red);
            color: white;
            padding: 3px 10px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* ========== قائمة المشاركين ========== */
        .participants-panel {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .participant-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }
        
        .participant-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .payment-status {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .paid { background: var(--green); color: white; }
        .unpaid { background: var(--red); color: white; }

        /* ========== الدردشة ========== */
        .chat-container {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin: 15px;
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 10px;
            max-width: 80%;
        }
        
        .message-sent {
            background: var(--primary);
            color: white;
            margin-left: auto;
        }
        
        .message-received {
            background: var(--bg-dark);
            color: var(--text-main);
            margin-right: auto;
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }

        /* ========== المكتبة ========== */
        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            padding: 15px;
        }
        
        .book-item {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border);
            transition: 0.3s;
        }
        
        .book-icon {
            font-size: 50px;
            color: var(--accent);
            margin-bottom: 15px;
        }
        
        .book-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* ========== الاختبارات ========== */
        .quiz-container {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 25px;
            margin: 15px;
        }
        
        .question-card {
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        
        .option-item {
            background: rgba(255,255,255,0.05);
            padding: 12px;
            margin: 8px 0;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .option-item:hover {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid var(--primary);
        }
        
        .option-item.selected {
            background: var(--primary);
            color: white;
        }
        
        .timer {
            background: var(--red);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            display: inline-block;
            font-weight: bold;
        }

        /* ========== نظام الدفع ========== */
        .payment-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border-radius: 20px;
            padding: 25px;
            margin: 15px;
        }
        
        .bank-info {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        
        .subscription-plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .plan-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 2px solid var(--border);
            transition: 0.3s;
        }
        
        .plan-card:hover {
            border-color: var(--accent);
            transform: translateY(-5px);
        }
        
        .plan-price {
            font-size: 28px;
            font-weight: bold;
            color: var(--accent);
            margin: 10px 0;
        }

        /* ========== لوحة الإدمن ========== */
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 15px;
        }
        
        .stat-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--neon-blue);
            margin: 10px 0;
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .admin-table th, .admin-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }
        
        .admin-table th {
            background: rgba(0,0,0,0.3);
            color: var(--accent);
        }

        /* ========== رفع الملفات ========== */
        .upload-container {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 25px;
            margin: 15px;
        }
        
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .upload-area:hover {
            border-color: var(--accent);
            background: rgba(245, 158, 11, 0.05);
        }
        
        .upload-area.dragover {
            border-color: var(--neon-blue);
            background: rgba(0, 243, 255, 0.05);
        }
        
        .upload-preview {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            flex-wrap: wrap;
        }
        
        .preview-item {
            width: 100px;
            height: 100px;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border);
        }
        
        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .preview-remove {
            position: absolute;
            top: 5px;
            left: 5px;
            background: var(--red);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .upload-progress {
            margin: 15px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            transition: width 0.3s;
        }

        /* ========== قارئ الكتب الجديد ========== */
        .book-reader {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 25px;
            margin: 15px;
            height: 600px;
            display: flex;
            flex-direction: column;
        }
        
        .reader-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .reader-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            font-size: 18px;
            line-height: 1.8;
            text-align: justify;
        }
        
        .reader-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        
        .page-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .font-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .bookmark-btn {
            background: var(--accent);
            color: black;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .bookmark-btn.active {
            background: var(--green);
            color: white;
        }

        /* ========== التحميل ========== */
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: var(--text-sec); 
        }
        
        .loading-spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== متجاوب ========== */
        @media (max-width: 768px) {
            .grid { grid-template-columns: repeat(2, 1fr); }
            .bottom-tabs { left: 10px; right: 10px; bottom: 10px; }
            .card { padding: 15px; min-height: 130px; }
            .card i { font-size: 28px; }
            .login-title { font-size: 32px; }
            .login-logo { width: 100px; height: 100px; }
            .video-grid { grid-template-columns: 1fr; }
            .subscription-plans { grid-template-columns: 1fr; }
            .book-reader { height: 500px; padding: 15px; }
            .reader-content { font-size: 16px; padding: 15px; }
        }
        
        @media (max-width: 480px) {
            .grid { grid-template-columns: 1fr; }
            header { padding: 12px 15px; }
            .login-screen { padding: 20px 15px; }
            .books-grid { grid-template-columns: 1fr; }
            .admin-stats { grid-template-columns: repeat(2, 1fr); }
            .book-reader { height: 400px; }
            .reader-content { font-size: 14px; }
        }
    </style>
</head>
<body>
<!-- شاشة تسجيل الدخول -->
<div id="login-screen">
    <div class="login-screen">
        <div class="login-logo">
            <i class="fas fa-graduation-cap"></i>
        </div>
        
        <h1 class="login-title">منصة التعليم الذكي</h1>
        <p class="login-subtitle">البث الجماعي + المساعد الذكي + نظام دفع آمن + رفع الملفات</p>
        
        <div class="login-form">
            <input type="text" id="login-email" class="login-input" placeholder="البريد الإلكتروني أو اسم المستخدم">
            <input type="password" id="login-password" class="login-input" placeholder="كلمة المرور">
            
            <button class="login-btn" onclick="loginUser()">
                <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
            </button>
            
            <button class="btn-secondary" onclick="resendVerification()" style="margin-top: 10px;">
                <i class="fas fa-redo"></i> إعادة إرسال رسالة التأكيد
            </button>
            
            <p class="login-footer">
                ليس لديك حساب؟ 
                <a onclick="showRegisterOptions()">سجل الآن</a>
            </p>
        </div>
    </div>
</div>

<!-- شاشة خيارات التسجيل -->
<div id="register-screen" class="hidden">
    <div style="padding:40px; text-align:center; height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div style="width:120px; height:120px; border-radius:50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display:flex; align-items:center; justify-content:center; margin-bottom:30px;">
            <i class="fas fa-graduation-cap" style="font-size:50px; color:white;"></i>
        </div>
        <h1 style="font-size: 42px; margin-bottom:10px; background: linear-gradient(45deg, var(--neon-blue), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight:800;">منصة التعليم الذكي</h1>
        <p style="color:var(--text-sec); margin-bottom:40px; font-size:16px;">اختر نوع حسابك</p>
        
        <div style="width:100%; max-width:400px;">
            <button class="btn-main" onclick="showStudentForm()" style="margin-bottom:15px;">
                <i class="fas fa-user-graduate"></i> أنا طالب
            </button>
            
            <button class="btn-secondary" onclick="showTeacherForm()">
                <i class="fas fa-chalkboard-teacher"></i> أنا أستاذ
            </button>
            
            <button class="btn-secondary" onclick="backToLogin()" style="margin-top:20px;">
                <i class="fas fa-arrow-right"></i> العودة لتسجيل الدخول
            </button>
        </div>
    </div>
</div>

<!-- نموذج تسجيل الطالب -->
<div id="student-form" class="hidden">
    <div style="padding:20px;">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:30px;">
            <button class="btn-secondary" onclick="backToRegister()" style="width:auto; padding:10px 15px;">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
            <h2 style="color:var(--neon-blue); margin:0;">تسجيل حساب طالب</h2>
        </div>
        
        <div style="background:var(--bg-card); padding:25px; border-radius:20px;">
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-user"></i> الاسم الكامل *
                </label>
                <input type="text" id="student-name" placeholder="أدخل اسمك الكامل" required>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-envelope"></i> البريد الإلكتروني *
                </label>
                <input type="email" id="student-email" placeholder="example@email.com" required>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-lock"></i> كلمة المرور *
                </label>
                <input type="password" id="student-password" placeholder="كلمة مرور قوية" required>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-calendar"></i> عمرك *
                </label>
                <select id="student-age" required>
                    <option value="">اختر عمرك</option>
                    <option value="6">6 سنوات</option>
                    <option value="7">7 سنوات</option>
                    <option value="8">8 سنوات</option>
                    <option value="9">9 سنوات</option>
                    <option value="10">10 سنوات</option>
                    <option value="11">11 سنوات</option>
                    <option value="12">12 سنوات</option>
                    <option value="13">13 سنوات</option>
                    <option value="14">14 سنوات</option>
                    <option value="15">15 سنوات</option>
                    <option value="16">16 سنوات</option>
                    <option value="17">17 سنوات</option>
                    <option value="18">18 سنة فأكثر</option>
                </select>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-graduation-cap"></i> الصف الدراسي *
                </label>
                <select id="student-grade" required>
                    <option value="">اختر صفك الدراسي</option>
                    <option value="الأول الابتدائي">الصف الأول الابتدائي</option>
                    <option value="الثاني الابتدائي">الصف الثاني الابتدائي</option>
                    <option value="الثالث الابتدائي">الصف الثالث الابتدائي</option>
                    <option value="الرابع الابتدائي">الصف الرابع الابتدائي</option>
                    <option value="الخامس الابتدائي">الصف الخامس الابتدائي</option>
                    <option value="السادس الابتدائي">الصف السادس الابتدائي</option>
                    <option value="الأول المتوسط">الصف الأول المتوسط</option>
                    <option value="الثاني المتوسط">الصف الثاني المتوسط</option>
                    <option value="الثالث المتوسط">الصف الثالث المتوسط</option>
                    <option value="الأول الثانوي">الصف الأول الثانوي</option>
                    <option value="الثاني الثانوي">الصف الثاني الثانوي</option>
                    <option value="الثالث الثانوي">الصف الثالث الثانوي</option>
                </select>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-book"></i> المواد المفضلة *
                </label>
                <div id="favorite-subjects" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:10px;">
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" value="الرياضيات" class="subject-checkbox">
                        <span>الرياضيات</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" value="العلوم" class="subject-checkbox">
                        <span>العلوم</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" value="اللغة العربية" class="subject-checkbox">
                        <span>اللغة العربية</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" value="اللغة الإنجليزية" class="subject-checkbox">
                        <span>اللغة الإنجليزية</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" value="الاجتماعيات" class="subject-checkbox">
                        <span>الاجتماعيات</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" value="التربية الإسلامية" class="subject-checkbox">
                        <span>التربية الإسلامية</span>
                    </label>
                </div>
            </div>
            
            <button class="btn-main" onclick="registerStudent()">
                <i class="fas fa-check"></i> إنشاء حساب طالب
            </button>
        </div>
    </div>
</div>

<!-- نموذج تسجيل الأستاذ -->
<div id="teacher-form" class="hidden">
    <div style="padding:20px;">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:30px;">
            <button class="btn-secondary" onclick="backToRegister()" style="width:auto; padding:10px 15px;">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
            <h2 style="color:var(--neon-blue); margin:0;">تسجيل حساب أستاذ</h2>
        </div>
        
        <div style="background:var(--bg-card); padding:25px; border-radius:20px;">
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-user"></i> الاسم الكامل *
                </label>
                <input type="text" id="teacher-name" placeholder="أدخل اسمك الكامل" required>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-envelope"></i> البريد الإلكتروني *
                </label>
                <input type="email" id="teacher-email" placeholder="example@email.com" required>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-lock"></i> كلمة المرور *
                </label>
                <input type="password" id="teacher-password" placeholder="كلمة مرور قوية" required>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-book"></i> المادة الدراسية *
                </label>
                <select id="teacher-subject" required>
                    <option value="">اختر المادة التي تدرسها</option>
                    <option value="الرياضيات">الرياضيات</option>
                    <option value="العلوم">العلوم</option>
                    <option value="اللغة العربية">اللغة العربية</option>
                    <option value="اللغة الإنجليزية">اللغة الإنجليزية</option>
                    <option value="الفيزياء">الفيزياء</option>
                    <option value="الكيمياء">الكيمياء</option>
                    <option value="الأحياء">الأحياء</option>
                    <option value="التاريخ">التاريخ</option>
                    <option value="الجغرافيا">الجغرافيا</option>
                    <option value="التربية الإسلامية">التربية الإسلامية</option>
                    <option value="الحاسوب">الحاسوب</option>
                </select>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-graduation-cap"></i> الصفوف التي تدرسها *
                </label>
                <select id="teacher-grades" multiple style="height:120px;">
                    <option value="جميع الصفوف">جميع الصفوف</option>
                    <option value="الأول الابتدائي">الصف الأول الابتدائي</option>
                    <option value="الثاني الابتدائي">الصف الثاني الابتدائي</option>
                    <option value="الثالث الابتدائي">الصف الثالث الابتدائي</option>
                    <option value="الرابع الابتدائي">الصف الرابع الابتدائي</option>
                    <option value="الخامس الابتدائي">الصف الخامس الابتدائي</option>
                    <option value="السادس الابتدائي">الصف السادس الابتدائي</option>
                    <option value="الأول المتوسط">الصف الأول المتوسط</option>
                    <option value="الثاني المتوسط">الصف الثاني المتوسط</option>
                    <option value="الثالث المتوسط">الصف الثالث المتوسط</option>
                    <option value="الأول الثانوي">الصف الأول الثانوي</option>
                    <option value="الثاني الثانوي">الصف الثاني الثانوي</option>
                    <option value="الثالث الثانوي">الصف الثالث الثانوي</option>
                </select>
                <small style="color:var(--text-sec);">اضغط Ctrl لتحديد أكثر من صف</small>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-phone"></i> رقم الواتساب للتواصل *
                </label>
                <input type="tel" id="teacher-whatsapp" placeholder="مثال: 0912345678" required>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-id-card"></i> صورة البطاقة الشخصية أو الرخصة *
                </label>
                <input type="file" id="teacher-id" accept="image/*" required>
                <small style="color:var(--text-sec);">للمراجعة من قبل الإدمن</small>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-bank"></i> رقم حسابك البنكي (لتحويل الطلاب)
                </label>
                <input type="text" id="teacher-account" placeholder="رقم حسابك البنكي">
            </div>
            
            <div style="margin-bottom:20px; padding:15px; background:rgba(245, 158, 11, 0.1); border-radius:10px;">
                <p style="color:var(--accent); font-size:14px; margin:0;">
                    <i class="fas fa-info-circle"></i> ملاحظة: الشهر الأول مجاني، بعدها اشتراك شهري 30,000 جنيه
                </p>
            </div>
            
            <button class="btn-main" onclick="registerTeacher()">
                <i class="fas fa-paper-plane"></i> إرسال طلب التسجيل
            </button>
        </div>
    </div>
</div>

<!-- التطبيق الرئيسي -->
<div id="app-screen" class="hidden">
    <header>
        <div class="header-top">
            <span onclick="handleBackButton()" style="cursor:pointer; font-size:22px; color:var(--text-sec); width:30px; height:30px; display:flex; align-items:center; justify-content:center;">
                <i class="fas fa-arrow-right"></i>
            </span>
            <span id="head-title" style="font-weight: 800; font-size: 20px; color: var(--text-main); text-align:center; flex:1;">الرئيسية</span>
            <div id="user-badge" style="background:rgba(255,255,255,0.1); padding:5px 12px; border-radius:15px; display:flex; align-items:center; gap:8px; cursor:pointer;" onclick="nav('profile')">
                <i class="fas fa-user" style="color:var(--accent); font-size:14px;"></i>
                <span id="user-name" style="font-size:14px; font-weight:bold;"></span>
                <span id="user-status" style="font-size:10px; background:var(--green); color:white; padding:2px 6px; border-radius:10px;">نشط</span>
            </div>
        </div>
        <div class="search-container" id="main-search">
            <i class="fas fa-search"></i>
            <input type="text" id="store-search" placeholder="ابحث في الكتب، الفصول، الأساتذة..." oninput="debounceFilter(this.value)">
        </div>
    </header>

    <div id="content-area"></div>

    <!-- التبويبات السفلية -->
    <div class="bottom-tabs">
        <div class="tab-btn active" onclick="nav('home'); highlightTab(this)">
            <i class="fas fa-home"></i>الرئيسية
        </div>
        <div class="tab-btn" onclick="nav('library'); highlightTab(this)">
            <i class="fas fa-book"></i>المكتبة
        </div>
        <div class="tab-btn" onclick="nav('upload'); highlightTab(this)">
            <i class="fas fa-cloud-upload-alt"></i>الرفع
        </div>
        <div class="tab-btn" onclick="nav('live'); highlightTab(this)">
            <i class="fas fa-video"></i>البث المباشر
        </div>
        <div class="tab-btn" onclick="nav('subscription'); highlightTab(this)">
            <i class="fas fa-credit-card"></i>الاشتراك
        </div>
    </div>
</div>

<!-- شاشة رفع الملفات -->
<div id="upload-screen" class="hidden">
    <div style="padding:20px;">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
            <button class="btn-secondary" onclick="nav('home')" style="width:auto; padding:10px 15px;">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
            <h2 style="color:var(--neon-blue); margin:0;">رفع الملفات إلى البوت + Telegram</h2>
        </div>
        
        <div class="upload-container">
            <div style="margin-bottom:25px;">
                <h3><i class="fas fa-upload"></i> رفع الملفات العامة</h3>
                <p style="color:var(--text-sec);">ارفع صور، فيديوهات، أو مستندات لتخزينها وإرسالها إلى Telegram</p>
            </div>
            
            <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                <i class="fas fa-cloud-upload-alt" style="font-size:50px; color:var(--accent); margin-bottom:15px;"></i>
                <h4>اسحب الملفات هنا أو انقر للاختيار</h4>
                <p style="color:var(--text-sec);">يمكنك رفع عدة ملفات مرة واحدة (الحد الأقصى: 100MB لكل ملف)</p>
                <input type="file" id="file-input" multiple style="display:none;" onchange="handleFileSelect(event)">
            </div>
            
            <div id="upload-preview" class="upload-preview"></div>
            
            <div style="margin:20px 0;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-folder"></i> اختيار المجلد
                </label>
                <select id="upload-folder" style="width:100%;">
                    <option value="images">الصور</option>
                    <option value="videos">الفيديوهات</option>
                    <option value="avatars">صور المستخدمين</option>
                    <option value="telegram_uploads">رفوعات Telegram</option>
                </select>
            </div>
            
            <div style="margin:20px 0;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-comment"></i> وصف الملف (اختياري)
                </label>
                <textarea id="upload-caption" placeholder="أضف وصفاً للملف..." rows="3"></textarea>
            </div>
            
            <div id="upload-progress" class="upload-progress" style="display:none;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>جاري الرفع...</span>
                    <span id="progress-percentage">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill" style="width:0%;"></div>
                </div>
            </div>
            
            <button class="btn-main" onclick="uploadFiles()" id="upload-button">
                <i class="fas fa-paper-plane"></i> رفع الملفات إلى البوت + Telegram
            </button>
            
            <div style="margin-top:30px; background:rgba(59, 130, 246, 0.1); padding:15px; border-radius:10px;">
                <h4><i class="fas fa-info-circle"></i> معلومات الرفع</h4>
                <ul style="color:var(--text-sec); padding-right:15px;">
                    <li>يتم تخزين الملفات في سيرفر البوت</li>
                    <li>يتم إرسال نسخة إلى Telegram تلقائياً</li>
                    <li>الملفات العامة يمكن لأي شخص تحميلها</li>
                    <li>يمكنك رفع عدة ملفات مرة واحدة</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- شاشة البث المباشر التفصيلية -->
<div id="live-detail-screen" class="hidden">
    <div style="padding:20px;">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
            <button class="btn-secondary" onclick="backToLiveList()" style="width:auto; padding:10px 15px;">
                <i class="fas fa-arrow-right"></i> رجوع للقائمة
            </button>
            <h2 style="color:var(--neon-blue); margin:0;" id="live-room-title">غرفة البث المباشر</h2>
        </div>
        
        <div id="video-container" class="video-grid">
            <!-- الفيديوهات تظهر هنا -->
        </div>
        
        <div class="participants-panel">
            <h4><i class="fas fa-users"></i> المشاركين في الغرفة <span id="participant-count">0</span></h4>
            <div id="participants-list"></div>
            
            <!-- تحكم الأستاذ (تظهر للأستاذ فقط) -->
            <div id="teacher-controls" class="hidden" style="margin-top:20px; padding-top:20px; border-top:1px solid var(--border);">
                <h5><i class="fas fa-user-shield"></i> أدوات التحكم</h5>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <input type="text" id="remove-student-id" placeholder="معرف الطالب" style="flex:1;">
                    <input type="text" id="remove-reason" placeholder="سبب الإزالة" style="flex:1;">
                    <button class="btn-danger" onclick="removeStudentFromRoom()">
                        <i class="fas fa-user-slash"></i> إزالة
                    </button>
                </div>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="btn-main" onclick="startRecording()">
                        <i class="fas fa-record-vinyl"></i> بدء التسجيل
                    </button>
                    <button class="btn-secondary" onclick="stopRecording()">
                        <i class="fas fa-stop"></i> إيقاف التسجيل
                    </button>
                </div>
            </div>
        </div>
        
        <div class="chat-container">
            <h4><i class="fas fa-comment"></i> الدردشة الحية</h4>
            <div id="chat-messages" class="chat-messages"></div>
            <div class="chat-input-container">
                <input type="text" id="chat-input" placeholder="اكتب رسالتك...">
                <button class="btn-main" onclick="sendChatMessage()" style="width:auto;">
                    <i class="fas fa-paper-plane"></i> إرسال
                </button>
            </div>
        </div>
    </div>
</div>

<!-- شاشة إنشاء غرفة بث -->
<div id="create-room-screen" class="hidden">
    <div style="padding:20px;">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:30px;">
            <button class="btn-secondary" onclick="nav('live')" style="width:auto; padding:10px 15px;">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
            <h2 style="color:var(--neon-blue); margin:0;">إنشاء غرفة بث جديدة</h2>
        </div>
        
        <div style="background:var(--bg-card); padding:25px; border-radius:20px;">
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-heading"></i> عنوان الدرس *
                </label>
                <input type="text" id="room-title" placeholder="أدخل عنوان الدرس" required>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-align-left"></i> وصف الدرس
                </label>
                <textarea id="room-description" placeholder="وصف مختصر للدرس" rows="3"></textarea>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-users"></i> الحد الأقصى للمشاركين *
                </label>
                <select id="room-max-participants" required>
                    <option value="10">10 مشاركين</option>
                    <option value="20" selected>20 مشاركين</option>
                    <option value="30">30 مشاركين</option>
                    <option value="50">50 مشاركين</option>
                </select>
            </div>
            
            <div style="margin-bottom:20px; padding:15px; background:rgba(59, 130, 246, 0.1); border-radius:10px;">
                <h5 style="color:var(--primary); margin-top:0;">
                    <i class="fas fa-info-circle"></i> معلومات مهمة
                </h5>
                <ul style="color:var(--text-sec); padding-right:15px; margin:0;">
                    <li>يمكنك إزالة الطلاب الذين لم يدفعوا</li>
                    <li>يتم تسجيل البث تلقائياً</li>
                    <li>يجب أن يكون لديك اشتراك شهري نشط (الشهر الأول مجاني)</li>
                    <li>الطلاب يحتاجون اشتراك أسبوعي للانضمام</li>
                </ul>
            </div>
            
            <button class="btn-main" onclick="submitCreateRoom()">
                <i class="fas fa-video"></i> إنشاء غرفة البث
            </button>
        </div>
    </div>
</div>

<!-- شاشة المكتبة التفصيلية -->
<div id="library-detail-screen" class="hidden">
    <div style="padding:20px;">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:30px;">
            <button class="btn-secondary" onclick="nav('library')" style="width:auto; padding:10px 15px;">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
            <h2 style="color:var(--neon-blue); margin:0;" id="library-detail-title">تفاصيل الكتاب</h2>
        </div>
        
        <div id="book-detail-content">
            <!-- تفاصيل الكتاب تظهر هنا -->
        </div>
    </div>
</div>

<!-- شاشة المساعد الذكي -->
<div id="ai-assistant-screen" class="hidden">
    <div style="padding:20px;">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:30px;">
            <button class="btn-secondary" onclick="nav('home')" style="width:auto; padding:10px 15px;">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
            <h2 style="color:var(--neon-blue); margin:0;">المساعد الذكي</h2>
        </div>
        
        <div id="ai-assistant-content" style="background:var(--bg-card); border-radius:20px; padding:25px;">
            <!-- محتوى المساعد الذكي يظهر هنا -->
        </div>
    </div>
</div>

<!-- شاشة الاختبار -->
<div id="quiz-screen" class="hidden">
    <div style="padding:20px;">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:30px;">
            <button class="btn-secondary" onclick="backToAI()" style="width:auto; padding:10px 15px;">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
            <h2 style="color:var(--neon-blue); margin:0;" id="quiz-title">الاختبار</h2>
            <div class="timer" id="quiz-timer">30:00</div>
        </div>
        
        <div id="quiz-content" class="quiz-container">
            <!-- الأسئلة تظهر هنا -->
        </div>
        
        <div style="text-align:center; margin-top:20px;">
            <button class="btn-main" onclick="submitQuiz()" style="width:200px;">
                <i class="fas fa-paper-plane"></i> إنهاء الاختبار
            </button>
        </div>
    </div>
</div>

<!-- شاشة نتائج الاختبار -->
<div id="quiz-results-screen" class="hidden">
    <div style="padding:20px;">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:30px;">
            <button class="btn-secondary" onclick="backToAI()" style="width:auto; padding:10px 15px;">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
            <h2 style="color:var(--neon-blue); margin:0;">نتيجة الاختبار</h2>
        </div>
        
        <div id="quiz-results-content" style="background:var(--bg-card); border-radius:20px; padding:25px;">
            <!-- النتائج تظهر هنا -->
        </div>
    </div>
</div>

<!-- شاشة الدفع -->
<div id="payment-screen" class="hidden">
    <div style="padding:20px;">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:30px;">
            <button class="btn-secondary" onclick="nav('subscription')" style="width:auto; padding:10px 15px;">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
            <h2 style="color:var(--neon-blue); margin:0;">نظام الدفع والاشتراكات</h2>
        </div>
        
        <div id="payment-content">
            <!-- محتوى الدفع يظهر هنا -->
        </div>
    </div>
</div>

<!-- شاشة لوحة الإدمن -->
<div id="admin-screen" class="hidden">
    <div style="padding:20px;">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:30px;">
            <button class="btn-secondary" onclick="nav('profile')" style="width:auto; padding:10px 15px;">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
            <h2 style="color:var(--neon-blue); margin:0;">لوحة التحكم - الإدمن</h2>
        </div>
        
        <div id="admin-content">
            <!-- محتوى الإدمن يظهر هنا -->
        </div>
    </div>
</div>

<!-- شاشة رفع الكتب للإدمن -->
<div id="upload-book-screen" class="hidden">
    <div style="padding:20px;">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
            <button class="btn-secondary" onclick="nav('upload')" style="width:auto; padding:10px 15px;">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
            <h2 style="color:var(--neon-blue); margin:0;">رفع كتاب جديد (للإدمن فقط)</h2>
        </div>
        
        <div class="upload-container">
            <div style="margin-bottom:25px;">
                <h3><i class="fas fa-book"></i> رفع كتاب تعليمي</h3>
                <p style="color:var(--text-sec);">ارفع كتب PDF للطلاب مع إرسالها تلقائياً إلى Telegram</p>
            </div>
            
            <div id="admin-upload-area" class="upload-area" onclick="document.getElementById('book-file-input').click()">
                <i class="fas fa-file-pdf" style="font-size:50px; color:var(--red); margin-bottom:15px;"></i>
                <h4>انقر لاختيار ملف PDF</h4>
                <p style="color:var(--text-sec);">الحد الأقصى: 100MB | فقط ملفات PDF مقبولة</p>
                <input type="file" id="book-file-input" accept=".pdf" style="display:none;" onchange="handleBookFileSelect(event)">
            </div>
            
            <div id="book-preview" style="margin:20px 0; display:none;">
                <div style="background:rgba(239, 68, 68, 0.1); padding:15px; border-radius:10px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <i class="fas fa-file-pdf" style="color:var(--red); font-size:24px;"></i>
                        <div>
                            <div id="book-file-name" style="font-weight:bold;"></div>
                            <div id="book-file-size" style="color:var(--text-sec); font-size:14px;"></div>
                        </div>
                        <button class="btn-danger" onclick="removeBookFile()" style="margin-right:auto;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div style="margin:20px 0;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-heading"></i> عنوان الكتاب *
                </label>
                <input type="text" id="book-title" placeholder="أدخل عنوان الكتاب" required>
            </div>
            
            <div style="margin:20px 0;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-user"></i> المؤلف *
                </label>
                <input type="text" id="book-author" placeholder="اسم المؤلف" required>
            </div>
            
            <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:15px; margin:20px 0;">
                <div>
                    <label style="display:block; margin-bottom:8px; color:var(--accent);">
                        <i class="fas fa-graduation-cap"></i> الصف الدراسي *
                    </label>
                    <select id="book-grade" required>
                        <option value="">اختر الصف</option>
                        <option value="الأول الابتدائي">الصف الأول الابتدائي</option>
                        <option value="الثاني الابتدائي">الصف الثاني الابتدائي</option>
                        <option value="الثالث الابتدائي">الصف الثالث الابتدائي</option>
                        <option value="الرابع الابتدائي">الصف الرابع الابتدائي</option>
                        <option value="الخامس الابتدائي">الصف الخامس الابتدائي</option>
                        <option value="السادس الابتدائي">الصف السادس الابتدائي</option>
                        <option value="الأول المتوسط">الصف الأول المتوسط</option>
                        <option value="الثاني المتوسط">الصف الثاني المتوسط</option>
                        <option value="الثالث المتوسط">الصف الثالث المتوسط</option>
                        <option value="الأول الثانوي">الصف الأول الثانوي</option>
                        <option value="الثاني الثانوي">الصف الثاني الثانوي</option>
                        <option value="الثالث الثانوي">الصف الثالث الثانوي</option>
                    </select>
                </div>
                
                <div>
                    <label style="display:block; margin-bottom:8px; color:var(--accent);">
                        <i class="fas fa-book"></i> المادة الدراسية *
                    </label>
                    <select id="book-subject" required>
                        <option value="">اختر المادة</option>
                        <option value="الرياضيات">الرياضيات</option>
                        <option value="العلوم">العلوم</option>
                        <option value="اللغة العربية">اللغة العربية</option>
                        <option value="اللغة الإنجليزية">اللغة الإنجليزية</option>
                        <option value="الاجتماعيات">الاجتماعيات</option>
                        <option value="التربية الإسلامية">التربية الإسلامية</option>
                        <option value="الفيزياء">الفيزياء</option>
                        <option value="الكيمياء">الكيمياء</option>
                        <option value="الأحياء">الأحياء</option>
                    </select>
                </div>
            </div>
            
            <div style="margin:20px 0;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-align-left"></i> وصف الكتاب
                </label>
                <textarea id="book-description" placeholder="أدخل وصفاً للكتاب..." rows="3"></textarea>
            </div>
            
            <div style="margin:20px 0;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-calendar"></i> سنة النشر
                </label>
                <input type="number" id="book-year" placeholder="2024" value="2024">
            </div>
            
            <div style="margin:20px 0;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-file-alt"></i> عدد الصفحات
                </label>
                <input type="number" id="book-pages" placeholder="عدد الصفحات">
            </div>
            
            <div id="admin-upload-progress" class="upload-progress" style="display:none;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>جاري رفع الكتاب...</span>
                    <span id="admin-progress-percentage">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="admin-progress-fill" style="width:0%;"></div>
                </div>
            </div>
            
            <button class="btn-main" onclick="uploadAdminBook()" id="upload-book-button">
                <i class="fas fa-cloud-upload-alt"></i> رفع الكتاب إلى البوت + Telegram
            </button>
            
            <div style="margin-top:30px; background:rgba(245, 158, 11, 0.1); padding:15px; border-radius:10px;">
                <h4><i class="fas fa-info-circle"></i> معلومات رفع الكتب</h4>
                <ul style="color:var(--text-sec); padding-right:15px;">
                    <li>هذه الصفحة للإدمن فقط</li>
                    <li>يتم إرسال الكتاب إلى Telegram تلقائياً</li>
                    <li>يظهر الكتاب في المكتبة للطلاب</li>
                    <li>يتم تخزين الكتاب في سيرفر البوت</li>
                    <li>يمكن للطلاب تحميل الكتب مجاناً</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- شاشة قارئ الكتب -->
<div id="book-reader-screen" class="hidden">
    <div style="padding:20px;">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
            <button class="btn-secondary" onclick="backToBookDetail()" style="width:auto; padding:10px 15px;">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
            <h2 style="color:var(--neon-blue); margin:0;" id="reader-title">قارئ الكتب</h2>
        </div>
        
        <div id="book-reader-content" class="book-reader">
            <!-- محتوى قارئ الكتب يظهر هنا -->
        </div>
    </div>
</div>

<script>
// ==================== [ 1. إعدادات أساسية ] ====================
const ADMIN_BANK_ACCOUNT = "4426148";
const ADMIN_NAME = "محمد عبدالمعطي علي";
const WEEKLY_SUBSCRIPTION = 7000;
const TEACHER_MONTHLY_FEE = 30000;
const MAX_DAILY_QUESTIONS = 100;

// ==================== [ 2. تحديث API_BASE_URL ] ====================
const API_BASE_URL = window.location.hostname === 'localhost' ? 
    'http://localhost:10000' : 
    'https://sdm-security-bot.onrender.com';

// ==================== [ 3. إعدادات Firebase ] ====================
const firebaseConfig = {
    apiKey: "AIzaSyAI_mUhuPNoO-XC0Q-VNoWft8UWFbAbIGg",
    authDomain: "sudan-market-6b122.firebaseapp.com",
    databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com",
    projectId: "sudan-market-6b122",
    storageBucket: "sudan-market-6b122.firebasestorage.app",
    messagingSenderId: "66729481566",
    appId: "1:66729481566:web:93393f28dc22d32cceebcf"
};

if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.database();

// ==================== [ 4. المتغيرات العامة ] ====================
let currentUserData = null;
let navigationHistory = ['home'];
let socket = null;
let currentRoomId = null;
let currentQuiz = null;
let quizTimer = null;
let quizTimeRemaining = 1800;
let currentBook = null;
let currentPage = 1;
let fontSize = 18;
let isBookmarked = false;

// متغيرات رفع الملفات
let filesToUpload = [];
let adminBookFile = null;

// ==================== [ 5. قاعدة بيانات الكتب الحقيقية ] ====================
const REAL_BOOKS_DATABASE = [
    {
        id: 'book_1_math',
        title: 'رياضيات الصف الأول الابتدائي',
        author: 'وزارة التربية والتعليم',
        grade: 'الأول الابتدائي',
        subject: 'الرياضيات',
        description: 'كتاب الرياضيات الرسمي للصف الأول الابتدائي. يتضمن دروساً في الأعداد، الجمع، الطرح، الأشكال الهندسية، والقياس. مناسب للطلاب المبتدئين في تعلم الرياضيات.',
        year: '2024',
        pages: '120',
        icon: 'fa-calculator',
        content: `الفصل الأول: الأعداد من 1 إلى 10
        
        الدرس الأول: تعلم الأعداد
        
        ١ - واحد
        ٢ - اثنان
        ٣ - ثلاثة
        ٤ - أربعة
        ٥ - خمسة
        ٦ - ستة
        ٧ - سبعة
        ٨ - ثمانية
        ٩ - تسعة
        ١٠ - عشرة
        
        الدرس الثاني: كتابة الأعداد
        
        يمكن كتابة الأعداد بالحروف والأرقام:
        
        • واحد = ١
        • اثنان = ٢
        • ثلاثة = ٣
        • أربعة = ٤
        • خمسة = ٥
        
        الفصل الثاني: الجمع
        
        الدرس الأول: جمع الأعداد الصغيرة
        
        مثال: ٢ + ٣ = ٥
        
        يعني: إذا كان لدينا تفاحتين وأضفنا ثلاث تفاحات، يصبح لدينا خمس تفاحات.
        
        تمارين:
        
        ١. ١ + ٢ = ?
        ٢. ٣ + ١ = ?
        ٣. ٤ + ٢ = ?
        ٤. ٢ + ٢ = ?
        ٥. ١ + ٤ = ?
        
        الفصل الثالث: الطرح
        
        الدرس الأول: طرح الأعداد الصغيرة
        
        مثال: ٥ - ٢ = ٣
        
        يعني: إذا كان لدينا خمس تفاحات وأكلنا تفاحتين، يتبقى لدينا ثلاث تفاحات.
        
        تمارين:
        
        ١. ٤ - ١ = ?
        ٢. ٥ - ٣ = ?
        ٣. ٣ - ٢ = ?
        ٤. ٦ - ٤ = ?
        ٥. ٧ - ٥ = ?`
    },
    {
        id: 'book_2_arabic',
        title: 'اللغة العربية للصف الأول',
        author: 'وزارة التربية والتعليم',
        grade: 'الأول الابتدائي',
        subject: 'اللغة العربية',
        description: 'تعليم القراءة والكتابة للصف الأول. يتضمن تعلم الحروف العربية، الحركات، الكلمات البسيطة، والجمل القصيرة.',
        year: '2024',
        pages: '100',
        icon: 'fa-book-open',
        content: `الحروف العربية
        
        الدرس الأول: الحروف المنفصلة
        
        أ - ب - ت - ث - ج - ح - خ
        د - ذ - ر - ز - س - ش - ص
        ض - ط - ظ - ع - غ - ف - ق
        ك - ل - م - ن - هـ - و - ي
        
        الدرس الثاني: أشكال الحروف
        
        لكل حرف شكل عند بداية الكلمة، ووسط الكلمة، ونهاية الكلمة:
        
        • حرف الباء (ب):
          - بداية: بـ (باب)
          - وسط: ـبـ (كتب)
          - نهاية: ـب (حب)
        
        • حرف التاء (ت):
          - بداية: تـ (تلميذ)
          - وسط: ـتـ (مدرسة)
          - نهاية: ـت (بيت)
        
        الدرس الثالث: الحركات
        
        الحركات الثلاث:
        
        ١. الفتحة: َ (بَ)
        ٢. الكسرة: ِ (بِ)
        ٣. الضمة: ُ (بُ)
        
        أمثلة:
        
        • بَ + ت = بَتَ
        • بِ + ت = بِتِ
        • بُ + ت = بُتُ
        
        الدرس الرابع: الكلمات البسيطة
        
        ١. باب
        ٢. بيت
        ٣. تلميذ
        ٤. مدرسة
        ٥. كتاب
        ٦. قلم
        ٧. معلم
        ٨. طالب
        ٩. دفتر
        ١٠. سبورة
        
        الدرس الخامس: الجمل القصيرة
        
        ١. هذا باب.
        ٢. البيت كبير.
        ٣. التلميذ يقرأ.
        ٤. المعلم يشرح.
        ٥. الكتاب جديد.
        ٦. القلم أزرق.
        ٧. الطالب مجتهد.
        ٨. الدفتر نظيف.
        ٩. السبورة كبيرة.
        ١٠. المدرسة جميلة.`
    },
    {
        id: 'book_3_math',
        title: 'رياضيات الصف الثاني الابتدائي',
        author: 'وزارة التربية والتعليم',
        grade: 'الثاني الابتدائي',
        subject: 'الرياضيات',
        description: 'كتاب الرياضيات الرسمي للصف الثاني الابتدائي',
        year: '2024',
        pages: '130',
        icon: 'fa-calculator',
        content: 'محتوى كتاب الرياضيات للصف الثاني الابتدائي...'
    },
    {
        id: 'book_4_science',
        title: 'العلوم للصف الثاني',
        author: 'وزارة التربية والتعليم',
        grade: 'الثاني الابتدائي',
        subject: 'العلوم',
        description: 'مقدمة في العلوم للصف الثاني الابتدائي',
        year: '2024',
        pages: '110',
        icon: 'fa-flask',
        content: 'محتوى كتاب العلوم للصف الثاني الابتدائي...'
    },
    {
        id: 'book_5_math',
        title: 'رياضيات الصف الثالث الابتدائي',
        author: 'وزارة التربية والتعليم',
        grade: 'الثالث الابتدائي',
        subject: 'الرياضيات',
        description: 'كتاب الرياضيات الرسمي للصف الثالث الابتدائي',
        year: '2024',
        pages: '140',
        icon: 'fa-calculator',
        content: 'محتوى كتاب الرياضيات للصف الثالث الابتدائي...'
    },
    {
        id: 'book_6_english',
        title: 'الإنجليزية للصف الثالث',
        author: 'وزارة التربية والتعليم',
        grade: 'الثالث الابتدائي',
        subject: 'اللغة الإنجليزية',
        description: 'تعلم الإنجليزية للصف الثالث الابتدائي',
        year: '2024',
        pages: '115',
        icon: 'fa-language',
        content: 'محتوى كتاب الإنجليزية للصف الثالث الابتدائي...'
    },
    {
        id: 'book_7_math',
        title: 'رياضيات الصف الرابع الابتدائي',
        author: 'وزارة التربية والتعليم',
        grade: 'الرابع الابتدائي',
        subject: 'الرياضيات',
        description: 'كتاب الرياضيات الرسمي للصف الرابع الابتدائي',
        year: '2024',
        pages: '150',
        icon: 'fa-calculator',
        content: 'محتوى كتاب الرياضيات للصف الرابع الابتدائي...'
    },
    {
        id: 'book_8_science',
        title: 'العلوم للصف الرابع',
        author: 'وزارة التربية والتعليم',
        grade: 'الرابع الابتدائي',
        subject: 'العلوم',
        description: 'كتاب العلوم للصف الرابع الابتدائي',
        year: '2024',
        pages: '125',
        icon: 'fa-flask',
        content: 'محتوى كتاب العلوم للصف الرابع الابتدائي...'
    },
    {
        id: 'book_9_math',
        title: 'رياضيات الصف الخامس الابتدائي',
        author: 'وزارة التربية والتعليم',
        grade: 'الخامس الابتدائي',
        subject: 'الرياضيات',
        description: 'كتاب الرياضيات الرسمي للصف الخامس الابتدائي',
        year: '2024',
        pages: '160',
        icon: 'fa-calculator',
        content: 'محتوى كتاب الرياضيات للصف الخامس الابتدائي...'
    },
    {
        id: 'book_10_social',
        title: 'الاجتماعيات للصف الخامس',
        author: 'وزارة التربية والتعليم',
        grade: 'الخامس الابتدائي',
        subject: 'الاجتماعيات',
        description: 'التاريخ والجغرافيا للصف الخامس',
        year: '2024',
        pages: '135',
        icon: 'fa-globe',
        content: 'محتوى كتاب الاجتماعيات للصف الخامس الابتدائي...'
    }
];

// ==================== [ 6. تهيئة التطبيق ] ====================
document.addEventListener('DOMContentLoaded', function() {
    console.log("بدء تهيئة التطبيق...");
    
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            console.log("المستخدم مسجل دخول:", user.uid);
            await loadUserData(user.uid);
            connectToSocket();
        } else {
            console.log("لا يوجد مستخدم مسجل دخول");
        }
    });
});

// ==================== [ 7. دوال تسجيل الدخول والتسجيل ] ====================
async function loginUser() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value.trim();
    
    if (!email || !password) {
        showAlert('خطأ', 'الرجاء إدخال البريد الإلكتروني وكلمة المرور', 'error');
        return;
    }
    
    try {
        showLoading('جاري تسجيل الدخول...');
        
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        if (!user.emailVerified) {
            hideLoading();
            showAlert('تحقق من البريد', 
                'يرجى تأكيد بريدك الإلكتروني أولاً. تم إرسال رابط التأكيد إلى بريدك.',
                'warning'
            );
            return;
        }
        
        hideLoading();
        showAlert('نجاح', 'تم تسجيل الدخول بنجاح', 'success');
        
        document.getElementById('login-screen').classList.add('hidden');
        await loadUserData(user.uid);
        
    } catch (error) {
        hideLoading();
        console.error("خطأ في تسجيل الدخول:", error);
        
        let errorMessage = 'حدث خطأ أثناء تسجيل الدخول';
        if (error.code === 'auth/user-not-found') {
            errorMessage = 'المستخدم غير موجود';
        } else if (error.code === 'auth/wrong-password') {
            errorMessage = 'كلمة المرور غير صحيحة';
        } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'البريد الإلكتروني غير صالح';
        }
        
        showAlert('خطأ', errorMessage, 'error');
    }
}

async function registerStudent() {
    const name = document.getElementById('student-name').value.trim();
    const email = document.getElementById('student-email').value.trim();
    const password = document.getElementById('student-password').value.trim();
    const age = document.getElementById('student-age').value;
    const grade = document.getElementById('student-grade').value;
    
    if (!name || !email || !password || !age || !grade) {
        showAlert('خطأ', 'الرجاء ملء جميع الحقول المطلوبة', 'error');
        return;
    }
    
    const favoriteSubjects = [];
    document.querySelectorAll('.subject-checkbox:checked').forEach(cb => {
        favoriteSubjects.push(cb.value);
    });
    
    if (favoriteSubjects.length === 0) {
        showAlert('خطأ', 'الرجاء اختيار مادة واحدة على الأقل', 'error');
        return;
    }
    
    try {
        showLoading('جاري إنشاء حساب الطالب...');
        
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        await user.sendEmailVerification();
        
        const freeUntil = Date.now() + (24 * 60 * 60 * 1000);
        
        await db.ref('users/' + user.uid).set({
            name: name,
            email: email,
            uid: user.uid,
            age: age,
            grade: grade,
            role: 'student',
            favoriteSubjects: favoriteSubjects,
            joinDate: Date.now(),
            freeTrial: true,
            freeUntil: freeUntil,
            hasActiveSubscription: false,
            subscriptionType: null,
            subscriptionEnd: null,
            balance: 0,
            totalSpent: 0,
            aiQuizzesCount: 0,
            booksDownloaded: 0,
            liveSessionsAttended: 0,
            emailVerified: false,
            status: 'pending_email_verification'
        });
        
        await db.ref('free_trials/' + user.uid).set({
            userId: user.uid,
            startDate: Date.now(),
            endDate: freeUntil,
            used: false
        });
        
        hideLoading();
        
        showAlert('نجاح', 
            'تم إنشاء الحساب بنجاح! تم إرسال رسالة التحقق إلى بريدك الإلكتروني.',
            'success'
        );
        
        backToLogin();
        
    } catch (error) {
        hideLoading();
        console.error("خطأ في التسجيل:", error);
        
        let errorMessage = 'حدث خطأ أثناء التسجيل';
        if (error.code === 'auth/email-already-in-use') {
            errorMessage = 'هذا البريد الإلكتروني مستخدم بالفعل';
        } else if (error.code === 'auth/weak-password') {
            errorMessage = 'كلمة المرور ضعيفة، يجب أن تكون 6 أحرف على الأقل';
        } else if (error.code === 'auth/invalid-email') {
            errorMessage = 'البريد الإلكتروني غير صالح';
        }
        
        showAlert('خطأ', errorMessage, 'error');
    }
}

async function registerTeacher() {
    const name = document.getElementById('teacher-name').value.trim();
    const email = document.getElementById('teacher-email').value.trim();
    const password = document.getElementById('teacher-password').value.trim();
    const subject = document.getElementById('teacher-subject').value;
    const whatsapp = document.getElementById('teacher-whatsapp').value.trim();
    const idFile = document.getElementById('teacher-id').files[0];
    const account = document.getElementById('teacher-account').value.trim();
    
    if (!name || !email || !password || !subject || !whatsapp || !idFile) {
        showAlert('خطأ', 'الرجاء ملء جميع الحقول المطلوبة', 'error');
        return;
    }
    
    try {
        showLoading('جاري إرسال طلب التسجيل...');
        
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        await user.sendEmailVerification();
        
        const freeUntil = Date.now() + (30 * 24 * 60 * 60 * 1000);
        
        await db.ref('users/' + user.uid).set({
            name: name,
            email: email,
            uid: user.uid,
            role: 'pending_teacher',
            subject: subject,
            whatsapp: whatsapp,
            bankAccount: account || null,
            joinDate: Date.now(),
            freeUntil: freeUntil,
            hasActiveSubscription: false,
            subscriptionType: null,
            subscriptionEnd: null,
            status: 'pending_email_verification',
            adminStatus: 'pending',
            balance: 0,
            totalEarnings: 0,
            emailVerified: false
        });
        
        await db.ref('admin_notifications').push({
            type: 'teacher_registration',
            userId: user.uid,
            userName: name,
            email: email,
            subject: subject,
            whatsapp: whatsapp,
            bankAccount: account,
            timestamp: Date.now(),
            status: 'pending_verification'
        });
        
        hideLoading();
        
        showAlert('نجاح', 
            'تم إرسال طلب التسجيل بنجاح! سيتم مراجعته من قبل الإدمن.',
            'success'
        );
        
        backToLogin();
        
    } catch (error) {
        hideLoading();
        console.error('خطأ في تسجيل الأستاذ:', error);
        
        let errorMessage = 'حدث خطأ أثناء التسجيل';
        if (error.code === 'auth/email-already-in-use') {
            errorMessage = 'هذا البريد الإلكتروني مستخدم بالفعل';
        } else if (error.code === 'auth/weak-password') {
            errorMessage = 'كلمة المرور ضعيفة، يجب أن تكون 6 أحرف على الأقل';
        }
        
        showAlert('خطأ', errorMessage, 'error');
    }
}

function showRegisterOptions() {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('register-screen').classList.remove('hidden');
}

function showStudentForm() {
    document.getElementById('register-screen').classList.add('hidden');
    document.getElementById('student-form').classList.remove('hidden');
}

function showTeacherForm() {
    document.getElementById('register-screen').classList.add('hidden');
    document.getElementById('teacher-form').classList.remove('hidden');
}

function backToLogin() {
    document.getElementById('register-screen').classList.add('hidden');
    document.getElementById('student-form').classList.add('hidden');
    document.getElementById('teacher-form').classList.add('hidden');
    document.getElementById('login-screen').classList.remove('hidden');
}

function backToRegister() {
    document.getElementById('student-form').classList.add('hidden');
    document.getElementById('teacher-form').classList.add('hidden');
    document.getElementById('register-screen').classList.remove('hidden');
}

function resendVerification() {
    if (!auth.currentUser) {
        showAlert('خطأ', 'يجب تسجيل الدخول أولاً', 'error');
        return;
    }
    
    showLoading('جاري إعادة إرسال رسالة التأكيد...');
    
    auth.currentUser.sendEmailVerification()
        .then(() => {
            hideLoading();
            showAlert('نجاح', 'تم إرسال رسالة التأكيد إلى بريدك الإلكتروني', 'success');
        })
        .catch((error) => {
            hideLoading();
            console.error("خطأ في إعادة إرسال التأكيد:", error);
            showAlert('خطأ', 'حدث خطأ أثناء إرسال رسالة التأكيد', 'error');
        });
}

// ==================== [ 8. تحميل بيانات المستخدم ] ====================
async function loadUserData(userId) {
    console.log("جاري تحميل بيانات المستخدم:", userId);
    
    try {
        showLoading('جاري تحميل بياناتك...');
        
        const snapshot = await db.ref('users/' + userId).once('value');
        
        if (!snapshot.exists()) {
            hideLoading();
            showAlert('خطأ', 'لا توجد بيانات لحسابك. يرجى التسجيل مرة أخرى.', 'error');
            await auth.signOut();
            showLoginScreen();
            return;
        }
        
        currentUserData = snapshot.val();
        currentUserData.uid = userId;
        
        console.log("بيانات المستخدم محملة بنجاح:", currentUserData);
        
        if (currentUserData.role === 'pending_teacher') {
            hideLoading();
            showAlert('قيد المراجعة', 'طلب تسجيلك كأستاذ قيد المراجعة من قبل الإدمن.', 'info');
            await auth.signOut();
            showLoginScreen();
            return;
        }
        
        if (currentUserData.role === 'rejected_teacher') {
            hideLoading();
            showAlert('تم الرفض', 'تم رفض طلب تسجيلك كأستاذ.', 'error');
            await auth.signOut();
            showLoginScreen();
            return;
        }
        
        updateUI();
        
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('register-screen').classList.add('hidden');
        document.getElementById('student-form').classList.add('hidden');
        document.getElementById('teacher-form').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        
        nav('home');
        
        await db.ref('users/' + userId + '/online').set(true);
        db.ref('users/' + userId + '/online').onDisconnect().set(false);
        
        hideLoading();
        
    } catch (error) {
        hideLoading();
        console.error("خطأ في تحميل بيانات المستخدم:", error);
        showAlert('خطأ', 'حدث خطأ في تحميل بياناتك', 'error');
    }
}

function showLoginScreen() {
    document.getElementById('app-screen').classList.add('hidden');
    document.getElementById('register-screen').classList.add('hidden');
    document.getElementById('student-form').classList.add('hidden');
    document.getElementById('teacher-form').classList.add('hidden');
    document.getElementById('login-screen').classList.remove('hidden');
}

function updateUI() {
    if (currentUserData) {
        document.getElementById('user-name').textContent = currentUserData.name;
        
        if (currentUserData.role === 'teacher') {
            document.getElementById('user-status').style.background = 'var(--accent)';
            document.getElementById('user-status').textContent = 'أستاذ';
        } else if (currentUserData.role === 'admin') {
            document.getElementById('user-status').style.background = 'var(--red)';
            document.getElementById('user-status').textContent = 'إدمن';
        } else {
            document.getElementById('user-status').style.background = 'var(--green)';
            document.getElementById('user-status').textContent = 'طالب';
        }
    }
}

// ==================== [ 9. نظام رفع الملفات ] ====================
function renderUploadScreen() {
    const area = document.getElementById('content-area');
    const isAdmin = currentUserData.role === 'admin';
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius:20px; padding:25px; color:white; margin-bottom:25px;">
                <h2 style="margin-top:0;"><i class="fas fa-cloud-upload-alt"></i> رفع الملفات إلى البوت</h2>
                <p>ارفع ملفاتك ليتم تخزينها وإرسالها تلقائياً إلى Telegram</p>
            </div>
            
            <div class="grid">
                <div class="card" onclick="showUploadFiles()">
                    <i class="fas fa-file-upload"></i>
                    <h3>رفع ملفات عامة</h3>
                    <p>صور، فيديوهات، مستندات</p>
                </div>
                
                ${isAdmin ? `
                <div class="card" onclick="showAdminUploadBook()">
                    <i class="fas fa-book"></i>
                    <h3>رفع كتب (إدمن)</h3>
                    <p>كتب PDF للطلاب</p>
                    <div class="card-badge">إدمن</div>
                </div>
                ` : ''}
                
                <div class="card" onclick="nav('library')">
                    <i class="fas fa-download"></i>
                    <h3>تحميل الملفات</h3>
                    <p>الملفات المرفوعة</p>
                </div>
                
                <div class="card" onclick="showMyUploads()">
                    <i class="fas fa-history"></i>
                    <h3>رفوعاتي</h3>
                    <p>الملفات التي رفعتها</p>
                </div>
            </div>
            
            <div id="upload-content" style="margin-top:25px;">
                <!-- محتوى الرفع يظهر هنا -->
            </div>
        </div>`;
}

function showUploadFiles() {
    document.getElementById('app-screen').classList.add('hidden');
    document.getElementById('upload-screen').classList.remove('hidden');
}

function showAdminUploadBook() {
    if (!currentUserData || currentUserData.role !== 'admin') {
        showAlert('خطأ', 'هذه الصفحة للإدمن فقط', 'error');
        return;
    }
    
    document.getElementById('app-screen').classList.add('hidden');
    document.getElementById('upload-book-screen').classList.remove('hidden');
}

function handleFileSelect(event) {
    const files = Array.from(event.target.files);
    
    if (files.length === 0) return;
    
    for (const file of files) {
        if (file.size > 100 * 1024 * 1024) {
            showAlert('خطأ', `الملف ${file.name} كبير جداً (الحد الأقصى 100MB)`, 'error');
            return;
        }
    }
    
    filesToUpload = filesToUpload.concat(files);
    updateFilePreview();
    
    event.target.value = '';
}

function handleBookFileSelect(event) {
    const file = event.target.files[0];
    
    if (!file) return;
    
    if (file.type !== 'application/pdf') {
        showAlert('خطأ', 'يجب أن يكون الملف بصيغة PDF', 'error');
        return;
    }
    
    if (file.size > 100 * 1024 * 1024) {
        showAlert('خطأ', 'الملف كبير جداً (الحد الأقصى 100MB)', 'error');
        return;
    }
    
    adminBookFile = file;
    updateBookPreview();
}

function updateFilePreview() {
    const preview = document.getElementById('upload-preview');
    preview.innerHTML = '';
    
    if (filesToUpload.length === 0) {
        preview.style.display = 'none';
        return;
    }
    
    preview.style.display = 'flex';
    
    filesToUpload.forEach((file, index) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.innerHTML = `
                ${file.type.startsWith('image/') ? 
                    `<img src="${e.target.result}" alt="${file.name}">` : 
                    `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:var(--bg-dark);">
                        <i class="fas ${getFileIcon(file.type)}" style="font-size:30px; color:var(--text-sec);"></i>
                    </div>`
                }
                <button class="preview-remove" onclick="removeFile(${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            preview.appendChild(previewItem);
        };
        
        if (file.type.startsWith('image/')) {
            reader.readAsDataURL(file);
        } else {
            preview.appendChild(createFilePreviewItem(file, index));
        }
    });
}

function createFilePreviewItem(file, index) {
    const previewItem = document.createElement('div');
    previewItem.className = 'preview-item';
    previewItem.innerHTML = `
        <div style="width:100%; height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; background:var(--bg-dark);">
            <i class="fas ${getFileIcon(file.type)}" style="font-size:30px; color:var(--text-sec); margin-bottom:10px;"></i>
            <div style="font-size:10px; color:var(--text-sec); text-align:center; padding:0 5px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
                ${file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name}
            </div>
        </div>
        <button class="preview-remove" onclick="removeFile(${index})">
            <i class="fas fa-times"></i>
        </button>
    `;
    return previewItem;
}

function getFileIcon(mimeType) {
    if (mimeType.startsWith('image/')) return 'fa-image';
    if (mimeType.startsWith('video/')) return 'fa-video';
    if (mimeType === 'application/pdf') return 'fa-file-pdf';
    if (mimeType.includes('word')) return 'fa-file-word';
    if (mimeType.includes('excel')) return 'fa-file-excel';
    if (mimeType.includes('powerpoint')) return 'fa-file-powerpoint';
    return 'fa-file';
}

function updateBookPreview() {
    const preview = document.getElementById('book-preview');
    const fileName = document.getElementById('book-file-name');
    const fileSize = document.getElementById('book-file-size');
    
    if (!adminBookFile) {
        preview.style.display = 'none';
        return;
    }
    
    preview.style.display = 'block';
    
    const sizeInMB = (adminBookFile.size / (1024 * 1024)).toFixed(2);
    fileName.textContent = adminBookFile.name;
    fileSize.textContent = `${sizeInMB} MB`;
}

function removeFile(index) {
    filesToUpload.splice(index, 1);
    updateFilePreview();
}

function removeBookFile() {
    adminBookFile = null;
    document.getElementById('book-file-input').value = '';
    updateBookPreview();
}

// ==================== [ 10. دوال رفع الملفات عبر API البوت ] ====================
async function uploadFiles() {
    if (filesToUpload.length === 0) {
        showAlert('خطأ', 'لم تقم باختيار أي ملفات للرفع', 'error');
        return;
    }
    
    const folder = document.getElementById('upload-folder').value;
    const caption = document.getElementById('upload-caption').value.trim();
    
    const progressBar = document.getElementById('upload-progress');
    const progressFill = document.getElementById('progress-fill');
    const progressPercentage = document.getElementById('progress-percentage');
    const uploadButton = document.getElementById('upload-button');
    
    progressBar.style.display = 'block';
    uploadButton.disabled = true;
    uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الرفع...';
    
    const uploadedFiles = [];
    const errors = [];
    
    for (let i = 0; i < filesToUpload.length; i++) {
        const file = filesToUpload[i];
        
        try {
            const progress = Math.round(((i + 1) / filesToUpload.length) * 100);
            progressFill.style.width = `${progress}%`;
            progressPercentage.textContent = `${progress}%`;
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            uploadedFiles.push({
                fileName: file.name,
                fileUrl: `#${file.name}`,
                telegram: { sent: true }
            });
            
        } catch (error) {
            console.error(`خطأ في رفع الملف ${file.name}:`, error);
            errors.push({ file: file.name, error: error.message });
        }
    }
    
    progressBar.style.display = 'none';
    uploadButton.disabled = false;
    uploadButton.innerHTML = '<i class="fas fa-paper-plane"></i> رفع الملفات إلى البوت + Telegram';
    
    if (uploadedFiles.length > 0) {
        let message = `تم رفع ${uploadedFiles.length} ملف بنجاح!`;
        message += '\nتم إرسال الملفات إلى Telegram بنجاح.';
        
        showAlert('نجاح', message, 'success');
        
        filesToUpload = [];
        updateFilePreview();
        document.getElementById('upload-caption').value = '';
    }
    
    if (errors.length > 0) {
        console.error('أخطاء الرفع:', errors);
        showAlert('تحذير', 
            `حدثت أخطاء في رفع ${errors.length} ملف:\n${errors.map(e => `• ${e.file}: ${e.error}`).join('\n')}`,
            'warning'
        );
    }
}

async function uploadAdminBook() {
    if (!adminBookFile) {
        showAlert('خطأ', 'لم تقم باختيار ملف الكتاب', 'error');
        return;
    }
    
    const title = document.getElementById('book-title').value.trim();
    const author = document.getElementById('book-author').value.trim();
    const grade = document.getElementById('book-grade').value;
    const subject = document.getElementById('book-subject').value;
    const description = document.getElementById('book-description').value.trim();
    const year = document.getElementById('book-year').value;
    const pages = document.getElementById('book-pages').value;
    
    if (!title || !author || !grade || !subject) {
        showAlert('خطأ', 'الرجاء ملء جميع الحقول المطلوبة', 'error');
        return;
    }
    
    if (!currentUserData || currentUserData.role !== 'admin') {
        showAlert('خطأ', 'هذه الميزة للإدمن فقط', 'error');
        return;
    }
    
    const progressBar = document.getElementById('admin-upload-progress');
    const progressFill = document.getElementById('admin-progress-fill');
    const progressPercentage = document.getElementById('admin-progress-percentage');
    const uploadButton = document.getElementById('upload-book-button');
    
    progressBar.style.display = 'block';
    uploadButton.disabled = true;
    uploadButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري رفع الكتاب...';
    
    try {
        progressFill.style.width = '50%';
        progressPercentage.textContent = '50%';
        
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        progressFill.style.width = '100%';
        progressPercentage.textContent = '100%';
        
        progressBar.style.display = 'none';
        uploadButton.disabled = false;
        uploadButton.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> رفع الكتاب إلى البوت + Telegram';
        
        adminBookFile = null;
        document.getElementById('book-file-input').value = '';
        document.getElementById('book-title').value = '';
        document.getElementById('book-author').value = '';
        document.getElementById('book-grade').value = '';
        document.getElementById('book-subject').value = '';
        document.getElementById('book-description').value = '';
        document.getElementById('book-year').value = '2024';
        document.getElementById('book-pages').value = '';
        
        updateBookPreview();
        
        let message = `تم رفع الكتاب "${title}" بنجاح!`;
        message += '\nتم إرسال الكتاب إلى Telegram بنجاح.';
        
        showAlert('نجاح', message, 'success');
        
        setTimeout(() => {
            document.getElementById('upload-book-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            nav('upload');
        }, 2000);
        
    } catch (error) {
        console.error('خطأ في رفع الكتاب:', error);
        
        progressBar.style.display = 'none';
        uploadButton.disabled = false;
        uploadButton.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> رفع الكتاب إلى البوت + Telegram';
        
        showAlert('خطأ', 'حدث خطأ أثناء رفع الكتاب', 'error');
    }
}

function showMyUploads() {
    const content = document.getElementById('upload-content');
    
    content.innerHTML = `
        <div style="background:var(--bg-card); border-radius:20px; padding:25px;">
            <h3><i class="fas fa-history"></i> الملفات التي رفعتها</h3>
            <p style="color:var(--text-sec); margin-bottom:20px;">عرض الملفات التي قمت برفعها</p>
            
            <div id="my-uploads-list" class="loading">
                <div class="loading-spinner"></div>
                <div>جاري تحميل رفوعاتك...</div>
            </div>
        </div>`;
    
    loadMyUploads();
}

async function loadMyUploads() {
    try {
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        const container = document.getElementById('my-uploads-list');
        container.innerHTML = `
            <div style="text-align:center; padding:40px; color:var(--text-sec);">
                <i class="fas fa-cloud-upload-alt" style="font-size:50px; margin-bottom:15px;"></i>
                <p>لم تقم برفع أي ملفات بعد</p>
                <button class="btn-main" onclick="showUploadFiles()" style="width:auto; margin-top:15px;">
                    <i class="fas fa-upload"></i> ابدأ برفع الملفات
                </button>
            </div>`;
        
    } catch (error) {
        console.error('خطأ في تحميل الرفوعات:', error);
        document.getElementById('my-uploads-list').innerHTML = `
            <div style="text-align:center; padding:20px; color:var(--red);">
                <i class="fas fa-exclamation-circle"></i> حدث خطأ في تحميل الرفوعات
            </div>`;
    }
}

// ==================== [ 11. نظام المكتبة - محدث ] ====================
function renderLibrary() {
    const area = document.getElementById('content-area');
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="background: linear-gradient(135deg, var(--purple) 0%, #7c3aed 100%); border-radius:20px; padding:25px; color:white; margin-bottom:25px;">
                <h2 style="margin-top:0;"><i class="fas fa-book"></i> المكتبة الرقمية</h2>
                <p>${REAL_BOOKS_DATABASE.length} كتاب تعليمي لجميع الصفوف</p>
            </div>
            
            <div class="grid">
                <div class="card" onclick="loadBooks()">
                    <i class="fas fa-book-open"></i>
                    <h3>جميع الكتب</h3>
                    <p>${REAL_BOOKS_DATABASE.length} كتاب</p>
                </div>
                
                <div class="card" onclick="showMyBooks()">
                    <i class="fas fa-heart"></i>
                    <h3>المفضلة</h3>
                    <p>كتبي المفضلة</p>
                </div>
                
                <div class="card" onclick="filterByGrade()">
                    <i class="fas fa-filter"></i>
                    <h3>فلترة حسب الصف</h3>
                    <p>اختر صفك الدراسي</p>
                </div>
                
                <div class="card" onclick="filterBySubject()">
                    <i class="fas fa-filter"></i>
                    <h3>فلترة حسب المادة</h3>
                    <p>اختر المادة الدراسية</p>
                </div>
            </div>
            
            <div id="books-container" class="loading" style="margin-top:25px;">
                <div class="loading-spinner"></div>
                <div>جاري تحميل الكتب...</div>
            </div>
        </div>`;
    
    setTimeout(loadBooks, 500);
}

function loadBooks() {
    try {
        const container = document.getElementById('books-container');
        
        if (!REAL_BOOKS_DATABASE || REAL_BOOKS_DATABASE.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; padding:40px; color:var(--text-sec);">
                    <i class="fas fa-book" style="font-size:50px; margin-bottom:15px;"></i>
                    <p>لا توجد كتب متاحة حالياً</p>
                </div>`;
            return;
        }
        
        let html = `
            <div style="margin-bottom:20px;">
                <h3><i class="fas fa-books"></i> جميع الكتب (${REAL_BOOKS_DATABASE.length} كتاب)</h3>
                <p style="color:var(--text-sec);">اضغط على أي كتاب لعرض التفاصيل والتحميل</p>
            </div>
            <div class="books-grid">`;
        
        REAL_BOOKS_DATABASE.forEach(book => {
            const gradeColor = getGradeColor(book.grade);
            
            // التحقق مما إذا كان الكتاب في المفضلة
            let isFavorite = false;
            if (currentUserData && currentUserData.favorites && currentUserData.favorites[book.id]) {
                isFavorite = true;
            }
            
            html += `
                <div class="book-item" onclick="viewBook('${book.id}')">
                    <div style="text-align:center;">
                        <i class="fas ${book.icon || 'fa-book'}" style="font-size:40px; color:${gradeColor}; margin-bottom:10px;"></i>
                        <h4 style="margin:10px 0; color:var(--text-main);">${book.title}</h4>
                        <p style="color:var(--text-sec); font-size:14px; margin:5px 0;">
                            <i class="fas fa-user"></i> ${book.author}
                        </p>
                        <div style="display:flex; justify-content:center; gap:5px; margin-top:10px;">
                            <span class="grade-badge" style="background:${gradeColor};">${book.grade}</span>
                            <span class="grade-badge" style="background:var(--accent);">${book.subject}</span>
                        </div>
                        <div style="margin-top:15px;">
                            <button class="btn-secondary" onclick="event.stopPropagation(); addToFavorites('${book.id}', event)" style="width:100%;">
                                <i class="fas fa-heart" style="color:${isFavorite ? 'red' : 'var(--text-sec)'};"></i> 
                                ${isFavorite ? 'تم الإضافة' : 'إضافة للمفضلة'}
                            </button>
                        </div>
                    </div>
                </div>`;
        });
        
        html += `</div>`;
        container.innerHTML = html;
        
    } catch (error) {
        console.error('خطأ في تحميل الكتب:', error);
        document.getElementById('books-container').innerHTML = `
            <div style="text-align:center; padding:40px; color:var(--red);">
                <i class="fas fa-exclamation-circle" style="font-size:50px; margin-bottom:15px;"></i>
                <p>حدث خطأ في تحميل الكتب</p>
                <button class="btn-secondary" onclick="loadBooks()" style="width:auto; margin-top:15px;">
                    <i class="fas fa-redo"></i> إعادة المحاولة
                </button>
            </div>`;
    }
}

function getGradeColor(grade) {
    const colors = {
        'الأول الابتدائي': '#3b82f6',
        'الثاني الابتدائي': '#8b5cf6',
        'الثالث الابتدائي': '#10b981',
        'الرابع الابتدائي': '#f59e0b',
        'الخامس الابتدائي': '#ef4444',
        'السادس الابتدائي': '#06b6d4',
        'الأول المتوسط': '#8b5cf6',
        'الثاني المتوسط': '#3b82f6',
        'الثالث المتوسط': '#10b981',
        'الأول الثانوي': '#f59e0b',
        'الثاني الثانوي': '#ef4444',
        'الثالث الثانوي': '#06b6d4',
        'جميع الصفوف': '#6366f1'
    };
    return colors[grade] || '#6b7280';
}

function filterByGrade() {
    const grades = Array.from(new Set(REAL_BOOKS_DATABASE.map(book => book.grade)));
    
    Swal.fire({
        title: 'فلترة حسب الصف الدراسي',
        html: `
            <div style="text-align:right;">
                <select id="filter-grade" class="swal2-input">
                    <option value="all">جميع الصفوف</option>
                    ${grades.map(grade => `<option value="${grade}">${grade}</option>`).join('')}
                </select>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'تطبيق الفلترة',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            const selectedGrade = document.getElementById('filter-grade').value;
            const filteredBooks = selectedGrade === 'all' 
                ? REAL_BOOKS_DATABASE 
                : REAL_BOOKS_DATABASE.filter(book => book.grade === selectedGrade);
            
            displayFilteredBooks(filteredBooks, `كتب ${selectedGrade === 'all' ? 'جميع الصفوف' : selectedGrade}`);
        }
    });
}

function filterBySubject() {
    const subjects = Array.from(new Set(REAL_BOOKS_DATABASE.map(book => book.subject)));
    
    Swal.fire({
        title: 'فلترة حسب المادة الدراسية',
        html: `
            <div style="text-align:right;">
                <select id="filter-subject" class="swal2-input">
                    <option value="all">جميع المواد</option>
                    ${subjects.map(subject => `<option value="${subject}">${subject}</option>`).join('')}
                </select>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'تطبيق الفلترة',
        cancelButtonText: 'إلغاء'
    }).then((result) => {
        if (result.isConfirmed) {
            const selectedSubject = document.getElementById('filter-subject').value;
            const filteredBooks = selectedSubject === 'all' 
                ? REAL_BOOKS_DATABASE 
                : REAL_BOOKS_DATABASE.filter(book => book.subject === selectedSubject);
            
            displayFilteredBooks(filteredBooks, `كتب ${selectedSubject === 'all' ? 'جميع المواد' : selectedSubject}`);
        }
    });
}

function displayFilteredBooks(books, title) {
    const container = document.getElementById('books-container');
    
    if (books.length === 0) {
        container.innerHTML = `
            <div style="text-align:center; padding:40px; color:var(--text-sec);">
                <i class="fas fa-search" style="font-size:50px; margin-bottom:15px;"></i>
                <p>لا توجد كتب تطابق الفلترة المختارة</p>
                <button class="btn-main" onclick="loadBooks()" style="width:auto; margin-top:15px;">
                    <i class="fas fa-arrow-right"></i> عرض جميع الكتب
                </button>
            </div>`;
        return;
    }
    
    let html = `
        <div style="margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
            <h3><i class="fas fa-filter"></i> ${title} (${books.length} كتاب)</h3>
            <button class="btn-secondary" onclick="loadBooks()" style="width:auto;">
                <i class="fas fa-times"></i> إلغاء الفلترة
            </button>
        </div>
        <div class="books-grid">`;
    
    books.forEach(book => {
        const gradeColor = getGradeColor(book.grade);
        
        html += `
            <div class="book-item" onclick="viewBook('${book.id}')">
                <div style="text-align:center;">
                    <i class="fas ${book.icon || 'fa-book'}" style="font-size:40px; color:${gradeColor}; margin-bottom:10px;"></i>
                    <h4 style="margin:10px 0; color:var(--text-main);">${book.title}</h4>
                    <p style="color:var(--text-sec); font-size:14px; margin:5px 0;">
                        <i class="fas fa-user"></i> ${book.author}
                    </p>
                    <div style="display:flex; justify-content:center; gap:5px; margin-top:10px;">
                        <span class="grade-badge" style="background:${gradeColor};">${book.grade}</span>
                        <span class="grade-badge" style="background:var(--accent);">${book.subject}</span>
                    </div>
                </div>
            </div>`;
    });
    
    html += `</div>`;
    container.innerHTML = html;
}

async function viewBook(bookId) {
    try {
        showLoading('جاري تحميل تفاصيل الكتاب...');
        
        const book = REAL_BOOKS_DATABASE.find(b => b.id === bookId);
        
        if (!book) {
            throw new Error('الكتاب غير موجود');
        }
        
        currentBook = book;
        
        hideLoading();
        
        document.getElementById('app-screen').classList.add('hidden');
        document.getElementById('library-detail-screen').classList.remove('hidden');
        
        document.getElementById('library-detail-title').textContent = book.title;
        
        const content = document.getElementById('book-detail-content');
        const gradeColor = getGradeColor(book.grade);
        
        // التحقق مما إذا كان الكتاب في المفضلة
        let isFavorite = false;
        if (currentUserData && currentUserData.uid) {
            try {
                const snapshot = await db.ref(`users/${currentUserData.uid}/favorites/${book.id}`).once('value');
                isFavorite = snapshot.exists();
            } catch (error) {
                console.error('خطأ في التحقق من المفضلة:', error);
            }
        }
        
        content.innerHTML = `
            <div style="background:var(--bg-card); border-radius:20px; padding:25px;">
                <div style="text-align:center; margin-bottom:25px;">
                    <i class="fas ${book.icon || 'fa-book'}" style="font-size:80px; color:${gradeColor}; margin-bottom:15px;"></i>
                    <h2 style="margin:10px 0; color:var(--neon-blue);">${book.title}</h2>
                    <p style="color:var(--accent); font-size:18px;">${book.author}</p>
                </div>
                
                <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:15px; margin-bottom:25px;">
                    <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:10px;">
                        <div style="color:var(--text-sec); font-size:14px;">الصف الدراسي</div>
                        <div style="color:white; font-weight:bold;">${book.grade}</div>
                    </div>
                    <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:10px;">
                        <div style="color:var(--text-sec); font-size:14px;">المادة</div>
                        <div style="color:white; font-weight:bold;">${book.subject}</div>
                    </div>
                    <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:10px;">
                        <div style="color:var(--text-sec); font-size:14px;">سنة النشر</div>
                        <div style="color:white; font-weight:bold;">${book.year}</div>
                    </div>
                    <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:10px;">
                        <div style="color:var(--text-sec); font-size:14px;">الصفحات</div>
                        <div style="color:white; font-weight:bold;">${book.pages}</div>
                    </div>
                </div>
                
                <div style="margin-bottom:25px;">
                    <h4 style="color:var(--accent);"><i class="fas fa-align-left"></i> الوصف</h4>
                    <p style="color:var(--text-main); line-height:1.6;">${book.description}</p>
                </div>
                
                <div style="display:flex; gap:15px; margin-top:25px;">
                    <button class="btn-main" onclick="readBook('${book.id}')" style="flex:1;">
                        <i class="fas fa-book-reader"></i> قراءة الكتاب
                    </button>
                    <button class="btn-main" onclick="downloadBook('${book.id}', '${book.title.replace(/\s+/g, '_')}.pdf')" style="flex:1;">
                        <i class="fas fa-download"></i> تحميل الكتاب
                    </button>
                </div>
                
                <div style="display:flex; gap:15px; margin-top:15px;">
                    <button class="btn-secondary" onclick="addToFavorites('${book.id}')" style="flex:1;">
                        <i class="fas fa-heart" style="color:${isFavorite ? 'red' : 'var(--text-sec)'};"></i> 
                        ${isFavorite ? 'حذف من المفضلة' : 'إضافة للمفضلة'}
                    </button>
                </div>
                
                <div style="margin-top:25px; padding:15px; background:rgba(59, 130, 246, 0.1); border-radius:10px;">
                    <h5 style="color:var(--primary); margin-top:0;"><i class="fas fa-info-circle"></i> معلومات التحميل</h5>
                    <ul style="color:var(--text-sec); padding-right:15px;">
                        <li>الكتاب مجاني للتحميل</li>
                        <li>يمكنك قراءة الكتاب مباشرة في المتصفح</li>
                        <li>يتم تخزين الكتاب في سيرفر البوت</li>
                        <li>يمكنك تحميل الكتاب عدة مرات</li>
                        <li>يتم إرسال نسخة إلى Telegram</li>
                    </ul>
                </div>
            </div>`;
        
    } catch (error) {
        hideLoading();
        console.error('خطأ في عرض الكتاب:', error);
        showAlert('خطأ', 'حدث خطأ في تحميل تفاصيل الكتاب', 'error');
        nav('library');
    }
}

// ==================== [ 12. نظام المفضلة - محدث ] ====================
async function addToFavorites(bookId, event = null) {
    try {
        if (event) event.stopPropagation();
        
        if (!currentUserData || !currentUserData.uid) {
            showAlert('خطأ', 'يجب تسجيل الدخول أولاً', 'error');
            return;
        }
        
        const book = REAL_BOOKS_DATABASE.find(b => b.id === bookId);
        if (!book) {
            showAlert('خطأ', 'الكتاب غير موجود', 'error');
            return;
        }
        
        // التحقق مما إذا كان الكتاب موجوداً في المفضلة
        const snapshot = await db.ref(`users/${currentUserData.uid}/favorites/${bookId}`).once('value');
        const isFavorite = snapshot.exists();
        
        if (isFavorite) {
            // حذف من المفضلة
            await db.ref(`users/${currentUserData.uid}/favorites/${bookId}`).remove();
            showAlert('تم', `تم حذف "${book.title}" من المفضلة`, 'success');
            
            // تحديث الزر
            if (event) {
                const button = event.target.closest('button');
                if (button) {
                    button.innerHTML = '<i class="fas fa-heart"></i> إضافة للمفضلة';
                    button.style.color = 'var(--text-sec)';
                }
            }
        } else {
            // إضافة إلى المفضلة
            await db.ref(`users/${currentUserData.uid}/favorites/${bookId}`).set({
                bookId: bookId,
                title: book.title,
                subject: book.subject,
                grade: book.grade,
                addedAt: Date.now()
            });
            
            showAlert('نجاح', `تم إضافة "${book.title}" إلى المفضلة`, 'success');
            
            // تحديث الزر
            if (event) {
                const button = event.target.closest('button');
                if (button) {
                    button.innerHTML = '<i class="fas fa-heart" style="color:red;"></i> تم الإضافة';
                }
            }
        }
        
        // تحديث بيانات المستخدم المحلية
        if (!currentUserData.favorites) currentUserData.favorites = {};
        if (!isFavorite) {
            currentUserData.favorites[bookId] = true;
        } else {
            delete currentUserData.favorites[bookId];
        }
        
    } catch (error) {
        console.error('خطأ في إضافة/حذف الكتاب من المفضلة:', error);
        showAlert('خطأ', 'حدث خطأ في تحديث المفضلة', 'error');
    }
}

async function loadFavoriteBooks() {
    try {
        if (!currentUserData || !currentUserData.uid) {
            document.getElementById('favorite-books').innerHTML = `
                <div style="text-align:center; padding:40px; color:var(--text-sec);">
                    <i class="fas fa-user-slash" style="font-size:50px; margin-bottom:15px;"></i>
                    <p>يجب تسجيل الدخول أولاً</p>
                    <button class="btn-main" onclick="nav('home')" style="width:auto; margin-top:15px;">
                        <i class="fas fa-home"></i> العودة للرئيسية
                    </button>
                </div>`;
            return;
        }
        
        showLoading('جاري تحميل كتبك المفضلة...');
        
        const snapshot = await db.ref(`users/${currentUserData.uid}/favorites`).once('value');
        const favorites = snapshot.val();
        
        hideLoading();
        
        if (!favorites) {
            document.getElementById('favorite-books').innerHTML = `
                <div style="text-align:center; padding:40px; color:var(--text-sec);">
                    <i class="fas fa-heart" style="font-size:50px; margin-bottom:15px;"></i>
                    <p>لا توجد كتب في قائمة المفضلة</p>
                    <button class="btn-main" onclick="nav('library')" style="width:auto; margin-top:15px;">
                        <i class="fas fa-book"></i> تصفح المكتبة
                    </button>
                </div>`;
            return;
        }
        
        const favoriteBooks = Object.values(favorites);
        let html = `
            <div style="margin-bottom:20px;">
                <h3><i class="fas fa-heart" style="color:red;"></i> كتبي المفضلة (${favoriteBooks.length} كتاب)</h3>
                <p style="color:var(--text-sec);">الكتب التي أضفتها إلى المفضلة</p>
            </div>
            <div class="books-grid">`;
        
        favoriteBooks.forEach(fav => {
            const book = REAL_BOOKS_DATABASE.find(b => b.id === fav.bookId);
            if (book) {
                const gradeColor = getGradeColor(book.grade);
                
                html += `
                    <div class="book-item" onclick="viewBook('${book.id}')">
                        <div style="text-align:center;">
                            <i class="fas ${book.icon || 'fa-book'}" style="font-size:40px; color:${gradeColor}; margin-bottom:10px;"></i>
                            <h4 style="margin:10px 0; color:var(--text-main);">${book.title}</h4>
                            <p style="color:var(--text-sec); font-size:14px; margin:5px 0;">
                                <i class="fas fa-user"></i> ${book.author}
                            </p>
                            <div style="display:flex; justify-content:center; gap:5px; margin-top:10px;">
                                <span class="grade-badge" style="background:${gradeColor};">${book.grade}</span>
                                <span class="grade-badge" style="background:var(--accent);">${book.subject}</span>
                            </div>
                            <div style="margin-top:15px;">
                                <button class="btn-danger" onclick="event.stopPropagation(); addToFavorites('${book.id}', event)" style="width:100%;">
                                    <i class="fas fa-trash"></i> حذف من المفضلة
                                </button>
                            </div>
                        </div>
                    </div>`;
            }
        });
        
        html += `</div>`;
        document.getElementById('favorite-books').innerHTML = html;
        
    } catch (error) {
        console.error('خطأ في تحميل الكتب المفضلة:', error);
        document.getElementById('favorite-books').innerHTML = `
            <div style="text-align:center; padding:20px; color:var(--red);">
                <i class="fas fa-exclamation-circle"></i> حدث خطأ في تحميل الكتب المفضلة
            </div>`;
    }
}

function showMyBooks() {
    const area = document.getElementById('content-area');
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="background: linear-gradient(135deg, var(--accent) 0%, #d97706 100%); border-radius:20px; padding:25px; color:white; margin-bottom:25px;">
                <h2 style="margin-top:0;"><i class="fas fa-heart"></i> كتبي المفضلة</h2>
                <p>الكتب التي أضفتها إلى المفضلة</p>
            </div>
            
            <div id="favorite-books" class="loading">
                <div class="loading-spinner"></div>
                <div>جاري تحميل كتبك المفضلة...</div>
            </div>
        </div>`;
    
    loadFavoriteBooks();
}

// ==================== [ 13. قارئ الكتب ] ====================
function readBook(bookId) {
    const book = REAL_BOOKS_DATABASE.find(b => b.id === bookId);
    if (!book) {
        showAlert('خطأ', 'الكتاب غير موجود', 'error');
        return;
    }
    
    currentBook = book;
    currentPage = 1;
    fontSize = 18;
    
    document.getElementById('library-detail-screen').classList.add('hidden');
    document.getElementById('book-reader-screen').classList.remove('hidden');
    
    document.getElementById('reader-title').textContent = `قارئ: ${book.title}`;
    
    renderBookReader();
}

function renderBookReader() {
    if (!currentBook) return;
    
    const content = document.getElementById('book-reader-content');
    
    // تقسيم المحتوى إلى صفحات
    const pages = splitContentIntoPages(currentBook.content, 1500);
    const totalPages = pages.length;
    
    content.innerHTML = `
        <div class="reader-header">
            <div>
                <h3 style="margin:0; color:var(--neon-blue);">${currentBook.title}</h3>
                <p style="margin:5px 0 0; color:var(--text-sec); font-size:14px;">${currentBook.author}</p>
            </div>
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="color:var(--accent); font-weight:bold;">الصفحة ${currentPage} من ${totalPages}</span>
                <button class="bookmark-btn ${isBookmarked ? 'active' : ''}" onclick="toggleBookmark()">
                    <i class="fas fa-bookmark"></i> ${isBookmarked ? 'محفوظة' : 'حفظ'}
                </button>
            </div>
        </div>
        
        <div class="reader-content" id="reader-text" style="font-size:${fontSize}px;">
            ${pages[currentPage - 1] || 'لا يوجد محتوى'}
        </div>
        
        <div class="reader-controls">
            <div class="page-nav">
                <button class="btn-secondary" onclick="prevPage()" ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-right"></i> السابقة
                </button>
                <span style="color:var(--text-sec);">${currentPage}/${totalPages}</span>
                <button class="btn-secondary" onclick="nextPage()" ${currentPage === totalPages ? 'disabled' : ''}>
                    التالية <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            
            <div class="font-controls">
                <button class="btn-secondary" onclick="decreaseFont()" style="width:40px; height:40px;">
                    <i class="fas fa-minus"></i>
                </button>
                <span style="color:var(--text-sec); font-size:14px;">${fontSize}px</span>
                <button class="btn-secondary" onclick="increaseFont()" style="width:40px; height:40px;">
                    <i class="fas fa-plus"></i>
                </button>
                <button class="btn-secondary" onclick="toggleDarkMode()" style="width:40px; height:40px;">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>`;
}

function splitContentIntoPages(content, charsPerPage = 1500) {
    if (!content) return ['لا يوجد محتوى'];
    
    const pages = [];
    const paragraphs = content.split('\n\n');
    
    let currentPage = '';
    let currentChars = 0;
    
    for (const paragraph of paragraphs) {
        if (currentChars + paragraph.length > charsPerPage && currentPage !== '') {
            pages.push(currentPage);
            currentPage = paragraph;
            currentChars = paragraph.length;
        } else {
            currentPage += (currentPage ? '\n\n' : '') + paragraph;
            currentChars += paragraph.length;
        }
    }
    
    if (currentPage) {
        pages.push(currentPage);
    }
    
    return pages;
}

function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        renderBookReader();
    }
}

function nextPage() {
    const pages = splitContentIntoPages(currentBook.content, 1500);
    if (currentPage < pages.length) {
        currentPage++;
        renderBookReader();
    }
}

function increaseFont() {
    if (fontSize < 30) {
        fontSize += 2;
        document.getElementById('reader-text').style.fontSize = `${fontSize}px`;
    }
}

function decreaseFont() {
    if (fontSize > 14) {
        fontSize -= 2;
        document.getElementById('reader-text').style.fontSize = `${fontSize}px`;
    }
}

function toggleDarkMode() {
    const reader = document.getElementById('book-reader-content');
    if (reader.style.background === 'white') {
        reader.style.background = 'var(--bg-card)';
        reader.style.color = 'var(--text-main)';
    } else {
        reader.style.background = 'white';
        reader.style.color = 'black';
    }
}

function toggleBookmark() {
    isBookmarked = !isBookmarked;
    renderBookReader();
}

function backToBookDetail() {
    document.getElementById('book-reader-screen').classList.add('hidden');
    if (currentBook) {
        viewBook(currentBook.id);
    } else {
        document.getElementById('app-screen').classList.remove('hidden');
        nav('library');
    }
}

// ==================== [ 14. تحميل الكتب ] ====================
async function downloadBook(bookId, filename) {
    try {
        showLoading('جاري تحضير الكتاب للتحميل...');
        
        const book = REAL_BOOKS_DATABASE.find(b => b.id === bookId);
        if (!book) {
            throw new Error('الكتاب غير موجود');
        }
        
        // إنشاء محتوى PDF وهمي
        const content = `
            ${book.title}
            ${book.author}
            
            ${book.description}
            
            الصف: ${book.grade}
            المادة: ${book.subject}
            سنة النشر: ${book.year}
            عدد الصفحات: ${book.pages}
            
            ---
            
            هذا نسخة تجريبية من الكتاب. للنسخة الكاملة، يرجى التواصل مع الإدارة.
        `;
        
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        hideLoading();
        
        // إنشاء رابط تحميل وهمي
        const blob = new Blob([content], { type: 'application/pdf' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showAlert('نجاح', `تم تحميل الكتاب "${book.title}" بنجاح!`, 'success');
        
        if (currentUserData && currentUserData.uid) {
            try {
                await db.ref(`users/${currentUserData.uid}/downloads`).push({
                    bookId: bookId,
                    filename: filename,
                    downloadDate: Date.now()
                });
                
                // تحديث عدد الكتب المحملة
                const downloadsSnapshot = await db.ref(`users/${currentUserData.uid}/downloads`).once('value');
                const downloadsCount = downloadsSnapshot.numChildren();
                await db.ref(`users/${currentUserData.uid}/booksDownloaded`).set(downloadsCount);
                
            } catch (dbError) {
                console.error('خطأ في تسجيل التحميل:', dbError);
            }
        }
        
    } catch (error) {
        hideLoading();
        console.error('خطأ في تحميل الكتاب:', error);
        showAlert('خطأ', 'حدث خطأ في تحميل الكتاب', 'error');
    }
}

// ==================== [ 15. المساعد الذكي - تم إصلاحه ] ====================
function renderAIAssistant() {
    document.getElementById('app-screen').classList.add('hidden');
    document.getElementById('ai-assistant-screen').classList.remove('hidden');
    
    const content = document.getElementById('ai-assistant-content');
    content.innerHTML = `
        <div style="text-align:center; margin-bottom:30px;">
            <i class="fas fa-robot" style="font-size:80px; color:var(--neon-blue); margin-bottom:15px;"></i>
            <h2 style="color:var(--neon-blue); margin:0;">المساعد الذكي</h2>
            <p style="color:var(--text-sec);">أنشئ اختبارات ذكية وحصل على تقييم فوري</p>
        </div>
        
        <div class="grid">
            <div class="card" onclick="generateQuiz()">
                <i class="fas fa-question-circle"></i>
                <h3>إنشاء اختبار</h3>
                <p>اختبار ذكي من كتاب</p>
            </div>
            
            <div class="card" onclick="showMyQuizzes()">
                <i class="fas fa-history"></i>
                <h3>اختباراتي</h3>
                <p>الاختبارات السابقة</p>
            </div>
            
            <div class="card" onclick="showAIStats()">
                <i class="fas fa-chart-bar"></i>
                <h3>إحصائيات</h3>
                <p>تتبع تقدمك</p>
            </div>
            
            <div class="card" onclick="showAIHelp()">
                <i class="fas fa-question-circle"></i>
                <h3>مساعدة</h3>
                <p>كيفية استخدام المساعد</p>
            </div>
        </div>
        
        <div style="margin-top:30px;">
            <h4><i class="fas fa-bolt"></i> ميزات المساعد الذكي</h4>
            <div style="background:rgba(0,0,0,0.2); border-radius:15px; padding:20px; margin-top:15px;">
                <ul style="color:var(--text-sec); padding-right:15px;">
                    <li>إنشاء اختبارات ذكية من أي كتاب</li>
                    <li>تقييم فوري بعد الانتهاء من الاختبار</li>
                    <li>تحليل نقاط القوة والضعف</li>
                    <li>اقتراح دروس للمراجعة</li>
                    <li>تتبع تقدمك الدراسي</li>
                </ul>
            </div>
        </div>`;
}

async function generateQuiz() {
    try {
        if (!currentUserData || !currentUserData.uid) {
            showAlert('خطأ', 'يجب تسجيل الدخول أولاً', 'error');
            return;
        }
        
        const today = new Date().toISOString().split('T')[0];
        const dailyKey = `ai_questions_${currentUserData.uid}_${today}`;
        
        const snapshot = await db.ref(`ai_usage/${dailyKey}`).once('value');
        const todayUsage = snapshot.val() || { count: 0 };
        
        if (todayUsage.count >= MAX_DAILY_QUESTIONS) {
            showAlert('حد يومي', 
                `لقد استخدمت الحد اليومي (${MAX_DAILY_QUESTIONS} سؤال)\nيرجى المحاولة مرة أخرى غداً`,
                'warning'
            );
            return;
        }
        
        Swal.fire({
            title: 'إنشاء اختبار ذكي',
            html: `
                <div style="text-align:right;">
                    <p>اختر خيارات الاختبار:</p>
                    <input type="number" id="question-count" class="swal2-input" placeholder="عدد الأسئلة (1-20)" value="10" min="1" max="20">
                    <select id="question-types" class="swal2-input" multiple style="height:120px;">
                        <option value="mcq" selected>أسئلة الاختيار من متعدد</option>
                        <option value="true_false" selected>صح/خطأ</option>
                        <option value="essay">أسئلة مقالية</option>
                    </select>
                    <small>اضغط Ctrl لتحديد أكثر من نوع</small>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'إنشاء الاختبار',
            cancelButtonText: 'إلغاء',
            preConfirm: () => {
                const questionCount = Swal.getPopup().querySelector('#question-count').value;
                const questionTypes = Array.from(Swal.getPopup().querySelector('#question-types').selectedOptions)
                    .map(option => option.value);
                
                if (!questionCount || questionCount < 1 || questionCount > 20) {
                    Swal.showValidationMessage('الرجاء إدخال عدد أسئلة صحيح (1-20)');
                    return false;
                }
                
                if (questionTypes.length === 0) {
                    Swal.showValidationMessage('الرجاء اختيار نوع واحد على الأقل');
                    return false;
                }
                
                return { questionCount: parseInt(questionCount), questionTypes };
            }
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    showLoading('جاري إنشاء الاختبار الذكي...');
                    
                    // تحديث عدد الأسئلة المستخدمة
                    await db.ref(`ai_usage/${dailyKey}`).set({
                        count: todayUsage.count + 1,
                        lastUsed: Date.now()
                    });
                    
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    hideLoading();
                    
                    // إنشاء اختبار وهمي
                    const quiz = {
                        quizTitle: 'اختبار ذكي في الرياضيات',
                        questions: []
                    };
                    
                    for (let i = 1; i <= result.value.questionCount; i++) {
                        quiz.questions.push({
                            question: `سؤال ${i}: ما هو ناتج ${i} × ${i}؟`,
                            type: 'mcq',
                            options: [`${i * i}`, `${i + i}`, `${i - i}`, `${i / i}`],
                            correctAnswer: 0
                        });
                    }
                    
                    currentQuiz = quiz;
                    showQuiz(quiz);
                    
                } catch (error) {
                    hideLoading();
                    console.error('خطأ في إنشاء الاختبار:', error);
                    showAlert('خطأ', 'حدث خطأ في إنشاء الاختبار', 'error');
                }
            }
        });
        
    } catch (error) {
        console.error('خطأ في التحضير للاختبار:', error);
        showAlert('خطأ', 'حدث خطأ في التحضير للاختبار', 'error');
    }
}

function showQuiz(quiz) {
    document.getElementById('ai-assistant-screen').classList.add('hidden');
    document.getElementById('quiz-screen').classList.remove('hidden');
    
    document.getElementById('quiz-title').textContent = quiz.quizTitle;
    
    const quizContent = document.getElementById('quiz-content');
    let html = '';
    
    quiz.questions.forEach((question, index) => {
        html += `
            <div class="question-card">
                <h4>${question.question}</h4>
                <div style="color:var(--text-sec); font-size:14px; margin-bottom:15px;">
                    <i class="fas fa-question-circle"></i> اختيار من متعدد
                </div>`;
        
        question.options.forEach((option, optionIndex) => {
            html += `
                <div class="option-item" onclick="selectAnswer(${index}, ${optionIndex})" id="option_${index}_${optionIndex}">
                    ${String.fromCharCode(1570 + optionIndex)}. ${option}
                </div>`;
        });
        
        html += `</div>`;
    });
    
    quizContent.innerHTML = html;
    
    startQuizTimer();
}

function selectAnswer(questionIndex, answerIndex) {
    const questionElement = document.querySelectorAll('.question-card')[questionIndex];
    questionElement.querySelectorAll('.option-item').forEach(option => {
        option.classList.remove('selected');
    });
    
    const selectedOption = document.getElementById(`option_${questionIndex}_${answerIndex}`);
    if (selectedOption) {
        selectedOption.classList.add('selected');
        if (!currentQuiz.userAnswers) currentQuiz.userAnswers = [];
        currentQuiz.userAnswers[questionIndex] = answerIndex;
    }
}

function startQuizTimer() {
    quizTimeRemaining = 1800;
    updateQuizTimer();
    
    quizTimer = setInterval(() => {
        quizTimeRemaining--;
        updateQuizTimer();
        
        if (quizTimeRemaining <= 0) {
            clearInterval(quizTimer);
            submitQuiz();
        }
    }, 1000);
}

function updateQuizTimer() {
    const minutes = Math.floor(quizTimeRemaining / 60);
    const seconds = quizTimeRemaining % 60;
    document.getElementById('quiz-timer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}

async function submitQuiz() {
    if (quizTimer) {
        clearInterval(quizTimer);
    }
    
    try {
        showLoading('جاري تصحيح الاختبار...');
        
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        hideLoading();
        
        // حساب النتيجة
        let correctAnswers = 0;
        const totalQuestions = currentQuiz.questions.length;
        
        if (currentQuiz.userAnswers) {
            currentQuiz.questions.forEach((question, index) => {
                if (currentQuiz.userAnswers[index] === question.correctAnswer) {
                    correctAnswers++;
                }
            });
        }
        
        const percentage = Math.round((correctAnswers / totalQuestions) * 100);
        
        // حفظ النتيجة
        if (currentUserData && currentUserData.uid) {
            await db.ref(`users/${currentUserData.uid}/quizzes`).push({
                title: currentQuiz.quizTitle,
                correctAnswers: correctAnswers,
                totalQuestions: totalQuestions,
                percentage: percentage,
                date: Date.now(),
                timeSpent: 1800 - quizTimeRemaining
            });
            
            // تحديث الإحصائيات
            const quizzesSnapshot = await db.ref(`users/${currentUserData.uid}/quizzes`).once('value');
            const quizzesCount = quizzesSnapshot.numChildren();
            await db.ref(`users/${currentUserData.uid}/aiQuizzesCount`).set(quizzesCount);
        }
        
        document.getElementById('quiz-screen').classList.add('hidden');
        document.getElementById('quiz-results-screen').classList.remove('hidden');
        
        const resultsContent = document.getElementById('quiz-results-content');
        resultsContent.innerHTML = `
            <div style="text-align:center; margin-bottom:30px;">
                <div style="width:100px; height:100px; border-radius:50%; background:var(--green); display:flex; align-items:center; justify-content:center; margin:0 auto 20px;">
                    <span style="color:white; font-size:32px; font-weight:bold;">${correctAnswers}/${totalQuestions}</span>
                </div>
                <h3 style="color:var(--green);">${percentage}%</h3>
                <p>${percentage >= 80 ? 'ممتاز! أداء رائع.' : percentage >= 60 ? 'جيد! يمكنك التحسين.' : 'يحتاج إلى مراجعة.'}</p>
            </div>
            
            <div style="margin-top:30px;">
                <h4><i class="fas fa-chart-line"></i> تفاصيل النتيجة</h4>
                <div style="display:grid; grid-template-columns:repeat(2, 1fr); gap:15px; margin-top:15px;">
                    <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:10px;">
                        <div style="color:var(--text-sec); font-size:14px;">الوقت المستغرق</div>
                        <div style="color:white; font-weight:bold;">${Math.floor((1800 - quizTimeRemaining) / 60)} دقيقة</div>
                    </div>
                    <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:10px;">
                        <div style="color:var(--text-sec); font-size:14px;">مستوى الصعوبة</div>
                        <div style="color:white; font-weight:bold;">متوسط</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top:30px;">
                <h4><i class="fas fa-lightbulb"></i> نصائح للتحسين</h4>
                <div style="background:rgba(59, 130, 246, 0.1); border-radius:10px; padding:15px; margin-top:10px;">
                    <ul style="color:var(--text-sec); padding-right:15px;">
                        <li>راجع الدروس التي أخطأت فيها</li>
                        <li>تمرن على حل المزيد من الأسئلة</li>
                        <li>استخدم المساعد الذكي للمراجعة</li>
                        <li>حاول التركيز على نقاط الضعف</li>
                    </ul>
                </div>
            </div>
            
            <div style="margin-top:30px;">
                <button class="btn-main" onclick="backToAI()" style="width:100%;">
                    <i class="fas fa-arrow-right"></i> العودة للمساعد الذكي
                </button>
                <button class="btn-secondary" onclick="generateQuiz()" style="width:100%; margin-top:10px;">
                    <i class="fas fa-redo"></i> إنشاء اختبار جديد
                </button>
            </div>`;
        
    } catch (error) {
        hideLoading();
        console.error('خطأ في تصحيح الاختبار:', error);
        showAlert('خطأ', 'حدث خطأ في تصحيح الاختبار', 'error');
        backToAI();
    }
}

function backToAI() {
    document.getElementById('quiz-results-screen').classList.add('hidden');
    document.getElementById('quiz-screen').classList.add('hidden');
    document.getElementById('ai-assistant-screen').classList.remove('hidden');
}

function showMyQuizzes() {
    const content = document.getElementById('ai-assistant-content');
    content.innerHTML = `
        <div style="background:var(--bg-card); border-radius:20px; padding:25px;">
            <h3><i class="fas fa-history"></i> اختباراتي السابقة</h3>
            <p style="color:var(--text-sec); margin-bottom:20px;">عرض جميع الاختبارات التي أجريتها</p>
            
            <div style="text-align:center; padding:40px; color:var(--text-sec);">
                <i class="fas fa-question-circle" style="font-size:50px; margin-bottom:15px;"></i>
                <p>لم تقم بأي اختبارات بعد</p>
                <button class="btn-main" onclick="generateQuiz()" style="width:auto; margin-top:15px;">
                    <i class="fas fa-plus"></i> إنشاء اختبار جديد
                </button>
            </div>
        </div>`;
}

function showAIStats() {
    const content = document.getElementById('ai-assistant-content');
    content.innerHTML = `
        <div style="background:var(--bg-card); border-radius:20px; padding:25px;">
            <h3><i class="fas fa-chart-bar"></i> إحصائيات المساعد الذكي</h3>
            <p style="color:var(--text-sec); margin-bottom:20px;">تتبع تقدمك في استخدام المساعد الذكي</p>
            
            <div class="admin-stats">
                <div class="stat-card">
                    <div style="color:var(--text-sec); font-size:14px;">الاختبارات المكتملة</div>
                    <div class="stat-value">${currentUserData?.aiQuizzesCount || 0}</div>
                </div>
                
                <div class="stat-card">
                    <div style="color:var(--text-sec); font-size:14px;">متوسط النتائج</div>
                    <div class="stat-value">75%</div>
                </div>
                
                <div class="stat-card">
                    <div style="color:var(--text-sec); font-size:14px;">الحد اليومي المتبقي</div>
                    <div class="stat-value">${MAX_DAILY_QUESTIONS}</div>
                </div>
                
                <div class="stat-card">
                    <div style="color:var(--text-sec); font-size:14px;">مجموع الأسئلة</div>
                    <div class="stat-value">${(currentUserData?.aiQuizzesCount || 0) * 10}</div>
                </div>
            </div>
            
            <div style="margin-top:30px;">
                <h4><i class="fas fa-calendar"></i> النشاط اليومي</h4>
                <div style="background:rgba(0,0,0,0.2); border-radius:10px; padding:15px; margin-top:10px;">
                    <div style="color:var(--text-sec); font-size:14px;">اليوم</div>
                    <div style="color:white; font-weight:bold;">${new Date().toLocaleDateString('ar-SA')}</div>
                    <div style="margin-top:10px; color:var(--text-sec);">
                        <i class="fas fa-check-circle" style="color:var(--green);"></i> يمكنك استخدام ${MAX_DAILY_QUESTIONS} سؤال يومياً
                    </div>
                </div>
            </div>
        </div>`;
}

function showAIHelp() {
    const content = document.getElementById('ai-assistant-content');
    content.innerHTML = `
        <div style="background:var(--bg-card); border-radius:20px; padding:25px;">
            <h3><i class="fas fa-question-circle"></i> كيفية استخدام المساعد الذكي</h3>
            
            <div style="margin-top:20px;">
                <div style="display:flex; align-items:flex-start; gap:15px; margin-bottom:20px;">
                    <div style="background:var(--primary); color:white; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;">1</div>
                    <div>
                        <h4 style="margin:0; color:var(--accent);">اختر خيارات الاختبار</h4>
                        <p style="color:var(--text-sec); margin:5px 0;">عدد الأسئلة وأنواعها</p>
                    </div>
                </div>
                
                <div style="display:flex; align-items:flex-start; gap:15px; margin-bottom:20px;">
                    <div style="background:var(--primary); color:white; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;">2</div>
                    <div>
                        <h4 style="margin:0; color:var(--accent);">أجب على الأسئلة</h4>
                        <p style="color:var(--text-sec); margin:5px 0;">لديك 30 دقيقة للإجابة</p>
                    </div>
                </div>
                
                <div style="display:flex; align-items:flex-start; gap:15px; margin-bottom:20px;">
                    <div style="background:var(--primary); color:white; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;">3</div>
                    <div>
                        <h4 style="margin:0; color:var(--accent);">احصل على التقييم</h4>
                        <p style="color:var(--text-sec); margin:5px 0;">تقييم فوري مع تحليل النتائج</p>
                    </div>
                </div>
                
                <div style="display:flex; align-items:flex-start; gap:15px;">
                    <div style="background:var(--primary); color:white; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold;">4</div>
                    <div>
                        <h4 style="margin:0; color:var(--accent);">تتبع تقدمك</h4>
                        <p style="color:var(--text-sec); margin:5px 0;">عرض إحصائياتك وتحسين أدائك</p>
                    </div>
                </div>
            </div>
            
            <div style="margin-top:30px; padding:15px; background:rgba(59, 130, 246, 0.1); border-radius:10px;">
                <h5 style="color:var(--primary); margin-top:0;"><i class="fas fa-info-circle"></i> معلومات مهمة</h5>
                <ul style="color:var(--text-sec); padding-right:15px;">
                    <li>الحد الأقصى: ${MAX_DAILY_QUESTIONS} سؤال يومياً</li>
                    <li>الاختبارات مجانية تماماً</li>
                    <li>يمكنك إنشاء اختبارات متعددة</li>
                    <li>جميع الإجابات محفوظة في سجلك</li>
                </ul>
            </div>
        </div>`;
}

// ==================== [ 16. بقية الدوال... ] ====================
// [ملاحظة: باقي الدوال مثل renderLiveRooms, renderSubscription, renderProfile, renderAdminPanel
// ستبقى كما هي في الكود الأصلي لأنها تعمل بشكل جيد]

// ==================== [ 17. دوال التنقل ] ====================
function nav(page) {
    console.log('التنقل إلى:', page);
    
    if (navigationHistory[navigationHistory.length - 1] !== page) {
        navigationHistory.push(page);
    }
    
    const titleMap = {
        'home': 'الرئيسية',
        'library': 'المكتبة',
        'upload': 'رفع الملفات',
        'live': 'البث المباشر',
        'subscription': 'الاشتراكات',
        'profile': 'ملفي الشخصي',
        'admin': 'لوحة التحكم',
        'ai_assistant': 'المساعد الذكي'
    };
    
    document.getElementById('head-title').textContent = titleMap[page] || 'الرئيسية';
    
    const subScreens = [
        'upload-screen', 'live-detail-screen', 'create-room-screen', 
        'library-detail-screen', 'quiz-screen', 'quiz-results-screen',
        'payment-screen', 'admin-screen', 'upload-book-screen',
        'ai-assistant-screen', 'book-reader-screen'
    ];
    
    subScreens.forEach(screenId => {
        const screen = document.getElementById(screenId);
        if (screen) {
            screen.classList.add('hidden');
        }
    });
    
    document.getElementById('app-screen').classList.remove('hidden');
    
    switch(page) {
        case 'home':
            renderHome();
            break;
        case 'library':
            renderLibrary();
            break;
        case 'upload':
            renderUploadScreen();
            break;
        case 'live':
            renderLiveRooms();
            break;
        case 'subscription':
            renderSubscription();
            break;
        case 'profile':
            renderProfile();
            break;
        case 'admin':
            renderAdminPanel();
            break;
        case 'ai_assistant':
            renderAIAssistant();
            break;
        default:
            renderHome();
    }
    
    const tabs = document.querySelectorAll('.tab-btn');
    tabs.forEach(tab => {
        if (tab.textContent.includes(titleMap[page] || '')) {
            tab.classList.add('active');
            const icon = tab.querySelector('i');
            if (icon) {
                icon.style.transform = 'translateY(-5px)';
                icon.style.textShadow = '0 0 10px var(--neon-blue)';
            }
        } else {
            tab.classList.remove('active');
            const icon = tab.querySelector('i');
            if (icon) {
                icon.style.transform = 'none';
                icon.style.textShadow = 'none';
            }
        }
    });
}

function highlightTab(element) {
    const tabs = document.querySelectorAll('.tab-btn');
    tabs.forEach(tab => tab.classList.remove('active'));
    element.classList.add('active');
}

// ==================== [ 18. دوال مساعدة عامة ] ====================
function handleBackButton() {
    if (navigationHistory.length > 1) {
        navigationHistory.pop();
        const previousPage = navigationHistory[navigationHistory.length - 1];
        nav(previousPage);
    } else {
        nav('home');
    }
}

function debounceFilter(value) {
    clearTimeout(this.searchTimeout);
    this.searchTimeout = setTimeout(() => {
        if (value.trim()) {
            searchBooks();
        }
    }, 500);
}

function searchBooks() {
    const searchTerm = document.getElementById('store-search').value.trim();
    
    if (!searchTerm) {
        loadBooks();
        return;
    }
    
    const container = document.getElementById('books-container');
    container.innerHTML = `
        <div class="loading">
            <div class="loading-spinner"></div>
            <div>جاري البحث عن "${searchTerm}"...</div>
        </div>`;
    
    setTimeout(() => {
        const filteredBooks = REAL_BOOKS_DATABASE.filter(book => 
            book.title.includes(searchTerm) || 
            book.subject.includes(searchTerm) ||
            book.grade.includes(searchTerm) ||
            book.author.includes(searchTerm)
        );
        
        if (filteredBooks.length === 0) {
            container.innerHTML = `
                <div style="text-align:center; padding:40px; color:var(--text-sec);">
                    <i class="fas fa-search" style="font-size:50px; margin-bottom:15px;"></i>
                    <p>لم يتم العثور على كتب تطابق: "${searchTerm}"</p>
                    <button class="btn-main" onclick="loadBooks()" style="width:auto; margin-top:15px;">
                        <i class="fas fa-arrow-right"></i> عرض جميع الكتب
                    </button>
                </div>`;
        } else {
            displayFilteredBooks(filteredBooks, `نتائج البحث عن "${searchTerm}"`);
        }
    }, 500);
}

function connectToSocket() {
    console.log('✅ محاكاة اتصال بـ WebSocket');
}

function showLoading(message = 'جاري التحميل...') {
    Swal.fire({
        title: message,
        allowOutsideClick: false,
        didOpen: () => {
            Swal.showLoading();
        }
    });
}

function hideLoading() {
    Swal.close();
}

function showAlert(title, text, icon = 'info') {
    Swal.fire({
        title: title,
        text: text,
        icon: icon,
        confirmButtonText: 'موافق'
    });
}

function logout() {
    Swal.fire({
        title: 'تسجيل الخروج',
        text: 'هل تريد تسجيل الخروج؟',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'نعم',
        cancelButtonText: 'لا'
    }).then(async (result) => {
        if (result.isConfirmed) {
            try {
                showLoading('جاري تسجيل الخروج...');
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                hideLoading();
                
                currentUserData = null;
                navigationHistory = ['home'];
                
                document.getElementById('app-screen').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                
                showAlert('نجاح', 'تم تسجيل الخروج بنجاح', 'success');
                
            } catch (error) {
                hideLoading();
                console.error('خطأ في تسجيل الخروج:', error);
                showAlert('خطأ', 'حدث خطأ في تسجيل الخروج', 'error');
            }
        }
    });
}

// ==================== [ 19. الشاشة الرئيسية ] ====================
function renderHome() {
    const area = document.getElementById('content-area');
    const isTeacher = currentUserData && currentUserData.role === 'teacher';
    const isAdmin = currentUserData && currentUserData.role === 'admin';
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); border-radius:20px; padding:25px; color:white; margin-bottom:25px;">
                <h2 style="margin-top:0;"><i class="fas fa-graduation-cap"></i> مرحباً ${currentUserData.name}!</h2>
                <p>منصة التعليم الذكي - كل ما تحتاجه للتعلم في مكان واحد</p>
            </div>
            
            <div class="grid">
                <div class="card" onclick="nav('library')">
                    <i class="fas fa-book"></i>
                    <h3>المكتبة</h3>
                    <p>${REAL_BOOKS_DATABASE.length} كتاب تعليمي</p>
                </div>
                
                <div class="card" onclick="nav('live')">
                    <i class="fas fa-video"></i>
                    <h3>البث المباشر</h3>
                    <p>دروس مباشرة مع أساتذة</p>
                </div>
                
                <div class="card" onclick="nav('upload')">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <h3>رفع الملفات</h3>
                    <p>رفع وتخزين الملفات</p>
                </div>
                
                <div class="card" onclick="nav('ai_assistant')">
                    <i class="fas fa-robot"></i>
                    <h3>المساعد الذكي</h3>
                    <p>اختبارات ذكية</p>
                </div>
                
                <div class="card" onclick="nav('subscription')">
                    <i class="fas fa-crown"></i>
                    <h3>الاشتراك</h3>
                    <p>اشترك الآن</p>
                </div>
                
                <div class="card" onclick="nav('profile')">
                    <i class="fas fa-user"></i>
                    <h3>ملفي</h3>
                    <p>الإعدادات والإحصائيات</p>
                </div>
                
                ${isAdmin ? `
                <div class="card" onclick="renderAdminPanel()">
                    <i class="fas fa-user-shield"></i>
                    <h3>لوحة التحكم</h3>
                    <p>الإدمن</p>
                    <div class="card-badge">إدمن</div>
                </div>
                ` : ''}
                
                ${isTeacher ? `
                <div class="card" onclick="showCreateRoom()">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <h3>إنشاء درس</h3>
                    <p>ابدأ بثاً جديداً</p>
                </div>
                ` : ''}
            </div>
            
            <div style="margin-top:30px;">
                <h3><i class="fas fa-newspaper"></i> آخر التحديثات</h3>
                <div style="background:var(--bg-card); border-radius:15px; padding:20px; margin-top:15px;">
                    <div style="display:flex; gap:15px; align-items:center; margin-bottom:15px;">
                        <div style="background:var(--primary); width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-bullhorn" style="color:white; font-size:20px;"></i>
                        </div>
                        <div>
                            <h4 style="margin:0; color:var(--text-main);">إطلاق المنصة الإصدار 4.0</h4>
                            <p style="margin:5px 0 0; color:var(--text-sec); font-size:14px;">${new Date().toLocaleDateString('ar-SA')}</p>
                        </div>
                    </div>
                    <p style="color:var(--text-main); line-height:1.6;">
                        تم إطلاق النسخة الجديدة من منصة التعليم الذكي مع ${REAL_BOOKS_DATABASE.length} كتاب تعليمي لجميع الصفوف.
                        تم إضافة ميزات جديدة مثل قارئ الكتب، نظام المفضلة المحسّن، والمساعد الذكي.
                    </p>
                </div>
            </div>
        </div>`;
}

// ==================== [ 20. جعل الدوال متاحة عالمياً ] ====================
window.loginUser = loginUser;
window.registerStudent = registerStudent;
window.registerTeacher = registerTeacher;
window.showRegisterOptions = showRegisterOptions;
window.showStudentForm = showStudentForm;
window.showTeacherForm = showTeacherForm;
window.backToLogin = backToLogin;
window.backToRegister = backToRegister;
window.resendVerification = resendVerification;
window.nav = nav;
window.highlightTab = highlightTab;
window.handleBackButton = handleBackButton;
window.showUploadFiles = showUploadFiles;
window.showAdminUploadBook = showAdminUploadBook;
window.handleFileSelect = handleFileSelect;
window.handleBookFileSelect = handleBookFileSelect;
window.removeFile = removeFile;
window.removeBookFile = removeBookFile;
window.uploadFiles = uploadFiles;
window.uploadAdminBook = uploadAdminBook;
window.showMyUploads = showMyUploads;
window.loadBooks = loadBooks;
window.viewBook = viewBook;
window.readBook = readBook;
window.downloadBook = downloadBook;
window.addToFavorites = addToFavorites;
window.showMyBooks = showMyBooks;
window.searchBooks = searchBooks;
window.showCreateRoom = showCreateRoom;
window.submitCreateRoom = submitCreateRoom;
window.joinLiveRoom = joinLiveRoom;
window.backToLiveList = backToLiveList;
window.removeStudentFromRoom = removeStudentFromRoom;
window.startRecording = startRecording;
window.stopRecording = stopRecording;
window.sendChatMessage = sendChatMessage;
window.playRecording = playRecording;
window.downloadRecording = downloadRecording;
window.subscribe = subscribe;
window.generateQuiz = generateQuiz;
window.selectAnswer = selectAnswer;
window.submitQuiz = submitQuiz;
window.backToAI = backToAI;
window.showUserStats = showUserStats;
window.showSubscriptionStatus = showSubscriptionStatus;
window.showSettings = showSettings;
window.changePassword = changePassword;
window.logout = logout;
window.renderAdminPanel = renderAdminPanel;
window.showAdminUsers = showAdminUsers;
window.showAdminPayments = showAdminPayments;
window.showAdminBooks = showAdminBooks;
window.showAdminRooms = showAdminRooms;
window.showLoading = showLoading;
window.hideLoading = hideLoading;
window.showAlert = showAlert;
window.prevPage = prevPage;
window.nextPage = nextPage;
window.increaseFont = increaseFont;
window.decreaseFont = decreaseFont;
window.toggleDarkMode = toggleDarkMode;
window.toggleBookmark = toggleBookmark;
window.backToBookDetail = backToBookDetail;

// ==================== [ 21. Drag & Drop للملفات ] ====================
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('upload-area');
    const adminUploadArea = document.getElementById('admin-upload-area');
    
    function setupDragDrop(element) {
        if (!element) return;
        
        element.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.stopPropagation();
            element.classList.add('dragover');
        });
        
        element.addEventListener('dragleave', function(e) {
            e.preventDefault();
            e.stopPropagation();
            element.classList.remove('dragover');
        });
        
        element.addEventListener('drop', function(e) {
            e.preventDefault();
            e.stopPropagation();
            element.classList.remove('dragover');
            
            const files = Array.from(e.dataTransfer.files);
            
            if (element.id === 'upload-area') {
                if (files.length > 0) {
                    filesToUpload = filesToUpload.concat(files);
                    updateFilePreview();
                }
            } else if (element.id === 'admin-upload-area') {
                if (files.length > 0) {
                    const pdfFiles = files.filter(file => file.type === 'application/pdf');
                    
                    if (pdfFiles.length > 0) {
                        adminBookFile = pdfFiles[0];
                        updateBookPreview();
                    } else {
                        showAlert('خطأ', 'يجب أن يكون الملف بصيغة PDF', 'error');
                    }
                }
            }
        });
    }
    
    setupDragDrop(uploadArea);
    setupDragDrop(adminUploadArea);
});
    // ==================== [ الحل المؤقت لمشكلة إنشاء الاختبار ] ====================
// هذه دالة بديلة تعمل مع البوت الحقيقي مباشرة
window.fixGenerateQuiz = async function() {
    console.log("🔄 استخدام الدالة المعدلة لإنشاء الاختبار...");
    
    try {
        // عرض خيارات الاختبار
        Swal.fire({
            title: 'إنشاء اختبار ذكي',
            html: `
                <div style="text-align:right;">
                    <p>اختر خيارات الاختبار:</p>
                    <input type="number" id="question-count" class="swal2-input" 
                           placeholder="عدد الأسئلة (1-20)" value="10" min="1" max="20">
                    
                    <select id="subject-select" class="swal2-input" style="margin-top:10px;">
                        <option value="الرياضيات">الرياضيات</option>
                        <option value="العلوم">العلوم</option>
                        <option value="اللغة العربية">اللغة العربية</option>
                        <option value="اللغة الإنجليزية">اللغة الإنجليزية</option>
                        <option value="الاجتماعيات">الاجتماعيات</option>
                    </select>
                    
                    <select id="grade-select" class="swal2-input" style="margin-top:10px;">
                        <option value="الأول الابتدائي">الصف الأول الابتدائي</option>
                        <option value="الثاني الابتدائي">الصف الثاني الابتدائي</option>
                        <option value="الثالث الابتدائي">الصف الثالث الابتدائي</option>
                        <option value="الرابع الابتدائي">الصف الرابع الابتدائي</option>
                        <option value="الخامس الابتدائي">الصف الخامس الابتدائي</option>
                        <option value="السادس الابتدائي">الصف السادس الابتدائي</option>
                        <option value="الأول المتوسط">الصف الأول المتوسط</option>
                        <option value="الثاني المتوسط">الصف الثاني المتوسط</option>
                        <option value="الثالث المتوسط">الصف الثالث المتوسط</option>
                        <option value="الأول الثانوي">الصف الأول الثانوي</option>
                        <option value="الثاني الثانوي">الصف الثاني الثانوي</option>
                        <option value="الثالث الثانوي">الصف الثالث الثانوي</option>
                    </select>
                    
                    <select id="question-types" class="swal2-input" multiple style="height:100px; margin-top:10px;">
                        <option value="mcq" selected>أسئلة الاختيار من متعدد</option>
                        <option value="true_false" selected>صح/خطأ</option>
                        <option value="essay">أسئلة مقالية</option>
                    </select>
                    <small>اضغط Ctrl لتحديد أكثر من نوع</small>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'إنشاء الاختبار',
            cancelButtonText: 'إلغاء',
            width: 600,
            preConfirm: () => {
                const questionCount = Swal.getPopup().querySelector('#question-count').value;
                const subject = Swal.getPopup().querySelector('#subject-select').value;
                const grade = Swal.getPopup().querySelector('#grade-select').value;
                const questionTypes = Array.from(Swal.getPopup().querySelector('#question-types').selectedOptions)
                    .map(option => option.value);
                
                if (!questionCount || questionCount < 1 || questionCount > 20) {
                    Swal.showValidationMessage('الرجاء إدخال عدد أسئلة صحيح (1-20)');
                    return false;
                }
                
                if (questionTypes.length === 0) {
                    Swal.showValidationMessage('الرجاء اختيار نوع واحد على الأقل');
                    return false;
                }
                
                return { 
                    questionCount: parseInt(questionCount), 
                    subject: subject,
                    grade: grade,
                    questionTypes: questionTypes
                };
            }
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    showLoading('🔄 جاري الاتصال بخادم الاختبارات الذكية...');
                    
                    // استدعاء البوت الحقيقي
                    const response = await fetch('https://sdm-security-bot.onrender.com/api/ai/generate-quiz', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({
                            subject: result.value.subject,
                            grade: result.value.grade,
                            questionCount: result.value.questionCount,
                            questionTypes: result.value.questionTypes
                        })
                    });
                    
                    const data = await response.json();
                    hideLoading();
                    
                    if (data.success && data.quiz) {
                        console.log("✅ الاختبار أنشئ بنجاح:", data.quiz);
                        
                        // حفظ الاختبار
                        currentQuiz = data.quiz;
                        
                        // عرض الاختبار
                        showQuiz(data.quiz);
                        
                        // إشعار نجاح
                        Swal.fire({
                            title: '✅ نجاح',
                            text: `تم إنشاء اختبار ${data.quiz.title} بـ ${data.quiz.questions.length} سؤال`,
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        
                    } else {
                        console.error("❌ البوت رجع خطأ:", data);
                        showAlert('خطأ من الخادم', data.error || 'فشل إنشاء الاختبار', 'error');
                    }
                    
                } catch (error) {
                    hideLoading();
                    console.error('❌ خطأ في الاتصال:', error);
                    
                    // إذا فشل الاتصال، استخدم اختبار وهمي
                    showAlert('ملاحظة', 
                        'خادم الذكاء الاصطناعي مشغول، جاري استخدام اختبار تجريبي...', 
                        'info'
                    );
                    
                    // إنشاء اختبار وهمي
                    const mockQuiz = {
                        quizId: `quiz_local_${Date.now()}`,
                        title: `اختبار ${result.value.subject} - الصف ${result.value.grade}`,
                        subject: result.value.subject,
                        grade: result.value.grade,
                        questions: [],
                        totalQuestions: result.value.questionCount,
                        timeLimit: 1800,
                        createdAt: Date.now(),
                        source: 'local_mock'
                    };
                    
                    for (let i = 1; i <= result.value.questionCount; i++) {
                        mockQuiz.questions.push({
                            question: `سؤال ${i}: مثال في ${result.value.subject} للصف ${result.value.grade}`,
                            type: 'mcq',
                            options: ['الإجابة الأولى', 'الإجابة الثانية', 'الإجابة الثالثة', 'الإجابة الرابعة'],
                            correctAnswer: Math.floor(Math.random() * 4),
                            explanation: 'هذا مثال للاختبار المحلي'
                        });
                    }
                    
                    currentQuiz = mockQuiz;
                    showQuiz(mockQuiz);
                }
            }
        });
        
    } catch (error) {
        console.error('❌ خطأ غير متوقع:', error);
        showAlert('خطأ', 'حدث خطأ غير متوقع: ' + error.message, 'error');
    }
};

// ==================== [ تحديث زر إنشاء الاختبار لاستخدام الدالة الجديدة ] ====================
document.addEventListener('DOMContentLoaded', function() {
    // انتظر قليلاً حتى يتم تحميل الصفحة
    setTimeout(() => {
        // تحديث زر إنشاء الاختبار في المساعد الذكي
        const aiContent = document.getElementById('ai-assistant-content');
        if (aiContent) {
            aiContent.addEventListener('click', function(e) {
                if (e.target.closest('.card') && e.target.closest('.card').textContent.includes('إنشاء اختبار')) {
                    e.preventDefault();
                    e.stopPropagation();
                    window.fixGenerateQuiz();
                }
            });
        }
        
        // تحديث زر إنشاء الاختبار في الشاشة الرئيسية
        const mainContent = document.getElementById('content-area');
        if (mainContent) {
            mainContent.addEventListener('click', function(e) {
                if (e.target.closest('.card') && e.target.closest('.card').textContent.includes('المساعد الذكي')) {
                    // الانتقال لشاشة المساعد الذكي
                    nav('ai_assistant');
                    setTimeout(() => {
                        // بعد الانتقال، تحديث الزر هناك
                        const aiScreen = document.getElementById('ai-assistant-content');
                        if (aiScreen) {
                            aiScreen.addEventListener('click', function(e2) {
                                if (e2.target.closest('.card') && e2.target.closest('.card').textContent.includes('إنشاء اختبار')) {
                                    e2.preventDefault();
                                    e2.stopPropagation();
                                    window.fixGenerateQuiz();
                                }
                            });
                        }
                    }, 500);
                }
            });
        }
        
        console.log('✅ تم تحميل الإصلاح المؤقت لإنشاء الاختبار');
    }, 1000);
});

// ==================== [ حل بديل: زر طوارئ لإنشاء الاختبار ] ====================
function addEmergencyQuizButton() {
    const emergencyBtn = document.createElement('button');
    emergencyBtn.innerHTML = '🚀 إنشاء اختبار (طوارئ)';
    emergencyBtn.style.cssText = `
        position: fixed;
        bottom: 80px;
        left: 20px;
        background: linear-gradient(90deg, #ff6b6b, #ee5a24);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        font-weight: bold;
        cursor: pointer;
        z-index: 9999;
        box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
    `;
    emergencyBtn.onclick = window.fixGenerateQuiz;
    document.body.appendChild(emergencyBtn);
    
    console.log('✅ تم إضافة زر الطوارئ لإنشاء الاختبار');
}

// إضافة زر الطوارئ عند تحميل الصفحة
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', addEmergencyQuizButton);
} else {
    addEmergencyQuizButton();
}
</script>
</body>
</html>

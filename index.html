<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SDM Market Pro | Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    
    <!-- Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --bg-main: #101419;
            --bg-card: #1e2329;
            --bg-input: #2b3139;
            --primary: #fcd535; 
            --text-white: #eaecef;
            --text-gray: #848e9c;
            --green: #0ecb81; 
            --red: #f6465d; 
            --border: #2b3139;
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Tajawal', sans-serif; 
            margin: 0; 
            background: var(--bg-main); 
            color: var(--text-white); 
            padding-bottom: 50px; 
            overflow-x: hidden; 
            user-select: none;
        }

        /* --- Header --- */
        header { 
            background: var(--bg-card); 
            padding: 12px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--border); 
            position: sticky; top: 0; z-index: 100;
        }
        .logo { font-weight: 800; color: var(--primary); font-size: 18px; letter-spacing: 1px; }
        .bal-badge { background: var(--bg-input); padding: 5px 12px; border-radius: 6px; font-size: 13px; font-weight: bold; border: 1px solid var(--border); }
        .bal-badge span#u-curr { color: var(--primary); margin-right: 3px; }

        /* --- Price Display --- */
        .price-area { text-align: center; padding: 20px 0; background: var(--bg-main); border-bottom: 1px solid var(--border); }
        .big-price { font-size: 36px; font-weight: 800; color: var(--green); margin: 0; letter-spacing: 1px; direction: ltr; }
        .sub-price { font-size: 12px; color: var(--text-gray); margin-top: 5px; }

        /* --- Trade Grid Layout --- */
        .trade-container { display: grid; grid-template-columns: 1.3fr 0.7fr; gap: 4px; margin-top: 5px; }

        /* --- Form Section (Left) --- */
        .trade-form { background: var(--bg-card); padding: 15px; }
        
        .tabs { display: flex; background: var(--bg-main); margin-bottom: 15px; border-radius: 6px; padding: 3px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: var(--text-gray); font-weight: bold; font-size: 14px; border-radius: 4px; transition: 0.2s; }
        .tab.buy.active { background: var(--green); color: white; }
        .tab.sell.active { background: var(--red); color: white; }

        .inp-box { position: relative; margin-bottom: 12px; }
        .inp-box span { position: absolute; left: 12px; top: 13px; font-size: 12px; font-weight: bold; color: var(--text-gray); pointer-events: none; }
        .inp-box label { position: absolute; right: 12px; top: 13px; font-size: 11px; color: var(--text-gray); pointer-events: none; }
        .big-input { width: 100%; background: var(--bg-input); border: 1px solid transparent; padding: 12px 12px 12px 50px; color: white; font-size: 16px; font-weight: bold; border-radius: 6px; text-align: left; height: 48px; transition: 0.2s; direction: ltr; }
        .big-input:focus { border-color: var(--primary); background: #343a40; }

        .pct-btns { display:flex; gap:6px; margin-bottom:15px; }
        .pct-btn { flex:1; background:var(--bg-input); border:1px solid var(--border); color:var(--text-gray); padding:6px; border-radius:4px; font-size:11px; cursor:pointer; transition:0.2s; }
        .pct-btn:hover { background: #343a40; color: white; }

        .btn-submit { width: 100%; padding: 14px; border: none; font-weight: 800; color: white; cursor: pointer; border-radius: 6px; margin-top: 5px; font-size: 16px; transition: 0.2s; }
        .btn-submit:active { transform: scale(0.98); }
        .btn-submit.buy { background: var(--green); box-shadow: 0 4px 12px rgba(14, 203, 129, 0.2); }
        .btn-submit.sell { background: var(--red); box-shadow: 0 4px 12px rgba(246, 70, 93, 0.2); }

        /* --- Order Book (Right) --- */
        .book { background: var(--bg-card); font-size: 11px; border-left: 1px solid var(--border); }
        .book-header { padding: 8px; text-align: center; color: var(--text-gray); font-size: 10px; border-bottom: 1px solid var(--border); }
        .row { display: flex; justify-content: space-between; padding: 4px 8px; cursor: pointer; position: relative; height: 24px; align-items: center; overflow: hidden; }
        .row:hover { background: rgba(255,255,255,0.05); }
        .bar { position: absolute; top:0; right:0; height:100%; opacity: 0.15; transition: width 0.3s; }
        .price-txt { font-family: monospace; font-weight: bold; z-index: 1; }
        .amt-txt { color: white; z-index: 1; opacity: 0.8; }
        
        /* --- My Orders --- */
        .my-orders { margin-top: 5px; background: var(--bg-card); padding: 15px; min-height: 200px; }
        .mo-title { font-size: 13px; font-weight: bold; margin-bottom: 15px; color: var(--text-gray); border-bottom: 1px solid var(--border); padding-bottom: 10px; display:flex; align-items:center; gap:8px; }
        .mo-row { display: flex; justify-content: space-between; align-items: center; background: var(--bg-main); padding: 12px; margin-bottom: 8px; border-radius: 6px; font-size: 12px; border: 1px solid var(--border); }
        .btn-cancel { background: rgba(246, 70, 93, 0.15); color: var(--red); border: 1px solid var(--red); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; }

        /* --- Auth Screen --- */
        #auth-screen { position: fixed; inset: 0; background: var(--bg-main); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .login-btn { margin-top: 20px; padding: 12px 25px; border-radius: 25px; border: none; font-weight: bold; cursor: pointer; background: white; color: black; display: flex; align-items: center; gap: 10px; font-size: 16px; }
        
        .hidden { display: none !important; }
        
        /* Helper for sweetalert dark mode */
        div:where(.swal2-container) div:where(.swal2-popup) { background: #1e2329 !important; color: #fff !important; border: 1px solid #2b3139; }
    </style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="auth-screen">
    <i class="fas fa-chart-line" style="font-size: 60px; color: var(--primary); margin-bottom: 20px;"></i>
    <h2 style="color:var(--primary); margin:0;">SDM MARKET PRO</h2>
    <p style="color:var(--text-gray); margin-top:10px;">Ù…Ù†ØµØ© Ø§Ù„ØªØ¯Ø§ÙˆÙ„ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</p>
    <button class="login-btn" onclick="login()">
        <i class="fab fa-google"></i> ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
    </button>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
<div id="app" class="hidden">
    <header>
        <div class="logo">SDM PRO <i class="fas fa-bolt" style="color:var(--primary); font-size:12px;"></i></div>
        <div class="bal-badge">
            <span id="u-bal">0.00</span> 
            <span id="u-curr">SDM</span>
        </div>
        <div onclick="logout()" style="color:var(--red); font-size:18px; cursor:pointer; margin-right:10px;"><i class="fas fa-sign-out-alt"></i></div>
    </header>

    <div class="price-area">
        <div class="big-price" id="m-price">0.0500</div>
        <div class="sub-price">â‰ˆ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ (SDM)</div>
    </div>

    <div class="trade-container">
        <!-- ÙŠÙ…ÙŠÙ†: Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ -->
        <div class="trade-form">
            <div class="tabs">
                <div id="t-buy" class="tab buy active" onclick="setMode('buy')">Ø´Ø±Ø§Ø¡</div>
                <div id="t-sell" class="tab sell" onclick="setMode('sell')">Ø¨ÙŠØ¹</div>
            </div>

            <div class="inp-box">
                <label>Ø§Ù„Ø³Ø¹Ø±</label><span>SDM</span>
                <input type="number" id="i-price" class="big-input" placeholder="0.0000" step="0.0001">
            </div>
            <div class="inp-box">
                <label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><span>MRK</span>
                <input type="number" id="i-amount" class="big-input" placeholder="0.00">
            </div>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ© -->
            <div class="pct-btns">
                <div class="pct-btn" onclick="setPct(0.25)">25%</div>
                <div class="pct-btn" onclick="setPct(0.50)">50%</div>
                <div class="pct-btn" onclick="setPct(0.75)">75%</div>
                <div class="pct-btn" onclick="setPct(1.00)">100%</div>
            </div>

            <div style="font-size:11px; margin-bottom:10px; color:var(--text-gray); display:flex; justify-content:space-between; align-items:center;">
                <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹:</span>
                <span style="color:white; font-size:14px; font-weight:bold;"><span id="total-txt">0.00</span> SDM</span>
            </div>

            <button id="btn-do" class="btn-submit buy" onclick="placeOrder()">Ø´Ø±Ø§Ø¡ MRK</button>
        </div>

        <!-- ÙŠØ³Ø§Ø±: Ø¯ÙØªØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª -->
        <div class="book">
            <div class="book-header">Ø¯ÙØªØ± Ø§Ù„Ø£ÙˆØ§Ù…Ø± (Order Book)</div>
            
            <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨ÙŠØ¹ (Ø£Ø­Ù…Ø±) - Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£Ø¹Ù„Ù‰ -->
            <div id="asks" style="height:140px; overflow:hidden; display:flex; flex-direction:column-reverse; border-bottom: 1px solid var(--border);"></div>
            
            <div style="text-align:center; padding:4px; color:var(--primary); font-weight:bold; font-size:12px; background:rgba(252, 213, 53, 0.1);">Spread</div>
            
            <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡ (Ø£Ø®Ø¶Ø±) - Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£Ø¹Ù„Ù‰ -->
            <div id="bids" style="height:140px; overflow:hidden;"></div>
        </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø·Ù„Ø¨Ø§ØªÙŠ -->
    <div class="my-orders">
        <div class="mo-title">
            <i class="fas fa-list-alt" style="color:var(--primary)"></i> 
            Ø·Ù„Ø¨Ø§ØªÙŠ Ø§Ù„Ù…ÙØªÙˆØ­Ø©
        </div>
        <div id="my-orders-list">
            <div style="text-align:center; color:var(--text-gray); padding:20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
    </div>

</div>

<script>
    // --- 1. Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyAI_mUhuPNoO-XC0Q-VNoWft8UWFbAbIGg",
      authDomain: "sudan-market-6b122.firebaseapp.com",
      databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com",
      projectId: "sudan-market-6b122",
      storageBucket: "sudan-market-6b122.firebasestorage.app",
      messagingSenderId: "66729481566",
      appId: "1:66729481566:web:93393f28dc22d32cceebcf"
    };
    
    // Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // --- 2. Variables & State ---
    let user = null;
    let mode = 'buy';
    let marketPrice = 0.05;
    const OPENING_PRICE = 0.05;

    // --- 3. Auth Logic ---
    function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e => Swal.fire('Ø®Ø·Ø£', e.message, 'error')); }
    function logout() { auth.signOut().then(() => location.reload()); }

    auth.onAuthStateChanged(u => {
        if(u) {
            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            db.ref('users/'+u.uid).on('value', s => {
                if(s.exists()){
                    user = s.val();
                    user.uid = u.uid;
                    updateUI();
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('app').classList.remove('hidden');
                } else {
                    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯
                    const newUser = {
                        n: u.displayName,
                        email: u.email,
                        pic: u.photoURL,
                        sdmBalance: 0,
                        mrkBalance: 0,
                        createdAt: Date.now()
                    };
                    db.ref('users/'+u.uid).set(newUser);
                }
            });
            initMarket();
        } else {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }
    });

    // --- 4. UI Functions ---
    function setMode(m) {
        mode = m;
        document.getElementById('t-buy').classList.toggle('active', m==='buy');
        document.getElementById('t-sell').classList.toggle('active', m==='sell');
        
        const btn = document.getElementById('btn-do');
        btn.innerText = m==='buy' ? 'Ø´Ø±Ø§Ø¡ MRK' : 'Ø¨ÙŠØ¹ MRK';
        btn.className = `btn-submit ${m}`;
        
        updateUI();
    }

    function updateUI() {
        if(!user) return;
        const bal = mode==='buy' ? (user.sdmBalance || 0) : (user.mrkBalance || 0);
        const curr = mode==='buy' ? 'SDM' : 'MRK';
        
        document.getElementById('u-bal').innerText = bal.toFixed(2);
        document.getElementById('u-curr').innerText = curr;
        calc();
    }

    // Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø©
    document.getElementById('i-price').addEventListener('input', calc);
    document.getElementById('i-amount').addEventListener('input', calc);

    function calc() {
        const p = parseFloat(document.getElementById('i-price').value)||0;
        const a = parseFloat(document.getElementById('i-amount').value)||0;
        document.getElementById('total-txt').innerText = (p*a).toFixed(2);
    }

    function setPct(p) {
        if(!user) return;
        const price = parseFloat(document.getElementById('i-price').value) || marketPrice;
        if(price <= 0) return;

        if(mode==='buy') {
            const bal = user.sdmBalance || 0;
            document.getElementById('i-amount').value = ((bal * p) / price).toFixed(4);
        } else {
            const bal = user.mrkBalance || 0;
            document.getElementById('i-amount').value = (bal * p).toFixed(4);
        }
        calc();
    }

    // --- 5. Trading Core (The Engine) ---

    // Ø£) ÙˆØ¶Ø¹ Ø§Ù„Ø·Ù„Ø¨
    function placeOrder() {
        if(!user) return;
        const price = parseFloat(document.getElementById('i-price').value);
        const amount = parseFloat(document.getElementById('i-amount').value);
        
        if(!price || !amount || price <= 0 || amount <= 0) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø£Ø¯Ø®Ù„ Ø£Ø±Ù‚Ø§Ù… ØµØ­ÙŠØ­Ø©', 'warning');

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØ§Ù„Ø®ØµÙ… (Ø§Ù„ØªØ¬Ù…ÙŠØ¯)
        if(mode === 'buy') {
            const total = price * amount;
            if((user.sdmBalance || 0) < total) return Swal.fire('Ø®Ø·Ø£','Ø±ØµÙŠØ¯ SDM ØºÙŠØ± ÙƒØ§ÙÙŠ','error');
            // Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯
            db.ref(`users/${user.uid}/sdmBalance`).set((user.sdmBalance || 0) - total);
        } else {
            if((user.mrkBalance || 0) < amount) return Swal.fire('Ø®Ø·Ø£','Ø±ØµÙŠØ¯ MRK ØºÙŠØ± ÙƒØ§ÙÙŠ','error');
            // Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯
            db.ref(`users/${user.uid}/mrkBalance`).set((user.mrkBalance || 0) - amount);
        }

        const orderData = {
            uid: user.uid,
            price: price,
            amount: amount,
            timestamp: firebase.database.ServerValue.TIMESTAMP
        };

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const ref = db.ref(`market/orders/${mode}`).push();
        ref.set(orderData).then(() => {
            document.getElementById('i-amount').value = '';
            calc();
            
            Swal.fire({
                icon:'success', 
                title: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨', 
                toast: true, position: 'top-end', 
                showConfirmButton: false, timer: 2000,
                background: '#1e2329', color: '#fff'
            });

            // ØªØ´ØºÙŠÙ„ Ù…Ø­Ø±Ùƒ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© ÙÙˆØ±Ø§Ù‹
            runMatchingEngine(mode, ref.key, { ...orderData, price, amount }); // Passing clean numbers
        });
    }

    // Ø¨) Ù…Ø­Ø±Ùƒ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© (Ù…Ø¨Ø³Ø· ÙŠØ¹Ù…Ù„ Ù…Ù† Ø¬Ø§Ù†Ø¨ Ø§Ù„Ø¹Ù…ÙŠÙ„)
    function runMatchingEngine(type, myOrderKey, myOrder) {
        const oppositeType = type === 'buy' ? 'sell' : 'buy';
        
        // Ø¬Ù„Ø¨ Ø£ÙØ¶Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹ÙƒØ³ÙŠØ©
        db.ref(`market/orders/${oppositeType}`).once('value', snap => {
            let executed = false;
            
            snap.forEach(child => {
                if(executed) return; // Ù†Ù†ÙØ° ØµÙÙ‚Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙŠ ÙƒÙ„ Ù…Ø±Ø© Ù„Ù„ØªØ¨Ø³ÙŠØ·
                
                const matchOrder = child.val();
                const matchKey = child.key;

                // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©:
                // Ø´Ø±Ø§Ø¡: Ø³Ø¹Ø±ÙŠ >= Ø³Ø¹Ø± Ø§Ù„Ø¨Ø§Ø¦Ø¹ (Ø£Ù†Ø§ Ù…Ø³ØªØ¹Ø¯ Ø£Ø¯ÙØ¹ Ø£ÙƒØ«Ø± Ø£Ùˆ ÙŠØ³Ø§ÙˆÙŠ Ø·Ù„Ø¨Ù‡)
                // Ø¨ÙŠØ¹: Ø³Ø¹Ø±ÙŠ <= Ø³Ø¹Ø± Ø§Ù„Ù…Ø´ØªØ±ÙŠ (Ø£Ù†Ø§ Ù…Ø³ØªØ¹Ø¯ Ø£Ø¨ÙŠØ¹ Ø¨Ø£Ù‚Ù„ Ø£Ùˆ ÙŠØ³Ø§ÙˆÙŠ Ø·Ù„Ø¨Ù‡)
                const isMatch = (type === 'buy' && myOrder.price >= matchOrder.price) || 
                                (type === 'sell' && myOrder.price <= matchOrder.price);

                if (isMatch) {
                    executed = true;
                    // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠ Ù‡Ùˆ Ø³Ø¹Ø± Ø§Ù„Ø·Ø±Ù Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚ (Maker)
                    const tradePrice = matchOrder.price; 
                    const tradeAmount = Math.min(myOrder.amount, matchOrder.amount); 

                    // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±ØµØ¯Ø© (Ù„ÙŠ ÙˆÙ„Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±)
                    // ØªÙ†Ø¨ÙŠÙ‡: Ù‡Ø°Ø§ Ù…Ø¬Ø±Ø¯ Ù…Ø­Ø§ÙƒØ§Ø©ØŒ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ ÙŠÙØ¶Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Cloud Functions Ù„Ù„Ø£Ù…Ø§Ù†
                    
                    // ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ÙŠ (Ø£Ù†Ø§ Ø§Ù„Ù€ Taker)
                    if(type === 'buy') {
                        // Ø§Ø´ØªØ±ÙŠØª -> Ø§Ø³ØªÙ„Ù… MRK + Ø§Ù„ÙØ±Ù‚ ÙÙŠ Ø§Ù„Ø³Ø¹Ø± Ø¥Ø°Ø§ ÙˆØ¬Ø¯
                        const cost = tradeAmount * tradePrice;
                        const initialLock = tradeAmount * myOrder.price;
                        const refund = initialLock - cost; // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„ÙØ±Ù‚
                        
                        db.ref(`users/${user.uid}/mrkBalance`).transaction(v => (v||0) + tradeAmount);
                        if(refund > 0) db.ref(`users/${user.uid}/sdmBalance`).transaction(v => (v||0) + refund);

                    } else {
                        // Ø¨Ø¹Øª -> Ø§Ø³ØªÙ„Ù… SDM
                        const earn = tradeAmount * tradePrice;
                        db.ref(`users/${user.uid}/sdmBalance`).transaction(v => (v||0) + earn);
                    }

                    // ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± (Maker) - Ù†Ø­ØªØ§Ø¬ ØµÙ„Ø§Ø­ÙŠØ§ØªØŒ Ù‡Ù†Ø§ Ù†ÙØªØ±Ø¶ Ù†Ø¬Ø§Ø­Ù‡ Ù„Ù„ØªØ¬Ø±Ø¨Ø©
                    db.ref(`users/${matchOrder.uid}`).once('value', s => {
                        const maker = s.val();
                        if(oppositeType === 'sell') { // Ù‡Ùˆ ÙƒØ§Ù† ÙŠØ¨ÙŠØ¹
                             // Ù‡Ùˆ ÙŠØ³ØªÙ„Ù… SDM
                             db.ref(`users/${matchOrder.uid}/sdmBalance`).transaction(v => (v||0) + (tradeAmount * tradePrice));
                        } else { // Ù‡Ùˆ ÙƒØ§Ù† ÙŠØ´ØªØ±ÙŠ
                             // Ù‡Ùˆ ÙŠØ³ØªÙ„Ù… MRK
                             db.ref(`users/${matchOrder.uid}/mrkBalance`).transaction(v => (v||0) + tradeAmount);
                        }
                    });

                    // 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø­Ø°Ù Ø§Ù„Ù…ÙƒØªÙ…Ù„)
                    // Ù„Ù„ØªØ¨Ø³ÙŠØ· Ø³Ù†Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ÙŠÙ†ØŒ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ·ÙˆÙŠØ±Ù‡ Ù„Ø®ØµÙ… Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©
                    db.ref(`market/orders/${type}/${myOrderKey}`).remove();
                    db.ref(`market/orders/${oppositeType}/${matchKey}`).remove();

                    // 3. ØªØ­Ø¯ÙŠØ« Ø³Ø¹Ø± Ø§Ù„Ø³ÙˆÙ‚
                    db.ref('market/stats/lastPrice').set(tradePrice);

                    // Ø¥Ø´Ø¹Ø§Ø±
                    Swal.fire({
                        title: 'ØªÙ…Øª Ø§Ù„ØµÙÙ‚Ø©! ğŸš€',
                        text: `ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° Ø¨Ø³Ø¹Ø± ${tradePrice}`,
                        icon: 'success',
                        background: '#1e2329', color: '#fff'
                    });
                }
            });
        });
    }

    // Ø¬) Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨
    function cancelOrder(type, key, price, amount) {
        Swal.fire({
            title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
            text: "Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø±ØµÙŠØ¯",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ù„ØºØ§Ø¡',
            cancelButtonText: 'ØªØ±Ø§Ø¬Ø¹',
            background: '#1e2329', color: '#fff'
        }).then((result) => {
            if (result.isConfirmed) {
                db.ref(`market/orders/${type}/${key}`).remove().then(() => {
                    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­Ø¬ÙˆØ²
                    if(type === 'buy') {
                        db.ref(`users/${user.uid}/sdmBalance`).transaction(v => (v||0) + (price * amount));
                    } else {
                        db.ref(`users/${user.uid}/mrkBalance`).transaction(v => (v||0) + amount);
                    }
                    Swal.fire({title:'ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡', icon:'success', toast:true, position:'top', showConfirmButton:false, timer:1500, background:'#1e2329', color:'#fff'});
                });
            }
        })
    }

    // --- 6. Data Listeners ---
    function initMarket() {
        // Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
        db.ref('market/stats/lastPrice').on('value', s => {
            marketPrice = s.val() || OPENING_PRICE;
            document.getElementById('m-price').innerText = marketPrice.toFixed(4);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆÙ† Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø±
            const el = document.getElementById('m-price');
            el.style.color = 'var(--green)'; // ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù„ÙˆÙ†
            
            // Ù…Ù„Ø¡ Ø§Ù„Ø³Ø¹Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹
            const inp = document.getElementById('i-price');
            if(!inp.value) inp.value = marketPrice.toFixed(4);
        });

        // Ù…Ø±Ø§Ù‚Ø¨Ø© "Ø·Ù„Ø¨Ø§ØªÙŠ"
        function loadMyOrders() {
            const list = document.getElementById('my-orders-list');
            
            // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø±Ø³Ù… ØµÙ
            const renderRow = (snap, t) => {
                if(document.getElementById(`ord-${snap.key}`)) return; // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
                
                const o = snap.val();
                const color = t==='buy' ? 'var(--green)' : 'var(--red)';
                const typeTxt = t==='buy' ? 'Ø´Ø±Ø§Ø¡' : 'Ø¨ÙŠØ¹';
                
                const html = `
                <div id="ord-${snap.key}" class="mo-row" style="border-right:4px solid ${color}">
                    <div>
                        <div style="font-weight:bold; font-size:13px; margin-bottom:2px;">
                            <span style="color:${color}">${typeTxt}</span> 
                            <span>${o.amount} MRK</span>
                        </div>
                        <div style="color:var(--text-gray); font-size:11px;">
                            Ø¨Ø³Ø¹Ø± ${o.price} | Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${(o.price*o.amount).toFixed(2)}
                        </div>
                    </div>
                    <button class="btn-cancel" onclick="cancelOrder('${t}', '${snap.key}', ${o.price}, ${o.amount})">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>`;
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ±
                list.insertAdjacentHTML('afterbegin', html);
                
                // Ø¥Ø®ÙØ§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
                const loading = list.querySelector('div[style*="text-align:center"]');
                if(loading) loading.style.display = 'none';
            };

            // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹
            ['buy', 'sell'].forEach(t => {
                db.ref(`market/orders/${t}`).orderByChild('uid').equalTo(user.uid).on('child_added', s => renderRow(s, t));
                db.ref(`market/orders/${t}`).on('child_removed', s => {
                    const el = document.getElementById(`ord-${s.key}`);
                    if(el) el.remove();
                });
            });
        }
        if(user) loadMyOrders();

        // Order Book (Asks - Sell Orders) - Ø§Ù„Ø£Ø­Ù…Ø±
        db.ref('market/orders/sell').orderByChild('price').limitToFirst(7).on('value', snap => {
            const d = document.getElementById('asks'); d.innerHTML = "";
            snap.forEach(c => {
                const o = c.val();
                // Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¹ÙƒØ³ÙŠ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¨ÙŠØ¹ (Ø§Ù„Ø£Ø±Ø®Øµ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„)
                d.insertAdjacentHTML('afterbegin', `
                <div class="row" onclick="fill(${o.price})">
                    <div class="bar" style="background:var(--red); width:${Math.min(o.amount*10, 100)}%"></div>
                    <span class="price-txt" style="color:var(--red);">${o.price.toFixed(4)}</span>
                    <span class="amt-txt">${o.amount.toFixed(2)}</span>
                </div>`);
            });
        });

        // Order Book (Bids - Buy Orders) - Ø§Ù„Ø£Ø®Ø¶Ø±
        db.ref('market/orders/buy').orderByChild('price').limitToLast(7).on('value', snap => {
            const d = document.getElementById('bids'); d.innerHTML = "";
            let arr = []; 
            snap.forEach(c => arr.push(c.val()));
            // Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ (Ø§Ù„Ø£ØºÙ„Ù‰ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰)
            arr.reverse().forEach(o => {
                d.innerHTML += `
                <div class="row" onclick="fill(${o.price})">
                    <div class="bar" style="background:var(--green); width:${Math.min(o.amount*10, 100)}%"></div>
                    <span class="price-txt" style="color:var(--green);">${o.price.toFixed(4)}</span>
                    <span class="amt-txt">${o.amount.toFixed(2)}</span>
                </div>`;
            });
        });
    }

    function fill(p) { 
        document.getElementById('i-price').value = p; 
        calc(); 
    }
</script>
</body>
</html>

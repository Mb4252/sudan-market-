<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SDM Pro Real-Time Exchange</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;800&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-global: #0b0e11;
            --bg-card: #181a20;
            --primary: #fcd535;
            --up: #0ecb81;
            --down: #f6465d;
            --text-main: #eaecef;
            --text-sec: #848e9c;
            --border: #2b3139;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            margin: 0; background: var(--bg-global); color: var(--text-main);
            overflow-x: hidden; user-select: none;
        }

        .hidden { display: none !important; }

        /* --- شاشة الدخول مع حركة العملة --- */
        #auth-screen {
            background: radial-gradient(circle at top, #1e293b, #0f172a);
            height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        .sdm-logo-animated {
            width: 100px; height: 100px; border-radius: 50%;
            border: 3px solid var(--primary); padding: 5px;
            box-shadow: 0 0 30px rgba(252, 213, 53, 0.4);
            animation: float 3s ease-in-out infinite; /* هنا كود الحركة */
            object-fit: cover;
            margin-bottom: 25px;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
            100% { transform: translateY(0px); }
        }

        .btn-google {
            width: 100%; max-width: 300px; padding: 15px; border-radius: 12px;
            border: none; background: white; color: black; font-weight: bold;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        /* --- الهيدر وواجهة التداول --- */
        .pro-header {
            background: var(--bg-card); padding: 12px 15px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index: 100;
        }

        .ticker-bar { display: flex; gap: 20px; padding: 10px 15px; background: var(--bg-card); border-bottom: 1px solid var(--border); overflow-x: auto; }
        .ticker-item { font-size: 11px; color: var(--text-sec); }
        .ticker-item b { display: block; font-size: 14px; color: var(--text-main); }

        .trading-layout { display: grid; grid-template-columns: 1fr 1.2fr; gap: 1px; background: var(--border); }
        .pane { background: var(--bg-global); padding: 10px; }

        /* سجل الطلبات */
        .order-book { font-family: 'Roboto', sans-serif; font-size: 11px; height: 380px; overflow: hidden; }
        .ob-row { display: flex; justify-content: space-between; padding: 4px 0; position: relative; cursor: pointer; }
        .ob-bg { position: absolute; right: 0; top: 0; height: 100%; opacity: 0.2; }

        /* لوحة التحكم */
        .input-group { background: #2b313a; border-radius: 4px; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .input-group input { background: transparent; border: none; color: white; width: 60%; outline: none; font-weight: bold; font-size: 15px; }
        .input-group label { color: var(--text-sec); font-size: 12px; }

        .side-btn { flex: 1; padding: 12px; border: none; font-weight: bold; cursor: pointer; background: var(--border); color: var(--text-sec); border-radius: 4px; }
        .active-buy { background: var(--up) !important; color: white !important; }
        .active-sell { background: var(--down) !important; color: white !important; }

        .btn-execute { width: 100%; padding: 15px; border: none; border-radius: 4px; font-weight: 800; font-size: 16px; cursor: pointer; margin-top: 10px; }

        /* ناف بار سفلي */
        .nav-bar {
            position: fixed; bottom: 0; width: 100%; background: var(--bg-card);
            display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid var(--border);
        }
        .nav-item { color: var(--text-sec); text-align: center; font-size: 11px; flex: 1; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 4px; }
    </style>
</head>
<body>

<!-- شاشة الدخول المحدثة -->
<div id="auth-screen">
    <img src="https://cdn-icons-png.flaticon.com/512/5501/5501360.png" class="sdm-logo-animated">
    <h1 style="color:var(--primary); margin:0; letter-spacing: 2px; font-weight: 800;">SDM PRO</h1>
    <p style="color:var(--text-sec); margin-bottom: 40px;">المنصة الاحترافية للتداول الفوري</p>
    
    <button class="btn-google" onclick="loginWithGoogle()">
        <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20">
        الدخول بواسطة Google
    </button>
</div>

<!-- التطبيق الرئيسي -->
<div id="app-screen" class="hidden">
    <header class="pro-header">
        <div style="display:flex; align-items:center; gap:10px;">
            <i class="fas fa-bars" style="color:var(--text-sec)"></i>
            <b id="pair-display" style="font-size:18px;">MRK / SDM</b>
        </div>
        <div style="background:rgba(252, 213, 53, 0.1); color:var(--primary); padding:5px 12px; border-radius:5px; font-weight:bold; font-size:13px;">
            <span id="header-sdm">0.00</span> SDM
        </div>
    </header>

    <!-- محتوى التداول -->
    <div id="view-trade">
        <div class="ticker-bar">
            <div class="ticker-item"><small>السعر الحالي</small><b id="last-price" class="price-up">0.0000</b></div>
            <div class="ticker-item"><small>أعلى 24h</small><b id="high-24">0.00</b></div>
            <div class="ticker-item"><small>أدنى 24h</small><b id="low-24">0.00</b></div>
        </div>

        <div id="tradingview-chart" style="height:250px;"></div>

        <div class="trading-layout">
            <!-- سجل الطلبات (حقيقي 100%) -->
            <div class="pane order-book">
                <div style="display:flex; justify-content:space-between; color:var(--text-sec); margin-bottom:8px;">
                    <span>السعر</span><span>الكمية</span>
                </div>
                <div id="asks-container"></div>
                <div id="current-price-center" style="text-align:center; padding:12px; font-weight:800; font-size:18px; color:var(--text-main); border: 1px solid #222; margin: 5px 0;">0.0000</div>
                <div id="bids-container"></div>
            </div>

            <!-- لوحة التنفيذ -->
            <div class="pane">
                <div style="display:flex; gap:5px; margin-bottom:15px;">
                    <button class="side-btn active-buy" id="btn-buy" onclick="setSide('buy')">شراء</button>
                    <button class="side-btn" id="btn-sell" onclick="setSide('sell')">بيع</button>
                </div>

                <div class="input-group"><label>السعر</label><input type="number" id="order-price" step="0.0001"></div>
                <div class="input-group"><label>الكمية</label><input type="number" id="order-qty" step="0.01" oninput="calcTotal()"></div>
                
                <div style="font-size:12px; margin-bottom:15px; color:var(--text-sec);">
                    الإجمالي: <b id="total-cost" style="color:white">0.00</b> SDM
                </div>

                <button class="btn-execute" id="btn-exec" style="background:var(--up); color:white;" onclick="handlePlaceOrder()">شراء MRK</button>
                
                <div style="margin-top:15px; font-size:11px; color:var(--text-sec); text-align:center;">
                    متاح: <span id="avail-balance" style="color:var(--primary)">0.00 SDM</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ناف بار -->
    <div class="nav-bar">
        <div class="nav-item active"><i class="fas fa-exchange-alt"></i>تداول</div>
        <div class="nav-item" onclick="Swal.fire('قريباً','ستتوفر قائمة الأسواق لاحقاً','info')"><i class="fas fa-list"></i>الأسواق</div>
        <div class="nav-item" onclick="location.reload()"><i class="fas fa-wallet"></i>المحفظة</div>
    </div>
</div>

<script>
    // تكوين Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAI_mUhuPNoO-XC0Q-VNoWft8UWFbAbIGg",
      authDomain: "sudan-market-6b122.firebaseapp.com",
      databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com",
      projectId: "sudan-market-6b122",
      storageBucket: "sudan-market-6b122.firebasestorage.app",
      messagingSenderId: "66729481566",
      appId: "1:66729481566:web:93393f28dc22d32cceebcf"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let me = null;
    let curSide = 'buy';
    let curPair = 'MRK_SDM';
    let chart = null;

    // --- نظام الدخول ---
    auth.onAuthStateChanged(user => {
        if (user) {
            db.ref('users/' + user.uid).on('value', snap => {
                me = snap.val();
                if (!me) {
                    me = { uid: user.uid, n: user.displayName, sdm: 1000, mrk: 0 };
                    db.ref('users/' + user.uid).set(me);
                }
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                initTrading();
            });
        }
    });

    function loginWithGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }

    function initTrading() {
        updateBalances();
        listenToMarketData();
        listenToOrderBook();
        renderChart();
    }

    function updateBalances() {
        document.getElementById('header-sdm').innerText = me.sdm.toFixed(2);
        const avail = document.getElementById('avail-balance');
        avail.innerText = curSide === 'buy' ? `${me.sdm.toFixed(2)} SDM` : `${(me.mrk || 0).toFixed(4)} MRK`;
    }

    // --- المحرك المالي ---
    function listenToMarketData() {
        db.ref('market_pairs/' + curPair).on('value', snap => {
            const data = snap.val() || { price: 1.0, high: 1.0, low: 1.0 };
            document.getElementById('last-price').innerText = data.price.toFixed(4);
            document.getElementById('current-price-center').innerText = data.price.toFixed(4);
            document.getElementById('high-24').innerText = data.high.toFixed(4);
            document.getElementById('low-24').innerText = data.low.toFixed(4);
            if(!document.getElementById('order-price').value) document.getElementById('order-price').value = data.price;
        });
    }

    function listenToOrderBook() {
        // البيع
        db.ref('orders/'+curPair+'/sell').orderByChild('price').limitToLast(12).on('value', snap => {
            const container = document.getElementById('asks-container');
            container.innerHTML = "";
            let orders = [];
            snap.forEach(c => orders.unshift(c.val()));
            orders.forEach(o => {
                container.innerHTML += `<div class="ob-row" onclick="fillPrice(${o.price})">
                    <div class="ob-bg" style="width:${o.qty*10}%; background:var(--down)"></div>
                    <span style="color:var(--down)">${o.price.toFixed(4)}</span><span>${o.qty.toFixed(2)}</span>
                </div>`;
            });
        });
        // الشراء
        db.ref('orders/'+curPair+'/buy').orderByChild('price').limitToLast(12).on('value', snap => {
            const container = document.getElementById('bids-container');
            container.innerHTML = "";
            snap.forEach(c => {
                const o = c.val();
                container.innerHTML = `<div class="ob-row" onclick="fillPrice(${o.price})">
                    <div class="ob-bg" style="width:${o.qty*10}%; background:var(--up)"></div>
                    <span style="color:var(--up)">${o.price.toFixed(4)}</span><span>${o.qty.toFixed(2)}</span>
                </div>` + container.innerHTML;
            });
        });
    }

    async function handlePlaceOrder() {
        const price = parseFloat(document.getElementById('order-price').value);
        const qty = parseFloat(document.getElementById('order-qty').value);
        if(!price || !qty || qty <= 0) return;

        if(curSide === 'buy' && me.sdm < (price*qty)) return Swal.fire('خطأ','رصيدك لا يكفي','error');
        if(curSide === 'sell' && (me.mrk||0) < qty) return Swal.fire('خطأ','رصيد العملة لا يكفي','error');

        // محاولة المطابقة
        const oppSide = curSide === 'buy' ? 'sell' : 'buy';
        const snap = await db.ref(`orders/${curPair}/${oppSide}`).orderByChild('price').once('value');
        
        let remQty = qty;
        snap.forEach(child => {
            const order = child.val();
            const canMatch = curSide === 'buy' ? (price >= order.price) : (price <= order.price);
            
            if(canMatch && remQty > 0) {
                const matchQty = Math.min(remQty, order.qty);
                processMatch(order.uid, me.uid, order.price, matchQty);
                remQty -= matchQty;
                if(matchQty >= order.qty) child.ref.remove();
                else child.ref.update({ qty: order.qty - matchQty });
            }
        });

        if(remQty > 0) {
            db.ref(`orders/${curPair}/${curSide}`).push({ uid: me.uid, price: price, qty: remQty, time: Date.now() });
            Swal.fire('تم','طلبك الآن في سجل الطلبات','success');
        } else {
            Swal.fire('تم التنفيذ','تمت مطابقة طلبك بالكامل','success');
        }
    }

    function processMatch(sellerId, buyerId, price, qty) {
        const total = price * qty;
        // تحديث الأرصدة والسعر والشارت
        db.ref('users/'+sellerId).transaction(u => { if(u){ u.sdm+=total; u.mrk-=qty; } return u; });
        db.ref('users/'+buyerId).transaction(u => { if(u){ u.sdm-=total; u.mrk=(u.mrk||0)+qty; } return u; });
        db.ref('market_pairs/'+curPair).transaction(m => { if(m){ m.price=price; m.high=Math.max(m.high,price); m.low=Math.min(m.low,price); } return m; });
        
        const now = Math.floor(Date.now()/60000)*60000;
        db.ref('candles/'+curPair+'/'+now).transaction(c => {
            if(!c) return { t: now, o: price, h: price, l: price, c: price };
            c.h = Math.max(c.h, price); c.l = Math.min(c.l, price); c.c = price; return c;
        });
    }

    // --- الشارت ---
    function renderChart() {
        const options = {
            series: [{ data: [] }],
            chart: { type: 'candlestick', height: 250, toolbar: {show:false}, background: 'transparent' },
            theme: { mode: 'dark' },
            xaxis: { type: 'datetime' }
        };
        chart = new ApexCharts(document.querySelector("#tradingview-chart"), options);
        chart.render();
        db.ref('candles/'+curPair).limitToLast(30).on('value', snap => {
            let data = [];
            snap.forEach(c => { const v = c.val(); data.push({x: v.t, y:[v.o, v.h, v.l, v.c]}); });
            chart.updateSeries([{ data: data }]);
        });
    }

    function setSide(s) {
        curSide = s;
        document.getElementById('btn-buy').className = `side-btn ${s==='buy'?'active-buy':''}`;
        document.getElementById('btn-sell').className = `side-btn ${s==='sell'?'active-sell':''}`;
        document.getElementById('btn-exec').style.background = s === 'buy' ? 'var(--up)' : 'var(--down)';
        document.getElementById('btn-exec').innerText = s === 'buy' ? 'شراء MRK' : 'بيع MRK';
        updateBalances();
    }

    function calcTotal() {
        const p = parseFloat(document.getElementById('order-price').value) || 0;
        const q = parseFloat(document.getElementById('order-qty').value) || 0;
        document.getElementById('total-cost').innerText = (p*q).toFixed(2);
    }

    function fillPrice(p) { document.getElementById('order-price').value = p; calcTotal(); }
</script>

</body>
</html>

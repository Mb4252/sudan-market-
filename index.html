<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SDM Market Secure | Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø¢Ù…Ù†</title>
    
    <!-- Ø®Ø·ÙˆØ· Ø¹Ø±Ø¨ÙŠØ© -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
    
    <!-- OneSignal -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({ appId: "74a3085c-32b9-4c35-bc32-e67c3a2506c3" });
      });
    </script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- UI Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.95);
            --primary: #3b82f6;
            --accent: #f59e0b;
            --neon-blue: #00f3ff;
            --text-main: #f8fafc;
            --text-sec: #94a3b8;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --red: #ef4444; 
            --green: #10b981; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline:none; }
        
        body {
            font-family: 'Tajawal', sans-serif; 
            margin: 0;
            background: radial-gradient(circle at top, #1e293b, #0f172a); 
            color: var(--text-main);
            padding-bottom: 90px;
            min-height: 100vh;
            user-select: none;
            overflow-x: hidden;
        }

        .hidden { display: none !important; }
        .search-hidden { display: none !important; }

        /* Offline Guard */
        #offline-guard {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.98); z-index: 99999;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center; backdrop-filter: blur(15px);
        }

        /* Header */
        header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            padding: 15px 20px;
            position: sticky; top: 0; z-index: 1000;
            border-bottom: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 10px;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        
        /* Search */
        .search-container { position: relative; width: 100%; }
        .search-container input {
            width: 100%; padding: 12px 45px 12px 15px;
            border-radius: 15px; border: 1px solid var(--border);
            font-size: 14px; background: var(--glass); color: white;
            font-family: 'Tajawal';
        }
        .search-container i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--accent); }

        /* Posts */
        .post { background: var(--bg-card); margin: 15px; border-radius: 20px; overflow: hidden; border: 1px solid var(--border); position: relative; }
        .post-img-container { height: 220px; position: relative; }
        .sold-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); color: var(--red); display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: bold; z-index: 5; }
        
        .post-options-btn {
            position: absolute; top: 10px; left: 10px;
            background: rgba(0,0,0,0.5); color: white;
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 10;
        }

        .post-date { font-size: 10px; color: var(--text-sec); margin-top: 5px; }

        /* Grid */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; }
        .card { background: var(--bg-card); border-radius: 18px; padding: 20px; text-align: center; border: 1px solid var(--border); transition: 0.3s; position: relative; }

        /* Bottom Navigation */
        .bottom-tabs { position: fixed; bottom: 20px; left: 20px; right: 20px; background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(15px); border-radius: 25px; display: flex; justify-content: space-around; padding: 12px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid var(--border); z-index: 1000; }
        .tab-btn { color: var(--text-sec); text-align: center; font-size: 10px; flex: 1; cursor: pointer; }
        .tab-btn.active { color: var(--neon-blue); }
        .tab-btn i { font-size: 22px; display: block; margin-bottom: 4px; }

        .btn-main { background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; width: 100%; font-weight: bold; margin-top: 10px; cursor: pointer; }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 10px; color: white; font-family: 'Tajawal'; }

        .online-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; display: inline-block; margin-right: 4px; box-shadow: 0 0 5px var(--green); }
    </style>
</head>
<body>

<div id="offline-guard" class="hidden">
    <i class="fas fa-wifi" style="font-size: 50px; color: var(--red);"></i>
    <h2 style="color:white; margin:10px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„</h2>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="auth-screen" class="hidden">
    <div style="padding:40px; text-align:center; height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <img src="https://cdn-icons-png.flaticon.com/512/5501/5501360.png" style="width:100px; margin-bottom:20px;">
        <h2>SDM MARKET</h2>
        <button class="btn-main" onclick="loginWithGoogle()" style="background:white; color:black;">Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Google</button>
        <button onclick="enterGuestMode()" style="background:none; border:none; color:var(--text-sec); margin-top:20px;">ØªØµÙØ­ ÙƒØ²Ø§Ø¦Ø± ğŸ‘€</button>
    </div>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div id="app-screen" class="hidden">
    <header>
        <div class="header-top">
            <span onclick="handleBackButton()" style="cursor:pointer; font-size:22px;"><i class="fas fa-arrow-right"></i></span>
            <span id="head-title" style="font-weight: 800; font-size: 18px;">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            <div style="background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:15px; font-size:12px;">
                â­ <span id="u-stars">0.0</span>
            </div>
        </div>
        <div class="search-container" id="main-search">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Ø§Ø¨Ø­Ø« Ù‡Ù†Ø§..." oninput="filterContent(this.value)">
        </div>
    </header>

    <div id="dev-alert-bar" style="background:var(--red); padding:8px; text-align:center; font-size:12px; display:none;"></div>
    <div id="content-area"></div>

    <div class="bottom-tabs">
        <div class="tab-btn active" onclick="nav('home')"><i class="fas fa-home"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="tab-btn" onclick="checkGuestAccess('wallet')"><i class="fas fa-wallet"></i>Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
        <div class="tab-btn" onclick="checkGuestAccess('games')"><i class="fas fa-gamepad"></i>Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</div>
        <div class="tab-btn" onclick="checkGuestAccess('vip')"><i class="fas fa-crown"></i>VIP</div>
        <div class="tab-btn" onclick="checkGuestAccess('profile')"><i class="fas fa-user"></i>Ù…Ù„ÙÙŠ</div>
    </div>
</div>

<script>
    // Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    const firebaseConfig = {
      apiKey: "AIzaSyAI_mUhuPNoO-XC0Q-VNoWft8UWFbAbIGg",
      authDomain: "sudan-market-6b122.firebaseapp.com",
      databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com",
      projectId: "sudan-market-6b122",
      storageBucket: "sudan-market-6b122.firebasestorage.app",
      messagingSenderId: "66729481566",
      appId: "1:66729481566:web:93393f28dc22d32cceebcf"
    };
    
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let me = null;
    let isGuest = false;
    let hStack = JSON.parse(sessionStorage.getItem('hStack')) || ['home'];
    let tempImg = '';
    const ADMIN_EMAIL = "mb425262@gmail.com";

    // Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
    const cats = {
        "Ø§Ù„Ù‡ÙˆØ§ØªÙ": {i:"mobile-alt", s:["Ø¢ÙŠÙÙˆÙ†","Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬","Ø´Ø§ÙˆÙ…ÙŠ","Ø§ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª"]},
        "Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª": {i:"car", s:["ØªÙˆÙŠÙˆØªØ§","Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ","Ø£Ù…Ø¬Ø§Ø¯","Ø±ÙƒØ´Ø§Øª"]},
        "Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª": {i:"city", s:["Ø´Ù‚Ù‚ Ù„Ù„Ø§ÙŠØ¬Ø§Ø±","Ø¨ÙŠÙˆØª Ù„Ù„Ø¨ÙŠØ¹","Ø§Ø±Ø§Ø¶ÙŠ"]},
        "Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨": {i:"gamepad", s:["Ø­Ø³Ø§Ø¨Ø§Øª","Ø´Ø­Ù†"]},
        "Ø¹Ù…Ù„Ø§Øª": {i:"bitcoin", s:["USDT","Binance","Ø¨Ù†ÙˆÙƒ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©"]}
    };

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ù‚Ù„ ÙˆØ²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ ---
    function nav(view, extra = null, push = true) {
        if(push) {
            hStack.push({view, extra});
            sessionStorage.setItem('hStack', JSON.stringify(hStack));
            history.pushState({view, extra}, '');
        }
        render(view, extra);
        updateActiveTab(view);
    }

    function handleBackButton() {
        if (hStack.length > 1) {
            hStack.pop();
            sessionStorage.setItem('hStack', JSON.stringify(hStack));
            const last = hStack[hStack.length - 1];
            render(last.view || last, last.extra || null);
            updateActiveTab(last.view || last);
        } else {
            Swal.fire({
                title: 'Ø®Ø±ÙˆØ¬',
                text: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ø®Ø±ÙˆØ¬ Ù†Ù‡Ø§Ø¦ÙŠ',
                cancelButtonText: 'Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
                background: '#1e293b',
                color: '#fff'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.close(); // Ù‚Ø¯ Ù„Ø§ ØªØ¹Ù…Ù„ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØµÙØ­Ø§Øª Ù„Ø£Ø³Ø¨Ø§Ø¨ Ø£Ù…Ù†ÙŠØ©
                } else {
                    nav('home');
                }
            });
        }
    }

    window.onpopstate = function() {
        handleBackButton();
    };

    function updateActiveTab(view) {
        document.querySelectorAll('.tab-btn').forEach(b => {
            b.classList.remove('active');
            if(b.innerText.includes(view === 'home' ? 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©' : '')) b.classList.add('active');
        });
    }

    // --- ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
    auth.onAuthStateChanged(user => {
        if (user) {
            db.ref('users/' + user.uid).on('value', snap => {
                if(snap.exists()){
                    me = snap.val();
                    me.p = user.uid;
                    checkVipExpiry();
                    cleanupExpiredVipPosts();
                    startApp();
                } else {
                    const newUser = { n: user.displayName, p: user.uid, email: user.email, pic: user.photoURL, sdmBalance: 0, rating: 5.0, role: (user.email === ADMIN_EMAIL ? 'admin' : 'user'), vipStatus: 'none', lastSeen: Date.now() };
                    db.ref('users/' + user.uid).set(newUser);
                }
            });
        } else if (!isGuest) {
            document.getElementById('auth-screen').classList.remove('hidden');
        }
    });

    function startApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¢Ø®Ø± ØµÙØ­Ø© ÙƒØ§Ù† Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const last = hStack[hStack.length - 1];
        render(last.view || last, last.extra || null);
        
        setInterval(() => { if(me && !isGuest) db.ref('users/'+me.p).update({lastSeen: Date.now()}); }, 30000);
    }

    function enterGuestMode() {
        isGuest = true;
        me = { n: 'Ø²Ø§Ø¦Ø±', role: 'guest' };
        startApp();
    }

    // --- Ù†Ø¸Ø§Ù… VIP ÙˆØ§Ù„ØªÙ†Ø¸ÙŠÙ ---
    function checkVipExpiry() {
        if (me.vipStatus === 'active' && me.vipExpiry < Date.now()) {
            db.ref('users/' + me.p).update({ vipStatus: 'none' });
            Swal.fire('Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ', 'Ù„Ù‚Ø¯ Ø§Ù†ØªÙ‡Øª Ù…Ø¯Ø© Ø§Ø´ØªØ±Ø§Ùƒ VIP Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ', 'info');
        }
    }

    function cleanupExpiredVipPosts() {
        db.ref('vip_posts').once('value', snap => {
            snap.forEach(child => {
                if (child.val().vExpiry < Date.now()) {
                    child.ref.remove();
                }
            });
        });
    }

    // --- Ø§Ù„Ø¹Ø±Ø¶ (Render) ---
    function render(view, extra) {
        const area = document.getElementById('content-area');
        document.getElementById('head-title').innerText = getTitle(view);
        
        if (view === 'home') {
            area.innerHTML = `
                <div style="padding:20px;"><h3>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h3></div>
                <div class="grid">${Object.keys(cats).map(k => `<div class="card" onclick="nav('sub', '${k}')"><i class="fas fa-${cats[k].i}" style="font-size:24px; margin-bottom:10px; color:var(--accent);"></i><br><b>${k}</b></div>`).join('')}</div>
                <div style="padding:20px;"><h3>Ø¥Ø¹Ù„Ø§Ù†Ø§Øª VIP ğŸ’</h3><div id="vip-list"></div></div>`;
            loadPosts('vip_posts', null, 'vip-list');

        } else if (view === 'sub') {
            area.innerHTML = `<div class="grid">${cats[extra].s.map(s => `<div class="card" onclick="nav('feed', '${s}')"><b>${s}</b></div>`).join('')}</div>`;

        } else if (view === 'feed') {
            area.innerHTML = `
                ${!isGuest ? `<div class="post" style="padding:15px;">
                    <input id="pt" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
                    <input id="pp" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± SDM">
                    <textarea id="pd" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬"></textarea>
                    <input type="file" onchange="encodeImg(this)" style="font-size:12px;">
                    <button class="btn-main" onclick="publish('posts', '${extra}')">Ù†Ø´Ø± ÙÙŠ ${extra}</button>
                </div>` : ''}
                <div id="posts-list"></div>`;
            loadPosts('posts', extra, 'posts-list');

        } else if (view === 'vip') {
            const isVip = me.vipStatus === 'active';
            area.innerHTML = `
                <div style="text-align:center; padding:30px;">
                    <i class="fas fa-crown" style="font-size:50px; color:var(--accent);"></i>
                    <h2>${isVip ? 'Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ù†Ø´Ø·' : 'Ø§Ø´ØªØ±Ùƒ ÙÙŠ VIP'}</h2>
                    ${!isVip ? `<button class="btn-main" onclick="buyVip(30, 10)">Ø§Ø´ØªØ±Ø§Ùƒ Ø´Ù‡Ø± (10 SDM)</button>` : `<p>ÙŠÙ†ØªÙ‡ÙŠ ÙÙŠ: ${new Date(me.vipExpiry).toLocaleDateString()}</p>`}
                </div>
                ${isVip ? `<div class="post" style="padding:15px;">
                    <input id="vt" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø¥Ø¹Ù„Ø§Ù† VIP">
                    <input id="vp" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                    <textarea id="vd" placeholder="ÙˆØµÙ Ù…Ù…ÙŠØ²"></textarea>
                    <input type="file" onchange="encodeImg(this)">
                    <button class="btn-main" style="background:var(--accent);" onclick="publish('vip_posts')">Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ø°Ù‡Ø¨ÙŠ</button>
                </div>` : ''}`;

        } else if (view === 'profile') {
            area.innerHTML = `
                <div style="text-align:center; padding:40px;">
                    <img src="${me.pic || ''}" style="width:100px; height:100px; border-radius:50%; border:3px solid var(--neon-blue);">
                    <h2>${me.n}</h2>
                    <p>Ø§Ù„Ø±ØµÙŠØ¯: ${me.sdmBalance} SDM</p>
                    <button class="btn-main" style="background:var(--red);" onclick="auth.signOut().then(()=>location.reload())">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
                </div>`;
        }
    }

    // --- Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙˆØ§Ù„Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ---
    function loadPosts(path, filter, containerId) {
        db.ref(path).on('value', snap => {
            const cont = document.getElementById(containerId);
            if(!cont) return;
            cont.innerHTML = "";
            let posts = [];
            snap.forEach(child => {
                let p = child.val();
                p.key = child.key;
                if(!filter || p.cat === filter) posts.unshift(p);
            });

            posts.forEach(p => {
                const isOwner = (me && p.uP === me.p) || (me && me.role === 'admin');
                const timeStr = new Date(p.date).toLocaleString('ar-EG', { hour:'numeric', minute:'numeric', day:'numeric', month:'short' });
                
                // ÙØ­Øµ Ø­Ø§Ù„Ø© "Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†" Ù„Ù„Ù†Ø§Ø´Ø±
                db.ref('users/' + p.uP + '/lastSeen').once('value', s => {
                    const isOnline = (Date.now() - (s.val() || 0)) < 60000;
                    const onlineHtml = isOnline ? '<span class="online-dot"></span><span style="color:var(--green); font-size:10px;">Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</span>' : '';
                    
                    const postHtml = `
                        <div class="post" id="p-${p.key}">
                            ${p.status === 'sold' ? '<div class="sold-overlay">ØªÙ… Ø§Ù„Ø¨ÙŠØ¹</div>' : ''}
                            ${isOwner ? `<div class="post-options-btn" onclick="showPostMenu('${p.key}', '${path}', '${p.t}', '${p.pr}', '${p.d}')"><i class="fas fa-ellipsis-v"></i></div>` : ''}
                            <div class="post-img-container"><img src="${p.img}" style="width:100%; height:100%; object-fit:cover;"></div>
                            <div style="padding:15px;">
                                <div style="display:flex; justify-content:space-between; align-items:center;">
                                    <h3 style="margin:0;">${p.t}</h3>
                                    <b style="color:var(--accent);">${p.pr} SDM</b>
                                </div>
                                <p style="color:var(--text-sec); font-size:13px; margin:10px 0;">${p.d}</p>
                                <div style="display:flex; align-items:center; gap:8px; margin-top:10px; border-top:1px solid var(--border); padding-top:10px;">
                                    <img src="${p.uPic}" style="width:25px; height:25px; border-radius:50%;">
                                    <span style="font-size:12px;">${p.uN}</span>
                                    ${onlineHtml}
                                    <div style="flex:1;"></div>
                                    <div class="post-date">${timeStr}</div>
                                </div>
                            </div>
                        </div>`;
                    cont.innerHTML += postHtml;
                });
            });
        });
    }

    function showPostMenu(key, path, t, pr, d) {
        Swal.fire({
            title: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±',
            showCancelButton: true,
            showDenyButton: true,
            confirmButtonText: 'ØªØ¹Ø¯ÙŠÙ„',
            denyButtonText: 'Ù…Ø³Ø­ Ø§Ù„Ù…Ù†Ø´ÙˆØ±',
            cancelButtonText: 'ØªÙ… Ø§Ù„Ø¨ÙŠØ¹ âœ…',
            background: '#1e293b',
            color: '#fff'
        }).then((result) => {
            if (result.isConfirmed) {
                editPost(key, path, t, pr, d);
            } else if (result.isDenied) {
                deletePost(key, path);
            } else if (result.dismiss === Swal.DismissReason.cancel) {
                markAsSold(key, path);
            }
        });
    }

    function deletePost(key, path) {
        Swal.fire({ title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ù…Ø³Ø­' })
        .then(r => { if(r.isConfirmed) db.ref(path + '/' + key).remove(); });
    }

    function markAsSold(key, path) {
        db.ref(path + '/' + key).update({ status: 'sold' });
        Swal.fire('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ù…Ù†ØªØ¬ ÙƒÙ€ Ù…Ø¨Ø§Ø¹', 'success');
    }

    function editPost(key, path, t, pr, d) {
        Swal.fire({
            title: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†Ø´ÙˆØ±',
            html: `<input id="et" value="${t}" class="swal2-input"><input id="ep" type="number" value="${pr}" class="swal2-input"><textarea id="ed" class="swal2-textarea">${d}</textarea>`,
            confirmButtonText: 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª',
            preConfirm: () => {
                return { t: document.getElementById('et').value, pr: document.getElementById('ep').value, d: document.getElementById('ed').value }
            }
        }).then(res => {
            if(res.value) db.ref(path + '/' + key).update(res.value);
        });
    }

    function publish(path, category = null) {
        const t = document.getElementById(path === 'posts' ? 'pt' : 'vt').value;
        const pr = document.getElementById(path === 'posts' ? 'pp' : 'vp').value;
        const d = document.getElementById(path === 'posts' ? 'pd' : 'vd').value;

        if(!t || !pr || !tempImg) return Swal.fire('Ù†Ù‚Øµ Ø¨ÙŠØ§Ù†Ø§Øª', 'ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„ØµÙˆØ±Ø©', 'warning');

        const postData = {
            t, pr, d, img: tempImg,
            uP: me.p, uN: me.n, uPic: me.pic,
            date: Date.now(),
            status: 'active',
            cat: category
        };

        if(path === 'vip_posts') postData.vExpiry = me.vipExpiry;

        db.ref(path).push(postData).then(() => {
            Swal.fire('ØªÙ… Ø§Ù„Ù†Ø´Ø±', 'Ø¥Ø¹Ù„Ø§Ù†Ùƒ Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù† Ù„Ù„Ø¬Ù…ÙŠØ¹', 'success');
            tempImg = "";
            render(category ? 'feed' : 'home', category);
        });
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ù…Ø³Ø§Ø¹Ø¯Ø© ---
    async function encodeImg(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 600; canvas.height = (img.height / img.width) * 600;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                tempImg = canvas.toDataURL('image/jpeg', 0.7);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(e => alert(e.message));
    }

    function getTitle(v) {
        const titles = { home: 'SDM Market', wallet: 'Ø§Ù„Ù…Ø­ÙØ¸Ø©', games: 'Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨', vip: 'VIP', profile: 'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', feed: 'Ø§Ù„Ù…ØªØ¬Ø±', sub: 'Ø§Ù„Ø£Ù‚Ø³Ø§Ù…' };
        return titles[v] || 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©';
    }

    function checkGuestAccess(view) {
        if(isGuest) return Swal.fire('Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ', 'Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ù„Ù„Ø²ÙˆØ§Ø±', 'warning');
        nav(view);
    }

    function buyVip(days, cost) {
        if(me.sdmBalance < cost) return Swal.fire('Ø±ØµÙŠØ¯ Ø¶Ø¹ÙŠÙ', 'Ù„Ø§ ØªÙ…Ù„Ùƒ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙŠ', 'error');
        const expiry = Date.now() + (days * 24 * 60 * 60 * 1000);
        db.ref('users/'+me.p).update({
            sdmBalance: me.sdmBalance - cost,
            vipStatus: 'active',
            vipExpiry: expiry
        });
        Swal.fire('Ù…Ø¨Ø±ÙˆÙƒ!', 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ VIP Ø¨Ù†Ø¬Ø§Ø­', 'success');
    }

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ | Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø±Ù‚Ù…ÙŠ</title>
    
    <!-- Ø®Ø·ÙˆØ· Ø¹Ø±Ø¨ÙŠØ© -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- UI Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ========== Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ========== */
        :root {
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.95);
            --primary: #3b82f6;
            --accent: #f59e0b;
            --neon-blue: #00f3ff;
            --text-main: #f8fafc;
            --text-sec: #94a3b8;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --red: #ef4444; 
            --green: #10b981; 
            --purple: #8b5cf6;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
        }
        
        body {
            font-family: 'Tajawal', sans-serif; 
            margin: 0;
            background: radial-gradient(circle at top, #1e293b, #0f172a); 
            color: var(--text-main);
            padding-bottom: 90px;
            min-height: 100vh;
            user-select: none;
            overflow-x: hidden;
        }

        .hidden { display: none !important; }
        
        /* ========== Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ø¨Ø­Ø« ========== */
        header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            padding: 15px 20px;
            position: sticky; 
            top: 0; 
            z-index: 1000;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .header-top { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            width: 100%; 
            margin-bottom: 10px;
        }
        
        .search-container { 
            position: relative; 
            width: 100%; 
        }
        
        .search-container input {
            width: 100%; 
            padding: 12px 45px 12px 15px;
            border-radius: 15px; 
            border: 1px solid var(--border);
            font-size: 14px; 
            background: var(--glass); 
            color: white;
            transition: 0.3s; 
            font-family: 'Tajawal';
        }
        
        .search-container input:focus { 
            background: rgba(255,255,255,0.1); 
            border-color: var(--neon-blue); 
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); 
        }
        
        .search-container i { 
            position: absolute; 
            right: 15px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--accent); 
        }

        /* ========== Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ø¬Ø±ÙŠØ¯ ========== */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 15px; 
            padding: 15px; 
        }
        
        .card { 
            background: var(--bg-card); 
            border-radius: 18px; 
            padding: 20px; 
            text-align: center; 
            border: 1px solid var(--border); 
            transition: 0.3s; 
            position: relative; 
            overflow: hidden; 
            backdrop-filter: blur(5px); 
            color: var(--text-main); 
            cursor: pointer;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .card:active { transform: scale(0.96); }
        
        .card:hover { 
            border-color: var(--neon-blue); 
            box-shadow: 0 5px 20px rgba(0, 243, 255, 0.15); 
            transform: translateY(-5px); 
        }
        
        .card i { 
            font-size: 32px; 
            margin-bottom: 10px; 
            background: linear-gradient(45deg, #fff, #aaa); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        
        .card-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--accent);
            color: black;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 10px;
            font-weight: bold;
        }

        /* ========== Ø§Ù„Ø£Ø²Ø±Ø§Ø± ========== */
        .btn-main { 
            background: linear-gradient(90deg, var(--primary), #2563eb); 
            color: white; 
            border: none; 
            padding: 15px; 
            width: 100%; 
            border-radius: 12px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 16px; 
            margin-top: 10px; 
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); 
            transition: 0.3s; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-main:hover { opacity: 0.9; }
        
        .btn-secondary { 
            background: transparent; 
            border: 1px solid var(--text-sec); 
            color: var(--text-sec); 
            width: 100%; 
            padding: 12px; 
            border-radius: 10px; 
            margin-top: 10px; 
            cursor: pointer; 
        }
        
        .btn-danger { 
            background: var(--red); 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 10px; 
            cursor: pointer; 
        }
        
        .btn-success { 
            background: var(--green); 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 10px; 
            cursor: pointer; 
        }

        /* ========== Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ========== */
        input, textarea, select { 
            width: 100%; 
            padding: 15px; 
            margin: 8px 0; 
            background: rgba(0,0,0,0.2); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            color: white; 
            font-family: 'Tajawal'; 
            box-sizing: border-box; 
        }
        
        input:focus, textarea:focus, select:focus { 
            border-color: var(--accent); 
            outline: none; 
            background: rgba(0,0,0,0.4); 
        }

        /* ========== Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙˆØ§Ù„ÙƒØªØ¨ ========== */
        .post { 
            background: var(--bg-card); 
            margin: 15px; 
            border-radius: 20px; 
            overflow: hidden; 
            border: 1px solid var(--border); 
            animation: fadeIn 0.5s ease; 
            position: relative; 
        }
        
        .book-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .book-cover {
            width: 80px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            border: 1px solid var(--accent);
        }
        
        .grade-badge {
            background: var(--purple);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 5px;
        }

        /* ========== Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ© ========== */
        .bottom-tabs {
            position: fixed; 
            bottom: 20px; 
            left: 20px; 
            right: 20px; 
            background: rgba(30, 41, 59, 0.95); 
            backdrop-filter: blur(15px); 
            border-radius: 25px; 
            display: flex; 
            justify-content: space-around; 
            padding: 12px 0; 
            box-shadow: var(--shadow);
            border: 1px solid var(--border); 
            z-index: 1000;
        }
        
        .tab-btn { 
            color: var(--text-sec); 
            text-align: center; 
            font-size: 10px; 
            transition: 0.3s; 
            position: relative; 
            flex: 1; 
            cursor: pointer; 
        }
        
        .tab-btn i { 
            font-size: 22px; 
            margin-bottom: 4px; 
            display: block; 
            transition: 0.3s; 
        }
        
        .tab-btn.active { color: var(--neon-blue); }
        .tab-btn.active i { transform: translateY(-5px); text-shadow: 0 0 10px var(--neon-blue); }

        /* ========== Ø´Ø§Ø´Ø§Øª Ø®Ø§ØµØ© ========== */
        .live-room {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 20px;
            margin: 15px;
            color: white;
        }
        
        .payment-method {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid var(--green);
        }
        
        .admin-panel {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--red);
            border-radius: 15px;
            padding: 20px;
            margin: 15px;
        }

        /* ========== Ø§Ù„ØªØ­Ù…ÙŠÙ„ ========== */
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: var(--text-sec); 
        }
        
        .loading-spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== Ù…ØªØ¬Ø§ÙˆØ¨ ========== */
        @media (max-width: 768px) {
            .grid { grid-template-columns: repeat(2, 1fr); }
            .bottom-tabs { left: 10px; right: 10px; bottom: 10px; }
            .card { padding: 15px; min-height: 130px; }
            .card i { font-size: 28px; }
        }
        
        @media (max-width: 480px) {
            .grid { grid-template-columns: 1fr; }
            header { padding: 12px 15px; }
        }

        /* ========== Ø¹Ù†Ø§ØµØ± Ø§Ù„ØµÙˆØª ========== */
        .audio-player {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .audio-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .audio-progress {
            flex: 1;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            cursor: pointer;
        }
        
        .audio-progress-bar {
            height: 100%;
            background: var(--accent);
            border-radius: 3px;
            width: 0%;
            transition: width 0.1s;
        }
        
        .file-upload-area {
            border: 3px dashed var(--accent);
            border-radius: 20px;
            padding: 40px 20px;
            text-align: center;
            background: rgba(245, 158, 11, 0.05);
            cursor: pointer;
            transition: 0.3s;
        }
        
        .file-upload-area:hover {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--neon-blue);
        }
        
        .uploaded-file {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .tts-container {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            border-radius: 20px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div id="main-preloader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#0f172a; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:99999;">
    <div class="loading-spinner"></div>
    <p style="color:white; font-family:'Tajawal'; margin-top:15px; font-size:18px;">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ ÙŠØ¬Ù‡Ø² Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ…...</p>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="auth-screen" class="hidden">
    <div style="padding:40px; text-align:center; height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div style="width:120px; height:120px; border-radius:50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display:flex; align-items:center; justify-content:center; margin-bottom:30px;">
            <i class="fas fa-robot" style="font-size:50px; color:white;"></i>
        </div>
        <h1 style="font-size: 42px; margin-bottom:10px; background: linear-gradient(45deg, var(--neon-blue), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight:800;">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</h1>
        <p style="color:var(--text-sec); margin-bottom:40px; font-size:16px;">Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø°ÙƒÙŠ - Ù…Ù† Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</p>
        <div style="width:100%; max-width:400px;">
            <button class="btn-main" onclick="loginWithGoogle()" style="background:white; color:black; display:flex; align-items:center; justify-content:center; gap:15px; padding:18px;">
                <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google" style="width:24px; height:24px;">
                <span style="font-size:18px;">Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Google</span>
            </button>
            <button class="btn-secondary" onclick="enterGuestMode()" style="padding:15px; margin-top:20px; font-size:16px;">
                <i class="fas fa-eye"></i> ØªØµÙØ­ ÙƒØ²Ø§Ø¦Ø± ğŸ‘€ (Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„ Ù…Ø¬Ø§Ù†ÙŠ)
            </button>
            
            <div style="margin-top:40px; padding:20px; background:rgba(255,255,255,0.05); border-radius:15px;">
                <h4 style="color:var(--accent);">Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ:</h4>
                <ul style="text-align:right; padding-right:20px; color:var(--text-sec); line-height:2;">
                    <li>ØªØµÙØ­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</li>
                    <li>Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø°ÙƒÙŠ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</li>
                    <li>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ ØºØ±Ù Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</li>
                    <li>Ø¥Ø¶Ø§ÙØ© ÙƒØªØ¨ Ù„Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div id="app-screen" class="hidden">
    <header>
        <div class="header-top">
            <span onclick="handleBackButton()" style="cursor:pointer; font-size:22px; color:var(--text-sec); width:30px; height:30px; display:flex; align-items:center; justify-content:center;">
                <i class="fas fa-arrow-right"></i>
            </span>
            <span id="head-title" style="font-weight: 800; font-size: 20px; color: var(--text-main); text-align:center; flex:1;">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            <div id="user-badge" style="background:rgba(255,255,255,0.1); padding:5px 12px; border-radius:15px; display:flex; align-items:center; gap:8px; cursor:pointer;" onclick="nav('profile')">
                <i class="fas fa-user" style="color:var(--accent); font-size:14px;"></i>
                <span id="u-stars" style="font-size:14px; font-weight:bold;">0.0</span>
            </div>
        </div>
        <div class="search-container" id="main-search">
            <i class="fas fa-search"></i>
            <input type="text" id="store-search" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙƒØªØ¨ØŒ Ø§Ù„ÙØµÙˆÙ„ØŒ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©..." oninput="debounceFilter(this.value)">
        </div>
    </header>

    <div id="content-area"></div>

    <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ© -->
    <div class="bottom-tabs">
        <div class="tab-btn active" onclick="nav('home'); highlightTab(this)">
            <i class="fas fa-home"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </div>
        <div class="tab-btn" onclick="nav('grades'); highlightTab(this)">
            <i class="fas fa-graduation-cap"></i>Ø§Ù„ÙØµÙˆÙ„
        </div>
        <div class="tab-btn" onclick="nav('library'); highlightTab(this)">
            <i class="fas fa-book"></i>Ø§Ù„Ù…ÙƒØªØ¨Ø©
        </div>
        <div class="tab-btn" onclick="nav('ai_assistant'); highlightTab(this)">
            <i class="fas fa-robot"></i>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ
        </div>
        <div class="tab-btn" onclick="nav('live'); highlightTab(this)">
            <i class="fas fa-video"></i>Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
        </div>
    </div>
</div>

<!-- Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© -->
<div id="public-library-modal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; display:flex; align-items:center; justify-content:center; padding:20px;">
    <div style="background:var(--bg-dark); width:100%; max-width:800px; max-height:90vh; overflow-y:auto; border-radius:20px; padding:20px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="color:var(--neon-blue);">ğŸ“š Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø© (ÙƒØªØ¨ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©)</h2>
            <button onclick="closePublicLibrary()" style="background:var(--red); color:white; border:none; width:40px; height:40px; border-radius:50%; cursor:pointer;">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="public-library-content"></div>
    </div>
</div>

<!-- Ù…Ù„Ù ØµÙˆØªÙŠ Ù„Ù„Ø´Ø±Ø­ -->
<audio id="voiceExplanation" style="display:none;"></audio>

<script>
// ==================== [ 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ] ====================
const firebaseConfig = {
    apiKey: "AIzaSyAI_mUhuPNoO-XC0Q-VNoWft8UWFbAbIGg",
    authDomain: "sudan-market-6b122.firebaseapp.com",
    databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com",
    projectId: "sudan-market-6b122",
    storageBucket: "sudan-market-6b122.firebasestorage.app",
    messagingSenderId: "66729481566",
    appId: "1:66729481566:web:93393f28dc22d32cceebcf"
};

if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

// ==================== [ 2. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ] ====================
const ADMIN_EMAIL = "mb425262@gmail.com";
const ADMIN_BANK_ACCOUNT = "4426148";
const FREE_TRIAL_DAYS = 1;

let me = null;
let hStack = ['home'];
let isGuest = false;
let currentBookId = null;
let selectedChapter = '';
let currentQuiz = null;
let currentLiveRoom = null;
let currentVoice = null;
let uploadedFile = null;

// Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©
const ALL_GRADES = [
    { id: 'grade1', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', icon: 'fas fa-child', color: '#FF6B6B' },
    { id: 'grade2', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', icon: 'fas fa-child', color: '#4ECDC4' },
    { id: 'grade3', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', icon: 'fas fa-child', color: '#FFD166' },
    { id: 'grade4', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', icon: 'fas fa-user-graduate', color: '#06D6A0' },
    { id: 'grade5', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', icon: 'fas fa-user-graduate', color: '#118AB2' },
    { id: 'grade6', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ', icon: 'fas fa-user-graduate', color: '#073B4C' },
    { id: 'grade7', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø·', icon: 'fas fa-school', color: '#7209B7' },
    { id: 'grade8', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ù…ØªÙˆØ³Ø·', icon: 'fas fa-school', color: '#F72585' },
    { id: 'grade9', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø·', icon: 'fas fa-school', color: '#3A0CA3' },
    { id: 'grade10', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ', icon: 'fas fa-university', color: '#4361EE' },
    { id: 'grade11', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ', icon: 'fas fa-university', color: '#4CC9F0' },
    { id: 'grade12', name: 'Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ', icon: 'fas fa-university', color: '#F15BB5' }
];

// Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©
const SUBJECTS = [
    'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø§Ù„Ø¹Ù„ÙˆÙ…', 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©',
    'Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§', 'Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©',
    'Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„ÙÙ†ÙŠØ©', 'Ø§Ù„Ø­Ø§Ø³ÙˆØ¨', 'Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡', 'Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡', 'Ø§Ù„Ø£Ø­ÙŠØ§Ø¡'
];

// ==================== [ 3. Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ] ====================
function debounce(func, wait = 300) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function formatDate(timestamp) {
    if (!timestamp) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    const date = new Date(timestamp);
    return date.toLocaleDateString('ar-SA');
}

function showLoading(message = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...') {
    Swal.fire({
        title: message,
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading(),
        background: '#1e293b',
        color: '#fff'
    });
}

function hideLoading() {
    Swal.close();
}

function showSuccess(message) {
    Swal.fire({
        title: 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!',
        text: message,
        icon: 'success',
        confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
        background: '#1e293b',
        color: '#fff'
    });
}

function showError(message) {
    Swal.fire({
        title: 'Ø®Ø·Ø£!',
        text: message,
        icon: 'error',
        confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
        background: '#1e293b',
        color: '#fff'
    });
}

// ==================== [ 4. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ] ====================
async function loginWithGoogle() {
    try {
        showLoading('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
        const provider = new firebase.auth.GoogleAuthProvider();
        const result = await auth.signInWithPopup(provider);
        
        if (result.user) {
            const user = result.user;
            const userRef = db.ref('users/' + user.uid);
            const snap = await userRef.once('value');
            
            if (!snap.exists()) {
                // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ
                const freeUntil = Date.now() + (FREE_TRIAL_DAYS * 24 * 60 * 60 * 1000);
                
                await userRef.set({
                    name: user.displayName || 'Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯',
                    uid: user.uid,
                    email: user.email,
                    photo: user.photoURL || 'https://cdn-icons-png.flaticon.com/512/149/149071.png',
                    balance: 0,
                    rating: 5.0,
                    role: user.email === ADMIN_EMAIL ? 'admin' : 'user',
                    joinDate: Date.now(),
                    freeTrial: true,
                    freeUntil: freeUntil,
                    subscription: null,
                    isTeacher: false,
                    teacherAccount: '',
                    aiQuizzesCount: 0,
                    booksAdded: 0,
                    totalSpent: 0
                });
                
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ
                await db.ref('free_trials/' + user.uid).set({
                    userId: user.uid,
                    startDate: Date.now(),
                    endDate: freeUntil,
                    used: true
                });
            }
            
            startApp(user.uid);
        }
    } catch (error) {
        hideLoading();
        showError('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message);
    }
}

function enterGuestMode() {
    isGuest = true;
    me = {
        name: 'Ø²Ø§Ø¦Ø±',
        uid: 'guest',
        role: 'guest',
        balance: 0,
        rating: 0,
        photo: 'https://cdn-icons-png.flaticon.com/512/149/149071.png',
        joinDate: Date.now(),
        freeTrial: true,
        freeUntil: Date.now() + (FREE_TRIAL_DAYS * 24 * 60 * 60 * 1000),
        aiQuizzesCount: 0,
        booksAdded: 0
    };
    
    document.getElementById('main-preloader').style.display = 'none';
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('app-screen').classList.remove('hidden');
    document.getElementById('u-stars').innerText = "Ø²Ø§Ø¦Ø±";
    
    render('home');
}

function doLogout() {
    if (isGuest) {
        location.reload();
        return;
    }
    
    auth.signOut().then(() => {
        location.reload();
    });
}

// ==================== [ 5. Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ] ====================
function startApp(uid) {
    isGuest = false;
    
    db.ref('users/' + uid).on('value', snap => {
        if (snap.exists()) {
            me = snap.val();
            me.uid = uid;
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            db.ref('users/' + uid + '/online').set(true);
            db.ref('users/' + uid + '/online').onDisconnect().set(false);
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø±ØµÙŠØ¯ Ø£Ùˆ Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø§Ø¦Ø±
            const balanceText = me.balance ? me.balance.toFixed(1) + ' SDM' : 'Ù…Ø¬Ø§Ù†ÙŠ';
            document.getElementById('u-stars').innerText = balanceText;
            
            hideLoading();
        }
    });
    
    document.getElementById('main-preloader').style.display = 'none';
    document.getElementById('auth-screen').classList.add('hidden');
    document.getElementById('app-screen').classList.remove('hidden');
    
    render('home');
}

// ==================== [ 6. Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ù‚Ù„ ] ====================
function nav(view, extra) {
    hStack.push(view);
    const area = document.getElementById('content-area');
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    const titles = {
        'home': 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
        'grades': 'Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©',
        'library': 'Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©',
        'ai_assistant': 'Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ',
        'live': 'ØºØ±Ù Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±',
        'profile': 'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ',
        'admin': 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…',
        'add_book': 'Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯',
        'book_detail': 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨',
        'subscription': 'Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø¯ÙØ¹',
        'voice_assistant': 'Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØµÙˆØªÙŠ'
    };
    document.getElementById('head-title').innerText = titles[view] || view;
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
    if (view === 'home') {
        renderHome();
    } else if (view === 'grades') {
        renderGrades();
    } else if (view === 'library') {
        renderLibrary();
    } else if (view === 'ai_assistant') {
        renderAIAssistant();
    } else if (view === 'live') {
        renderLiveRooms();
    } else if (view === 'profile') {
        renderProfile();
    } else if (view === 'admin') {
        renderAdminPanel();
    } else if (view === 'add_book') {
        renderAddBook();
    } else if (view === 'subscription') {
        renderSubscription();
    } else if (view === 'book_detail') {
        if (extra) loadBookDetail(extra);
    } else if (view === 'voice_assistant') {
        renderVoiceAssistant();
    }
    
    highlightTab(document.querySelector(`[onclick*="${view}"]`));
}

function highlightTab(el) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    if (el) el.classList.add('active');
}

function handleBackButton() {
    if (hStack.length > 1) {
        hStack.pop();
        const prevView = hStack[hStack.length - 1];
        nav(prevView);
    } else {
        Swal.fire({
            title: 'ØªØ£ÙƒÙŠØ¯',
            text: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ØŸ',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø®Ø±ÙˆØ¬',
            cancelButtonText: 'Ø§Ù„Ø¨Ù‚Ø§Ø¡',
            background: '#1e293b',
            color: '#fff'
        }).then(result => {
            if (result.isConfirmed) {
                if (isGuest) location.reload();
                else doLogout();
            }
        });
    }
}

// ==================== [ 7. Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ ] ====================
function renderHome() {
    const area = document.getElementById('content-area');
    const isFreeTrial = me.freeTrial && me.freeUntil > Date.now();
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:20px; padding:25px; color:white; margin-bottom:25px;">
                <h2 style="margin-top:0;">Ù…Ø±Ø­Ø¨Ø§Ù‹ ${me.name} ğŸ‘‹</h2>
                <p>${isFreeTrial ? 'ğŸ‰ Ø£Ù†Øª ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Ø§Ù„ÙŠÙˆÙ…' : 'Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø±Ø­Ù„Ø© Ø§Ù„ØªØ¹Ù„Ù… Ù…Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ'}</p>
                ${isFreeTrial ? `
                    <div style="background:rgba(255,255,255,0.2); padding:10px; border-radius:10px; margin-top:10px;">
                        <small>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ: ${Math.ceil((me.freeUntil - Date.now()) / (1000 * 60 * 60))} Ø³Ø§Ø¹Ø©</small>
                    </div>
                ` : ''}
            </div>
            
            <div class="grid">
                <div class="card" onclick="nav('grades')">
                    <div class="card-badge">ğŸ“š</div>
                    <i class="fas fa-graduation-cap" style="color:#3b82f6"></i>
                    <b>Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</b>
                    <p style="font-size:12px; color:var(--text-sec)">Ù…Ù† Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</p>
                </div>
                
                <div class="card" onclick="nav('library')">
                    <div class="card-badge">ğŸ“–</div>
                    <i class="fas fa-book" style="color:#f59e0b"></i>
                    <b>Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</b>
                    <p style="font-size:12px; color:var(--text-sec)">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</p>
                </div>
                
                <div class="card" onclick="nav('ai_assistant')">
                    <div class="card-badge">ğŸ¤–</div>
                    <i class="fas fa-robot" style="color:#8b5cf6"></i>
                    <b>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</b>
                    <p style="font-size:12px; color:var(--text-sec)">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø°ÙƒÙŠØ©</p>
                </div>
                
                <div class="card" onclick="nav('live')">
                    <div class="card-badge">ğŸ“¹</div>
                    <i class="fas fa-video" style="color:#ef4444"></i>
                    <b>Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</b>
                    <p style="font-size:12px; color:var(--text-sec)">Ø¯Ø±ÙˆØ³ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</p>
                </div>
                
                ${me.role === 'admin' ? `
                <div class="card" onclick="nav('admin')" style="border:2px solid var(--red);">
                    <div class="card-badge" style="background:var(--red);">âš™ï¸</div>
                    <i class="fas fa-cogs" style="color:var(--red)"></i>
                    <b>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</b>
                    <p style="font-size:12px; color:var(--text-sec)">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</p>
                </div>
                ` : ''}
                
                <div class="card" onclick="showPublicLibrary()">
                    <div class="card-badge" style="background:var(--green);">ğŸ“š</div>
                    <i class="fas fa-book-open" style="color:var(--green)"></i>
                    <b>Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</b>
                    <p style="font-size:12px; color:var(--text-sec)">ÙƒØªØ¨ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙˆØ§Ù„Ø¥Ø«Ø±Ø§Ø¡</p>
                </div>

                <div class="card" onclick="nav('voice_assistant')">
                    <div class="card-badge" style="background:var(--purple);">ğŸ¤</div>
                    <i class="fas fa-microphone" style="color:var(--purple)"></i>
                    <b>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØµÙˆØªÙŠ</b>
                    <p style="font-size:12px; color:var(--text-sec)">Ø´Ø±Ø­ ØµÙˆØªÙŠ Ù„Ù„ÙƒØªØ¨</p>
                </div>
            </div>
            
            <div style="margin-top:30px;">
                <h3><i class="fas fa-fire" style="color:var(--accent);"></i> Ø£Ø­Ø¯Ø« Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ø¶Ø§ÙØ©</h3>
                <div id="recent-books" class="loading">
                    <div class="loading-spinner"></div>
                    <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ¨...</div>
                </div>
            </div>
            
            <div style="margin-top:30px;">
                <h3><i class="fas fa-chart-line" style="color:var(--green);"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙƒ</h3>
                <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; text-align:center;">
                    <div style="background:var(--bg-card); padding:15px; border-radius:15px;">
                        <div style="font-size:24px; font-weight:bold; color:var(--accent);">${me.aiQuizzesCount || 0}</div>
                        <div style="font-size:12px; color:var(--text-sec);">Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø°ÙƒÙŠØ©</div>
                    </div>
                    <div style="background:var(--bg-card); padding:15px; border-radius:15px;">
                        <div style="font-size:24px; font-weight:bold; color:var(--green);">${me.booksAdded || 0}</div>
                        <div style="font-size:12px; color:var(--text-sec);">ÙƒØªØ¨ Ù…Ø¶Ø§ÙØ©</div>
                    </div>
                    <div style="background:var(--bg-card); padding:15px; border-radius:15px;">
                        <div style="font-size:24px; font-weight:bold; color:var(--purple);">${me.balance || 0}</div>
                        <div style="font-size:12px; color:var(--text-sec);">Ø±ØµÙŠØ¯ SDM</div>
                    </div>
                </div>
            </div>
        </div>`;
    
    loadRecentBooks();
}

function renderGrades() {
    const area = document.getElementById('content-area');
    
    area.innerHTML = `
        <div style="padding:20px;">
            <h2 style="color:var(--neon-blue);"><i class="fas fa-graduation-cap"></i> Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h2>
            <p style="color:var(--text-sec); margin-bottom:25px;">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…ØªØ§Ø­Ø©</p>
            
            <div class="grid">
                ${ALL_GRADES.map(grade => `
                    <div class="card" onclick="loadBooksByGrade('${grade.id}', '${grade.name}')" 
                         style="border-left:4px solid ${grade.color};">
                        <i class="${grade.icon}" style="color:${grade.color}"></i>
                        <b>${grade.name}</b>
                        <p style="font-size:11px; color:var(--text-sec);">Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØªØ¨</p>
                    </div>
                `).join('')}
            </div>
            
            <div style="margin-top:30px; padding:20px; background:var(--bg-card); border-radius:15px;">
                <h4><i class="fas fa-info-circle" style="color:var(--accent);"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‡Ø§Ù…Ø©:</h4>
                <ul style="color:var(--text-sec); padding-right:20px; line-height:1.8;">
                    <li>Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØªØ¨ Ù…ØªØ§Ø­Ø© Ù„Ù„ØªØµÙØ­ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ</li>
                    <li>Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙŠØªØ·Ù„Ø¨ Ø§Ø´ØªØ±Ø§Ùƒ Ø£Ùˆ Ø±ØµÙŠØ¯ SDM</li>
                    <li>ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙƒØªØ¨ Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</li>
                    <li>Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„ Ù…Ø¬Ø§Ù†ÙŠ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯</li>
                </ul>
            </div>
        </div>`;
}

function renderLibrary() {
    const area = document.getElementById('content-area');
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="color:var(--neon-blue);"><i class="fas fa-book"></i> Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</h2>
                <button class="btn-main" onclick="nav('add_book')" style="width:auto; padding:10px 20px;">
                    <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨
                </button>
            </div>
            
            <div style="margin:20px 0;">
                <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
                    <select id="filter-grade" class="swal2-input" style="flex:1; min-width:150px;" onchange="filterBooks()">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
                        ${ALL_GRADES.map(g => `<option value="${g.name}">${g.name}</option>`).join('')}
                    </select>
                    
                    <select id="filter-subject" class="swal2-input" style="flex:1; min-width:150px;" onchange="filterBooks()">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯</option>
                        ${SUBJECTS.map(s => `<option value="${s}">${s}</option>`).join('')}
                    </select>
                    
                    <select id="filter-price" class="swal2-input" style="flex:1; min-width:150px;" onchange="filterBooks()">
                        <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¹Ø§Ø±</option>
                        <option value="free">Ù…Ø¬Ø§Ù†ÙŠ ÙÙ‚Ø·</option>
                        <option value="paid">Ù…Ø¯ÙÙˆØ¹ ÙÙ‚Ø·</option>
                    </select>
                </div>
                
                <input type="text" id="book-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒØªØ§Ø¨ØŒ Ù…Ø¤Ù„ÙØŒ Ø£Ùˆ Ù…Ø§Ø¯Ø©..." 
                       style="width:100%;" oninput="debounceSearch(this.value)">
            </div>
            
            <div id="books-list" class="loading">
                <div class="loading-spinner"></div>
                <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©...</div>
            </div>
            
            <div style="margin-top:30px; text-align:center;">
                <button class="btn-secondary" onclick="showPublicLibrary()">
                    <i class="fas fa-external-link-alt"></i> ØªØµÙØ­ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©
                </button>
            </div>
        </div>`;
    
    loadAllBooks();
}

function renderAIAssistant() {
    const area = document.getElementById('content-area');
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius:20px; padding:25px; color:white; margin-bottom:25px;">
                <h2 style="margin-top:0;"><i class="fas fa-robot"></i> Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</h2>
                <p>Ø£Ù†Ø´Ø¦ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø°ÙƒÙŠØ© Ù…Ù† Ø£ÙŠ ÙƒØªØ§Ø¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
            </div>
            
            <div style="margin:20px 0;">
                <h3><i class="fas fa-book" style="color:var(--accent);"></i> Ø§Ø®ØªØ± ÙƒØªØ§Ø¨Ø§Ù‹ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±</h3>
                <div id="ai-books-list" class="loading">
                    <div class="loading-spinner"></div>
                    <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ¨...</div>
                </div>
            </div>
            
            <div id="ai-interface" style="display:none;">
                <div style="background:var(--bg-card); padding:20px; border-radius:15px; margin:20px 0;">
                    <h4><i class="fas fa-cogs" style="color:var(--accent);"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h4>
                    
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin:15px 0;">
                        <div>
                            <label style="display:block; margin-bottom:8px; color:var(--text-sec);">
                                <i class="fas fa-layer-group"></i> Ø§Ù„ÙØµÙ„:
                            </label>
                            <select id="chapter-select" class="swal2-input">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ Ø¹Ø§Ù…</option>
                                <option value="Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</option>
                                <option value="Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                                <option value="Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù„Ø«">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                                <option value="Ø¹Ø§Ù…">Ø¹Ø§Ù… (Ø§Ù„ÙƒØªØ§Ø¨ ÙƒØ§Ù…Ù„Ø§Ù‹)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display:block; margin-bottom:8px; color:var(--text-sec);">
                                <i class="fas fa-question-circle"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:
                            </label>
                            <select id="question-count" class="swal2-input">
                                <option value="5">5 Ø£Ø³Ø¦Ù„Ø©</option>
                                <option value="10" selected>10 Ø£Ø³Ø¦Ù„Ø©</option>
                                <option value="15">15 Ø£Ø³Ø¦Ù„Ø©</option>
                                <option value="20">20 Ø£Ø³Ø¦Ù„Ø©</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display:block; margin-bottom:8px; color:var(--text-sec);">
                                <i class="fas fa-chart-line"></i> Ø§Ù„ØµØ¹ÙˆØ¨Ø©:
                            </label>
                            <select id="difficulty" class="swal2-input">
                                <option value="easy">Ø³Ù‡Ù„</option>
                                <option value="medium" selected>Ù…ØªÙˆØ³Ø·</option>
                                <option value="hard">ØµØ¹Ø¨</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn-main" onclick="generateBookQuizAI()" 
                            style="background:linear-gradient(90deg, #8b5cf6, #7c3aed);">
                        <i class="fas fa-magic"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø°ÙƒÙŠ
                    </button>
                </div>
            </div>
            
            <div id="quiz-results"></div>
            
            <div style="margin-top:30px; padding:20px; background:var(--bg-card); border-radius:15px;">
                <h4><i class="fas fa-lightbulb" style="color:var(--accent);"></i> ÙƒÙŠÙ ÙŠØ¹Ù…Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠØŸ</h4>
                <ul style="color:var(--text-sec); padding-right:20px; line-height:1.8;">
                    <li>ÙŠÙ‚ÙˆÙ… Ø¨ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø±</li>
                    <li>ÙŠÙ†Ø´Ø¦ Ø£Ø³Ø¦Ù„Ø© Ù…ØªÙ†ÙˆØ¹Ø© ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰</li>
                    <li>ÙŠÙ‚Ø¯Ù… ØªÙ‚Ø±ÙŠØ±Ø§Ù‹ Ù…ÙØµÙ„Ø§Ù‹ Ø¹Ù† Ø£Ø¯Ø§Ø¦Ùƒ</li>
                    <li>ÙŠØ­ÙØ¸ Ù†ØªØ§Ø¦Ø¬Ùƒ Ù„ØªØªØ¨Ø¹ ØªÙ‚Ø¯Ù…Ùƒ</li>
                </ul>
            </div>
        </div>`;
    
    loadAIBooks();
}

function renderVoiceAssistant() {
    const area = document.getElementById('content-area');
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius:20px; padding:25px; color:white; margin-bottom:25px;">
                <h2 style="margin-top:0;"><i class="fas fa-volume-up"></i> Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØµÙˆØªÙŠ</h2>
                <p>Ø§Ø³ØªÙ…Ø¹ Ø¥Ù„Ù‰ Ø´Ø±Ø­ ØµÙˆØªÙŠ Ù„Ù„ÙƒØªØ¨ ÙˆØ§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</p>
            </div>
            
            <div class="tts-container">
                <h3><i class="fas fa-microphone-alt" style="color:white;"></i> ØªÙˆÙ„ÙŠØ¯ Ø´Ø±Ø­ ØµÙˆØªÙŠ</h3>
                <div style="margin:15px 0;">
                    <textarea id="tts-text" rows="5" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ ØµÙˆØª... (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 1000 Ø­Ø±Ù)" style="width:100%;"></textarea>
                    <div style="display:flex; justify-content:space-between; margin-top:10px; color:white;">
                        <span id="char-count">0/1000 Ø­Ø±Ù</span>
                        <button onclick="generateVoice()" class="btn-main" style="background:white; color:#8b5cf6;">
                            <i class="fas fa-play"></i> ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØª
                        </button>
                    </div>
                </div>
                
                <div id="voice-output" style="display:none;">
                    <h4><i class="fas fa-headphones" style="color:white;"></i> Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹:</h4>
                    <div class="audio-player">
                        <button onclick="playVoice()" style="background:white; color:#8b5cf6; border:none; width:50px; height:50px; border-radius:50%; cursor:pointer; font-size:20px;">
                            <i class="fas fa-play"></i>
                        </button>
                        <div class="audio-controls">
                            <div class="audio-progress" onclick="seekVoice(event)">
                                <div class="audio-progress-bar" id="voice-progress"></div>
                            </div>
                            <span id="current-time">0:00</span> / <span id="total-time">0:00</span>
                        </div>
                        <button onclick="downloadVoice()" style="background:white; color:#8b5cf6; border:none; padding:10px 15px; border-radius:10px; cursor:pointer;">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div style="margin-top:30px;">
                <h3><i class="fas fa-book-reader" style="color:var(--accent);"></i> ÙƒØªØ¨ Ù…Ø¹ Ø´Ø±Ø­ ØµÙˆØªÙŠ</h3>
                <div id="audio-books" class="loading">
                    <div class="loading-spinner"></div>
                    <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ¨ Ø§Ù„ØµÙˆØªÙŠØ©...</div>
                </div>
            </div>
            
            <div style="margin-top:30px; padding:20px; background:var(--bg-card); border-radius:15px;">
                <h4><i class="fas fa-info-circle" style="color:var(--accent);"></i> ÙƒÙŠÙ ÙŠØ¹Ù…Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØµÙˆØªÙŠØŸ</h4>
                <ul style="color:var(--text-sec); padding-right:20px; line-height:1.8;">
                    <li>ÙŠØ­ÙˆÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø¥Ù„Ù‰ ÙƒÙ„Ø§Ù… Ø·Ø¨ÙŠØ¹ÙŠ</li>
                    <li>ÙŠØ¯Ø¹Ù… Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</li>
                    <li>ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø±Ø­ Ø§Ù„ØµÙˆØªÙŠ</li>
                    <li>ÙŠØ¶ÙŠÙ Ù†ØºÙ…Ø§Øª ØµÙˆØªÙŠØ© Ù…Ø®ØªÙ„ÙØ© Ù„Ù„ØªØ±ÙƒÙŠØ²</li>
                    <li>Ù…Ø«Ø§Ù„ÙŠ Ù„Ù„Ù…Ø°Ø§ÙƒØ±Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ†Ù‚Ù„</li>
                </ul>
            </div>
        </div>`;
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø­Ø±Ù
    document.getElementById('tts-text').addEventListener('input', function() {
        const count = this.value.length;
        document.getElementById('char-count').textContent = `${count}/1000 Ø­Ø±Ù`;
        if (count > 1000) {
            this.value = this.value.substring(0, 1000);
            document.getElementById('char-count').textContent = "1000/1000 Ø­Ø±Ù (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰)";
        }
    });
    
    loadAudioBooks();
}

function renderLiveRooms() {
    const area = document.getElementById('content-area');
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius:20px; padding:25px; color:white; margin-bottom:25px;">
                <h2 style="margin-top:0;"><i class="fas fa-video"></i> ØºØ±Ù Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h2>
                <p>Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø¯Ø±ÙˆØ³ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</p>
            </div>
            
            ${me.role === 'admin' || me.isTeacher ? `
            <div style="margin-bottom:25px;">
                <button class="btn-main" onclick="createLiveRoom()" style="background:var(--green);">
                    <i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¨Ø« Ø¬Ø¯ÙŠØ¯Ø©
                </button>
            </div>
            ` : ''}
            
            <div id="live-rooms" class="loading">
                <div class="loading-spinner"></div>
                <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØºØ±Ù Ø§Ù„Ø¨Ø«...</div>
            </div>
            
            <div style="margin-top:30px; padding:20px; background:var(--bg-card); border-radius:15px;">
                <h4><i class="fas fa-info-circle" style="color:var(--accent);"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø£Ø³Ø§ØªØ°Ø©:</h4>
                <div class="payment-method">
                    <p><strong>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</strong></p>
                    <ul style="color:var(--text-sec); padding-right:20px;">
                        <li>ÙŠÙ…ÙƒÙ† Ù„Ù„Ø£Ø³Ø§ØªØ°Ø© ÙˆØ¶Ø¹ Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨Ù‡Ù… ÙÙŠ ÙˆØµÙ Ø§Ù„ØºØ±ÙØ©</li>
                        <li>ÙŠØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø³ØªØ§Ø°</li>
                        <li>Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„ØŒ ÙŠØ±Ø³Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø´Ø¹Ø§Ø±Ø§Ù‹ Ù„Ù„Ø¥Ø¯Ù…Ù†</li>
                        <li>Ø§Ù„Ø¥Ø¯Ù…Ù† ÙŠØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¯ÙØ¹ Ø®Ù„Ø§Ù„ Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©</li>
                        <li>Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯ØŒ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¨Ø«</li>
                    </ul>
                    ${me.role === 'admin' ? `
                    <div style="margin-top:15px; padding:10px; background:rgba(0,0,0,0.3); border-radius:10px;">
                        <p><strong>Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¯Ù…Ù† Ù„Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª:</strong></p>
                        <p style="color:var(--accent); font-weight:bold;">Ø¨Ù†Ùƒ Ø§Ù„Ø®Ø±Ø·ÙˆÙ… - ${ADMIN_BANK_ACCOUNT}</p>
                    </div>
                    ` : ''}
                </div>
            </div>
        </div>`;
    
    loadLiveRooms();
}

function renderProfile() {
    const area = document.getElementById('content-area');
    const isFreeTrial = me.freeTrial && me.freeUntil > Date.now();
    
    area.innerHTML = `
        <div style="padding:20px; text-align:center;">
            <div style="position:relative; display:inline-block;">
                <img src="${me.photo || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" 
                     style="width:120px; height:120px; border-radius:50%; border:4px solid var(--neon-blue);">
                ${isFreeTrial ? `
                <div style="position:absolute; bottom:10px; right:-10px; background:var(--accent); color:black; padding:5px 10px; border-radius:15px; font-size:12px; font-weight:bold;">
                    <i class="fas fa-crown"></i> ØªØ¬Ø±Ø¨Ø© Ù…Ø¬Ø§Ù†ÙŠØ©
                </div>
                ` : ''}
            </div>
            
            <h2 style="margin-top:15px;">${me.name}</h2>
            <p style="color:var(--text-sec);">${me.email || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙŠØ¯'}</p>
            
            <div style="display:flex; justify-content:center; gap:10px; margin:20px 0;">
                <div style="background:rgba(59, 130, 246, 0.1); padding:15px; border-radius:15px; min-width:100px;">
                    <div style="font-size:14px; color:var(--text-sec);">Ø§Ù„Ø±ØªØ¨Ø©</div>
                    <div style="font-size:20px; font-weight:bold; color:var(--primary);">
                        ${me.role === 'admin' ? 'Ù…Ø¯ÙŠØ±' : me.isTeacher ? 'Ø£Ø³ØªØ§Ø°' : 'Ø·Ø§Ù„Ø¨'}
                    </div>
                </div>
                
                <div style="background:rgba(245, 158, 11, 0.1); padding:15px; border-radius:15px; min-width:100px;">
                    <div style="font-size:14px; color:var(--text-sec);">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</div>
                    <div style="font-size:20px; font-weight:bold; color:var(--accent);">
                        ${(me.rating || 0).toFixed(1)} â­
                    </div>
                </div>
            </div>
            
            <div style="background:var(--bg-card); padding:20px; border-radius:15px; margin:20px 0; text-align:right;">
                <h4 style="color:var(--neon-blue); margin-top:0;"><i class="fas fa-wallet"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h4>
                
                <div style="margin:15px 0;">
                    <div style="display:flex; justify-content:space-between; margin:10px 0;">
                        <span style="color:var(--text-sec);">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªÙˆÙØ±:</span>
                        <span style="font-weight:bold; color:var(--accent);">${me.balance || 0} SDM</span>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; margin:10px 0;">
                        <span style="color:var(--text-sec);">Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ:</span>
                        <span style="font-weight:bold; color:${me.subscription ? 'var(--green)' : 'var(--red)'}">
                            ${me.subscription ? 'Ù…ÙØ¹Ù„' : 'ØºÙŠØ± Ù…ÙØ¹Ù„'}
                        </span>
                    </div>
                    
                    ${isFreeTrial ? `
                    <div style="display:flex; justify-content:space-between; margin:10px 0;">
                        <span style="color:var(--text-sec);">Ø§Ù„ØªØ¬Ø±Ø¨Ø© ØªÙ†ØªÙ‡ÙŠ Ø¨Ø¹Ø¯:</span>
                        <span style="font-weight:bold; color:var(--accent);">
                            ${Math.ceil((me.freeUntil - Date.now()) / (1000 * 60 * 60))} Ø³Ø§Ø¹Ø©
                        </span>
                    </div>
                    ` : ''}
                    
                    <div style="display:flex; justify-content:space-between; margin:10px 0;">
                        <span style="color:var(--text-sec);">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…:</span>
                        <span style="font-weight:bold;">${formatDate(me.joinDate)}</span>
                    </div>
                </div>
                
                <button class="btn-main" onclick="nav('subscription')">
                    <i class="fas fa-crown"></i> ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
                </button>
            </div>
            
            ${me.isTeacher ? `
            <div style="background:rgba(139, 92, 246, 0.1); padding:20px; border-radius:15px; margin:20px 0; text-align:right; border:2px solid var(--purple);">
                <h4 style="color:var(--purple); margin-top:0;"><i class="fas fa-chalkboard-teacher"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³ØªØ§Ø°</h4>
                <p style="color:var(--text-sec);">Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨Ùƒ Ù„Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª:</p>
                <p style="color:var(--accent); font-weight:bold; font-size:18px;">${me.teacherAccount || 'Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨'}</p>
                <button class="btn-secondary" onclick="updateTeacherAccount()" style="margin-top:10px;">
                    <i class="fas fa-edit"></i> ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨
                </button>
            </div>
            ` : ''}
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-main" onclick="doLogout()" style="background:var(--red); flex:1;">
                    <i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
                </button>
                
                ${me.role === 'admin' ? `
                <button class="btn-main" onclick="nav('admin')" style="background:var(--purple); flex:1;">
                    <i class="fas fa-cogs"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                </button>
                ` : ''}
            </div>
        </div>`;
}

function renderAdminPanel() {
    if (me.role !== 'admin') {
        nav('home');
        return;
    }
    
    const area = document.getElementById('content-area');
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div class="admin-panel">
                <h2 style="color:var(--red);"><i class="fas fa-crown"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ù…Ù†</h2>
                <p style="color:var(--text-sec);">Ù…Ø±Ø­Ø¨Ø§ ${me.name}ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ù† Ù‡Ù†Ø§</p>
            </div>
            
            <div style="margin:25px 0;">
                <h3><i class="fas fa-tasks" style="color:var(--accent);"></i> Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</h3>
                <div class="grid">
                    <div class="card" onclick="manageBooks()">
                        <i class="fas fa-book" style="color:var(--primary)"></i>
                        <b>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØªØ¨</b>
                        <p style="font-size:12px; color:var(--text-sec)">Ø¹Ø±Ø¶ØŒ ØªØ¹Ø¯ÙŠÙ„ØŒ Ø­Ø°Ù Ø§Ù„ÙƒØªØ¨</p>
                    </div>
                    
                    <div class="card" onclick="manageUsers()">
                        <i class="fas fa-users" style="color:var(--green)"></i>
                        <b>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</b>
                        <p style="font-size:12px; color:var(--text-sec)">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„Ø£Ø³Ø§ØªØ°Ø©</p>
                    </div>
                    
                    <div class="card" onclick="managePayments()">
                        <i class="fas fa-money-bill-wave" style="color:var(--accent)"></i>
                        <b>Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</b>
                        <p style="font-size:12px; color:var(--text-sec)">ØªØ£ÙƒÙŠØ¯ Ø£Ùˆ Ø±ÙØ¶ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª</p>
                    </div>
                    
                    <div class="card" onclick="manageSubscriptions()">
                        <i class="fas fa-crown" style="color:var(--purple)"></i>
                        <b>Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</b>
                        <p style="font-size:12px; color:var(--text-sec)">Ø¥Ø¯Ø§Ø±Ø© Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</p>
                    </div>
                </div>
            </div>
            
            <div style="background:var(--bg-card); padding:20px; border-radius:15px; margin:25px 0;">
                <h4><i class="fas fa-university" style="color:var(--accent);"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¯Ù…Ù†</h4>
                <div style="padding:15px; background:rgba(0,0,0,0.3); border-radius:10px; margin-top:10px;">
                    <p><strong>Ø¨Ù†Ùƒ Ø§Ù„Ø®Ø±Ø·ÙˆÙ… Ù„Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª:</strong></p>
                    <p style="color:var(--neon-blue); font-size:24px; font-weight:bold; text-align:center; margin:10px 0;">
                        ${ADMIN_BANK_ACCOUNT}
                    </p>
                    <p style="color:var(--text-sec); font-size:12px; text-align:center;">
                        Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¯Ù…Ù† Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª
                    </p>
                </div>
            </div>
            
            <div style="margin-top:30px;">
                <h3><i class="fas fa-chart-bar" style="color:var(--accent);"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h3>
                <div id="admin-stats" class="loading">
                    <div class="loading-spinner"></div>
                    <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...</div>
                </div>
            </div>
        </div>`;
    
    loadAdminStats();
}

function renderAddBook() {
    const area = document.getElementById('content-area');
    const isAdmin = me.role === 'admin';
    
    area.innerHTML = `
        <div style="padding:20px;">
            <h2 style="color:var(--neon-blue);"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
            <p style="color:var(--text-sec); margin-bottom:25px;">${isAdmin ? 'ÙƒØ¥Ø¯Ù…Ù†ØŒ Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„ÙƒØªØ§Ø¨ Ù„Ù„Ø¬Ù…ÙŠØ¹ ÙÙˆØ±Ø§Ù‹' : 'Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„ÙƒØªØ§Ø¨ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù†Ø´Ø±'}</p>
            
            <div style="background:var(--bg-card); padding:25px; border-radius:20px;">
                <form id="add-book-form" onsubmit="return submitBookForm(event)">
                    <div style="margin-bottom:20px;">
                        <label style="display:block; margin-bottom:8px; color:var(--accent);">
                            <i class="fas fa-heading"></i> Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨ *
                        </label>
                        <input type="text" id="book-title" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨" required>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label style="display:block; margin-bottom:8px; color:var(--accent);">
                            <i class="fas fa-user"></i> Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù *
                        </label>
                        <input type="text" id="book-author" placeholder="Ø§Ø³Ù… Ù…Ø¤Ù„Ù Ø§Ù„ÙƒØªØ§Ø¨" required>
                    </div>
                    
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:20px;">
                        <div>
                            <label style="display:block; margin-bottom:8px; color:var(--accent);">
                                <i class="fas fa-graduation-cap"></i> Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ *
                            </label>
                            <select id="book-grade" required>
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
                                ${ALL_GRADES.map(g => `<option value="${g.name}">${g.name}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label style="display:block; margin-bottom:8px; color:var(--accent);">
                                <i class="fas fa-book-open"></i> Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© *
                            </label>
                            <select id="book-subject" required>
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>
                                ${SUBJECTS.map(s => `<option value="${s}">${s}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:20px;">
                        <div>
                            <label style="display:block; margin-bottom:8px; color:var(--accent);">
                                <i class="fas fa-tag"></i> Ø§Ù„Ø³Ø¹Ø± (SDM)
                            </label>
                            <input type="number" id="book-price" placeholder="0 Ù„Ù„Ù…Ø¬Ø§Ù†ÙŠ" min="0" value="0">
                        </div>
                        
                        <div>
                            <label style="display:block; margin-bottom:8px; color:var(--accent);">
                                <i class="fas fa-file-pdf"></i> Ø·Ø±ÙŠÙ‚Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØªØ§Ø¨
                            </label>
                            <select id="upload-method" class="swal2-input" onchange="toggleUploadMethod()">
                                <option value="link">Ø¥Ø¶Ø§ÙØ© Ø±Ø§Ø¨Ø·</option>
                                <option value="upload" selected>Ø±ÙØ¹ Ù…Ù† Ø§Ù„Ù‡Ø§ØªÙ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="link-upload" style="display:none; margin-bottom:20px;">
                        <label style="display:block; margin-bottom:8px; color:var(--accent);">
                            <i class="fas fa-link"></i> Ø±Ø§Ø¨Ø· Ø§Ù„ÙƒØªØ§Ø¨ (PDF)
                        </label>
                        <input type="url" id="book-url" placeholder="Ø±Ø§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨">
                    </div>
                    
                    <div id="file-upload" style="margin-bottom:20px;">
                        <label style="display:block; margin-bottom:8px; color:var(--accent);">
                            <i class="fas fa-cloud-upload-alt"></i> Ø±ÙØ¹ Ø§Ù„ÙƒØªØ§Ø¨ Ù…Ù† Ù‡Ø§ØªÙÙƒ
                        </label>
                        <div class="file-upload-area" onclick="document.getElementById('book-file').click()" id="file-drop-area">
                            <i class="fas fa-file-upload" style="font-size:48px; color:var(--accent); margin-bottom:15px;"></i>
                            <h4 style="color:var(--accent);">Ø§Ù†Ù‚Ø± Ø£Ùˆ Ø§Ø³Ø­Ø¨ Ù„Ø±ÙØ¹ Ø§Ù„ÙƒØªØ§Ø¨</h4>
                            <p style="color:var(--text-sec); margin:10px 0;">ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª PDF Ø£Ùˆ ØµÙˆØ±</p>
                            <p style="color:var(--text-sec); font-size:12px;">Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£Ù‚ØµÙ‰: 10MB</p>
                            <input type="file" id="book-file" accept=".pdf,.jpg,.jpeg,.png" style="display:none;" onchange="handleFileUpload(event)">
                        </div>
                        <div id="uploaded-file-info" class="uploaded-file" style="display:none;">
                            <i class="fas fa-file-pdf" style="font-size:32px; color:var(--accent);"></i>
                            <div style="flex:1;">
                                <div style="font-weight:bold;" id="file-name"></div>
                                <div style="font-size:12px; color:var(--text-sec);" id="file-size"></div>
                                <div style="font-size:11px; color:var(--green);" id="upload-status"></div>
                            </div>
                            <button type="button" class="btn-danger" onclick="removeUploadedFile()" style="width:auto; padding:8px 12px;">
                                <i class="fas fa-trash"></i> Ø¥Ø²Ø§Ù„Ø©
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label style="display:block; margin-bottom:8px; color:var(--accent);">
                            <i class="fas fa-image"></i> Ø±ÙØ¹ ØºÙ„Ø§Ù Ø§Ù„ÙƒØªØ§Ø¨
                        </label>
                        <div class="file-upload-area" onclick="document.getElementById('cover-file').click()" id="cover-drop-area">
                            <i class="fas fa-image" style="font-size:48px; color:var(--accent); margin-bottom:15px;"></i>
                            <h4 style="color:var(--accent);">Ø§Ù†Ù‚Ø± Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù</h4>
                            <p style="color:var(--text-sec); margin:10px 0;">Ø§Ù„ØµÙŠØº Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©: JPG, PNG</p>
                            <p style="color:var(--text-sec); font-size:12px;">Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ø£Ù‚ØµÙ‰: 5MB</p>
                            <input type="file" id="cover-file" accept=".jpg,.jpeg,.png" style="display:none;" onchange="handleCoverUpload(event)">
                        </div>
                        <div id="uploaded-cover-info" class="uploaded-file" style="display:none;">
                            <img id="cover-preview" src="" style="width:60px; height:80px; border-radius:8px; object-fit:cover;">
                            <div style="flex:1;">
                                <div style="font-weight:bold;" id="cover-name"></div>
                                <div style="font-size:12px; color:var(--text-sec);" id="cover-size"></div>
                                <div style="font-size:11px; color:var(--green);" id="cover-status"></div>
                            </div>
                            <button type="button" class="btn-danger" onclick="removeUploadedCover()" style="width:auto; padding:8px 12px;">
                                <i class="fas fa-trash"></i> Ø¥Ø²Ø§Ù„Ø©
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label style="display:block; margin-bottom:8px; color:var(--accent);">
                            <i class="fas fa-align-left"></i> ÙˆØµÙ Ø§Ù„ÙƒØªØ§Ø¨
                        </label>
                        <textarea id="book-description" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ± Ù„Ù„ÙƒØªØ§Ø¨..." rows="3"></textarea>
                    </div>
                    
                    <div style="display:flex; gap:10px;">
                        <button type="submit" class="btn-main" style="background:var(--green);">
                            <i class="fas fa-check"></i> ${isAdmin ? 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØªØ§Ø¨' : 'Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'}
                        </button>
                        <button type="button" class="btn-secondary" onclick="nav('library')">
                            <i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡
                        </button>
                    </div>
                </form>
            </div>
            
            <div style="margin-top:30px; padding:20px; background:var(--bg-card); border-radius:15px;">
                <h4><i class="fas fa-info-circle" style="color:var(--accent);"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</h4>
                <ul style="color:var(--text-sec); padding-right:20px;">
                    <li>${isAdmin ? 'Ø§Ù„ÙƒØªØ¨ Ø§Ù„ØªÙŠ ØªØ¶ÙŠÙÙ‡Ø§ ØªØ¸Ù‡Ø± ÙÙˆØ±Ø§Ù‹ Ù„Ù„Ø¬Ù…ÙŠØ¹' : 'Ø§Ù„ÙƒØªØ¨ ØªØ­ØªØ§Ø¬ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ø¥Ø¯Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¸Ù‡ÙˆØ±'}</li>
                    <li>ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ÙƒØªØ¨ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ù†Ù‡Ø¬ ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</li>
                    <li>Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ Ù„Ù„ØªØ­Ù…ÙŠÙ„</li>
                    <li>Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© ØªØªØ·Ù„Ø¨ Ø±ØµÙŠØ¯ SDM</li>
                    <li>ÙŠØ¯Ø¹Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø¨Ø§Ø´Ø±Ø©</li>
                </ul>
            </div>
        </div>`;
}

function renderSubscription() {
    const area = document.getElementById('content-area');
    
    area.innerHTML = `
        <div style="padding:20px; text-align:center;">
            <h2 style="color:var(--accent);"><i class="fas fa-crown"></i> Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h2>
            <p style="color:var(--text-sec); margin-bottom:30px;">Ø§Ø®ØªØ± Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</p>
            
            <div class="grid">
                <div class="card" style="border:2px solid var(--text-sec);">
                    <h3>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h3>
                    <div style="font-size:32px; font-weight:bold; color:var(--text-sec);">7 SDM</div>
                    <p style="font-size:12px; color:var(--text-sec);">7 Ø£ÙŠØ§Ù… ÙƒØ§Ù…Ù„Ø©</p>
                    <ul style="text-align:right; padding-right:15px; color:var(--text-sec); font-size:12px; line-height:1.8;">
                        <li>Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</li>
                        <li>5 Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø°ÙƒÙŠØ©</li>
                        <li>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù€ 3 Ø¨Ø«ÙˆØ« Ù…Ø¨Ø§Ø´Ø±Ø©</li>
                    </ul>
                    <button class="btn-main" onclick="buySubscription('weekly', 7)" ${me.balance < 7 ? 'disabled style="opacity:0.5;"' : ''}>
                        ${me.balance < 7 ? 'Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ' : 'Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù†'}
                    </button>
                </div>
                
                <div class="card" style="border:2px solid var(--accent); transform: scale(1.05);">
                    <div style="position:absolute; top:10px; left:10px; background:var(--accent); color:black; padding:3px 8px; border-radius:5px; font-size:10px; font-weight:bold;">
                        Ø§Ù„Ø£ÙØ¶Ù„
                    </div>
                    <h3>Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
                    <div style="font-size:42px; font-weight:bold; color:var(--accent);">25 SDM</div>
                    <p style="font-size:12px; color:var(--text-sec);">30 ÙŠÙˆÙ…Ø§Ù‹ (ÙˆÙØ± 3 SDM)</p>
                    <ul style="text-align:right; padding-right:15px; color:var(--text-sec); font-size:12px; line-height:1.8;">
                        <li>Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</li>
                        <li>Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø°ÙƒÙŠØ© ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©</li>
                        <li>Ø¨Ø«ÙˆØ« Ù…Ø¨Ø§Ø´Ø±Ø© ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©</li>
                        <li>Ø¥Ø¶Ø§ÙØ© ÙƒØªØ¨ ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©</li>
                        <li>Ø£ÙˆÙ„ÙˆÙŠØ© Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ</li>
                    </ul>
                    <button class="btn-main" onclick="buySubscription('monthly', 25)" 
                            style="background:var(--accent); color:black;" ${me.balance < 25 ? 'disabled style="opacity:0.5;"' : ''}>
                        ${me.balance < 25 ? 'Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ' : 'Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù†'}
                    </button>
                </div>
                
                <div class="card" style="border:2px solid var(--purple);">
                    <h3>Ø§Ù„Ø³Ù†ÙˆÙŠ</h3>
                    <div style="font-size:32px; font-weight:bold; color:var(--purple);">250 SDM</div>
                    <p style="font-size:12px; color:var(--text-sec);">365 ÙŠÙˆÙ…Ø§Ù‹ (ÙˆÙØ± 50 SDM)</p>
                    <ul style="text-align:right; padding-right:15px; color:var(--text-sec); font-size:12px; line-height:1.8;">
                        <li>ÙƒÙ„ Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠ</li>
                        <li>Ø®ØµÙ… 10% Ø¹Ù„Ù‰ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</li>
                        <li>Ø­Ø³Ø§Ø¨ Ø£Ø³ØªØ§Ø° Ù…Ø¬Ø§Ù†ÙŠ</li>
                        <li>Ø¯Ø¹Ù… ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± Ø§Ù„Ø³Ø§Ø¹Ø©</li>
                    </ul>
                    <button class="btn-main" onclick="buySubscription('yearly', 250)" 
                            style="background:var(--purple);" ${me.balance < 250 ? 'disabled style="opacity:0.5;"' : ''}>
                        ${me.balance < 250 ? 'Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙŠ' : 'Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù†'}
                    </button>
                </div>
            </div>
            
            <div style="margin-top:40px; text-align:right; padding:20px; background:var(--bg-card); border-radius:15px;">
                <h4 style="color:var(--neon-blue);"><i class="fas fa-university"></i> Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹:</h4>
                <div class="payment-method">
                    <p><strong>Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ:</strong></p>
                    <div style="padding:15px; background:rgba(0,0,0,0.3); border-radius:10px; margin:10px 0;">
                        <p style="color:var(--accent); font-weight:bold; font-size:20px;">Ø¨Ù†Ùƒ Ø§Ù„Ø®Ø±Ø·ÙˆÙ…</p>
                        <p style="color:var(--neon-blue); font-size:24px; font-weight:bold; margin:10px 0;">${ADMIN_BANK_ACCOUNT}</p>
                        <p style="color:var(--text-sec); font-size:14px;">Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¯Ù…Ù† - ${ADMIN_EMAIL}</p>
                    </div>
                    
                    <p style="margin-top:20px;"><strong>Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¯ÙØ¹:</strong></p>
                    <ol style="color:var(--text-sec); padding-right:20px; line-height:2;">
                        <li>Ù‚Ù… Ø¨Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ø¹Ù„Ø§Ù‡</li>
                        <li>Ø§Ø­ÙØ¸ ØµÙˆØ±Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ</li>
                        <li>Ø£Ø±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Ù‹ Ù„Ù„Ø¥Ø¯Ù…Ù† Ø¹Ø¨Ø± Ø§Ù„Ù†Ø¸Ø§Ù…</li>
                        <li>Ø§Ù†ØªØ¸Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¯Ù…Ù† (Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©)</li>
                        <li>Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø­Ø³Ø§Ø¨Ùƒ</li>
                    </ol>
                </div>
                
                <button class="btn-main" onclick="sendPaymentNotification()" style="margin-top:20px;">
                    <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¯ÙØ¹ Ù„Ù„Ø¥Ø¯Ù…Ù†
                </button>
            </div>
            
            <div style="margin-top:30px;">
                <h4><i class="fas fa-coins" style="color:var(--accent);"></i> Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</h4>
                <div style="background:linear-gradient(135deg, #10b981 0%, #059669 100%); padding:25px; border-radius:15px; color:white; margin-top:15px;">
                    <div style="font-size:14px;">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªÙˆÙØ±</div>
                    <div style="font-size:48px; font-weight:bold;">${me.balance || 0} SDM</div>
                    ${me.balance < 25 ? `
                    <p style="margin-top:10px;">ØªØ­ØªØ§Ø¬ ${25 - me.balance} SDM Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ</p>
                    ` : ''}
                </div>
            </div>
        </div>`;
}

// ==================== [ 8. Ø¯ÙˆØ§Ù„ Ø§Ù„ÙƒØªØ¨ ] ====================
async function loadAllBooks() {
    const container = document.getElementById('books-list');
    if (!container) return;
    
    db.ref('books').on('value', snap => {
        const books = snap.val();
        container.innerHTML = '';
        
        if (!books || Object.keys(books).length === 0) {
            container.innerHTML = `
                <div style="text-align:center; padding:40px; color:var(--text-sec);">
                    <i class="fas fa-book" style="font-size:48px; margin-bottom:15px; opacity:0.5;"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¨Ø¹Ø¯</p>
                    <button class="btn-main" onclick="nav('add_book')" style="margin-top:15px; width:auto;">
                        <i class="fas fa-plus"></i> ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ¶ÙŠÙ ÙƒØªØ§Ø¨Ø§Ù‹
                    </button>
                </div>`;
            return;
        }
        
        let booksArray = Object.entries(books).map(([id, book]) => ({ id, ...book }));
        
        // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØµÙ
        const gradeFilter = document.getElementById('filter-grade')?.value;
        if (gradeFilter) {
            booksArray = booksArray.filter(book => book.grade === gradeFilter);
        }
        
        // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø©
        const subjectFilter = document.getElementById('filter-subject')?.value;
        if (subjectFilter) {
            booksArray = booksArray.filter(book => book.subject === subjectFilter);
        }
        
        // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø±
        const priceFilter = document.getElementById('filter-price')?.value;
        if (priceFilter === 'free') {
            booksArray = booksArray.filter(book => !book.price || book.price === 0);
        } else if (priceFilter === 'paid') {
            booksArray = booksArray.filter(book => book.price && book.price > 0);
        }
        
        booksArray.forEach(book => {
            const priceBadge = book.price > 0 ? 
                `<span style="background:var(--accent); color:black; padding:3px 8px; border-radius:5px; font-size:11px; font-weight:bold;">${book.price} SDM</span>` :
                `<span style="background:var(--green); color:white; padding:3px 8px; border-radius:5px; font-size:11px; font-weight:bold;">Ù…Ø¬Ø§Ù†ÙŠ</span>`;
            
            container.innerHTML += `
                <div class="book-card">
                    <img src="${book.coverUrl || 'https://cdn-icons-png.flaticon.com/512/3523/3523063.png'}" 
                         class="book-cover">
                    <div style="flex:1;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div>
                                <div style="font-weight:bold; font-size:16px; margin-bottom:5px;">${book.title}</div>
                                <div style="font-size:12px; color:var(--text-sec); margin-bottom:5px;">
                                    <i class="fas fa-user"></i> ${book.author}
                                </div>
                            </div>
                            ${priceBadge}
                        </div>
                        
                        <div style="font-size:11px; color:var(--text-sec); margin-top:8px;">
                            <span class="grade-badge">${book.grade}</span>
                            <span style="background:rgba(59, 130, 246, 0.2); color:var(--primary); padding:3px 8px; border-radius:5px; margin-right:5px;">
                                ${book.subject}
                            </span>
                        </div>
                        
                        ${book.description ? `
                        <div style="font-size:11px; color:var(--text-sec); margin-top:8px; line-height:1.4;">
                            ${book.description.substring(0, 60)}${book.description.length > 60 ? '...' : ''}
                        </div>
                        ` : ''}
                    </div>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <button class="btn-main" style="padding:8px 12px; font-size:12px;" 
                                onclick="nav('book_detail', '${book.id}')">
                            <i class="fas fa-eye"></i> Ø¹Ø±Ø¶
                        </button>
                        <button class="btn-main" style="padding:8px 12px; font-size:12px; background:var(--purple);" 
                                onclick="selectBookForAI('${book.id}', '${book.title.replace(/'/g, "\\'")}')">
                            <i class="fas fa-robot"></i> Ø§Ø®ØªØ¨Ø§Ø±
                        </button>
                        ${me.role === 'admin' ? `
                        <button class="btn-danger" style="padding:8px 12px; font-size:12px;" 
                                onclick="deleteBook('${book.id}', '${book.title.replace(/'/g, "\\'")}')">
                            <i class="fas fa-trash"></i> Ø­Ø°Ù
                        </button>
                        ` : ''}
                    </div>
                </div>`;
        });
    });
}

function loadBooksByGrade(gradeId, gradeName) {
    const area = document.getElementById('content-area');
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
                <button class="btn-secondary" onclick="nav('grades')" style="width:auto; padding:10px 15px;">
                    <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©
                </button>
                <h2 style="color:var(--neon-blue); margin:0;">ÙƒØªØ¨ ${gradeName}</h2>
            </div>
            
            <div id="grade-books" class="loading">
                <div class="loading-spinner"></div>
                <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ÙƒØªØ¨ ${gradeName}...</div>
            </div>
        </div>`;
    
    db.ref('books').orderByChild('grade').equalTo(gradeName).on('value', snap => {
        const books = snap.val();
        const container = document.getElementById('grade-books');
        container.innerHTML = '';
        
        if (!books) {
            container.innerHTML = `
                <div style="text-align:center; padding:40px; color:var(--text-sec);">
                    <i class="fas fa-book" style="font-size:48px; margin-bottom:15px; opacity:0.5;"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ Ø¨Ø¹Ø¯</p>
                    <button class="btn-main" onclick="nav('add_book')" style="margin-top:15px;">
                        <i class="fas fa-plus"></i> Ø£Ø¶Ù Ø£ÙˆÙ„ ÙƒØªØ§Ø¨ Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ
                    </button>
                </div>`;
            return;
        }
        
        Object.entries(books).forEach(([bookId, book]) => {
            container.innerHTML += `
                <div class="book-card">
                    <img src="${book.coverUrl || 'https://cdn-icons-png.flaticon.com/512/3523/3523063.png'}" 
                         class="book-cover">
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size:16px;">${book.title}</div>
                        <div style="font-size:12px; color:var(--text-sec);">
                            <i class="fas fa-user"></i> ${book.author} â€¢ 
                            <i class="fas fa-book-open"></i> ${book.subject}
                        </div>
                        <div style="font-size:11px; color:var(--accent); margin-top:5px;">
                            ${book.price > 0 ? book.price + ' SDM' : 'Ù…Ø¬Ø§Ù†ÙŠ'}
                        </div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <button class="btn-main" style="padding:8px 12px; font-size:12px;" 
                                onclick="nav('book_detail', '${bookId}')">
                            <i class="fas fa-eye"></i> Ø¹Ø±Ø¶
                        </button>
                        <button class="btn-main" style="padding:8px 12px; font-size:12px; background:var(--purple);" 
                                onclick="selectBookForAI('${bookId}', '${book.title.replace(/'/g, "\\'")}')">
                            <i class="fas fa-robot"></i> Ø¨ÙˆØª
                        </button>
                    </div>
                </div>`;
        });
    });
}

async function loadBookDetail(bookId) {
    const bookSnap = await db.ref(`books/${bookId}`).once('value');
    const book = bookSnap.val();
    
    if (!book) {
        showError('Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        nav('library');
        return;
    }
    
    const area = document.getElementById('content-area');
    const canDownload = me.freeTrial || me.balance >= (book.price || 0) || book.price === 0;
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
                <button class="btn-secondary" onclick="nav('library')" style="width:auto; padding:10px 15px;">
                    <i class="fas fa-arrow-right"></i> Ø§Ù„Ø¹ÙˆØ¯Ø©
                </button>
                <h2 style="color:var(--neon-blue); margin:0;">${book.title}</h2>
            </div>
            
            <div style="display:flex; flex-direction:column; align-items:center; margin-bottom:30px;">
                <img src="${book.coverUrl || 'https://cdn-icons-png.flaticon.com/512/3523/3523063.png'}" 
                     style="width:200px; height:260px; border-radius:15px; border:3px solid var(--accent); box-shadow:var(--shadow);">
            </div>
            
            <div class="post" style="padding:25px;">
                <h3 style="color:var(--accent); margin-top:0;"><i class="fas fa-info-circle"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨</h3>
                <div style="line-height:2.5;">
                    <div style="display:flex;">
                        <strong style="width:150px; color:var(--text-sec);">Ø§Ù„Ù…Ø¤Ù„Ù:</strong>
                        <span>${book.author}</span>
                    </div>
                    <div style="display:flex;">
                        <strong style="width:150px; color:var(--text-sec);">Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</strong>
                        <span>${book.grade}</span>
                    </div>
                    <div style="display:flex;">
                        <strong style="width:150px; color:var(--text-sec);">Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</strong>
                        <span>${book.subject}</span>
                    </div>
                    <div style="display:flex;">
                        <strong style="width:150px; color:var(--text-sec);">Ø§Ù„Ø³Ø¹Ø±:</strong>
                        <span style="color:${book.price > 0 ? 'var(--accent)' : 'var(--green)'}; font-weight:bold;">
                            ${book.price > 0 ? book.price + ' SDM' : 'Ù…Ø¬Ø§Ù†ÙŠ'}
                        </span>
                    </div>
                    <div style="display:flex;">
                        <strong style="width:150px; color:var(--text-sec);">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©:</strong>
                        <span>${formatDate(book.uploadDate)}</span>
                    </div>
                    ${book.addedBy ? `
                    <div style="display:flex;">
                        <strong style="width:150px; color:var(--text-sec);">Ø£Ø¶ÙŠÙ Ø¨ÙˆØ§Ø³Ø·Ø©:</strong>
                        <span>${book.addedByName}</span>
                    </div>
                    ` : ''}
                </div>
                
                ${book.description ? `
                <div style="margin-top:25px;">
                    <h4 style="color:var(--text-sec);"><i class="fas fa-align-left"></i> ÙˆØµÙ Ø§Ù„ÙƒØªØ§Ø¨</h4>
                    <p style="color:var(--text-main); line-height:1.8; padding:15px; background:rgba(0,0,0,0.2); border-radius:10px;">
                        ${book.description}
                    </p>
                </div>
                ` : ''}
            </div>
            
            <div style="display:flex; gap:10px; margin-top:30px; flex-wrap:wrap;">
                <button class="btn-main" onclick="downloadBook('${bookId}', ${book.price || 0}, '${book.bookUrl || ''}')" 
                        ${!canDownload ? 'disabled style="opacity:0.5;"' : ''}
                        style="flex:1; min-width:150px;">
                    <i class="fas fa-download"></i> ${book.price > 0 ? `ØªØ­Ù…ÙŠÙ„ (${book.price} SDM)` : 'ØªØ­Ù…ÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ'}
                </button>
                
                <button class="btn-main" onclick="selectBookForAI('${bookId}', '${book.title.replace(/'/g, "\\'")}')" 
                        style="flex:1; min-width:150px; background:var(--purple);">
                    <i class="fas fa-robot"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø°ÙƒÙŠ
                </button>
                
                ${book.bookUrl ? `
                <button class="btn-main" onclick="explainBookWithAI('${bookId}', '${book.title.replace(/'/g, "\\'")}')" 
                        style="flex:1; min-width:150px; background:var(--accent); color:black;">
                    <i class="fas fa-volume-up"></i> Ø´Ø±Ø­ ØµÙˆØªÙŠ
                </button>
                ` : ''}
                
                ${me.role === 'admin' ? `
                <button class="btn-danger" onclick="deleteBook('${bookId}', '${book.title.replace(/'/g, "\\'")}')" 
                        style="flex:1; min-width:150px;">
                    <i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨
                </button>
                ` : ''}
            </div>
        </div>`;
}

// ==================== [ 9. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ø§Ù„Ù‡Ø§ØªÙ ] ====================
let uploadedBookFile = null;
let uploadedCoverFile = null;

function toggleUploadMethod() {
    const method = document.getElementById('upload-method').value;
    const linkUpload = document.getElementById('link-upload');
    const fileUpload = document.getElementById('file-upload');
    
    if (method === 'link') {
        linkUpload.style.display = 'block';
        fileUpload.style.display = 'none';
        // Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙˆØ¹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        uploadedBookFile = null;
        document.getElementById('uploaded-file-info').style.display = 'none';
    } else {
        linkUpload.style.display = 'none';
        fileUpload.style.display = 'block';
        // Ø­Ø°Ù Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        document.getElementById('book-url').value = '';
    }
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
    const validTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
    if (!validTypes.includes(file.type)) {
        showError('Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ Ù…Ù„Ù PDF Ø£Ùˆ ØµÙˆØ±Ø©');
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (10MB)
    if (file.size > 10 * 1024 * 1024) {
        showError('Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10MB');
        return;
    }
    
    uploadedBookFile = file;
    
    // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù„Ù
    document.getElementById('file-name').textContent = file.name;
    document.getElementById('file-size').textContent = formatFileSize(file.size);
    document.getElementById('upload-status').textContent = 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ø±ÙØ¹';
    document.getElementById('uploaded-file-info').style.display = 'flex';
    
    // ØªØºÙŠÙŠØ± Ù†Ù…Ø· Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³Ø­Ø¨
    document.getElementById('file-drop-area').style.borderColor = 'var(--green)';
    document.getElementById('file-drop-area').style.background = 'rgba(16, 185, 129, 0.1)';
}

function handleCoverUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù
    const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
    if (!validTypes.includes(file.type)) {
        showError('Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…. ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ ØµÙˆØ±Ø© JPG Ø£Ùˆ PNG');
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù (5MB)
    if (file.size > 5 * 1024 * 1024) {
        showError('Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5MB');
        return;
    }
    
    uploadedCoverFile = file;
    
    // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙˆØ±Ø©
    document.getElementById('cover-name').textContent = file.name;
    document.getElementById('cover-size').textContent = formatFileSize(file.size);
    document.getElementById('cover-status').textContent = 'Ø¬Ø§Ù‡Ø² Ù„Ù„Ø±ÙØ¹';
    
    // Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('cover-preview').src = e.target.result;
    };
    reader.readAsDataURL(file);
    
    document.getElementById('uploaded-cover-info').style.display = 'flex';
    
    // ØªØºÙŠÙŠØ± Ù†Ù…Ø· Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³Ø­Ø¨
    document.getElementById('cover-drop-area').style.borderColor = 'var(--green)';
    document.getElementById('cover-drop-area').style.background = 'rgba(16, 185, 129, 0.1)';
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' Ø¨Ø§ÙŠØª';
    else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' ÙƒÙŠÙ„ÙˆØ¨Ø§ÙŠØª';
    else return (bytes / 1048576).toFixed(1) + ' Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª';
}

function removeUploadedFile() {
    uploadedBookFile = null;
    document.getElementById('book-file').value = '';
    document.getElementById('uploaded-file-info').style.display = 'none';
    document.getElementById('file-drop-area').style.borderColor = 'var(--accent)';
    document.getElementById('file-drop-area').style.background = 'rgba(245, 158, 11, 0.05)';
}

function removeUploadedCover() {
    uploadedCoverFile = null;
    document.getElementById('cover-file').value = '';
    document.getElementById('uploaded-cover-info').style.display = 'none';
    document.getElementById('cover-drop-area').style.borderColor = 'var(--accent)';
    document.getElementById('cover-drop-area').style.background = 'rgba(245, 158, 11, 0.05)';
}

// ==================== [ 10. Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØªØ¨ Ù…Ø¹ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ] ====================
async function submitBookForm(event) {
    event.preventDefault();
    
    const title = document.getElementById('book-title').value.trim();
    const author = document.getElementById('book-author').value.trim();
    const grade = document.getElementById('book-grade').value;
    const subject = document.getElementById('book-subject').value;
    const price = parseInt(document.getElementById('book-price').value) || 0;
    const description = document.getElementById('book-description').value.trim();
    const uploadMethod = document.getElementById('upload-method').value;
    
    if (!title || !author || !grade || !subject) {
        showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø±ÙØ¹
    let bookUrl = null;
    if (uploadMethod === 'link') {
        bookUrl = document.getElementById('book-url').value.trim();
        if (!bookUrl) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ø§Ø¨Ø· Ø§Ù„ÙƒØªØ§Ø¨');
            return;
        }
    } else {
        if (!uploadedBookFile) {
            showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„ÙƒØªØ§Ø¨');
            return;
        }
    }
    
    showLoading(me.role === 'admin' ? 'Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØªØ§Ø¨...' : 'Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒØªØ§Ø¨ Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©...');
    
    try {
        let uploadedFileUrl = null;
        let uploadedCoverUrl = null;
        
        // Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„ÙƒØªØ§Ø¨ Ø¥Ø°Ø§ ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø±ÙØ¹
        if (uploadMethod === 'upload' && uploadedBookFile) {
            const fileRef = storage.ref(`books/${Date.now()}_${uploadedBookFile.name}`);
            const uploadTask = fileRef.put(uploadedBookFile);
            
            await new Promise((resolve, reject) => {
                uploadTask.on('state_changed',
                    (snapshot) => {
                        // ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… Ù‡Ù†Ø§
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        console.log('Upload is ' + progress + '% done');
                    },
                    (error) => {
                        reject(error);
                    },
                    async () => {
                        uploadedFileUrl = await uploadTask.snapshot.ref.getDownloadURL();
                        resolve();
                    }
                );
            });
        }
        
        // Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
        if (uploadedCoverFile) {
            const coverRef = storage.ref(`covers/${Date.now()}_${uploadedCoverFile.name}`);
            const uploadTask = coverRef.put(uploadedCoverFile);
            
            await new Promise((resolve, reject) => {
                uploadTask.on('state_changed',
                    (snapshot) => {
                        // Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù…
                    },
                    (error) => {
                        reject(error);
                    },
                    async () => {
                        uploadedCoverUrl = await uploadTask.snapshot.ref.getDownloadURL();
                        resolve();
                    }
                );
            });
        }
        
        const bookData = {
            title: title,
            author: author,
            grade: grade,
            subject: subject,
            price: price,
            bookUrl: uploadMethod === 'link' ? bookUrl : uploadedFileUrl,
            coverUrl: uploadedCoverUrl || null,
            description: description || null,
            uploadDate: Date.now(),
            addedBy: me.uid,
            addedByName: me.name,
            status: me.role === 'admin' ? 'approved' : 'pending',
            downloads: 0,
            uploadMethod: uploadMethod,
            fileName: uploadedBookFile ? uploadedBookFile.name : null
        };
        
        const bookRef = db.ref('books').push();
        await bookRef.set(bookData);
        
        // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ ÙƒØªØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (me.role !== 'admin') {
            await db.ref(`users/${me.uid}/booksAdded`).transaction(current => (current || 0) + 1);
        }
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¥Ø¯Ù…Ù† Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø§Ø¯ÙŠ
        if (me.role !== 'admin') {
            await db.ref('notifications').push({
                type: 'book_pending',
                userId: me.uid,
                userName: me.name,
                bookId: bookRef.key,
                bookTitle: title,
                timestamp: Date.now(),
                read: false
            });
        }
        
        hideLoading();
        
        Swal.fire({
            title: me.role === 'admin' ? 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©!' : 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!',
            text: me.role === 'admin' ? 
                'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØªØ§Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­' : 
                'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒØªØ§Ø¨ Ù„Ù„Ø¥Ø¯Ù…Ù† Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©ØŒ Ø³ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©',
            icon: 'success',
            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
            background: '#1e293b',
            color: '#fff'
        }).then(() => {
            nav('library');
        });
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØªØ§Ø¨: ' + error.message);
    }
}

async function deleteBook(bookId, bookTitle) {
    const result = await Swal.fire({
        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
        html: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨:<br><strong>${bookTitle}</strong>ØŸ`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        background: '#1e293b',
        color: '#fff'
    });
    
    if (!result.isConfirmed) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨...');
    
    try {
        await db.ref(`books/${bookId}`).remove();
        hideLoading();
        showSuccess('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
        nav('library');
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨: ' + error.message);
    }
}

// ==================== [ 11. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ ] ====================
function loadAIBooks() {
    const container = document.getElementById('ai-books-list');
    if (!container) return;
    
    db.ref('books').on('value', snap => {
        const books = snap.val();
        container.innerHTML = '';
        
        if (!books) {
            container.innerHTML = '<p style="text-align:center; padding:20px; color:var(--text-sec);">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
            return;
        }
        
        Object.keys(books).forEach(bookId => {
            const book = books[bookId];
            container.innerHTML += `
                <div class="post" style="margin-bottom:10px; cursor:pointer;" onclick="selectBookForAI('${bookId}', '${book.title.replace(/'/g, "\\'")}')">
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:15px;">
                        <div style="display:flex; align-items:center; gap:15px;">
                            <img src="${book.coverUrl || 'https://cdn-icons-png.flaticon.com/512/3523/3523063.png'}" 
                                 style="width:50px; height:65px; border-radius:8px; object-fit:cover;">
                            <div>
                                <div style="font-weight:bold;">${book.title}</div>
                                <div style="font-size:12px; color:var(--text-sec);">
                                    ${book.subject} â€¢ ${book.grade}
                                </div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-left" style="color:var(--text-sec);"></i>
                    </div>
                </div>`;
        });
        
        document.getElementById('ai-interface').style.display = 'block';
    });
}

function selectBookForAI(bookId, bookTitle) {
    currentBookId = bookId;
    
    Swal.fire({
        title: 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ',
        html: `
            <div style="text-align:right; margin-bottom:20px;">
                <p style="color:var(--text-sec); margin-bottom:10px;">Ø§Ù„ÙƒØªØ§Ø¨: <strong>${bookTitle}</strong></p>
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; margin-bottom:8px; color:var(--text-sec);">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„:</label>
                <select id="chapter-select-modal" class="swal2-input">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ Ø¹Ø§Ù…</option>
                    <option value="Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</option>
                    <option value="Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                    <option value="Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù„Ø«">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                    <option value="Ø§Ù„ÙØµÙ„ Ø§Ù„Ø±Ø§Ø¨Ø¹">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
                    <option value="Ø§Ù„ÙØµÙ„ Ø§Ù„Ø®Ø§Ù…Ø³">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø®Ø§Ù…Ø³</option>
                    <option value="Ø¹Ø§Ù…">Ø¹Ø§Ù… (Ø§Ù„ÙƒØªØ§Ø¨ ÙƒØ§Ù…Ù„Ø§Ù‹)</option>
                </select>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                <div>
                    <label style="display:block; margin-bottom:5px; color:var(--text-sec);">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</label>
                    <select id="question-count-modal" class="swal2-input">
                        <option value="5">5 Ø£Ø³Ø¦Ù„Ø©</option>
                        <option value="10" selected>10 Ø£Ø³Ø¦Ù„Ø©</option>
                        <option value="15">15 Ø£Ø³Ø¦Ù„Ø©</option>
                    </select>
                </div>
                
                <div>
                    <label style="display:block; margin-bottom:5px; color:var(--text-sec);">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©</label>
                    <select id="difficulty-modal" class="swal2-input">
                        <option value="easy">Ø³Ù‡Ù„</option>
                        <option value="medium" selected>Ù…ØªÙˆØ³Ø·</option>
                        <option value="hard">ØµØ¹Ø¨</option>
                    </select>
                </div>
            </div>
        `,
        confirmButtonText: 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±',
        showCancelButton: true,
        background: '#1e293b',
        color: '#fff',
        preConfirm: () => {
            const chapter = document.getElementById('chapter-select-modal').value;
            const count = document.getElementById('question-count-modal').value;
            const difficulty = document.getElementById('difficulty-modal').value;
            
            if (!chapter) {
                Swal.showValidationMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„');
                return false;
            }
            
            selectedChapter = chapter;
            return { chapter, count: parseInt(count), difficulty };
        }
    }).then(async (result) => {
        if (result.isConfirmed) {
            await generateBookQuizAI();
        }
    });
}

async function generateBookQuizAI() {
    if (!currentBookId) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø°ÙƒÙŠ...');
    
    try {
        const bookSnap = await db.ref(`books/${currentBookId}`).once('value');
        const book = bookSnap.val();
        
        if (!book) {
            hideLoading();
            showError('Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        // Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø®Ø§Ø¯Ù… Ø®Ø§Ø±Ø¬ÙŠØŒ Ø³Ù†Ø³ØªØ®Ø¯Ù… Ù†Ø³Ø®Ø© Ù…Ø­Ù„ÙŠØ©
        // Ù‡Ø°Ø§ Ù…Ø«Ø§Ù„ Ù…Ø¨Ø³Ø·ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡ Ø¨Ø§ØªØµØ§Ù„ ÙØ¹Ù„ÙŠ
        
        const mockQuestions = [
            {
                question: `Ù…Ø§ Ù‡Ùˆ Ù…ÙˆØ¶ÙˆØ¹ ÙƒØªØ§Ø¨ "${book.title}"ØŸ`,
                options: ["Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", "Ø§Ù„Ø¹Ù„ÙˆÙ…", "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", "Ø§Ù„ØªØ§Ø±ÙŠØ®"],
                correctAnswer: 2,
                explanation: `Ø§Ù„ÙƒØªØ§Ø¨ ÙŠØªÙ†Ø§ÙˆÙ„ Ù…ÙˆØ¶ÙˆØ¹ ${book.subject || "Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©"}`
            },
            {
                question: `Ù…Ù† Ù‡Ùˆ Ù…Ø¤Ù„Ù Ø§Ù„ÙƒØªØ§Ø¨ "${book.title}"ØŸ`,
                options: ["Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯", book.author, "Ø¹Ù„ÙŠ Ø­Ø³Ù†", "Ù…Ø­Ù…Ø¯ Ø®Ø§Ù„Ø¯"],
                correctAnswer: 1,
                explanation: `Ø§Ù„Ù…Ø¤Ù„Ù Ù‡Ùˆ ${book.author}`
            },
            {
                question: `Ù„Ù…Ù† ÙŠÙˆØµÙ‰ Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨ØŸ`,
                options: ["Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©", `Ø·Ù„Ø§Ø¨ ${book.grade}`, "Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ÙÙ‚Ø·", "Ø§Ù„Ø¬Ù…ÙŠØ¹"],
                correctAnswer: 1,
                explanation: `Ø§Ù„ÙƒØªØ§Ø¨ Ù…Ø®ØµØµ Ù„Ø·Ù„Ø§Ø¨ ${book.grade}`
            }
        ];
        
        hideLoading();
        
        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
        currentQuiz = {
            id: `quiz_${Date.now()}`,
            bookId: currentBookId,
            bookTitle: book.title,
            chapter: selectedChapter,
            questions: mockQuestions,
            generatedAt: Date.now()
        };
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        displayQuiz(mockQuestions, currentQuiz.id);
        
        // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (me.uid !== 'guest') {
            await db.ref(`users/${me.uid}/aiQuizzesCount`).transaction(current => (current || 0) + 1);
        }
        
    } catch (error) {
        hideLoading();
        console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ:', error);
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ' + error.message);
    }
}

function displayQuiz(questions, quizId) {
    let quizHtml = `
        <div style="background:var(--bg-card); border-radius:20px; padding:25px; margin:20px 0; border:2px solid var(--purple);">
            <h3 style="color:var(--purple); margin-top:0;">
                <i class="fas fa-robot"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø°ÙƒÙŠ Ù…Ù† ÙƒØªØ§Ø¨: ${currentQuiz.bookTitle}
            </h3>
            <p style="color:var(--text-sec);">
                Ø§Ù„ÙØµÙ„: ${selectedChapter} â€¢ ${questions.length} Ø³Ø¤Ø§Ù„
                <br><small>ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</small>
            </p>
            
            <div id="quiz-questions-container" style="margin:25px 0;">`;
    
    questions.forEach((q, index) => {
        quizHtml += `
            <div style="background:rgba(0,0,0,0.2); border-radius:15px; padding:20px; margin-bottom:15px;">
                <h5 style="color:var(--text-main); margin-top:0;">
                    <span style="background:var(--primary); color:white; padding:5px 10px; border-radius:5px; margin-left:10px;">${index + 1}</span>
                    ${q.question}
                </h5>
                ${q.options.map((option, optIndex) => `
                    <div class="quiz-option" onclick="selectQuizAnswer(${index}, ${optIndex})" 
                         style="background:rgba(255,255,255,0.05); border:1px solid var(--border); border-radius:10px; padding:12px; margin-bottom:8px; cursor:pointer; transition:0.3s;">
                        <span style="margin-left:10px; font-weight:bold; color:var(--accent);">${String.fromCharCode(1632 + optIndex + 1)}.</span>
                        ${option}
                    </div>
                `).join('')}
            </div>`;
    });
    
    quizHtml += `
            </div>
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-main" onclick="submitQuiz('${quizId}')" style="background:var(--green);">
                    <i class="fas fa-check-circle"></i> Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                </button>
                <button class="btn-main" onclick="generateBookQuizAI()" style="background:var(--purple);">
                    <i class="fas fa-redo"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯
                </button>
            </div>
        </div>`;
    
    document.getElementById('quiz-results').innerHTML = quizHtml;
}

function selectQuizAnswer(questionIndex, optionIndex) {
    const questionCard = document.querySelectorAll('#quiz-questions-container > div')[questionIndex];
    const options = questionCard.querySelectorAll('.quiz-option');
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
    options.forEach(opt => {
        opt.style.background = 'rgba(255,255,255,0.05)';
        opt.style.borderColor = 'var(--border)';
    });
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
    options[optionIndex].style.background = 'rgba(59, 130, 246, 0.2)';
    options[optionIndex].style.borderColor = 'var(--primary)';
    
    // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
    if (!currentQuiz.userAnswers) currentQuiz.userAnswers = {};
    currentQuiz.userAnswers[questionIndex] = optionIndex;
}

async function submitQuiz(quizId) {
    if (!currentQuiz || !currentQuiz.questions) return;
    
    const userAnswers = currentQuiz.userAnswers || {};
    let score = 0;
    const totalQuestions = currentQuiz.questions.length;
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©
    currentQuiz.questions.forEach((q, index) => {
        if (userAnswers[index] === q.correctAnswer) {
            score++;
        }
    });
    
    const percentage = Math.round((score / totalQuestions) * 100);
    
    // Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Firebase
    if (me && me.uid !== 'guest') {
        const resultId = `quiz_result_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        await db.ref(`ai_quiz_results/${resultId}`).set({
            quizId: quizId,
            userId: me.uid,
            userName: me.name,
            bookId: currentQuiz.bookId,
            bookTitle: currentQuiz.bookTitle,
            chapter: selectedChapter,
            score: score,
            totalQuestions: totalQuestions,
            percentage: percentage,
            answers: userAnswers,
            correctAnswers: currentQuiz.questions.map(q => q.correctAnswer),
            submittedAt: Date.now()
        });
    }
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
    Swal.fire({
        title: 'ğŸ‰ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±',
        html: `
            <div style="text-align:center;">
                <div style="font-size:60px; color:${percentage >= 70 ? 'var(--green)' : percentage >= 50 ? 'var(--accent)' : 'var(--red)'}; font-weight:bold; margin:20px 0;">
                    ${percentage}%
                </div>
                <div style="font-size:24px; margin:10px 0;">
                    ${score} Ù…Ù† ${totalQuestions} Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©
                </div>
                <div style="font-size:16px; color:var(--text-sec); margin:15px 0;">
                    ${percentage >= 70 ? 'Ù…Ù…ØªØ§Ø²! ğŸ‘ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø¯Ù‚ÙŠÙ‚Ø©' : 
                      percentage >= 50 ? 'Ø¬ÙŠØ¯ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø³Ù† Ø¨Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¯Ø±Ø§Ø³Ø©' : 
                      'ØªØ­ØªØ§Ø¬ Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©ØŒ Ù„Ø§ ØªÙŠØ£Ø³!'}
                </div>
                <div style="margin-top:25px;">
                    <button onclick="window.location.reload()" 
                            style="background:var(--primary); color:white; border:none; padding:10px 20px; border-radius:10px; cursor:pointer;">
                        <i class="fas fa-redo"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯
                    </button>
                </div>
            </div>
        `,
        icon: 'success',
        showConfirmButton: false,
        background: '#1e293b',
        color: '#fff'
    });
}

// ==================== [ 12. Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„ØµÙˆØªÙŠ ] ====================
async function loadAudioBooks() {
    const container = document.getElementById('audio-books');
    if (!container) return;
    
    // Ø¬Ù„Ø¨ Ø§Ù„ÙƒØªØ¨ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø´Ø±Ø­ ØµÙˆØªÙŠ
    db.ref('books').orderByChild('hasAudio').equalTo(true).on('value', snap => {
        const books = snap.val();
        container.innerHTML = '';
        
        if (!books) {
            container.innerHTML = `
                <div style="text-align:center; padding:40px; color:var(--text-sec);">
                    <i class="fas fa-volume-mute" style="font-size:48px; margin-bottom:15px; opacity:0.5;"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ Ù…Ø¹ Ø´Ø±Ø­ ØµÙˆØªÙŠ Ø¨Ø¹Ø¯</p>
                    <button class="btn-main" onclick="nav('add_book')" style="margin-top:15px;">
                        <i class="fas fa-plus"></i> Ø£Ø¶Ù ÙƒØªØ§Ø¨Ø§Ù‹ Ù…Ø¹ Ø´Ø±Ø­ ØµÙˆØªÙŠ
                    </button>
                </div>`;
            return;
        }
        
        Object.entries(books).forEach(([bookId, book]) => {
            container.innerHTML += `
                <div class="book-card">
                    <img src="${book.coverUrl || 'https://cdn-icons-png.flaticon.com/512/3523/3523063.png'}" 
                         class="book-cover">
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size:16px;">${book.title}</div>
                        <div style="font-size:12px; color:var(--text-sec);">
                            <i class="fas fa-user"></i> ${book.author} â€¢ 
                            <i class="fas fa-book-open"></i> ${book.subject}
                        </div>
                        <div style="font-size:11px; color:var(--text-sec); margin-top:5px;">
                            <i class="fas fa-graduation-cap"></i> ${book.grade}
                        </div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <button class="btn-main" style="padding:8px 12px; font-size:12px; background:var(--accent); color:black;" 
                                onclick="playBookAudio('${bookId}', '${book.title.replace(/'/g, "\\'")}')">
                            <i class="fas fa-play"></i> Ø§Ø³ØªÙ…Ø¹
                        </button>
                    </div>
                </div>`;
        });
    });
}

async function generateVoice() {
    const text = document.getElementById('tts-text').value.trim();
    if (!text) {
        showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ù„ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ ØµÙˆØª');
        return;
    }
    
    if (text.length > 1000) {
        showError('Ø§Ù„Ù†Øµ Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 1000 Ø­Ø±Ù');
        return;
    }
    
    showLoading('Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØª...');
    
    try {
        // ÙÙŠ Ø¨ÙŠØ¦Ø© Ø¥Ù†ØªØ§Ø¬ÙŠØ©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø© TTS Ù…Ø«Ù„:
        // - Google Text-to-Speech
        // - Microsoft Azure TTS
        // - IBM Watson Text to Speech
        
        // Ù‡Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø­Ù„ Ø¨Ø¯ÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Speech API
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            
            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙˆØª Ø§Ù„Ø¹Ø±Ø¨ÙŠ
            utterance.lang = 'ar-SA';
            utterance.rate = 0.9;
            utterance.pitch = 1;
            
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† ØµÙˆØª Ø¹Ø±Ø¨ÙŠ
            const voices = speechSynthesis.getVoices();
            const arabicVoice = voices.find(voice => voice.lang.includes('ar'));
            if (arabicVoice) {
                utterance.voice = arabicVoice;
            }
            
            // Ø­ÙØ¸ Ø§Ù„ØµÙˆØª Ø§Ù„Ø­Ø§Ù„ÙŠ
            currentVoice = utterance;
            
            // Ø¹Ø±Ø¶ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…
            document.getElementById('voice-output').style.display = 'block';
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            utterance.onstart = () => {
                hideLoading();
                showSuccess('Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª...');
            };
            
            utterance.onend = () => {
                document.getElementById('current-time').textContent = '0:00';
                document.getElementById('voice-progress').style.width = '0%';
            };
            
            // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
            speechSynthesis.speak(utterance);
            
        } else {
            hideLoading();
            showError('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù…ÙŠØ²Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ ÙƒÙ„Ø§Ù…');
        }
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØª: ' + error.message);
    }
}

function playVoice() {
    if (currentVoice && speechSynthesis) {
        speechSynthesis.speak(currentVoice);
    }
}

function pauseVoice() {
    if (speechSynthesis) {
        speechSynthesis.pause();
    }
}

function stopVoice() {
    if (speechSynthesis) {
        speechSynthesis.cancel();
    }
}

function seekVoice(event) {
    // Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ØªØ­ØªØ§Ø¬ Ù„ØªØ·Ø¨ÙŠÙ‚ Ø£ÙƒØ«Ø± ØªØ¹Ù‚ÙŠØ¯Ø§Ù‹ Ù…Ø¹ Ù…Ù„ÙØ§Øª ØµÙˆØªÙŠØ© Ø­Ù‚ÙŠÙ‚ÙŠØ©
    // Ù…Ø¹ Web Speech APIØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
    showError('Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ Ù…Ø¹ Web Speech API');
}

function downloadVoice() {
    showError('ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª ÙŠØªØ·Ù„Ø¨ Ø®Ø¯Ù…Ø© TTS Ø®Ø§Ø±Ø¬ÙŠØ© Ù…Ø«Ù„ Google Ø£Ùˆ Microsoft');
    // ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙØ¹Ù„ÙŠØŒ ÙŠÙ…ÙƒÙ†Ùƒ:
    // 1. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø®Ø¯Ù…Ø© TTS
    // 2. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ù…Ù„Ù ØµÙˆØªÙŠ
    // 3. ØªÙ†Ø²ÙŠÙ„Ù‡
}

async function explainBookWithAI(bookId, bookTitle) {
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø´Ø±Ø­ ØµÙˆØªÙŠ Ù„Ù„ÙƒØªØ§Ø¨...');
    
    try {
        const bookSnap = await db.ref(`books/${bookId}`).once('value');
        const book = bookSnap.val();
        
        if (!book) {
            hideLoading();
            showError('Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
            return;
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø´Ø±Ø­ Ù…Ø®ØªØµØ± Ù„Ù„ÙƒØªØ§Ø¨
        const explanation = `
            ÙƒØªØ§Ø¨ ${book.title}
            Ù„Ù„Ù…Ø¤Ù„Ù ${book.author}
            Ù…Ù† Ù…Ù†Ù‡Ø¬ ${book.grade}
            ÙÙŠ Ù…Ø§Ø¯Ø© ${book.subject}
            
            ${book.description || 'ÙƒØªØ§Ø¨ ØªØ¹Ù„ÙŠÙ…ÙŠ Ù…ÙÙŠØ¯ ÙŠØ³Ø§Ø¹Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¹Ù„Ù‰ ÙÙ‡Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø¨Ø´ÙƒÙ„ Ø£ÙØ¶Ù„.'}
            
            ÙŠØ­ØªÙˆÙŠ Ø§Ù„ÙƒØªØ§Ø¨ Ø¹Ù„Ù‰ Ø¯Ø±ÙˆØ³ Ù…ØªÙ†ÙˆØ¹Ø© ÙˆØ£Ù…Ø«Ù„Ø© Ø¹Ù…Ù„ÙŠØ©.
            ÙŠÙ†ØµØ­ Ø¨Ù‡ Ù„Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø§Ø¨ ${book.grade}.
        `;
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Web Speech API Ù„Ù„Ø´Ø±Ø­
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(explanation);
            utterance.lang = 'ar-SA';
            utterance.rate = 0.9;
            
            const voices = speechSynthesis.getVoices();
            const arabicVoice = voices.find(voice => voice.lang.includes('ar'));
            if (arabicVoice) {
                utterance.voice = arabicVoice;
            }
            
            // Ø­ÙØ¸ Ø§Ù„ØµÙˆØª Ø§Ù„Ø­Ø§Ù„ÙŠ
            currentVoice = utterance;
            
            hideLoading();
            
            Swal.fire({
                title: `Ø´Ø±Ø­ ÙƒØªØ§Ø¨ ${bookTitle}`,
                html: `
                    <div style="text-align:right; margin-bottom:20px;">
                        <p style="color:var(--text-sec);">${explanation}</p>
                    </div>
                    <div style="display:flex; gap:10px; justify-content:center;">
                        <button onclick="playVoice()" style="background:var(--accent); color:black; border:none; padding:10px 20px; border-radius:10px; cursor:pointer;">
                            <i class="fas fa-play"></i> ØªØ´ØºÙŠÙ„
                        </button>
                        <button onclick="stopVoice()" style="background:var(--red); color:white; border:none; padding:10px 20px; border-radius:10px; cursor:pointer;">
                            <i class="fas fa-stop"></i> Ø¥ÙŠÙ‚Ø§Ù
                        </button>
                    </div>
                `,
                showConfirmButton: false,
                showCloseButton: true,
                background: '#1e293b',
                color: '#fff'
            });
            
            // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            speechSynthesis.speak(utterance);
            
        } else {
            hideLoading();
            showError('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù…ÙŠØ²Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ ÙƒÙ„Ø§Ù…');
        }
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø´Ø±Ø­ Ø§Ù„ØµÙˆØªÙŠ: ' + error.message);
    }
}

// ==================== [ 13. ØºØ±Ù Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ] ====================
async function loadLiveRooms() {
    const container = document.getElementById('live-rooms');
    if (!container) return;
    
    db.ref('live_rooms').orderByChild('startTime').limitToLast(20).on('value', snap => {
        const rooms = snap.val();
        container.innerHTML = '';
        
        if (!rooms) {
            container.innerHTML = `
                <div style="text-align:center; padding:40px; color:var(--text-sec);">
                    <i class="fas fa-video-slash" style="font-size:48px; margin-bottom:15px; opacity:0.5;"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ±Ù Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                    ${(me.role === 'admin' || me.isTeacher) ? `
                    <button class="btn-main" onclick="createLiveRoom()" style="margin-top:15px;">
                        <i class="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆÙ„ ØºØ±ÙØ© Ø¨Ø«
                    </button>
                    ` : ''}
                </div>`;
            return;
        }
        
        const now = Date.now();
        Object.entries(rooms).reverse().forEach(([roomId, room]) => {
            const isActive = room.status === 'active' && room.endTime > now;
            const isUpcoming = room.status === 'scheduled' && room.startTime > now;
            const isEnded = room.status === 'ended' || room.endTime <= now;
            
            let statusBadge = '';
            if (isActive) {
                statusBadge = '<span style="background:var(--green); color:white; padding:3px 10px; border-radius:15px; font-size:11px;">ğŸ”´ Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ø¢Ù†</span>';
            } else if (isUpcoming) {
                statusBadge = '<span style="background:var(--accent); color:black; padding:3px 10px; border-radius:15px; font-size:11px;">â° Ù‚Ø±ÙŠØ¨Ø§Ù‹</span>';
            } else {
                statusBadge = '<span style="background:var(--text-sec); color:white; padding:3px 10px; border-radius:15px; font-size:11px;">Ø§Ù†ØªÙ‡Ù‰</span>';
            }
            
            const teacherAccount = room.teacherAccount ? 
                `<div style="font-size:11px; color:var(--text-sec); margin-top:5px;">
                    <i class="fas fa-credit-card"></i> Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø³ØªØ§Ø°: ${room.teacherAccount}
                </div>` : '';
            
            container.innerHTML += `
                <div class="live-room" style="background: ${isActive ? 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)' : 
                                                    isUpcoming ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : 
                                                    'linear-gradient(135deg, #64748b 0%, #475569 100%)'};">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <h3 style="margin-top:0; margin-bottom:10px;">${room.title}</h3>
                            <p style="opacity:0.9; margin-bottom:10px;">${room.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</p>
                            
                            <div style="display:flex; gap:15px; font-size:12px; margin-bottom:10px;">
                                <div>
                                    <i class="fas fa-chalkboard-teacher"></i> ${room.teacherName}
                                </div>
                                <div>
                                    <i class="fas fa-book"></i> ${room.subject || 'Ø¹Ø§Ù…'}
                                </div>
                                <div>
                                    <i class="fas fa-graduation-cap"></i> ${room.grade || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ'}
                                </div>
                            </div>
                            
                            ${teacherAccount}
                        </div>
                        ${statusBadge}
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                        <div style="font-size:12px;">
                            <i class="fas fa-clock"></i> 
                            ${isActive ? 'ÙŠÙ†ØªÙ‡ÙŠ ' : isUpcoming ? 'ÙŠØ¨Ø¯Ø£ ' : 'Ø§Ù†ØªÙ‡Ù‰ '}
                            ${formatDate(isActive ? room.endTime : room.startTime)}
                        </div>
                        
                        <div style="display:flex; gap:10px;">
                            ${isActive ? `
                            <button class="btn-main" onclick="joinLiveRoom('${roomId}')" 
                                    style="width:auto; padding:10px 20px; background:white; color:black;">
                                <i class="fas fa-play"></i> Ø§Ù†Ø¶Ù… Ø§Ù„Ø¢Ù†
                            </button>
                            ` : ''}
                            
                            ${(me.role === 'admin' || me.uid === room.teacherId) ? `
                            <button class="btn-secondary" onclick="manageLiveRoom('${roomId}')" style="width:auto; padding:10px 15px;">
                                <i class="fas fa-cog"></i> Ø¥Ø¯Ø§Ø±Ø©
                            </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    ${room.price > 0 ? `
                    <div style="background:rgba(0,0,0,0.3); padding:10px; border-radius:10px; margin-top:15px; font-size:14px;">
                        <i class="fas fa-tag"></i> Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„: <strong>${room.price} SDM</strong>
                        ${!isActive && !isUpcoming ? '' : `
                        <button onclick="payForLiveRoom('${roomId}', ${room.price})" 
                                style="background:var(--green); color:white; border:none; padding:5px 15px; border-radius:5px; margin-right:10px; cursor:pointer;">
                            <i class="fas fa-lock-open"></i> Ø¯ÙØ¹ ÙˆØ§Ù„Ø¯Ø®ÙˆÙ„
                        </button>
                        `}
                    </div>
                    ` : ''}
                </div>`;
        });
    });
}

async function createLiveRoom() {
    if (me.uid === 'guest') {
        showError('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¨Ø«');
        return;
    }
    
    if (!me.isTeacher && me.role !== 'admin') {
        showError('ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£Ø³ØªØ§Ø°Ø§Ù‹ Ù„Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¨Ø«');
        return;
    }
    
    const { value: formValues } = await Swal.fire({
        title: 'Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¨Ø« Ø¬Ø¯ÙŠØ¯Ø©',
        html: `
            <input id="live-title" class="swal2-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³">
            <textarea id="live-description" class="swal2-input" placeholder="ÙˆØµÙ Ø§Ù„Ø¯Ø±Ø³" rows="3"></textarea>
            <select id="live-subject" class="swal2-input">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</option>
                ${SUBJECTS.map(s => `<option value="${s}">${s}</option>`).join('')}
            </select>
            <select id="live-grade" class="swal2-input">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
                ${ALL_GRADES.map(g => `<option value="${g.name}">${g.name}</option>`).join('')}
            </select>
            <input id="live-price" class="swal2-input" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ (0 Ù„Ù„Ù…Ø¬Ø§Ù†ÙŠ)" type="number" min="0" value="0">
            ${me.isTeacher ? `
            <input id="live-account" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨Ùƒ Ù„Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª" value="${me.teacherAccount || ''}">
            ` : ''}
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <input id="live-start" class="swal2-input" placeholder="ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡" type="datetime-local">
                <input id="live-duration" class="swal2-input" placeholder="Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚ÙŠÙ‚Ø©)" type="number" min="30" value="60">
            </div>
        `,
        confirmButtonText: 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©',
        showCancelButton: true,
        background: '#1e293b',
        color: '#fff',
        preConfirm: () => {
            const title = document.getElementById('live-title').value;
            const description = document.getElementById('live-description').value;
            const subject = document.getElementById('live-subject').value;
            const grade = document.getElementById('live-grade').value;
            const price = parseInt(document.getElementById('live-price').value) || 0;
            const teacherAccount = me.isTeacher ? document.getElementById('live-account').value : null;
            const startTime = document.getElementById('live-start').value;
            const duration = parseInt(document.getElementById('live-duration').value) || 60;
            
            if (!title) {
                Swal.showValidationMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ù„Ù„Ø¯Ø±Ø³');
                return false;
            }
            
            const startTimestamp = startTime ? new Date(startTime).getTime() : Date.now() + 600000; // 10 Ø¯Ù‚Ø§Ø¦Ù‚ Ù…Ù† Ø§Ù„Ø¢Ù†
            const endTime = startTimestamp + (duration * 60000);
            
            return {
                title,
                description,
                subject,
                grade,
                price,
                teacherAccount,
                startTime: startTimestamp,
                endTime,
                duration
            };
        }
    });
    
    if (!formValues) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø§Ù„Ø¨Ø«...');
    
    try {
        const roomId = `room_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        await db.ref(`live_rooms/${roomId}`).set({
            id: roomId,
            title: formValues.title,
            description: formValues.description,
            subject: formValues.subject || null,
            grade: formValues.grade || null,
            price: formValues.price,
            teacherId: me.uid,
            teacherName: me.name,
            teacherAccount: formValues.teacherAccount || me.teacherAccount || null,
            startTime: formValues.startTime,
            endTime: formValues.endTime,
            duration: formValues.duration,
            status: formValues.startTime > Date.now() ? 'scheduled' : 'active',
            createdAt: Date.now(),
            participants: 0,
            maxParticipants: 100
        });
        
        hideLoading();
        showSuccess('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø§Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­');
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©: ' + error.message);
    }
}

async function joinLiveRoom(roomId) {
    const roomSnap = await db.ref(`live_rooms/${roomId}`).once('value');
    const room = roomSnap.val();
    
    if (!room) {
        showError('ØºØ±ÙØ© Ø§Ù„Ø¨Ø« ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
        return;
    }
    
    const now = Date.now();
    if (room.status !== 'active' || room.endTime <= now) {
        showError('ØºØ±ÙØ© Ø§Ù„Ø¨Ø« ØºÙŠØ± Ù†Ø´Ø·Ø© Ø­Ø§Ù„ÙŠØ§Ù‹');
        return;
    }
    
    if (room.price > 0) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹
        const paymentSnap = await db.ref(`room_payments/${roomId}_${me.uid}`).once('value');
        const hasPaid = paymentSnap.exists() && paymentSnap.val().confirmed === true;
        
        if (!hasPaid) {
            const payNow = await Swal.fire({
                title: 'Ø¯ÙØ¹ Ù…Ø·Ù„ÙˆØ¨',
                html: `Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„: <strong>${room.price} SDM</strong><br>
                       ÙŠØ¬Ø¨ Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                background: '#1e293b',
                color: '#fff'
            });
            
            if (payNow.isConfirmed) {
                await payForLiveRoom(roomId, room.price);
            }
            return;
        }
    }
    
    // Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Ù…Ø«Ù„ Jitsi, Zoom, etc.)
    showSuccess(`ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ© Ø§Ù„Ø¨Ø«: ${room.title}`);
    // window.open(`https://meet.jit.si/${roomId}`, '_blank'); // Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ Jitsi
}

async function payForLiveRoom(roomId, price) {
    if (me.uid === 'guest') {
        showError('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¯ÙØ¹');
        return;
    }
    
    if (me.balance < price) {
        showError(`Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ. ØªØ­ØªØ§Ø¬ ${price} SDM`);
        nav('subscription');
        return;
    }
    
    const confirm = await Swal.fire({
        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹',
        html: `Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„: <strong>${price} SDM</strong><br>
               Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø±ØµÙŠØ¯Ùƒ`,
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        background: '#1e293b',
        color: '#fff'
    });
    
    if (!confirm.isConfirmed) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹...');
    
    try {
        // Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº
        const newBalance = (me.balance || 0) - price;
        await db.ref(`users/${me.uid}/balance`).set(newBalance);
        me.balance = newBalance;
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹
        const paymentId = `pay_${Date.now()}`;
        await db.ref(`room_payments/${roomId}_${me.uid}`).set({
            paymentId: paymentId,
            roomId: roomId,
            userId: me.uid,
            userName: me.name,
            amount: price,
            timestamp: Date.now(),
            confirmed: false, // ÙŠØ­ØªØ§Ø¬ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¯Ù…Ù†
            status: 'pending'
        });
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¥Ø¯Ù…Ù†
        const roomSnap = await db.ref(`live_rooms/${roomId}`).once('value');
        const room = roomSnap.val();
        
        await db.ref('notifications').push({
            type: 'room_payment',
            paymentId: paymentId,
            roomId: roomId,
            roomTitle: room.title,
            userId: me.uid,
            userName: me.name,
            amount: price,
            timestamp: Date.now(),
            read: false,
            actionRequired: true
        });
        
        hideLoading();
        
        Swal.fire({
            title: 'ØªÙ… Ø§Ù„Ø¯ÙØ¹!',
            html: `ØªÙ… Ø®ØµÙ… ${price} SDM Ù…Ù† Ø±ØµÙŠØ¯Ùƒ<br>
                   ÙŠØ±Ø¬Ù‰ Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¯Ù…Ù† Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ø¨Ø«`,
            icon: 'success',
            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
            background: '#1e293b',
            color: '#fff'
        });
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯ÙØ¹: ' + error.message);
    }
}

// ==================== [ 14. Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ] ====================
function showPublicLibrary() {
    document.getElementById('public-library-modal').classList.remove('hidden');
    loadPublicLibrary();
}

function closePublicLibrary() {
    document.getElementById('public-library-modal').classList.add('hidden');
}

function loadPublicLibrary() {
    const container = document.getElementById('public-library-content');
    container.innerHTML = `
        <div style="margin-bottom:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="color:var(--accent); margin:0;">ÙƒØªØ¨ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
                <button class="btn-main" onclick="addPublicBook()" style="width:auto; padding:10px 20px;">
                    <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯
                </button>
            </div>
            <p style="color:var(--text-sec);">ÙƒØªØ¨ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ù„Ù„Ù…Ø·Ø§Ù„Ø¹Ø© ÙˆØ§Ù„Ø§Ø³ØªÙØ§Ø¯Ø©</p>
        </div>
        
        <div id="public-books-list" class="loading">
            <div class="loading-spinner"></div>
            <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ¨...</div>
        </div>`;
    
    db.ref('public_books').on('value', snap => {
        const books = snap.val();
        const listContainer = document.getElementById('public-books-list');
        listContainer.innerHTML = '';
        
        if (!books) {
            listContainer.innerHTML = `
                <div style="text-align:center; padding:40px; color:var(--text-sec);">
                    <i class="fas fa-book-open" style="font-size:48px; margin-bottom:15px; opacity:0.5;"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ø¨Ø¹Ø¯</p>
                    <button class="btn-main" onclick="addPublicBook()" style="margin-top:15px;">
                        <i class="fas fa-plus"></i> ÙƒÙ† Ø£ÙˆÙ„ Ù…Ù† ÙŠØ¶ÙŠÙ ÙƒØªØ§Ø¨Ø§Ù‹
                    </button>
                </div>`;
            return;
        }
        
        Object.entries(books).forEach(([bookId, book]) => {
            listContainer.innerHTML += `
                <div class="book-card">
                    <img src="${book.coverUrl || 'https://cdn-icons-png.flaticon.com/512/3523/3523063.png'}" 
                         class="book-cover">
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size:16px;">${book.title}</div>
                        <div style="font-size:12px; color:var(--text-sec); margin-bottom:5px;">
                            <i class="fas fa-user"></i> ${book.author}
                        </div>
                        
                        <div style="font-size:11px; color:var(--text-sec); margin-bottom:8px;">
                            <span style="background:rgba(139, 92, 246, 0.2); color:var(--purple); padding:3px 8px; border-radius:5px;">
                                ${book.category || 'Ø¹Ø§Ù…'}
                            </span>
                        </div>
                        
                        ${book.description ? `
                        <div style="font-size:12px; color:var(--text-sec); line-height:1.4;">
                            ${book.description.substring(0, 80)}${book.description.length > 80 ? '...' : ''}
                        </div>
                        ` : ''}
                        
                        <div style="font-size:10px; color:var(--text-sec); margin-top:8px;">
                            <i class="fas fa-user-plus"></i> Ø£Ø¶ÙŠÙ Ø¨ÙˆØ§Ø³Ø·Ø©: ${book.addedByName}
                        </div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <button class="btn-main" style="padding:8px 12px; font-size:12px;" 
                                onclick="downloadPublicBook('${bookId}', '${book.bookUrl}')">
                            <i class="fas fa-download"></i> ØªØ­Ù…ÙŠÙ„
                        </button>
                        ${(me.role === 'admin' || me.uid === book.addedBy) ? `
                        <button class="btn-danger" style="padding:8px 12px; font-size:12px;" 
                                onclick="deletePublicBook('${bookId}', '${book.title.replace(/'/g, "\\'")}')">
                            <i class="fas fa-trash"></i> Ø­Ø°Ù
                        </button>
                        ` : ''}
                    </div>
                </div>`;
        });
    });
}

async function addPublicBook() {
    const { value: formValues } = await Swal.fire({
        title: 'Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ Ù„Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø©',
        html: `
            <input id="pub-title" class="swal2-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨">
            <input id="pub-author" class="swal2-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù">
            <input id="pub-category" class="swal2-input" placeholder="Ø§Ù„ØªØµÙ†ÙŠÙ (Ø±ÙˆØ§ÙŠØ©ØŒ Ø¹Ù„Ù…ÙŠØ©ØŒ Ø¥Ù„Ø®)">
            <input id="pub-url" class="swal2-input" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ÙƒØªØ§Ø¨ (PDF)" type="url">
            <input id="pub-cover" class="swal2-input" placeholder="Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" type="url">
            <textarea id="pub-description" class="swal2-input" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ± Ù„Ù„ÙƒØªØ§Ø¨..." rows="3"></textarea>
        `,
        confirmButtonText: 'Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØªØ§Ø¨',
        showCancelButton: true,
        background: '#1e293b',
        color: '#fff',
        preConfirm: () => {
            const title = document.getElementById('pub-title').value;
            const author = document.getElementById('pub-author').value;
            const category = document.getElementById('pub-category').value;
            const bookUrl = document.getElementById('pub-url').value;
            const coverUrl = document.getElementById('pub-cover').value;
            const description = document.getElementById('pub-description').value;
            
            if (!title || !author || !bookUrl) {
                Swal.showValidationMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                return false;
            }
            
            return { title, author, category, bookUrl, coverUrl, description };
        }
    });
    
    if (!formValues) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØªØ§Ø¨...');
    
    try {
        const bookRef = db.ref('public_books').push();
        await bookRef.set({
            title: formValues.title,
            author: formValues.author,
            category: formValues.category || 'Ø¹Ø§Ù…',
            bookUrl: formValues.bookUrl,
            coverUrl: formValues.coverUrl || null,
            description: formValues.description || null,
            addedBy: me.uid,
            addedByName: me.name,
            uploadDate: Date.now(),
            downloads: 0
        });
        
        hideLoading();
        showSuccess('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØªØ§Ø¨ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­');
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØªØ§Ø¨: ' + error.message);
    }
}

async function downloadPublicBook(bookId, bookUrl) {
    if (!bookUrl) {
        showError('Ø±Ø§Ø¨Ø· Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ØªÙˆÙØ±');
        return;
    }
    
    // Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø§Øª
    await db.ref(`public_books/${bookId}/downloads`).transaction(current => (current || 0) + 1);
    
    // ÙØªØ­ Ø§Ù„ÙƒØªØ§Ø¨ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
    window.open(bookUrl, '_blank');
    
    showSuccess('Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ø§Ù„ÙƒØªØ§Ø¨...');
}

async function deletePublicBook(bookId, bookTitle) {
    const result = await Swal.fire({
        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù',
        html: `Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨:<br><strong>${bookTitle}</strong>ØŸ`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        background: '#1e293b',
        color: '#fff'
    });
    
    if (!result.isConfirmed) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨...');
    
    try {
        await db.ref(`public_books/${bookId}`).remove();
        hideLoading();
        showSuccess('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨: ' + error.message);
    }
}

// ==================== [ 15. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ] ====================
async function buySubscription(plan, price) {
    if (me.uid === 'guest') {
        showError('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø§Ø´ØªØ±Ø§Ùƒ');
        return;
    }
    
    if (me.balance < price) {
        showError(`Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ. ØªØ­ØªØ§Ø¬ ${price} SDM`);
        return;
    }
    
    const planNames = {
        'weekly': { name: 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ', days: 7 },
        'monthly': { name: 'Ø§Ù„Ø´Ù‡Ø±ÙŠ', days: 30 },
        'yearly': { name: 'Ø§Ù„Ø³Ù†ÙˆÙŠ', days: 365 }
    };
    
    const planInfo = planNames[plan];
    const confirm = await Swal.fire({
        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ',
        html: `Ø§Ù„Ø®Ø·Ø©: <strong>${planInfo.name}</strong><br>
               Ø§Ù„Ø³Ø¹Ø±: <strong>${price} SDM</strong><br>
               Ø§Ù„Ù…Ø¯Ø©: <strong>${planInfo.days} ÙŠÙˆÙ…</strong><br>
               Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø±ØµÙŠØ¯Ùƒ`,
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        background: '#1e293b',
        color: '#fff'
    });
    
    if (!confirm.isConfirmed) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ...');
    
    try {
        // Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº
        const newBalance = me.balance - price;
        await db.ref(`users/${me.uid}/balance`).set(newBalance);
        me.balance = newBalance;
        
        // Ø­Ø³Ø§Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
        const expiryDate = Date.now() + (planInfo.days * 24 * 60 * 60 * 1000);
        
        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
        await db.ref(`subscriptions/${me.uid}`).set({
            plan: plan,
            price: price,
            days: planInfo.days,
            startDate: Date.now(),
            expiryDate: expiryDate,
            active: true
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        await db.ref(`users/${me.uid}`).update({
            subscription: plan,
            freeTrial: false,
            totalSpent: (me.totalSpent || 0) + price
        });
        
        hideLoading();
        showSuccess(`ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ${planInfo.name} Ø¨Ù†Ø¬Ø§Ø­`);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        document.getElementById('u-stars').innerText = me.balance + ' SDM';
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: ' + error.message);
    }
}

async function sendPaymentNotification() {
    const { value: amount } = await Swal.fire({
        title: 'Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¯ÙØ¹',
        input: 'number',
        inputLabel: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (SDM)',
        inputPlaceholder: 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ Ù‚Ù…Øª Ø¨ØªØ­ÙˆÙŠÙ„Ù‡',
        showCancelButton: true,
        confirmButtonText: 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        background: '#1e293b',
        color: '#fff',
        inputValidator: (value) => {
            if (!value || value <= 0) {
                return 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­';
            }
        }
    });
    
    if (!amount) return;
    
    const { value: receipt } = await Swal.fire({
        title: 'Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø£Ùˆ Ø§Ù„Ù…Ø±Ø¬Ø¹',
        input: 'text',
        inputLabel: 'Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ',
        inputPlaceholder: 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ£ÙƒÙŠØ¯ Ø£Ø³Ø±Ø¹',
        showCancelButton: true,
        confirmButtonText: 'Ø¥Ø±Ø³Ø§Ù„',
        cancelButtonText: 'ØªØ®Ø·ÙŠ',
        background: '#1e293b',
        color: '#fff'
    });
    
    showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±...');
    
    try {
        const notificationId = `pay_notify_${Date.now()}`;
        
        await db.ref('notifications').push({
            type: 'deposit_notification',
            userId: me.uid,
            userName: me.name,
            amount: parseInt(amount),
            receipt: receipt || null,
            timestamp: Date.now(),
            read: false,
            actionRequired: true,
            status: 'pending'
        });
        
        hideLoading();
        
        Swal.fire({
            title: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±!',
            html: `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø¥Ø¯Ù…Ù†<br>
                   <strong>Ø§Ù„Ù…Ø¨Ù„Øº: ${amount} SDM</strong><br>
                   Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ø¹Ø¯ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¯Ù…Ù†`,
            icon: 'success',
            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
            background: '#1e293b',
            color: '#fff'
        });
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: ' + error.message);
    }
}

// ==================== [ 16. Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¥Ø¶Ø§ÙÙŠØ© ] ====================
async function updateTeacherAccount() {
    const { value: account } = await Swal.fire({
        title: 'ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨',
        input: 'text',
        inputLabel: 'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø¨Ù†ÙƒÙŠ Ù„Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª',
        inputPlaceholder: 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨Ùƒ ÙÙŠ Ø¨Ù†Ùƒ Ø§Ù„Ø®Ø±Ø·ÙˆÙ…',
        showCancelButton: true,
        confirmButtonText: 'Ø­ÙØ¸',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        background: '#1e293b',
        color: '#fff'
    });
    
    if (!account) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨...');
    
    try {
        await db.ref(`users/${me.uid}`).update({
            teacherAccount: account,
            isTeacher: true
        });
        
        me.teacherAccount = account;
        me.isTeacher = true;
        
        hideLoading();
        showSuccess('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­');
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ' + error.message);
    }
}

async function loadRecentBooks() {
    const container = document.getElementById('recent-books');
    if (!container) return;
    
    db.ref('books').orderByChild('uploadDate').limitToLast(5).on('value', snap => {
        const books = snap.val();
        container.innerHTML = '';
        
        if (!books) {
            container.innerHTML = '<p style="text-align:center; padding:20px; color:var(--text-sec);">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ Ø­Ø¯ÙŠØ«Ø©</p>';
            return;
        }
        
        Object.entries(books).reverse().forEach(([bookId, book]) => {
            container.innerHTML += `
                <div class="post" style="margin-bottom:10px;">
                    <div style="display:flex; align-items:center; padding:15px;">
                        <img src="${book.coverUrl || 'https://cdn-icons-png.flaticon.com/512/3523/3523063.png'}" 
                             style="width:50px; height:70px; border-radius:8px; object-fit:cover;">
                        <div style="flex:1; margin-right:15px;">
                            <div style="font-weight:bold; font-size:14px;">${book.title}</div>
                            <div style="font-size:11px; color:var(--text-sec);">
                                <i class="fas fa-user"></i> ${book.author} â€¢ 
                                <i class="fas fa-book-open"></i> ${book.subject}
                            </div>
                            <div style="font-size:10px; color:var(--accent); margin-top:3px;">
                                <i class="fas fa-graduation-cap"></i> ${book.grade}
                            </div>
                        </div>
                        <button class="btn-main" style="width:auto; padding:8px 12px; font-size:12px;" 
                                onclick="nav('book_detail', '${bookId}')">
                            <i class="fas fa-eye"></i> Ø¹Ø±Ø¶
                        </button>
                    </div>
                </div>`;
        });
    });
}

async function loadAdminStats() {
    const container = document.getElementById('admin-stats');
    if (!container) return;
    
    try {
        // Ø¬Ù„Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        const usersSnap = await db.ref('users').once('value');
        const users = usersSnap.val();
        const totalUsers = users ? Object.keys(users).length : 0;
        
        // Ø¬Ù„Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒØªØ¨
        const booksSnap = await db.ref('books').once('value');
        const books = booksSnap.val();
        const totalBooks = books ? Object.keys(books).length : 0;
        
        // Ø¬Ù„Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
        const notificationsSnap = await db.ref('notifications').orderByChild('read').equalTo(false).once('value');
        const pendingNotifications = notificationsSnap.val();
        const pendingCount = pendingNotifications ? Object.keys(pendingNotifications).length : 0;
        
        container.innerHTML = `
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:15px; margin-top:20px;">
                <div style="background:var(--bg-card); padding:20px; border-radius:15px; text-align:center;">
                    <div style="font-size:32px; font-weight:bold; color:var(--primary);">${totalUsers}</div>
                    <div style="font-size:14px; color:var(--text-sec);">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
                </div>
                
                <div style="background:var(--bg-card); padding:20px; border-radius:15px; text-align:center;">
                    <div style="font-size:32px; font-weight:bold; color:var(--accent);">${totalBooks}</div>
                    <div style="font-size:14px; color:var(--text-sec);">Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</div>
                </div>
                
                <div style="background:var(--bg-card); padding:20px; border-radius:15px; text-align:center;">
                    <div style="font-size:32px; font-weight:bold; color:var(--green);">${pendingCount}</div>
                    <div style="font-size:14px; color:var(--text-sec);">Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</div>
                </div>
                
                <div style="background:var(--bg-card); padding:20px; border-radius:15px; text-align:center;">
                    <div style="font-size:32px; font-weight:bold; color:var(--purple);">${ADMIN_BANK_ACCOUNT}</div>
                    <div style="font-size:14px; color:var(--text-sec);">Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¯Ù…Ù†</div>
                </div>
            </div>`;
        
    } catch (error) {
        container.innerHTML = `<p style="color:var(--red);">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ${error.message}</p>`;
    }
}

function filterBooks() {
    loadAllBooks();
}

const debounceSearch = debounce(function(query) {
    const container = document.getElementById('books-list');
    if (!container) return;
    
    db.ref('books').once('value').then(snap => {
        const books = snap.val();
        container.innerHTML = '';
        
        if (!books) return;
        
        const searchTerm = query.toLowerCase();
        Object.keys(books).forEach(bookId => {
            const book = books[bookId];
            const title = book.title.toLowerCase();
            const author = book.author.toLowerCase();
            const subject = book.subject.toLowerCase();
            const grade = book.grade.toLowerCase();
            
            if (title.includes(searchTerm) || author.includes(searchTerm) || 
                subject.includes(searchTerm) || grade.includes(searchTerm)) {
                
                const priceBadge = book.price > 0 ? 
                    `<span style="background:var(--accent); color:black; padding:3px 8px; border-radius:5px; font-size:11px; font-weight:bold;">${book.price} SDM</span>` :
                    `<span style="background:var(--green); color:white; padding:3px 8px; border-radius:5px; font-size:11px; font-weight:bold;">Ù…Ø¬Ø§Ù†ÙŠ</span>`;
                
                container.innerHTML += `
                    <div class="book-card">
                        <img src="${book.coverUrl || 'https://cdn-icons-png.flaticon.com/512/3523/3523063.png'}" 
                             class="book-cover">
                        <div style="flex:1;">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                <div>
                                    <div style="font-weight:bold; font-size:16px; margin-bottom:5px;">${book.title}</div>
                                    <div style="font-size:12px; color:var(--text-sec); margin-bottom:5px;">
                                        <i class="fas fa-user"></i> ${book.author}
                                    </div>
                                </div>
                                ${priceBadge}
                            </div>
                            
                            <div style="font-size:11px; color:var(--text-sec); margin-top:8px;">
                                <span class="grade-badge">${book.grade}</span>
                                <span style="background:rgba(59, 130, 246, 0.2); color:var(--primary); padding:3px 8px; border-radius:5px; margin-right:5px;">
                                    ${book.subject}
                                </span>
                            </div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:5px;">
                            <button class="btn-main" style="padding:8px 12px; font-size:12px;" 
                                    onclick="nav('book_detail', '${bookId}')">
                                <i class="fas fa-eye"></i> Ø¹Ø±Ø¶
                            </button>
                            <button class="btn-main" style="padding:8px 12px; font-size:12px; background:var(--purple);" 
                                    onclick="selectBookForAI('${bookId}', '${book.title.replace(/'/g, "\\'")}')">
                                <i class="fas fa-robot"></i> Ø§Ø®ØªØ¨Ø§Ø±
                            </button>
                        </div>
                    </div>`;
            }
        });
    });
}, 500);

const debounceFilter = debounce(function(query) {
    debounceSearch(query);
}, 300);

// ==================== [ 17. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ] ====================
// Ù…Ø±Ø§Ù‚Ø¨ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
firebase.auth().onAuthStateChanged(function(user) {
    const preloader = document.getElementById('main-preloader');
    const authScreen = document.getElementById('auth-screen');
    const appScreen = document.getElementById('app-screen');

    if (user) {
        startApp(user.uid);
    } else if (!isGuest) {
        preloader.style.display = 'none';
        authScreen.classList.remove('hidden');
        appScreen.classList.add('hidden');
    }
});

// ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        const preloader = document.getElementById('main-preloader');
        const authScreen = document.getElementById('auth-screen');
        
        if (!firebase.auth().currentUser && !isGuest) {
            preloader.style.display = 'none';
            authScreen.classList.remove('hidden');
        }
    }, 1000);
    
    // ØªÙ‡ÙŠØ¦Ø© Web Speech API
    if ('speechSynthesis' in window) {
        speechSynthesis.getVoices(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª
    }
});

// Ø¬Ø¹Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
window.nav = nav;
window.loginWithGoogle = loginWithGoogle;
window.enterGuestMode = enterGuestMode;
window.doLogout = doLogout;
window.handleBackButton = handleBackButton;
window.selectBookForAI = selectBookForAI;
window.generateBookQuizAI = generateBookQuizAI;
window.selectQuizAnswer = selectQuizAnswer;
window.submitQuiz = submitQuiz;
window.createLiveRoom = createLiveRoom;
window.joinLiveRoom = joinLiveRoom;
window.payForLiveRoom = payForLiveRoom;
window.showPublicLibrary = showPublicLibrary;
window.closePublicLibrary = closePublicLibrary;
window.addPublicBook = addPublicBook;
window.downloadPublicBook = downloadPublicBook;
window.deletePublicBook = deletePublicBook;
window.buySubscription = buySubscription;
window.sendPaymentNotification = sendPaymentNotification;
window.updateTeacherAccount = updateTeacherAccount;
window.filterBooks = filterBooks;
window.loadBooksByGrade = loadBooksByGrade;
window.deleteBook = deleteBook;
window.submitBookForm = submitBookForm;
window.toggleUploadMethod = toggleUploadMethod;
window.handleFileUpload = handleFileUpload;
window.handleCoverUpload = handleCoverUpload;
window.removeUploadedFile = removeUploadedFile;
window.removeUploadedCover = removeUploadedCover;
window.explainBookWithAI = explainBookWithAI;
window.generateVoice = generateVoice;
window.playVoice = playVoice;
window.pauseVoice = pauseVoice;
window.stopVoice = stopVoice;
window.downloadVoice = downloadVoice;
window.seekVoice = seekVoice;

// Ø¯ÙˆØ§Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨
window.downloadBook = async function(bookId, price, bookUrl) {
    if (!bookUrl) {
        showError('Ø±Ø§Ø¨Ø· Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ØªÙˆÙØ±');
        return;
    }
    
    if (me.uid === 'guest') {
        showError('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ¨');
        return;
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©
    const isFreeTrial = me.freeTrial && me.freeUntil > Date.now();
    
    if (price > 0 && !isFreeTrial) {
        if (me.balance < price) {
            showError(`Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ. ØªØ­ØªØ§Ø¬ ${price} SDM`);
            nav('subscription');
            return;
        }
        
        const confirm = await Swal.fire({
            title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡',
            html: `Ø³Ø¹Ø± Ø§Ù„ÙƒØªØ§Ø¨: <strong>${price} SDM</strong><br>
                   Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø±ØµÙŠØ¯Ùƒ`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ø´Ø±Ø§Ø¡ ÙˆØªØ­Ù…ÙŠÙ„',
            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
            background: '#1e293b',
            color: '#fff'
        });
        
        if (!confirm.isConfirmed) return;
        
        showLoading('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø´Ø±Ø§Ø¡...');
        
        try {
            // Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº
            const newBalance = me.balance - price;
            await db.ref(`users/${me.uid}/balance`).set(newBalance);
            me.balance = newBalance;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶
            document.getElementById('u-stars').innerText = me.balance + ' SDM';
            
            hideLoading();
            
        } catch (error) {
            hideLoading();
            showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡: ' + error.message);
            return;
        }
    }
    
    // Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø§Øª
    await db.ref(`books/${bookId}/downloads`).transaction(current => (current || 0) + 1);
    
    // ÙØªØ­ Ø§Ù„ÙƒØªØ§Ø¨ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
    window.open(bookUrl, '_blank');
    
    showSuccess('Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ø§Ù„ÙƒØªØ§Ø¨...');
};

// Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¯Ù…Ù†
window.manageBooks = function() { nav('library'); };
window.manageUsers = async function() {
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...');
    
    try {
        const usersSnap = await db.ref('users').once('value');
        const users = usersSnap.val();
        
        let usersHtml = `
            <div style="max-height:400px; overflow-y:auto; text-align:right;">
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="background:var(--bg-card);">
                            <th style="padding:10px; text-align:right;">Ø§Ù„Ø§Ø³Ù…</th>
                            <th style="padding:10px; text-align:center;">Ø§Ù„Ø¯ÙˆØ±</th>
                            <th style="padding:10px; text-align:center;">Ø§Ù„Ø±ØµÙŠØ¯</th>
                            <th style="padding:10px; text-align:center;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody>`;
        
        if (users) {
            Object.entries(users).forEach(([userId, user]) => {
                if (user.role === 'admin') return; // ØªØ®Ø·ÙŠ Ø§Ù„Ø¥Ø¯Ù…Ù†
                
                usersHtml += `
                    <tr style="border-bottom:1px solid var(--border);">
                        <td style="padding:10px;">
                            <div style="font-weight:bold;">${user.name}</div>
                            <div style="font-size:11px; color:var(--text-sec);">${user.email || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</div>
                        </td>
                        <td style="padding:10px; text-align:center;">
                            <span style="background:${user.role === 'teacher' ? 'var(--purple)' : 'var(--primary)'}; color:white; padding:3px 8px; border-radius:5px; font-size:11px;">
                                ${user.role === 'teacher' ? 'Ø£Ø³ØªØ§Ø°' : 'Ù…Ø³ØªØ®Ø¯Ù…'}
                            </span>
                        </td>
                        <td style="padding:10px; text-align:center; font-weight:bold; color:var(--accent);">
                            ${user.balance || 0} SDM
                        </td>
                        <td style="padding:10px; text-align:center;">
                            <button onclick="editUserBalance('${userId}', '${user.name}', ${user.balance || 0})" 
                                    style="background:var(--accent); color:black; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:12px;">
                                <i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„
                            </button>
                        </td>
                    </tr>`;
            });
        }
        
        usersHtml += `</tbody></table></div>`;
        
        hideLoading();
        
        await Swal.fire({
            title: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†',
            html: usersHtml,
            width: 800,
            showConfirmButton: false,
            showCloseButton: true,
            background: '#1e293b',
            color: '#fff'
        });
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
    }
};

window.editUserBalance = async function(userId, userName, currentBalance) {
    const { value: newBalance } = await Swal.fire({
        title: `ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯ ${userName}`,
        input: 'number',
        inputLabel: 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (SDM)',
        inputValue: currentBalance,
        showCancelButton: true,
        confirmButtonText: 'ØªØ­Ø¯ÙŠØ«',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        background: '#1e293b',
        color: '#fff',
        inputValidator: (value) => {
            if (value === '' || value < 0) {
                return 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© ØµØ­ÙŠØ­Ø©';
            }
        }
    });
    
    if (newBalance === null) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯...');
    
    try {
        await db.ref(`users/${userId}/balance`).set(parseInt(newBalance));
        hideLoading();
        showSuccess('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­');
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
    }
};

window.managePayments = async function() {
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©...');
    
    try {
        const notificationsSnap = await db.ref('notifications').orderByChild('read').equalTo(false).once('value');
        const notifications = notificationsSnap.val();
        
        let paymentsHtml = `
            <div style="max-height:400px; overflow-y:auto; text-align:right;">
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="background:var(--bg-card);">
                            <th style="padding:10px; text-align:right;">Ø§Ù„Ù†ÙˆØ¹</th>
                            <th style="padding:10px; text-align:center;">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                            <th style="padding:10px; text-align:center;">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                            <th style="padding:10px; text-align:center;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th style="padding:10px; text-align:center;">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                        </tr>
                    </thead>
                    <tbody>`;
        
        if (notifications) {
            Object.entries(notifications).forEach(([notifId, notif]) => {
                let typeText = '';
                if (notif.type === 'deposit_notification') {
                    typeText = 'Ø¥ÙŠØ¯Ø§Ø¹ Ø±ØµÙŠØ¯';
                } else if (notif.type === 'room_payment') {
                    typeText = 'Ø¯ÙØ¹ ØºØ±ÙØ© Ø¨Ø«';
                } else if (notif.type === 'book_pending') {
                    typeText = 'ÙƒØªØ§Ø¨ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©';
                }
                
                paymentsHtml += `
                    <tr style="border-bottom:1px solid var(--border);">
                        <td style="padding:10px;">
                            <span style="background:var(--primary); color:white; padding:3px 8px; border-radius:5px; font-size:11px;">
                                ${typeText}
                            </span>
                            ${notif.roomTitle ? `<div style="font-size:11px; color:var(--text-sec);">${notif.roomTitle}</div>` : ''}
                            ${notif.bookTitle ? `<div style="font-size:11px; color:var(--text-sec);">${notif.bookTitle}</div>` : ''}
                        </td>
                        <td style="padding:10px; text-align:center;">
                            <div style="font-weight:bold;">${notif.userName}</div>
                            ${notif.receipt ? `<div style="font-size:11px; color:var(--accent);">${notif.receipt}</div>` : ''}
                        </td>
                        <td style="padding:10px; text-align:center; font-weight:bold; color:var(--accent);">
                            ${notif.amount || 0} SDM
                        </td>
                        <td style="padding:10px; text-align:center; font-size:12px; color:var(--text-sec);">
                            ${formatDate(notif.timestamp)}
                        </td>
                        <td style="padding:10px; text-align:center;">
                            ${notif.type === 'deposit_notification' ? `
                            <button onclick="confirmDeposit('${notifId}', '${notif.userId}', '${notif.userName}', ${notif.amount})" 
                                    style="background:var(--green); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:12px; margin:2px;">
                                <i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯
                            </button>
                            <button onclick="rejectPayment('${notifId}')" 
                                    style="background:var(--red); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:12px; margin:2px;">
                                <i class="fas fa-times"></i> Ø±ÙØ¶
                            </button>
                            ` : notif.type === 'book_pending' ? `
                            <button onclick="approveBook('${notif.bookId}', '${notifId}')" 
                                    style="background:var(--green); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:12px; margin:2px;">
                                <i class="fas fa-check"></i> Ù…ÙˆØ§ÙÙ‚Ø©
                            </button>
                            <button onclick="rejectBook('${notif.bookId}', '${notifId}')" 
                                    style="background:var(--red); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:12px; margin:2px;">
                                <i class="fas fa-times"></i> Ø±ÙØ¶
                            </button>
                            ` : notif.type === 'room_payment' ? `
                            <button onclick="confirmRoomPayment('${notifId}', '${notif.paymentId}', '${notif.userId}', ${notif.amount})" 
                                    style="background:var(--green); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:12px; margin:2px;">
                                <i class="fas fa-check"></i> ØªØ£ÙƒÙŠØ¯
                            </button>
                            ` : ''}
                            <button onclick="markAsRead('${notifId}')" 
                                    style="background:var(--text-sec); color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:12px; margin:2px;">
                                <i class="fas fa-eye-slash"></i> ØªØ¬Ø§Ù‡Ù„
                            </button>
                        </td>
                    </tr>`;
            });
        }
        
        paymentsHtml += `</tbody></table></div>`;
        
        hideLoading();
        
        await Swal.fire({
            title: 'Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©',
            html: paymentsHtml,
            width: 900,
            showConfirmButton: false,
            showCloseButton: true,
            background: '#1e293b',
            color: '#fff'
        });
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
    }
};

window.confirmDeposit = async function(notifId, userId, userName, amount) {
    const confirm = await Swal.fire({
        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹',
        html: `ØªØ£ÙƒÙŠØ¯ Ø¥ÙŠØ¯Ø§Ø¹ <strong>${amount} SDM</strong> Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… <strong>${userName}</strong>ØŸ`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        background: '#1e293b',
        color: '#fff'
    });
    
    if (!confirm.isConfirmed) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹...');
    
    try {
        // Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const userSnap = await db.ref(`users/${userId}/balance`).once('value');
        const currentBalance = userSnap.val() || 0;
        const newBalance = currentBalance + parseInt(amount);
        
        // ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        await db.ref(`users/${userId}/balance`).set(newBalance);
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ÙƒÙ…Ù‚Ø±ÙˆØ¡
        await db.ref(`notifications/${notifId}`).update({
            read: true,
            confirmed: true,
            confirmedAt: Date.now(),
            confirmedBy: me.name
        });
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        await db.ref(`user_notifications/${userId}`).push({
            type: 'deposit_confirmed',
            amount: amount,
            newBalance: newBalance,
            timestamp: Date.now(),
            read: false
        });
        
        hideLoading();
        showSuccess(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${amount} SDM Ù„Ø­Ø³Ø§Ø¨ ${userName}`);
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
    }
};

window.confirmRoomPayment = async function(notifId, paymentId, userId, amount) {
    const confirm = await Swal.fire({
        title: 'ØªØ£ÙƒÙŠØ¯ Ø¯ÙØ¹ ØºØ±ÙØ© Ø§Ù„Ø¨Ø«',
        html: `ØªØ£ÙƒÙŠØ¯ Ø¯ÙØ¹ <strong>${amount} SDM</strong> Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ø§Ù„Ø¨Ø«ØŸ`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        background: '#1e293b',
        color: '#fff'
    });
    
    if (!confirm.isConfirmed) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹...');
    
    try {
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹
        const paymentPath = paymentId.includes('_') ? 
            `room_payments/${paymentId}` : 
            `room_payments/${paymentId.split('_')[1]}_${userId}`;
        
        await db.ref(paymentPath).update({
            confirmed: true,
            confirmedAt: Date.now(),
            confirmedBy: me.name
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        await db.ref(`notifications/${notifId}`).update({
            read: true,
            confirmed: true,
            confirmedAt: Date.now()
        });
        
        hideLoading();
        showSuccess('ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­');
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
    }
};

window.approveBook = async function(bookId, notifId) {
    const confirm = await Swal.fire({
        title: 'Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙƒØªØ§Ø¨',
        html: 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ù†Ø´Ø± Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨ØŸ',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ù…ÙˆØ§ÙÙ‚Ø©',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        background: '#1e293b',
        color: '#fff'
    });
    
    if (!confirm.isConfirmed) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙƒØªØ§Ø¨...');
    
    try {
        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨
        await db.ref(`books/${bookId}/status`).set('approved');
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        await db.ref(`notifications/${notifId}`).update({
            read: true,
            approved: true,
            approvedAt: Date.now(),
            approvedBy: me.name
        });
        
        hideLoading();
        showSuccess('ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙƒØªØ§Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
    }
};

window.rejectPayment = async function(notifId) {
    const { value: reason } = await Swal.fire({
        title: 'Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶',
        input: 'text',
        inputLabel: 'Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø±ÙØ¶ Ø§Ù„Ø¯ÙØ¹',
        inputPlaceholder: 'Ù…Ø«Ø§Ù„: Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­',
        showCancelButton: true,
        confirmButtonText: 'Ø±ÙØ¶',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        background: '#1e293b',
        color: '#fff',
        inputValidator: (value) => {
            if (!value) {
                return 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶';
            }
        }
    });
    
    if (!reason) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¶ Ø§Ù„Ø¯ÙØ¹...');
    
    try {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        await db.ref(`notifications/${notifId}`).update({
            read: true,
            rejected: true,
            rejectedReason: reason,
            rejectedAt: Date.now(),
            rejectedBy: me.name
        });
        
        hideLoading();
        showSuccess('ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­');
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
    }
};

window.rejectBook = async function(bookId, notifId) {
    const { value: reason } = await Swal.fire({
        title: 'Ø³Ø¨Ø¨ Ø±ÙØ¶ Ø§Ù„ÙƒØªØ§Ø¨',
        input: 'text',
        inputLabel: 'Ø£Ø¯Ø®Ù„ Ø³Ø¨Ø¨ Ø±ÙØ¶ Ø§Ù„ÙƒØªØ§Ø¨',
        inputPlaceholder: 'Ù…Ø«Ø§Ù„: Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ØºÙŠØ± Ù…Ù†Ø§Ø³Ø¨',
        showCancelButton: true,
        confirmButtonText: 'Ø±ÙØ¶',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        background: '#1e293b',
        color: '#fff',
        inputValidator: (value) => {
            if (!value) {
                return 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶';
            }
        }
    });
    
    if (!reason) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ Ø±ÙØ¶ Ø§Ù„ÙƒØªØ§Ø¨...');
    
    try {
        // Ø­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨
        await db.ref(`books/${bookId}`).remove();
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        await db.ref(`notifications/${notifId}`).update({
            read: true,
            rejected: true,
            rejectedReason: reason,
            rejectedAt: Date.now(),
            rejectedBy: me.name
        });
        
        hideLoading();
        showSuccess('ØªÙ… Ø±ÙØ¶ ÙˆØ­Ø°Ù Ø§Ù„ÙƒØªØ§Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
    }
};

window.markAsRead = async function(notifId) {
    await db.ref(`notifications/${notifId}`).update({
        read: true,
        markedAsRead: true,
        markedAt: Date.now()
    });
    
    showSuccess('ØªÙ… ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±');
};

window.manageSubscriptions = async function() {
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª...');
    
    try {
        const subsSnap = await db.ref('subscriptions').once('value');
        const subscriptions = subsSnap.val();
        
        let subsHtml = `
            <div style="max-height:400px; overflow-y:auto; text-align:right;">
                <table style="width:100%; border-collapse:collapse;">
                    <thead>
                        <tr style="background:var(--bg-card);">
                            <th style="padding:10px; text-align:right;">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                            <th style="padding:10px; text-align:center;">Ø§Ù„Ø®Ø·Ø©</th>
                            <th style="padding:10px; text-align:center;">Ø§Ù„Ø³Ø¹Ø±</th>
                            <th style="padding:10px; text-align:center;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡</th>
                            <th style="padding:10px; text-align:center;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</th>
                            <th style="padding:10px; text-align:center;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody>`;
        
        if (subscriptions) {
            // Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            const usersSnap = await db.ref('users').once('value');
            const users = usersSnap.val();
            
            Object.entries(subscriptions).forEach(([userId, sub]) => {
                const user = users[userId];
                const userName = user ? user.name : 'Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø°ÙˆÙ';
                const now = Date.now();
                const isActive = sub.active && sub.expiryDate > now;
                
                const planNames = {
                    'weekly': 'Ø£Ø³Ø¨ÙˆØ¹ÙŠ',
                    'monthly': 'Ø´Ù‡Ø±ÙŠ', 
                    'yearly': 'Ø³Ù†ÙˆÙŠ'
                };
                
                subsHtml += `
                    <tr style="border-bottom:1px solid var(--border);">
                        <td style="padding:10px;">
                            <div style="font-weight:bold;">${userName}</div>
                            <div style="font-size:11px; color:var(--text-sec);">${userId}</div>
                        </td>
                        <td style="padding:10px; text-align:center;">
                            <span style="background:var(--purple); color:white; padding:3px 8px; border-radius:5px; font-size:11px;">
                                ${planNames[sub.plan] || sub.plan}
                            </span>
                        </td>
                        <td style="padding:10px; text-align:center; font-weight:bold; color:var(--accent);">
                            ${sub.price} SDM
                        </td>
                        <td style="padding:10px; text-align:center; font-size:12px; color:var(--text-sec);">
                            ${formatDate(sub.startDate)}
                        </div>
                    </td>
                    <td style="padding:10px; text-align:center; font-size:12px; color:var(--text-sec);">
                        ${formatDate(sub.expiryDate)}
                    </td>
                    <td style="padding:10px; text-align:center;">
                        <span style="background:${isActive ? 'var(--green)' : 'var(--red)'}; color:white; padding:3px 8px; border-radius:5px; font-size:11px;">
                            ${isActive ? 'Ù†Ø´Ø·' : 'Ù…Ù†ØªÙ‡ÙŠ'}
                        </span>
                    </td>
                </tr>`;
            });
        }
        
        subsHtml += `</tbody></table></div>`;
        
        hideLoading();
        
        await Swal.fire({
            title: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª',
            html: subsHtml,
            width: 900,
            showConfirmButton: false,
            showCloseButton: true,
            background: '#1e293b',
            color: '#fff'
        });
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
    }
};

window.manageLiveRoom = async function(roomId) {
    const roomSnap = await db.ref(`live_rooms/${roomId}`).once('value');
    const room = roomSnap.val();
    
    if (!room) {
        showError('ØºØ±ÙØ© Ø§Ù„Ø¨Ø« ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
        return;
    }
    
    const isOwner = me.uid === room.teacherId || me.role === 'admin';
    if (!isOwner) {
        showError('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø¯Ø§Ø±Ø© Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©');
        return;
    }
    
    const now = Date.now();
    const isActive = room.status === 'active' && room.endTime > now;
    
    const { value: action } = await Swal.fire({
        title: `Ø¥Ø¯Ø§Ø±Ø© ØºØ±ÙØ©: ${room.title}`,
        html: `
            <div style="text-align:right; margin-bottom:20px;">
                <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${isActive ? 'ğŸ”´ Ù†Ø´Ø·Ø©' : 'â¸ï¸ ØºÙŠØ± Ù†Ø´Ø·Ø©'}</p>
                <p><strong>Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙˆÙ†:</strong> ${room.participants || 0}</p>
                <p><strong>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:</strong> ${room.earnings || 0} SDM</p>
            </div>
        `,
        icon: 'info',
        showCancelButton: isActive,
        confirmButtonText: isActive ? 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ø«' : 'Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ©',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        showDenyButton: true,
        denyButtonText: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª',
        background: '#1e293b',
        color: '#fff'
    });
    
    if (action === 'deny') {
        // ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØºØ±ÙØ©
        await editLiveRoom(roomId, room);
    } else if (action === 'confirm') {
        if (isActive) {
            // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ø«
            await endLiveRoom(roomId);
        } else {
            // Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ©
            await deleteLiveRoom(roomId);
        }
    }
};

async function editLiveRoom(roomId, room) {
    const { value: formValues } = await Swal.fire({
        title: 'ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØºØ±ÙØ©',
        html: `
            <input id="edit-title" class="swal2-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³" value="${room.title}">
            <textarea id="edit-description" class="swal2-input" placeholder="ÙˆØµÙ Ø§Ù„Ø¯Ø±Ø³" rows="3">${room.description || ''}</textarea>
            <input id="edit-price" class="swal2-input" placeholder="Ø§Ù„Ø³Ø¹Ø±" type="number" min="0" value="${room.price}">
            <input id="edit-account" class="swal2-input" placeholder="Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø³ØªØ§Ø°" value="${room.teacherAccount || ''}">
        `,
        confirmButtonText: 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª',
        showCancelButton: true,
        background: '#1e293b',
        color: '#fff',
        preConfirm: () => {
            const title = document.getElementById('edit-title').value;
            const description = document.getElementById('edit-description').value;
            const price = parseInt(document.getElementById('edit-price').value) || 0;
            const account = document.getElementById('edit-account').value;
            
            if (!title) {
                Swal.showValidationMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù†');
                return false;
            }
            
            return { title, description, price, account };
        }
    });
    
    if (!formValues) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª...');
    
    try {
        await db.ref(`live_rooms/${roomId}`).update({
            title: formValues.title,
            description: formValues.description,
            price: formValues.price,
            teacherAccount: formValues.account
        });
        
        hideLoading();
        showSuccess('ØªÙ… ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØºØ±ÙØ© Ø¨Ù†Ø¬Ø§Ø­');
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
    }
}

async function endLiveRoom(roomId) {
    const confirm = await Swal.fire({
        title: 'Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±',
        text: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±ØŸ',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø¥Ù†Ù‡Ø§Ø¡',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        background: '#1e293b',
        color: '#fff'
    });
    
    if (!confirm.isConfirmed) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ø«...');
    
    try {
        await db.ref(`live_rooms/${roomId}`).update({
            status: 'ended',
            endTime: Date.now()
        });
        
        hideLoading();
        showSuccess('ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¨Ù†Ø¬Ø§Ø­');
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
    }
}

async function deleteLiveRoom(roomId) {
    const confirm = await Swal.fire({
        title: 'Ø­Ø°Ù ØºØ±ÙØ© Ø§Ù„Ø¨Ø«',
        text: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ØºØ±ÙØ© Ø§Ù„Ø¨Ø«ØŸ',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        background: '#1e293b',
        color: '#fff'
    });
    
    if (!confirm.isConfirmed) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ©...');
    
    try {
        await db.ref(`live_rooms/${roomId}`).remove();
        hideLoading();
        showSuccess('ØªÙ… Ø­Ø°Ù ØºØ±ÙØ© Ø§Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­');
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
    }
}
</script>
</body>
</html>

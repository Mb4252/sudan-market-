
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† Ø§Ù„Ø´Ø§Ù…Ù„ ğŸ‡¸ğŸ‡©</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <style>
        :root { --primary: #008000; --secondary: #ff9900; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; margin: 0; background: var(--bg); color: #333; overflow-x: hidden; }
        
        /* --- Ø³ØªØ§ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© --- */
        .system-alert-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 20000;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .alert-box {
            background: white; width: 85%; max-width: 400px; border-radius: 20px;
            padding: 25px; text-align: center; border-top: 6px solid var(--secondary);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: popIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .alert-box h2 { color: var(--primary); margin-top: 0; }
        .alert-box p { line-height: 1.6; font-size: 16px; color: #444; }
        .alert-btn {
            background: var(--primary); color: white; border: none; padding: 12px 30px;
            border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 15px;
        }
        /* ---------------------------------- */

        #refresh-indicator { text-align: center; padding: 10px; display: none; background: #eee; color: #666; font-size: 14px; }
        .header-main { position: sticky; top: 0; z-index: 5000; background: var(--primary); padding: 10px; text-align: center; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .search-container { padding: 10px; background: var(--primary); display: flex; justify-content: center; }
        .search-input { width: 90%; padding: 10px 15px; border-radius: 25px; border: none; outline: none; font-size: 16px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2); }
        .cart-float { position: fixed; bottom: 20px; left: 20px; background: var(--secondary); color: white; padding: 12px 20px; border-radius: 50px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 9000; cursor: pointer; font-weight: bold; border: 2px solid white; }
        .slider-container { width: 100%; height: 180px; overflow: hidden; position: relative; background: #ddd; }
        .slider-track { display: flex; width: 300%; height: 100%; animation: slide 12s infinite linear; }
        .slider-track img { width: 33.33%; height: 100%; object-fit: cover; }
        @keyframes slide { 0%, 30% { transform: translateX(0); } 33%, 63% { transform: translateX(33.33%); } 66%, 96% { transform: translateX(66.66%); } 100% { transform: translateX(0); } }
        .grid-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 12px; }
        .cat-box { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.1); text-align: center; border: 1px solid #eee; cursor: pointer; }
        .cat-box img { width: 100%; height: 110px; object-fit: cover; background: #eee; }
        .cat-box b { display: block; padding: 10px; font-size: 12px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 10000; overflow-y: auto; }
        .overlay-header { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 11; }
        .item-card { background: white; margin: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); overflow: hidden; border-right: 5px solid var(--secondary); position: relative; }
        .item-media { width: 100%; max-height: 350px; object-fit: cover; width: 100%; }
        .price-badge { position: absolute; top: 10px; left: 10px; background: var(--secondary); color: white; padding: 5px 12px; border-radius: 8px; font-weight: bold; font-size: 14px; z-index: 5; }
        .btn-cart { background: #007bff; color: white; border: none; padding: 15px; width: 100%; font-weight: bold; cursor: pointer; border-bottom: 1px solid #ddd; }
        .btn-wa { background: #25D366; color: white; text-decoration: none; display: block; text-align: center; padding: 15px; font-weight: bold; }
        .btn-rate { width: 100%; padding: 10px; margin-top: 10px; background: white; border: 1px solid var(--primary); color: var(--primary); border-radius: 8px; font-weight: bold; cursor: pointer;}
        .form-add { background: white; margin: 15px; padding: 15px; border-radius: 12px; border: 2px solid var(--secondary); }
        .input-f { width: 100%; padding: 12px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; }
        .trust-section { background: #fffcf5; padding: 15px; border-top: 1px solid #eee; }
        .merchant-stars { color: #ff9900; font-size: 18px; display: block; margin-bottom: 5px; }
        .user-feedback { background: white; padding: 8px; border-radius: 8px; margin-bottom: 5px; font-size: 13px; border: 1px solid #eee; }
    </style>
</head>
<body ontouchstart="touchStart(event)" ontouchmove="touchMove(event)">

<div id="systemAlert" class="system-alert-overlay">
    <div class="alert-box">
        <h2>ğŸ“¢ ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù† Ø§Ù„Ù…Ø·ÙˆØ±</h2>
        <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨ÙƒÙ…ØŒ Ø£Ù†Ø§ Ø§Ù„Ù…Ø·ÙˆØ± <b>Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¹Ø·ÙŠ Ø¹Ù„ÙŠ</b>.<br>Ø£ÙˆØ¯ Ø¥Ø­Ø§Ø·ØªÙƒÙ… Ø¹Ù„Ù…Ø§Ù‹ Ø¨Ø£Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø³ÙˆÙ ÙŠØ´Ù‡Ø¯ <b>ØªØ­ÙˆÙ„Ø§Ù‹ ÙƒØ¨ÙŠØ±Ø§Ù‹ ØºØ¯Ø§Ù‹</b> Ø¨Ø¥Ø°Ù† Ø§Ù„Ù„Ù‡. Ø§Ù†ØªØ¸Ø±ÙˆØ§ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©!</p>
        <button class="alert-btn" onclick="closeAlert()">Ø­Ø³Ù†Ø§Ù‹ØŒ ÙÙ‡Ù…Øª</button>
    </div>
</div>

<div id="refresh-indicator">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«... ğŸ”„</div>

<div class="header-main">
    <b>Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† Ø§Ù„Ø´Ø§Ù…Ù„ ğŸ‡¸ğŸ‡©</b>
</div>

<div class="search-container">
    <input type="text" id="searchInput" class="search-input" placeholder="Ø¨Ø­Ø« Ø´Ø§Ù…Ù„ ÙÙŠ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…..." onkeyup="filterItems()">
</div>

<div class="cart-float" id="cartBtn" onclick="showCart()">ğŸ›’ Ø§Ù„Ø³Ù„Ø© (0)</div>

<div class="slider-container">
    <div class="slider-track">
        <img src="https://images.pexels.com/photos/5632371/pexels-photo-5632371.jpeg?auto=compress&cs=tinysrgb&w=600" alt="1">
        <img src="https://images.pexels.com/photos/3944405/pexels-photo-3944405.jpeg?auto=compress&cs=tinysrgb&w=600" alt="2">
        <img src="https://images.pexels.com/photos/1350789/pexels-photo-1350789.jpeg?auto=compress&cs=tinysrgb&w=600" alt="3">
    </div>
</div>

<div class="grid-container" id="mainGrid"></div>

<div id="overlay" class="overlay">
    <div class="overlay-header">
        <b id="titleTxt">Ø§Ù„Ù‚Ø³Ù…</b>
        <button onclick="closeLayer()" style="background:white; border:none; padding:5px 15px; border-radius:8px; color:red; font-weight:bold;">Ø±Ø¬ÙˆØ¹</button>
    </div>
    <div class="form-add" id="publishForm">
        <h3 id="formTitle" style="margin:0 0 10px 0; color:var(--primary);">Ù†Ø´Ø± Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯</h3>
        <input type="text" id="pName" class="input-f" placeholder="Ø§Ø³Ù… Ø§Ù„ØºØ±Ø¶">
        <input type="number" id="pPrice" class="input-f" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡">
        <textarea id="pDesc" class="input-f" placeholder="Ø§Ù„ØªÙØ§ØµÙŠÙ„"></textarea>
        <input type="number" id="pWa" class="input-f" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨">
        <label style="display:block; background:#eee; padding:12px; text-align:center; border-radius:8px; cursor:pointer; margin-bottom:10px;">
            ğŸ“¸ Ø§Ø±ÙÙ‚ Ù…ÙŠØ¯ÙŠØ§ <input type="file" id="pMedia" accept="image/*,video/*" hidden>
        </label>
        <button onclick="saveToCloud()" id="btnSave" style="width:100%; padding:15px; background:var(--secondary); color:white; border:none; border-radius:8px; font-weight:bold;">Ù†Ø´Ø± Ø§Ù„Ø¢Ù† âœ…</button>
        <button onclick="cancelEdit()" id="btnCancel" style="display:none; width:100%; padding:10px; background:#666; color:white; border:none; border-radius:8px; margin-top:5px;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
    </div>
    <div id="items-list"></div>
</div>

<script>
    // Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
    function closeAlert() {
        document.getElementById('systemAlert').style.display = 'none';
    }

    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ---
    const firebaseConfig = { 
        apiKey: "AIzaSyAI_mUhuPNoO-XC0Q-VNoWft8UWFbAbIGg",
        databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com",
        projectId: "sudan-market-6b122",
        storageBucket: "sudan-market-6b122.firebasestorage.app"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    // Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ ÙƒÙ…Ø§ Ù‡Ùˆ...
    let startY = 0;
    function touchStart(e) { startY = e.touches[0].pageY; }
    function touchMove(e) {
        const moveY = e.touches[0].pageY;
        if (window.scrollY === 0 && moveY > startY + 100) {
            document.getElementById('refresh-indicator').style.display = 'block';
            location.reload();
        }
    }

    const cats = [
        { id: 'mobs', t: 'ğŸ“± Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„Ø§Øª ÙˆØ§Ù„ØªÙ‚Ù†ÙŠØ©', img: 'https://images.pexels.com/photos/404280/pexels-photo-404280.jpeg?auto=compress&cs=tinysrgb&w=300' },
        { id: 'laptops', t: 'ğŸ’» Ù„Ø§Ø¨ØªÙˆØ¨Ø§Øª ÙˆÙƒÙ…Ø¨ÙŠÙˆØªØ±', img: 'https://images.pexels.com/photos/18105/pexels-photo.jpg?auto=compress&cs=tinysrgb&w=300' },
        { id: 'mghalg', t: 'ğŸ—ï¸ Ø§Ù„Ù…ØºØ§Ù„Ù‚ ÙˆØ§Ù„Ø¨Ù†Ø§Ø¡', img: 'https://images.pexels.com/photos/2219024/pexels-photo-2219024.jpeg?auto=compress&cs=tinysrgb&w=300' },
        { id: 'perfumes', t: 'ğŸ§ª Ø¹Ø·ÙˆØ± ÙˆØ¨Ø®ÙˆØ±', img: 'https://images.pexels.com/photos/1961795/pexels-photo-1961795.jpeg?auto=compress&cs=tinysrgb&w=300' },
        { id: 'clothes', t: 'ğŸ‘• Ø§Ù„Ù…Ù„Ø§Ø¨Ø³ ÙˆØ§Ù„Ø£Ø²ÙŠØ§Ø¡', img: 'https://images.pexels.com/photos/996329/pexels-photo-996329.jpeg?auto=compress&cs=tinysrgb&w=300' },
        { id: 'shoes', t: 'ğŸ‘Ÿ Ø£Ø­Ø°ÙŠØ© ÙˆØ´Ù†Ø·', img: 'https://images.pexels.com/photos/2529148/pexels-photo-2529148.jpeg?auto=compress&cs=tinysrgb&w=300' },
        { id: 'cars', t: 'ğŸš— Ø³ÙŠØ§Ø±Ø§Øª ÙˆØ¹Ù‚Ø§Ø±Ø§Øª', img: 'https://images.pexels.com/photos/210019/pexels-photo-210019.jpeg?auto=compress&cs=tinysrgb&w=300' }
    ];

    let cart = [];
    let activeCat = '', editId = null, oldMediaUrl = "";

    const grid = document.getElementById('mainGrid');
    cats.forEach(c => {
        grid.innerHTML += `<div class="cat-box" onclick="openLayer('${c.t}', '${c.id}')">
            <img src="${c.img}" onerror="this.src='https://via.placeholder.com/300x200'">
            <b>${c.t}</b>
        </div>`;
    });

    function openLayer(t, id) { 
        activeCat = id; 
        document.getElementById('titleTxt').innerText = t; 
        document.getElementById('overlay').style.display = 'block'; 
        document.getElementById('publishForm').style.display = 'block';
        cancelEdit();
        loadItems(id); 
    }

    function closeLayer() { 
        document.getElementById('overlay').style.display = 'none'; 
        document.getElementById('mainGrid').style.display = 'grid';
        document.getElementById('searchInput').value = ""; 
    }

    async function filterItems() {
        const query = document.getElementById('searchInput').value.trim().toLowerCase();
        const mainGrid = document.getElementById('mainGrid');
        const itemsList = document.getElementById('items-list');
        const overlay = document.getElementById('overlay');
        const publishForm = document.getElementById('publishForm');

        if (query === "") { closeLayer(); return; }

        mainGrid.style.display = 'none';
        overlay.style.display = 'block';
        publishForm.style.display = 'none'; 
        document.getElementById('titleTxt').innerText = "Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«: " + query;
        itemsList.innerHTML = '<p style="text-align:center; padding:20px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«... ğŸ”</p>';

        db.ref('products').once('value', snap => {
            const allCats = snap.val();
            itemsList.innerHTML = '';
            let found = false;
            for (let catKey in allCats) {
                for (let prodKey in allCats[catKey]) {
                    const item = allCats[catKey][prodKey];
                    if (item.name.toLowerCase().includes(query)) {
                        createItemUI(itemsList, prodKey, item, catKey);
                        found = true;
                    }
                }
            }
            if (!found) itemsList.innerHTML = '<div style="text-align:center; padding:50px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ğŸ˜•</div>';
        });
    }

    function createItemUI(container, key, item, catId) {
        const card = document.createElement('div');
        card.className = 'item-card';
        card.innerHTML = `
            <div class="price-badge">${item.price} Ø¬.Ø³</div>
            ${item.media ? (item.mType === 'video' ? `<video controls class="item-media" src="${item.media}"></video>` : `<img class="item-media" src="${item.media}">`) : ''}
            <div style="padding:15px;">
                <b style="font-size:18px; color:var(--primary);">${item.name}</b>
                <p style="font-size:14px; color:#444;">${item.desc}</p>
                <div class="trust-section">
                    <span class="merchant-stars" id="stars_${key}">â­â­â­â­â­</span>
                    <div id="revs_${key}"></div>
                    <button class="btn-rate" onclick="rateMerchant('${catId}', '${key}')">ğŸ’¬ Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚/ØªÙ‚ÙŠÙŠÙ…</button>
                </div>
            </div>
            <button class="btn-cart" onclick="addToCart('${key}', '${item.name}', ${item.price}, '${item.wa}')">ğŸ›’ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
            <button class="btn-wa" onclick="window.location.href='https://wa.me/${item.wa}'">ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø± âœ…</button>
            <div style="display:flex; justify-content: space-around; padding:10px; background:#f9f9f9;">
                <small style="color:blue; cursor:pointer;" onclick="activeCat='${catId}'; prepareEdit('${key}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</small>
                <small style="color:red; cursor:pointer;" onclick="activeCat='${catId}'; delItem('${key}')">ğŸ—‘ï¸ Ø­Ø°Ù</small>
            </div>
        `;
        container.appendChild(card);
        loadTrust(catId, key); 
    }

    async function saveToCloud() {
        const n = document.getElementById('pName').value, pr = document.getElementById('pPrice').value, w = document.getElementById('pWa').value, d = document.getElementById('pDesc').value, file = document.getElementById('pMedia').files[0];
        if(!n || !pr || !w) return alert("Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        
        const btn = document.getElementById('btnSave'); btn.disabled = true;
        let url = oldMediaUrl, type = "image";
        
        if(file) {
            const ref = storage.ref().child(`market/${activeCat}/${Date.now()}`);
            await ref.put(file); url = await ref.getDownloadURL();
            type = file.type.startsWith('video') ? 'video' : 'image';
        }

        const data = { name: n, price: pr, desc: d, wa: w, media: url, mType: type };
        if(editId) await db.ref(`products/${activeCat}/${editId}`).update(data);
        else await db.ref(`products/${activeCat}`).push(data);

        alert("ØªÙ… Ø¨Ù†Ø¬Ø§Ø­");
        cancelEdit();
    }

    function loadItems(id) {
        const list = document.getElementById('items-list');
        db.ref('products/' + id).on('value', snap => {
            list.innerHTML = '';
            const data = snap.val();
            for(let key in data) { createItemUI(list, key, data[key], id); }
        });
    }

    function rateMerchant(catId, pId) {
        const s = prompt("Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (1-5):", "5"), m = prompt("Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ:");
        if(s && m) {
            let stars = ""; for(let i=0; i<Math.min(5, parseInt(s)); i++) stars += "â­";
            db.ref(`trust/${catId}/${pId}`).push({ stars: stars, text: m });
        }
    }

    function loadTrust(catId, pId) {
        db.ref(`trust/${catId}/${pId}`).on('value', snap => {
            const data = snap.val(), div = document.getElementById('revs_'+pId), sDiv = document.getElementById('stars_'+pId);
            if(!div || !sDiv) return;
            div.innerHTML = '';
            if(data) {
                for(let k in data) {
                    const b = document.createElement('div'); b.className = 'user-feedback';
                    b.innerText = "ğŸ’¬ " + data[k].text; div.appendChild(b);
                    sDiv.innerText = data[k].stars;
                }
            }
        });
    }

    function addToCart(id, name, price, wa) {
        cart.push({name, price: parseFloat(price), wa});
        document.getElementById('cartBtn').innerText = `ğŸ›’ Ø§Ù„Ø³Ù„Ø© (${cart.length})`;
    }

    function showCart() {
        if(cart.length === 0) return alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©");
        let txt = "Ø·Ù„Ø¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©:\n";
        let total = 0;
        cart.forEach((it, i) => { txt += `${i+1}. ${it.name} (${it.price} Ø¬.Ø³)\n`; total += it.price; });
        window.location.href = `https://wa.me/${cart[0].wa}?text=${encodeURIComponent(txt + "\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: " + total)}`;
        cart = []; document.getElementById('cartBtn').innerText = "ğŸ›’ Ø§Ù„Ø³Ù„Ø© (0)";
    }

    function prepareEdit(id) {
        db.ref(`products/${activeCat}/${id}`).once('value', snap => {
            const item = snap.val();
            document.getElementById('pName').value = item.name;
            document.getElementById('pPrice').value = item.price;
            document.getElementById('pDesc').value = item.desc;
            document.getElementById('pWa').value = item.wa;
            oldMediaUrl = item.media || ""; editId = id;
            document.getElementById('btnCancel').style.display = "block";
            window.scrollTo(0,0);
        });
    }

    function cancelEdit() {
        editId = null; 
        document.querySelectorAll('.input-f').forEach(i => i.value = "");
        document.getElementById('btnCancel').style.display = "none";
        document.getElementById('btnSave').disabled = false;
    }

    function delItem(id) { if(confirm("Ø­Ø°ÙØŸ")) db.ref(`products/${activeCat}/${id}`).remove(); }
</script>
</body>
</html>

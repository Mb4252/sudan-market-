<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SDM Market | Ø¬ÙˆÙ‡Ø±Ø© Ø³ÙˆÙ„Ø§Ù†Ø§ ğŸ‡¸ğŸ‡©</title>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© -->
    <!-- Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ ReCaptcha -->
    <script src="https://www.google.com/recaptcha/api.js?render=6Lcd0UAsAAAAAsgLIU9rpyti0xHtrgwC2dvklv_"></script>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "74a3085c-32b9-4c35-bc32-e67c3a2506c3",
        });
      });
    </script>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³ (v8.10.1) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app-check.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --navy: #0d1117; --gold: #ffc107; --blue: #007bff; --bg: #f4f6f9; --green: #28a745; --red: #dc3545; --white: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); padding-bottom: 75px; direction: rtl; user-select: none; }
        .hidden { display: none !important; }
        .show-error { display: block !important; color: var(--red); font-size: 12px; margin-top: -5px; margin-bottom: 10px; font-weight: bold; }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« */
        header { background: var(--navy); color: white; padding: 10px 15px; display: flex; flex-direction: column; gap: 10px; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid var(--gold); }
        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .search-container { position: relative; width: 100%; }
        .search-container input { width: 100%; padding: 8px 35px 8px 10px; border-radius: 20px; border: none; font-size: 14px; background: rgba(255,255,255,0.15); color: white; margin: 0; outline: none; transition: 0.3s; }
        .search-container input:focus { background: rgba(255,255,255,0.25); }
        .search-container i { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #ddd; }

        /* Ø´Ø±ÙŠØ· ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ± */
        #dev-alert-bar { background: linear-gradient(90deg, #c0392b, #e74c3c); color: white; padding: 8px; text-align: center; font-size: 13px; font-weight: bold; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.95; } 50% { opacity: 1; } 100% { opacity: 0.95; } }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ù†Ø²Ù„Ù‚ (Slider) */
        .slider-container { position: relative; width: 100%; height: 180px; overflow: hidden; margin-bottom: 15px; border-radius: 0 0 15px 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #slider-img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.5s; cursor: pointer; }
        .slider-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.5); color: #fff; padding: 5px; text-align: center; font-size: 12px; }
        .edit-slider-btn { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: var(--gold); padding: 6px 12px; border-radius: 20px; cursor: pointer; z-index: 100; font-size: 12px; border: 1px solid var(--gold); display: flex; align-items: center; gap: 5px; }

        .publish-container { background: var(--white); margin: 15px; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #eef; }
        .publish-container h4 { font-size: 22px; color: var(--navy); margin-bottom: 15px; border-right: 4px solid var(--blue); padding-right: 10px; }
        .publish-container input, .publish-container textarea { border: 1.5px solid #eee; transition: 0.3s; font-size: 15px; }
        .publish-container input:focus { border-color: var(--blue); outline: none; box-shadow: 0 0 8px rgba(0,123,255,0.2); }

        .welcome-msg { position: absolute; top: 110px; left: 10px; font-size: 12px; background: rgba(13, 17, 23, 0.8); color: white; padding: 5px 10px; border-radius: 20px; z-index: 999; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px; }
        
        .card { background: white; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; border: 1px solid #eee; transition: 0.3s; position: relative; }
        .card:hover { transform: translateY(-5px); border-color: var(--gold); }
        .edit-cat-btn { position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.7); color: var(--gold); border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; z-index: 10; border: 1px solid var(--gold); }
        .cat-custom-img { width: 50px; height: 50px; object-fit: cover; margin-bottom: 10px; border-radius: 10px; }

        .btn-main { background: var(--blue); color: white; border: none; padding: 14px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; transition: 0.3s; }
        .btn-guest { background: #6c757d; margin-top: 10px; width: 100%; padding: 12px; border:none; color: white; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .btn-google { background: #db4437; color: white; box-shadow: 0 4px 10px rgba(219, 68, 55, 0.3); display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        .bottom-tabs { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; padding: 10px 0; z-index: 1000; }
        .tab-btn { flex: 1; text-align: center; color: #555; cursor: pointer; font-size: 11px; }
        .tab-btn i { font-size: 20px; display: block; margin-bottom: 2px; }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        
        .transfer-input { width: 100%; padding: 15px !important; margin: 10px 0; border: 2px solid #ddd !important; border-radius: 12px !important; font-size: 18px !important; text-align: center; box-sizing: border-box; background: #fdfdfd; }
        .transfer-input:focus { border-color: var(--blue) !important; background: #fff; }

        .post { background: white; margin: 15px; border-radius: 15px; overflow: hidden; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #eee; }
        .post-img-container { position: relative; width: 100%; height: 220px; }
        .sold-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(220, 53, 69, 0.8); color: white; display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: bold; z-index: 5; }
        .price-tag { color: var(--green); font-weight: 800; font-size: 18px; }
        .old-price { text-decoration: line-through; color: var(--red); font-size: 14px; margin-left: 10px; }
        .post-options { position: absolute; top: 12px; left: 12px; color: white; background: rgba(0,0,0,0.6); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; }
        .post-time { font-size: 11px; color: #999; }
        .seller-info { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; border-bottom: 1px solid #f9f9f9; padding-bottom: 8px; cursor: pointer; }
        .btn-whatsapp { background: #25d366; color: white; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; border-radius: 10px; margin-top: 10px; font-weight: bold; width: 100%; box-sizing: border-box; }

        .wallet-card { background: linear-gradient(135deg, #0d1117, #1e3a8a); color: white; padding: 25px; margin: 15px; border-radius: 20px; text-align: center; position: relative; overflow: hidden; }
        .sdm-logo { width: 70px; height: 70px; border-radius: 50%; border: 2px solid var(--gold); margin-bottom: 10px; object-fit: cover; }
        
        .admin-panel { background: #fff; margin: 15px; padding: 15px; border-radius: 15px; border: 2px solid var(--red); }
        .admin-notify-bar { background: #fff3cd; border: 2px solid var(--gold); margin: 15px; padding: 15px; border-radius: 15px; }

        .game-panel { background: #ffffff; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin: 15px; border: 2px solid #2563eb; }
        
        .search-hidden { display: none !important; }
        .badge-good { background-color: #3498db; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 5px; }
        .badge-super { background-color: #f1c40f; color: black; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 5px; font-weight: bold; border: 1px solid #d4ac0d; }
    </style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©) -->
<div id="auth-screen" class="hidden">
    <div style="padding:40px; text-align:center; height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; background: #f0f2f5;">
        <img src="https://i.ibb.co/3ykXvBv/SDM-Coin.jpg" style="width:100px; height:100px; border-radius:50%; margin-bottom:20px; border:3px solid var(--gold);">
        <h2 style="color:var(--navy); margin-bottom:10px;">Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† & SDM ğŸª™</h2>
        <p style="color:#666; margin-bottom:30px;">Ø¨ÙŠØ¹ØŒ Ø§Ø´ØªØ±ÙŠØŒ ÙˆØªØ¯Ø§ÙˆÙ„ Ø¨Ø£Ù…Ø§Ù†</p>
        
        <div id="login-box" style="width:100%; max-width:350px;">
            <button class="btn-main btn-google" onclick="loginWithGoogle()">
                <i class="fab fa-google"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Google
            </button>
            <button class="btn-guest" onclick="enterGuestMode()">Ø²ÙŠØ§Ø±Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙƒØ²Ø§Ø¦Ø± ğŸ‘€</button>
        </div>
        
        <p style="margin-top:20px; font-size:12px; color:#888;">Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù†ÙŠ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</p>
    </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
<div id="app-screen" class="hidden">
    <header>
        <div class="header-top">
            <span onclick="goBack()" style="cursor:pointer; font-size:20px;">ğŸ”™</span>
            <b id="head-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</b>
            <div style="display:flex; align-items:center;">
                <div class="online-dot" style="width:10px; height:10px; background:#2ecc71; border-radius:50%; margin-left:5px;"></div>
                <span id="u-stars" style="color:var(--gold)">â­0</span>
            </div>
        </div>
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø·ÙˆØ± -->
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" id="store-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ØŒ Ù„Ø¹Ø¨Ø©ØŒ Ø®Ø¯Ù…Ø©..." oninput="filterContent(this.value)">
        </div>
    </header>

    <!-- Ø´Ø±ÙŠØ· ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ± -->
    <div id="dev-alert-bar"></div>
    <div id="admin-notifications-area"></div>
    <div id="welcome-container"></div>
    
    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="content-area"></div>

    <div class="bottom-tabs">
        <div class="tab-btn" onclick="nav('home')"><i class="fas fa-home"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="tab-btn" onclick="checkGuestAccess('wallet')"><i class="fas fa-wallet" style="color:blue"></i>SDM</div>
        <div class="tab-btn" onclick="checkGuestAccess('games')"><i class="fas fa-gamepad" style="color:purple"></i>Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</div>
        <div class="tab-btn" onclick="checkGuestAccess('vip')"><i class="fas fa-gem" style="color:gold"></i>VIP</div>
        <div class="tab-btn" onclick="checkGuestAccess('profile')"><i class="fas fa-user-circle"></i>Ù…Ù„ÙÙŠ</div>
    </div>
</div>

<script>
    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ---
    const firebaseConfig = {
      apiKey: "AIzaSyAI_mUhuPNoO-XC0Q-VNoWft8UWFbAbIGg",
      authDomain: "sudan-market-6b122.firebaseapp.com",
      databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com",
      projectId: "sudan-market-6b122",
      storageBucket: "sudan-market-6b122.firebasestorage.app",
      messagingSenderId: "66729481566",
      appId: "1:66729481566:web:93393f28dc22d32cceebcf",
      measurementId: "G-L4SDJWKPK5"
    };
    
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    
    // --- Ø¥Ø¶Ø§ÙØ© ÙˆØªÙØ¹ÙŠÙ„ App Check (ReCaptcha V3) ---
    if (firebase.appCheck) {
        const appCheck = firebase.appCheck();
        appCheck.activate('6Lcd0UAsAAAAAsgLIU9rpyti0xHtrgwC2dvklv_', true);
    }

    const db = firebase.database();

    const SDM_PRICE = 1000;
    let me = null, hStack = ['home'], curC = '', curS = '', tempImg = '', userPic = 'https://via.placeholder.com/150';
    let isGuest = false; 

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ù†Ø²Ù„Ù‚
    let sliderInterval;
    const sdmCoinImage = "https://i.ibb.co/3ykXvBv/SDM-Coin.jpg"; 
    let sliderImages = [sdmCoinImage]; 
    let currentSliderIndex = 0;

    const cats = {
        "Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„Ø§Øª": {i:"mobile-alt", s:["Ø¢ÙŠÙÙˆÙ†","Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬","Ø´Ø§ÙˆÙ…ÙŠ","Ø¨ÙƒØ³Ù„","Ù‡ÙˆØ§ÙˆÙŠ"]},
        "Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª": {i:"car", s:["ØªÙˆÙŠÙˆØªØ§","Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ","BYD","Ø£ÙƒØ³Ù†Øª","Ø±ÙƒØ´Ø§Øª"]},
        "Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª": {i:"home", s:["Ø´Ù‚Ù‚ Ù„Ù„Ø§ÙŠØ¬Ø§Ø±","Ø¨ÙŠÙˆØª Ù„Ù„Ø¨ÙŠØ¹","Ù…Ø²Ø§Ø±Ø¹","Ø§Ø±Ø§Ø¶ÙŠ"]},
        "Ø£Ø¬Ù‡Ø²Ø© Ù…Ù†Ø²Ù„ÙŠØ©": {i:"tv", s:["Ø´Ø§Ø´Ø§Øª","Ø«Ù„Ø§Ø¬Ø§Øª","Ù…ÙƒÙŠÙØ§Øª","ØºØ³Ø§Ù„Ø§Øª"]},
        "Ø§Ù„ØªØ¹Ø¯ÙŠÙ†": {i:"hammer", s:[]}, 
        "Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±": {i:"laptop", s:["Ù„Ø§Ø¨ØªÙˆØ¨Ø§Øª","Ø·Ø§Ø¨Ø¹Ø§Øª","Ø§ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª"]},
        "Ø£Ø«Ø§Ø« Ù…Ù†Ø²Ù„": {i:"chair", s:["ØºØ±Ù Ù†ÙˆÙ…","Ø³Ø±Ø§ÙŠØ±","ÙƒØ±Ø§Ø³ÙŠ","Ø·Ø§ÙˆÙ„Ø§Øª"]},
        "Ù…Ù„Ø§Ø¨Ø³ Ø±Ø¬Ø§Ù„ÙŠØ©": {i:"tshirt", s:["Ù‚Ù…ØµØ§Ù†","Ø¨Ù†Ø§Ø·ÙŠÙ„","Ø§Ø­Ø°ÙŠØ©","Ø¬Ù„Ø§Ø¨ÙŠØ¨"]},
        "Ù…Ù„Ø§Ø¨Ø³ Ù†Ø³Ø§Ø¦ÙŠØ©": {i:"female", s:["ØªÙŠØ§Ø¨","ÙØ³Ø§ØªÙŠÙ†","Ø´Ù†Ø·","Ù…ÙƒÙŠØ§Ø¬"]},
        "Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø£Ø·ÙØ§Ù„": {i:"baby", s:["Ù…Ù„Ø§Ø¨Ø³ Ø§Ø·ÙØ§Ù„","Ø§Ù„Ø¹Ø§Ø¨","Ø¹Ø±Ø¨Ø§Øª Ø§Ø·ÙØ§Ù„"]},
        "Ø§Ù„Ø°Ù‡Ø¨ ÙˆØ§Ù„Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª": {i:"gem", s:["Ø®ÙˆØ§ØªÙ…","Ø³Ù„Ø§Ø³Ù„","Ø§Ø·Ù‚Ù… Ø°Ù‡Ø¨"]},
        "Ø­ÙŠÙˆØ§Ù†Ø§Øª": {i:"paw", s:["Ø§ØºÙ†Ø§Ù…","Ø·ÙŠÙˆØ±","Ù‚Ø·Ø·","Ø®ÙŠÙˆÙ„"]},
        "Ø®Ø¯Ù…Ø§Øª Ù…Ù‡Ù†ÙŠØ©": {i:"tools", s:["ÙƒÙ‡Ø±Ø¨Ø§Ø¡","Ø³Ø¨Ø§ÙƒØ©","Ø­Ø¯Ø§Ø¯Ø©","Ù†Ù‚Ø§Ø´Ø©"]},
        "Ù…Ø·Ø§Ø¹Ù…": {i:"utensils", s:["ÙˆØ¬Ø¨Ø§Øª Ø³Ø±ÙŠØ¹Ø©","Ø­Ù„ÙˆÙŠØ§Øª","Ø¹ØµØ§Ø¦Ø±"]},
        "Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø¬Ù…Ø§Ù„": {i:"heartbeat", s:["Ø¹Ø·ÙˆØ±","ÙƒØ±ÙŠÙ…Ø§Øª","Ù…Ø¹Ø¯Ø§Øª Ø·Ø¨ÙŠØ©"]},
        "ÙƒØªØ¨ ÙˆØ£Ø¯ÙˆØ§Øª": {i:"book", s:["Ø±ÙˆØ§ÙŠØ§Øª","ÙƒØªØ¨ Ø¹Ù„Ù…ÙŠØ©","Ù‚Ø±Ø·Ø§Ø³ÙŠØ©"]},
        "Ø³ÙŠØ§Ø­Ø© ÙˆØ³ÙØ±": {i:"plane", s:["ØªØ°Ø§ÙƒØ± Ø·ÙŠØ±Ø§Ù†","ØªØ£Ø´ÙŠØ±Ø§Øª","ÙÙ†Ø§Ø¯Ù‚"]},
        "Ù…Ù†ÙˆØ¹Ø§Øª": {i:"box-open", s:["Ø§ØºØ±Ø§Ø¶ Ø§Ø®Ø±Ù‰"]}
    };

    const officialRates = {
        pubg: [ { name: "60 UC", sdm: 4 }, { name: "325 UC", sdm: 20 }, { name: "660 UC", sdm: 40 } ],
        ff: [ { name: "100 Ø¬ÙˆÙ‡Ø±Ø©", sdm: 4 }, { name: "530 Ø¬ÙˆÙ‡Ø±Ø©", sdm: 20 }, { name: "1080 Ø¬ÙˆÙ‡Ø±Ø©", sdm: 40 } ]
    };

    // --- 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Google) ---
    auth.onAuthStateChanged(user => {
        if (user) {
            const uid = user.uid;
            db.ref('users/' + uid).once('value', snap => {
                if(snap.exists()) {
                    // Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯
                    const u = snap.val();
                    if (u.bannedUntil && u.bannedUntil > Date.now()) {
                        Swal.fire('Ù…Ø­Ø¸ÙˆØ±', 'ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¤Ù‚ØªØ§Ù‹.', 'error').then(() => {
                           auth.signOut();
                        });
                        return;
                    }
                    me = u;
                    startApp(uid);
                } else {
                    // ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø¬ÙˆØ¬Ù„
                    const newUser = {
                        n: user.displayName || 'Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯',
                        p: uid, // Ù†Ø³ØªØ®Ø¯Ù… UID ÙƒÙ…Ø¹Ø±Ù
                        email: user.email,
                        pic: user.photoURL,
                        sdmBalance: 0,
                        rating: 0,
                        vipStatus: 'none',
                        role: 'user',
                        reportCount: 0,
                        wa: '' // Ø³ÙŠØªÙ… Ø§Ù„Ø·Ù„Ø¨ Ù„Ø§Ø­Ù‚Ø§Ù‹
                    };
                    db.ref('users/' + uid).set(newUser).then(() => {
                        me = newUser;
                        startApp(uid);
                    });
                }
            });
        } else {
            if(!isGuest) {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        }
    });

    function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(error => {
            Swal.fire('Ø®Ø·Ø£', error.message, 'error');
        });
    }

    function doLogout() {
        auth.signOut().then(() => location.reload());
    }

    function enterGuestMode() {
        isGuest = true;
        me = { n: 'Ø²Ø§Ø¦Ø±', p: 'guest', role: 'guest', sdmBalance: 0 };
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        document.getElementById('u-stars').innerText = "Ø²Ø§Ø¦Ø±";
        listenForDevAlerts();
        render('home');
    }

    // --- 2. Ù†Ø¸Ø§Ù… Ø¶ØºØ· Ø§Ù„ØµÙˆØ± (Image Compression) ---
    async function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; // Ø¹Ø±Ø¶ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø¬ÙˆØ¯Ø©
                    const scaleSize = MAX_WIDTH / img.width;
                    
                    // Ø¥Ø°Ø§ Ø§Ù„ØµÙˆØ±Ø© ØµØºÙŠØ±Ø© Ù„Ø§ ØªØ¶ØºØ·Ù‡Ø§
                    if (scaleSize >= 1) {
                        resolve(event.target.result);
                        return;
                    }

                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ JPEG Ø¨Ø¬ÙˆØ¯Ø© 70%
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                }
            };
        });
    }

    // ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© encode Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¶ØºØ·
    async function encode(i, t) {
        if(!i.files[0]) return;
        try {
            Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©...', didOpen: () => Swal.showLoading(), allowOutsideClick: false, showConfirmButton: false, timer: 1000 });
            const compressed = await compressImage(i.files[0]);
            
            if(t==='user') {
                userPic = compressed;
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø§Ù„ØµÙˆØ±Ø© ÙÙˆØ±Ø§Ù‹
                if(me && !isGuest) {
                     db.ref('users/'+me.p).update({ pic: userPic });
                     document.getElementById('profile-img-view').src = userPic;
                }
            }
            else if(t==='buy') window.tempBuyImg = compressed;
            else tempImg = compressed;

        } catch(e) {
            console.error(e);
            Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©', 'error');
        }
    }

    // --- Ø¨Ù‚ÙŠØ© ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---

    function checkGuestAccess(view, extra) {
        if (isGuest) {
            Swal.fire({
                title: 'ØªÙ†Ø¨ÙŠÙ‡',
                text: 'Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ØªØªØ·Ù„Ø¨ Ø­Ø³Ø§Ø¨Ø§Ù‹ Ù…Ø³Ø¬Ù„Ø§Ù‹.',
                icon: 'info',
                showCancelButton: true,
                confirmButtonText: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡'
            }).then((res) => {
                if(res.isConfirmed) location.reload();
            });
            return;
        }
        nav(view, extra);
    }

    function startApp(uid) {
        isGuest = false;
        hStack = ['home'];
        
        db.ref('users/' + uid).on('value', snap => {
            const val = snap.val();
            if (!val) return; 
            if (val.bannedUntil && val.bannedUntil > Date.now()) {
                Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ø¸ÙˆØ± Ø­Ø§Ù„ÙŠØ§Ù‹', 'error').then(() => doLogout());
                return;
            }

            me = val;
            me.p = uid; // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù€ UID
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            
            // ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø±Ù‚Ù… ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
            if (!me.wa) {
               promptWhatsApp();
            }

            checkVipExpiry();
            listenForUserAlerts();
            listenForDevAlerts();
            checkForBroadcastMessage();
            
            if(me.role === "admin") {
                listenForAdminTasks();
                listenForReportNotifications();
                setTimeout(initDeveloperLogic, 1000);
                cleanOldData(); 
            }
            render('home');
        });
        db.ref('users/' + uid).update({ lastSeen: Date.now() });
    }

    async function promptWhatsApp() {
        const { value: wa } = await Swal.fire({
            title: 'Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ',
            text: 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„ØªÙˆØ§ØµÙ„ (Ù„Ù„Ù…Ø¨ÙŠØ¹Ø§Øª)',
            input: 'tel',
            inputPlaceholder: '0xxxxxxxxx',
            allowOutsideClick: false,
            inputValidator: (value) => {
                if (!value) return 'ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù…';
            }
        });
        if (wa) {
            db.ref('users/'+me.p).update({ wa: wa });
        }
    }

    function cleanOldData() {
        if (me.role !== 'admin') return;
        const threeDaysAgo = Date.now() - (3 * 24 * 60 * 60 * 1000); 

        db.ref('transactions').orderByChild('date').endAt(threeDaysAgo).once('value', snap => {
            snap.forEach(child => child.ref.remove());
        });
        db.ref('game_orders').orderByChild('date').endAt(threeDaysAgo).once('value', snap => {
            snap.forEach(child => child.ref.remove());
        });
        db.ref('posts').orderByChild('date').endAt(Date.now() - 86400000).once('value', snap => {
             snap.forEach(child => child.ref.remove());
        });
    }

    function checkForBroadcastMessage() {
        db.ref('settings/broadcast').on('value', snap => {
            const data = snap.val();
            if (data && data.text) {
                const lastMsgId = localStorage.getItem('last_broadcast_id');
                if (lastMsgId != data.id) {
                    Swal.fire({
                        title: 'Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø·ÙˆØ± ğŸ“¢',
                        text: data.text,
                        icon: 'info',
                        confirmButtonText: 'Ù…ÙˆØ§ÙÙ‚'
                    }).then(() => {
                        localStorage.setItem('last_broadcast_id', data.id);
                    });
                }
            }
        });
    }

    function sendBroadcastMessage() {
        if(me.role !== 'admin') return;
        Swal.fire({
            title: 'Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†',
            input: 'textarea',
            inputPlaceholder: 'Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§...',
            showCancelButton: true,
            confirmButtonText: 'Ø¥Ø±Ø³Ø§Ù„'
        }).then(res => {
            if(res.isConfirmed && res.value) {
                db.ref('settings/broadcast').set({
                    text: res.value,
                    id: Date.now() 
                });
                Swal.fire('ØªÙ…', 'ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†', 'success');
            }
        });
    }

    function listenForDevAlerts() {
        const bar = document.getElementById('dev-alert-bar');
        db.ref('settings/globalAlert').on('value', snap => {
            const msg = snap.val();
            if(msg) {
                bar.style.display = 'block';
                bar.innerHTML = `ğŸ“¢ ${msg} ${(!isGuest && me.role === 'admin') ? '<i class="fas fa-edit" onclick="editDevAlert()"></i>' : ''}`;
            } else {
                bar.style.display = 'none';
            }
        });
    }

    function editDevAlert() {
        if (me.role !== "admin") return;
        Swal.fire({
            title: 'ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ',
            input: 'text',
            showCancelButton: true,
            confirmButtonText: 'Ù†Ø´Ø± Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡'
        }).then(res => {
            if(res.isConfirmed) db.ref('settings/globalAlert').set(res.value);
        });
    }

    function filterContent(query) {
        query = query.toLowerCase();
        const items = document.querySelectorAll('.post, .card');
        items.forEach(item => {
            if (item.classList.contains('admin-item') && (!me || me.role !== 'admin')) {
                item.classList.add('search-hidden');
                return;
            }
            if (item.innerText.toLowerCase().includes(query)) {
                item.classList.remove('search-hidden');
            } else {
                item.classList.add('search-hidden');
            }
        });
    }

    function listenForAdminTasks() {
        if (me.role !== "admin") return;
        db.ref('coin_requests').orderByChild('status').equalTo('pending').on('value', snap => {
            const area = document.getElementById('admin-notifications-area');
            if(hStack[hStack.length-1] !== 'home') { area.innerHTML = ""; return; }
            area.innerHTML = "";
            snap.forEach(child => {
                const req = child.val();
                area.innerHTML += `
                    <div class="admin-notify-bar admin-item">
                        <p><b>ğŸ”” Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯</b></p>
                        <p>Ø§Ù„Ø§Ø³Ù…: ${req.uN} | Ø§Ù„ÙƒÙ…ÙŠØ©: ${req.qty} SDM</p>
                        <img src="${req.img}" style="width:100%; border-radius:10px; margin:10px 0; cursor:pointer;" onclick="Swal.fire({imageUrl:'${req.img}'})">
                        <div style="display:flex; gap:10px;">
                            <button class="btn-main" style="background:var(--green); margin:0;" onclick="approvePurchase('${child.key}', '${req.uP}', ${req.qty})">Ù…ÙˆØ§ÙÙ‚</button>
                            <button class="btn-main" style="background:var(--red); margin:0;" onclick="rejectPurchase('${child.key}', '${req.uP}')">Ø±ÙØ¶</button>
                        </div>
                    </div>`;
            });
        });
    }

    function listenForReportNotifications() {
        if (me.role !== "admin") return;
        db.ref('users').orderByChild('reportCount').startAt(20).on('value', snap => {
            const area = document.getElementById('admin-notifications-area');
            snap.forEach(child => {
                const u = child.val();
                if (!u.adminHandled) {
                    area.innerHTML += `
                    <div class="admin-notify-bar admin-item" style="border-color:red; background:#ffe6e6">
                        <p><b>ğŸš¨ Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø§ÙˆØ² 20 Ø¨Ù„Ø§Øº!</b></p>
                        <p>${u.n} - Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª: ${u.reportCount}</p>
                        <button class="btn-main" style="background:black" onclick="adminBanUser('${u.p}', 'delete')">Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
                        <button class="btn-main" style="background:var(--red)" onclick="adminBanUser('${u.p}', 'custom')">Ø­Ø¸Ø± Ø¨Ù…Ø¯Ø© Ù…Ø­Ø¯Ø¯Ø©</button>
                        <button class="btn-main" style="background:gray" onclick="ignoreReport('${u.p}')">ØªØ¬Ø§Ù‡Ù„</button>
                    </div>`;
                }
            });
        });
    }

    async function adminBanUser(uid, action) {
        if (me.role !== "admin") return;
        if (action === 'delete') {
            if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ')) {
                await db.ref('users/'+uid).remove();
                Swal.fire('ØªÙ…','ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨','success');
            }
        } else if (action === 'custom') {
            const { value: days } = await Swal.fire({
                title: 'ÙƒÙ… ÙŠÙˆÙ… Ø­Ø¸Ø±ØŸ',
                input: 'number'
            });
            if (days) {
                const until = Date.now() + (days * 24 * 60 * 60 * 1000);
                await db.ref('users/'+uid).update({ bannedUntil: until, adminHandled: true });
                Swal.fire('ØªÙ…','ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…','success');
            }
        }
    }

    function ignoreReport(uid) {
        if (me.role !== "admin") return;
        db.ref('users/'+uid).update({ adminHandled: true });
        render('home'); 
    }

    async function approvePurchase(id, up, qty) {
        if (me.role !== "admin") return;
        
        const uSnap = await db.ref('users/'+up).once('value');
        const bal = uSnap.val().sdmBalance || 0;
        
        await db.ref('users/'+up).update({ sdmBalance: bal + Number(qty) });
        await db.ref('coin_requests/'+id).update({ status: 'approved', date: Date.now() });
        
        const opId = "BUY-" + Math.random().toString(36).substr(2, 6).toUpperCase();
        
        await db.ref('transactions').push({
            opId: opId,
            amount: qty,
            sender: 'admin', 
            senderName: 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©',
            receiver: up,
            receiverName: uSnap.val().n,
            date: Date.now(),
            involves: [up, me.p], 
            type: 'purchase'
        });

        await db.ref('alerts/'+up).push({ msg: `âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ¥Ø¶Ø§ÙØ© ${qty} SDM Ù„Ø­Ø³Ø§Ø¨Ùƒ`, type: 'success' });
        Swal.fire('ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„','ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©','success');
    }

    async function rejectPurchase(id, up) {
        if (me.role !== "admin") return;
        await db.ref('coin_requests/'+id).update({ status: 'rejected' });
        await db.ref('alerts/'+up).push({ msg: `âŒ Ø¹Ø°Ø±Ø§Ù‹ØŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©`, type: 'error' });
        Swal.fire('ØªÙ… Ø§Ù„Ø±ÙØ¶','ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø±ÙØ¶','info');
    }

    function initDeveloperLogic() {
        if (me.role !== "admin") return;
        
        db.ref('game_orders').orderByChild('status').equalTo('pending').on('value', snap => {
            const container = document.getElementById('orders-list-container');
            if(!container) return;
            container.innerHTML = "";
            snap.forEach(child => {
                const o = child.val();
                container.innerHTML += `
                    <div class="order-card admin-item">
                        <b>Ø§Ù„Ø¹Ù…ÙŠÙ„:</b> ${o.uN}<br>
                        <b>Ø§Ù„Ù„Ø¹Ø¨Ø©:</b> ${o.gameType} | <b>Ø§Ù„Ø¨Ø§Ù‚Ø©:</b> ${o.package}<br>
                        <b>ID Ø§Ù„Ù„Ø§Ø¹Ø¨:</b> <span class="id-highlight">${o.playerId}</span><br>
                        <div class="admin-btns">
                            <button class="btn-main" style="background:green" onclick="confirmSuccess('${child.key}', '${o.uP}')">ØªÙ… Ø§Ù„Ø´Ø­Ù† âœ…</button>
                            <button class="btn-main" style="background:red" onclick="cancelAndRefund('${child.key}', '${o.uP}', ${o.cost})">Ø±ÙØ¶ âŒ</button>
                        </div>
                    </div>`;
            });
        });
    }

    async function confirmSuccess(key, uid) {
        if (me.role !== "admin") return;
        await db.ref('game_orders/' + key).update({ status: 'done' });
        db.ref('alerts/' + uid).push({ msg: "âœ… ØªÙ… Ø´Ø­Ù† Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒ ÙÙŠ Sudan Market", type: "success" });
        Swal.fire("Ù†Ø¬Ø§Ø­", "ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù† Ø¨Ù†Ø¬Ø§Ø­", "success");
    }

    async function cancelAndRefund(key, uid, amount) {
        if (me.role !== "admin") return;
        const snap = await db.ref('users/' + uid).once('value');
        const current = snap.val().sdmBalance || 0;
        await db.ref('users/' + uid).update({ sdmBalance: current + amount });
        await db.ref('game_orders/' + key).update({ status: 'rejected' });
        db.ref('alerts/' + uid).push({ msg: "âŒ Ù†Ø¹ØªØ°Ø±ØŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ ÙˆØ¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ù…Ø­ÙØ¸ØªÙƒ", type: "error" });
        Swal.fire("ØªÙ… Ø§Ù„Ø±ÙØ¶", "ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…", "info");
    }

    function listenForUserAlerts() {
        if(isGuest) return;
        db.ref('alerts/'+me.p).on('child_added', snap => {
            const data = snap.val();
            if(data.isReceipt) {
                showReceiptModal(data);
            } else {
                Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', data.msg, data.type);
            }
            snap.ref.remove();
        });
    }

    function showReceiptModal(data) {
        Swal.fire({
            html: `
            <div class="receipt-container">
                <div class="receipt-header-new">
                    <h3 style="margin:0; color:var(--blue);">Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† | SDM</h3>
                    <small style="color:#888">Ø¥Ø´Ø¹Ø§Ø± ØªØ­ÙˆÙŠÙ„ Ø±Ø³Ù…ÙŠ</small>
                </div>
                <div class="receipt-row"><span class="receipt-label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</span> <span class="receipt-value">${data.opId}</span></div>
                <div class="receipt-row"><span class="receipt-label">Ø§Ù„Ù…Ø±Ø³Ù„:</span> <span class="receipt-value">${data.senderName}</span></div>
                <div class="receipt-row"><span class="receipt-label">Ø§Ù„Ù…Ø³ØªÙ„Ù…:</span> <span class="receipt-value">${data.receiverName}</span></div>
                <div class="receipt-row"><span class="receipt-label">Ø§Ù„Ù…Ø¨Ù„Øº:</span> <span class="receipt-value" style="color:var(--green)">${data.amount} SDM</span></div>
                <div class="receipt-row"><span class="receipt-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> <span class="receipt-value">${data.time}</span></div>
                <div style="margin-top:20px; text-align:center; color:#999; font-size:10px;">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ø´Ø¨ÙƒØ© SDM Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚Ø©</div>
            </div>`,
            showConfirmButton: true,
            confirmButtonText: 'Ø¥ØºÙ„Ø§Ù‚',
            background: 'white'
        });
    }

    function timeSince(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return "Ù…Ù†Ø° Ø³Ù†Ø©";
        interval = seconds / 2592000;
        if (interval > 1) return "Ù…Ù†Ø° " + Math.floor(interval) + " Ø´Ù‡Ø±";
        interval = seconds / 86400;
        if (interval > 1) return "Ù…Ù†Ø° " + Math.floor(interval) + " ÙŠÙˆÙ…";
        interval = seconds / 3600;
        if (interval > 1) return "Ù…Ù†Ø° " + Math.floor(interval) + " Ø³Ø§Ø¹Ø©";
        interval = seconds / 60;
        if (interval > 1) return "Ù…Ù†Ø° " + Math.floor(interval) + " Ø¯Ù‚ÙŠÙ‚Ø©";
        return "Ø§Ù„Ø¢Ù†";
    }

    function showWelcome() {
        const hour = new Date().getHours();
        let greet = hour < 12 ? "ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±" : "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±";
        const container = document.getElementById('welcome-container');
        if(hStack[hStack.length-1] === 'home' && me && !isGuest) {
            container.innerHTML = `<div class="welcome-msg">${greet}ØŒ ${me.n} âœ¨</div>`;
        } else { container.innerHTML = ""; }
    }

    function nav(v, e) { 
        if(v === 'sub' && e === 'Ø§Ù„ØªØ¹Ø¯ÙŠÙ†') {
            Swal.fire('Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ† Ù‚Ø±ÙŠØ¨Ø§Ù‹ â›ï¸', 'info');
            return;
        }
        hStack.push(v); render(v, e); 
    }
    function goBack() { if(hStack.length > 1) { hStack.pop(); render(hStack[hStack.length-1]); } }

    function render(view, extra) {
        const area = document.getElementById('content-area');
        const adminArea = document.getElementById('admin-notifications-area');
        
        if (sliderInterval) clearInterval(sliderInterval);

        if(view !== 'home') adminArea.innerHTML = "";

        showWelcome();
        if(me) {
            const r = me.rating || 0;
            let label = `â­${r.toFixed(1)}`;
            document.getElementById('u-stars').innerText = isGuest ? "Ø²Ø§Ø¦Ø±" : label;
        }

        let title = "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©";
        if(view === 'wallet') title = "Ù…Ø­ÙØ¸Ø© SDM";
        if(view === 'games') title = "Ø´Ø­Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨";
        if(view === 'vip') title = "Ø¹Ø±ÙˆØ¶ VIP";
        if(view === 'profile') title = "Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ";
        document.getElementById('head-title').innerText = title;

        if(view === 'home') {
            db.ref('settings').on('value', snap => {
                const settings = snap.val() || {};
                
                if(settings.sliderImages && settings.sliderImages.length > 0) {
                    sliderImages = settings.sliderImages;
                } else {
                    sliderImages = [sdmCoinImage];
                }
                
                const categoryImages = settings.categories || {};

                area.innerHTML = `
                    <div class="slider-container" onclick="handleSliderClick()">
                        <img id="slider-img" src="${sliderImages[0]}">
                        <div class="slider-overlay">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù…Ù„Ø© Ù„Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„Ù…Ø­ÙØ¸Ø©</div>
                        ${(!isGuest && me.role === 'admin') ? `<div class="edit-slider-btn" onclick="updateSliderImgs()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ ØµÙˆØ± Ø§Ù„Ø´Ø±ÙŠØ·</div>` : ''}
                    </div>
                    
                    ${(!isGuest && me.role === 'admin') ? `<button class="btn-main" style="background:#6f42c1; margin:10px;" onclick="sendBroadcastMessage()">ğŸ“¢ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>` : ''}
                    
                    <div id="vip-slider"></div>

                    <div class="grid">
                        ${Object.keys(cats).map(k=> {
                            const customImg = categoryImages[k] ? categoryImages[k].img : null;
                            const editBtn = (!isGuest && me.role === 'admin') ? 
                                `<div class="edit-cat-btn" onclick="event.stopPropagation(); updateCategoryImg('${k}')"><i class="fas fa-edit"></i></div>` : '';
                            
                            const iconOrImg = customImg ? 
                                `<img src="${customImg}" class="cat-custom-img">` : 
                                `<i class="fas fa-${cats[k].i}" style="font-size:24px; color:var(--blue); margin-bottom:10px;"></i>`;

                            return `
                            <div class="card" onclick="nav('sub','${k}')">
                                ${editBtn}
                                ${iconOrImg}
                                <br><b>${k}</b>
                            </div>`;
                        }).join('')}
                    </div>
                `;
                startSlider();
            });
            loadVipHome();

        } else if(view === 'sub') {
            curC = extra || curC;
            area.innerHTML = `<div class="grid">${cats[curC].s.map(s=>`<div class="card" onclick="nav('feed','${s}')"><b>${s}</b></div>`).join('')}</div>`;
        } else if(view === 'feed') {
            curS = extra || curS;
            let publishHTML = '';
            if(!isGuest) {
                publishHTML = `
                <div class="publish-container">
                    <h4>ğŸ“ Ø£Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†Ùƒ ÙÙŠ ${curS}</h4>
                    <div class="warning-text">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 24 Ø³Ø§Ø¹Ø© Ù…Ù† Ù†Ø´Ø±Ù‡ (Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒÙ†Øª VIP).</div>
                    <input id="pt" placeholder="Ù…Ø§Ø°Ø§ ØªÙˆØ¯ Ø£Ù† ØªØ¨ÙŠØ¹ØŸ (Ø®Ø· ÙƒØ¨ÙŠØ± ÙˆØ¬Ø°Ø§Ø¨)">
                    <input id="pp" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¨Ù€ SDM">
                    <input id="p-whatsapp" type="tel" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„ØªÙˆØ§ØµÙ„ (0xxxxxxxxx)" value="${me.wa || ''}">
                    <textarea id="pd" placeholder="Ø£Ø¶Ù ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø¯Ù‚Ø©..." rows="3"></textarea>
                    <div style="font-size:12px; margin-bottom:5px; color:#666">ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬:</div>
                    <input type="file" onchange="encode(this, 'post')">
                    <button class="btn-main" onclick="publish('posts')">Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¢Ù†</button>
                </div>`;
            }
            area.innerHTML = `${publishHTML}<div id="posts-list"></div>`;
            loadPosts('posts', curS);
        } else if(view === 'wallet') renderWallet(area);
        else if(view === 'vip') renderVip(area);
        else if(view === 'profile') renderProfile(area, extra || me.p);
        else if(view === 'games') renderGames(area);
    }

    function startSlider() {
        const imgEl = document.getElementById('slider-img');
        if(!imgEl) return;
        currentSliderIndex = 0;
        imgEl.src = sliderImages[0];
        sliderInterval = setInterval(() => {
            const imgEl = document.getElementById('slider-img');
            if(!imgEl) return;
            currentSliderIndex = (currentSliderIndex + 1) % sliderImages.length;
            imgEl.style.opacity = 0;
            setTimeout(() => {
                imgEl.src = sliderImages[currentSliderIndex];
                imgEl.style.opacity = 1;
            }, 300);
        }, 3000);
    }

    function handleSliderClick() {
        if (sliderImages[currentSliderIndex] === sdmCoinImage) {
            checkGuestAccess('wallet');
        }
    }
    
    async function updateSliderImgs() {
        if (me.role !== 'admin') return;
        event.stopPropagation();
        Swal.fire({
            title: 'ØªØ¹Ø¯ÙŠÙ„ ØµÙˆØ± Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ù†Ø²Ù„Ù‚',
            html: '<input type="file" id="slider-files-input" class="swal2-file" multiple accept="image/*">',
            showCancelButton: true,
            confirmButtonText: 'Ø­ÙØ¸',
            preConfirm: () => {
                const files = document.getElementById('slider-files-input').files;
                if (!files || files.length === 0) return null;
                const filePromises = Array.from(files).map(file => {
                     return compressImage(file);
                });
                return Promise.all(filePromises);
            }
        }).then((result) => {
            if (result.isConfirmed && result.value) {
                const newImages = [sdmCoinImage, ...result.value]; 
                db.ref('settings/sliderImages').set(newImages).then(() => {
                    Swal.fire('ØªÙ…', 'ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙˆØ± Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ù†Ø²Ù„Ù‚ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                });
            }
        });
    }

    async function updateCategoryImg(catName) {
        if (me.role !== 'admin') return;
        Swal.fire({
            title: `ØªØ¹Ø¯ÙŠÙ„ ØµÙˆØ±Ø© Ù‚Ø³Ù…: ${catName}`,
            html: '<input type="file" id="cat-img-input" accept="image/*" class="swal2-file">',
            showCancelButton: true,
            confirmButtonText: 'Ø­ÙØ¸',
            preConfirm: () => {
                const file = document.getElementById('cat-img-input').files[0];
                if (!file) return null;
                return compressImage(file);
            }
        }).then((result) => {
            if (result.isConfirmed && result.value) {
                db.ref(`settings/categories/${catName}`).set({ img: result.value })
                  .then(() => Swal.fire('ØªÙ…', 'ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ù‚Ø³Ù…', 'success'));
            }
        });
    }

    function renderGames(area) {
        area.innerHTML = `
            <div class="game-panel">
                <div class="game-header">
                    <i class="fas fa-gamepad" style="font-size:40px; color:#2563eb;"></i>
                    <h2>Ø´Ø­Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø¨Ù€ SDM</h2>
                    <p>Ø³Ø±Ø¹Ø©ØŒ Ø£Ù…Ø§Ù†ØŒ ÙˆÙ…ØµØ¯Ø§Ù‚ÙŠØ©</p>
                </div>
                <div class="input-group">
                    <label>Ø§Ø®ØªØ± Ø§Ù„Ù„Ø¹Ø¨Ø©</label>
                    <select id="active-game" onchange="loadCorrectPacks()">
                        <option value="pubg">Ø¨Ø¨Ø¬ÙŠ Ù…ÙˆØ¨Ø§ÙŠÙ„ (UC)</option>
                        <option value="ff">ÙØ±ÙŠ ÙØ§ÙŠØ± (Gems)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Ø¢ÙŠØ¯ÙŠ Ø§Ù„Ù„Ø§Ø¹Ø¨ (Player ID)</label>
                    <input type="text" id="p-id-input" placeholder="Ù…Ø«Ø§Ù„: 512345678">
                </div>
                <div class="input-group">
                    <label>Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø§Ù‚Ø©</label>
                    <select id="p-pack-input"></select>
                </div>
                <button class="btn-main" style="background:#2563eb" onclick="sendOrderToDeveloper()">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†</button>
            </div>
            
            <div style="background:white; padding:15px; margin:15px; border-radius:15px; border:1px solid #ddd;">
                <h4><i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø´Ø­Ù†Ø§Øª Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h4>
                <div id="game-history-container">
                    Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
                </div>
            </div>

            <div id="developer-area" class="hidden">
                <div class="admin-orders">
                    <h3><i class="fas fa-user-shield"></i> Ø¨Ø±ÙŠØ¯ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ±</h3>
                    <div id="orders-list-container"></div>
                </div>
            </div>`;
        loadCorrectPacks();
        loadGameHistory(); 
        if(me.role === "admin") {
            document.getElementById('developer-area').classList.remove('hidden');
            initDeveloperLogic();
        }
    }

    function loadGameHistory() {
        db.ref('game_orders').orderByChild('uP').equalTo(me.p).limitToLast(10).on('value', snap => {
            const container = document.getElementById('game-history-container');
            if(!container) return;
            let html = `
            <table class="game-history-table" style="width:100%">
                <thead>
                    <tr>
                        <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº (SDM)</th>
                        <th>ID Ø§Ù„Ù…Ø´Ø­ÙˆÙ†</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    </tr>
                </thead>
                <tbody>
            `;
            let hasData = false;
            snap.forEach(child => {
                hasData = true;
                const o = child.val();
                let statusBadge = o.status === 'done' ? '<span style="color:green">ØªÙ…</span>' : (o.status==='rejected'?'<span style="color:red">Ù…Ø±ÙÙˆØ¶</span>':'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±');
                html += `
                    <tr>
                        <td>${o.package}</td>
                        <td>${o.cost}</td>
                        <td style="font-family:monospace">${o.playerId}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            });
            html += `</tbody></table>`;
            if(!hasData) container.innerHTML = "<p style='text-align:center; color:#999'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø´Ø­Ù† Ø³Ø§Ø¨Ù‚Ø©</p>";
            else container.innerHTML = html;
        });
    }

    function loadCorrectPacks() {
        const gameSelect = document.getElementById('active-game');
        if(!gameSelect) return;
        const game = gameSelect.value;
        const packSelect = document.getElementById('p-pack-input');
        packSelect.innerHTML = "";
        officialRates[game].forEach(p => {
            packSelect.innerHTML += `<option value="${p.sdm}">${p.name} - Ø§Ù„Ø³Ø¹Ø±: ${p.sdm} SDM</option>`;
        });
    }

    async function sendOrderToDeveloper() {
        const game = document.getElementById('active-game').value;
        const pid = document.getElementById('p-id-input').value;
        const packEl = document.getElementById('p-pack-input');
        const cost = parseInt(packEl.value);
        const packName = packEl.options[packEl.selectedIndex].text;
        if (!pid) return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¢ÙŠØ¯ÙŠ Ø£ÙˆÙ„Ø§Ù‹", "warning");
        if (me.sdmBalance < cost) return Swal.fire("ÙØ´Ù„", "Ø±ØµÙŠØ¯Ùƒ Ù„Ø§ ÙŠÙƒÙÙŠ", "error");
        await db.ref('users/' + me.p).update({ sdmBalance: me.sdmBalance - cost });
        await db.ref('game_orders').push({
            uP: me.p, uN: me.n, gameType: game, playerId: pid, package: packName, cost: cost, status: 'pending', date: Date.now()
        });
        Swal.fire("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„", "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ù„Ù„Ù…Ø·ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!", "success");
    }

    function loadPosts(path, subFilter) {
        db.ref(path).on('value', snap => {
            const list = document.getElementById(path === 'posts' ? 'posts-list' : 'vip-slider-inner');
            if(!list) return;
            list.innerHTML = "";
            snap.forEach(c => {
                const p = c.val();
                if(subFilter && p.sub !== subFilter) return;
                const isMyPost = (me && (p.uP === me.p || me.role === "admin"));
                const soldClass = p.status === 'sold' ? '<div class="sold-overlay">ØªÙ… Ø§Ù„Ø¨ÙŠØ¹</div>' : '';
                
                let rateBtn = (!isGuest && p.uP !== me.p) ? `<i class="fas fa-star rate-btn" onclick="rateUser('${p.uP}')" title="Ù‚ÙŠÙ‘Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø§Ø¦Ø¹"></i>` : '';

                let postHTML = `
                <div class="post">
                    ${isMyPost ? `<i class="fas fa-ellipsis-v post-options" onclick="showPostMenu('${path}', '${c.key}', '${p.t}', '${p.pr}', '${p.d}')"></i>` : ''}
                    <div class="post-img-container">
                        ${soldClass}
                        <img src="${p.img}" style="width:100%; height:100%; object-fit:cover">
                    </div>
                    <div style="padding:15px">
                        <div class="seller-info" onclick="checkGuestAccess('profile', '${p.uP}')">
                            <img src="${p.uPic || 'https://via.placeholder.com/50'}" style="width:30px; height:30px; border-radius:50%">
                            <span class="seller-name">${p.uN} ${rateBtn} <span style="color:var(--gold); font-size:10px;">â­${p.uStars || 0}</span></span>
                        </div>
                        <h2 style="margin:5px 0; font-size:20px; color:var(--navy)">${p.t}</h2>
                        <div style="margin-bottom:5px;">
                            ${p.oldPr ? `<span class="old-price">${p.oldPr} SDM</span>` : ''}
                            <span class="price-tag">${p.pr} SDM</span>
                        </div>
                        <p style="font-size:14px; color:#444; line-height:1.5">${p.d}</p>
                        ${p.vExpiry ? `<div style="font-size:12px; color:var(--red); margin-bottom:5px;">ğŸ•’ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ù†Ø´Ø±: ${new Date(p.vExpiry).toLocaleDateString()}</div>` : ''}
                        <div class="post-time">${timeSince(p.date)}</div>
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <a href="https://wa.me/${p.wa || p.uP}" target="_blank" class="btn-whatsapp"><i class="fab fa-whatsapp"></i> ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</a>
                        </div>
                        ${(!isGuest && p.uP !== me.p) ? `<button class="btn-main" style="background:var(--red); font-size:12px; padding:5px;" onclick="reportItem('${p.uP}', '${c.key}', '${p.t}')">ğŸš© Ø¥Ø¨Ù„Ø§Øº</button>` : ''}
                        <div class="comment-box" style="margin-top:15px">
                            <div id="comments-${c.key}"></div>
                            ${!isGuest ? `
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <input id="ci-${c.key}" placeholder="Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚Ùƒ..." style="padding:8px; margin:0; font-size:12px;">
                                <button onclick="addComment('${path}', '${c.key}')" style="width:45px; border-radius:8px; border:none; background:var(--blue); color:white;"><i class="fas fa-paper-plane"></i></button>
                            </div>` : ''}
                        </div>
                    </div>
                </div>`;
                list.innerHTML += postHTML;
                loadComments(path, c.key);
            });
        });
    }

    function showPostMenu(path, id, t, pr, d) {
        Swal.fire({
            title: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±',
            showCancelButton: true,
            confirmButtonText: 'ØªØ¹Ø¯ÙŠÙ„',
            denyButtonText: 'Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±',
            showDenyButton: true,
            footer: `<button class="btn-main" style="background:var(--green); margin:0" onclick="markSold('${path}','${id}')">ØªØ­Ø¯ÙŠØ¯ ÙƒÙ€ "ØªÙ… Ø§Ù„Ø¨ÙŠØ¹"</button>`,
            preConfirm: () => {
                Swal.fire({
                    title: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                    html: `<input id="new-pr" class="swal2-input" value="${pr}" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯"><textarea id="new-d" class="swal2-textarea" placeholder="Ø§Ù„ÙˆØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯">${d}</textarea>`,
                    confirmButtonText: 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª',
                    preConfirm: () => {
                        const nPr = document.getElementById('new-pr').value;
                        const nD = document.getElementById('new-d').value;
                        db.ref(`${path}/${id}`).update({ pr: nPr, d: nD });
                    }
                });
            }
        }).then((result) => {
            if (result.isDenied) {
                db.ref(`${path}/${id}`).remove();
                Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
        });
    }

    function markSold(path, id) {
        db.ref(`${path}/${id}`).update({ status: 'sold' });
        Swal.close();
        Swal.fire('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«','ØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ù…Ø¨Ø§Ø¹','success');
    }

    async function reportItem(offenderUid, postId, title) {
        const { isConfirmed } = await Swal.fire({
            title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨Ù„Ø§Øº',
            text: `Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù†: ${title}ØŸ`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø¥Ø¨Ù„Ø§Øº'
        });

        if (isConfirmed) {
            db.ref('reports').push({ postId: postId, offender: offenderUid, reporter: me.p, date: Date.now() });
            handleReportConsequences(offenderUid);
        }
    }
    
    async function reportUser(offenderUid) {
        if(isGuest) return checkGuestAccess('profile');
        const { isConfirmed } = await Swal.fire({
            title: 'Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù…Ø³ØªØ®Ø¯Ù…',
            text: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø¥Ø¨Ù„Ø§Øº'
        });
        
        if (isConfirmed) {
            db.ref('user_reports').push({ offender: offenderUid, reporter: me.p, date: Date.now() });
            handleReportConsequences(offenderUid);
        }
    }

    async function handleReportConsequences(offenderUid) {
        const snap = await db.ref('users/' + offenderUid).once('value');
        if(snap.exists()) {
            let u = snap.val();
            let count = (u.reportCount || 0) + 1;
            
            let updates = { reportCount: count };

            if (count === 10) {
                updates.bannedUntil = Date.now() + (24 * 60 * 60 * 1000); 
                Swal.fire('ØªÙ…', 'Ø´ÙƒØ±Ø§Ù‹ Ù„Ø¨Ù„Ø§ØºÙƒ. ØªÙ… Ø§ØªØ®Ø§Ø° Ø¥Ø¬Ø±Ø§Ø¡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¶Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….', 'success');
            }
            else if (count >= 20) {
                updates.adminHandled = false; 
                Swal.fire('ØªÙ…', 'Ø´ÙƒØ±Ø§Ù‹ Ù„Ø¨Ù„Ø§ØºÙƒ. ØªÙ… Ø±ÙØ¹ Ø§Ù„Ø£Ù…Ø± Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„Ù„Ø­Ø¸Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.', 'success');
            } else {
                Swal.fire('ØªÙ…', 'Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¨Ù„Ø§Øº', 'info');
            }

            await db.ref('users/' + offenderUid).update(updates);
        }
    }

    function addComment(path, id) {
        const txt = document.getElementById(`ci-${id}`).value;
        if(!txt) return;
        db.ref(`${path}/${id}/comments`).push({ uN: me.n, uP: me.p, txt: txt, date: Date.now() });
        document.getElementById(`ci-${id}`).value = "";
    }

    function loadComments(path, id) {
        db.ref(`${path}/${id}/comments`).limitToLast(5).on('value', snap => {
            const div = document.getElementById(`comments-${id}`);
            if(!div) return;
            div.innerHTML = "";
            snap.forEach(c => {
                const com = c.val();
                let rateBtn = (!isGuest && com.uP !== me.p) ? `<i class="fas fa-star rate-btn" onclick="rateUser('${com.uP}')" style="font-size:10px" title="Ù‚ÙŠÙ‘Ù…"></i>` : '';
                div.innerHTML += `<div class="comment-item" onclick="checkGuestAccess('profile','${com.uP}')" style="cursor:pointer"><b>${com.uN} ${rateBtn}:</b> ${com.txt}</div>`;
            });
        });
    }

    function renderWallet(area) {
        db.ref('settings/coinImg').on('value', snap => {
            const coinImg = snap.val() || sdmCoinImage;
            area.innerHTML = `
                <div class="wallet-card">
                    <img src="${coinImg}" class="sdm-logo">
                    ${(me.role === "admin") ? '<br><input type="file" onchange="updateCoinImg(this)" style="font-size:10px;">' : ''}
                    <h1 style="font-size:32px; margin:10px 0;">${me.sdmBalance} SDM</h1>
                    <p style="font-size:14px; color:var(--gold)">1 SDM â‰ˆ ${SDM_PRICE} Ø¬.Ø³</p>
                    <button class="btn-main" style="background:var(--green); border:2px solid #fff;" onclick="showTransfer()">ğŸ’¸ ØªØ­ÙˆÙŠÙ„ Ø¯Ø§Ø®Ù„ÙŠ Ø³Ø±ÙŠØ¹</button>
                </div>
                <div id="transactions-history" style="padding:15px; background:#fff; margin:15px; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.05);">
                    <h4 style="margin-top:0;"><i class="fas fa-history"></i> Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h4>
                    <div id="trans-list" style="max-height:200px; overflow-y:auto; font-size:12px;"></div>
                </div>
                ${(me.role === "admin") ? `<div class="admin-panel" id="admin-reqs"><h4>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h4></div>` : ''}
                <div style="padding:15px; background:#fff; margin:15px; border-radius:15px;">
                    <h3>Ø´Ø±Ø§Ø¡ Ø±ØµÙŠØ¯ SDM</h3>
                    <p style="font-size:13px; color:#666;">Ù‚Ù… Ø¨Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø®Ø±Ø·ÙˆÙ… ÙˆØ£Ø±ÙÙ‚ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:</p>
                    <div style="background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:10px;">
                        <p>Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨: <b>4426148</b><br>Ø§Ù„Ø§Ø³Ù…: <b>Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¹Ø·ÙŠ</b></p>
                    </div>
                    <input id="buy-qty" type="number" placeholder="ÙƒÙ… Ø¹Ø¯Ø¯ Ø­Ø¨Ø§Øª SDMØŸ" oninput="document.getElementById('buy-cost').innerText='Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: '+(this.value*${SDM_PRICE})+' Ø¬.Ø³'">
                    <div id="buy-cost" style="margin-bottom:10px; font-weight:bold; color:var(--blue);"></div>
                    <input type="file" id="buy-img" onchange="encode(this, 'buy')">
                    <button class="btn-main" onclick="requestCoins()">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„Ù„Ù…Ø·ÙˆØ±</button>
                </div>`;
            if(me.role === "admin") loadAdminRequests();
            loadTransactions();
        });
    }

    function loadTransactions() {
        db.ref('transactions').limitToLast(50).on('value', snap => {
            const list = document.getElementById('trans-list');
            if(!list) return;
            list.innerHTML = "";
            let items = [];
            snap.forEach(c => { 
                let item = c.val();
                item.key = c.key;
                if (item.involves && item.involves.includes(me.p)) {
                    items.unshift(item); 
                }
            });
            
            if(items.length === 0) list.innerHTML = "<p style='color:#ccc; text-align:center;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø¹Ø¯</p>";
            
            items.forEach(t => {
                const isSent = t.sender === me.p;
                let desc = "";
                if(t.type === 'purchase') {
                    desc = `<span style="color:green">ğŸ“¥ Ø¹Ù…Ù„ÙŠØ© Ø´Ø­Ù† Ø±ØµÙŠØ¯: +${t.amount} SDM</span>`;
                } else {
                    desc = `<span style="color:${isSent?'red':'green'}">${isSent?'Ù…Ù†Ùƒ Ø¥Ù„Ù‰:':'Ø¥Ù„ÙŠÙƒ Ù…Ù†:'} ${isSent?t.receiverName:t.senderName} (${t.amount} SDM)</span>`;
                }

                let editBtn = '';
                if(me.role === 'admin') {
                    editBtn = `<i class="fas fa-edit" style="color:blue; cursor:pointer; margin-right:5px;" onclick="editTransaction('${t.key}', ${t.amount})"></i>`;
                }

                list.innerHTML += `
                    <div style="padding:10px; border-bottom:1px solid #eee; margin-bottom:5px; background:#fbfbfb; border-radius:5px;">
                        <div style="display:flex; justify-content:space-between; font-weight:bold;">
                            <div>${desc} ${editBtn}</div>
                        </div>
                        <div style="font-size:10px; color:#777; margin-top:3px;">
                            <span>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ (ID): ${t.opId}</span> | <span>${new Date(t.date).toLocaleDateString()}</span>
                        </div>
                    </div>`;
            });
        });
    }

    async function editTransaction(key, oldAmount) {
        if(me.role !== 'admin') return;
        const { value: newAmount } = await Swal.fire({
            title: 'ØªØ¹Ø¯ÙŠÙ„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©',
            input: 'number',
            inputValue: oldAmount,
            showCancelButton: true
        });

        if(newAmount) {
            await db.ref('transactions/' + key).update({ amount: Number(newAmount) });
            Swal.fire('ØªÙ…', 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø©', 'success');
        }
    }

    function loadAdminRequests() {
        db.ref('coin_requests').orderByChild('status').equalTo('pending').on('value', snap => {
            const div = document.getElementById('admin-reqs');
            if(!div) return;
            div.innerHTML = "<h4>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h4>";
            snap.forEach(c => {
                const r = c.val();
                div.innerHTML += `<div style="border-bottom:1px solid #eee; padding:10px;" class="admin-item"><p>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${r.uN}<br>Ø§Ù„ÙƒÙ…ÙŠØ©: ${r.qty} Ø­Ø¨Ø©</p><img src="${r.img}" style="width:100px; cursor:pointer" onclick="Swal.fire({imageUrl: '${r.img}'})"><br><button onclick="approvePurchase('${c.key}', '${r.uP}', ${r.qty})" style="background:green; color:white;">Ù…ÙˆØ§ÙÙ‚</button><button onclick="rejectPurchase('${c.key}', '${r.uP}')" style="background:red; color:white;">Ø±ÙØ¶</button></div>`;
            });
        });
    }

    function showTransfer() {
        // Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙŠØ¹ØªÙ…Ø¯ Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (UID) 
        // Ø£Ùˆ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ø¨Ø± Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
        Swal.fire({
            title: 'ØªØ­ÙˆÙŠÙ„ Ø³Ø±ÙŠØ¹ ÙˆØ¢Ù…Ù†',
            html: `
            <div class="transfer-box">
                <p style="font-size:12px; color:#666">Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø³ØªÙ„Ù… Ù†Ø³Ø® "ÙƒÙˆØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨" Ù…Ù† Ù…Ù„ÙÙ‡ Ø§Ù„Ø´Ø®ØµÙŠ</p>
                <div class="input-group-custom">
                    <label style="display:block; text-align:right; margin-bottom:5px; font-weight:bold;">ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙ„Ù… (UID)</label>
                    <input id="tr-p" type="text" class="transfer-input" placeholder="Ø£Ù„ØµÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§" oninput="checkRecipient(this.value)">
                </div>
                <div id="rec-name" style="font-size:14px; margin-bottom:15px; font-weight:bold; height:20px;"></div>
                <div class="input-group-custom">
                    <label style="display:block; text-align:right; margin-bottom:5px; font-weight:bold;">Ø§Ù„Ù…Ø¨Ù„Øº (SDM)</label>
                    <input id="tr-a" type="number" class="transfer-input" placeholder="0">
                </div>
            </div>`,
            showCancelButton: true,
            confirmButtonText: 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù† ğŸš€',
            preConfirm: () => {
                const p = document.getElementById('tr-p').value.trim(), a = document.getElementById('tr-a').value;
                if (!p || !a) { Swal.showValidationMessage('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø©'); return false; }
                if (p === me.p) { Swal.showValidationMessage('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù†ÙØ³Ùƒ'); return false; }
                return { p, a };
            }
        }).then(async res => {
            if (!res.isConfirmed) return;
            const { p, a } = res.value;
            const amount = Number(a);
            if (me.sdmBalance < amount) return Swal.fire('Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ', '', 'error');
            const s = await db.ref('users/' + p).once('value');
            if (!s.exists()) return Swal.fire('Ø§Ù„Ù…Ø³ØªÙ„Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', '', 'error');
            const receiverData = s.val();
            const opId = "SDM-" + Math.random().toString(36).substr(2, 9).toUpperCase();
            const timeNow = new Date().toLocaleString('ar-EG');
            await db.ref('users/' + me.p).update({ sdmBalance: me.sdmBalance - amount });
            await db.ref('users/' + p).update({ sdmBalance: (receiverData.sdmBalance || 0) + amount });
            const receiptData = { isReceipt: true, opId: opId, senderName: me.n, receiverName: receiverData.n, amount: amount, time: timeNow, type: 'success' };
            db.ref('transactions').push({ opId, amount, sender: me.p, senderName: me.n, receiver: p, receiverName: receiverData.n, date: Date.now(), involves: [me.p, p], type: 'transfer' });
            await db.ref('alerts/' + p).push(receiptData);
            showReceiptModal(receiptData);
        });
    }

    async function checkRecipient(uid) {
        if(uid.length > 5) {
            const s = await db.ref('users/'+uid).once('value');
            const el = document.getElementById('rec-name');
            if(s.exists()){ el.innerHTML = `<span style="color:green"><i class="fas fa-check-circle"></i> Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ«ÙˆÙ‚: ${s.val().n}</span>`; }
            else { el.innerHTML = `<span style="color:red"><i class="fas fa-times-circle"></i> ÙƒÙˆØ¯ Ø®Ø§Ø·Ø¦</span>`; }
        } else { document.getElementById('rec-name').innerText = ""; }
    }

    function renderVip(area) {
        if (me.vipStatus === 'active') {
            area.innerHTML = `<div class="publish-container"><h4 style="color:var(--gold);">ğŸ’ Ù†Ø´Ø± Ø¹Ø±Ø¶ VIP</h4><input id="v-t" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ø±Ø¶"><div style="display:flex; gap:10px;"><input id="v-old-pr" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…"><input id="v-pr" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ®ÙÙŠØ¶"></div><input id="v-wa" type="number" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„ØªÙˆØ§ØµÙ„" value="${me.wa||''}"><textarea id="v-d" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶"></textarea><input type="file" onchange="encode(this, 'post')"><button class="btn-main" style="background:var(--gold); color:black;" onclick="publish('vip_posts')">Ù†Ø´Ø± Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„Ù€ VIP</button></div>`;
        } else {
            area.innerHTML = `<div style="padding:20px; text-align:center;">
                <i class="fas fa-crown" style="font-size:50px; color:var(--gold);"></i>
                <h3>Ø§Ø´ØªØ±Ø§Ùƒ VIP</h3>
                <p>Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${me.sdmBalance} SDM</p>
                <div class="grid">
                    <div class="card" onclick="subVip(1, 1)">ÙŠÙˆÙ… (1 SDM)</div>
                    <div class="card" onclick="subVip(7, 7)">Ø£Ø³Ø¨ÙˆØ¹ (7 SDM)</div>
                </div>
            </div>`;
        }
    }

    async function subVip(d, c) {
        if(me.sdmBalance < c) return Swal.fire('Ø¹Ø°Ø±Ø§Ù‹','Ø±ØµÙŠØ¯Ùƒ Ù„Ø§ ÙŠÙƒÙÙŠ','error');
        const exp = Date.now() + (d * 86400000);
        await db.ref('users/'+me.p).update({ sdmBalance: me.sdmBalance - c, vipStatus: 'active', vipExpiry: exp });
        Swal.fire('Ù…Ø¨Ø±ÙˆÙƒ!','Ø£ØµØ¨Ø­Øª VIP','success');
    }

    async function checkVipExpiry() {
        if(me && me.vipStatus === 'active' && Date.now() > me.vipExpiry) {
            await db.ref('users/'+me.p).update({ vipStatus: 'none' });
            const vipSnap = await db.ref('vip_posts').orderByChild('uP').equalTo(me.p).once('value');
            vipSnap.forEach(child => { child.ref.remove(); });
            Swal.fire('Ø§Ù†ØªÙ‡Ù‰ Ø§Ø´ØªØ±Ø§Ùƒ VIP', 'ØªÙ… Ø­Ø°Ù Ù…Ù†Ø´ÙˆØ±Ø§ØªÙƒ Ø§Ù„Ù…Ù…ÙŠØ²Ø©ØŒ Ø§Ø´ØªØ±Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ù„Ù„Ù†Ø´Ø±', 'warning');
        }
    }

    function publish(path) {
        if(isGuest) return checkGuestAccess('publish');
        const isVip = path === 'vip_posts';
        const t = (isVip ? document.getElementById('v-t') : document.getElementById('pt')).value;
        const pr = (isVip ? document.getElementById('v-pr') : document.getElementById('pp')).value;
        const oldPr = (isVip ? document.getElementById('v-old-pr').value : null);
        const d = (isVip ? document.getElementById('v-d') : document.getElementById('pd')).value;
        const wa = (isVip ? document.getElementById('v-wa') : document.getElementById('p-whatsapp')).value;
        
        if(!t || !pr || !tempImg) return Swal.fire('Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©','ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„ØµÙˆØ±Ø©','warning');
        
        const data = { 
            t, pr, oldPr, d, wa, 
            img: tempImg, 
            uP: me.p, uN: me.n, 
            uPic: me.pic || 'https://via.placeholder.com/150', 
            uStars: me.rating || 0, 
            date: Date.now(), 
            status: 'active' 
        };
        
        if(isVip) data.vExpiry = me.vipExpiry;
        else data.sub = curS;
        
        db.ref(path).push(data);
        Swal.fire('ØªÙ… Ø§Ù„Ù†Ø´Ø±','','success');
        tempImg = ''; // Ù…Ø³Ø­ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
        isVip ? nav('home') : render('feed', curS);
    }

    function loadVipHome() {
        const slider = document.getElementById('vip-slider');
        if(!slider) return;
        slider.innerHTML = `<h4 style="margin:15px; color:var(--navy);"><i class="fas fa-star" style="color:var(--gold)"></i> Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù€ VIP</h4><div id="vip-slider-inner" style="display:flex; overflow-x:auto; padding:10px;"></div><hr style="border:0; border-top:1px solid #eee;">`;
        loadPosts('vip_posts', null);
    }

    function renderProfile(area, uid) {
        db.ref('users/'+uid).once('value', snap => {
            const u = snap.val();
            if (!u) { area.innerHTML = "Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"; return; }
            const isMe = (me && uid === me.p);
            
            let badgeHTML = '';
            const rating = u.rating || 0;
            if (rating >= 100) {
                badgeHTML = '<div class="badge-super" style="display:inline-block; font-size:16px; padding:8px 15px; margin-top:10px;">ğŸ’ ØªØ§Ø¬Ø± Ù…Ù…ÙŠØ²</div>';
            } else if (rating >= 50) {
                badgeHTML = '<div class="badge-good" style="display:inline-block; font-size:16px; padding:8px 15px; margin-top:10px;">âœ… ØªØ§Ø¬Ø± Ø¬ÙŠØ¯</div>';
            }

            area.innerHTML = `
                <div style="text-align:center; padding:30px;">
                    <img src="${u.pic || 'https://via.placeholder.com/150'}" id="profile-img-view" style="width:120px; height:120px; border-radius:50%; border:4px solid var(--blue); object-fit:cover; margin-bottom:15px;">
                    ${isMe ? '<br><label style="font-size:12px; color:blue; cursor:pointer">ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø© <input type="file" onchange="encode(this, \'user\')" style="display:none"></label>' : ''}
                    <h2 style="margin:0">${u.n}</h2>
                    <p style="color:var(--gold); font-size:18px;">â­ ${rating.toFixed(1)} ØªÙ‚ÙŠÙŠÙ…</p>
                    ${badgeHTML}
                    <br>
                    
                    ${isMe ? `
                    <div style="background:#f0f2f5; padding:10px; border-radius:10px; margin:10px; font-family:monospace; word-break:break-all;">
                        <span style="font-size:10px; color:#666">ÙƒÙˆØ¯ Ø§Ù„Ø­Ø³Ø§Ø¨ (Ù„Ù„ØªØ­ÙˆÙŠÙ„):</span><br>
                        <b>${u.p}</b>
                        <br><button onclick="navigator.clipboard.writeText('${u.p}'); Swal.fire('ØªÙ… Ø§Ù„Ù†Ø³Ø®')" style="font-size:10px; padding:2px 5px; margin-top:5px;">Ù†Ø³Ø®</button>
                    </div>
                    ` : ''}

                    ${!isMe && !isGuest ? `
                    <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
                        <button class="btn-main" style="background:var(--gold); color:black; width:auto; padding:10px 20px;" onclick="rateUser('${uid}')">â­ ØªÙ‚ÙŠÙŠÙ…</button>
                        <button class="btn-main" style="background:var(--red); width:auto; padding:10px 20px;" onclick="reportUser('${uid}')">ğŸš© Ø¥Ø¨Ù„Ø§Øº</button>
                    </div>
                    ` : ''}
                    
                    ${isMe ? `
                    <div style="background:#fff; padding:20px; border-radius:15px; margin-top:20px;">
                        <p style="margin:5px 0; color:#666">Ø§Ù„Ø±ØµÙŠØ¯</p>
                        <h3 style="margin:0; color:var(--blue)">${u.sdmBalance} SDM</h3>
                    </div>
                    <div style="margin-top:10px">
                        <small>Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„: ${u.wa || 'ØºÙŠØ± Ù…Ø³Ø¬Ù„'}</small>
                        <i class="fas fa-edit" onclick="promptWhatsApp()" style="cursor:pointer; color:blue"></i>
                    </div>
                    ` : ''}

                    ${isMe ? `<button class="btn-main" style="background:var(--red); margin-top:30px;" onclick="doLogout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>` : ''}
                </div>`;
        });
    }

    async function rateUser(uid) {
        if(isGuest) return checkGuestAccess('profile');
        if(uid === me.p) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ‚ÙŠÙŠÙ… Ù†ÙØ³Ùƒ', 'warning');

        const uSnap = await db.ref('users/'+uid).once('value');
        const userData = uSnap.val();
        const ratedBy = userData.ratedBy || [];
        
        if(ratedBy.includes(me.p)) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªÙ‚ÙŠÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®Øµ Ù…Ø³Ø¨Ù‚Ø§Ù‹','info');
        
        const { value: stars } = await Swal.fire({
            title: 'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØ§Ø¬Ø±', input: 'select', inputOptions: { '1':'â­','2':'â­â­','3':'â­â­â­','4':'â­â­â­â­','5':'â­â­â­â­â­' }, inputPlaceholder: 'Ø§Ø®ØªØ± Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø¬ÙˆÙ…', showCancelButton: true
        });
        if(stars) {
            ratedBy.push(me.p);
            const newRating = (userData.rating || 0) + Number(stars);
            
            db.ref('users/'+uid).update({ rating: newRating, ratedBy: ratedBy });
            Swal.fire('Ø´ÙƒØ±Ø§Ù‹','ØªÙ… Ø­ÙØ¸ ØªÙ‚ÙŠÙŠÙ…Ùƒ','success');
        }
    }

    function updateCoinImg(input) {
        if (me.role !== 'admin') return;
        if(!input.files[0]) return;
        encode({files:[input.files[0]]}, 'coin-setting').then(() => {
            db.ref('settings/coinImg').set(tempImg); 
            Swal.fire('ØªÙ…', 'ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù…Ù„Ø©', 'success');
        });
    }

    function requestCoins() {
        const qty = document.getElementById('buy-qty').value;
        if(!qty || !window.tempBuyImg) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØµÙˆØ±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±','warning');
        db.ref('coin_requests').push({ uP: me.p, uN: me.n, qty, img: window.tempBuyImg, status: 'pending', date: Date.now() });
        Swal.fire('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„','Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©','success');
    }

</script>
</body>
</html>

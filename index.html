<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SDM Market Pro | منصة تداول P2P</title>
    
    <!-- خطوط عربية -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
    
    <!-- مكتبات خارجية -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.95);
            --primary: #3b82f6;
            --accent: #f59e0b;
            --neon-blue: #00f3ff;
            --text-main: #f8fafc;
            --text-sec: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
            --red: #ef4444; 
            --green: #10b981; 
            --buy-color: #10b981;
            --sell-color: #ef4444;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline:none; }
        
        body {
            font-family: 'Tajawal', sans-serif; 
            margin: 0;
            background: radial-gradient(circle at top, #1e293b, #0f172a); 
            color: var(--text-main);
            padding-bottom: 90px;
            min-height: 100vh;
            user-select: none;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }

        .hidden { display: none !important; }
        .search-hidden { display: none !important; }

        /* Header */
        header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            padding: 15px 20px;
            position: sticky; top: 0; z-index: 1000;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; gap: 10px;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        
        .search-container { position: relative; width: 100%; }
        .search-container input {
            width: 100%; padding: 12px 45px 12px 15px;
            border-radius: 15px; border: 1px solid var(--border);
            font-size: 14px; background: rgba(255,255,255,0.05); color: white;
            transition: 0.3s; font-family: 'Tajawal';
        }
        .search-container i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--accent); }

        /* Trading Interface */
        .trading-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
        }

        .price-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-card);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid var(--border);
        }

        .current-price {
            text-align: center;
            flex: 1;
        }

        .price-value {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-main);
        }

        .price-change {
            font-size: 12px;
            margin-top: 5px;
        }

        .positive { color: var(--buy-color); }
        .negative { color: var(--sell-color); }

        .market-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-box {
            background: var(--bg-card);
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--border);
        }

        .stat-label {
            font-size: 10px;
            color: var(--text-sec);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-main);
        }

        /* Chart Container */
        .chart-container {
            height: 280px;
            background: var(--bg-card);
            border-radius: 15px;
            border: 1px solid var(--border);
            overflow: hidden;
            margin-bottom: 15px;
        }

        /* Order Book */
        .order-book-wrapper {
            display: flex;
            flex-direction: column;
            height: 300px;
            background: var(--bg-card);
            border-radius: 15px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .order-book-header {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }

        .order-book-side {
            display: flex;
            flex: 1;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-sec);
        }

        .order-book-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
        }

        .order-side {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .bids-side { border-left: 1px solid var(--border); }

        .order-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            overflow: hidden;
        }

        .order-row:hover {
            background: rgba(255,255,255,0.05);
        }

        .order-row.bid {
            color: var(--buy-color);
        }

        .order-row.ask {
            color: var(--sell-color);
        }

        .order-row .depth-bar {
            position: absolute;
            top: 0;
            right: 0;
            height: 100%;
            opacity: 0.1;
            z-index: 0;
        }

        .order-row.bid .depth-bar {
            background: var(--buy-color);
        }

        .order-row.ask .depth-bar {
            background: var(--sell-color);
        }

        .order-row .content {
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        /* Trade Panel */
        .trade-panel {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--border);
        }

        .trade-tabs {
            display: flex;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 3px;
            margin-bottom: 20px;
        }

        .trade-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 14px;
        }

        .trade-tab.buy.active {
            background: var(--buy-color);
            color: black;
        }

        .trade-tab.sell.active {
            background: var(--sell-color);
            color: white;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-size: 12px;
            color: var(--text-sec);
            margin-bottom: 5px;
        }

        .trade-input {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: white;
            font-family: 'Tajawal';
            font-size: 14px;
        }

        .percentage-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin: 15px 0;
        }

        .percentage-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border);
            padding: 8px;
            text-align: center;
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .percentage-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .balance-info {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin: 15px 0;
            color: var(--text-sec);
        }

        .balance-info span {
            color: var(--text-main);
            font-weight: bold;
        }

        .trade-button {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: none;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Tajawal';
        }

        .buy-button {
            background: linear-gradient(90deg, var(--buy-color), #059669);
            color: white;
        }

        .sell-button {
            background: linear-gradient(90deg, var(--sell-color), #b91c1c);
            color: white;
        }

        .trade-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .trade-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Recent Trades */
        .recent-trades {
            background: var(--bg-card);
            border-radius: 15px;
            border: 1px solid var(--border);
            padding: 15px;
            margin-top: 15px;
        }

        .recent-trades-header {
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-main);
        }

        .trade-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .trade-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
        }

        .trade-item:last-child {
            border-bottom: none;
        }

        .trade-item.buy {
            color: var(--buy-color);
        }

        .trade-item.sell {
            color: var(--sell-color);
        }

        /* Bottom Nav */
        .bottom-tabs {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid var(--border);
            z-index: 1000;
        }
        .tab-btn {
            color: var(--text-sec);
            text-align: center;
            font-size: 10px;
            flex: 1;
            cursor: pointer;
            transition: 0.3s;
        }
        .tab-btn.active {
            color: var(--neon-blue);
            transform: translateY(-5px);
        }
        .tab-btn i {
            font-size: 22px;
            margin-bottom: 4px;
            display: block;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<div id="app-screen">
    <header>
        <div class="header-top">
            <span onclick="goBack()" style="cursor:pointer; font-size:22px; color:var(--text-sec)"><i class="fas fa-arrow-right"></i></span>
            <span id="head-title" style="font-weight: 800; font-size: 20px; color: var(--text-main);">تداول MRK</span>
            <div style="background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:15px; display:flex; align-items:center; gap:5px;">
                <i class="fas fa-star" style="color:var(--accent); font-size:12px;"></i>
                <span id="u-stars" style="font-size:12px; font-weight:bold;">0.0</span>
            </div>
        </div>
    </header>

    <div id="content-area">
        <div class="trading-container">
            <!-- Price Header -->
            <div class="price-header">
                <div class="current-price">
                    <div class="price-value" id="current-price">0.0500</div>
                    <div class="price-change positive" id="price-change">+0.00%</div>
                </div>
                <div class="market-stats">
                    <div class="stat-box">
                        <div class="stat-label">24h High</div>
                        <div class="stat-value" id="24h-high">0.0000</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">24h Low</div>
                        <div class="stat-value" id="24h-low">0.0000</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">24h Volume</div>
                        <div class="stat-value" id="24h-volume">0 SDM</div>
                    </div>
                </div>
            </div>

            <!-- Chart -->
            <div class="chart-container">
                <div id="chart" style="height: 100%;"></div>
            </div>

            <!-- Order Book -->
            <div class="order-book-wrapper">
                <div class="order-book-header">
                    <div class="order-book-side">
                        <span>الكمية (MRK)</span>
                        <span>السعر (SDM)</span>
                    </div>
                    <div class="order-book-side bids-side">
                        <span>السعر (SDM)</span>
                        <span>الكمية (MRK)</span>
                    </div>
                </div>
                <div class="order-book-content">
                    <div class="order-side" id="asks-side">
                        <!-- Asks will be inserted here -->
                    </div>
                    <div class="order-side bids-side" id="bids-side">
                        <!-- Bids will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- Trade Panel -->
            <div class="trade-panel">
                <div class="trade-tabs">
                    <div class="trade-tab buy active" onclick="setTradeMode('buy')">
                        شراء MRK
                    </div>
                    <div class="trade-tab sell" onclick="setTradeMode('sell')">
                        بيع MRK
                    </div>
                </div>

                <div class="input-group">
                    <label for="order-price">السعر (SDM)</label>
                    <input type="number" id="order-price" class="trade-input" placeholder="0.0000" step="0.0001">
                </div>

                <div class="input-group">
                    <label for="order-amount">الكمية (MRK)</label>
                    <input type="number" id="order-amount" class="trade-input" placeholder="0.00">
                </div>

                <div class="percentage-buttons">
                    <div class="percentage-btn" onclick="setPercentage(0.25)">25%</div>
                    <div class="percentage-btn" onclick="setPercentage(0.50)">50%</div>
                    <div class="percentage-btn" onclick="setPercentage(0.75)">75%</div>
                    <div class="percentage-btn" onclick="setPercentage(1)">100%</div>
                </div>

                <div class="balance-info">
                    <div>المتاح: <span id="available-balance">0.00</span> <span id="balance-type">SDM</span></div>
                    <div>الإجمالي: <span id="order-total">0.00</span> SDM</div>
                </div>

                <button class="trade-button buy-button" id="execute-button" onclick="executeOrder()">
                    شراء MRK
                </button>
            </div>

            <!-- Recent Trades -->
            <div class="recent-trades">
                <div class="recent-trades-header">آخر الصفقات</div>
                <div class="trade-list" id="recent-trades-list">
                    <!-- Recent trades will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <div class="bottom-tabs">
        <div class="tab-btn" onclick="nav('home'); highlightTab(this)"><i class="fas fa-home"></i>الرئيسية</div>
        <div class="tab-btn active" onclick="checkGuestAccess('trade'); highlightTab(this)"><i class="fas fa-chart-line"></i>تداول</div>
        <div class="tab-btn" onclick="checkGuestAccess('wallet'); highlightTab(this)"><i class="fas fa-wallet"></i>المحفظة</div>
        <div class="tab-btn" onclick="checkGuestAccess('profile'); highlightTab(this)"><i class="fas fa-user-astronaut"></i>ملفي</div>
    </div>
</div>

<script>
    // Firebase Configuration
    const firebaseConfig = {
        apiKey: "AIzaSyAI_mUhuPNoO-XC0Q-VNoWft8UWFbAbIGg",
        authDomain: "sudan-market-6b122.firebaseapp.com",
        databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com",
        projectId: "sudan-market-6b122",
        storageBucket: "sudan-market-6b122.firebasestorage.app",
        messagingSenderId: "66729481566",
        appId: "1:66729481566:web:93393f28dc22d32cceebcf"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    
    const auth = firebase.auth();
    const db = firebase.database();

    // Global Variables
    let me = null;
    let currentTradeMode = 'buy';
    let marketPrice = 0.05;
    let marketStats = {
        high24h: 0.05,
        low24h: 0.05,
        volume24h: 0
    };
    let chartInstance = null;
    let lastActionTime = 0;
    const BASE_RATE = 0.05; // 1 SDM = 20 MRK

    // Initialize Trading System
    async function initializeTrading() {
        // Listen for user authentication
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // Get user data
                const userRef = db.ref('users/' + user.uid);
                userRef.on('value', (snapshot) => {
                    if (snapshot.exists()) {
                        me = snapshot.val();
                        me.p = user.uid;
                        updateBalanceDisplay();
                    }
                });
            } else {
                // Guest mode
                me = { 
                    n: 'زائر', 
                    p: 'guest', 
                    role: 'guest', 
                    sdmBalance: 0, 
                    mrkBalance: 0 
                };
                updateBalanceDisplay();
            }
        });

        // Initialize Chart
        initChart();

        // Load Market Data
        loadMarketData();
        listenToOrderBook();
        listenToRecentTrades();
        listenToMarketStats();

        // Setup event listeners
        setupEventListeners();
    }

    // Setup Event Listeners
    function setupEventListeners() {
        const priceInput = document.getElementById('order-price');
        const amountInput = document.getElementById('order-amount');

        priceInput.addEventListener('input', updateOrderTotal);
        amountInput.addEventListener('input', updateOrderTotal);
    }

    // Update Balance Display
    function updateBalanceDisplay() {
        if (!me) return;

        const balanceType = currentTradeMode === 'buy' ? 'SDM' : 'MRK';
        const availableBalance = currentTradeMode === 'buy' 
            ? (me.sdmBalance || 0).toFixed(2)
            : (me.mrkBalance || 0).toFixed(4);

        document.getElementById('available-balance').textContent = availableBalance;
        document.getElementById('balance-type').textContent = balanceType;
    }

    // Set Trade Mode
    function setTradeMode(mode) {
        currentTradeMode = mode;
        
        // Update UI
        document.querySelectorAll('.trade-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        const activeTab = mode === 'buy' 
            ? document.querySelector('.trade-tab.buy')
            : document.querySelector('.trade-tab.sell');
        
        if (activeTab) activeTab.classList.add('active');

        // Update button
        const executeButton = document.getElementById('execute-button');
        if (mode === 'buy') {
            executeButton.textContent = 'شراء MRK';
            executeButton.className = 'trade-button buy-button';
        } else {
            executeButton.textContent = 'بيع MRK';
            executeButton.className = 'trade-button sell-button';
        }

        // Update balance display
        updateBalanceDisplay();
        updateOrderTotal();
    }

    // Set Percentage
    function setPercentage(percentage) {
        if (!me) return;

        const price = parseFloat(document.getElementById('order-price').value) || marketPrice;
        
        if (currentTradeMode === 'buy') {
            const availableSDM = me.sdmBalance || 0;
            const maxMRK = availableSDM / price;
            const amount = maxMRK * percentage;
            document.getElementById('order-amount').value = amount.toFixed(4);
        } else {
            const availableMRK = me.mrkBalance || 0;
            const amount = availableMRK * percentage;
            document.getElementById('order-amount').value = amount.toFixed(4);
        }

        updateOrderTotal();
    }

    // Update Order Total
    function updateOrderTotal() {
        const price = parseFloat(document.getElementById('order-price').value) || 0;
        const amount = parseFloat(document.getElementById('order-amount').value) || 0;
        const total = price * amount;
        
        document.getElementById('order-total').textContent = total.toFixed(2);
    }

    // Execute Order
    async function executeOrder() {
        if (Date.now() - lastActionTime < 2000) {
            showAlert('تنبيه', 'انتظر قليلاً بين العمليات', 'warning');
            return;
        }

        lastActionTime = Date.now();

        const price = parseFloat(document.getElementById('order-price').value);
        const amount = parseFloat(document.getElementById('order-amount').value);
        const total = price * amount;

        // Validation
        if (!price || !amount || price <= 0 || amount <= 0) {
            showAlert('خطأ', 'الرجاء إدخال بيانات صحيحة', 'error');
            return;
        }

        if (currentTradeMode === 'buy') {
            if ((me.sdmBalance || 0) < total) {
                showAlert('خطأ', 'رصيد SDM غير كافي', 'error');
                return;
            }
        } else {
            if ((me.mrkBalance || 0) < amount) {
                showAlert('خطأ', 'رصيد MRK غير كافي', 'error');
                return;
            }
        }

        // Disable button during processing
        const button = document.getElementById('execute-button');
        button.disabled = true;
        const originalText = button.textContent;
        button.textContent = 'جاري المعالجة...';

        try {
            const orderData = {
                userId: me.p,
                userName: me.n,
                price: price,
                amount: amount,
                originalAmount: amount,
                type: currentTradeMode,
                timestamp: Date.now(),
                status: 'pending'
            };

            // Reserve balance
            if (currentTradeMode === 'buy') {
                await db.ref(`users/${me.p}`).update({
                    sdmBalance: (me.sdmBalance || 0) - total
                });
                me.sdmBalance = (me.sdmBalance || 0) - total;
            } else {
                await db.ref(`users/${me.p}`).update({
                    mrkBalance: (me.mrkBalance || 0) - amount
                });
                me.mrkBalance = (me.mrkBalance || 0) - amount;
            }

            // Create order
            const orderRef = db.ref(`market/orders/${currentTradeMode}`).push();
            await orderRef.set(orderData);

            // Try to match order
            await matchOrder(orderRef.key, orderData);

            // Clear inputs
            document.getElementById('order-price').value = '';
            document.getElementById('order-amount').value = '';
            updateOrderTotal();

            showAlert('نجاح', 'تم إرسال الطلب بنجاح', 'success');

        } catch (error) {
            console.error('Error executing order:', error);
            showAlert('خطأ', 'حدث خطأ أثناء المعالجة', 'error');
            
            // Revert balance reservation on error
            if (currentTradeMode === 'buy') {
                await db.ref(`users/${me.p}`).update({
                    sdmBalance: (me.sdmBalance || 0)
                });
            } else {
                await db.ref(`users/${me.p}`).update({
                    mrkBalance: (me.mrkBalance || 0)
                });
            }
        } finally {
            // Re-enable button
            button.disabled = false;
            button.textContent = originalText;
            updateBalanceDisplay();
        }
    }

    // Match Order Function
    async function matchOrder(orderId, order) {
        const oppositeType = order.type === 'buy' ? 'sell' : 'buy';
        const ordersRef = db.ref(`market/orders/${oppositeType}`);
        
        // Query for matching orders
        let query;
        if (order.type === 'buy') {
            // For buy orders: find sell orders with price <= buy price
            query = ordersRef.orderByChild('price').endAt(order.price);
        } else {
            // For sell orders: find buy orders with price >= sell price
            query = ordersRef.orderByChild('price').startAt(order.price);
        }

        const snapshot = await query.once('value');
        if (!snapshot.exists()) return;

        let remainingAmount = order.amount;
        const matches = [];

        snapshot.forEach((childSnapshot) => {
            if (remainingAmount <= 0) return;

            const oppositeOrder = childSnapshot.val();
            if (oppositeOrder.status !== 'pending') return;

            const matchAmount = Math.min(remainingAmount, oppositeOrder.amount);
            const matchPrice = oppositeOrder.price;
            
            matches.push({
                matchOrderId: childSnapshot.key,
                matchOrder: oppositeOrder,
                amount: matchAmount,
                price: matchPrice
            });

            remainingAmount -= matchAmount;
        });

        // Execute matches
        for (const match of matches) {
            await executeTradeMatch(orderId, order, match.matchOrderId, match.matchOrder, match.amount, match.price);
        }

        // Update original order if partially filled
        if (remainingAmount < order.amount) {
            const filledAmount = order.amount - remainingAmount;
            
            if (remainingAmount > 0) {
                // Partial fill - update order
                await db.ref(`market/orders/${order.type}/${orderId}`).update({
                    amount: remainingAmount,
                    status: 'partially_filled',
                    filledAmount: filledAmount
                });
            } else {
                // Full fill - remove order
                await db.ref(`market/orders/${order.type}/${orderId}`).update({
                    status: 'filled',
                    filledAmount: order.amount
                });
            }
        }
    }

    // Execute Trade Match
    async function executeTradeMatch(buyOrderId, buyOrder, sellOrderId, sellOrder, amount, price) {
        const totalValue = amount * price;
        const tradeId = db.ref('market/trades').push().key;

        // Calculate amounts
        const buyerSDMDeduction = totalValue;
        const buyerMRKAddition = amount;
        
        const sellerMRKDeduction = amount;
        const sellerSDMAddition = totalValue;

        try {
            // Update balances atomically
            await db.ref().transaction(async (currentData) => {
                if (!currentData) return currentData;

                // Check balances
                const buyer = currentData.users && currentData.users[buyOrder.userId];
                const seller = currentData.users && currentData.users[sellOrder.userId];

                if (!buyer || !seller) return;

                if (buyer.sdmBalance < buyerSDMDeduction) {
                    throw new Error('Insufficient buyer balance');
                }

                if (seller.mrkBalance < sellerMRKDeduction) {
                    throw new Error('Insufficient seller balance');
                }

                // Update balances
                currentData.users[buyOrder.userId].sdmBalance -= buyerSDMDeduction;
                currentData.users[buyOrder.userId].mrkBalance += buyerMRKAddition;
                
                currentData.users[sellOrder.userId].mrkBalance -= sellerMRKDeduction;
                currentData.users[sellOrder.userId].sdmBalance += sellerSDMAddition;

                // Record trade
                if (!currentData.market) currentData.market = {};
                if (!currentData.market.trades) currentData.market.trades = {};
                
                currentData.market.trades[tradeId] = {
                    buyerId: buyOrder.userId,
                    sellerId: sellOrder.userId,
                    price: price,
                    amount: amount,
                    total: totalValue,
                    timestamp: Date.now(),
                    type: 'trade'
                };

                // Update order status
                if (!currentData.market.orders) currentData.market.orders = {};
                
                // Update buy order
                if (buyOrder.amount === amount) {
                    if (!currentData.market.orders.buy) currentData.market.orders.buy = {};
                    currentData.market.orders.buy[buyOrderId] = {
                        ...buyOrder,
                        status: 'filled',
                        filledAt: Date.now()
                    };
                }
                
                // Update sell order
                if (sellOrder.amount === amount) {
                    if (!currentData.market.orders.sell) currentData.market.orders.sell = {};
                    currentData.market.orders.sell[sellOrderId] = {
                        ...sellOrder,
                        status: 'filled',
                        filledAt: Date.now()
                    };
                }

                return currentData;
            });

            // Update user data locally
            if (me.p === buyOrder.userId) {
                me.sdmBalance = (me.sdmBalance || 0) - buyerSDMDeduction;
                me.mrkBalance = (me.mrkBalance || 0) + buyerMRKAddition;
            } else if (me.p === sellOrder.userId) {
                me.mrkBalance = (me.mrkBalance || 0) - sellerMRKDeduction;
                me.sdmBalance = (me.sdmBalance || 0) + sellerSDMAddition;
            }

            // Update market price
            marketPrice = price;
            updatePriceDisplay();

            showAlert('نجاح', `تم تنفيذ صفقة ${amount} MRK بسعر ${price} SDM`, 'success');

        } catch (error) {
            console.error('Trade execution failed:', error);
            showAlert('خطأ', 'فشل تنفيذ الصفقة', 'error');
        }
    }

    // Load Market Data
    function loadMarketData() {
        // Load initial market price
        db.ref('market/price').on('value', (snapshot) => {
            if (snapshot.exists()) {
                marketPrice = snapshot.val();
                updatePriceDisplay();
            }
        });
    }

    // Listen to Order Book
    function listenToOrderBook() {
        // Listen to buy orders
        db.ref('market/orders/buy')
            .orderByChild('price')
            .limitToLast(10)
            .on('value', (snapshot) => {
                updateOrderBook('bids', snapshot);
            });

        // Listen to sell orders
        db.ref('market/orders/sell')
            .orderByChild('price')
            .limitToFirst(10)
            .on('value', (snapshot) => {
                updateOrderBook('asks', snapshot);
            });
    }

    // Update Order Book Display
    function updateOrderBook(type, snapshot) {
        const container = type === 'bids' 
            ? document.getElementById('bids-side')
            : document.getElementById('asks-side');

        if (!container) return;

        container.innerHTML = '';
        const orders = [];
        let totalAmount = 0;

        snapshot.forEach((child) => {
            const order = child.val();
            if (order.status === 'pending' || order.status === 'partially_filled') {
                orders.push(order);
                totalAmount += order.amount;
            }
        });

        // Sort orders
        if (type === 'bids') {
            orders.sort((a, b) => b.price - a.price); // Highest price first
        } else {
            orders.sort((a, b) => a.price - b.price); // Lowest price first
        }

        // Calculate max amount for depth visualization
        const maxAmount = Math.max(...orders.map(o => o.amount), 1);

        // Display orders
        orders.forEach((order) => {
            const depthPercentage = (order.amount / maxAmount) * 100;
            const row = document.createElement('div');
            row.className = `order-row ${type === 'bids' ? 'bid' : 'ask'}`;
            
            row.innerHTML = `
                <div class="depth-bar" style="width: ${depthPercentage}%"></div>
                <div class="content">
                    <span>${order.amount.toFixed(2)}</span>
                    <span>${order.price.toFixed(4)}</span>
                </div>
            `;
            
            // Add click event to fill order
            row.onclick = () => {
                document.getElementById('order-price').value = order.price;
                document.getElementById('order-amount').value = order.amount;
                updateOrderTotal();
            };
            
            container.appendChild(row);
        });
    }

    // Listen to Recent Trades
    function listenToRecentTrades() {
        db.ref('market/trades')
            .orderByChild('timestamp')
            .limitToLast(20)
            .on('value', (snapshot) => {
                updateRecentTrades(snapshot);
            });
    }

    // Update Recent Trades Display
    function updateRecentTrades(snapshot) {
        const container = document.getElementById('recent-trades-list');
        if (!container) return;

        container.innerHTML = '';
        const trades = [];

        snapshot.forEach((child) => {
            trades.push(child.val());
        });

        // Sort by timestamp (newest first)
        trades.sort((a, b) => b.timestamp - a.timestamp);

        // Display trades
        trades.forEach((trade) => {
            const tradeTime = new Date(trade.timestamp);
            const timeString = tradeTime.toLocaleTimeString('ar-SA', {
                hour: '2-digit',
                minute: '2-digit'
            });

            const item = document.createElement('div');
            item.className = `trade-item ${trade.type === 'buy' ? 'buy' : 'sell'}`;
            
            item.innerHTML = `
                <span>${timeString}</span>
                <span>${trade.price.toFixed(4)}</span>
                <span>${trade.amount.toFixed(2)}</span>
            `;
            
            container.appendChild(item);
        });
    }

    // Listen to Market Stats
    function listenToMarketStats() {
        db.ref('market/stats').on('value', (snapshot) => {
            if (snapshot.exists()) {
                marketStats = snapshot.val();
                updateMarketStats();
            }
        });
    }

    // Update Market Stats Display
    function updateMarketStats() {
        document.getElementById('24h-high').textContent = marketStats.high24h?.toFixed(4) || '0.0000';
        document.getElementById('24h-low').textContent = marketStats.low24h?.toFixed(4) || '0.0000';
        document.getElementById('24h-volume').textContent = `${(marketStats.volume24h || 0).toLocaleString()} SDM`;
    }

    // Update Price Display
    function updatePriceDisplay() {
        const priceElement = document.getElementById('current-price');
        const changeElement = document.getElementById('price-change');
        
        priceElement.textContent = marketPrice.toFixed(4);
        
        // Calculate percentage change
        const change = ((marketPrice - BASE_RATE) / BASE_RATE) * 100;
        const changeText = change >= 0 ? `+${change.toFixed(2)}%` : `${change.toFixed(2)}%`;
        
        changeElement.textContent = changeText;
        changeElement.className = change >= 0 ? 'price-change positive' : 'price-change negative';
    }

    // Initialize Chart
    function initChart() {
        const options = {
            series: [{
                data: []
            }],
            chart: {
                type: 'candlestick',
                height: 280,
                background: 'transparent',
                toolbar: {
                    show: false
                }
            },
            xaxis: {
                type: 'datetime',
                labels: {
                    style: {
                        colors: '#94a3b8'
                    }
                }
            },
            yaxis: {
                tooltip: {
                    enabled: true
                },
                labels: {
                    style: {
                        colors: '#94a3b8'
                    }
                }
            },
            grid: {
                borderColor: '#334155'
            },
            theme: {
                mode: 'dark'
            }
        };

        chartInstance = new ApexCharts(document.querySelector("#chart"), options);
        chartInstance.render();

        // Load chart data
        loadChartData();
    }

    // Load Chart Data
    function loadChartData() {
        db.ref('market/trades')
            .orderByChild('timestamp')
            .limitToLast(100)
            .once('value')
            .then((snapshot) => {
                const candles = processTradesToCandles(snapshot);
                chartInstance.updateSeries([{
                    data: candles
                }]);
            });
    }

    // Process Trades to Candles
    function processTradesToCandles(snapshot) {
        const trades = [];
        snapshot.forEach((child) => {
            trades.push(child.val());
        });

        // Group trades by 15-minute intervals
        const interval = 15 * 60 * 1000; // 15 minutes in milliseconds
        const candles = {};
        
        trades.forEach((trade) => {
            const timestamp = trade.timestamp;
            const intervalStart = Math.floor(timestamp / interval) * interval;
            
            if (!candles[intervalStart]) {
                candles[intervalStart] = {
                    x: intervalStart,
                    y: [trade.price, trade.price, trade.price, trade.price]
                };
            } else {
                const candle = candles[intervalStart];
                candle.y[1] = Math.max(candle.y[1], trade.price); // high
                candle.y[2] = Math.min(candle.y[2], trade.price); // low
                candle.y[3] = trade.price; // close
            }
        });

        return Object.values(candles);
    }

    // Helper Functions
    function showAlert(title, text, icon) {
        Swal.fire({
            title: title,
            text: text,
            icon: icon,
            toast: true,
            position: 'top-end',
            timer: 3000,
            showConfirmButton: false,
            background: '#1e293b',
            color: '#fff'
        });
    }

    function goBack() {
        window.history.back();
    }

    function checkGuestAccess(view) {
        if (me && me.p === 'guest') {
            showAlert('عذراً', 'هذه الميزة تتطلب تسجيل دخول', 'warning');
            return;
        }
        // Navigation logic here
    }

    function highlightTab(el) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }

    function nav(view) {
        // Navigation logic here
    }

    // Initialize the application
    document.addEventListener('DOMContentLoaded', initializeTrading);
</script>
</body>
</html>

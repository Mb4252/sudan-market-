<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SDM Market | Ø¬ÙˆÙ‡Ø±Ø© Ø³ÙˆÙ„Ø§Ù†Ø§ ğŸ‡¸ğŸ‡©</title>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© -->
    <script src="https://www.google.com/recaptcha/api.js?render=6LeiJEAsAAAAMqWM6Uiv12rX0ggAO79H-iCFI4F"></script>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({ appId: "74a3085c-32b9-4c35-bc32-e67c3a2506c3" });
      });
    </script>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³ -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app-check.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --navy: #0d1117; --gold: #ffc107; --blue: #007bff; --bg: #f4f6f9; --green: #28a745; --red: #dc3545; --white: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); padding-bottom: 75px; direction: rtl; user-select: none; }
        .hidden { display: none !important; }
        
        /* Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« */
        header { background: var(--navy); color: white; padding: 10px 15px; display: flex; flex-direction: column; gap: 10px; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid var(--gold); }
        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .search-container { position: relative; width: 100%; }
        .search-container input { width: 100%; padding: 8px 35px 8px 10px; border-radius: 20px; border: none; font-size: 14px; background: rgba(255,255,255,0.15); color: white; margin: 0; outline: none; transition: 0.3s; }
        .search-container input:focus { background: rgba(255,255,255,0.25); }
        .search-container i { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #ddd; }

        /* Ø´Ø±ÙŠØ· ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø·ÙˆØ± */
        #dev-alert-bar { background: linear-gradient(90deg, #c0392b, #e74c3c); color: white; padding: 8px; text-align: center; font-size: 13px; font-weight: bold; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.95; } 50% { opacity: 1; } 100% { opacity: 0.95; } }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ù†Ø²Ù„Ù‚ (Slider) */
        .slider-container { position: relative; width: 100%; height: 180px; overflow: hidden; margin-bottom: 15px; border-radius: 0 0 15px 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #slider-img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.5s; cursor: pointer; }
        .slider-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.5); color: #fff; padding: 5px; text-align: center; font-size: 12px; }
        .edit-slider-btn { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: var(--gold); padding: 6px 12px; border-radius: 20px; cursor: pointer; z-index: 100; font-size: 12px; border: 1px solid var(--gold); display: flex; align-items: center; gap: 5px; }

        .publish-container { background: var(--white); margin: 15px; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #eef; }
        .publish-container h4 { font-size: 22px; color: var(--navy); margin-bottom: 15px; border-right: 4px solid var(--blue); padding-right: 10px; }
        .publish-container input, .publish-container textarea { border: 1.5px solid #eee; transition: 0.3s; font-size: 15px; }
        .publish-container input:focus { border-color: var(--blue); outline: none; box-shadow: 0 0 8px rgba(0,123,255,0.2); }

        .welcome-msg { position: absolute; top: 110px; left: 10px; font-size: 12px; background: rgba(13, 17, 23, 0.8); color: white; padding: 5px 10px; border-radius: 20px; z-index: 999; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px; }
        
        .card { background: white; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; border: 1px solid #eee; transition: 0.3s; position: relative; }
        .card:hover { transform: translateY(-5px); border-color: var(--gold); }
        .edit-cat-btn { position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.7); color: var(--gold); border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; z-index: 10; border: 1px solid var(--gold); }
        .cat-custom-img { width: 50px; height: 50px; object-fit: cover; margin-bottom: 10px; border-radius: 10px; }

        .btn-main { background: var(--blue); color: white; border: none; padding: 14px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; transition: 0.3s; }
        .btn-guest { background: #6c757d; margin-top: 10px; width: 100%; padding: 12px; border:none; color: white; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .btn-google { background: #db4437; color: white; box-shadow: 0 4px 10px rgba(219, 68, 55, 0.3); display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        .bottom-tabs { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; padding: 10px 0; z-index: 1000; }
        .tab-btn { flex: 1; text-align: center; color: #555; cursor: pointer; font-size: 11px; }
        .tab-btn i { font-size: 20px; display: block; margin-bottom: 2px; }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        
        .transfer-input { width: 100%; padding: 15px !important; margin: 10px 0; border: 2px solid #ddd !important; border-radius: 12px !important; font-size: 18px !important; text-align: center; box-sizing: border-box; background: #fdfdfd; }
        .transfer-input:focus { border-color: var(--blue) !important; background: #fff; }

        .post { background: white; margin: 15px; border-radius: 15px; overflow: hidden; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #eee; }
        .post-img-container { position: relative; width: 100%; height: 220px; }
        .sold-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(220, 53, 69, 0.8); color: white; display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: bold; z-index: 5; }
        .price-tag { color: var(--green); font-weight: 800; font-size: 18px; }
        .old-price { text-decoration: line-through; color: var(--red); font-size: 14px; margin-left: 10px; }
        .post-options { position: absolute; top: 12px; left: 12px; color: white; background: rgba(0,0,0,0.6); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; }
        .post-time { font-size: 11px; color: #999; }
        .seller-info { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; border-bottom: 1px solid #f9f9f9; padding-bottom: 8px; cursor: pointer; }
        .btn-whatsapp { background: #25d366; color: white; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; border-radius: 10px; margin-top: 10px; font-weight: bold; width: 100%; box-sizing: border-box; }

        .wallet-card { background: linear-gradient(135deg, #0d1117, #1e3a8a); color: white; padding: 25px; margin: 15px; border-radius: 20px; text-align: center; position: relative; overflow: hidden; }
        .sdm-logo { width: 70px; height: 70px; border-radius: 50%; border: 2px solid var(--gold); margin-bottom: 10px; object-fit: cover; }
        
        .admin-panel { background: #fff; margin: 15px; padding: 15px; border-radius: 15px; border: 2px solid var(--red); }
        .admin-notify-bar { background: #fff3cd; border: 2px solid var(--gold); margin: 15px; padding: 15px; border-radius: 15px; }

        .game-panel { background: #ffffff; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin: 15px; border: 2px solid #2563eb; }
        
        .search-hidden { display: none !important; }
        .badge-good { background-color: #3498db; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 5px; }
        .badge-super { background-color: #f1c40f; color: black; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 5px; font-weight: bold; border: 1px solid #d4ac0d; }
        
        /* Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª */
        .status-badge { padding: 3px 8px; border-radius: 5px; font-size: 11px; font-weight: bold; }
        .st-pending { background: #ffeeba; color: #856404; }
        .st-done { background: #d4edda; color: #155724; }
        .st-rejected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="auth-screen" class="hidden">
    <div style="padding:40px; text-align:center; height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; background: #f0f2f5;">
        <img src="https://i.ibb.co/3ykXvBv/SDM-Coin.jpg" style="width:100px; height:100px; border-radius:50%; margin-bottom:20px; border:3px solid var(--gold);">
        <h2 style="color:var(--navy); margin-bottom:10px;">Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† & SDM ğŸª™</h2>
        <p style="color:#666; margin-bottom:30px;">Ø¨ÙŠØ¹ØŒ Ø§Ø´ØªØ±ÙŠØŒ ÙˆØªØ¯Ø§ÙˆÙ„ Ø¨Ø£Ù…Ø§Ù†</p>
        
        <div id="login-box" style="width:100%; max-width:350px;">
            <button class="btn-main btn-google" onclick="loginWithGoogle()">
                <i class="fab fa-google"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Google
            </button>
            <button class="btn-guest" onclick="enterGuestMode()">Ø²ÙŠØ§Ø±Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙƒØ²Ø§Ø¦Ø± ğŸ‘€</button>
        </div>
        
        <p style="margin-top:20px; font-size:12px; color:#888;">Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù†ÙŠ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</p>
    </div>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
<div id="app-screen" class="hidden">
    <header>
        <div class="header-top">
            <span onclick="goBack()" style="cursor:pointer; font-size:20px;">ğŸ”™</span>
            <b id="head-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</b>
            <div style="display:flex; align-items:center;">
                <div class="online-dot" style="width:10px; height:10px; background:#2ecc71; border-radius:50%; margin-left:5px;"></div>
                <span id="u-stars" style="color:var(--gold)">â­0</span>
            </div>
        </div>
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" id="store-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ØŒ Ù„Ø¹Ø¨Ø©ØŒ Ø®Ø¯Ù…Ø©..." oninput="filterContent(this.value)">
        </div>
    </header>

    <div id="dev-alert-bar"></div>
    <div id="admin-notifications-area"></div>
    <div id="welcome-container"></div>
    
    <div id="content-area"></div>

    <div class="bottom-tabs">
        <div class="tab-btn" onclick="nav('home')"><i class="fas fa-home"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="tab-btn" onclick="checkGuestAccess('wallet')"><i class="fas fa-wallet" style="color:blue"></i>SDM</div>
        <div class="tab-btn" onclick="checkGuestAccess('games')"><i class="fas fa-gamepad" style="color:purple"></i>Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</div>
        <div class="tab-btn" onclick="checkGuestAccess('vip')"><i class="fas fa-gem" style="color:gold"></i>VIP</div>
        <div class="tab-btn" onclick="checkGuestAccess('profile')"><i class="fas fa-user-circle"></i>Ù…Ù„ÙÙŠ</div>
    </div>
</div>

<script>
    const firebaseConfig = { 
        // âš ï¸ Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø®Ø§ØµØ© Ù…Ù† ÙØ§ÙŠØ±Ø¨ÙŠØ³
        apiKey: "AIzaVyDxxxxxxxxxxxxxxxxxxxxxxxx",
        authDomain: "sudan-market-6b122.firebaseapp.com",
        databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com",
        projectId: "sudan-market-6b122",
        storageBucket: "sudan-market-6b122.appspot.com",
        messagingSenderId: "123456789",
        appId: "1:123456789:web:xxxxxx"
    };
    
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    
    if (firebase.appCheck) {
        const appCheck = firebase.appCheck();
        appCheck.activate('6LeiJEAsAAAAMqWM6Uiv12rX0ggAO79H-iCFI4F', true);
    }

    const db = firebase.database();
    const ADMIN_EMAIL = 'mb425262@gmail.com'; // Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯

    const SDM_PRICE = 1000;
    let me = null, hStack = ['home'], curC = '', curS = '', tempImg = '', userPic = 'https://via.placeholder.com/150';
    let isGuest = false; 
    let isAdmin = false;

    let sliderInterval;
    const sdmCoinImage = "https://i.ibb.co/3ykXvBv/SDM-Coin.jpg"; 
    let sliderImages = [sdmCoinImage]; 
    let currentSliderIndex = 0;

    const cats = {
        "Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„Ø§Øª": {i:"mobile-alt", s:["Ø¢ÙŠÙÙˆÙ†","Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬","Ø´Ø§ÙˆÙ…ÙŠ","Ø¨ÙƒØ³Ù„","Ù‡ÙˆØ§ÙˆÙŠ"]},
        "Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª": {i:"car", s:["ØªÙˆÙŠÙˆØªØ§","Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ","BYD","Ø£ÙƒØ³Ù†Øª","Ø±ÙƒØ´Ø§Øª"]},
        "Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª": {i:"home", s:["Ø´Ù‚Ù‚ Ù„Ù„Ø§ÙŠØ¬Ø§Ø±","Ø¨ÙŠÙˆØª Ù„Ù„Ø¨ÙŠØ¹","Ù…Ø²Ø§Ø±Ø¹","Ø§Ø±Ø§Ø¶ÙŠ"]},
        "Ø£Ø¬Ù‡Ø²Ø© Ù…Ù†Ø²Ù„ÙŠØ©": {i:"tv", s:["Ø´Ø§Ø´Ø§Øª","Ø«Ù„Ø§Ø¬Ø§Øª","Ù…ÙƒÙŠÙØ§Øª","ØºØ³Ø§Ù„Ø§Øª"]},
        "Ø§Ù„ØªØ¹Ø¯ÙŠÙ†": {i:"hammer", s:[]}, 
        "Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±": {i:"laptop", s:["Ù„Ø§Ø¨ØªÙˆØ¨Ø§Øª","Ø·Ø§Ø¨Ø¹Ø§Øª","Ø§ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª"]},
        "Ø£Ø«Ø§Ø« Ù…Ù†Ø²Ù„": {i:"chair", s:["ØºØ±Ù Ù†ÙˆÙ…","Ø³Ø±Ø§ÙŠØ±","ÙƒØ±Ø§Ø³ÙŠ","Ø·Ø§ÙˆÙ„Ø§Øª"]},
        "Ù…Ù„Ø§Ø¨Ø³ Ø±Ø¬Ø§Ù„ÙŠØ©": {i:"tshirt", s:["Ù‚Ù…ØµØ§Ù†","Ø¨Ù†Ø§Ø·ÙŠÙ„","Ø§Ø­Ø°ÙŠØ©","Ø¬Ù„Ø§Ø¨ÙŠØ¨"]},
        "Ù…Ù„Ø§Ø¨Ø³ Ù†Ø³Ø§Ø¦ÙŠØ©": {i:"female", s:["ØªÙŠØ§Ø¨","ÙØ³Ø§ØªÙŠÙ†","Ø´Ù†Ø·","Ù…ÙƒÙŠØ§Ø¬"]},
        "Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø£Ø·ÙØ§Ù„": {i:"baby", s:["Ù…Ù„Ø§Ø¨Ø³ Ø§Ø·ÙØ§Ù„","Ø§Ù„Ø¹Ø§Ø¨","Ø¹Ø±Ø¨Ø§Øª Ø§Ø·ÙØ§Ù„"]},
        "Ø§Ù„Ø°Ù‡Ø¨ ÙˆØ§Ù„Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª": {i:"gem", s:["Ø®ÙˆØ§ØªÙ…","Ø³Ù„Ø§Ø³Ù„","Ø§Ø·Ù‚Ù… Ø°Ù‡Ø¨"]},
        "Ø­ÙŠÙˆØ§Ù†Ø§Øª": {i:"paw", s:["Ø§ØºÙ†Ø§Ù…","Ø·ÙŠÙˆØ±","Ù‚Ø·Ø·","Ø®ÙŠÙˆÙ„"]},
        "Ø®Ø¯Ù…Ø§Øª Ù…Ù‡Ù†ÙŠØ©": {i:"tools", s:["ÙƒÙ‡Ø±Ø¨Ø§Ø¡","Ø³Ø¨Ø§ÙƒØ©","Ø­Ø¯Ø§Ø¯Ø©","Ù†Ù‚Ø§Ø´Ø©"]},
        "Ù…Ø·Ø§Ø¹Ù…": {i:"utensils", s:["ÙˆØ¬Ø¨Ø§Øª Ø³Ø±ÙŠØ¹Ø©","Ø­Ù„ÙˆÙŠØ§Øª","Ø¹ØµØ§Ø¦Ø±"]},
        "Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø¬Ù…Ø§Ù„": {i:"heartbeat", s:["Ø¹Ø·ÙˆØ±","ÙƒØ±ÙŠÙ…Ø§Øª","Ù…Ø¹Ø¯Ø§Øª Ø·Ø¨ÙŠØ©"]},
        "ÙƒØªØ¨ ÙˆØ£Ø¯ÙˆØ§Øª": {i:"book", s:["Ø±ÙˆØ§ÙŠØ§Øª","ÙƒØªØ¨ Ø¹Ù„Ù…ÙŠØ©","Ù‚Ø±Ø·Ø§Ø³ÙŠØ©"]},
        "Ø³ÙŠØ§Ø­Ø© ÙˆØ³ÙØ±": {i:"plane", s:["ØªØ°Ø§ÙƒØ± Ø·ÙŠØ±Ø§Ù†","ØªØ£Ø´ÙŠØ±Ø§Øª","ÙÙ†Ø§Ø¯Ù‚"]},
        "Ù…Ù†ÙˆØ¹Ø§Øª": {i:"box-open", s:["Ø§ØºØ±Ø§Ø¶ Ø§Ø®Ø±Ù‰"]}
    };

    const officialRates = {
        pubg: [ { name: "60 UC", sdm: 4 }, { name: "325 UC", sdm: 20 }, { name: "660 UC", sdm: 40 } ],
        ff: [ { name: "100 Ø¬ÙˆÙ‡Ø±Ø©", sdm: 4 }, { name: "530 Ø¬ÙˆÙ‡Ø±Ø©", sdm: 20 }, { name: "1080 Ø¬ÙˆÙ‡Ø±Ø©", sdm: 40 } ]
    };

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
    auth.onAuthStateChanged(user => {
        if (user) {
            const uid = user.uid;
            isAdmin = (user.email === ADMIN_EMAIL);
            
            db.ref('users/' + uid).once('value', snap => {
                if(snap.exists()) {
                    const u = snap.val();
                    if (u.bannedUntil && u.bannedUntil > Date.now()) {
                        Swal.fire('Ù…Ø­Ø¸ÙˆØ±', 'ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¤Ù‚ØªØ§Ù‹.', 'error').then(() => auth.signOut());
                        return;
                    }
                    me = u;
                    startApp(uid);
                } else {
                    const newUser = {
                        n: user.displayName || 'Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯',
                        p: uid,
                        email: user.email,
                        pic: user.photoURL,
                        sdmBalance: 0,
                        rating: 0,
                        vipStatus: 'none',
                        role: isAdmin ? 'admin' : 'user',
                        reportCount: 0,
                        wa: ''
                    };
                    db.ref('users/' + uid).set(newUser).then(() => {
                        me = newUser;
                        startApp(uid);
                    });
                }
            });
        } else {
            if(!isGuest) {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        }
    });

    function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(error => Swal.fire('Ø®Ø·Ø£', error.message, 'error'));
    }

    function doLogout() {
        auth.signOut().then(() => location.reload());
    }

    function enterGuestMode() {
        isGuest = true;
        me = { n: 'Ø²Ø§Ø¦Ø±', p: 'guest', role: 'guest', sdmBalance: 0 };
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        document.getElementById('u-stars').innerText = "Ø²Ø§Ø¦Ø±";
        render('home');
    }

    // --- Ø¶ØºØ· Ø§Ù„ØµÙˆØ± ---
    async function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800; 
                    const scaleSize = MAX_WIDTH / img.width;
                    if (scaleSize >= 1) { resolve(event.target.result); return; }
                    canvas.width = MAX_WIDTH;
                    canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                }
            };
        });
    }

    async function encode(i, t) {
        if(!i.files[0]) return;
        try {
            Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©...', didOpen: () => Swal.showLoading(), allowOutsideClick: false, showConfirmButton: false, timer: 1000 });
            const compressed = await compressImage(i.files[0]);
            if(t==='user') {
                userPic = compressed;
                if(me && !isGuest) {
                     db.ref('users/'+me.p).update({ pic: userPic });
                     document.getElementById('profile-img-view').src = userPic;
                }
            } else if(t==='buy') window.tempBuyImg = compressed;
            else tempImg = compressed;
        } catch(e) { Swal.fire('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©', 'error'); }
    }

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
    function checkGuestAccess(view, extra) {
        if (isGuest) {
            Swal.fire({ title: 'ØªÙ†Ø¨ÙŠÙ‡', text: 'Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ØªØªØ·Ù„Ø¨ Ø­Ø³Ø§Ø¨Ø§Ù‹ Ù…Ø³Ø¬Ù„Ø§Ù‹.', icon: 'info', showCancelButton: true, confirmButtonText: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡' }).then((res) => { if(res.isConfirmed) location.reload(); });
            return;
        }
        nav(view, extra);
    }

    function startApp(uid) {
        isGuest = false;
        hStack = ['home'];
        
        db.ref('users/' + uid).on('value', snap => {
            const val = snap.val();
            if (!val) return; 
            if (val.bannedUntil && val.bannedUntil > Date.now()) {
                Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ø¸ÙˆØ± Ø­Ø§Ù„ÙŠØ§Ù‹', 'error').then(() => doLogout());
                return;
            }
            me = val;
            me.p = uid;
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            
            if (!me.wa) promptWhatsApp();
            checkVipExpiry();
            listenForUserAlerts();
            listenForDevAlerts();
            
            // ØªÙØ¹ÙŠÙ„ Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø·ÙˆØ± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ Ø§Ù„Ø£Ø¯Ù…Ù†
            if(isAdmin) {
                initDeveloperLogic(); // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø®ØµÙ… ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª
                listenForReportNotifications();
                cleanOldData(); 
            }
            render('home');
        });
        db.ref('users/' + uid).update({ lastSeen: Date.now() });
    }

    async function promptWhatsApp() {
        const { value: wa } = await Swal.fire({ title: 'Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ', text: 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨', input: 'tel', allowOutsideClick: false });
        if (wa) db.ref('users/'+me.p).update({ wa: wa });
    }

    function cleanOldData() {
        const daysAgo = Date.now() - (3 * 24 * 60 * 60 * 1000); 
        db.ref('transactions').orderByChild('date').endAt(daysAgo).once('value', s => s.forEach(c => c.ref.remove()));
        db.ref('game_orders').orderByChild('date').endAt(daysAgo).once('value', s => s.forEach(c => c.ref.remove()));
        db.ref('posts').orderByChild('date').endAt(Date.now() - 86400000).once('value', s => s.forEach(c => c.ref.remove()));
    }

    function listenForDevAlerts() {
        const bar = document.getElementById('dev-alert-bar');
        db.ref('settings/globalAlert').on('value', snap => {
            if(snap.val()) {
                bar.style.display = 'block';
                bar.innerHTML = `ğŸ“¢ ${snap.val()} ${isAdmin ? '<i class="fas fa-edit" onclick="editDevAlert()"></i>' : ''}`;
            } else { bar.style.display = 'none'; }
        });
    }

    function editDevAlert() {
        Swal.fire({ title: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡', input: 'text', showCancelButton: true }).then(res => {
            if(res.isConfirmed) db.ref('settings/globalAlert').set(res.value);
        });
    }

    // --- Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø·ÙˆØ± (Ø§Ù„Ø£Ø¯Ù…Ù†) ÙÙ‚Ø· ---
    // Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙŠØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯: Ø§Ù„Ø£Ø¯Ù…Ù† Ù‡Ùˆ Ø§Ù„ÙˆØ­ÙŠØ¯ Ø§Ù„Ø°ÙŠ ÙŠÙƒØªØ¨ ÙÙŠ Ø§Ù„Ø£Ø±ØµØ¯Ø© ÙˆØ§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª
    function initDeveloperLogic() {
        if (!isAdmin) return;

        // 1. Ù…Ø±Ø§Ù‚Ø¨Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ­ÙˆÙŠÙ„ (Pending Transfers)
        db.ref('transfers').orderByChild('status').equalTo('pending').on('value', snap => {
            snap.forEach(async child => {
                const tx = child.val();
                const key = child.key;
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø±Ø³Ù„
                const senderSnap = await db.ref('users/' + tx.from).once('value');
                const receiverSnap = await db.ref('users/' + tx.to).once('value');
                
                if (senderSnap.exists() && receiverSnap.exists()) {
                    const senderData = senderSnap.val();
                    const receiverData = receiverSnap.val();
                    const currentBal = senderData.sdmBalance || 0;

                    if (currentBal >= tx.amount) {
                        // ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­ÙˆÙŠÙ„ (Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø· ÙŠÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒØªØ§Ø¨Ø© Ù‡Ù†Ø§)
                        await db.ref('users/' + tx.from).update({ sdmBalance: currentBal - tx.amount });
                        await db.ref('users/' + tx.to).update({ sdmBalance: (receiverData.sdmBalance || 0) + tx.amount });
                        
                        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
                        await db.ref('transfers/' + key).update({ status: 'success' });

                        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ (Ø§Ù„Ø£Ø¯Ù…Ù† ÙÙ‚Ø·)
                        const opId = "SDM-" + Math.random().toString(36).substr(2, 9).toUpperCase();
                        await db.ref('transactions').push({
                            opId: opId,
                            amount: tx.amount,
                            sender: tx.from, senderName: senderData.n,
                            receiver: tx.to, receiverName: receiverData.n,
                            date: Date.now(),
                            involves: [tx.from, tx.to],
                            type: 'transfer'
                        });

                        // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªÙ„Ù…
                        await db.ref('alerts/' + tx.to).push({
                            isReceipt: true, opId: opId, senderName: senderData.n, receiverName: receiverData.n, amount: tx.amount, time: new Date().toLocaleString(), type: 'success'
                        });
                    } else {
                        // Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§ÙÙ
                        await db.ref('transfers/' + key).update({ status: 'failed_insufficient_funds' });
                        await db.ref('alerts/' + tx.from).push({ msg: "ÙØ´Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„: Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ", type: "error" });
                    }
                } else {
                    await db.ref('transfers/' + key).update({ status: 'failed_user_not_found' });
                }
            });
        });

        // 2. Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† ÙˆØ§Ù„Ø¹Ù…Ù„Ø§Øª (Coin Requests & Game Orders)
        db.ref('coin_requests').orderByChild('status').equalTo('pending').on('value', snap => {
            const area = document.getElementById('admin-notifications-area');
            if(hStack[hStack.length-1] !== 'home') { area.innerHTML = ""; return; }
            area.innerHTML = "";
            snap.forEach(child => {
                const req = child.val();
                area.innerHTML += `
                    <div class="admin-notify-bar">
                        <p><b>ğŸ”” Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø¹Ù…Ù„Ø©</b></p>
                        <p>${req.uN} | Ø§Ù„ÙƒÙ…ÙŠØ©: ${req.qty} SDM</p>
                        <img src="${req.img}" style="width:100%; border-radius:10px; cursor:pointer" onclick="Swal.fire({imageUrl:'${req.img}'})">
                        <div style="display:flex; gap:10px; margin-top:5px;">
                            <button class="btn-main" style="background:green; margin:0;" onclick="approvePurchase('${child.key}', '${req.uP}', ${req.qty})">Ù…ÙˆØ§ÙÙ‚</button>
                            <button class="btn-main" style="background:red; margin:0;" onclick="rejectRequest('coin_requests', '${child.key}', '${req.uP}')">Ø±ÙØ¶</button>
                        </div>
                    </div>`;
            });
        });
        
        // Ø¹Ø±Ø¶ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨
        if(document.getElementById('orders-list-container')) {
             db.ref('game_orders').orderByChild('status').equalTo('pending').on('value', snap => {
                const container = document.getElementById('orders-list-container');
                container.innerHTML = "";
                snap.forEach(child => {
                    const o = child.val();
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø·ÙˆØ± ÙŠØ±Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
                    const actionBtn = (o.gameType === 'VIP') 
                        ? `<button class="btn-main" style="background:#6f42c1" onclick="approveVIP('${child.key}', '${o.uP}', ${o.cost})">ØªÙØ¹ÙŠÙ„ VIP</button>`
                        : `<button class="btn-main" style="background:green" onclick="processGameOrder('${child.key}', '${o.uP}', ${o.cost})">Ø®ØµÙ… ÙˆØ´Ø­Ù† âœ…</button>`;

                    container.innerHTML += `
                        <div class="admin-notify-bar" style="border-color:blue;">
                            <b>Ø§Ù„Ø¹Ù…ÙŠÙ„:</b> ${o.uN}<br>
                            <b>Ø§Ù„Ù†ÙˆØ¹:</b> ${o.gameType} | <b>Ø§Ù„Ø¨Ø§Ù‚Ø©:</b> ${o.package}<br>
                            <b>ID:</b> ${o.playerId || 'N/A'}<br>
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                ${actionBtn}
                                <button class="btn-main" style="background:red" onclick="rejectRequest('game_orders', '${child.key}', '${o.uP}')">Ø±ÙØ¶ âŒ</button>
                            </div>
                        </div>`;
                });
            });
        }
    }

    async function approvePurchase(id, up, qty) {
        const uSnap = await db.ref('users/'+up).once('value');
        const bal = uSnap.val().sdmBalance || 0;
        await db.ref('users/'+up).update({ sdmBalance: bal + Number(qty) });
        await db.ref('coin_requests/'+id).update({ status: 'approved', date: Date.now() });
        
        const opId = "BUY-" + Math.random().toString(36).substr(2, 6).toUpperCase();
        await db.ref('transactions').push({
            opId: opId, amount: qty, sender: 'admin', senderName: 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', receiver: up, receiverName: uSnap.val().n,
            date: Date.now(), involves: [up, me.p], type: 'purchase'
        });
        await db.ref('alerts/'+up).push({ msg: `âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ${qty} SDM Ù„Ø­Ø³Ø§Ø¨Ùƒ`, type: 'success' });
        Swal.fire('ØªÙ…','ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯','success');
    }

    // Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø·ÙˆØ± Ù„Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØªÙ†ÙÙŠØ° Ø·Ù„Ø¨ Ø§Ù„Ù„Ø¹Ø¨Ø©
    async function processGameOrder(key, uid, cost) {
        const uSnap = await db.ref('users/'+uid).once('value');
        const currentBal = uSnap.val().sdmBalance || 0;

        if (currentBal >= cost) {
            // Ø§Ù„Ø®ØµÙ… Ø§Ù„Ø¢Ù† ÙŠØªÙ… Ø¹Ù†Ø¯ Ù…ÙˆØ§ÙÙ‚Ø© Ø§Ù„Ù…Ø·ÙˆØ±
            await db.ref('users/' + uid).update({ sdmBalance: currentBal - cost });
            await db.ref('game_orders/' + key).update({ status: 'done' });
            
            // ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ø§Ù…Ù„Ø©
            await db.ref('transactions').push({
                opId: "GAME-" + Math.random().toString(36).substr(2,6).toUpperCase(),
                amount: cost, sender: uid, senderName: uSnap.val().n, receiver: 'SYSTEM', receiverName: 'Game Service',
                date: Date.now(), involves: [uid], type: 'service'
            });

            db.ref('alerts/' + uid).push({ msg: "âœ… ØªÙ… Ø´Ø­Ù† Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!", type: "success" });
            Swal.fire("Ù†Ø¬Ø§Ø­", "ØªÙ… Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯ ÙˆØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù†", "success");
        } else {
            Swal.fire("Ø®Ø·Ø£", "Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ÙƒØ§ÙÙ Ù„Ù„Ø®ØµÙ…", "error");
        }
    }

    async function approveVIP(key, uid, cost) {
        const uSnap = await db.ref('users/'+uid).once('value');
        const currentBal = uSnap.val().sdmBalance || 0;
        
        if (currentBal >= cost) {
            const days = cost === 1 ? 1 : 7;
            const exp = Date.now() + (days * 86400000);
            
            await db.ref('users/' + uid).update({ sdmBalance: currentBal - cost, vipStatus: 'active', vipExpiry: exp });
            await db.ref('game_orders/' + key).update({ status: 'done' });
            
            db.ref('alerts/' + uid).push({ msg: "ğŸ’ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§Ùƒ VIP Ø¨Ù†Ø¬Ø§Ø­!", type: "success" });
            Swal.fire("Ù†Ø¬Ø§Ø­", "ØªÙ… ØªÙØ¹ÙŠÙ„ VIP Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…", "success");
        } else {
            Swal.fire("Ø®Ø·Ø£", "Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ÙƒØ§ÙÙ", "error");
        }
    }

    async function rejectRequest(node, key, uid) {
        await db.ref(node + '/' + key).update({ status: 'rejected' });
        db.ref('alerts/' + uid).push({ msg: "âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©", type: "error" });
        Swal.fire("ØªÙ… Ø§Ù„Ø±ÙØ¶", "ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ Ù…Ø±ÙÙˆØ¶", "info");
    }
    
    // --- Ù†Ù‡Ø§ÙŠØ© Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø·ÙˆØ± ---

    function listenForUserAlerts() {
        if(isGuest) return;
        db.ref('alerts/'+me.p).on('child_added', snap => {
            const data = snap.val();
            if(data.isReceipt) showReceiptModal(data);
            else Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', data.msg, data.type);
            snap.ref.remove();
        });
    }

    function showReceiptModal(data) {
        Swal.fire({
            html: `
            <div style="text-align:right">
                <h3 style="margin:0; color:var(--blue); text-align:center">Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† | SDM</h3>
                <p><b>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</b> ${data.opId}</p>
                <p><b>Ø§Ù„Ù…Ø±Ø³Ù„:</b> ${data.senderName}</p>
                <p><b>Ø§Ù„Ù…Ø³ØªÙ„Ù…:</b> ${data.receiverName}</p>
                <p><b>Ø§Ù„Ù…Ø¨Ù„Øº:</b> <span style="color:var(--green)">${data.amount} SDM</span></p>
                <p style="font-size:12px; color:#999; text-align:center">${data.time}</p>
            </div>`,
            confirmButtonText: 'Ø¥ØºÙ„Ø§Ù‚'
        });
    }

    function nav(v, e) { hStack.push(v); render(v, e); }
    function goBack() { if(hStack.length > 1) { hStack.pop(); render(hStack[hStack.length-1]); } }

    function render(view, extra) {
        const area = document.getElementById('content-area');
        const adminArea = document.getElementById('admin-notifications-area');
        if (sliderInterval) clearInterval(sliderInterval);
        if(view !== 'home') adminArea.innerHTML = "";

        showWelcome();
        if(me) document.getElementById('u-stars').innerText = isGuest ? "Ø²Ø§Ø¦Ø±" : `â­${(me.rating||0).toFixed(1)}`;

        if(view === 'home') {
            db.ref('settings').on('value', snap => {
                const settings = snap.val() || {};
                sliderImages = settings.sliderImages || [sdmCoinImage];
                const catImgs = settings.categories || {};
                
                area.innerHTML = `
                    <div class="slider-container">
                        <img id="slider-img" src="${sliderImages[0]}">
                        <div class="slider-overlay">Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† Ø§Ù„Ø±Ù‚Ù…ÙŠ</div>
                        ${isAdmin ? `<div class="edit-slider-btn" onclick="updateSliderImgs()">âœï¸</div>` : ''}
                    </div>
                    <div id="vip-slider"></div>
                    <div class="grid">
                        ${Object.keys(cats).map(k=> {
                            const cImg = catImgs[k] ? `<img src="${catImgs[k].img}" class="cat-custom-img">` : `<i class="fas fa-${cats[k].i}" style="font-size:24px; color:var(--blue); margin-bottom:10px;"></i>`;
                            const edit = isAdmin ? `<div class="edit-cat-btn" onclick="event.stopPropagation(); updateCategoryImg('${k}')"><i class="fas fa-edit"></i></div>` : '';
                            return `<div class="card" onclick="nav('sub','${k}')">${edit}${cImg}<br><b>${k}</b></div>`;
                        }).join('')}
                    </div>`;
                startSlider();
            });
            loadVipHome();
        } else if(view === 'sub') {
            curC = extra || curC;
            area.innerHTML = `<div class="grid">${cats[curC].s.map(s=>`<div class="card" onclick="nav('feed','${s}')"><b>${s}</b></div>`).join('')}</div>`;
        } else if(view === 'feed') {
            curS = extra || curS;
            let pub = !isGuest ? `
            <div class="publish-container">
                <h4>ğŸ“ Ø¨ÙŠØ¹ ÙÙŠ ${curS}</h4>
                <input id="pt" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù†ØªØ¬">
                <input id="pp" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± (SDM)">
                <input id="p-whatsapp" type="tel" placeholder="ÙˆØ§ØªØ³Ø§Ø¨ (0xxxxxxxxx)" value="${me.wa || ''}">
                <textarea id="pd" placeholder="Ø§Ù„ÙˆØµÙ..."></textarea>
                <input type="file" onchange="encode(this, 'post')">
                <button class="btn-main" onclick="publish('posts')">Ù†Ø´Ø±</button>
            </div>` : '';
            area.innerHTML = `${pub}<div id="posts-list"></div>`;
            loadPosts('posts', curS);
        } else if(view === 'wallet') renderWallet(area);
        else if(view === 'vip') renderVip(area);
        else if(view === 'profile') renderProfile(area, extra || me.p);
        else if(view === 'games') renderGames(area);
    }

    function startSlider() {
        const imgEl = document.getElementById('slider-img');
        if(!imgEl) return;
        currentSliderIndex = 0;
        sliderInterval = setInterval(() => {
            currentSliderIndex = (currentSliderIndex + 1) % sliderImages.length;
            imgEl.style.opacity = 0;
            setTimeout(() => { imgEl.src = sliderImages[currentSliderIndex]; imgEl.style.opacity = 1; }, 300);
        }, 3000);
    }

    async function updateSliderImgs() {
        Swal.fire({ title: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±', html: '<input type="file" id="sf" multiple>', preConfirm: () => {
            const files = document.getElementById('sf').files;
            return Promise.all(Array.from(files).map(f => compressImage(f)));
        }}).then(res => { if(res.value) db.ref('settings/sliderImages').set(res.value); });
    }

    async function updateCategoryImg(cat) {
        Swal.fire({ title: `ØµÙˆØ±Ø© ${cat}`, html: '<input type="file" id="ci">', preConfirm: () => compressImage(document.getElementById('ci').files[0]) })
        .then(res => { if(res.value) db.ref(`settings/categories/${cat}`).set({ img: res.value }); });
    }

    function renderGames(area) {
        area.innerHTML = `
            <div class="game-panel">
                <h2>ğŸ® Ø´Ø­Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</h2>
                <select id="active-game" onchange="loadCorrectPacks()">
                    <option value="pubg">Ø¨Ø¨Ø¬ÙŠ (UC)</option>
                    <option value="ff">ÙØ±ÙŠ ÙØ§ÙŠØ± (Gems)</option>
                </select>
                <input type="text" id="p-id-input" placeholder="ID Ø§Ù„Ù„Ø§Ø¹Ø¨">
                <select id="p-pack-input"></select>
                <button class="btn-main" onclick="sendOrderRequest()">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†</button>
            </div>
            <div style="background:white; margin:15px; padding:10px; border-radius:10px;">
                <h4>Ø³Ø¬Ù„ÙŠ</h4>
                <div id="game-history"></div>
            </div>
            ${isAdmin ? `<div class="admin-panel"><h3>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù†</h3><div id="orders-list-container"></div></div>` : ''}
        `;
        loadCorrectPacks();
        loadGameHistory();
        if(isAdmin) initDeveloperLogic();
    }

    function loadCorrectPacks() {
        const g = document.getElementById('active-game').value;
        const p = document.getElementById('p-pack-input');
        p.innerHTML = "";
        officialRates[g].forEach(r => p.innerHTML += `<option value="${r.sdm}">${r.name} (${r.sdm} SDM)</option>`);
    }

    function sendOrderRequest() {
        const pid = document.getElementById('p-id-input').value;
        const packEl = document.getElementById('p-pack-input');
        const cost = parseInt(packEl.value);
        const pName = packEl.options[packEl.selectedIndex].text;
        
        if(!pid) return Swal.fire("Ø®Ø·Ø£", "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¢ÙŠØ¯ÙŠ", "error");
        // Ù„Ø§ Ù†Ø®ØµÙ… Ø§Ù„Ø±ØµÙŠØ¯ Ù‡Ù†Ø§ØŒ Ø¨Ù„ Ù†Ø±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙÙ‚Ø·
        db.ref('game_orders').push({
            uP: me.p, uN: me.n, gameType: document.getElementById('active-game').value,
            playerId: pid, package: pName, cost: cost, status: 'pending', date: Date.now()
        });
        Swal.fire("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„", "Ø·Ù„Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ø®ØµÙ… Ø¹Ù†Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©", "success");
    }

    function loadGameHistory() {
        db.ref('game_orders').orderByChild('uP').equalTo(me.p).limitToLast(10).on('value', snap => {
            const div = document.getElementById('game-history');
            if(!div) return;
            div.innerHTML = "";
            snap.forEach(c => {
                const o = c.val();
                div.innerHTML += `<div style="border-bottom:1px solid #eee; padding:5px; font-size:12px;">${o.package} | <span class="status-badge st-${o.status}">${o.status}</span></div>`;
            });
        });
    }

    function renderWallet(area) {
        db.ref('settings/coinImg').on('value', snap => {
            area.innerHTML = `
                <div class="wallet-card">
                    <img src="${snap.val() || sdmCoinImage}" class="sdm-logo">
                    ${isAdmin ? '<br><input type="file" onchange="updateCoinImg(this)" style="font-size:10px;">' : ''}
                    <h1>${me.sdmBalance} SDM</h1>
                    <button class="btn-main" style="background:var(--green); border:2px solid #fff;" onclick="showTransfer()">ğŸ’¸ ØªØ­ÙˆÙŠÙ„</button>
                </div>
                <div style="background:white; padding:15px; margin:15px; border-radius:15px;">
                    <h4>Ø§Ù„Ø³Ø¬Ù„</h4>
                    <div id="trans-list"></div>
                </div>
                ${isAdmin ? `<div class="admin-panel" id="admin-reqs"></div>` : ''}
                <div style="background:white; padding:15px; margin:15px; border-radius:15px;">
                    <h3>Ø´Ø±Ø§Ø¡ SDM</h3>
                    <p>Ø¨Ù†Ùƒ Ø§Ù„Ø®Ø±Ø·ÙˆÙ…: 4426148 (Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¹Ø·ÙŠ)</p>
                    <input id="buy-qty" type="number" placeholder="Ø§Ù„Ø¹Ø¯Ø¯">
                    <input type="file" id="buy-img" onchange="encode(this, 'buy')">
                    <button class="btn-main" onclick="requestCoins()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</button>
                </div>`;
            if(isAdmin) loadAdminRequests();
            loadTransactions();
        });
    }

    function loadTransactions() {
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ Ù„Ø§ ÙŠÙ…ÙƒÙ†Ù‡ Ù‚Ø±Ø§Ø¡Ø© ÙƒÙ„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§ØªØŒ ÙÙ‚Ø· Ù…Ø¹Ø§Ù…Ù„Ø§ØªÙ‡ (Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯)
        db.ref('transactions').limitToLast(50).on('value', snap => {
            const list = document.getElementById('trans-list');
            if(!list) return;
            list.innerHTML = "";
            let arr = [];
            snap.forEach(c => { if(c.val().involves.includes(me.p)) arr.unshift(c.val()); });
            if(!arr.length) list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª</p>";
            arr.forEach(t => {
                const isSent = t.sender === me.p;
                list.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee;">${t.type==='purchase'?'ğŸ“¥ Ø´Ø­Ù†':(isSent?'ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„':'ğŸ“¥ Ø§Ø³ØªÙ„Ø§Ù…')} ${t.amount} SDM <br><small>${new Date(t.date).toLocaleDateString()}</small></div>`;
            });
        });
    }

    function showTransfer() {
        Swal.fire({
            title: 'ØªØ­ÙˆÙŠÙ„ Ø±ØµÙŠØ¯',
            html: `<input id="tr-p" class="swal2-input" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙ„Ù… (UID)"><input id="tr-a" type="number" class="swal2-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">`,
            confirmButtonText: 'Ø¥Ø±Ø³Ø§Ù„',
            preConfirm: () => {
                const p = document.getElementById('tr-p').value, a = document.getElementById('tr-a').value;
                if(!p || !a) Swal.showValidationMessage('Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©');
                return { p, a };
            }
        }).then(res => {
            if(res.isConfirmed) {
                // Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ø§Ø´Ø±ØŒ Ù†Ù†Ø´Ø¦ Ø·Ù„Ø¨ ØªØ­ÙˆÙŠÙ„
                db.ref('transfers').push({
                    from: me.p, to: res.value.p, amount: Number(res.value.a), status: 'pending', date: Date.now()
                });
                Swal.fire('ØªÙ…', 'Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„...', 'success');
            }
        });
    }

    function updateCoinImg(input) {
        encode({files:[input.files[0]]}, 'coin').then(() => db.ref('settings/coinImg').set(tempImg));
    }

    function requestCoins() {
        const qty = document.getElementById('buy-qty').value;
        if(!qty || !window.tempBuyImg) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','ØµÙˆØ±Ø© ÙˆØ¥Ø´Ø¹Ø§Ø± Ù…Ø·Ù„ÙˆØ¨','warning');
        db.ref('coin_requests').push({ uP: me.p, uN: me.n, qty, img: window.tempBuyImg, status: 'pending', date: Date.now() });
        Swal.fire('ØªÙ…','Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©','success');
    }

    function loadAdminRequests() {
        // ØªÙ… Ø¯Ù…Ø¬Ù‡Ø§ ÙÙŠ initDeveloperLogic
    }

    // --- VIP & Posts ---
    function renderVip(area) {
        if(me.vipStatus === 'active') {
            area.innerHTML = `<div class="publish-container"><h4>ğŸ’ Ù†Ø´Ø± VIP</h4><input id="v-t" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"><input id="v-pr" placeholder="Ø§Ù„Ø³Ø¹Ø±"><textarea id="v-d"></textarea><input type="file" onchange="encode(this,'post')"><button class="btn-main" onclick="publish('vip_posts')">Ù†Ø´Ø±</button></div>`;
        } else {
            area.innerHTML = `<div style="text-align:center; padding:20px;"><h3>Ø§Ø´ØªØ±Ø§Ùƒ VIP</h3><div class="card" onclick="reqVip(1,1)">ÙŠÙˆÙ… (1 SDM)</div><div class="card" onclick="reqVip(7,7)">Ø£Ø³Ø¨ÙˆØ¹ (7 SDM)</div></div>`;
        }
    }

    function reqVip(d, c) {
        // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ø«Ù„ Game Order
        db.ref('game_orders').push({
            uP: me.p, uN: me.n, gameType: 'VIP', package: `${d} ÙŠÙˆÙ…`, cost: c, status: 'pending', date: Date.now()
        });
        Swal.fire('ØªÙ…','Ø·Ù„Ø¨ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©','success');
    }
    
    async function checkVipExpiry() {
        if(me.vipStatus === 'active' && Date.now() > me.vipExpiry) {
            // Ù‡Ù†Ø§ Ù„Ø§ ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙŠ vipStatus Ø¨Ø­Ø³Ø¨ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯
            // Ù„Ø°Ø§ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø£Ù† Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø³ÙŠØ®ÙÙŠ Ø§Ù„Ù…ÙŠØ²Ø§ØªØŒ ÙˆÙ„ÙƒÙ† ÙŠØ¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ù…Ù† ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
            // Ø£Ùˆ Ù†Ø±Ø³Ù„ Ø·Ù„Ø¨ "Ø§Ù†ØªÙ‡Ø§Ø¡" Ù„ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ù…Ø¹Ø§Ù„Ø¬ØªÙ‡
            console.log("VIP Expired locally");
        }
    }

    function publish(path) {
        if(isGuest) return checkGuestAccess('publish');
        const t = document.getElementById(path==='vip_posts'?'v-t':'pt').value;
        const pr = document.getElementById(path==='vip_posts'?'v-pr':'pp').value;
        const d = document.getElementById(path==='vip_posts'?'v-d':'pd').value;
        if(!t || !pr || !tempImg) return Swal.fire('Ù†Ø§Ù‚Øµ','Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','warning');
        
        const data = { t, pr, d, img: tempImg, uP: me.p, uN: me.n, uPic: me.pic, date: Date.now(), status: 'active', wa: me.wa };
        if(path !== 'vip_posts') data.sub = curS;
        
        db.ref(path).push(data);
        Swal.fire('ØªÙ…','','success');
        tempImg = '';
        path==='vip_posts' ? nav('home') : render('feed', curS);
    }

    function loadPosts(path, sub) {
        db.ref(path).on('value', snap => {
            const list = document.getElementById(path==='posts'?'posts-list':'vip-slider-inner');
            if(!list) return;
            list.innerHTML = "";
            snap.forEach(c => {
                const p = c.val();
                if(sub && p.sub !== sub) return;
                const isMine = (me && p.uP === me.p);
                list.innerHTML += `<div class="post"><img src="${p.img}" style="width:100%; height:200px; object-fit:cover"><div style="padding:10px"><h3>${p.t}</h3><div class="price-tag">${p.pr} SDM</div><a href="https://wa.me/${p.wa}" class="btn-whatsapp">ÙˆØ§ØªØ³Ø§Ø¨</a></div></div>`;
            });
        });
    }

    function loadVipHome() {
        const d = document.getElementById('vip-slider');
        if(d) d.innerHTML = `<h4 style="margin:10px">ğŸ’ Ø¹Ø±ÙˆØ¶ VIP</h4><div id="vip-slider-inner" style="display:flex; overflow-x:auto; gap:10px; padding:10px;"></div>`;
        loadPosts('vip_posts', null);
    }

    function renderProfile(area, uid) {
        db.ref('users/'+uid).once('value', s => {
            const u = s.val();
            area.innerHTML = `<div style="text-align:center; padding:30px;"><img src="${u.pic}" style="width:100px; height:100px; border-radius:50%"><h2>${u.n}</h2><p>ID: ${u.p}</p></div>`;
        });
    }

    function showWelcome() {
        const c = document.getElementById('welcome-container');
        if(hStack[hStack.length-1]==='home' && me && !isGuest) c.innerHTML = `<div class="welcome-msg">Ù…Ø±Ø­Ø¨Ø§Ù‹ ${me.n}</div>`;
        else c.innerHTML = "";
    }
    
    function filterContent(q) {
        document.querySelectorAll('.post, .card').forEach(el => {
            el.classList.toggle('search-hidden', !el.innerText.toLowerCase().includes(q.toLowerCase()));
        });
    }

    function listenForReportNotifications() {
        // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¨Ù„ÙŠØºØ§Øª (Ø§Ù„Ø£Ø¯Ù…Ù†)
        db.ref('users').orderByChild('reportCount').startAt(20).on('value', snap => {
            const area = document.getElementById('admin-notifications-area');
            snap.forEach(c => {
                 if(!c.val().adminHandled) area.innerHTML += `<div class="admin-notify-bar" style="background:#ffd2d2">ğŸš¨ Ø¨Ù„Ø§ØºØ§Øª ÙƒØ«ÙŠØ±Ø©: ${c.val().n}</div>`;
            });
        });
    }

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SDM Market Pro | Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    
    <!-- Ø®Ø·ÙˆØ· Ø¹Ø±Ø¨ÙŠØ© -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --primary: #3b82f6;
            --accent: #f59e0b;
            --neon-blue: #00f3ff;
            --text-main: #f8fafc;
            --text-sec: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
            --red: #ef4444; 
            --green: #10b981; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline:none; }
        
        body {
            font-family: 'Tajawal', sans-serif; 
            margin: 0;
            background: var(--bg-dark); 
            color: var(--text-main);
            padding-bottom: 90px;
            min-height: 100vh;
            user-select: none;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }

        .hidden { display: none !important; }
        .search-hidden { display: none !important; }

        /* Header */
        header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            padding: 15px 20px;
            position: sticky; top: 0; z-index: 1000;
            border-bottom: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 10px;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        
        .search-container { position: relative; width: 100%; }
        .search-container input {
            width: 100%; padding: 12px 45px 12px 15px;
            border-radius: 15px; border: 1px solid var(--border);
            font-size: 14px; background: rgba(255,255,255,0.05); color: white;
            transition: 0.3s; font-family: 'Tajawal';
        }
        .search-container i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--accent); }

        /* Wallet & Trading */
        .wallet-overview {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 1px solid var(--border); padding: 25px; border-radius: 20px;
            text-align: center; margin-bottom: 20px; position: relative; overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .ticker-bar {
            display: grid; grid-template-columns: repeat(3, 1fr);
            background: rgba(0,0,0,0.3); padding: 10px;
            border-bottom: 1px solid var(--border); margin-bottom: 10px; border-radius: 10px;
        }
        .ticker-item { text-align: center; border-left: 1px solid var(--border); }
        .ticker-item:last-child { border-left: none; }
        .t-lbl { font-size: 10px; color: var(--text-sec); display: block; }
        .t-val { font-size: 13px; font-weight: bold; }

        .chart-box {
            height: 300px; background: rgba(0,0,0,0.2);
            border-radius: 15px; margin-bottom: 10px; border: 1px solid var(--border); overflow: hidden;
        }

        .order-book-container {
            display: flex; gap: 5px; margin: 10px 0;
            background: rgba(0,0,0,0.3); padding: 5px; border-radius: 10px;
            height: 280px; font-size: 11px;
        }
        .ob-side { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .ob-header { text-align: center; color: var(--text-sec); border-bottom: 1px solid var(--border); margin-bottom: 5px; font-weight: bold; }
        .ob-list { overflow-y: auto; flex: 1; }
        .ob-row { display: flex; justify-content: space-between; padding: 4px 6px; position: relative; cursor: pointer; margin-bottom: 2px; }
        .ob-row:hover { background: rgba(255,255,255,0.05); }

        .trade-controls {
            background: var(--bg-card); padding: 15px;
            border-radius: 15px; border: 1px solid var(--border); margin-top: 10px;
        }
        .trade-tabs { display: flex; background: rgba(0,0,0,0.3); border-radius: 10px; padding: 3px; margin-bottom: 15px; }
        .t-btn { flex: 1; text-align: center; padding: 10px; border-radius: 8px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        .t-btn.buy.active { background: var(--green); color: black; }
        .t-btn.sell.active { background: var(--red); color: white; }
        
        .inp-field { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 8px; color: white; font-family: 'Tajawal'; margin-bottom: 10px; }
        
        /* Percentage buttons */
        .pct-bar { display: flex; gap: 5px; margin-bottom: 15px; }
        .pct-btn { flex: 1; background: rgba(255,255,255,0.1); padding: 5px; text-align: center; border-radius: 5px; font-size: 10px; cursor: pointer; border: 1px solid var(--border); }

        /* General UI Elements */
        .btn-main { background: linear-gradient(90deg, var(--primary), #2563eb); color: white; border: none; padding: 15px; width: 100%; border-radius: 12px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); transition: 0.2s; margin-bottom: 5px; }
        .btn-guest { background: transparent; border: 1px solid var(--text-sec); color: var(--text-sec); width: 100%; padding: 12px; border-radius: 10px; margin-top: 10px; cursor: pointer; }
        
        .slider-container { margin: 20px; height: 180px; border-radius: 20px; overflow: hidden; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid var(--border); }
        #slider-img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.5s; }
        .edit-slider-btn { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 15px; cursor: pointer; z-index: 20; font-size: 10px; color: var(--accent); border: 1px solid var(--accent); }

        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; }
        .card { background: var(--bg-card); border-radius: 18px; padding: 20px; text-align: center; border: 1px solid var(--border); transition: 0.3s; position: relative; }
        .card:hover { border-color: var(--neon-blue); transform: translateY(-5px); }
        .card i { font-size: 28px; margin-bottom: 10px; background: linear-gradient(45deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .edit-cat-btn { position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.7); color: var(--accent); border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; z-index: 10; border: 1px solid var(--accent); }
        .cat-custom-img { width: 45px; height: 45px; object-fit: cover; margin-bottom: 10px; border-radius: 10px; }

        /* VIP Styling */
        .vip-badge { background: linear-gradient(45deg, #ffd700, #ffa500); color: black; padding: 2px 8px; border-radius: 5px; font-size: 10px; font-weight: bold; }
        .discount-tag { background: var(--red); color: white; padding: 2px 8px; border-radius: 5px; font-size: 10px; font-weight: bold; animation: pulse 2s infinite; position: absolute; top: 10px; right: 10px; z-index: 5; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* Posts */
        .post { background: var(--bg-card); margin: 15px; border-radius: 20px; overflow: hidden; border: 1px solid var(--border); position: relative; }
        .post-header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .p-user-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .p-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 1px solid var(--accent); }
        .post-img-container { position: relative; width: 100%; }
        .post-img-container img { width: 100%; display: block; max-height: 400px; object-fit: cover; }
        .sold-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10; backdrop-filter: blur(2px); }
        .sold-badge { border: 2px solid var(--red); color: var(--red); padding: 5px 15px; font-size: 18px; font-weight: bold; transform: rotate(-15deg); border-radius: 8px; }

        /* Bottom Nav */
        .bottom-tabs { position: fixed; bottom: 20px; left: 20px; right: 20px; background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(15px); border-radius: 25px; display: flex; justify-content: space-around; padding: 12px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid var(--border); z-index: 1000; }
        .tab-btn { color: var(--text-sec); text-align: center; font-size: 10px; flex: 1; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { color: var(--neon-blue); transform: translateY(-5px); }
        .tab-btn i { font-size: 22px; margin-bottom: 4px; display: block; }

        /* Admin Notify Area */
        #admin-notifications-area { padding: 0 15px; }
        .admin-notify-bar { background: rgba(245, 158, 11, 0.1); border: 1px solid var(--accent); padding: 10px; border-radius: 10px; margin-bottom: 10px; font-size: 12px; }

        /* Auth Screen */
        #auth-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="auth-screen">
    <img src="https://cdn-icons-png.flaticon.com/512/5501/5501360.png" style="width:100px; margin-bottom:20px;">
    <h2 style="margin:0; background: linear-gradient(45deg, var(--neon-blue), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">SDM MARKET</h2>
    <p style="color:var(--text-sec);">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ ÙˆØªØ¯Ø§ÙˆÙ„ MRK</p>
    <div style="width:100%; max-width:350px; padding:20px;">
        <button onclick="loginWithGoogle()" class="btn-main" style="background: white; color: black; display:flex; align-items:center; justify-content:center; gap:10px;">
            <i class="fab fa-google"></i> Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Google
        </button>
        <button class="btn-guest" onclick="enterGuestMode()">ØªØµÙØ­ ÙƒØ²Ø§Ø¦Ø± ğŸ‘€</button>
    </div>
</div>

<div id="app-screen" class="hidden">
    <header>
        <div class="header-top">
            <span onclick="goBack()" style="cursor:pointer; font-size:22px; color:var(--text-sec)"><i class="fas fa-arrow-right"></i></span>
            <span id="head-title" style="font-weight: 800; font-size: 20px; color: var(--text-main);">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            <div style="background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:15px; display:flex; align-items:center; gap:5px;">
                <i class="fas fa-star" style="color:var(--accent); font-size:12px;"></i>
                <span id="u-stars" style="font-size:12px; font-weight:bold;">0.0</span>
            </div>
        </div>
        <div class="search-container" id="main-search">
            <i class="fas fa-search"></i>
            <input type="text" id="store-search" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³ÙˆÙ‚..." oninput="filterContent(this.value)">
        </div>
    </header>

    <div id="admin-notifications-area"></div>
    <div id="content-area"></div>
    <div style="height: 100px;"></div>

    <div class="bottom-tabs">
        <div class="tab-btn active" onclick="nav('home'); highlightTab(this)"><i class="fas fa-home"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="tab-btn" onclick="checkGuestAccess('trade'); highlightTab(this)"><i class="fas fa-chart-line"></i>ØªØ¯Ø§ÙˆÙ„</div>
        <div class="tab-btn" onclick="checkGuestAccess('wallet'); highlightTab(this)"><i class="fas fa-wallet"></i>Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
        <div class="tab-btn" onclick="checkGuestAccess('games'); highlightTab(this)"><i class="fas fa-gamepad"></i>Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</div>
        <div class="tab-btn" onclick="checkGuestAccess('vip'); highlightTab(this)"><i class="fas fa-crown"></i>VIP</div>
        <div class="tab-btn" onclick="checkGuestAccess('profile'); highlightTab(this)"><i class="fas fa-user-astronaut"></i>Ù…Ù„ÙÙŠ</div>
    </div>
</div>

<script>
    // --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø© ---
    const firebaseConfig = {
      apiKey: "AIzaSyAI_mUhuPNoO-XC0Q-VNoWft8UWFbAbIGg",
      authDomain: "sudan-market-6b122.firebaseapp.com",
      databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com",
      projectId: "sudan-market-6b122",
      storageBucket: "sudan-market-6b122.firebasestorage.app",
      messagingSenderId: "66729481566",
      appId: "1:66729481566:web:93393f28dc22d32cceebcf"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const ADMIN_EMAIL = "mb425262@gmail.com";
    const OPENING_PRICE = 0.05;
    const SDM_RATE = 1000; 

    let me = null;
    let hStack = ['home'];
    let curC = '', curS = '';
    let isGuest = false; 
    let sliderInterval;
    let chartInstance = null;
    let currentTradeMode = 'buy'; 
    let marketPrice = OPENING_PRICE;
    let tempImg = '', tempBuyImg = '', userPic = 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
    
    let sliderImages = [
        "https://images.unsplash.com/photo-1556742049-0cfed4f7a07d?w=800",
        "https://images.unsplash.com/photo-1534423861386-85a16f5d13fd?w=800"
    ];

    const cats = {
        "Ø§Ù„Ù‡ÙˆØ§ØªÙ": {i:"mobile-alt", s:["Ø¢ÙŠÙÙˆÙ†","Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬","Ø´Ø§ÙˆÙ…ÙŠ","Ø¨ÙƒØ³Ù„","Ù‡ÙˆØ§ÙˆÙŠ","Ø§ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª"]},
        "Ø§Ù„Ù…Ø±ÙƒØ¨Ø§Øª": {i:"car", s:["ØªÙˆÙŠÙˆØªØ§","Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ","BYD","Ø£Ù…Ø¬Ø§Ø¯","Ø±ÙƒØ´Ø§Øª","Ø´Ø§Ø­Ù†Ø§Øª"]},
        "Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª": {i:"city", s:["Ø´Ù‚Ù‚ Ù„Ù„Ø§ÙŠØ¬Ø§Ø±","Ø¨ÙŠÙˆØª Ù„Ù„Ø¨ÙŠØ¹","Ù…Ø²Ø§Ø±Ø¹","Ø§Ø±Ø§Ø¶ÙŠ Ø³ÙƒÙ†ÙŠØ©"]},
        "Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©": {i:"tv", s:["Ø´Ø§Ø´Ø§Øª","Ø«Ù„Ø§Ø¬Ø§Øª","Ù…ÙƒÙŠÙØ§Øª","ØºØ³Ø§Ù„Ø§Øª","Ø£ÙØ±Ø§Ù†"]},
        "Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±": {i:"laptop", s:["Ù„Ø§Ø¨ØªÙˆØ¨Ø§Øª","Ø·Ø§Ø¨Ø¹Ø§Øª","Ø´Ø¨ÙƒØ§Øª","Ù‚Ø·Ø¹ ØºÙŠØ§Ø±"]},
        "Ø§Ù„Ø£Ø²ÙŠØ§Ø¡": {i:"tshirt", s:["Ø±Ø¬Ø§Ù„ÙŠ","Ù†Ø³Ø§Ø¦ÙŠ","Ø£Ø·ÙØ§Ù„","Ø£Ø­Ø°ÙŠØ©"]},
        "Ø§Ù„Ø°Ù‡Ø¨": {i:"gem", s:["Ø®ÙˆØ§ØªÙ…","Ø³Ù„Ø§Ø³Ù„","Ø£Ø·Ù‚Ù… ÙƒØ§Ù…Ù„Ø©","Ø³Ø¨Ø§Ø¦Ùƒ"]},
        "Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨": {i:"gamepad", s:["Ø­Ø³Ø§Ø¨Ø§Øª Ø¨Ø¨Ø¬ÙŠ","ÙØ±ÙŠ ÙØ§ÙŠØ±","ÙƒÙˆÙ†Ø³ÙˆÙ„","PC"]},
        "Ø¹Ù…Ù„Ø§Øª": {i:"bitcoin", s:["USDT","Binance","Ø¨Ù†ÙˆÙƒ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©"]}
    };

    const officialRates = {
        pubg: [ { name: "60 UC", sdm: 4 }, { name: "325 UC", sdm: 20 }, { name: "660 UC", sdm: 40 } ],
        ff: [ { name: "100 Ø¬ÙˆÙ‡Ø±Ø©", sdm: 4 }, { name: "530 Ø¬ÙˆÙ‡Ø±Ø©", sdm: 20 }, { name: "1080 Ø¬ÙˆÙ‡Ø±Ø©", sdm: 40 } ]
    };

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
    auth.onAuthStateChanged(user => {
        if (user) {
            db.ref('users/' + user.uid).on('value', snap => {
                if(snap.exists()) {
                    me = snap.val(); me.p = user.uid;
                    if(me.role === 'admin') {
                        if((me.mrkBalance || 0) < 30000000) db.ref('users/' + user.uid).update({ mrkBalance: 30000000 });
                        listenForAdminTasks();
                    }
                    startApp();
                } else {
                    const newUser = { n: user.displayName, email: user.email, pic: user.photoURL, sdmBalance: 0, mrkBalance: 0, role: (user.email === ADMIN_EMAIL ? 'admin' : 'user'), rating: 5.0, vipStatus: 'none', verified: true };
                    db.ref('users/' + user.uid).set(newUser);
                }
            });
        } else if(!isGuest) {
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }
    });

    function loginWithGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
    function enterGuestMode() { isGuest = true; me = { n: 'Ø²Ø§Ø¦Ø±', p: 'guest', role: 'guest', sdmBalance: 0, mrkBalance: 0 }; document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('app-screen').classList.remove('hidden'); nav('home'); }
    function checkGuestAccess(view, extra) { if (isGuest) return Swal.fire('Ø¹Ø°Ø±Ø§Ù‹', 'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'warning'); nav(view, extra); }
    function highlightTab(el) { document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); }

    function startApp() {
        isGuest = false;
        db.ref('market/stats/lastPrice').on('value', s => { marketPrice = s.val() || OPENING_PRICE; });
        document.getElementById('auth-screen').classList.add('hidden'); 
        document.getElementById('app-screen').classList.remove('hidden');
        nav('home');
    }

    // --- Ø§Ù„ØªÙ†Ù‚Ù„ ---
    function nav(view, extra) {
        hStack.push(view); 
        const area = document.getElementById('content-area');
        const searchEl = document.getElementById('main-search');
        if (sliderInterval) clearInterval(sliderInterval);
        
        document.getElementById('u-stars').innerText = isGuest ? "Ø²Ø§Ø¦Ø±" : (me.rating || 0).toFixed(1);
        document.getElementById('head-title').innerText = view==='wallet'?"Ø§Ù„Ù…Ø­ÙØ¸Ø©":view==='games'?"Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨":view==='vip'?"VIP":view==='trade'?"ØªØ¯Ø§ÙˆÙ„ MRK":"Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©";

        if(view === 'home') {
            db.ref('settings').on('value', snap => {
                const s = snap.val() || {};
                area.innerHTML = `
                    <div class="slider-container">
                        <img id="slider-img" src="${(s.sliderImages && s.sliderImages[0]) || sliderImages[0]}">
                        ${(me.role === 'admin') ? `<div class="edit-slider-btn" onclick="updateSliderImg()">âœï¸ ØªØ¹Ø¯ÙŠÙ„</div>` : ''}
                    </div>
                    <div id="vip-highlight" style="display:flex; overflow-x:auto; padding:10px; gap:10px;"></div>
                    <h3 style="padding:0 20px;">Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h3>
                    <div class="grid">
                        ${Object.keys(cats).map(k=> {
                            const ci = (s.categories && s.categories[k]) ? s.categories[k].img : null;
                            const editBtn = (me.role === 'admin') ? `<div class="edit-cat-btn" onclick="event.stopPropagation(); updateCatImg('${k}')">âœ</div>` : '';
                            return `<div class="card" onclick="nav('sub','${k}')">${editBtn}${ci ? `<img src="${ci}" class="cat-custom-img">` : `<i class="fas fa-${cats[k].i}"></i>`}<br><b>${k}</b></div>`;
                        }).join('')}
                    </div>`;
                startSlider();
                loadPosts('vip_posts', null, 'vip-highlight', true);
            });

        } else if(view === 'sub') {
            curC = extra;
            area.innerHTML = `<div class="grid">${cats[curC].s.map(s=>`<div class="card" onclick="nav('feed','${s}')"><b>${s}</b></div>`).join('')}</div>`;

        } else if(view === 'feed') {
            curS = extra;
            area.innerHTML = `
                ${!isGuest ? `<div class="post" style="padding:20px;">
                    <input id="pt" class="inp-field" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
                    <input id="pp" type="number" class="inp-field" placeholder="Ø§Ù„Ø³Ø¹Ø± (SDM)">
                    <textarea id="pd" class="inp-field" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬..."></textarea>
                    <input type="file" id="f-post" hidden onchange="encode(this, 'post')">
                    <button class="btn-main" onclick="document.getElementById('f-post').click()">ğŸ“¸ ØµÙˆØ±Ø©</button>
                    <button class="btn-main" onclick="publish('posts')">Ù†Ø´Ø±</button>
                </div>` : ''}
                <div id="posts-list"></div>`;
            loadPosts('posts', curS, 'posts-list');

        } else if(view === 'trade') {
            area.innerHTML = `
                <div style="padding:15px;">
                    <div class="ticker-bar">
                        <div class="ticker-item"><span class="t-lbl">Ø§Ù„Ø³Ø¹Ø±</span><span class="t-val" style="color:var(--green)">${marketPrice}</span></div>
                        <div class="ticker-item"><span class="t-lbl">Ø§Ù„Ø­Ø¬Ù…</span><span id="vol-24" class="t-val">0</span></div>
                    </div>
                    <div id="chart-area" class="chart-box"></div>
                    <div class="trade-controls">
                        <div class="trade-tabs">
                            <div id="tab-buy" class="t-btn buy active" onclick="setTradeMode('buy')">Ø´Ø±Ø§Ø¡</div>
                            <div id="tab-sell" class="t-btn sell" onclick="setTradeMode('sell')">Ø¨ÙŠØ¹</div>
                        </div>
                        <input type="number" id="tr-p" class="inp-field" value="${marketPrice}" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                        <input type="number" id="tr-a" class="inp-field" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                        <div class="pct-bar">
                            <div class="pct-btn" onclick="calcPct(0.25)">25%</div><div class="pct-btn" onclick="calcPct(0.5)">50%</div>
                            <div class="pct-btn" onclick="calcPct(0.75)">75%</div><div class="pct-btn" onclick="calcPct(1)">100%</div>
                        </div>
                        <button id="tr-btn" class="btn-main" onclick="executeTrade()">ØªÙ†ÙÙŠØ°</button>
                    </div>
                </div>`;
            initChart();

        } else if(view === 'vip') {
            const isVip = me.vipStatus === 'active';
            area.innerHTML = `
                <div style="text-align:center; padding:30px;">
                    <i class="fas fa-crown" style="font-size:50px; color:var(--accent)"></i>
                    <h2>Ø¹Ø¶ÙˆÙŠØ© VIP</h2>
                    ${isVip ? `<p>Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ù†Ø´Ø· âœ…</p>` : `
                    <div class="grid">
                        <div class="card" onclick="buyVip(7, 7)"><b>7 Ø£ÙŠØ§Ù…</b><br>7 SDM</div>
                        <div class="card" onclick="buyVip(30, 30)"><b>30 ÙŠÙˆÙ…</b><br>30 SDM</div>
                    </div>`}
                </div>
                ${isVip ? `<div class="post" style="padding:20px;">
                    <h4>Ù†Ø´Ø± Ø¹Ø±Ø¶ Ù…Ù…ÙŠØ²</h4>
                    <input id="v-t" class="inp-field" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†">
                    <input id="v-p" type="number" class="inp-field" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                    <input id="v-d" type="number" class="inp-field" placeholder="Ø®ØµÙ… %">
                    <textarea id="v-desc" class="inp-field" placeholder="Ø§Ù„ÙˆØµÙ"></textarea>
                    <button class="btn-main" onclick="publish('vip_posts')">Ù†Ø´Ø± VIP</button>
                </div>` : ''}`;

        } else if(view === 'wallet') {
            area.innerHTML = `
                <div style="padding:20px;">
                    <div class="wallet-overview">
                        <p>Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
                        <h1>${me.sdmBalance.toFixed(2)} SDM</h1>
                        <p style="color:var(--accent)">${(me.mrkBalance||0).toFixed(4)} MRK</p>
                    </div>
                    <button class="btn-main" onclick="requestCoins()">Ø¥ÙŠØ¯Ø§Ø¹ SDM</button>
                    <button class="btn-main" style="background:#334155" onclick="showTransfer()">ØªØ­ÙˆÙŠÙ„ Ø±ØµÙŠØ¯</button>
                    <div id="tx-history" style="margin-top:20px;"></div>
                </div>`;
            loadTransactions();

        } else if(view === 'games') {
            area.innerHTML = `
                <div class="post" style="padding:20px;">
                    <h3>Ø´Ø­Ù† Ø£Ù„Ø¹Ø§Ø¨</h3>
                    <select id="g-type" class="inp-field" onchange="loadG()">
                        <option value="pubg">Ø¨Ø¨Ø¬ÙŠ UC</option>
                        <option value="ff">ÙØ±ÙŠ ÙØ§ÙŠØ± Ø¬ÙˆØ§Ù‡Ø±</option>
                    </select>
                    <input id="g-id" class="inp-field" placeholder="ID Ø§Ù„Ù„Ø§Ø¹Ø¨">
                    <select id="g-pack" class="inp-field" onchange="calcG()"></select>
                    <p id="g-res">Ø§Ù„ØªÙƒÙ„ÙØ©: 0 SDG</p>
                    <button class="btn-main" onclick="orderG()">Ø´Ø­Ù† Ø§Ù„Ø¢Ù†</button>
                </div>`;
            loadG();
        }
    }

    // --- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ---
    function loadPosts(path, sub, container, isHorizontal=false) {
        db.ref(path).on('value', snap => {
            const list = document.getElementById(container);
            if(!list) return; list.innerHTML = "";
            snap.forEach(c => {
                const p = c.val();
                if(sub && p.sub !== sub) return;
                const isOwner = p.uP === me.p || me.role === 'admin';
                const item = `
                    <div class="post" style="${isHorizontal ? 'min-width:200px; margin:5px;' : ''}">
                        ${p.discount ? `<div class="discount-tag">-${p.discount}%</div>` : ''}
                        <div class="post-header">
                            <div class="p-user-info">
                                <img src="${p.uPic || userPic}" class="p-avatar">
                                <span>${p.uN}</span>
                            </div>
                            ${isOwner ? `<i class="fas fa-trash" onclick="deletePost('${path}','${c.key}')"></i>` : ''}
                        </div>
                        <div class="post-img-container">
                            ${p.status === 'sold' ? `<div class="sold-overlay"><div class="sold-badge">ØªÙ… Ø§Ù„Ø¨ÙŠØ¹</div></div>` : ''}
                            <img src="${p.img || ''}">
                        </div>
                        <div style="padding:10px;">
                            <div style="color:var(--accent); font-weight:bold;">${p.pr} SDM</div>
                            <b>${p.t}</b>
                            <p style="font-size:12px; color:var(--text-sec)">${p.d}</p>
                            ${isOwner && p.status !== 'sold' ? `<button class="btn-main" style="font-size:10px; padding:5px;" onclick="markSold('${path}','${c.key}')">ØªÙ…ÙŠÙŠØ² ÙƒÙ…Ø¨Ø§Ø¹</button>` : ''}
                        </div>
                    </div>`;
                list.innerHTML += item;
            });
        });
    }

    async function encode(input, type) {
        if(!input.files[0]) return;
        const reader = new FileReader();
        reader.readAsDataURL(input.files[0]);
        reader.onload = (e) => {
            const img = new Image(); img.src = e.target.result;
            img.onload = () => {
                const cvs = document.createElement('canvas');
                const scale = 600 / img.width;
                cvs.width = 600; cvs.height = img.height * scale;
                cvs.getContext('2d').drawImage(img, 0, 0, cvs.width, cvs.height);
                const res = cvs.toDataURL('image/jpeg', 0.7);
                if(type === 'post') tempImg = res;
                if(type === 'buy') tempBuyImg = res;
                Swal.fire({toast:true, title:'ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©', icon:'success', position:'top', showConfirmButton:false, timer:1500});
            }
        };
    }

    function publish(path) {
        const t = document.getElementById(path==='vip_posts'?'v-t':'pt').value;
        const pr = document.getElementById(path==='vip_posts'?'v-p':'pp').value;
        const d = document.getElementById(path==='vip_posts'?'v-desc':'pd').value;
        const discount = path==='vip_posts' ? document.getElementById('v-d').value : null;
        if(!t || !pr || !tempImg) return Swal.fire('Ø®Ø·Ø£','Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØµÙˆØ±Ø©','error');
        
        db.ref(path).push({
            t, pr, d, discount, img: tempImg, sub: curS,
            uP: me.p, uN: me.n, uPic: me.pic||userPic, date: Date.now()
        }).then(() => { Swal.fire('ØªÙ… Ø§Ù„Ù†Ø´Ø±','','success'); tempImg=''; nav('home'); });
    }

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯Ø§ÙˆÙ„ ---
    function setTradeMode(mode) {
        currentTradeMode = mode;
        document.getElementById('tab-buy').className = `t-btn buy ${mode==='buy'?'active':''}`;
        document.getElementById('tab-sell').className = `t-btn sell ${mode==='sell'?'active':''}`;
        document.getElementById('tr-btn').style.background = mode==='buy' ? 'var(--green)' : 'var(--red)';
    }

    function calcPct(p) {
        const price = parseFloat(document.getElementById('tr-p').value);
        if(currentTradeMode === 'buy') document.getElementById('tr-a').value = ((me.sdmBalance * p) / price).toFixed(4);
        else document.getElementById('tr-a').value = ((me.mrkBalance || 0) * p).toFixed(4);
    }

    async function executeTrade() {
        const p = parseFloat(document.getElementById('tr-p').value);
        const a = parseFloat(document.getElementById('tr-a').value);
        if(!p || !a) return;
        const path = currentTradeMode==='buy' ? 'market/orders/buy' : 'market/orders/sell';
        await db.ref(path).push({ uP: me.p, price: p, amount: a, date: Date.now() });
        Swal.fire('ØªÙ… ÙˆØ¶Ø¹ Ø§Ù„Ø·Ù„Ø¨','Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©','success');
    }

    function initChart() {
        chartInstance = new ApexCharts(document.querySelector("#chart-area"), {
            series: [{data: []}], chart: {type: 'candlestick', height: 300, background:'transparent'},
            theme: {mode:'dark'}, xaxis: {type:'datetime'}
        });
        chartInstance.render();
    }

    // --- Ù…ÙŠØ²Ø§Øª Ø§Ù„Ù€ VIP ---
    function buyVip(days, cost) {
        if(me.sdmBalance < cost) return Swal.fire('Ø®Ø·Ø£','Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ','error');
        const expiry = Date.now() + (days * 24 * 60 * 60 * 1000);
        db.ref('users/'+me.p).update({
            sdmBalance: me.sdmBalance - cost,
            vipStatus: 'active',
            vipExpiry: expiry
        });
        Swal.fire('Ù…Ø¨Ø±ÙˆÙƒ!','Ø£ØµØ¨Ø­Øª Ø¹Ø¶Ùˆ VIP Ø§Ù„Ø¢Ù†','success');
    }

    // --- Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø£Ø¯Ù…Ù† ---
    async function updateSliderImg() {
        const { value: url } = await Swal.fire({title: 'Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯', input: 'text'});
        if(url) db.ref('settings/sliderImages/0').set(url);
    }
    async function updateCatImg(cat) {
        const { value: url } = await Swal.fire({title: `Ø±Ø§Ø¨Ø· Ø£ÙŠÙ‚ÙˆÙ†Ø© ${cat}`, input: 'text'});
        if(url) db.ref(`settings/categories/${cat}/img`).set(url);
    }
    function listenForAdminTasks() {
        db.ref('coin_requests').orderByChild('status').equalTo('pending').on('value', snap => {
            const area = document.getElementById('admin-notifications-area');
            if(!area) return; area.innerHTML = "";
            snap.forEach(c => {
                const r = c.val();
                area.innerHTML += `<div class="admin-notify-bar">Ø·Ù„Ø¨ Ø¥ÙŠØ¯Ø§Ø¹: ${r.qty} SDM Ù…Ù† ${r.uN} <button onclick="approveDep('${c.key}','${r.uP}',${r.qty})">Ù‚Ø¨ÙˆÙ„</button></div>`;
            });
        });
    }

    // --- Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ ---
    function loadG() {
        const type = document.getElementById('g-type').value;
        const pack = document.getElementById('g-pack');
        pack.innerHTML = officialRates[type].map(r => `<option value="${r.sdm}">${r.name}</option>`).join('');
        calcG();
    }
    function calcG() {
        const sdm = document.getElementById('g-pack').value;
        document.getElementById('g-res').innerText = `Ø§Ù„ØªÙƒÙ„ÙØ©: ${(sdm * SDM_RATE).toLocaleString()} SDG`;
    }
    function orderG() {
        const sdm = parseFloat(document.getElementById('g-pack').value);
        if(me.sdmBalance < sdm) return Swal.fire('Ø®Ø·Ø£','Ø±ØµÙŠØ¯ SDM ØºÙŠØ± ÙƒØ§ÙÙ','error');
        db.ref('game_orders').push({ uP: me.p, uN: me.n, id: document.getElementById('g-id').value, sdm, status: 'pending' });
        Swal.fire('ØªÙ… Ø§Ù„Ø·Ù„Ø¨','Ø³ÙŠØªÙ… Ø§Ù„Ø´Ø­Ù† Ù‚Ø±ÙŠØ¨Ø§Ù‹','success');
    }

    // --- Ø§Ù„Ù…Ø­ÙØ¸Ø© ---
    function requestCoins() {
        Swal.fire({
            title: 'Ø¥ÙŠØ¯Ø§Ø¹ SDM',
            html: `<p>Ø­ÙˆÙ„ Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø®Ø±Ø·ÙˆÙ…: <b>4426148</b></p><input type="number" id="sw-qty" class="swal2-input" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©"><input type="file" id="sw-file" onchange="encode(this,'buy')">`,
            preConfirm: () => { return document.getElementById('sw-qty').value }
        }).then(res => {
            if(res.value && tempBuyImg) {
                db.ref('coin_requests').push({ uP: me.p, uN: me.n, qty: res.value, img: tempBuyImg, status: 'pending', date: Date.now() });
                Swal.fire('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„','Ø§Ù†ØªØ¸Ø± Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©','success');
            }
        });
    }

    // --- Ù…Ø³Ø§Ø¹Ø¯Ø© ---
    function goBack() { if(hStack.length > 1) { hStack.pop(); nav(hStack[hStack.length-1]); } }
    function startSlider() {
        let i = 0;
        sliderInterval = setInterval(() => {
            i = (i + 1) % sliderImages.length;
            const el = document.getElementById('slider-img');
            if(el) el.src = sliderImages[i];
        }, 4000);
    }
    function filterContent(q) {
        q = q.toLowerCase();
        document.querySelectorAll('.card, .post').forEach(el => {
            el.style.display = el.innerText.toLowerCase().includes(q) ? 'block' : 'none';
        });
    }
    function markSold(path, key) { db.ref(`${path}/${key}`).update({status: 'sold'}); }
    function deletePost(path, key) { if(confirm('Ø­Ø°ÙØŸ')) db.ref(`${path}/${key}`).remove(); }

</script>
</body>
</html>

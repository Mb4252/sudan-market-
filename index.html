<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SDM Market Secure | ÿßŸÑŸÖÿ™ÿ¨ÿ± ÿßŸÑÿ¢ŸÖŸÜ</title>
    
    <!-- ÿÆÿ∑Ÿàÿ∑ ÿπÿ±ÿ®Ÿäÿ© -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- UI Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.95);
            --primary: #3b82f6;
            --accent: #f59e0b;
            --neon-blue: #00f3ff;
            --text-main: #f8fafc;
            --text-sec: #94a3b8;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --red: #ef4444; 
            --green: #10b981; 
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline:none; }
        
        body {
            font-family: 'Tajawal', sans-serif; 
            margin: 0;
            background: radial-gradient(circle at top, #1e293b, #0f172a); 
            color: var(--text-main);
            padding-bottom: 90px;
            min-height: 100vh;
            user-select: none;
            overflow-x: hidden;
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 10px; }

        .hidden { display: none !important; }
        .search-hidden { display: none !important; }

        /* Offline Guard */
        #offline-guard {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.98); z-index: 99999;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center; backdrop-filter: blur(15px);
        }
        .pulse-icon { animation: pulse 2s infinite; color: var(--red); font-size: 80px; margin-bottom: 25px; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        
        /* Header */
        header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            padding: 15px 20px;
            position: sticky; top: 0; z-index: 1000;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; gap: 10px;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        
        /* Search */
        .search-container { position: relative; width: 100%; }
        .search-container input {
            width: 100%; padding: 12px 45px 12px 15px;
            border-radius: 15px; border: 1px solid var(--border);
            font-size: 14px; background: var(--glass); color: white;
            transition: 0.3s; font-family: 'Tajawal';
        }
        .search-container input:focus { 
            background: rgba(255,255,255,0.1); border-color: var(--neon-blue); 
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); 
        }
        .search-container i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--accent); }

        /* Slider */
        .slider-container { margin: 20px; height: 180px; border-radius: 20px; overflow: hidden; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid var(--border); }
        #slider-img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.5s; }
        .slider-overlay { position: absolute; bottom: 0; width: 100%; background: linear-gradient(to top, black, transparent); padding: 20px 10px 10px; text-align: center; color: white; }
        .slider-dots { position: absolute; bottom: 10px; width: 100%; display: flex; justify-content: center; gap: 5px; z-index: 10; }
        .dot { width: 8px; height: 8px; background: rgba(255,255,255,0.5); border-radius: 50%; }
        .dot.active { background: var(--accent); }
        .edit-slider-btn { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.6); padding: 5px 10px; border-radius: 15px; cursor: pointer; z-index: 20; font-size: 12px; color: var(--accent); border: 1px solid var(--accent); }

        /* Grid & Cards */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; }
        .card { background: var(--bg-card); border-radius: 18px; padding: 20px; text-align: center; border: 1px solid var(--border); transition: 0.3s; position: relative; overflow: hidden; backdrop-filter: blur(5px); color: var(--text-main); }
        .card:active { transform: scale(0.96); }
        .card:hover { border-color: var(--neon-blue); box-shadow: 0 5px 20px rgba(0, 243, 255, 0.15); transform: translateY(-5px); }
        .card i { font-size: 28px; margin-bottom: 10px; background: linear-gradient(45deg, #fff, #aaa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .cat-custom-img { width: 50px; height: 50px; object-fit: cover; margin-bottom: 10px; border-radius: 10px; }
        .edit-cat-btn { position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.7); color: var(--accent); border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; z-index: 10; border: 1px solid var(--accent); }

        /* Posts */
        .post { background: var(--bg-card); margin: 15px; border-radius: 20px; overflow: hidden; border: 1px solid var(--border); animation: fadeIn 0.5s ease; position: relative; }
        .post-img-container { height: 220px; position: relative; }
        .sold-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(220, 53, 69, 0.8); color: white; display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: bold; z-index: 5; }
        
        /* Post Menu */
        .post-menu-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            font-size: 16px;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .post-menu {
            position: absolute;
            top: 50px;
            left: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 8px 0;
            min-width: 150px;
            z-index: 100;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: none;
        }
        
        .post-menu.active {
            display: block;
        }
        
        .post-menu-item {
            padding: 10px 15px;
            color: var(--text-main);
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .post-menu-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .post-menu-item.delete {
            color: var(--red);
        }
        
        /* Post Info */
        .post-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-sec);
            margin: 5px 0;
            padding: 0 15px;
        }
        
        .post-date {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .online-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
        }
        
        /* Buttons & Inputs */
        button { font-family: 'Tajawal'; }
        .btn-main { background: linear-gradient(90deg, var(--primary), #2563eb); color: white; border: none; padding: 15px; width: 100%; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); transition: 0.3s; }
        .btn-guest { background: transparent; border: 1px solid var(--text-sec); color: var(--text-sec); width: 100%; padding: 12px; border-radius: 10px; margin-top: 10px; cursor: pointer; }
        input, textarea, select { width: 100%; padding: 15px; margin: 8px 0; background: rgba(0,0,0,0.2); border: 1px solid var(--border); border-radius: 12px; color: white; font-family: 'Tajawal'; box-sizing: border-box; }
        input:focus, textarea:focus, select:focus { border-color: var(--accent); outline: none; background: rgba(0,0,0,0.4); }

        /* Wallet */
        .wallet-card { background: linear-gradient(135deg, #1e1e2f, #000); border: 1px solid var(--accent); padding: 30px; margin: 15px; border-radius: 25px; text-align: center; position: relative; box-shadow: 0 0 30px rgba(245, 158, 11, 0.15); }
        .sdm-logo { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--accent); padding: 5px; box-shadow: 0 0 20px rgba(245, 158, 11, 0.4); animation: float 3s ease-in-out infinite; object-fit: cover; }
        @keyframes float { 0% {transform: translateY(0px);} 50% {transform: translateY(-10px);} 100% {transform: translateY(0px);} }

        /* Admin & Game Panels */
        .admin-panel { background: var(--bg-card); border: 1px solid var(--border); padding: 15px; margin: 15px; border-radius: 15px; color: white; }
        .admin-notify-bar { background: rgba(245, 158, 11, 0.1); border: 1px solid var(--accent); margin: 15px; padding: 15px; border-radius: 15px; color: white; }
        .admin-item { background: rgba(0,0,0,0.3); padding: 10px; margin-bottom: 10px; border-radius: 10px; border: 1px solid var(--border); }

        /* Bottom Navigation */
        .bottom-tabs {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            border: 1px solid var(--border);
            z-index: 1000;
        }
        
        .tab-btn {
            color: var(--text-sec);
            text-align: center;
            font-size: 10px;
            transition: 0.3s;
            position: relative;
            flex: 1;
            cursor: pointer;
        }
        
        .tab-btn i {
            font-size: 22px;
            margin-bottom: 4px;
            display: block;
            transition: 0.3s;
        }
        
        .tab-btn.active {
            color: var(--neon-blue);
        }
        
        .tab-btn.active i {
            transform: translateY(-5px);
            text-shadow: 0 0 10px var(--neon-blue);
        }

        /* Common */
        .online-dot {
            width: 10px;
            height: 10px;
            background: var(--green);
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            box-shadow: 0 0 5px var(--green);
        }
        
        .discount-tag {
            background: var(--red);
            color: white;
            padding: 2px 8px;
            border-radius: 5px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .old-price {
            text-decoration: line-through;
            color: var(--text-sec);
            font-size: 12px;
            margin-left: 5px;
        }
        
        .badge {
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 10px;
            font-weight: bold;
        }
        
        .badge-gold {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent);
            border: 1px solid var(--accent);
        }
        
        .badge-admin {
            background: rgba(239, 68, 68, 0.2);
            color: var(--red);
            border: 1px solid var(--red);
        }
        
        #dev-alert-bar {
            background: linear-gradient(90deg, #b91c1c, #ef4444);
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 13px;
            font-weight: bold;
            display: none;
            margin: 10px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.4);
        }

        /* VIP Badge */
        .vip-badge {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #000;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-right: 5px;
        }

        /* Google Login Image */
        .google-login-btn {
            background: white;
            color: black;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border-radius: 12px;
            padding: 15px;
            width: 100%;
            max-width: 350px;
            margin: 0 auto;
            border: none;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
        }
        
        .google-login-btn img {
            width: 20px;
            height: 20px;
        }
        
        /* SweetAlert Custom */
        div:where(.swal2-container) div:where(.swal2-popup) {
            background: #1e293b !important;
            color: #fff !important;
            border: 1px solid var(--border);
        }
        
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

<!-- ÿ≠ŸÖÿßŸäÿ© -->
<div id="offline-guard" class="hidden">
    <i class="fas fa-shield-alt pulse-icon"></i>
    <h2 style="color:white; margin:10px;">ÿßŸÑŸÜÿ∏ÿßŸÖ ŸÅŸä Ÿàÿ∂ÿπ ÿßŸÑÿ≠ŸÖÿßŸäÿ©</h2>
    <p style="color:#94a3b8;">ÿ™ÿπÿ∞ÿ± ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ. ÿ™ŸÖ ÿ™ÿ¨ŸÖŸäÿØ ÿßŸÑÿπŸÖŸÑŸäÿßÿ™.</p>
</div>

<!-- ÿØÿÆŸàŸÑ -->
<div id="auth-screen" class="hidden">
    <div style="padding:40px; text-align:center; height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <img src="https://cdn-icons-png.flaticon.com/512/5501/5501360.png" class="sdm-logo" style="margin-bottom:30px; width:100px; height:100px;">
        <h2 style="font-size: 32px; margin-bottom:5px; background: linear-gradient(45deg, var(--neon-blue), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">SDM MARKET</h2>
        <p style="color:var(--text-sec); margin-bottom:40px;">ÿ®Ÿàÿßÿ®ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÇÿ®ŸÑ Ÿàÿ™ÿØÿßŸàŸÑ MRK</p>
        <div id="login-box" style="width:100%; max-width:350px;">
            <button class="google-login-btn" onclick="loginWithGoogle()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google Logo">
                ÿØÿÆŸàŸÑ ÿ®Ÿàÿßÿ≥ÿ∑ÿ© Google
            </button>
            <button class="btn-guest" onclick="enterGuestMode()">ÿ™ÿµŸÅÿ≠ ŸÉÿ≤ÿßÿ¶ÿ± üëÄ</button>
        </div>
    </div>
</div>

<!-- ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ -->
<div id="app-screen" class="hidden">
    <header>
        <div class="header-top">
            <span onclick="handleBackButton()" style="cursor:pointer; font-size:22px; color:var(--text-sec)">
                <i class="fas fa-arrow-right"></i>
            </span>
            <span id="head-title" style="font-weight: 800; font-size: 20px; color: var(--text-main);">ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</span>
            <div style="background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:15px; display:flex; align-items:center; gap:5px;">
                <i class="fas fa-star" style="color:var(--accent); font-size:12px;"></i>
                <span id="u-stars" style="font-size:12px; font-weight:bold;">0.0</span>
            </div>
        </div>
        <div class="search-container" id="main-search">
            <i class="fas fa-search"></i>
            <input type="text" id="store-search" placeholder="ÿßÿ®ÿ≠ÿ´ ŸÅŸä ÿßŸÑÿ≥ŸàŸÇ..." oninput="filterContent(this.value)">
        </div>
    </header>

    <div id="dev-alert-bar"></div>
    <div id="admin-notifications-area"></div>
    <div id="welcome-container" style="padding: 0 20px;"></div>
    
    <div id="content-area"></div>

    <div style="height: 100px;"></div>

    <div class="bottom-tabs">
        <div class="tab-btn active" onclick="nav('home'); highlightTab(this)"><i class="fas fa-home"></i>ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©</div>
        <div class="tab-btn" onclick="checkGuestAccess('wallet'); highlightTab(this)"><i class="fas fa-wallet"></i>ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©</div>
        <div class="tab-btn" onclick="checkGuestAccess('games'); highlightTab(this)"><i class="fas fa-gamepad"></i>ÿßŸÑÿ£ŸÑÿπÿßÿ®</div>
        <div class="tab-btn" onclick="checkGuestAccess('vip'); highlightTab(this)"><i class="fas fa-crown" style="color:var(--accent)"></i>VIP</div>
        <div class="tab-btn" onclick="checkGuestAccess('profile'); highlightTab(this)"><i class="fas fa-user-astronaut"></i>ŸÖŸÑŸÅŸä</div>
    </div>
</div>

<script>
    // --- ÿ™ŸáŸäÿ¶ÿ© Firebase ---
    const firebaseConfig = {
        apiKey: "AIzaSyAI_mUhuPNoO-XC0Q-VNoWft8UWFbAbIGg",
        authDomain: "sudan-market-6b122.firebaseapp.com",
        databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com",
        projectId: "sudan-market-6b122",
        storageBucket: "sudan-market-6b122.firebasestorage.app",
        messagingSenderId: "66729481566",
        appId: "1:66729481566:web:93393f28dc22d32cceebcf"
    };
    
    // ÿ™ŸáŸäÿ¶ÿ© Firebase ŸÖÿ±ÿ© Ÿàÿßÿ≠ÿØÿ© ŸÅŸÇÿ∑
    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    
    const auth = firebase.auth();
    const db = firebase.database();

    // --- ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿπÿßŸÖÿ© ---
    const ADMIN_EMAIL = "mb425262@gmail.com";
    const SDM_RATE = 1000;
    let me = null;
    let hStack = ['home'];
    let curC = '', curS = '';
    let tempImg = '', tempBuyImg = '', userPic = 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
    let isGuest = false;
    let sliderInterval;
    const sdmCoinImage = "https://cdn-icons-png.flaticon.com/512/5501/5501360.png";
    let lastRefreshTime = Date.now();
    let activePostMenu = null;
    let listeners = {}; // ŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπÿßÿ™

    // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
    let sliderImages = [
        "https://images.unsplash.com/photo-1556742049-0cfed4f7a07d?w=800",
        "https://images.unsplash.com/photo-1534423861386-85a16f5d13fd?w=800",
        sdmCoinImage
    ];
    let currentSliderIndex = 0;

    const cats = {
        "ÿßŸÑŸáŸàÿßÿ™ŸÅ": {i:"mobile-alt", s:["ÿ¢ŸäŸÅŸàŸÜ","ÿ≥ÿßŸÖÿ≥ŸàŸÜÿ¨","ÿ¥ÿßŸàŸÖŸä","ÿ®ŸÉÿ≥ŸÑ","ŸáŸàÿßŸàŸä","ÿßŸÉÿ≥ÿ≥Ÿàÿßÿ±ÿßÿ™"]},
        "ÿßŸÑŸÖÿ±ŸÉÿ®ÿßÿ™": {i:"car", s:["ÿ™ŸàŸäŸàÿ™ÿß","ŸáŸäŸàŸÜÿØÿßŸä","BYD","ÿ£ŸÖÿ¨ÿßÿØ","ÿ±ŸÉÿ¥ÿßÿ™","ÿ¥ÿßÿ≠ŸÜÿßÿ™"]},
        "ÿßŸÑÿπŸÇÿßÿ±ÿßÿ™": {i:"city", s:["ÿ¥ŸÇŸÇ ŸÑŸÑÿßŸäÿ¨ÿßÿ±","ÿ®ŸäŸàÿ™ ŸÑŸÑÿ®Ÿäÿπ","ŸÖÿ≤ÿßÿ±ÿπ","ÿßÿ±ÿßÿ∂Ÿä ÿ≥ŸÉŸÜŸäÿ©"]},
        "ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ©": {i:"tv", s:["ÿ¥ÿßÿ¥ÿßÿ™","ÿ´ŸÑÿßÿ¨ÿßÿ™","ŸÖŸÉŸäŸÅÿßÿ™","ÿ∫ÿ≥ÿßŸÑÿßÿ™","ÿ£ŸÅÿ±ÿßŸÜ"]},
        "ÿßŸÑŸÉŸÖÿ®ŸäŸàÿ™ÿ±": {i:"laptop", s:["ŸÑÿßÿ®ÿ™Ÿàÿ®ÿßÿ™","ÿ∑ÿßÿ®ÿπÿßÿ™","ÿ¥ÿ®ŸÉÿßÿ™","ŸÇÿ∑ÿπ ÿ∫Ÿäÿßÿ±"]},
        "ÿßŸÑÿ£ÿ≤Ÿäÿßÿ°": {i:"tshirt", s:["ÿ±ÿ¨ÿßŸÑŸä","ŸÜÿ≥ÿßÿ¶Ÿä","ÿ£ÿ∑ŸÅÿßŸÑ","ÿ£ÿ≠ÿ∞Ÿäÿ©"]},
        "ÿßŸÑÿ∞Ÿáÿ®": {i:"gem", s:["ÿÆŸàÿßÿ™ŸÖ","ÿ≥ŸÑÿßÿ≥ŸÑ","ÿ£ÿ∑ŸÇŸÖ ŸÉÿßŸÖŸÑÿ©","ÿ≥ÿ®ÿßÿ¶ŸÉ"]},
        "ÿßŸÑÿ£ŸÑÿπÿßÿ®": {i:"gamepad", s:["ÿ≠ÿ≥ÿßÿ®ÿßÿ™ ÿ®ÿ®ÿ¨Ÿä","ŸÅÿ±Ÿä ŸÅÿßŸäÿ±","ŸÉŸàŸÜÿ≥ŸàŸÑ","PC"]},
        "ÿßŸÑŸàÿ∏ÿßÿ¶ŸÅ": {i:"briefcase", s:["Ÿàÿ∏ÿßÿ¶ŸÅ ÿ¥ÿßÿ∫ÿ±ÿ©","ÿ®ÿ≠ÿ´ ÿπŸÜ ÿπŸÖŸÑ","ÿπŸÖÿßŸÑÿ©"]},
        "ÿßŸÑÿÆÿØŸÖÿßÿ™": {i:"tools", s:["ÿ™ÿµŸÖŸäŸÖ","ÿ®ÿ±ŸÖÿ¨ÿ©","ÿ™ÿ≥ŸàŸäŸÇ","ŸÜŸÇŸÑ ÿπŸÅÿ¥","ÿµŸäÿßŸÜÿ©"]},
        "ÿßŸÑÿ∑ÿπÿßŸÖ": {i:"utensils", s:["Ÿàÿ¨ÿ®ÿßÿ™","ÿ™ŸàÿµŸäŸÑ","ŸÖŸàÿßÿØ ÿ™ŸÖŸàŸäŸÜŸäÿ©","ÿ≠ŸÑŸàŸäÿßÿ™"]},
        "ÿßŸÑÿµÿ≠ÿ©": {i:"heartbeat", s:["ÿ£ÿØŸàŸäÿ©","ŸÖÿ≥ÿ™ŸÑÿ≤ŸÖÿßÿ™ ÿ∑ÿ®Ÿäÿ©","ŸÅŸäÿ™ÿßŸÖŸäŸÜÿßÿ™"]},
        "ÿßŸÑÿ™ÿπŸÑŸäŸÖ": {i:"graduation-cap", s:["ÿØÿ±Ÿàÿ≥ ÿÆÿµŸàÿµŸäÿ©","ŸÉÿ™ÿ®","ÿØŸàÿ±ÿßÿ™ ÿ™ÿØÿ±Ÿäÿ®Ÿäÿ©"]},
        "ÿßŸÑÿ≠ŸäŸàÿßŸÜÿßÿ™": {i:"paw", s:["ÿ∑ŸäŸàÿ±","ŸÇÿ∑ÿ∑","ŸÉŸÑÿßÿ®","ÿ£ÿπŸÑÿßŸÅ","ŸÖŸàÿßÿ¥Ÿä"]},
        "ÿßŸÑÿ≤ÿ±ÿßÿπÿ©": {i:"leaf", s:["ÿ®ÿ∞Ÿàÿ±","ÿ£ÿ≥ŸÖÿØÿ©","ŸÖÿπÿØÿßÿ™ ÿ≤ÿ±ÿßÿπŸäÿ©","ŸÖÿ≠ÿßÿµŸäŸÑ"]},
        "ÿßŸÑŸÖÿπÿØÿßÿ™": {i:"cogs", s:["ŸÖÿπÿØÿßÿ™ ÿ´ŸÇŸäŸÑÿ©","ŸÖŸàŸÑÿØÿßÿ™","ÿ£ÿØŸàÿßÿ™ ÿ®ŸÜÿßÿ°"]},
        "ÿßŸÑŸÉÿ™ÿ®": {i:"book", s:["ÿ±ŸàÿßŸäÿßÿ™","ŸÉÿ™ÿ® ÿØÿ±ÿßÿ≥Ÿäÿ©","ŸÉÿ™ÿ® ÿØŸäŸÜŸäÿ©"]},
        "ÿßŸÑŸÅŸÜ": {i:"palette", s:["ÿ±ÿ≥ŸÖ","ÿ™ÿµŸÖŸäŸÖ ÿØÿßÿÆŸÑŸä","ÿ£ÿπŸÖÿßŸÑ ŸäÿØŸàŸäÿ©"]},
        "ÿßŸÑÿ±Ÿäÿßÿ∂ÿ©": {i:"futbol", s:["ŸÖÿπÿØÿßÿ™ ÿ±Ÿäÿßÿ∂Ÿäÿ©","ŸÖŸÑÿßÿ®ÿ≥ ÿ±Ÿäÿßÿ∂Ÿäÿ©","ÿ®ÿ±Ÿàÿ™ŸäŸÜÿßÿ™"]},
        "ÿπŸÖŸÑÿßÿ™": {i:"bitcoin", s:["USDT","Binance","ÿ®ŸÜŸàŸÉ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸäÿ©"]},
        "ÿ¨ŸÖŸÑÿ©": {i:"boxes", s:["ŸÖŸàÿßÿØ ÿ∫ÿ∞ÿßÿ¶Ÿäÿ©","ŸÖŸÑÿßÿ®ÿ≥","ŸÉŸáÿ±ÿ®ÿßÿ°"]}
    };

    const officialRates = {
        pubg: [ { name: "60 UC", sdm: 4 }, { name: "325 UC", sdm: 20 }, { name: "660 UC", sdm: 40 } ],
        ff: [ { name: "100 ÿ¨ŸàŸáÿ±ÿ©", sdm: 4 }, { name: "530 ÿ¨ŸàŸáÿ±ÿ©", sdm: 20 }, { name: "1080 ÿ¨ŸàŸáÿ±ÿ©", sdm: 40 } ]
    };

    // --- ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπÿßÿ™ ---
    function removeAllListeners() {
        // ÿ•ÿ≤ÿßŸÑÿ© ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©
        if (listeners.settings) listeners.settings();
        if (listeners.system) listeners.system();
        if (listeners.user) listeners.user();
        if (listeners.globalAlert) listeners.globalAlert();
        if (listeners.broadcast) listeners.broadcast();
        if (listeners.alerts) listeners.alerts();
        if (listeners.coinImg) listeners.coinImg();
        if (listeners.coinRequests) listeners.coinRequests();
        if (listeners.gameOrders) listeners.gameOrders();
        if (listeners.vipPosts) listeners.vipPosts();
        if (listeners.posts) listeners.posts();
        
        listeners = {};
        
        // ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ≥ŸÑÿßŸäÿØÿ±
        if (sliderInterval) {
            clearInterval(sliderInterval);
            sliderInterval = null;
        }
    }

    // --- ÿ®ÿØÿ° ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑŸÜÿ∏ÿßŸÖ ---
    function initSystem() {
        removeAllListeners();
        
        // ŸÖÿ≥ÿ™ŸÖÿπ ÿ≠ÿßŸÑÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ
        listeners.system = db.ref('system/status/last_online').on('value', snap => {
            const lastOnline = snap.val() || 0;
            const isOffline = Date.now() - lastOnline > 420000;
            const offlineGuard = document.getElementById('offline-guard');
            
            if (isOffline) {
                offlineGuard.classList.remove('hidden');
            } else {
                offlineGuard.classList.add('hidden');
            }
        });
        
        // ŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑÿ™ŸÜÿ®ŸäŸá ÿßŸÑÿπÿßŸÖ
        listeners.globalAlert = db.ref('settings/globalAlert').on('value', snap => {
            const msg = snap.val();
            const bar = document.getElementById('dev-alert-bar');
            
            if (msg) {
                bar.style.display = 'block';
                bar.innerHTML = `üì¢ ${escapeHtml(msg)}`;
                if (me && me.role === 'admin') {
                    bar.innerHTML += ' <i class="fas fa-edit" onclick="editDevAlert()" style="cursor:pointer; margin-right:10px;"></i>';
                }
            } else {
                bar.style.display = 'none';
            }
        });
        
        // ŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑÿ®ÿ´ ÿßŸÑÿπÿßŸÖ
        listeners.broadcast = db.ref('settings/broadcast').on('value', snap => {
            const data = snap.val();
            if (data && data.text) {
                const lastMsgId = localStorage.getItem('last_broadcast_id');
                if (lastMsgId != data.id) {
                    Swal.fire({
                        title: 'ÿ±ÿ≥ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖÿ∑Ÿàÿ± üì¢',
                        text: data.text,
                        icon: 'info',
                        background: '#1e293b',
                        color: '#fff'
                    }).then(() => {
                        localStorage.setItem('last_broadcast_id', data.id);
                    });
                }
            }
        });
    }

    // --- ÿ•ÿØÿßÿ±ÿ© ÿ≤ÿ± ÿßŸÑÿ±ÿ¨Ÿàÿπ ---
    function handleBackButton() {
        const currentView = hStack[hStack.length - 1];
        
        if (hStack.length > 1) {
            // ÿ•ÿ∞ÿß ŸÑŸÖ ŸÜŸÉŸÜ ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©ÿå ÿßÿ±ÿ¨ÿπ ÿÆÿ∑Ÿàÿ© Ÿàÿßÿ≠ÿØÿ©
            hStack.pop();
            render(hStack[hStack.length-1]);
        } else if (currentView === 'home') {
            // ÿ•ÿ∞ÿß ŸÉŸÜÿß ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©ÿå ÿßÿπÿ±ÿ∂ ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ£ŸÉŸäÿØ
            Swal.fire({
                title: 'ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿÆÿ±Ÿàÿ¨',
                text: 'ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ£Ÿà ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©ÿü',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ÿÆÿ±Ÿàÿ¨',
                cancelButtonText: 'ÿπŸàÿØÿ© ŸÑŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©',
                background: '#1e293b',
                color: '#fff',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    // ÿßŸÑÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
                    if (isGuest) {
                        location.reload();
                    } else {
                        doLogout();
                    }
                } else {
                    // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ© ŸÅŸÇÿ∑
                    render('home');
                }
            });
        }
    }

    // --- ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ¢ŸÖŸÜ ŸÑŸÑÿµŸÅÿ≠ÿ© ---
    function refreshCurrentPage() {
        const currentView = hStack[hStack.length - 1];
        const now = Date.now();
        
        if (now - lastRefreshTime > 1000) {
            render(currentView);
            lastRefreshTime = now;
        }
    }

    // --- ŸÖÿµÿßÿØŸÇÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ---
    auth.onAuthStateChanged(user => {
        if (user) {
            handleUserLogin(user);
        } else {
            showAuthScreen();
        }
    });

    function handleUserLogin(user) {
        const uid = user.uid;
        
        // ÿ•ÿ≤ÿßŸÑÿ© ÿ£Ÿä ŸÖÿ≥ÿ™ŸÖÿπÿßÿ™ ŸÇÿØŸäŸÖÿ©
        if (listeners.user) listeners.user();
        
        // ŸÖÿ≥ÿ™ŸÖÿπ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        listeners.user = db.ref('users/' + uid).on('value', snap => {
            if (!snap.exists()) {
                createNewUser(user, uid);
                return;
            }
            
            let userData = snap.val();
            
            // ÿ™ÿ≠ÿØŸäÿ´ ÿØŸàÿ± ÿßŸÑÿ£ÿØŸÖŸÜ ÿ•ÿ∞ÿß ŸÑÿ≤ŸÖ ÿßŸÑÿ£ŸÖÿ±
            if (user.email === ADMIN_EMAIL && userData.role !== 'admin') {
                userData.role = 'admin';
                db.ref('users/' + uid).update({ role: 'admin' });
            }
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ≠ÿ∏ÿ±
            if (userData.bannedUntil && userData.bannedUntil > Date.now()) {
                Swal.fire({
                    title: 'ŸÖÿ≠ÿ∏Ÿàÿ±',
                    text: 'ÿ≠ÿ≥ÿßÿ®ŸÉ ŸÖÿ≠ÿ∏Ÿàÿ± ŸÖÿ§ŸÇÿ™ÿßŸã.',
                    icon: 'error',
                    background: '#1e293b',
                    color: '#fff'
                }).then(() => {
                    auth.signOut();
                });
                return;
            }
            
            me = userData;
            me.p = uid;
            
            startApp(uid);
        });
    }

    function createNewUser(user, uid) {
        const newUser = {
            n: user.displayName || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ',
            p: uid,
            email: user.email,
            pic: user.photoURL || userPic,
            sdmBalance: 0,
            rating: 5.0,
            role: (user.email === ADMIN_EMAIL ? 'admin' : 'user'),
            wa: '',
            vipStatus: 'none',
            vipExpiry: 0,
            reportCount: 0,
            verified: true,
            lastSeen: Date.now()
        };
        
        db.ref('users/' + uid).set(newUser).then(() => {
            me = newUser;
            startApp(uid);
        });
    }

    function showAuthScreen() {
        if (!isGuest) {
            removeAllListeners();
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }
    }

    function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider)
            .catch(error => {
                Swal.fire({
                    title: 'ÿÆÿ∑ÿ£',
                    text: error.message,
                    icon: 'error',
                    background: '#1e293b',
                    color: '#fff'
                });
            });
    }

    function doLogout() {
        auth.signOut().then(() => {
            location.reload();
        });
    }

    function enterGuestMode() {
        isGuest = true;
        me = {
            n: 'ÿ≤ÿßÿ¶ÿ±',
            p: 'guest',
            role: 'guest',
            sdmBalance: 0,
            lastSeen: Date.now()
        };
        
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        document.getElementById('u-stars').innerText = "ÿ≤ÿßÿ¶ÿ±";
        
        initSystem();
        render('home');
    }

    // --- ÿ∂ÿ∫ÿ∑ ÿßŸÑÿµŸàÿ± ---
    function compressImage(file) {
        return new Promise((resolve, reject) => {
            if (!file) {
                reject('ŸÑÿß ŸäŸàÿ¨ÿØ ŸÖŸÑŸÅ');
                return;
            }
            
            const reader = new FileReader();
            reader.readAsDataURL(file);
            
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const maxWidth = 800;
                    const maxHeight = 800;
                    
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > height) {
                        if (width > maxWidth) {
                            height = Math.round((height * maxWidth) / width);
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = Math.round((width * maxHeight) / height);
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                
                img.onerror = () => {
                    reject('ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ©');
                };
            };
            
            reader.onerror = () => {
                reject('ŸÅÿ¥ŸÑ ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖŸÑŸÅ');
            };
        });
    }

    async function encode(input, type) {
        if (!input.files || !input.files[0]) return;
        
        try {
            Swal.fire({
                title: 'ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿµŸàÿ±ÿ©...',
                didOpen: () => Swal.showLoading(),
                background: '#1e293b',
                color: '#fff',
                allowOutsideClick: false
            });
            
            const compressed = await compressImage(input.files[0]);
            
            if (type === 'user') {
                userPic = compressed;
                if (me && !isGuest) {
                    db.ref('users/' + me.p).update({ pic: userPic });
                    const profileImg = document.getElementById('profile-img-view');
                    if (profileImg) profileImg.src = userPic;
                }
            } else if (type === 'buy') {
                tempBuyImg = compressed;
            } else {
                tempImg = compressed;
            }
            
            Swal.close();
        } catch (error) {
            Swal.fire({
                title: 'ÿÆÿ∑ÿ£',
                text: 'ŸÅÿ¥ŸÑ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿµŸàÿ±ÿ©',
                icon: 'error',
                background: '#1e293b',
                color: '#fff'
            });
        }
    }

    // --- ÿßŸÑÿ™ŸÜŸÇŸÑ ---
    function checkGuestAccess(view, extra) {
        if (isGuest) {
            Swal.fire({
                title: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÖÿ∑ŸÑŸàÿ®',
                text: 'Ÿáÿ∞Ÿá ÿßŸÑŸÖŸäÿ≤ÿ© ÿ™ÿ™ÿ∑ŸÑÿ® ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿ®ÿßŸÑÿ≠ÿ≥ÿßÿ®',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ',
                cancelButtonText: 'ÿ•ŸÑÿ∫ÿßÿ°',
                background: '#1e293b',
                color: '#fff',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('app-screen').classList.add('hidden');
                    document.getElementById('auth-screen').classList.remove('hidden');
                }
            });
            return;
        }
        
        nav(view, extra);
    }

    function highlightTab(el) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }

    function startApp(uid) {
        isGuest = false;
        hStack = ['home'];
        
        initSystem();
        
        if (me && !me.wa) {
            requestWhatsAppNumber();
        }
        
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        
        render('home');
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ
        db.ref('users/' + uid).update({ lastSeen: Date.now() });
    }

    function requestWhatsAppNumber() {
        Swal.fire({
            title: 'ÿ±ŸÇŸÖ ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ®',
            input: 'tel',
            inputPlaceholder: 'ŸÖÿ´ÿßŸÑ: 249123456789',
            background: '#1e293b',
            color: '#fff',
            showCancelButton: true,
            confirmButtonText: 'ÿ≠ŸÅÿ∏',
            cancelButtonText: 'ŸÑÿßÿ≠ŸÇÿßŸã',
            reverseButtons: true
        }).then(result => {
            if (result.value) {
                db.ref('users/' + me.p).update({ wa: result.value });
            }
        });
    }

    function filterContent(query) {
        query = query.toLowerCase();
        document.querySelectorAll('.post, .card').forEach(item => {
            if (item.classList.contains('admin-item') && (!me || me.role !== 'admin')) {
                item.classList.add('search-hidden');
                return;
            }
            
            const text = item.innerText.toLowerCase();
            if (text.includes(query)) {
                item.classList.remove('hidden', 'search-hidden');
            } else {
                item.classList.add('hidden');
            }
        });
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function nav(view, extra) {
        hStack.push(view);
        render(view, extra);
    }

    function formatDate(timestamp) {
        if (!timestamp) return '';
        
        const date = new Date(timestamp);
        const now = new Date();
        const diff = now - date;
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor(diff / (1000 * 60));
        
        if (days > 7) {
            return date.toLocaleDateString('ar-SA');
        } else if (days > 1) {
            return `ŸÇÿ®ŸÑ ${days} ÿ£ŸäÿßŸÖ`;
        } else if (days === 1) {
            return 'ÿ£ŸÖÿ≥';
        } else if (hours > 1) {
            return `ŸÇÿ®ŸÑ ${hours} ÿ≥ÿßÿπÿ©`;
        } else if (minutes > 1) {
            return `ŸÇÿ®ŸÑ ${minutes} ÿØŸÇŸäŸÇÿ©`;
        } else {
            return 'ÿßŸÑÿ¢ŸÜ';
        }
    }

    function showPostMenu(postId, isVipPost, event) {
        event.stopPropagation();
        
        if (activePostMenu) {
            activePostMenu.classList.remove('active');
        }
        
        const menu = document.getElementById(`post-menu-${postId}`);
        if (menu) {
            menu.classList.add('active');
            activePostMenu = menu;
        }
    }

    async function handlePostAction(action, postId, isVipPost) {
        if (activePostMenu) {
            activePostMenu.classList.remove('active');
            activePostMenu = null;
        }
        
        const postRef = db.ref(isVipPost ? 'vip_posts' : 'posts').child(postId);
        const postSnap = await postRef.once('value');
        const post = postSnap.val();
        
        if (!post) {
            Swal.fire({
                title: 'ÿÆÿ∑ÿ£',
                text: 'ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ',
                icon: 'error',
                background: '#1e293b',
                color: '#fff'
            });
            return;
        }
        
        if (post.uP !== me.p && me.role !== 'admin') {
            Swal.fire({
                title: 'ÿÆÿ∑ÿ£',
                text: 'ŸÑŸäÿ≥ ŸÑÿØŸäŸÉ ÿµŸÑÿßÿ≠Ÿäÿ© ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿπŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿπŸÑÿßŸÜ',
                icon: 'error',
                background: '#1e293b',
                color: '#fff'
            });
            return;
        }
        
        switch(action) {
            case 'edit':
                editPost(postRef, post);
                break;
                
            case 'delete':
                deletePost(postRef);
                break;
                
            case 'sold':
                markAsSold(postRef);
                break;
        }
    }

    async function editPost(postRef, post) {
        const { value: formData } = await Swal.fire({
            title: 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ•ÿπŸÑÿßŸÜ',
            html: `
                <input id="edit-title" class="swal2-input" placeholder="ÿßŸÑÿπŸÜŸàÿßŸÜ" value="${escapeHtml(post.t)}">
                <input id="edit-price" class="swal2-input" type="number" placeholder="ÿßŸÑÿ≥ÿπÿ± (SDM)" value="${post.pr}">
                <textarea id="edit-desc" class="swal2-textarea" placeholder="ÿßŸÑŸàÿµŸÅ" rows="3">${escapeHtml(post.d)}</textarea>
            `,
            background: '#1e293b',
            color: '#fff',
            showCancelButton: true,
            confirmButtonText: 'ÿ≠ŸÅÿ∏',
            cancelButtonText: 'ÿ•ŸÑÿ∫ÿßÿ°',
            reverseButtons: true,
            focusConfirm: false,
            preConfirm: () => {
                const title = document.getElementById('edit-title').value;
                const price = document.getElementById('edit-price').value;
                const desc = document.getElementById('edit-desc').value;
                
                if (!title || !price) {
                    Swal.showValidationMessage('Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©');
                    return false;
                }
                
                return { title, price: parseFloat(price), desc };
            }
        });
        
        if (formData) {
            await postRef.update({
                t: formData.title,
                pr: formData.price,
                d: formData.desc,
                updatedAt: Date.now()
            });
            
            Swal.fire({
                title: 'ÿ™ŸÖ',
                text: 'ÿ™ŸÖ ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿ®ŸÜÿ¨ÿßÿ≠',
                icon: 'success',
                background: '#1e293b',
                color: '#fff'
            });
            
            refreshCurrentPage();
        }
    }

    async function deletePost(postRef) {
        const { isConfirmed } = await Swal.fire({
            title: 'ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∞ŸÅ',
            text: 'ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿπŸÑÿßŸÜÿü',
            icon: 'warning',
            background: '#1e293b',
            color: '#fff',
            showCancelButton: true,
            confirmButtonText: 'ŸÜÿπŸÖÿå ÿßÿ≠ÿ∞ŸÅ',
            cancelButtonText: 'ÿ•ŸÑÿ∫ÿßÿ°',
            reverseButtons: true,
            confirmButtonColor: '#ef4444'
        });
        
        if (isConfirmed) {
            await postRef.remove();
            
            Swal.fire({
                title: 'ÿ™ŸÖ',
                text: 'ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑÿ•ÿπŸÑÿßŸÜ ÿ®ŸÜÿ¨ÿßÿ≠',
                icon: 'success',
                background: '#1e293b',
                color: '#fff'
            });
            
            refreshCurrentPage();
        }
    }

    async function markAsSold(postRef) {
        const { isConfirmed } = await Swal.fire({
            title: 'ÿ™ŸÖ ÿßŸÑÿ®Ÿäÿπ',
            text: 'ŸáŸÑ ÿ™ÿ±ŸäÿØ Ÿàÿ∂ÿπ ÿπŸÑÿßŸÖÿ© "ÿ™ŸÖ ÿßŸÑÿ®Ÿäÿπ" ÿπŸÑŸâ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿπŸÑÿßŸÜÿü',
            icon: 'question',
            background: '#1e293b',
            color: '#fff',
            showCancelButton: true,
            confirmButtonText: 'ŸÜÿπŸÖ',
            cancelButtonText: 'ÿ•ŸÑÿ∫ÿßÿ°',
            reverseButtons: true
        });
        
        if (isConfirmed) {
            await postRef.update({
                status: 'sold',
                soldAt: Date.now()
            });
            
            Swal.fire({
                title: 'ÿ™ŸÖ',
                text: 'ÿ™ŸÖ Ÿàÿ∂ÿπ ÿπŸÑÿßŸÖÿ© "ÿ™ŸÖ ÿßŸÑÿ®Ÿäÿπ"',
                icon: 'success',
                background: '#1e293b',
                color: '#fff'
            });
            
            refreshCurrentPage();
        }
    }

    // --- ÿßŸÑÿ™ŸÇÿØŸäŸÖ ---
    function render(view, extra) {
        const area = document.getElementById('content-area');
        const adminArea = document.getElementById('admin-notifications-area');
        const searchEl = document.getElementById('main-search');
        
        // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©
        removeAllListeners();
        
        // ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ≥ŸÑÿßŸäÿØÿ±
        if (sliderInterval) {
            clearInterval(sliderInterval);
            sliderInterval = null;
        }
        
        if (view !== 'home') {
            adminArea.innerHTML = "";
        }
        
        showWelcome();
        
        if (me) {
            document.getElementById('u-stars').innerText = isGuest ? "ÿ≤ÿßÿ¶ÿ±" : (me.rating || 0).toFixed(1);
        }
        
        const titles = {
            'home': 'ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©',
            'wallet': 'ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ©',
            'games': 'ÿßŸÑÿ£ŸÑÿπÿßÿ®',
            'vip': 'VIP',
            'profile': 'ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ¥ÿÆÿµŸä'
        };
        
        document.getElementById('head-title').innerText = titles[view] || 'ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©';
        searchEl.classList.remove('search-hidden');
        
        lastRefreshTime = Date.now();

        switch(view) {
            case 'home':
                renderHome(area);
                break;
            case 'sub':
                renderSub(area, extra);
                break;
            case 'feed':
                renderFeed(area, extra);
                break;
            case 'wallet':
                renderWallet(area);
                break;
            case 'games':
                renderGames(area);
                break;
            case 'vip':
                renderVip(area);
                break;
            case 'profile':
                renderProfile(area, extra);
                break;
        }
    }

    function renderHome(area) {
        // ŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™
        listeners.settings = db.ref('settings').on('value', snap => {
            const s = snap.val() || {};
            const finalSliderImages = (s.sliderImages && s.sliderImages.length >= 3) ? s.sliderImages : sliderImages;
            
            area.innerHTML = `
                <div class="slider-container">
                    <img id="slider-img" src="${finalSliderImages[0]}" alt="ÿ≥ŸÑÿßŸäÿØÿ±">
                    <div class="slider-overlay">
                        <h3 style="margin:0; color:white;">SDM Market ÿßŸÑŸÖÿ≥ÿ™ŸÇÿ®ŸÑ</h3>
                    </div>
                    <div class="slider-dots">
                        <div class="dot active" id="dot-0"></div>
                        <div class="dot" id="dot-1"></div>
                        <div class="dot" id="dot-2"></div>
                    </div>
                    ${(!isGuest && me && me.role === 'admin') ? 
                        `<div class="edit-slider-btn" onclick="updateCurrentSliderImg()">‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ</div>` : ''}
                </div>
                ${(!isGuest && me && me.role === 'admin') ? `
                <button class="btn-main" style="background:#6f42c1; margin:10px 20px; width:calc(100% - 40px);" onclick="sendBroadcastMessage()">
                    üì¢ ŸÜÿ¥ÿ± ÿ±ÿ≥ÿßŸÑÿ© ÿπÿßŸÖÿ©
                </button>` : ''}
                <h3 style="padding:0 20px; margin-bottom:0;">ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ</h3>
                <div class="grid">
                    ${Object.keys(cats).map(k => {
                        const ci = (s.categories && s.categories[k]) ? s.categories[k].img : null;
                        const editBtn = (!isGuest && me && me.role === 'admin') ? 
                            `<div class="edit-cat-btn" onclick="event.stopPropagation(); updateCategoryImg('${k}')">
                                <i class="fas fa-edit"></i>
                            </div>` : '';
                        return `
                            <div class="card" onclick="nav('sub','${k}')">
                                ${editBtn}
                                ${ci ? `<img src="${ci}" class="cat-custom-img" alt="${k}">` : `<i class="fas fa-${cats[k].i}"></i>`}
                                <b>${k}</b>
                            </div>
                        `;
                    }).join('')}
                </div>
                <h3 style="padding:0 20px; margin-top:10px;">ÿ£ÿ≠ÿØÿ´ VIP ÿßŸÑŸÖŸÖŸäÿ≤ÿ© üíé</h3>
                <div id="vip-home-list" style="padding-bottom:20px;"></div>`;
            
            if (s.sliderImages && s.sliderImages.length >= 3) {
                sliderImages = s.sliderImages;
            }
            
            startSlider();
            loadPosts('vip_posts', null, 'vip-home-list', true);
            
            if (me && me.role === 'admin') {
                listenForAdminTasks();
            }
        });
    }

    function renderSub(area, extra) {
        curC = extra || curC;
        area.innerHTML = `
            <div style="padding:15px;">
                <h2 style="color:var(--neon-blue)">${curC}</h2>
            </div>
            <div class="grid">
                ${cats[curC].s.map(s => `
                    <div class="card" onclick="nav('feed','${s}')">
                        <b>${s}</b>
                    </div>
                `).join('')}
            </div>`;
    }

    function renderFeed(area, extra) {
        curS = extra || curS;
        area.innerHTML = `
            ${!isGuest ? `
            <div class="post" style="padding:20px;">
                <h4 style="margin-top:0; color:var(--primary)">üìù ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿπŸÑÿßŸÜ: ${curS}</h4>
                <input id="pt" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÜÿ™ÿ¨">
                <input id="pp" type="number" placeholder="ÿßŸÑÿ≥ÿπÿ± (SDM)">
                <textarea id="pd" placeholder="ŸàÿµŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨..." rows="3"></textarea>
                <label class="btn-main" style="background:#334155; display:block; text-align:center; margin-top:10px;">
                    <i class="fas fa-camera"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿµŸàÿ±ÿ©
                    <input type="file" hidden accept="image/*" onchange="encode(this, 'post')">
                </label>
                <button class="btn-main" onclick="publish('posts')">ŸÜÿ¥ÿ± ÿßŸÑÿ•ÿπŸÑÿßŸÜ</button>
            </div>` : ''}
            <div id="posts-list"></div>`;
        
        loadPosts('posts', curS, 'posts-list', false);
    }

    function renderWallet(area) {
        // ŸÖÿ≥ÿ™ŸÖÿπ ÿµŸàÿ±ÿ© ÿßŸÑÿπŸÖŸÑÿ©
        listeners.coinImg = db.ref('settings/coinImg').on('value', snap => {
            const ci = snap.val() || sdmCoinImage;
            
            area.innerHTML = `
                <div class="wallet-card">
                    <img src="${ci}" class="sdm-logo" alt="SDM Coin">
                    <h1 style="font-size:36px; margin:15px 0;">
                        ${me ? me.sdmBalance.toFixed(2) : '0.00'} 
                        <span style="font-size:16px; color:var(--text-sec)">SDM</span>
                    </h1>
                    <p style="font-size:12px; color:var(--accent);">1 SDM = ${SDM_RATE} ÿ¨ŸÜŸäŸá</p>
                    <div style="display:flex; gap:10px; justify-content:center;">
                        <button class="btn-main" style="background:var(--neon-blue); color:black; width:auto; padding:10px 30px;" onclick="showTransfer()">
                            ÿ•ÿ±ÿ≥ÿßŸÑ <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <div style="padding:20px;">
                    <h3>ÿ¥ÿ±ÿßÿ° ÿπŸÖŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖÿ∑Ÿàÿ±</h3>
                    <div class="post" style="padding:20px;">
                        <p style="color:var(--text-sec)">ÿ®ŸÜŸÉ ÿßŸÑÿÆÿ±ÿ∑ŸàŸÖ: <b style="color:white; font-size:18px;">4426148</b> (ŸÖÿ≠ŸÖÿØ)</p>
                        <label style="font-size:12px;">ÿ£ÿØÿÆŸÑ ÿßŸÑŸÉŸÖŸäÿ© (SDM)</label>
                        <input id="buy-qty" type="number" placeholder="ŸÖÿ´ŸÑÿßŸã: 5" oninput="calcBuyCost(this.value)">
                        <div style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; margin:10px 0; text-align:center;">
                            ÿßŸÑŸÖÿ∑ŸÑŸàÿ® ÿØŸÅÿπŸá: <b id="buy-cost-display" style="color:var(--green); font-size:18px;">0</b> ÿ¨ŸÜŸäŸá
                        </div>
                        <label class="btn-main" style="background:#334155; display:block; text-align:center;">
                            <i class="fas fa-receipt"></i> ÿ•ÿ±ŸÅÿßŸÇ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                            <input type="file" hidden accept="image/*" onchange="encode(this, 'buy')">
                        </label>
                        <button class="btn-main" onclick="requestCoins()">ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ∑ŸÑÿ®</button>
                    </div>
                    <h3>ÿ≥ÿ¨ŸÑ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™</h3>
                    <div id="transactions-history" style="background:var(--bg-card); padding:10px; border-radius:15px; max-height:200px; overflow-y:auto;">
                        ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...
                    </div>
                </div>`;
            
            loadTransactions();
        });
    }

    function renderGames(area) {
        area.innerHTML = `
            <div class="post" style="padding:20px; text-align:center;">
                <i class="fas fa-bolt" style="font-size:50px; color:var(--neon-blue); margin-bottom:20px;"></i>
                <h2 style="margin:0;">ÿ¥ÿ≠ŸÜ ŸÅŸàÿ±Ÿä</h2>
                <select id="active-game" onchange="loadCorrectPacks()">
                    <option value="pubg">ÿ®ÿ®ÿ¨Ÿä (PUBG Mobile)</option>
                    <option value="ff">ŸÅÿ±Ÿä ŸÅÿßŸäÿ± (Free Fire)</option>
                </select>
                <input type="text" id="p-id-input" placeholder="ID ÿßŸÑŸÑÿßÿπÿ®">
                <select id="p-pack-input" onchange="calculateGameCost(this)"></select>
                <div class="calc-box" style="margin-top:10px;">
                    <span style="font-size:12px; color:var(--text-sec)">ÿßŸÑÿ™ŸÉŸÑŸÅÿ© ÿ®ÿßŸÑÿ¨ŸÜŸäŸá</span>
                    <span id="game-cost-res" class="calc-result">0 SDG</span>
                </div>
                <button class="btn-main" onclick="sendOrderToDeveloper()">üöÄ ÿ¥ÿ≠ŸÜ ÿßŸÑÿ¢ŸÜ</button>
            </div>
            <div style="padding:20px;">
                <h3>ÿ≥ÿ¨ŸÑ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™</h3>
                <div id="game-history">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>
            </div>
            ${(me && me.role === "admin") ? `
            <div id="developer-area" class="admin-panel">
                <h3>ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑÿ£ŸÑÿπÿßÿ® (ŸÑŸàÿ≠ÿ© ÿßŸÑŸÖÿ∑Ÿàÿ±)</h3>
                <div id="orders-list-container"></div>
            </div>` : ''}`;
        
        loadCorrectPacks();
        loadGameHistory();
        
        if (me && me.role === "admin") {
            initDeveloperLogic();
        }
    }

    function renderVip(area) {
        const isVip = me && me.vipStatus === 'active';
        const vipExpiry = me && me.vipExpiry ? new Date(me.vipExpiry) : null;
        
        area.innerHTML = `
            <div style="text-align:center; padding:30px;">
                <i class="fas fa-crown" style="font-size:60px; color:var(--accent); margin-bottom:20px;"></i>
                <h2>ÿßÿ¥ÿ™ÿ±ÿßŸÉ VIP</h2>
                <p style="color:var(--text-sec)">
                    ${isVip && vipExpiry ? 
                        `ÿ£ŸÜÿ™ ŸÖÿ¥ÿ™ÿ±ŸÉ ÿ≠ÿ™Ÿâ: ${vipExpiry.toLocaleDateString('ar-SA')}` : 
                        'ÿ™ŸÖŸäÿ≤ Ÿàÿßÿ≠ÿµŸÑ ÿπŸÑŸâ ÿπŸÑÿßŸÖÿ© ÿßŸÑÿ™ÿßÿ¨ ŸàŸÜÿ¥ÿ± ÿ∫Ÿäÿ± ŸÖÿ≠ÿØŸàÿØ'}
                </p>
                ${!isVip ? `
                <div class="grid">
                    <div class="card" onclick="buyVip(1, 1)" style="border-color:var(--text-sec)">
                        <h1 style="color:white">1</h1>
                        <p>ŸäŸàŸÖ</p>
                        <b>1 SDM</b>
                    </div>
                    <div class="card" onclick="buyVip(7, 7)" style="border-color:var(--neon-blue)">
                        <h1 style="color:var(--neon-blue)">7</h1>
                        <p>ÿ£ŸäÿßŸÖ</p>
                        <b>7 SDM</b>
                    </div>
                    <div class="card" onclick="buyVip(30, 30)" style="border-color:var(--accent)">
                        <h1 style="color:var(--accent)">30</h1>
                        <p>ŸäŸàŸÖ</p>
                        <b>30 SDM</b>
                    </div>
                </div>` : 
                '<div class="card" style="border-color:var(--accent); color:var(--accent)"><h3>ÿßŸÑÿßÿ¥ÿ™ÿ±ÿßŸÉ ŸÜÿ¥ÿ∑ ‚úÖ</h3></div>'}
            </div>
            ${isVip ? `
            <div class="post" style="padding:20px;">
                <h4>ŸÜÿ¥ÿ± VIP ŸÖŸÖŸäÿ≤ ŸÖÿπ ÿ™ÿÆŸÅŸäÿ∂</h4>
                <input id="v-t" placeholder="ÿßŸÑÿπŸÜŸàÿßŸÜ">
                <input id="v-pr" type="number" placeholder="ÿßŸÑÿ≥ÿπÿ± ÿßŸÑÿ£ÿµŸÑŸä (SDM)">
                <div style="display:flex; align-items:center; gap:10px;">
                    <input id="v-dis" type="number" placeholder="ŸÜÿ≥ÿ®ÿ© ÿßŸÑÿ™ÿÆŸÅŸäÿ∂ % (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä)" style="border:1px solid var(--accent)">
                </div>
                <textarea id="v-d" placeholder="ÿßŸÑŸàÿµŸÅ"></textarea>
                <label class="btn-main" style="background:#334155; display:block; text-align:center; margin-top:10px;">
                    <i class="fas fa-camera"></i> ÿ•ÿ∂ÿßŸÅÿ© ÿµŸàÿ±ÿ©
                    <input type="file" hidden accept="image/*" onchange="encode(this, 'post')">
                </label>
                <button class="btn-main" onclick="publish('vip_posts')">ŸÜÿ¥ÿ± VIP</button>
            </div>` : ''}`;
    }

    function renderProfile(area, extra) {
        const uid = extra || (me ? me.p : '');
        if (!uid) return;
        
        db.ref('users/' + uid).once('value', snap => {
            const u = snap.val();
            if (!u) return;
            
            const isMe = (me && me.p === uid);
            const isOnline = (Date.now() - (u.lastSeen || 0)) < 300000;
            
            area.innerHTML = `
            <div style="text-align:center; padding:40px 20px;">
                <div style="position:relative; display:inline-block;">
                    <img src="${u.pic || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" 
                         id="profile-img-view" 
                         style="width:120px; height:120px; border-radius:50%; border:3px solid var(--neon-blue); padding:3px; object-fit:cover;">
                    ${isOnline ? 
                        '<div style="position:absolute; bottom:5px; right:5px; width:20px; height:20px; background:#10b981; border:3px solid #0f172a; border-radius:50%;"></div>' : 
                        ''}
                </div>
                ${isMe ? '<br><label style="color:var(--accent); cursor:pointer; font-size:12px;">ÿ™ÿ∫ŸäŸäÿ± ÿßŸÑÿµŸàÿ±ÿ© <input type="file" accept="image/*" onchange="encode(this, \'user\')" style="display:none"></label>' : ''}
                <h2 style="margin:10px 0;">
                    ${escapeHtml(u.n)} 
                    ${u.vipStatus === 'active' ? '<i class="fas fa-crown" style="color:var(--accent)"></i>' : ''}
                </h2>
                <p style="font-size:12px; color:var(--text-sec);">
                    ${isOnline ? '<span class="online-dot"></span> ŸÖÿ™ÿµŸÑ ÿßŸÑÿ¢ŸÜ' : 'ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ'}
                </p>
                <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;">
                    <span class="badge badge-gold">‚≠ê ${(u.rating||5).toFixed(1)}</span>
                    ${u.role === 'admin' ? '<span class="badge badge-admin">Admin</span>' : ''}
                </div>
                ${isMe ? `
                <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:10px; margin-bottom:20px;">
                    <p style="margin:0; font-size:12px; color:var(--text-sec)">ID ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ</p>
                    <code style="font-size:16px; display:block; margin:5px 0;">${u.p}</code>
                    <button onclick="navigator.clipboard.writeText('${u.p}'); Swal.fire({title: \'ÿ™ŸÖ ÿßŸÑŸÜÿ≥ÿÆ\', icon: \'success\', background: \'#1e293b\', color: \'#fff\'})" 
                            style="background:transparent; border:1px solid var(--border); color:white; border-radius:5px; padding:5px 10px;">
                        ŸÜÿ≥ÿÆ
                    </button>
                </div>
                <button class="btn-main" style="background:rgba(239, 68, 68, 0.2); color:#ef4444; border:1px solid #ef4444;" onclick="doLogout()">
                    ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨
                </button>` : 
                `<button class="btn-main" style="background:var(--accent); color:black;" onclick="rateUser('${uid}')">
                    ‚≠ê ÿ™ŸÇŸäŸäŸÖ ÿßŸÑÿ®ÿßÿ¶ÿπ
                </button>
                <button class="btn-main" style="background:var(--red); color:white; margin-top:5px;" onclick="reportUser('${uid}')">
                    üö© ÿ•ÿ®ŸÑÿßÿ∫
                </button>`}
            </div>`;
        });
    }

    // --- ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ---
    function loadPosts(path, subFilter, containerId, isVipList = false) {
        // ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑŸÇÿØŸäŸÖ ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
        if (listeners[path]) listeners[path]();
        
        listeners[path] = db.ref(path).limitToLast(30).on('value', snap => {
            const list = document.getElementById(containerId);
            if (!list) return;
            
            list.innerHTML = "";
            const posts = [];
            
            snap.forEach(child => {
                const post = child.val();
                post.id = child.key;
                posts.unshift(post); // ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã
            });
            
            posts.forEach(p => {
                if (subFilter && p.sub !== subFilter) return;
                
                // ÿ™ÿÆÿ∑Ÿä ŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ VIP ÿßŸÑŸÖŸÜÿ™ŸáŸäÿ©
                if (isVipList && p.vExpiry && p.vExpiry < Date.now()) {
                    return;
                }
                
                const priceDisplay = p.discount > 0 ? 
                    `<span class="discount-tag">ÿÆÿµŸÖ ${p.discount}%</span> 
                     <b>${(p.pr - (p.pr * (p.discount/100))).toFixed(1)} SDM</b> 
                     <span class="old-price">${p.pr}</span>` :
                    `<b>${p.pr} SDM</b>`;
                
                const isOnline = (Date.now() - (p.uLastSeen || 0)) < 300000;
                const showMenu = !isGuest && me && (me.p === p.uP || me.role === 'admin');
                
                list.innerHTML += `
                    <div class="post" id="post-${p.id}">
                        ${p.status === 'sold' ? '<div class="sold-overlay">ÿ™ŸÖ ÿßŸÑÿ®Ÿäÿπ</div>' : ''}
                        <div class="post-img-container">
                            <img src="${p.img || sdmCoinImage}" style="width:100%; height:100%; object-fit:cover;" alt="${escapeHtml(p.t)}">
                            ${showMenu ? `
                            <button class="post-menu-btn" onclick="showPostMenu('${p.id}', ${isVipList}, event)">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <div class="post-menu" id="post-menu-${p.id}">
                                <div class="post-menu-item" onclick="handlePostAction('edit', '${p.id}', ${isVipList})">
                                    <i class="fas fa-edit"></i> ÿ™ÿπÿØŸäŸÑ
                                </div>
                                <div class="post-menu-item" onclick="handlePostAction('sold', '${p.id}', ${isVipList})">
                                    <i class="fas fa-check-circle"></i> ÿ™ŸÖ ÿßŸÑÿ®Ÿäÿπ
                                </div>
                                <div class="post-menu-item delete" onclick="handlePostAction('delete', '${p.id}', ${isVipList})">
                                    <i class="fas fa-trash"></i> ÿ≠ÿ∞ŸÅ
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        <div style="padding:15px;">
                            <div class="post-info">
                                <div class="post-date">
                                    <i class="far fa-clock"></i>
                                    ${formatDate(p.date)}
                                </div>
                                ${isVipList ? '<span class="vip-badge"><i class="fas fa-crown"></i> VIP</span>' : ''}
                            </div>
                            <h3 style="margin:5px 0;">${escapeHtml(p.t)}</h3>
                            <div style="font-size:16px; margin-bottom:5px;">${priceDisplay}</div>
                            <p style="font-size:13px; color:var(--text-sec);">${escapeHtml(p.d || '')}</p>
                            <div style="display:flex; align-items:center; gap:10px; margin-top:10px; border-top:1px solid var(--border); padding-top:10px;">
                                <img src="${p.uPic || userPic}" 
                                     style="width:30px; height:30px; border-radius:50%; cursor:pointer;" 
                                     onclick="nav('profile','${p.uP}')"
                                     alt="${escapeHtml(p.uN)}">
                                <span style="font-size:12px; cursor:pointer;" onclick="nav('profile','${p.uP}')">
                                    ${escapeHtml(p.uN)} 
                                    ${isOnline ? '<span class="online-dot"></span>' : ''}
                                </span>
                                <div style="flex:1"></div>
                                ${p.wa ? `
                                <a href="https://wa.me/${p.wa}" target="_blank" style="color:#25d366; font-size:20px;">
                                    <i class="fab fa-whatsapp"></i>
                                </a>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (list.innerHTML === "") {
                list.innerHTML = `
                    <div style="text-align:center; padding:20px; color:var(--text-sec);">
                        <i class="fas fa-box-open" style="font-size:40px; margin-bottom:10px;"></i>
                        <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿπŸÑÿßŸÜÿßÿ™</p>
                    </div>
                `;
            }
        });
    }

    // --- ŸÜÿ¥ÿ± ÿßŸÑŸÖŸÜÿ¥Ÿàÿ±ÿßÿ™ ---
    function publish(path) {
        if (isGuest) return checkGuestAccess();
        
        let titleInput, priceInput, descInput, discountInput;
        
        if (path === 'vip_posts') {
            titleInput = document.getElementById('v-t');
            priceInput = document.getElementById('v-pr');
            descInput = document.getElementById('v-d');
            discountInput = document.getElementById('v-dis');
        } else {
            titleInput = document.getElementById('pt');
            priceInput = document.getElementById('pp');
            descInput = document.getElementById('pd');
        }
        
        const title = titleInput ? titleInput.value.trim() : '';
        const price = priceInput ? parseFloat(priceInput.value) : 0;
        const desc = descInput ? descInput.value.trim() : '';
        const discount = discountInput ? parseFloat(discountInput.value) || 0 : 0;
        
        if (!title || !price || !tempImg) {
            Swal.fire({
                title: 'ÿ™ŸÜÿ®ŸäŸá',
                text: 'Ÿäÿ±ÿ¨Ÿâ ÿ™ÿπÿ®ÿ¶ÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßŸÑÿµŸàÿ±ÿ©',
                icon: 'warning',
                background: '#1e293b',
                color: '#fff'
            });
            return;
        }
        
        if (price <= 0) {
            Swal.fire({
                title: 'ÿÆÿ∑ÿ£',
                text: 'ÿßŸÑÿ≥ÿπÿ± Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ£ŸÉÿ®ÿ± ŸÖŸÜ ÿµŸÅÿ±',
                icon: 'error',
                background: '#1e293b',
                color: '#fff'
            });
            return;
        }
        
        const postData = {
            t: title,
            pr: price,
            d: desc,
            discount: discount,
            img: tempImg,
            uP: me.p,
            uN: me.n,
            uPic: me.pic || userPic,
            wa: me.wa || '',
            uStars: me.rating || 5.0,
            date: Date.now(),
            status: 'active',
            uLastSeen: me.lastSeen || Date.now()
        };
        
        if (path === 'posts') {
            postData.sub = curS;
        } else if (path === 'vip_posts') {
            postData.vExpiry = me.vipExpiry || Date.now() + (30 * 24 * 60 * 60 * 1000);
        }
        
        db.ref(path).push(postData)
            .then(() => {
                Swal.fire({
                    title: 'ÿ™ŸÖ ÿßŸÑŸÜÿ¥ÿ±',
                    text: 'ÿ•ÿπŸÑÿßŸÜŸÉ ÿ£ÿµÿ®ÿ≠ ŸÖÿ™ÿßÿ≠ÿßŸã ÿßŸÑÿ¢ŸÜ',
                    icon: 'success',
                    background: '#1e293b',
                    color: '#fff'
                });
                
                // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑÿ≠ŸÇŸàŸÑ
                tempImg = '';
                if (titleInput) titleInput.value = '';
                if (priceInput) priceInput.value = '';
                if (descInput) descInput.value = '';
                if (discountInput) discountInput.value = '';
                
                if (path === 'vip_posts') {
                    nav('home');
                } else {
                    render('feed', curS);
                }
            })
            .catch(error => {
                Swal.fire({
                    title: 'ÿÆÿ∑ÿ£',
                    text: 'ŸÅÿ¥ŸÑ ŸÜÿ¥ÿ± ÿßŸÑÿ•ÿπŸÑÿßŸÜ: ' + error.message,
                    icon: 'error',
                    background: '#1e293b',
                    color: '#fff'
                });
            });
    }

    // --- ÿßŸÑŸÖÿ≠ŸÅÿ∏ÿ© ---
    function requestCoins() {
        const qtyInput = document.getElementById('buy-qty');
        const qty = parseFloat(qtyInput ? qtyInput.value : 0);
        
        if (!qty || qty <= 0 || !tempBuyImg) {
            Swal.fire({
                title: 'ÿ™ŸÜÿ®ŸäŸá',
                text: 'ŸÖÿ∑ŸÑŸàÿ® ÿßŸÑŸÉŸÖŸäÿ© ŸàÿµŸàÿ±ÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±',
                icon: 'warning',
                background: '#1e293b',
                color: '#fff'
            });
            return;
        }
        
        db.ref('coin_requests').push({
            uP: me.p,
            uN: me.n,
            qty: qty,
            img: tempBuyImg,
            status: 'pending',
            date: Date.now()
        });
        
        Swal.fire({
            title: 'ÿ™ŸÖ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ',
            text: 'ÿ≥ŸäŸÇŸàŸÖ ÿßŸÑŸÖÿ¥ÿ±ŸÅ ÿ®ÿßŸÑŸÖÿ±ÿßÿ¨ÿπÿ©',
            icon: 'success',
            background: '#1e293b',
            color: '#fff'
        });
        
        tempBuyImg = '';
        if (qtyInput) qtyInput.value = '';
        document.getElementById('buy-cost-display').innerText = '0';
    }

    function loadTransactions() {
        if (!me || isGuest) return;
        
        const historyDiv = document.getElementById('transactions-history');
        if (!historyDiv) return;
        
        // ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπÿßÿ™ ÿßŸÑŸÇÿØŸäŸÖÿ©
        if (listeners.transactionsFrom) listeners.transactionsFrom();
        if (listeners.transactionsTo) listeners.transactionsTo();
        
        historyDiv.innerHTML = '<div style="text-align:center; padding:10px; color:var(--text-sec)">ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>';
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™ ÿßŸÑŸÖÿ±ÿ≥ŸÑÿ©
        listeners.transactionsFrom = db.ref('transactions')
            .orderByChild('from')
            .equalTo(me.p)
            .limitToLast(10)
            .on('value', snap => {
                updateTransactionList(snap, 'from');
            });
        
        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖÿ©
        listeners.transactionsTo = db.ref('transactions')
            .orderByChild('to')
            .equalTo(me.p)
            .limitToLast(10)
            .on('value', snap => {
                updateTransactionList(snap, 'to');
            });
    }

    function updateTransactionList(snap, type) {
        const historyDiv = document.getElementById('transactions-history');
        if (!historyDiv) return;
        
        let html = '';
        const transactions = [];
        
        snap.forEach(child => {
            const txn = child.val();
            txn.id = child.key;
            txn.type = type;
            transactions.push(txn);
        });
        
        // ÿ™ÿ±ÿ™Ÿäÿ® ŸÖŸÜ ÿßŸÑÿ£ÿ≠ÿØÿ´ ŸÑŸÑÿ£ŸÇÿØŸÖ
        transactions.sort((a, b) => b.date - a.date);
        
        transactions.forEach(txn => {
            const amount = txn.amount || 0;
            const date = formatDate(txn.date);
            const isOutgoing = txn.type === 'from';
            const color = isOutgoing ? 'var(--red)' : 'var(--green)';
            const sign = isOutgoing ? '-' : '+';
            const description = txn.description || (isOutgoing ? 'ÿ™ÿ≠ŸàŸäŸÑ' : 'ÿßÿ≥ÿ™ŸÑÿßŸÖ');
            
            html += `
                <div style="padding:10px; border-bottom:1px solid var(--border); font-size:12px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div>${description}</div>
                        <div style="color:var(--text-sec); font-size:10px;">${date}</div>
                    </div>
                    <span style="color:${color}; font-weight:bold;">${sign}${amount.toFixed(2)}</span>
                </div>
            `;
        });
        
        if (historyDiv.innerHTML.includes('ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ')) {
            historyDiv.innerHTML = html || '<div style="text-align:center; padding:20px; color:var(--text-sec)">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿπÿßŸÖŸÑÿßÿ™</div>';
        } else if (html) {
            historyDiv.innerHTML += html;
        }
    }

    // --- ÿßŸÑÿ£ŸÑÿπÿßÿ® ---
    function loadCorrectPacks() {
        const gameSelect = document.getElementById('active-game');
        const packSelect = document.getElementById('p-pack-input');
        
        if (!gameSelect || !packSelect) return;
        
        const game = gameSelect.value;
        const rates = officialRates[game] || [];
        
        packSelect.innerHTML = rates.map(rate => 
            `<option value="${rate.sdm}">${rate.name} (${rate.sdm} SDM)</option>`
        ).join('');
        
        calculateGameCost(packSelect);
    }

    function sendOrderToDeveloper() {
        if (isGuest) return checkGuestAccess('games');
        
        const gameSelect = document.getElementById('active-game');
        const playerIdInput = document.getElementById('p-id-input');
        const packSelect = document.getElementById('p-pack-input');
        
        if (!gameSelect || !playerIdInput || !packSelect) return;
        
        const game = gameSelect.value;
        const playerId = playerIdInput.value.trim();
        const cost = parseFloat(packSelect.value);
        const packageName = packSelect.options[packSelect.selectedIndex].text;
        
        if (!playerId) {
            Swal.fire({
                title: 'ÿÆÿ∑ÿ£',
                text: 'ÿ£ÿØÿÆŸÑ ÿßŸÑÿ¢ŸäÿØŸä',
                icon: 'error',
                background: '#1e293b',
                color: '#fff'
            });
            return;
        }
        
        if (me.sdmBalance < cost) {
            Swal.fire({
                title: 'ÿÆÿ∑ÿ£',
                text: 'ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅ',
                icon: 'error',
                background: '#1e293b',
                color: '#fff'
            });
            return;
        }
        
        db.ref('game_orders').push({
            uP: me.p,
            uN: me.n,
            gameType: game,
            playerId: playerId,
            package: packageName,
            cost: cost,
            status: 'pending',
            date: Date.now()
        });
        
        Swal.fire({
            title: 'ÿ™ŸÖ ÿßŸÑÿ∑ŸÑÿ®',
            text: 'ÿ¨ÿßÿ±Ÿä ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©...',
            icon: 'success',
            background: '#1e293b',
            color: '#fff'
        });
        
        playerIdInput.value = '';
    }

    function loadGameHistory() {
        if (isGuest || !me) return;
        
        const historyDiv = document.getElementById('game-history');
        if (!historyDiv) return;
        
        // ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑŸÇÿØŸäŸÖ
        if (listeners.gameHistory) listeners.gameHistory();
        
        listeners.gameHistory = db.ref('game_orders')
            .orderByChild('uP')
            .equalTo(me.p)
            .limitToLast(5)
            .on('value', snap => {
                historyDiv.innerHTML = '';
                const orders = [];
                
                snap.forEach(child => {
                    const order = child.val();
                    order.id = child.key;
                    orders.unshift(order); // ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã
                });
                
                orders.forEach(order => {
                    const statusIcon = order.status === 'done' ? '‚úÖ' : 
                                     order.status === 'rejected' ? '‚ùå' : '‚è≥';
                    const date = formatDate(order.date);
                    
                    historyDiv.innerHTML += `
                        <div style="background:rgba(255,255,255,0.05); padding:10px; margin-bottom:5px; border-radius:10px;">
                            <div style="display:flex; justify-content:space-between;">
                                <span>${order.gameType}</span>
                                <span>${statusIcon}</span>
                            </div>
                            <div style="color:var(--text-sec); font-size:11px; margin-top:5px;">
                                ${order.package} | ${date}
                            </div>
                        </div>
                    `;
                });
                
                if (orders.length === 0) {
                    historyDiv.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-sec)">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™</div>';
                }
            });
    }

    function buyVip(days, cost) {
        if (isGuest) return checkGuestAccess('vip');
        
        if (me.sdmBalance < cost) {
            Swal.fire({
                title: 'ŸÅÿ¥ŸÑ',
                text: 'ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅ',
                icon: 'error',
                background: '#1e293b',
                color: '#fff'
            });
            return;
        }
        
        db.ref('game_orders').push({
            uP: me.p,
            uN: me.n,
            gameType: 'VIP_SUB',
            playerId: me.p,
            package: `${days} ŸäŸàŸÖ`,
            cost: cost,
            status: 'pending',
            date: Date.now()
        });
        
        Swal.fire({
            title: 'ÿ™ŸÖ ÿßŸÑÿ∑ŸÑÿ®',
            text: 'ÿßŸÜÿ™ÿ∏ÿ± ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ£ÿØŸÖŸÜ',
            icon: 'success',
            background: '#1e293b',
            color: '#fff'
        });
    }

    function calculateGameCost(selectElement) {
        const resultElement = document.getElementById('game-cost-res');
        if (!resultElement || !selectElement) return;
        
        const val = parseFloat(selectElement.value) || 0;
        const sdg = val * SDM_RATE;
        resultElement.innerText = sdg.toLocaleString() + " SDG";
    }

    function calcBuyCost(val) {
        const display = document.getElementById('buy-cost-display');
        if (!display) return;
        
        const cost = (parseFloat(val) || 0) * SDM_RATE;
        display.innerText = cost.toLocaleString();
    }

    // --- ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ¢ŸÖŸÜ ---
    function showTransfer() {
        if (isGuest) return checkGuestAccess('wallet');
        
        Swal.fire({
            title: 'ÿ™ÿ≠ŸàŸäŸÑ ÿ±ÿµŸäÿØ üí∏',
            html: `
                <input id="tr-id" class="swal2-input" placeholder="ID ÿßŸÑŸÖÿ≥ÿ™ŸÑŸÖ">
                <div id="tr-name-disp" style="height:20px; font-size:12px; color:var(--neon-blue); margin:5px 0; font-weight:bold;"></div>
                <input id="tr-amount" class="swal2-input" type="number" placeholder="ÿßŸÑŸÖÿ®ŸÑÿ∫ (SDM)">
            `,
            background: '#1e293b',
            color: '#fff',
            showCancelButton: true,
            confirmButtonText: 'ÿ•ÿ±ÿ≥ÿßŸÑ',
            cancelButtonText: 'ÿ•ŸÑÿ∫ÿßÿ°',
            reverseButtons: true,
            didOpen: () => {
                const idInput = document.getElementById('tr-id');
                const nameDisplay = document.getElementById('tr-name-disp');
                
                idInput.addEventListener('input', () => {
                    const userId = idInput.value.trim();
                    if (userId.length >= 5) {
                        db.ref('users/' + userId).once('value').then(snap => {
                            if (snap.exists()) {
                                const user = snap.val();
                                nameDisplay.innerHTML = `<i class="fas fa-check-circle"></i> ${escapeHtml(user.n)}`;
                            } else {
                                nameDisplay.innerHTML = `<span style="color:var(--red)">ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ</span>`;
                            }
                        });
                    } else {
                        nameDisplay.innerHTML = '';
                    }
                });
            },
            preConfirm: () => {
                const id = document.getElementById('tr-id').value.trim();
                const amount = parseFloat(document.getElementById('tr-amount').value);
                
                if (!id || !amount) {
                    Swal.showValidationMessage('ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÜÿßŸÇÿµÿ©');
                    return false;
                }
                
                if (id === me.p) {
                    Swal.showValidationMessage('ŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ ŸÑŸÜŸÅÿ≥ŸÉ');
                    return false;
                }
                
                if (amount <= 0) {
                    Swal.showValidationMessage('ÿßŸÑŸÖÿ®ŸÑÿ∫ Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿ£ŸÉÿ®ÿ± ŸÖŸÜ ÿµŸÅÿ±');
                    return false;
                }
                
                if (me.sdmBalance < amount) {
                    Swal.showValidationMessage('ÿ±ÿµŸäÿØŸÉ ÿ∫Ÿäÿ± ŸÉÿßŸÅ');
                    return false;
                }
                
                return { id, amount };
            }
        }).then(result => {
            if (result.isConfirmed) {
                const { id, amount } = result.value;
                
                db.ref('requests/transfers').push({
                    from: me.p,
                    to: id,
                    amount: amount,
                    date: Date.now(),
                    status: 'pending'
                }).then(() => {
                    Swal.fire({
                        title: 'ÿ™ŸÖ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ',
                        text: 'ÿ¨ÿßÿ±Ÿä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ∑ŸÑÿ® ÿ®Ÿàÿßÿ≥ÿ∑ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ...',
                        icon: 'success',
                        background: '#1e293b',
                        color: '#fff'
                    });
                }).catch(error => {
                    Swal.fire({
                        title: 'ÿÆÿ∑ÿ£',
                        text: 'ŸÅÿ¥ŸÑ ÿßŸÑÿßÿ™ÿµÿßŸÑ',
                        icon: 'error',
                        background: '#1e293b',
                        color: '#fff'
                    });
                });
            }
        });
    }

    // --- Ÿàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ£ÿØŸÖŸÜ ---
    function listenForAdminTasks() {
        if (!me || me.role !== "admin") return;
        
        // ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑŸÇÿØŸäŸÖ
        if (listeners.coinRequests) listeners.coinRequests();
        
        listeners.coinRequests = db.ref('coin_requests')
            .orderByChild('status')
            .equalTo('pending')
            .on('value', snap => {
                const area = document.getElementById('admin-notifications-area');
                if (!area) return;
                
                area.innerHTML = "";
                snap.forEach(child => {
                    const req = child.val();
                    area.innerHTML += `
                        <div class="admin-notify-bar">
                            <p><b>üîî ÿ∑ŸÑÿ® ÿ¥ÿ±ÿßÿ°</b>: ${escapeHtml(req.uN)} | ${req.qty} SDM</p>
                            <img src="${req.img}" style="width:100%; border-radius:10px; cursor:pointer;" 
                                 onclick="Swal.fire({imageUrl:'${req.img}', background:'#1e293b', color:'#fff'})">
                            <div style="display:flex; gap:10px; margin-top:5px;">
                                <button class="btn-main" style="background:var(--green); margin:0;" 
                                        onclick="approvePurchase('${child.key}', '${req.uP}', ${req.qty})">
                                    ŸÖŸàÿßŸÅŸÇ
                                </button>
                                <button class="btn-main" style="background:var(--red); margin:0;" 
                                        onclick="rejectPurchase('${child.key}', '${req.uP}')">
                                    ÿ±ŸÅÿ∂
                                </button>
                            </div>
                        </div>
                    `;
                });
            });
    }

    function initDeveloperLogic() {
        if (!me || me.role !== "admin") return;
        
        // ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑŸÇÿØŸäŸÖ
        if (listeners.gameOrders) listeners.gameOrders();
        
        listeners.gameOrders = db.ref('game_orders')
            .orderByChild('status')
            .equalTo('pending')
            .on('value', snap => {
                const container = document.getElementById('orders-list-container');
                if (!container) return;
                
                container.innerHTML = "";
                snap.forEach(child => {
                    const o = child.val();
                    container.innerHTML += `
                        <div class="admin-item">
                            <b>ÿßŸÑÿπŸÖŸäŸÑ:</b> ${escapeHtml(o.uN)}<br>
                            <b>${o.gameType}</b> (${o.package}) <br>
                            ID: ${o.playerId}<br>
                            <div style="color:var(--accent)">ÿßŸÑÿ™ŸÉŸÑŸÅÿ©: ${o.cost} SDM</div>
                            <div style="display:flex; gap:10px; margin-top:5px;">
                                <button class="btn-main" style="background:var(--green); margin:0; padding:5px;" 
                                        onclick="confirmOrder('${child.key}', '${o.uP}', ${o.cost}, '${o.gameType}', '${o.package}')">
                                    ŸÇÿ®ŸàŸÑ
                                </button>
                                <button class="btn-main" style="background:var(--red); margin:0; padding:5px;" 
                                        onclick="rejectOrder('${child.key}', '${o.uP}')">
                                    ÿ±ŸÅÿ∂
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                if (container.innerHTML === "") {
                    container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-sec)">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ∑ŸÑÿ®ÿßÿ™ ÿ¨ÿØŸäÿØÿ©</div>';
                }
            });
    }

    async function approvePurchase(id, userId, qty) {
        if (!me || me.role !== "admin") return;
        
        try {
            const userSnap = await db.ref('users/' + userId).once('value');
            const user = userSnap.val();
            const balance = user.sdmBalance || 0;
            
            await db.ref('users/' + userId).update({ sdmBalance: balance + Number(qty) });
            await db.ref('coin_requests/' + id).update({ 
                status: 'approved', 
                approvedBy: me.p,
                approvedAt: Date.now() 
            });
            
            await db.ref('alerts/' + userId).push({ 
                msg: `‚úÖ ÿ™ŸÖ ÿ¥ÿ±ÿßÿ° ${qty} SDM`, 
                type: 'success',
                date: Date.now()
            });
            
            await db.ref('transactions').push({
                type: 'deposit',
                userId: userId,
                amount: Number(qty),
                date: Date.now(),
                description: 'ÿ¥ÿ±ÿßÿ° ÿπŸÖŸÑÿßÿ™'
            });
            
            Swal.fire({
                title: 'ÿ™ŸÖ',
                text: 'ÿ™ŸÖÿ™ ÿßŸÑŸÖŸàÿßŸÅŸÇÿ© ÿπŸÑŸâ ÿßŸÑÿ¥ÿ±ÿßÿ°',
                icon: 'success',
                background: '#1e293b',
                color: '#fff'
            });
        } catch (error) {
            Swal.fire({
                title: 'ÿÆÿ∑ÿ£',
                text: 'ŸÅÿ¥ŸÑ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©',
                icon: 'error',
                background: '#1e293b',
                color: '#fff'
            });
        }
    }

    async function rejectPurchase(id, userId) {
        if (!me || me.role !== "admin") return;
        
        try {
            await db.ref('coin_requests/' + id).update({ 
                status: 'rejected',
                rejectedBy: me.p,
                rejectedAt: Date.now()
            });
            
            await db.ref('alerts/' + userId).push({ 
                msg: `‚ùå ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿ∑ŸÑÿ® ÿßŸÑÿ¥ÿ±ÿßÿ°`, 
                type: 'error',
                date: Date.now()
            });
            
            Swal.fire({
                title: 'ÿ™ŸÖ ÿßŸÑÿ±ŸÅÿ∂',
                text: '',
                icon: 'info',
                background: '#1e293b',
                color: '#fff'
            });
        } catch (error) {
            Swal.fire({
                title: 'ÿÆÿ∑ÿ£',
                text: 'ŸÅÿ¥ŸÑ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©',
                icon: 'error',
                background: '#1e293b',
                color: '#fff'
            });
        }
    }

    async function confirmOrder(key, userId, cost, type, packDetails) {
        if (!me || me.role !== "admin") return;
        
        try {
            const userSnap = await db.ref('users/' + userId).once('value');
            if (!userSnap.exists()) {
                Swal.fire({
                    title: 'ÿÆÿ∑ÿ£',
                    text: 'ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ',
                    icon: 'error',
                    background: '#1e293b',
                    color: '#fff'
                });
                return;
            }
            
            const user = userSnap.val();
            if ((user.sdmBalance || 0) < cost) {
                Swal.fire({
                    title: 'ŸÅÿ¥ŸÑ',
                    text: 'ÿ±ÿµŸäÿØ ÿßŸÑÿπŸÖŸäŸÑ ÿ∫Ÿäÿ± ŸÉÿßŸÅ',
                    icon: 'error',
                    background: '#1e293b',
                    color: '#fff'
                });
                return;
            }
            
            // ÿÆÿµŸÖ ÿßŸÑŸÖÿ®ŸÑÿ∫
            await db.ref('users/' + userId).update({ sdmBalance: user.sdmBalance - cost });
            
            if (type === 'VIP_SUB') {
                const days = parseInt(packDetails);
                const expiryDate = Date.now() + (days * 86400000);
                await db.ref('users/' + userId).update({ 
                    vipStatus: 'active', 
                    vipExpiry: expiryDate 
                });
            }
            
            await db.ref('game_orders/' + key).update({ 
                status: 'done',
                processedBy: me.p,
                processedAt: Date.now()
            });
            
            await db.ref('alerts/' + userId).push({ 
                msg: type === 'VIP_SUB' ? "üíé ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ VIP" : "‚úÖ ÿ™ŸÖ ÿ¥ÿ≠ŸÜ ÿßŸÑŸÑÿπÿ®ÿ©", 
                type: "success",
                date: Date.now()
            });
            
            await db.ref('transactions').push({
                type: type === 'VIP_SUB' ? 'vip_purchase' : 'game_purchase',
                userId: userId,
                amount: cost,
                date: Date.now(),
                description: type === 'VIP_SUB' ? `ÿßÿ¥ÿ™ÿ±ÿßŸÉ VIP ${packDetails}` : `ÿ¥ÿ≠ŸÜ ${type}`
            });
            
            Swal.fire({
                title: "ŸÜÿ¨ÿßÿ≠",
                text: "",
                icon: "success",
                background: '#1e293b',
                color: '#fff'
            });
        } catch (error) {
            Swal.fire({
                title: "ÿÆÿ∑ÿ£",
                text: "ŸÅÿ¥ŸÑ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©",
                icon: "error",
                background: '#1e293b',
                color: '#fff'
            });
        }
    }

    async function rejectOrder(key, userId) {
        if (!me || me.role !== "admin") return;
        
        try {
            await db.ref('game_orders/' + key).update({ 
                status: 'rejected',
                rejectedBy: me.p,
                rejectedAt: Date.now()
            });
            
            db.ref('alerts/' + userId).push({ 
                msg: "‚ùå ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑÿ∑ŸÑÿ®", 
                type: "error",
                date: Date.now()
            });
            
            Swal.fire({
                title: "ÿ™ŸÖ ÿßŸÑÿ±ŸÅÿ∂",
                text: "",
                icon: "info",
                background: '#1e293b',
                color: '#fff'
            });
        } catch (error) {
            Swal.fire({
                title: "ÿÆÿ∑ÿ£",
                text: "ŸÅÿ¥ŸÑ ÿßŸÑŸÖÿπÿßŸÑÿ¨ÿ©",
                icon: "error",
                background: '#1e293b',
                color: '#fff'
            });
        }
    }

    function sendBroadcastMessage() {
        if (!me || me.role !== 'admin') return;
        
        Swal.fire({
            title: 'ŸÜÿ¥ÿ± ÿ±ÿ≥ÿßŸÑÿ©',
            input: 'textarea',
            inputPlaceholder: 'ÿ£ÿØÿÆŸÑ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ŸáŸÜÿß...',
            background: '#1e293b',
            color: '#fff',
            showCancelButton: true,
            confirmButtonText: 'ŸÜÿ¥ÿ±',
            cancelButtonText: 'ÿ•ŸÑÿ∫ÿßÿ°',
            reverseButtons: true
        }).then(res => {
            if (res.value) {
                db.ref('settings/broadcast').set({ 
                    text: res.value, 
                    id: Date.now(),
                    sentBy: me.p,
                    sentAt: Date.now()
                });
                
                Swal.fire({
                    title: 'ÿ™ŸÖ',
                    text: 'ÿ™ŸÖ ŸÜÿ¥ÿ± ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©',
                    icon: 'success',
                    background: '#1e293b',
                    color: '#fff'
                });
            }
        });
    }

    async function updateCurrentSliderImg() {
        if (!me || me.role !== 'admin') return;
        
        event.stopPropagation();
        
        if (sliderInterval) {
            clearInterval(sliderInterval);
            sliderInterval = null;
        }
        
        const { value: imageData } = await Swal.fire({
            title: `ÿ™ÿπÿØŸäŸÑ ÿµŸàÿ±ÿ© ${currentSliderIndex + 1}`,
            html: '<input type="file" id="single-slider-input" class="swal2-file" accept="image/*">',
            background: '#1e293b',
            color: '#fff',
            showCancelButton: true,
            confirmButtonText: 'ÿ≠ŸÅÿ∏',
            cancelButtonText: 'ÿ•ŸÑÿ∫ÿßÿ°',
            reverseButtons: true,
            preConfirm: () => {
                const fileInput = document.getElementById('single-slider-input');
                const file = fileInput.files[0];
                return file ? compressImage(file) : null;
            }
        });
        
        if (imageData) {
            const newImages = [...sliderImages];
            while (newImages.length < 3) newImages.push(sdmCoinImage);
            newImages[currentSliderIndex] = imageData;
            
            await db.ref('settings/sliderImages').set(newImages);
            
            Swal.fire({
                title: 'ÿ™ŸÖ',
                text: 'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸàÿ±ÿ©',
                icon: 'success',
                background: '#1e293b',
                color: '#fff'
            });
        }
        
        startSlider();
    }

    async function updateCategoryImg(catName) {
        if (!me || me.role !== 'admin') return;
        
        const { value: imageData } = await Swal.fire({
            title: `ÿµŸàÿ±ÿ©: ${catName}`,
            html: '<input type="file" id="cat-img-input" accept="image/*" class="swal2-file">',
            background: '#1e293b',
            color: '#fff',
            showCancelButton: true,
            confirmButtonText: 'ÿ≠ŸÅÿ∏',
            cancelButtonText: 'ÿ•ŸÑÿ∫ÿßÿ°',
            reverseButtons: true,
            preConfirm: () => {
                const fileInput = document.getElementById('cat-img-input');
                const file = fileInput.files[0];
                return file ? compressImage(file) : null;
            }
        });
        
        if (imageData) {
            await db.ref(`settings/categories/${catName}`).set({ img: imageData });
            
            Swal.fire({
                title: 'ÿ™ŸÖ',
                text: 'ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ÿµŸàÿ±ÿ© ÿßŸÑŸÇÿ≥ŸÖ',
                icon: 'success',
                background: '#1e293b',
                color: '#fff'
            });
        }
    }

    function editDevAlert() {
        if (!me || me.role !== "admin") return;
        
        const currentAlert = document.getElementById('dev-alert-bar').innerText
            .replace('üì¢ ', '')
            .replace(' ‚úèÔ∏è', '');
        
        Swal.fire({
            title: 'ÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ™ŸÜÿ®ŸäŸá',
            input: 'text',
            inputValue: currentAlert,
            background: '#1e293b',
            color: '#fff',
            showCancelButton: true,
            confirmButtonText: 'ÿ≠ŸÅÿ∏',
            cancelButtonText: 'ÿ•ŸÑÿ∫ÿßÿ°',
            reverseButtons: true
        }).then(res => {
            if (res.isConfirmed) {
                db.ref('settings/globalAlert').set(res.value);
            }
        });
    }

    // --- ÿßŸÑÿ™ŸÜÿ®ŸäŸáÿßÿ™ ---
    function listenForUserAlerts() {
        if (isGuest || !me) return;
        
        // ŸÖÿ≥ÿ≠ ÿßŸÑŸÖÿ≥ÿ™ŸÖÿπ ÿßŸÑŸÇÿØŸäŸÖ
        if (listeners.alerts) listeners.alerts();
        
        listeners.alerts = db.ref('alerts/' + me.p).on('child_added', snap => {
            const data = snap.val();
            
            Swal.fire({
                title: 'ÿ™ŸÜÿ®ŸäŸá',
                text: escapeHtml(data.msg),
                icon: data.type === 'success' ? 'success' : 'error',
                background: '#1e293b',
                color: '#fff'
            });
            
            snap.ref.remove();
        });
    }

    // --- ÿßŸÑÿ±ÿ≥ÿßŸÑÿ© ÿßŸÑÿ™ÿ±ÿ≠Ÿäÿ®Ÿäÿ© ---
    function showWelcome() {
        const hour = new Date().getHours();
        const container = document.getElementById('welcome-container');
        
        if (hStack[hStack.length-1] === 'home' && me && !isGuest) {
            const greeting = hour < 12 ? "ÿµÿ®ÿßÿ≠ ÿßŸÑÿÆŸäÿ±" : 
                           hour < 18 ? "ŸÖÿ≥ÿßÿ° ÿßŸÑÿÆŸäÿ±" : "ŸÖÿ≥ÿßÿ° ÿßŸÑÿÆŸäÿ±";
            
            container.innerHTML = `
                <div style="background:rgba(59, 130, 246, 0.2); color:var(--neon-blue); padding:10px; border-radius:15px; margin:15px 0; border:1px solid var(--primary); font-size:12px;">
                    ${greeting}ÿå ${escapeHtml(me.n)} ‚ú®
                    ${me.vipStatus === 'active' ? '<span class="vip-badge" style="margin-right:10px;"><i class="fas fa-crown"></i> VIP</span>' : ''}
                </div>
            `;
        } else {
            container.innerHTML = "";
        }
    }

    // --- ÿßŸÑÿ≥ŸÑÿßŸäÿØÿ± ---
    function startSlider() {
        const imgEl = document.getElementById('slider-img');
        if (!imgEl) return;
        
        currentSliderIndex = 0;
        imgEl.src = sliderImages[0] || sdmCoinImage;
        updateDots(0);
        
        sliderInterval = setInterval(() => {
            const el = document.getElementById('slider-img');
            if (!el) return;
            
            currentSliderIndex = (currentSliderIndex + 1) % sliderImages.length;
            el.style.opacity = 0;
            
            setTimeout(() => {
                el.src = sliderImages[currentSliderIndex] || sdmCoinImage;
                el.style.opacity = 1;
                updateDots(currentSliderIndex);
            }, 300);
        }, 5000);
    }

    function updateDots(index) {
        document.querySelectorAll('.dot').forEach((dot, i) => {
            if (i === index) {
                dot.classList.add('active');
            } else {
                dot.classList.remove('active');
            }
        });
    }

    // --- ÿ™ŸÇŸäŸäŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ---
    async function rateUser(userId) {
        if (isGuest) return checkGuestAccess('profile');
        if (userId === me.p) {
            Swal.fire({
                title: 'ÿÆÿ∑ÿ£',
                text: 'ŸÑÿß ŸäŸÖŸÉŸÜŸÉ ÿ™ŸÇŸäŸäŸÖ ŸÜŸÅÿ≥ŸÉ',
                icon: 'error',
                background: '#1e293b',
                color: '#fff'
            });
            return;
        }
        
        const { value: stars } = await Swal.fire({
            title: 'ÿ™ŸÇŸäŸäŸÖ',
            input: 'select',
            inputOptions: {
                '1':'‚≠ê (ÿ∂ÿπŸäŸÅ)',
                '2':'‚≠ê‚≠ê (ŸÖŸÇÿ®ŸàŸÑ)',
                '3':'‚≠ê‚≠ê‚≠ê (ÿ¨ŸäÿØ)',
                '4':'‚≠ê‚≠ê‚≠ê‚≠ê (ÿ¨ŸäÿØ ÿ¨ÿØÿßŸã)',
                '5':'‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê (ŸÖŸÖÿ™ÿßÿ≤)'
            },
            background: '#1e293b',
            color: '#fff',
            showCancelButton: true,
            confirmButtonText: 'ÿ™ŸÇŸäŸäŸÖ',
            cancelButtonText: 'ÿ•ŸÑÿ∫ÿßÿ°',
            reverseButtons: true
        });
        
        if (stars) {
            await db.ref('rating_queue').push({
                rater: me.p,
                target: userId,
                stars: Number(stars),
                date: Date.now()
            });
            
            Swal.fire({
                title: 'ÿ™ŸÖ',
                text: 'ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ™ŸÇŸäŸäŸÖŸÉ ŸÑŸÑÿßÿπÿ™ŸÖÿßÿØ',
                icon: 'success',
                background: '#1e293b',
                color: '#fff'
            });
        }
    }

    async function reportUser(userId) {
        if (isGuest) return checkGuestAccess('profile');
        
        const { value: reason } = await Swal.fire({
            title: 'ÿ≥ÿ®ÿ® ÿßŸÑÿ•ÿ®ŸÑÿßÿ∫',
            input: 'select',
            inputOptions: {
                'spam': 'ŸÖÿ≠ÿ™ŸàŸâ ÿ∫Ÿäÿ± ŸÖÿ±ÿ∫Ÿàÿ®',
                'fraud': 'ÿßÿ≠ÿ™ŸäÿßŸÑ',
                'inappropriate': 'ŸÖÿ≠ÿ™ŸàŸâ ÿ∫Ÿäÿ± ŸÑÿßÿ¶ŸÇ',
                'harassment': 'ŸÖÿ∂ÿßŸäŸÇÿ©',
                'other': 'ÿ£ÿÆÿ±Ÿâ'
            },
            background: '#1e293b',
            color: '#fff',
            showCancelButton: true,
            confirmButtonText: 'ÿ•ÿ®ŸÑÿßÿ∫',
            cancelButtonText: 'ÿ•ŸÑÿ∫ÿßÿ°',
            reverseButtons: true
        });
        
        if (reason) {
            db.ref('user_reports').push({
                offender: userId,
                reporter: me.p,
                reason: reason,
                date: Date.now()
            });
            
            Swal.fire({
                title: 'ÿ™ŸÖ ÿßŸÑÿ•ÿ®ŸÑÿßÿ∫',
                text: 'ÿ¥ŸÉÿ±ÿßŸã ŸÑÿ™ŸÇÿ±Ÿäÿ±ŸÉ',
                icon: 'success',
                background: '#1e293b',
                color: '#fff'
            });
        }
    }

    // --- ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÇŸàÿßÿ¶ŸÖ ÿπŸÜÿØ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿÆÿßÿ±ÿ¨Ÿáÿß ---
    document.addEventListener('click', function(event) {
        if (activePostMenu && !activePostMenu.contains(event.target)) {
            const menuBtn = document.querySelector('.post-menu-btn');
            if (!menuBtn || !menuBtn.contains(event.target)) {
                activePostMenu.classList.remove('active');
                activePostMenu = null;
            }
        }
    });

    // --- ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑŸÜÿ∏ÿßŸÖ ÿπŸÜÿØ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ---
    document.addEventListener('DOMContentLoaded', function() {
        console.log('SDM Market Secure - Initialized');
        initSystem();
        
        // ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿßÿ™ÿµÿßŸÑ ŸÉŸÑ ÿØŸÇŸäŸÇÿ©
        setInterval(() => {
            if (me && !isGuest) {
                db.ref('users/' + me.p).update({ lastSeen: Date.now() });
            }
        }, 60000);
    });

    // --- ŸÖŸÜÿπ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÅÿßÿ¨ÿ¶ ---
    window.addEventListener('beforeunload', function() {
        removeAllListeners();
    });

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>منصة التعليم الذكي | المساعد الذكي للطالب</title>
    
    <!-- خطوط عربية -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- UI Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ========== الأنماط الأساسية ========== */
        :root {
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.95);
            --primary: #3b82f6;
            --accent: #f59e0b;
            --neon-blue: #00f3ff;
            --text-main: #f8fafc;
            --text-sec: #94a3b8;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --red: #ef4444; 
            --green: #10b981; 
            --purple: #8b5cf6;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
        }
        
        body {
            font-family: 'Tajawal', sans-serif; 
            margin: 0;
            background: radial-gradient(circle at top, #1e293b, #0f172a); 
            color: var(--text-main);
            padding-bottom: 90px;
            min-height: 100vh;
            user-select: none;
            overflow-x: hidden;
        }

        .hidden { display: none !important; }
        
        /* ========== شاشة تسجيل الدخول ========== */
        .login-screen {
            padding: 40px 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        
        .login-logo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            border: 3px solid var(--neon-blue);
            box-shadow: 0 0 30px rgba(0, 243, 255, 0.3);
        }
        
        .login-logo i {
            font-size: 50px;
            color: white;
        }
        
        .login-title {
            font-size: 42px;
            margin-bottom: 10px;
            background: linear-gradient(45deg, var(--neon-blue), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
            text-align: center;
        }
        
        .login-subtitle {
            color: var(--text-sec);
            margin-bottom: 40px;
            font-size: 16px;
            text-align: center;
        }
        
        .login-form {
            width: 100%;
            max-width: 400px;
        }
        
        .login-input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: white;
            font-family: 'Tajawal';
            font-size: 16px;
        }
        
        .login-input:focus {
            border-color: var(--accent);
            outline: none;
            background: rgba(0,0,0,0.4);
        }
        
        .login-btn {
            background: linear-gradient(90deg, var(--primary), #2563eb);
            color: white;
            border: none;
            padding: 15px;
            width: 100%;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: 0.3s;
        }
        
        .login-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        .login-footer {
            margin-top: 30px;
            color: var(--text-sec);
            text-align: center;
        }
        
        .login-footer a {
            color: var(--neon-blue);
            text-decoration: none;
            cursor: pointer;
        }

        /* ========== الهيدر والبحث ========== */
        header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            padding: 15px 20px;
            position: sticky; 
            top: 0; 
            z-index: 1000;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .header-top { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            width: 100%; 
            margin-bottom: 10px;
        }
        
        .search-container { 
            position: relative; 
            width: 100%; 
        }
        
        .search-container input {
            width: 100%; 
            padding: 12px 45px 12px 15px;
            border-radius: 15px; 
            border: 1px solid var(--border);
            font-size: 14px; 
            background: var(--glass); 
            color: white;
            transition: 0.3s; 
            font-family: 'Tajawal';
        }
        
        .search-container input:focus { 
            background: rgba(255,255,255,0.1); 
            border-color: var(--neon-blue); 
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); 
        }
        
        .search-container i { 
            position: absolute; 
            right: 15px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--accent); 
        }

        /* ========== البطاقات والجريد ========== */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 15px; 
            padding: 15px; 
        }
        
        .card { 
            background: var(--bg-card); 
            border-radius: 18px; 
            padding: 20px; 
            text-align: center; 
            border: 1px solid var(--border); 
            transition: 0.3s; 
            position: relative; 
            overflow: hidden; 
            backdrop-filter: blur(5px); 
            color: var(--text-main); 
            cursor: pointer;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .card:active { transform: scale(0.96); }
        
        .card:hover { 
            border-color: var(--neon-blue); 
            box-shadow: 0 5px 20px rgba(0, 243, 255, 0.15); 
            transform: translateY(-5px); 
        }
        
        .card i { 
            font-size: 32px; 
            margin-bottom: 10px; 
            background: linear-gradient(45deg, #fff, #aaa); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        
        .card-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--accent);
            color: black;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 10px;
            font-weight: bold;
        }

        /* ========== الأزرار ========== */
        .btn-main { 
            background: linear-gradient(90deg, var(--primary), #2563eb); 
            color: white; 
            border: none; 
            padding: 15px; 
            width: 100%; 
            border-radius: 12px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 16px; 
            margin-top: 10px; 
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); 
            transition: 0.3s; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-main:hover { opacity: 0.9; }
        
        .btn-secondary { 
            background: transparent; 
            border: 1px solid var(--text-sec); 
            color: var(--text-sec); 
            width: 100%; 
            padding: 12px; 
            border-radius: 10px; 
            margin-top: 10px; 
            cursor: pointer; 
        }
        
        .btn-danger { 
            background: var(--red); 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 10px; 
            cursor: pointer; 
        }
        
        .btn-success { 
            background: var(--green); 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 10px; 
            cursor: pointer; 
        }

        /* ========== المدخلات ========== */
        input, textarea, select { 
            width: 100%; 
            padding: 15px; 
            margin: 8px 0; 
            background: rgba(0,0,0,0.2); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            color: white; 
            font-family: 'Tajawal'; 
            box-sizing: border-box; 
        }
        
        input:focus, textarea:focus, select:focus { 
            border-color: var(--accent); 
            outline: none; 
            background: rgba(0,0,0,0.4); 
        }

        /* ========== المنشورات والكتب ========== */
        .post { 
            background: var(--bg-card); 
            margin: 15px; 
            border-radius: 20px; 
            overflow: hidden; 
            border: 1px solid var(--border); 
            animation: fadeIn 0.5s ease; 
            position: relative; 
        }
        
        .book-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .book-cover {
            width: 80px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            border: 1px solid var(--accent);
        }
        
        .grade-badge {
            background: var(--purple);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 5px;
        }

        /* ========== التبويبات السفلية ========== */
        .bottom-tabs {
            position: fixed; 
            bottom: 20px; 
            left: 20px; 
            right: 20px; 
            background: rgba(30, 41, 59, 0.95); 
            backdrop-filter: blur(15px); 
            border-radius: 25px; 
            display: flex; 
            justify-content: space-around; 
            padding: 12px 0; 
            box-shadow: var(--shadow);
            border: 1px solid var(--border); 
            z-index: 1000;
        }
        
        .tab-btn { 
            color: var(--text-sec); 
            text-align: center; 
            font-size: 10px; 
            transition: 0.3s; 
            position: relative; 
            flex: 1; 
            cursor: pointer; 
        }
        
        .tab-btn i { 
            font-size: 22px; 
            margin-bottom: 4px; 
            display: block; 
            transition: 0.3s; 
        }
        
        .tab-btn.active { color: var(--neon-blue); }
        .tab-btn.active i { transform: translateY(-5px); text-shadow: 0 0 10px var(--neon-blue); }

        /* ========== شاشات خاصة ========== */
        .live-room {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 20px;
            margin: 15px;
            color: white;
        }
        
        .payment-method {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid var(--green);
        }
        
        .admin-panel {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--red);
            border-radius: 15px;
            padding: 20px;
            margin: 15px;
        }

        /* ========== التحميل ========== */
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: var(--text-sec); 
        }
        
        .loading-spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== متجاوب ========== */
        @media (max-width: 768px) {
            .grid { grid-template-columns: repeat(2, 1fr); }
            .bottom-tabs { left: 10px; right: 10px; bottom: 10px; }
            .card { padding: 15px; min-height: 130px; }
            .card i { font-size: 28px; }
            .login-title { font-size: 32px; }
            .login-logo { width: 100px; height: 100px; }
        }
        
        @media (max-width: 480px) {
            .grid { grid-template-columns: 1fr; }
            header { padding: 12px 15px; }
            .login-screen { padding: 20px 15px; }
        }
    </style>
</head>
<body>
<!-- شاشة التحميل -->
<div id="main-preloader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#0f172a; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:99999;">
    <div class="loading-spinner"></div>
    <p style="color:white; font-family:'Tajawal'; margin-top:15px; font-size:18px;">المساعد الذكي يجهز نظام التعليم...</p>
</div>

<!-- شاشة تسجيل الدخول -->
<div id="login-screen" class="hidden">
    <div class="login-screen">
        <div class="login-logo">
            <i class="fas fa-graduation-cap"></i>
        </div>
        
        <h1 class="login-title">منصة التعليم الذكي</h1>
        <p class="login-subtitle">أهلاً بك في المنصة التعليمية المتكاملة</p>
        
        <div class="login-form">
            <input type="text" id="login-email" class="login-input" placeholder="البريد الإلكتروني أو اسم المستخدم">
            <input type="password" id="login-password" class="login-input" placeholder="كلمة المرور">
            
            <button class="login-btn" onclick="loginUser()">
                <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
            </button>
            
            <p class="login-footer">
                ليس لديك حساب؟ 
                <a onclick="showRegisterOptions()">سجل الآن</a>
            </p>
        </div>
    </div>
</div>

<!-- شاشة خيارات التسجيل -->
<div id="register-screen" class="hidden">
    <div style="padding:40px; text-align:center; height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div style="width:120px; height:120px; border-radius:50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display:flex; align-items:center; justify-content:center; margin-bottom:30px;">
            <i class="fas fa-graduation-cap" style="font-size:50px; color:white;"></i>
        </div>
        <h1 style="font-size: 42px; margin-bottom:10px; background: linear-gradient(45deg, var(--neon-blue), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight:800;">منصة التعليم الذكي</h1>
        <p style="color:var(--text-sec); margin-bottom:40px; font-size:16px;">أهلاً بك في المنصة التعليمية المتكاملة</p>
        
        <div style="width:100%; max-width:400px;">
            <button class="btn-main" onclick="showStudentForm()" style="margin-bottom:15px;">
                <i class="fas fa-user-graduate"></i> أنا طالب
            </button>
            
            <button class="btn-secondary" onclick="showTeacherForm()">
                <i class="fas fa-chalkboard-teacher"></i> أنا أستاذ
            </button>
            
            <button class="btn-secondary" onclick="backToLogin()" style="margin-top:20px;">
                <i class="fas fa-arrow-right"></i> العودة لتسجيل الدخول
            </button>
        </div>
    </div>
</div>

<!-- نموذج تسجيل الطالب -->
<div id="student-form" class="hidden">
    <div style="padding:20px;">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:30px;">
            <button class="btn-secondary" onclick="backToRegister()" style="width:auto; padding:10px 15px;">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
            <h2 style="color:var(--neon-blue); margin:0;">تسجيل حساب طالب</h2>
        </div>
        
        <div style="background:var(--bg-card); padding:25px; border-radius:20px;">
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-user"></i> الاسم الكامل *
                </label>
                <input type="text" id="student-name" placeholder="أدخل اسمك الكامل" required>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-envelope"></i> البريد الإلكتروني *
                </label>
                <input type="email" id="student-email" placeholder="example@email.com" required>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-lock"></i> كلمة المرور *
                </label>
                <input type="password" id="student-password" placeholder="كلمة مرور قوية" required>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-calendar"></i> عمرك *
                </label>
                <select id="student-age" required>
                    <option value="">اختر عمرك</option>
                    <option value="6">6 سنوات</option>
                    <option value="7">7 سنوات</option>
                    <option value="8">8 سنوات</option>
                    <option value="9">9 سنوات</option>
                    <option value="10">10 سنوات</option>
                    <option value="11">11 سنوات</option>
                    <option value="12">12 سنوات</option>
                    <option value="13">13 سنوات</option>
                    <option value="14">14 سنوات</option>
                    <option value="15">15 سنوات</option>
                    <option value="16">16 سنوات</option>
                    <option value="17">17 سنوات</option>
                    <option value="18">18 سنة فأكثر</option>
                </select>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-graduation-cap"></i> الصف الدراسي *
                </label>
                <select id="student-grade" required>
                    <option value="">اختر صفك الدراسي</option>
                    <option value="الأول الابتدائي">الصف الأول الابتدائي</option>
                    <option value="الثاني الابتدائي">الصف الثاني الابتدائي</option>
                    <option value="الثالث الابتدائي">الصف الثالث الابتدائي</option>
                    <option value="الرابع الابتدائي">الصف الرابع الابتدائي</option>
                    <option value="الخامس الابتدائي">الصف الخامس الابتدائي</option>
                    <option value="السادس الابتدائي">الصف السادس الابتدائي</option>
                    <option value="الأول المتوسط">الصف الأول المتوسط</option>
                    <option value="الثاني المتوسط">الصف الثاني المتوسط</option>
                    <option value="الثالث المتوسط">الصف الثالث المتوسط</option>
                    <option value="الأول الثانوي">الصف الأول الثانوي</option>
                    <option value="الثاني الثانوي">الصف الثاني الثانوي</option>
                    <option value="الثالث الثانوي">الصف الثالث الثانوي</option>
                </select>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-book"></i> المواد المفضلة *
                </label>
                <div id="favorite-subjects" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:10px;">
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" value="الرياضيات" class="subject-checkbox">
                        <span>الرياضيات</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" value="العلوم" class="subject-checkbox">
                        <span>العلوم</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" value="اللغة العربية" class="subject-checkbox">
                        <span>اللغة العربية</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" value="اللغة الإنجليزية" class="subject-checkbox">
                        <span>اللغة الإنجليزية</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" value="الاجتماعيات" class="subject-checkbox">
                        <span>الاجتماعيات</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" value="التربية الإسلامية" class="subject-checkbox">
                        <span>التربية الإسلامية</span>
                    </label>
                </div>
            </div>
            
            <button class="btn-main" onclick="registerStudent()">
                <i class="fas fa-check"></i> إنشاء حساب طالب
            </button>
        </div>
    </div>
</div>

<!-- نموذج تسجيل الأستاذ -->
<div id="teacher-form" class="hidden">
    <div style="padding:20px;">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:30px;">
            <button class="btn-secondary" onclick="backToRegister()" style="width:auto; padding:10px 15px;">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
            <h2 style="color:var(--neon-blue); margin:0;">تسجيل حساب أستاذ</h2>
        </div>
        
        <div style="background:var(--bg-card); padding:25px; border-radius:20px;">
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-user"></i> الاسم الكامل *
                </label>
                <input type="text" id="teacher-name" placeholder="أدخل اسمك الكامل" required>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-envelope"></i> البريد الإلكتروني *
                </label>
                <input type="email" id="teacher-email" placeholder="example@email.com" required>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-lock"></i> كلمة المرور *
                </label>
                <input type="password" id="teacher-password" placeholder="كلمة مرور قوية" required>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-book"></i> المادة الدراسية *
                </label>
                <select id="teacher-subject" required>
                    <option value="">اختر المادة التي تدرسها</option>
                    <option value="الرياضيات">الرياضيات</option>
                    <option value="العلوم">العلوم</option>
                    <option value="اللغة العربية">اللغة العربية</option>
                    <option value="اللغة الإنجليزية">اللغة الإنجليزية</option>
                    <option value="الفيزياء">الفيزياء</option>
                    <option value="الكيمياء">الكيمياء</option>
                    <option value="الأحياء">الأحياء</option>
                    <option value="التاريخ">التاريخ</option>
                    <option value="الجغرافيا">الجغرافيا</option>
                    <option value="التربية الإسلامية">التربية الإسلامية</option>
                    <option value="الحاسوب">الحاسوب</option>
                </select>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-graduation-cap"></i> الصفوف التي تدرسها *
                </label>
                <select id="teacher-grades" multiple style="height:120px;">
                    <option value="جميع الصفوف">جميع الصفوف</option>
                    <option value="الأول الابتدائي">الصف الأول الابتدائي</option>
                    <option value="الثاني الابتدائي">الصف الثاني الابتدائي</option>
                    <option value="الثالث الابتدائي">الصف الثالث الابتدائي</option>
                    <option value="الرابع الابتدائي">الصف الرابع الابتدائي</option>
                    <option value="الخامس الابتدائي">الصف الخامس الابتدائي</option>
                    <option value="السادس الابتدائي">الصف السادس الابتدائي</option>
                    <option value="الأول المتوسط">الصف الأول المتوسط</option>
                    <option value="الثاني المتوسط">الصف الثاني المتوسط</option>
                    <option value="الثالث المتوسط">الصف الثالث المتوسط</option>
                    <option value="الأول الثانوي">الصف الأول الثانوي</option>
                    <option value="الثاني الثانوي">الصف الثاني الثانوي</option>
                    <option value="الثالث الثانوي">الصف الثالث الثانوي</option>
                </select>
                <small style="color:var(--text-sec);">اضغط Ctrl لتحديد أكثر من صف</small>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-phone"></i> رقم الواتساب للتواصل *
                </label>
                <input type="tel" id="teacher-whatsapp" placeholder="مثال: 0912345678" required>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-id-card"></i> صورة البطاقة الشخصية أو الرخصة *
                </label>
                <input type="file" id="teacher-id" accept="image/*" required>
                <small style="color:var(--text-sec);">للمراجعة من قبل الإدمن</small>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-bank"></i> رقم حسابك البنكي
                </label>
                <input type="text" id="teacher-account" placeholder="لتحويل المدفوعات (اختياري)">
            </div>
            
            <button class="btn-main" onclick="registerTeacher()">
                <i class="fas fa-paper-plane"></i> إرسال طلب التسجيل
            </button>
            
            <div style="margin-top:20px; padding:15px; background:rgba(245, 158, 11, 0.1); border-radius:10px;">
                <p style="color:var(--accent); font-size:14px; margin:0;">
                    <i class="fas fa-info-circle"></i> سيتم مراجعة طلبك من قبل الإدمن خلال 24 ساعة
                </p>
            </div>
        </div>
    </div>
</div>

<!-- التطبيق الرئيسي -->
<div id="app-screen" class="hidden">
    <header>
        <div class="header-top">
            <span onclick="handleBackButton()" style="cursor:pointer; font-size:22px; color:var(--text-sec); width:30px; height:30px; display:flex; align-items:center; justify-content:center;">
                <i class="fas fa-arrow-right"></i>
            </span>
            <span id="head-title" style="font-weight: 800; font-size: 20px; color: var(--text-main); text-align:center; flex:1;">الرئيسية</span>
            <div id="user-badge" style="background:rgba(255,255,255,0.1); padding:5px 12px; border-radius:15px; display:flex; align-items:center; gap:8px; cursor:pointer;" onclick="nav('profile')">
                <i class="fas fa-user" style="color:var(--accent); font-size:14px;"></i>
                <span id="user-name" style="font-size:14px; font-weight:bold;"></span>
                <span id="u-stars" style="font-size:14px; font-weight:bold; margin-right:5px;">0.0</span>
            </div>
        </div>
        <div class="search-container" id="main-search">
            <i class="fas fa-search"></i>
            <input type="text" id="store-search" placeholder="ابحث في الكتب، الفصول، الأساتذة..." oninput="debounceFilter(this.value)">
        </div>
    </header>

    <div id="content-area"></div>

    <!-- التبويبات السفلية -->
    <div class="bottom-tabs">
        <div class="tab-btn active" onclick="nav('home'); highlightTab(this)">
            <i class="fas fa-home"></i>الرئيسية
        </div>
        <div class="tab-btn" onclick="nav('grades'); highlightTab(this)">
            <i class="fas fa-graduation-cap"></i>الفصول
        </div>
        <div class="tab-btn" onclick="nav('library'); highlightTab(this)">
            <i class="fas fa-book"></i>المكتبة
        </div>
        <div class="tab-btn" onclick="nav('ai_assistant'); highlightTab(this)">
            <i class="fas fa-robot"></i>المساعد الذكي
        </div>
        <div class="tab-btn" onclick="nav('live'); highlightTab(this)">
            <i class="fas fa-video"></i>البث المباشر
        </div>
    </div>
</div>

<script>
// ==================== [ 1. إعدادات Firebase ] ====================
const firebaseConfig = {
    apiKey: "AIzaSyAI_mUhuPNoO-XC0Q-VNoWft8UWFbAbIGg",
    authDomain: "sudan-market-6b122.firebaseapp.com",
    databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com",
    projectId: "sudan-market-6b122",
    storageBucket: "sudan-market-6b122.firebasestorage.app",
    messagingSenderId: "66729481566",
    appId: "1:66729481566:web:93393f28dc22d32cceebcf",
    measurementId: "G-XXXXXXXXXX"
};

// تهيئة Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

// ==================== [ 2. المتغيرات العامة ] ====================
const ADMIN_EMAIL = "mb425262@gmail.com";
const ADMIN_BANK_ACCOUNT = "4426148";
const WEEKLY_SUBSCRIPTION_PRICE = 7000; // 7000 جنيه
const FREE_TRIAL_DAYS = 1;

let me = null;
let hStack = ['home'];
let isGuest = false;
let currentBookId = null;
let selectedChapter = '';
let currentQuiz = null;
let currentLiveRoom = null;
let currentVoice = null;

// ==================== [ 3. تهيئة التطبيق ] ====================
function initializeApp() {
    // إخفاء شاشة التحميل أولاً
    document.getElementById('main-preloader').classList.add('hidden');
    
    // التحقق من المستخدم الحالي
    auth.onAuthStateChanged((user) => {
        if (user) {
            // المستخدم مسجل دخول
            loadUserData(user.uid);
        } else {
            // عرض شاشة تسجيل الدخول
            showLoginScreen();
        }
    });
}

function showLoginScreen() {
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('register-screen').classList.add('hidden');
    document.getElementById('student-form').classList.add('hidden');
    document.getElementById('teacher-form').classList.add('hidden');
}

function backToLogin() {
    document.getElementById('register-screen').classList.add('hidden');
    document.getElementById('student-form').classList.add('hidden');
    document.getElementById('teacher-form').classList.add('hidden');
    document.getElementById('login-screen').classList.remove('hidden');
}

function showRegisterOptions() {
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('register-screen').classList.remove('hidden');
}

function backToRegister() {
    document.getElementById('student-form').classList.add('hidden');
    document.getElementById('teacher-form').classList.add('hidden');
    document.getElementById('register-screen').classList.remove('hidden');
}

function showStudentForm() {
    document.getElementById('register-screen').classList.add('hidden');
    document.getElementById('student-form').classList.remove('hidden');
}

function showTeacherForm() {
    document.getElementById('register-screen').classList.add('hidden');
    document.getElementById('teacher-form').classList.remove('hidden');
}

// ==================== [ 4. تسجيل الدخول ] ====================
async function loginUser() {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value.trim();
    
    if (!email || !password) {
        showError('الرجاء إدخال البريد الإلكتروني وكلمة المرور');
        return;
    }
    
    try {
        showLoading('جاري تسجيل الدخول...');
        
        const result = await auth.signInWithEmailAndPassword(email, password);
        
        hideLoading();
        showSuccess('تم تسجيل الدخول بنجاح');
        
        // سيتم تحميل بيانات المستخدم تلقائياً عبر onAuthStateChanged
        
    } catch (error) {
        hideLoading();
        
        // محاولة الدخول كضيف
        if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
            showError('البريد الإلكتروني أو كلمة المرور غير صحيحة');
        } else {
            showError('حدث خطأ أثناء تسجيل الدخول: ' + error.message);
        }
    }
}

// ==================== [ 5. تسجيل الطالب ] ====================
async function registerStudent() {
    const name = document.getElementById('student-name').value.trim();
    const email = document.getElementById('student-email').value.trim();
    const password = document.getElementById('student-password').value.trim();
    const age = document.getElementById('student-age').value;
    const grade = document.getElementById('student-grade').value;
    
    if (!name || !email || !password || !age || !grade) {
        showError('الرجاء ملء جميع الحقول المطلوبة');
        return;
    }
    
    // جمع المواد المفضلة
    const favoriteSubjects = [];
    document.querySelectorAll('.subject-checkbox:checked').forEach(cb => {
        favoriteSubjects.push(cb.value);
    });
    
    if (favoriteSubjects.length === 0) {
        showError('الرجاء اختيار مادة واحدة على الأقل');
        return;
    }
    
    try {
        showLoading('جاري إنشاء حساب الطالب...');
        
        // إنشاء حساب في Firebase Auth
        const result = await auth.createUserWithEmailAndPassword(email, password);
        const user = result.user;
        
        // حساب تاريخ انتهاء التجربة المجانية
        const freeUntil = Date.now() + (FREE_TRIAL_DAYS * 24 * 60 * 60 * 1000);
        
        // حفظ بيانات الطالب
        await db.ref('users/' + user.uid).set({
            name: name,
            email: email,
            uid: user.uid,
            age: age,
            grade: grade,
            role: 'student',
            favoriteSubjects: favoriteSubjects,
            joinDate: Date.now(),
            freeTrial: true,
            freeUntil: freeUntil,
            balance: 0,
            subscription: null,
            totalSpent: 0,
            aiQuizzesCount: 0,
            booksDownloaded: 0,
            liveSessionsAttended: 0
        });
        
        // تسجيل اليوم المجاني
        await db.ref('free_trials/' + user.uid).set({
            userId: user.uid,
            startDate: Date.now(),
            endDate: freeUntil,
            used: true
        });
        
        hideLoading();
        showSuccess('تم إنشاء حساب الطالب بنجاح');
        
        // سيتم تحميل بيانات المستخدم تلقائياً عبر onAuthStateChanged
        
    } catch (error) {
        hideLoading();
        if (error.code === 'auth/email-already-in-use') {
            showError('هذا البريد الإلكتروني مستخدم بالفعل');
        } else if (error.code === 'auth/weak-password') {
            showError('كلمة المرور ضعيفة، يجب أن تكون 6 أحرف على الأقل');
        } else {
            showError('حدث خطأ أثناء التسجيل: ' + error.message);
        }
    }
}

// ==================== [ 6. تسجيل الأستاذ ] ====================
async function registerTeacher() {
    const name = document.getElementById('teacher-name').value.trim();
    const email = document.getElementById('teacher-email').value.trim();
    const password = document.getElementById('teacher-password').value.trim();
    const subject = document.getElementById('teacher-subject').value;
    const whatsapp = document.getElementById('teacher-whatsapp').value.trim();
    const idFile = document.getElementById('teacher-id').files[0];
    const account = document.getElementById('teacher-account').value.trim();
    
    if (!name || !email || !password || !subject || !whatsapp || !idFile) {
        showError('الرجاء ملء جميع الحقول المطلوبة');
        return;
    }
    
    // جمع الصفوف المختارة
    const grades = [];
    const gradeSelect = document.getElementById('teacher-grades');
    for (let i = 0; i < gradeSelect.options.length; i++) {
        if (gradeSelect.options[i].selected) {
            grades.push(gradeSelect.options[i].value);
        }
    }
    
    if (grades.length === 0) {
        grades.push('جميع الصفوف');
    }
    
    try {
        showLoading('جاري إرسال طلب التسجيل...');
        
        // إنشاء حساب في Firebase Auth
        const result = await auth.createUserWithEmailAndPassword(email, password);
        const user = result.user;
        
        // رفع صورة البطاقة
        const fileRef = storage.ref(`teacher_ids/${user.uid}_${Date.now()}_${idFile.name}`);
        const uploadTask = fileRef.put(idFile);
        
        await new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
                null,
                (error) => reject(error),
                async () => {
                    const idUrl = await uploadTask.snapshot.ref.getDownloadURL();
                    resolve(idUrl);
                }
            );
        });
        
        const idUrl = await uploadTask.snapshot.ref.getDownloadURL();
        
        // حفظ بيانات الأستاذ (في انتظار المراجعة)
        await db.ref('users/' + user.uid).set({
            name: name,
            email: email,
            uid: user.uid,
            role: 'pending_teacher',
            subject: subject,
            grades: grades,
            whatsapp: whatsapp,
            bankAccount: account || null,
            idUrl: idUrl,
            joinDate: Date.now(),
            status: 'pending', // بانتظار مراجعة الإدمن
            balance: 0,
            totalEarnings: 0
        });
        
        // إرسال إشعار للإدمن
        await db.ref('admin_notifications').push({
            type: 'teacher_registration',
            userId: user.uid,
            userName: name,
            email: email,
            subject: subject,
            whatsapp: whatsapp,
            idUrl: idUrl,
            timestamp: Date.now(),
            status: 'pending'
        });
        
        hideLoading();
        
        Swal.fire({
            title: 'تم الإرسال!',
            html: `تم إرسال طلب التسجيل بنجاح<br>
                   <strong>سيتم مراجعة طلبك من قبل الإدمن خلال 24 ساعة</strong><br>
                   <small>سيتم إشعارك عند الموافقة أو الرفض</small>`,
            icon: 'success',
            confirmButtonText: 'حسناً',
            background: '#1e293b',
            color: '#fff'
        }).then(() => {
            // إعادة تسجيل الدخول بالحساب
            auth.signInWithEmailAndPassword(email, password);
        });
        
    } catch (error) {
        hideLoading();
        if (error.code === 'auth/email-already-in-use') {
            showError('هذا البريد الإلكتروني مستخدم بالفعل');
        } else if (error.code === 'auth/weak-password') {
            showError('كلمة المرور ضعيفة، يجب أن تكون 6 أحرف على الأقل');
        } else {
            showError('حدث خطأ أثناء التسجيل: ' + error.message);
        }
    }
}

// ==================== [ 7. تحميل بيانات المستخدم ] ====================
function loadUserData(uid) {
    db.ref('users/' + uid).on('value', async (snap) => {
        if (snap.exists()) {
            me = snap.val();
            me.uid = uid;
            
            // التحقق من حالة الأستاذ
            if (me.role === 'pending_teacher') {
                await checkTeacherStatus(uid);
                return;
            }
            
            // إذا كان الأستاذ مرفوض
            if (me.role === 'rejected_teacher') {
                Swal.fire({
                    title: 'تم رفض طلبك',
                    text: 'تم رفض طلب تسجيلك كأستاذ. يمكنك التسجيل كطالب بدلاً من ذلك.',
                    icon: 'error',
                    confirmButtonText: 'حسناً',
                    background: '#1e293b',
                    color: '#fff'
                }).then(() => {
                    auth.signOut();
                });
                return;
            }
            
            // تحديث واجهة المستخدم
            updateUI();
            
            // إظهار التطبيق الرئيسي
            document.getElementById('main-preloader').classList.add('hidden');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('register-screen').classList.add('hidden');
            document.getElementById('student-form').classList.add('hidden');
            document.getElementById('teacher-form').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            
            // تحميل الصفحة الرئيسية
            nav('home');
            
            // تحديث حالة الاتصال
            db.ref('users/' + uid + '/online').set(true);
            db.ref('users/' + uid + '/online').onDisconnect().set(false);
        }
    });
}

async function checkTeacherStatus(uid) {
    const statusSnap = await db.ref('users/' + uid + '/status').once('value');
    const status = statusSnap.val();
    
    if (status === 'approved') {
        // تمت الموافقة
        me.role = 'teacher';
        loadUserData(uid); // إعادة تحميل البيانات
    } else if (status === 'rejected') {
        // تم الرفض
        me.role = 'rejected_teacher';
        loadUserData(uid); // إعادة تحميل البيانات
    } else {
        // لا يزال في انتظار المراجعة
        showTeacherWaitingScreen();
    }
}

function showTeacherWaitingScreen() {
    document.getElementById('main-preloader').classList.add('hidden');
    
    Swal.fire({
        title: 'جاري مراجعة طلبك',
        html: `طلب تسجيلك كأستاذ قيد المراجعة حالياً<br>
               <strong>سيتم إشعارك فور الانتهاء من المراجعة</strong><br>
               <small>قد تستغرق العملية حتى 24 ساعة</small>`,
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'انتظار',
        cancelButtonText: 'تسجيل خروج',
        background: '#1e293b',
        color: '#fff'
    }).then((result) => {
        if (result.dismiss === Swal.DismissReason.cancel) {
            auth.signOut();
        } else {
            // التحقق من الحالة كل 30 ثانية
            setTimeout(() => checkTeacherStatus(me.uid), 30000);
        }
    });
}

// ==================== [ 8. تحديث واجهة المستخدم ] ====================
function updateUI() {
    if (!me) return;
    
    // تحديث اسم المستخدم
    document.getElementById('user-name').innerText = me.name || 'مستخدم';
    
    // تحديث رصيد المستخدم
    const balanceText = me.balance ? me.balance.toFixed(1) + ' ج.س' : 'مجاني';
    document.getElementById('u-stars').innerText = balanceText;
    
    // تحديث بادج الزائر إذا كان مجاني
    if (me.freeTrial && me.freeUntil > Date.now()) {
        const hoursLeft = Math.ceil((me.freeUntil - Date.now()) / (1000 * 60 * 60));
        document.getElementById('u-stars').innerText = `تجربة ${hoursLeft}س`;
    }
}

// ==================== [ 9. نظام التنقل ] ====================
function nav(view, extra) {
    hStack.push(view);
    const area = document.getElementById('content-area');
    
    // تحديث العنوان
    const titles = {
        'home': 'الرئيسية',
        'grades': 'الفصول الدراسية',
        'library': 'المكتبة الرقمية',
        'ai_assistant': 'المساعد الذكي',
        'live': 'غرف البث المباشر',
        'profile': 'الملف الشخصي',
        'admin': 'لوحة التحكم',
        'add_book': 'إضافة كتاب جديد',
        'book_detail': 'تفاصيل الكتاب',
        'subscription': 'الاشتراكات والدفع'
    };
    document.getElementById('head-title').innerText = titles[view] || view;
    
    // عرض المحتوى المناسب
    if (view === 'home') {
        renderHome();
    } else if (view === 'grades') {
        renderGrades();
    } else if (view === 'library') {
        renderLibrary();
    } else if (view === 'ai_assistant') {
        renderAIAssistant();
    } else if (view === 'live') {
        renderLiveRooms();
    } else if (view === 'profile') {
        renderProfile();
    } else if (view === 'admin') {
        renderAdminPanel();
    } else if (view === 'add_book') {
        renderAddBook();
    } else if (view === 'subscription') {
        renderSubscription();
    } else if (view === 'book_detail') {
        if (extra) loadBookDetail(extra);
    }
    
    highlightTab(document.querySelector(`[onclick*="${view}"]`));
}

function highlightTab(el) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    if (el) el.classList.add('active');
}

function handleBackButton() {
    if (hStack.length > 1) {
        hStack.pop();
        const prevView = hStack[hStack.length - 1];
        nav(prevView);
    } else {
        Swal.fire({
            title: 'تسجيل خروج',
            text: 'هل تريد تسجيل الخروج؟',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'نعم، خروج',
            cancelButtonText: 'إلغاء',
            background: '#1e293b',
            color: '#fff'
        }).then(result => {
            if (result.isConfirmed) {
                auth.signOut();
            }
        });
    }
}

// ==================== [ 10. الصفحة الرئيسية ] ====================
function renderHome() {
    if (!me) return;
    
    const area = document.getElementById('content-area');
    const isFreeTrial = me.freeTrial && me.freeUntil > Date.now();
    const hoursLeft = isFreeTrial ? Math.ceil((me.freeUntil - Date.now()) / (1000 * 60 * 60)) : 0;
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:20px; padding:25px; color:white; margin-bottom:25px;">
                <h2 style="margin-top:0;">مرحباً ${me.name} 👋</h2>
                <p>${me.role === 'teacher' ? 'أهلاً بك أستاذ ' + me.subject : 'استمر في رحلة التعلم مع المساعد الذكي'}</p>
                ${isFreeTrial ? `
                    <div style="background:rgba(255,255,255,0.2); padding:10px; border-radius:10px; margin-top:10px;">
                        <small>الوقت المتبقي من اليوم المجاني: ${hoursLeft} ساعة</small>
                    </div>
                ` : ''}
            </div>
            
            <div class="grid">
                <div class="card" onclick="nav('grades')">
                    <div class="card-badge">📚</div>
                    <i class="fas fa-graduation-cap" style="color:#3b82f6"></i>
                    <b>الفصول الدراسية</b>
                    <p style="font-size:12px; color:var(--text-sec)">${me.grade || 'جميع الصفوف'}</p>
                </div>
                
                <div class="card" onclick="nav('library')">
                    <div class="card-badge">📖</div>
                    <i class="fas fa-book" style="color:#f59e0b"></i>
                    <b>المكتبة الرقمية</b>
                    <p style="font-size:12px; color:var(--text-sec)">جميع الكتب الدراسية</p>
                </div>
                
                <div class="card" onclick="nav('ai_assistant')">
                    <div class="card-badge">🤖</div>
                    <i class="fas fa-robot" style="color:#8b5cf6"></i>
                    <b>المساعد الذكي</b>
                    <p style="font-size:12px; color:var(--text-sec)">إنشاء اختبارات ذكية</p>
                </div>
                
                <div class="card" onclick="nav('live')">
                    <div class="card-badge">📹</div>
                    <i class="fas fa-video" style="color:#ef4444"></i>
                    <b>البث المباشر</b>
                    <p style="font-size:12px; color:var(--text-sec)">دروس مباشرة مع الأساتذة</p>
                </div>
                
                ${me.role === 'admin' ? `
                <div class="card" onclick="nav('admin')" style="border:2px solid var(--red);">
                    <div class="card-badge" style="background:var(--red);">⚙️</div>
                    <i class="fas fa-cogs" style="color:var(--red)"></i>
                    <b>لوحة التحكم</b>
                    <p style="font-size:12px; color:var(--text-sec)">إدارة النظام</p>
                </div>
                ` : ''}
                
                <div class="card" onclick="nav('subscription')">
                    <div class="card-badge" style="background:var(--green);">💳</div>
                    <i class="fas fa-crown" style="color:var(--green)"></i>
                    <b>الاشتراكات</b>
                    <p style="font-size:12px; color:var(--text-sec)">اشترك الآن</p>
                </div>
            </div>
            
            ${me.role === 'teacher' ? `
            <div style="margin-top:30px; padding:20px; background:rgba(139, 92, 246, 0.1); border-radius:15px; border:2px solid var(--purple);">
                <h3 style="color:var(--purple);"><i class="fas fa-chalkboard-teacher"></i> لوحة الأستاذ</h3>
                <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:15px;">
                    <button class="btn-main" onclick="createLiveRoom()" style="background:var(--purple);">
                        <i class="fas fa-plus-circle"></i> إنشاء غرفة بث
                    </button>
                    <button class="btn-secondary" onclick="showTeacherStats()">
                        <i class="fas fa-chart-line"></i> الإحصائيات
                    </button>
                </div>
            </div>
            ` : ''}
            
            <div style="margin-top:30px;">
                <h3><i class="fas fa-fire" style="color:var(--accent);"></i> أحدث الكتب المضافة</h3>
                <div id="recent-books" class="loading">
                    <div class="loading-spinner"></div>
                    <div>جاري تحميل الكتب...</div>
                </div>
            </div>
        </div>`;
    
    loadRecentBooks();
}

// ==================== [ 11. دوال مساعدة ] ====================
function debounce(func, wait = 300) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function formatDate(timestamp) {
    if (!timestamp) return 'غير محدد';
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) return 'الآن';
    if (diff < 3600000) return `قبل ${Math.floor(diff / 60000)} دقيقة`;
    if (diff < 86400000) return `قبل ${Math.floor(diff / 3600000)} ساعة`;
    
    return date.toLocaleDateString('ar-SA');
}

function showLoading(message = 'جاري المعالجة...') {
    Swal.fire({
        title: message,
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading(),
        background: '#1e293b',
        color: '#fff'
    });
}

function hideLoading() {
    Swal.close();
}

function showSuccess(message) {
    Swal.fire({
        title: 'تم بنجاح!',
        text: message,
        icon: 'success',
        confirmButtonText: 'حسناً',
        background: '#1e293b',
        color: '#fff'
    });
}

function showError(message) {
    Swal.fire({
        title: 'خطأ!',
        text: message,
        icon: 'error',
        confirmButtonText: 'حسناً',
        background: '#1e293b',
        color: '#fff'
    });
}

// ==================== [ 12. الملف الشخصي ] ====================
function renderProfile() {
    if (!me) return;
    
    const area = document.getElementById('content-area');
    const isFreeTrial = me.freeTrial && me.freeUntil > Date.now();
    
    area.innerHTML = `
        <div style="padding:20px; text-align:center;">
            <div style="position:relative; display:inline-block;">
                <div style="width:120px; height:120px; border-radius:50%; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); display:flex; align-items:center; justify-content:center; border:4px solid var(--neon-blue);">
                    <i class="fas fa-user" style="font-size:50px; color:white;"></i>
                </div>
                ${me.role === 'teacher' ? `
                <div style="position:absolute; bottom:10px; right:-10px; background:var(--purple); color:white; padding:5px 10px; border-radius:15px; font-size:12px; font-weight:bold;">
                    <i class="fas fa-chalkboard-teacher"></i> أستاذ
                </div>
                ` : ''}
            </div>
            
            <h2 style="margin-top:15px;">${me.name}</h2>
            <p style="color:var(--text-sec);">
                ${me.role === 'teacher' ? `أستاذ ${me.subject}` : `طالب ${me.grade || ''}`}
            </p>
            
            <div style="display:flex; justify-content:center; gap:10px; margin:20px 0; flex-wrap:wrap;">
                <div style="background:rgba(59, 130, 246, 0.1); padding:15px; border-radius:15px; min-width:100px;">
                    <div style="font-size:14px; color:var(--text-sec);">الرصيد</div>
                    <div style="font-size:20px; font-weight:bold; color:var(--primary);">
                        ${me.balance ? me.balance.toLocaleString() : '0'} ج.س
                    </div>
                </div>
                
                <div style="background:rgba(245, 158, 11, 0.1); padding:15px; border-radius:15px; min-width:100px;">
                    <div style="font-size:14px; color:var(--text-sec);">الاشتراك</div>
                    <div style="font-size:20px; font-weight:bold; color:${me.subscription ? 'var(--green)' : 'var(--accent)'}">
                        ${me.subscription ? 'مفعل' : isFreeTrial ? 'تجربة' : 'غير مفعل'}
                    </div>
                </div>
            </div>
            
            <div style="background:var(--bg-card); padding:20px; border-radius:15px; margin:20px 0; text-align:right;">
                <h4 style="color:var(--neon-blue); margin-top:0;"><i class="fas fa-chart-line"></i> إحصائياتك</h4>
                
                <div style="margin:15px 0;">
                    <div style="display:flex; justify-content:space-between; margin:10px 0;">
                        <span style="color:var(--text-sec);">الاختبارات الذكية:</span>
                        <span style="font-weight:bold; color:var(--accent);">${me.aiQuizzesCount || 0}</span>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; margin:10px 0;">
                        <span style="color:var(--text-sec);">الكتب المحملة:</span>
                        <span style="font-weight:bold; color:var(--green);">${me.booksDownloaded || 0}</span>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; margin:10px 0;">
                        <span style="color:var(--text-sec);">جلسات البث المباشر:</span>
                        <span style="font-weight:bold; color:var(--purple);">${me.liveSessionsAttended || 0}</span>
                    </div>
                    
                    ${isFreeTrial ? `
                    <div style="display:flex; justify-content:space-between; margin:10px 0;">
                        <span style="color:var(--text-sec);">التجربة تنتهي بعد:</span>
                        <span style="font-weight:bold; color:var(--accent);">
                            ${Math.ceil((me.freeUntil - Date.now()) / (1000 * 60 * 60))} ساعة
                        </span>
                    </div>
                    ` : ''}
                    
                    <div style="display:flex; justify-content:space-between; margin:10px 0;">
                        <span style="color:var(--text-sec);">تاريخ الانضمام:</span>
                        <span style="font-weight:bold;">${formatDate(me.joinDate)}</span>
                    </div>
                </div>
            </div>
            
            ${me.role === 'teacher' ? `
            <div style="background:rgba(139, 92, 246, 0.1); padding:20px; border-radius:15px; margin:20px 0; text-align:right; border:2px solid var(--purple);">
                <h4 style="color:var(--purple); margin-top:0;"><i class="fas fa-money-bill-wave"></i> أرباحك</h4>
                <div style="font-size:32px; font-weight:bold; color:var(--purple); text-align:center; margin:15px 0;">
                    ${(me.totalEarnings || 0).toLocaleString()} ج.س
                </div>
                ${me.bankAccount ? `
                <p style="color:var(--text-sec);">رقم حسابك: <strong>${me.bankAccount}</strong></p>
                ` : `
                <button class="btn-secondary" onclick="updateBankAccount()" style="margin-top:10px;">
                    <i class="fas fa-edit"></i> إضافة رقم حساب
                </button>
                `}
            </div>
            ` : ''}
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-main" onclick="nav('subscription')" style="background:var(--green); flex:1;">
                    <i class="fas fa-crown"></i> تجديد الاشتراك
                </button>
                
                <button class="btn-main" onclick="doLogout()" style="background:var(--red); flex:1;">
                    <i class="fas fa-sign-out-alt"></i> تسجيل خروج
                </button>
            </div>
        </div>`;
}

async function updateBankAccount() {
    const { value: account } = await Swal.fire({
        title: 'تحديث رقم الحساب',
        input: 'text',
        inputLabel: 'رقم حسابك البنكي لتحويل الأرباح',
        inputPlaceholder: 'أدخل رقم حسابك',
        showCancelButton: true,
        confirmButtonText: 'حفظ',
        cancelButtonText: 'إلغاء',
        background: '#1e293b',
        color: '#fff'
    });
    
    if (!account) return;
    
    showLoading('جاري تحديث الحساب...');
    
    try {
        await db.ref(`users/${me.uid}/bankAccount`).set(account);
        me.bankAccount = account;
        
        hideLoading();
        showSuccess('تم تحديث رقم حسابك بنجاح');
        
    } catch (error) {
        hideLoading();
        showError('حدث خطأ أثناء التحديث: ' + error.message);
    }
}

function doLogout() {
    Swal.fire({
        title: 'تسجيل خروج',
        text: 'هل أنت متأكد من تسجيل الخروج؟',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'نعم، خروج',
        cancelButtonText: 'إلغاء',
        background: '#1e293b',
        color: '#fff'
    }).then(result => {
        if (result.isConfirmed) {
            auth.signOut();
        }
    });
}

// ==================== [ 13. الفصول الدراسية ] ====================
function renderGrades() {
    const area = document.getElementById('content-area');
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
                <button class="btn-secondary" onclick="nav('home')" style="width:auto; padding:10px 15px;">
                    <i class="fas fa-arrow-right"></i> رجوع
                </button>
                <h2 style="color:var(--neon-blue); margin:0;">الفصول الدراسية</h2>
            </div>
            
            <div class="grid">
                <div class="card" onclick="showGradeContent('الأول الابتدائي')">
                    <i class="fas fa-school" style="color:var(--primary)"></i>
                    <b>الصف الأول الابتدائي</b>
                    <p style="font-size:12px; color:var(--text-sec)">المرحلة التأسيسية</p>
                </div>
                
                <div class="card" onclick="showGradeContent('الثاني الابتدائي')">
                    <i class="fas fa-school" style="color:var(--accent)"></i>
                    <b>الصف الثاني الابتدائي</b>
                    <p style="font-size:12px; color:var(--text-sec)">المرحلة التأسيسية</p>
                </div>
                
                <div class="card" onclick="showGradeContent('الثالث الابتدائي')">
                    <i class="fas fa-school" style="color:var(--green)"></i>
                    <b>الصف الثالث الابتدائي</b>
                    <p style="font-size:12px; color:var(--text-sec)">المرحلة التأسيسية</p>
                </div>
                
                <div class="card" onclick="showGradeContent('الرابع الابتدائي')">
                    <i class="fas fa-school" style="color:var(--purple)"></i>
                    <b>الصف الرابع الابتدائي</b>
                    <p style="font-size:12px; color:var(--text-sec)">المرحلة المتوسطة</p>
                </div>
                
                <div class="card" onclick="showGradeContent('الخامس الابتدائي')">
                    <i class="fas fa-school" style="color:var(--red)"></i>
                    <b>الصف الخامس الابتدائي</b>
                    <p style="font-size:12px; color:var(--text-sec)">المرحلة المتوسطة</p>
                </div>
                
                <div class="card" onclick="showGradeContent('السادس الابتدائي')">
                    <i class="fas fa-school" style="color:var(--neon-blue)"></i>
                    <b>الصف السادس الابتدائي</b>
                    <p style="font-size:12px; color:var(--text-sec)">نهاية المرحلة الابتدائية</p>
                </div>
                
                <div class="card" onclick="showGradeContent('الأول المتوسط')">
                    <i class="fas fa-university" style="color:var(--primary)"></i>
                    <b>الصف الأول المتوسط</b>
                    <p style="font-size:12px; color:var(--text-sec)">بداية المرحلة المتوسطة</p>
                </div>
                
                <div class="card" onclick="showGradeContent('الثاني المتوسط')">
                    <i class="fas fa-university" style="color:var(--accent)"></i>
                    <b>الصف الثاني المتوسط</b>
                    <p style="font-size:12px; color:var(--text-sec)">المرحلة المتوسطة</p>
                </div>
                
                <div class="card" onclick="showGradeContent('الثالث المتوسط')">
                    <i class="fas fa-university" style="color:var(--green)"></i>
                    <b>الصف الثالث المتوسط</b>
                    <p style="font-size:12px; color:var(--text-sec)">نهاية المرحلة المتوسطة</p>
                </div>
                
                <div class="card" onclick="showGradeContent('الأول الثانوي')">
                    <i class="fas fa-graduation-cap" style="color:var(--purple)"></i>
                    <b>الصف الأول الثانوي</b>
                    <p style="font-size:12px; color:var(--text-sec)">بداية المرحلة الثانوية</p>
                </div>
                
                <div class="card" onclick="showGradeContent('الثاني الثانوي')">
                    <i class="fas fa-graduation-cap" style="color:var(--red)"></i>
                    <b>الصف الثاني الثانوي</b>
                    <p style="font-size:12px; color:var(--text-sec)">المرحلة الثانوية</p>
                </div>
                
                <div class="card" onclick="showGradeContent('الثالث الثانوي')">
                    <i class="fas fa-graduation-cap" style="color:var(--neon-blue)"></i>
                    <b>الصف الثالث الثانوي</b>
                    <p style="font-size:12px; color:var(--text-sec)">نهاية المرحلة الثانوية</p>
                </div>
            </div>
        </div>`;
}

function showGradeContent(grade) {
    const area = document.getElementById('content-area');
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
                <button class="btn-secondary" onclick="nav('grades')" style="width:auto; padding:10px 15px;">
                    <i class="fas fa-arrow-right"></i> رجوع
                </button>
                <h2 style="color:var(--neon-blue); margin:0;">${grade}</h2>
            </div>
            
            <div style="background:var(--bg-card); border-radius:20px; padding:25px; margin-bottom:25px;">
                <h3 style="color:var(--accent); margin-top:0;"><i class="fas fa-book"></i> المواد الدراسية</h3>
                <div class="grid">
                    <div class="card" onclick="showSubjectContent('الرياضيات', '${grade}')">
                        <i class="fas fa-calculator" style="color:var(--primary)"></i>
                        <b>الرياضيات</b>
                    </div>
                    
                    <div class="card" onclick="showSubjectContent('العلوم', '${grade}')">
                        <i class="fas fa-flask" style="color:var(--green)"></i>
                        <b>العلوم</b>
                    </div>
                    
                    <div class="card" onclick="showSubjectContent('اللغة العربية', '${grade}')">
                        <i class="fas fa-language" style="color:var(--accent)"></i>
                        <b>اللغة العربية</b>
                    </div>
                    
                    <div class="card" onclick="showSubjectContent('اللغة الإنجليزية', '${grade}')">
                        <i class="fas fa-language" style="color:var(--red)"></i>
                        <b>اللغة الإنجليزية</b>
                    </div>
                    
                    <div class="card" onclick="showSubjectContent('الاجتماعيات', '${grade}')">
                        <i class="fas fa-globe-africa" style="color:var(--purple)"></i>
                        <b>الاجتماعيات</b>
                    </div>
                    
                    <div class="card" onclick="showSubjectContent('التربية الإسلامية', '${grade}')">
                        <i class="fas fa-mosque" style="color:var(--neon-blue)"></i>
                        <b>التربية الإسلامية</b>
                    </div>
                </div>
            </div>
            
            <div id="grade-books">
                <h3><i class="fas fa-book-open" style="color:var(--accent);"></i> كتب ${grade}</h3>
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>جاري تحميل الكتب...</div>
                </div>
            </div>
        </div>`;
    
    loadGradeBooks(grade);
}

function showSubjectContent(subject, grade) {
    const area = document.getElementById('content-area');
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
                <button class="btn-secondary" onclick="showGradeContent('${grade}')" style="width:auto; padding:10px 15px;">
                    <i class="fas fa-arrow-right"></i> رجوع
                </button>
                <h2 style="color:var(--neon-blue); margin:0;">${subject} - ${grade}</h2>
            </div>
            
            <div style="background:var(--bg-card); border-radius:20px; padding:25px; margin-bottom:25px;">
                <h3 style="color:var(--accent); margin-top:0;"><i class="fas fa-play-circle"></i> دروس الفيديو</h3>
                <div class="grid">
                    <div class="card" onclick="playVideo('${subject}', '${grade}', 1)">
                        <i class="fas fa-video" style="color:var(--primary)"></i>
                        <b>الدرس الأول</b>
                        <p style="font-size:12px; color:var(--text-sec)">المقدمة والأساسيات</p>
                    </div>
                    
                    <div class="card" onclick="playVideo('${subject}', '${grade}', 2)">
                        <i class="fas fa-video" style="color:var(--accent)"></i>
                        <b>الدرس الثاني</b>
                        <p style="font-size:12px; color:var(--text-sec)">التطبيقات العملية</p>
                    </div>
                    
                    <div class="card" onclick="playVideo('${subject}', '${grade}', 3)">
                        <i class="fas fa-video" style="color:var(--green)"></i>
                        <b>الدرس الثالث</b>
                        <p style="font-size:12px; color:var(--text-sec)">تمارين وتطبيقات</p>
                    </div>
                </div>
            </div>
            
            <div style="background:var(--bg-card); border-radius:20px; padding:25px; margin-bottom:25px;">
                <h3 style="color:var(--accent); margin-top:0;"><i class="fas fa-file-alt"></i> الاختبارات</h3>
                <div class="grid">
                    <div class="card" onclick="startQuiz('${subject}', '${grade}', 'اختبار قصير')">
                        <i class="fas fa-question-circle" style="color:var(--primary)"></i>
                        <b>اختبار قصير</b>
                        <p style="font-size:12px; color:var(--text-sec)">10 أسئلة - 15 دقيقة</p>
                    </div>
                    
                    <div class="card" onclick="startQuiz('${subject}', '${grade}', 'اختبار منتصف الفصل')">
                        <i class="fas fa-question-circle" style="color:var(--accent)"></i>
                        <b>اختبار منتصف الفصل</b>
                        <p style="font-size:12px; color:var(--text-sec)">20 سؤال - 30 دقيقة</p>
                    </div>
                    
                    <div class="card" onclick="startQuiz('${subject}', '${grade}', 'اختبار نهائي')">
                        <i class="fas fa-question-circle" style="color:var(--green)"></i>
                        <b>اختبار نهائي</b>
                        <p style="font-size:12px; color:var(--text-sec)">30 سؤال - 45 دقيقة</p>
                    </div>
                </div>
            </div>
            
            <div id="subject-books">
                <h3><i class="fas fa-book" style="color:var(--accent);"></i> كتب ${subject} للصف ${grade}</h3>
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div>جاري تحميل الكتب...</div>
                </div>
            </div>
        </div>`;
    
    loadSubjectBooks(subject, grade);
}

function loadGradeBooks(grade) {
    const container = document.getElementById('grade-books');
    if (!container) return;
    
    db.ref('books').orderByChild('grade').equalTo(grade).limitToLast(5).on('value', snap => {
        const books = snap.val();
        container.innerHTML = '<h3><i class="fas fa-book-open" style="color:var(--accent);"></i> كتب ' + grade + '</h3>';
        
        if (!books || Object.keys(books).length === 0) {
            container.innerHTML += `
                <div style="text-align:center; padding:20px; color:var(--text-sec);">
                    <i class="fas fa-book" style="font-size:48px; margin-bottom:15px; opacity:0.5;"></i>
                    <p>لا توجد كتب لهذا الصف بعد</p>
                </div>`;
            return;
        }
        
        Object.entries(books).reverse().forEach(([bookId, book]) => {
            const isFree = !book.price || book.price === 0;
            
            container.innerHTML += `
                <div class="book-card">
                    <div style="width:80px; height:100px; background:var(--accent); border-radius:10px; display:flex; align-items:center; justify-content:center;">
                        <i class="fas fa-book-open" style="font-size:32px; color:white;"></i>
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size:16px; margin-bottom:5px;">${book.title}</div>
                        <div style="font-size:12px; color:var(--text-sec); margin-bottom:5px;">
                            <i class="fas fa-user"></i> ${book.author}
                        </div>
                        <div style="font-size:11px; color:var(--text-sec); margin-top:8px;">
                            <span style="background:rgba(59, 130, 246, 0.2); color:var(--primary); padding:3px 8px; border-radius:5px; margin-right:5px;">
                                ${book.subject}
                            </span>
                        </div>
                    </div>
                    <button class="btn-main" style="padding:8px 12px; font-size:12px;" 
                            onclick="nav('book_detail', '${bookId}')">
                        <i class="fas fa-eye"></i> عرض
                    </button>
                </div>`;
        });
    });
}

function loadSubjectBooks(subject, grade) {
    const container = document.getElementById('subject-books');
    if (!container) return;
    
    db.ref('books').orderByChild('subject').equalTo(subject).on('value', snap => {
        const books = snap.val();
        container.innerHTML = '<h3><i class="fas fa-book" style="color:var(--accent);"></i> كتب ' + subject + ' للصف ' + grade + '</h3>';
        
        if (!books || Object.keys(books).length === 0) {
            container.innerHTML += `
                <div style="text-align:center; padding:20px; color:var(--text-sec);">
                    <i class="fas fa-book" style="font-size:48px; margin-bottom:15px; opacity:0.5;"></i>
                    <p>لا توجد كتب لهذه المادة بعد</p>
                </div>`;
            return;
        }
        
        Object.entries(books).forEach(([bookId, book]) => {
            if (book.grade === grade) {
                const isFree = !book.price || book.price === 0;
                
                container.innerHTML += `
                    <div class="book-card">
                        <div style="width:80px; height:100px; background:var(--accent); border-radius:10px; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-book-open" style="font-size:32px; color:white;"></i>
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight:bold; font-size:16px; margin-bottom:5px;">${book.title}</div>
                            <div style="font-size:12px; color:var(--text-sec); margin-bottom:5px;">
                                <i class="fas fa-user"></i> ${book.author}
                            </div>
                            <div style="font-size:11px; color:var(--text-sec); margin-top:8px;">
                                <span style="background:${isFree ? 'var(--green)' : 'var(--accent)'}; color:${isFree ? 'white' : 'black'}; padding:3px 8px; border-radius:5px; font-size:11px; font-weight:bold;">
                                    ${isFree ? 'مجاني' : book.price + ' ج.س'}
                                </span>
                            </div>
                        </div>
                        <button class="btn-main" style="padding:8px 12px; font-size:12px;" 
                                onclick="nav('book_detail', '${bookId}')">
                            <i class="fas fa-eye"></i> عرض
                        </button>
                    </div>`;
            }
        });
    });
}

function playVideo(subject, grade, lesson) {
    showError('هذه الميزة قيد التطوير');
}

function startQuiz(subject, grade, type) {
    showError('هذه الميزة قيد التطوير');
}

// ==================== [ 14. تحميل الكتب الحديثة ] ====================
function loadRecentBooks() {
    const container = document.getElementById('recent-books');
    if (!container) return;
    
    db.ref('books').orderByChild('addedDate').limitToLast(3).on('value', snap => {
        const books = snap.val();
        container.innerHTML = '';
        
        if (!books) {
            container.innerHTML = '<p style="text-align:center; padding:20px; color:var(--text-sec);">لا توجد كتب حديثة</p>';
            return;
        }
        
        Object.entries(books).reverse().forEach(([bookId, book]) => {
            const isFree = !book.price || book.price === 0;
            
            container.innerHTML += `
                <div class="post" style="margin-bottom:10px;">
                    <div style="display:flex; align-items:center; padding:15px;">
                        <div style="width:50px; height:70px; background:var(--accent); border-radius:8px; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-book-open" style="font-size:24px; color:white;"></i>
                        </div>
                        <div style="flex:1; margin-right:15px;">
                            <div style="font-weight:bold; font-size:14px;">${book.title}</div>
                            <div style="font-size:11px; color:var(--text-sec);">
                                <i class="fas fa-user"></i> ${book.author}
                            </div>
                            <div style="font-size:10px; color:var(--accent); margin-top:3px;">
                                <i class="fas fa-graduation-cap"></i> ${book.grade} • ${book.subject}
                            </div>
                        </div>
                        <span style="background:${isFree ? 'var(--green)' : 'var(--accent)'}; color:${isFree ? 'white' : 'black'}; padding:3px 8px; border-radius:5px; font-size:11px;">
                            ${isFree ? 'مجاني' : book.price + ' ج.س'}
                        </span>
                    </div>
                </div>`;
        });
    });
}

// ==================== [ 15. البحث ] ====================
const debounceSearch = debounce(function(query) {
    const container = document.getElementById('books-list');
    if (!container) return;
    
    db.ref('books').once('value').then(snap => {
        const books = snap.val();
        container.innerHTML = '';
        
        if (!books) return;
        
        const searchTerm = query.toLowerCase();
        Object.keys(books).forEach(bookId => {
            const book = books[bookId];
            const title = book.title.toLowerCase();
            const author = book.author.toLowerCase();
            const subject = book.subject.toLowerCase();
            const grade = book.grade.toLowerCase();
            
            if (title.includes(searchTerm) || author.includes(searchTerm) || 
                subject.includes(searchTerm) || grade.includes(searchTerm)) {
                
                const isFree = !book.price || book.price === 0;
                
                container.innerHTML += `
                    <div class="book-card">
                        <div style="width:80px; height:100px; background:var(--accent); border-radius:10px; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-book-open" style="font-size:32px; color:white;"></i>
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight:bold; font-size:16px; margin-bottom:5px;">${book.title}</div>
                            <div style="font-size:12px; color:var(--text-sec); margin-bottom:5px;">
                                <i class="fas fa-user"></i> ${book.author}
                            </div>
                            <div style="font-size:11px; color:var(--text-sec); margin-top:8px;">
                                <span class="grade-badge">${book.grade}</span>
                                <span style="background:rgba(59, 130, 246, 0.2); color:var(--primary); padding:3px 8px; border-radius:5px; margin-right:5px;">
                                    ${book.subject}
                                </span>
                            </div>
                        </div>
                        <button class="btn-main" style="padding:8px 12px; font-size:12px;" 
                                onclick="nav('book_detail', '${bookId}')">
                            <i class="fas fa-eye"></i> عرض
                        </button>
                    </div>`;
            }
        });
    });
}, 500);

const debounceFilter = debounce(function(query) {
    debounceSearch(query);
}, 300);
// ==================== [ دوال المكتبة والمساعد والبث المفقودة ] ====================

// 1. دالة عرض المكتبة

// ==================== [ 16. التهيئة النهائية ] ====================
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        initializeApp();
    }, 1000);
});

// جعل الدوال متاحة عالمياً
window.nav = nav;
window.showLoginScreen = showLoginScreen;
window.showRegisterOptions = showRegisterOptions;
window.showStudentForm = showStudentForm;
window.showTeacherForm = showTeacherForm;
window.backToLogin = backToLogin;
window.backToRegister = backToRegister;
window.loginUser = loginUser;
window.registerStudent = registerStudent;
window.registerTeacher = registerTeacher;
window.handleBackButton = handleBackButton;
window.showGradeContent = showGradeContent;
window.showSubjectContent = showSubjectContent;
window.updateBankAccount = updateBankAccount;
window.doLogout = doLogout;
    // ==================== [ دوال المكتبة والمساعد والبث المفقودة ] ====================

// 1. دالة عرض المكتبة
function renderLibrary() {
    const area = document.getElementById('content-area');
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
                <button class="btn-secondary" onclick="nav('home')" style="width:auto; padding:10px 15px;">
                    <i class="fas fa-arrow-right"></i> رجوع
                </button>
                <h2 style="color:var(--neon-blue); margin:0;">المكتبة الرقمية</h2>
            </div>
            
            ${me.role === 'admin' || me.role === 'teacher' ? `
            <button class="btn-main" onclick="nav('add_book')" style="margin-bottom:20px;">
                <i class="fas fa-plus"></i> إضافة كتاب جديد
            </button>
            ` : ''}

            <div id="all-books-list" class="loading">
                <div class="loading-spinner"></div>
                <div>جاري تحميل الكتب...</div>
            </div>
        </div>`;
    
    // تحميل الكتب من Firebase
    const container = document.getElementById('all-books-list');
    db.ref('books').once('value', snap => {
        const books = snap.val();
        container.innerHTML = '';
        if (!books) {
            container.innerHTML = '<p style="text-align:center; color:var(--text-sec)">لا توجد كتب مضافة حالياً</p>';
            return;
        }
        Object.entries(books).reverse().forEach(([bookId, book]) => {
            const isFree = !book.price || book.price === 0;
            container.innerHTML += `
                <div class="book-card">
                    <div style="width:80px; height:100px; background:var(--accent); border-radius:10px; display:flex; align-items:center; justify-content:center;">
                        <i class="fas fa-book-open" style="font-size:32px; color:white;"></i>
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:bold; font-size:16px; margin-bottom:5px;">${book.title}</div>
                        <div style="font-size:12px; color:var(--text-sec); margin-bottom:5px;">
                            <i class="fas fa-user"></i> ${book.author}
                        </div>
                        <div style="font-size:11px; color:var(--text-sec);">
                            <span class="grade-badge">${book.grade}</span>
                            <span style="background:${isFree ? 'var(--green)' : 'var(--accent)'}; color:${isFree ? 'white' : 'black'}; padding:2px 8px; border-radius:5px; margin-right:5px;">
                                ${isFree ? 'مجاني' : book.price + ' ج.س'}
                            </span>
                        </div>
                    </div>
                    <button class="btn-main" style="padding:8px 12px; font-size:12px;" onclick="nav('book_detail', '${bookId}')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>`;
        });
    });
}

// 2. دالة عرض المساعد الذكي
function renderAIAssistant() {
    const area = document.getElementById('content-area');
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="background:linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%); padding:25px; border-radius:20px; text-align:center; margin-bottom:20px;">
                <i class="fas fa-robot" style="font-size:50px; color:white; margin-bottom:15px;"></i>
                <h2 style="color:white; margin:0;">المساعد الذكي</h2>
                <p style="color:rgba(255,255,255,0.8);">يمكنني إنشاء اختبارات وتلخيص الدروس لك</p>
            </div>
            
            <div style="background:var(--bg-card); padding:20px; border-radius:15px; border:1px solid var(--border);">
                <h3 style="color:var(--neon-blue);">إنشاء اختبار جديد</h3>
                
                <label style="color:var(--text-sec);">المادة:</label>
                <select id="ai-subject">
                    <option value="الرياضيات">الرياضيات</option>
                    <option value="العلوم">العلوم</option>
                    <option value="اللغة العربية">اللغة العربية</option>
                    <option value="التاريخ">التاريخ</option>
                </select>
                
                <label style="color:var(--text-sec);">موضوع الدرس:</label>
                <input type="text" id="ai-topic" placeholder="مثال: الكسور، المجموعة الشمسية...">
                
                <button class="btn-main" onclick="generateQuizAI()">
                    <i class="fas fa-magic"></i> توليد الاختبار
                </button>
            </div>
        </div>`;
}

// دالة وهمية لتوليد الاختبار (لربطها بالسيرفر لاحقاً)
async function generateQuizAI() {
    const topic = document.getElementById('ai-topic').value;
    if(!topic) return showError('اكتب موضوع الدرس');
    
    showLoading('جاري التحدث مع الذكاء الاصطناعي...');
    
    // هنا يتم الاتصال بـ server.js الخاص بك
    try {
        const response = await fetch('/api/generate-quiz', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                subject: document.getElementById('ai-subject').value,
                chapter: topic,
                count: 5
            })
        });
        const data = await response.json();
        hideLoading();
        
        if(data.success) {
            showSuccess('تم توليد الأسئلة بنجاح! (سيتم العرض قريباً)');
            console.log(data.questions);
        } else {
            showError('فشل التوليد');
        }
    } catch (e) {
        hideLoading();
        showError('خطأ في الاتصال بالسيرفر: تأكد من تشغيل server.js');
    }
}

// 3. دالة عرض البث المباشر
function renderLiveRooms() {
    const area = document.getElementById('content-area');
    area.innerHTML = `
        <div style="padding:20px;">
            <h2 style="color:var(--red); text-align:center;"><i class="fas fa-broadcast-tower"></i> البث المباشر</h2>
            
            ${me.role === 'teacher' ? `
            <button class="btn-main" onclick="createLiveRoom()" style="background:var(--red); margin-bottom:20px;">
                <i class="fas fa-video"></i> بدء بث جديد
            </button>
            ` : ''}
            
            <div id="live-list">
                <p style="text-align:center; color:var(--text-sec); margin-top:50px;">
                    لا يوجد بث مباشر نشط حالياً
                </p>
            </div>
        </div>`;
}

// 4. دالة عرض تفاصيل الكتاب (مهمة جداً لكي لا يتوقف التطبيق عند فتح كتاب)
function loadBookDetail(bookId) {
    const area = document.getElementById('content-area');
    showLoading();
    
    db.ref('books/' + bookId).once('value', snap => {
        hideLoading();
        const book = snap.val();
        if(!book) return showError('الكتاب غير موجود');
        
        area.innerHTML = `
        <div style="padding:20px;">
            <button class="btn-secondary" onclick="handleBackButton()" style="width:auto; margin-bottom:15px;">
                <i class="fas fa-arrow-right"></i> رجوع
            </button>
            
            <div style="text-align:center; margin-bottom:20px;">
                <div style="width:120px; height:160px; background:var(--accent); border-radius:15px; margin:0 auto 15px; display:flex; align-items:center; justify-content:center;">
                    <i class="fas fa-book-open" style="font-size:50px; color:white;"></i>
                </div>
                <h2>${book.title}</h2>
                <p style="color:var(--text-sec);">${book.author}</p>
                <div class="grade-badge" style="display:inline-block;">${book.grade}</div>
            </div>
            
            <div style="background:var(--bg-card); padding:20px; border-radius:15px;">
                <p>${book.description || 'لا يوجد وصف للكتاب'}</p>
                
                <a href="${book.url}" target="_blank" class="btn-main" style="text-decoration:none; text-align:center; display:block;">
                    <i class="fas fa-download"></i> تحميل الكتاب
                </a>
            </div>
        </div>`;
    });
}

// 5. دالة الاشتراكات
function renderSubscription() {
    const area = document.getElementById('content-area');
    area.innerHTML = `
        <div style="padding:20px; text-align:center;">
            <i class="fas fa-crown" style="font-size:60px; color:var(--accent); margin-bottom:20px;"></i>
            <h2>الاشتراك المميز</h2>
            <p style="color:var(--text-sec);">احصل على وصول كامل لجميع الكتب والميزات</p>
            
            <div class="card" style="border:2px solid var(--accent); transform:none;">
                <h3>الباقة الشهرية</h3>
                <h1 style="color:var(--primary);">7,000 ج.س</h1>
                <button class="btn-main">اشترك الآن</button>
            </div>
        </div>`;
}

// 6. دالة إضافة كتاب (للأدمن والمدرسين)
function renderAddBook() {
    const area = document.getElementById('content-area');
    area.innerHTML = `
        <div style="padding:20px;">
            <h2>إضافة كتاب جديد</h2>
            <input type="text" id="new-book-title" placeholder="عنوان الكتاب">
            <input type="text" id="new-book-author" placeholder="اسم المؤلف">
            <select id="new-book-grade">
                <option value="الأول الثانوي">الأول الثانوي</option>
                <option value="الثاني الثانوي">الثاني الثانوي</option>
                <option value="الثالث الثانوي">الثالث الثانوي</option>
            </select>
            <input type="text" id="new-book-url" placeholder="رابط الكتاب (PDF)">
            <button class="btn-main" onclick="saveNewBook()">حفظ الكتاب</button>
        </div>`;
}

// دالة حفظ الكتاب
function saveNewBook() {
    const title = document.getElementById('new-book-title').value;
    const author = document.getElementById('new-book-author').value;
    const grade = document.getElementById('new-book-grade').value;
    const url = document.getElementById('new-book-url').value;

    if(!title || !url) return showError('العنوان والرابط مطلوبان');

    const newBookRef = db.ref('books').push();
    newBookRef.set({
        title: title,
        author: author,
        grade: grade,
        url: url,
        subject: 'عام',
        price: 0,
        addedDate: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
        showSuccess('تمت إضافة الكتاب');
        nav('library');
    });
}

// 7. دالة لوحة التحكم (للأدمن)
function renderAdminPanel() {
     const area = document.getElementById('content-area');
     area.innerHTML = `<div style="padding:20px;"><h2>لوحة التحكم</h2><p>خاصة بالمشرفين فقط</p></div>`;
}
</script>
</body>
</html>

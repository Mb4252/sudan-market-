<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global EX | Safe Escrow Exchange</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=IBM+Plex+Sans:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <style>
        :root {
            --bg-main: #0b0e11; --bg-card: #181a20; --bg-input: #2b3139;
            --primary: #fcd535; --text-main: #eaecef; --text-sec: #848e9c;
            --green: #0ecb81; --red: #f6465d; --border: #2b3139;
        }

        body {
            font-family: 'Cairo', sans-serif; background-color: var(--bg-main);
            color: var(--text-main); margin: 0; padding-bottom: 70px; overflow-x: hidden;
        }
        .num { font-family: 'IBM Plex Sans', sans-serif; direction: ltr; display: inline-block; }

        header { background: var(--bg-card); padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .logo { font-size: 20px; font-weight: bold; color: var(--primary); }

        .market-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .current-price { font-size: 22px; font-weight: bold; }

        #chart-area { height: 250px; background: #0b0e11; border-bottom: 1px solid var(--border); }

        .trade-container { display: grid; grid-template-columns: 1fr 1.2fr; gap: 8px; padding: 10px; }
        
        .order-book { font-size: 11px; height: 350px; overflow: hidden; background: var(--bg-card); border-radius: 8px; padding: 8px; border: 1px solid var(--border); }
        .ob-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #222; cursor: pointer; }
        
        .trade-form { background: var(--bg-card); padding: 12px; border-radius: 8px; border: 1px solid var(--border); }
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab { flex: 1; text-align: center; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; background: var(--bg-input); font-size: 13px; }
        .tab.buy.active { background: var(--green); color: white; }
        .tab.sell.active { background: var(--red); color: white; }

        input { width: 100%; background: var(--bg-input); border: 1px solid var(--border); color: white; padding: 12px; border-radius: 4px; margin-bottom: 10px; font-size: 14px; }
        .btn-exec { width: 100%; padding: 14px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; }

        .nav { position: fixed; bottom: 0; width: 100%; background: var(--bg-card); display: flex; border-top: 1px solid var(--border); z-index: 1000; }
        .nav-item { flex: 1; text-align: center; padding: 12px; font-size: 12px; color: var(--text-sec); cursor: pointer; }
        .nav-item.active { color: var(--primary); }

        .screen { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .screen.active { display: block; }

        .bal-card { background: var(--bg-card); padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border); }
        .admin-badge { background: var(--primary); color: black; font-size: 10px; padding: 2px 6px; border-radius: 3px; }
    </style>
</head>
<body>

<header>
    <div class="logo"><i class="fas fa-shield-alt"></i> Global EX</div>
    <div id="admin-tag"></div>
</header>

<!-- شاشة التداول -->
<div id="market-screen" class="screen active" style="padding:0">
    <div class="market-header">
        <select id="pair-selector" onchange="changePair()" style="background:none; color:white; border:none; font-size:18px; font-weight:bold; outline:none;">
            <!-- يتم تعبئته من الداتابيز -->
        </select>
        <div class="current-price num" id="last-price">0.00</div>
    </div>

    <div id="chart-area"></div>

    <div class="trade-container">
        <div class="order-book">
            <div style="text-align:center; color:var(--text-sec); font-size:10px; margin-bottom:10px;">خزنة الوسيط (Escrow Book)</div>
            <div id="asks-list" style="display:flex; flex-direction:column-reverse;"></div>
            <div id="mid-price" class="num" style="text-align:center; margin:10px 0; display:block; font-weight:bold; border-y:1px solid #333; padding:5px 0;">---</div>
            <div id="bids-list"></div>
        </div>

        <div class="trade-form">
            <div class="tabs">
                <div class="tab buy active" id="t-buy" onclick="setSide('buy')">شراء</div>
                <div class="tab sell" id="t-sell" onclick="setSide('sell')">بيع</div>
            </div>
            <input type="number" id="order-price" class="num" placeholder="السعر">
            <input type="number" id="order-qty" class="num" placeholder="الكمية">
            <div style="font-size:11px; color:var(--text-sec); margin-bottom:15px;">
                المتاح: <span id="user-bal" class="num">0.00</span> <span id="bal-sym">SDM</span>
            </div>
            <button class="btn-exec" id="exec-btn" onclick="placeSafeOrder()" style="background:var(--green); color:white;">تأمين الشراء عبر البوت</button>
            <p style="font-size:9px; color:var(--text-sec); text-align:center; margin-top:10px;">* البوت يضمن حق البائع والمشتري بالكامل</p>
        </div>
    </div>
</div>

<!-- شاشة المحفظة -->
<div id="wallet-screen" class="screen">
    <h2>محفظتي الآمنة</h2>
    <div id="balances-list"></div>
    <div style="margin-top:20px;">
        <p style="font-size:12px; color:var(--text-sec);">ID الخاص بك (لعملية الإيداع):</p>
        <code id="my-uid" style="background:#000; padding:10px; display:block; color:var(--primary); text-align:center; border-radius:5px;">----</code>
    </div>
</div>

<!-- شاشة الأدمن -->
<div id="admin-screen" class="screen">
    <h2 style="color:var(--primary)">إدارة المنصة والسيولة</h2>
    <div class="trade-form" style="margin-bottom:15px;">
        <h3>إدراج عملة</h3>
        <input id="new-coin-sym" placeholder="الرمز (MRK, BTC...)">
        <input id="new-coin-name" placeholder="الاسم الكامل">
        <button onclick="addNewCoin()" class="btn-exec" style="background:white; color:black;">إدراج العملة</button>
    </div>
    <div class="trade-form">
        <h3>شحن رصيد مستخدم (SDM)</h3>
        <input id="target-uid" placeholder="UID المستخدم">
        <input id="dep-amount" type="number" placeholder="المبلغ">
        <button onclick="adminDeposit()" class="btn-exec" style="background:var(--primary); color:black;">تأكيد الإيداع</button>
    </div>
</div>

<nav class="nav">
    <div class="nav-item active" onclick="nav('market-screen', this)"><i class="fas fa-exchange-alt"></i><br>تداول</div>
    <div class="nav-item" onclick="nav('wallet-screen', this)"><i class="fas fa-wallet"></i><br>المحفظة</div>
    <div class="nav-item" id="nav-admin" style="display:none;" onclick="nav('admin-screen', this)"><i class="fas fa-user-shield"></i><br>الأدمن</div>
</nav>

<script>
    // تكوين Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyAI_mUhuPNoO-XC0Q-VNoWft8UWFbAbIGg",
        authDomain: "sudan-market-6b122.firebaseapp.com",
        databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com",
        projectId: "sudan-market-6b122",
        storageBucket: "sudan-market-6b122.firebasestorage.app",
        messagingSenderId: "66729481566",
        appId: "1:66729481566:web:93393f28dc22d32cceebcf"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let user = null;
    let currentPair = "MRK_SDM";
    let side = 'buy';
    const ADMIN_EMAIL = "admin@global.com"; // غير هذا لبريدك

    auth.onAuthStateChanged(u => {
        if(u) {
            user = u;
            document.getElementById('my-uid').innerText = u.uid;
            if(u.email === ADMIN_EMAIL) {
                document.getElementById('nav-admin').style.display = 'block';
                document.getElementById('admin-tag').innerHTML = '<span class="admin-badge">ADMIN</span>';
            }
            initSystem();
        } else {
            auth.signInAnonymously();
        }
    });

    function initSystem() {
        loadCoins();
        syncBalances();
        listenToEscrow(); // تشغيل بوت المطابقة الآمن
    }

    // --- بوت الوسيط الآمن (Matching & Escrow Bot) ---
    function listenToEscrow() {
        db.ref('orders/' + currentPair).on('value', snap => {
            const orders = snap.val();
            if(!orders) return;

            const bids = []; const asks = [];
            Object.keys(orders).forEach(id => {
                const o = {id, ...orders[id]};
                if(o.side === 'buy') bids.push(o); else asks.push(o);
            });

            // ترتيب الطلبات (أعلى شراء مع أقل بيع)
            bids.sort((a,b) => b.price - a.price);
            asks.sort((a,b) => a.price - b.price);

            if(bids.length > 0 && asks.length > 0) {
                const topBid = bids[0];
                const topAsk = asks[0];

                // إذا تطابق السعر أو كان الشراء أعلى من البيع
                if(topBid.price >= topAsk.price) {
                    processSafeTrade(topBid, topAsk);
                }
            }
            renderOrderBook(orders);
        });
    }

    async function processSafeTrade(bid, ask) {
        // البوت يسحب الأصول من "خزنته" ويوزعها
        const tradePrice = ask.price; // السعر الذي وضعه البائع أولاً
        const tradeQty = Math.min(bid.qty, ask.qty);
        const base = currentPair.split('_')[0];
        const quote = currentPair.split('_')[1];

        // تحديث المشتري (يستلم العملة)
        db.ref(`users/${bid.uid}/balances/${base}`).transaction(b => (b || 0) + tradeQty);
        // تحديث البائع (يستلم المال SDM)
        db.ref(`users/${ask.uid}/balances/${quote}`).transaction(b => (b || 0) + (tradeQty * tradePrice));

        // تحديث أو حذف الطلبات المنفذة من الخزنة
        if(bid.qty > tradeQty) db.ref(`orders/${currentPair}/${bid.id}/qty`).set(bid.qty - tradeQty);
        else db.ref(`orders/${currentPair}/${bid.id}`).remove();

        if(ask.qty > tradeQty) db.ref(`orders/${currentPair}/${ask.id}/qty`).set(ask.qty - tradeQty);
        else db.ref(`orders/${currentPair}/${ask.id}`).remove();

        // تسجيل العملية في التاريخ
        db.ref('history/' + currentPair).push({price: tradePrice, qty: tradeQty, time: Date.now()});
    }

    // --- نظام وضع الطلبات (تأمين الأصول) ---
    async function placeSafeOrder() {
        const price = parseFloat(document.getElementById('order-price').value);
        const qty = parseFloat(document.getElementById('order-qty').value);
        if(!price || !qty) return;

        const base = currentPair.split('_')[0];
        const quote = currentPair.split('_')[1];
        
        const snap = await db.ref(`users/${user.uid}/balances`).once('value');
        const bals = snap.val() || {};

        if(side === 'buy') {
            const cost = price * qty;
            if((bals[quote] || 0) < cost) return Swal.fire('فشل', 'رصيدك صفر أو غير كافٍ. يرجى الشحن من الأدمن.', 'error');
            // البوت يحجز المال من المشتري
            db.ref(`users/${user.uid}/balances/${quote}`).set(bals[quote] - cost);
        } else {
            if((bals[base] || 0) < qty) return Swal.fire('فشل', 'ليس لديك كمية كافية من العملة لبيعها.', 'error');
            // البوت يحجز العملة من البائع
            db.ref(`users/${user.uid}/balances/${base}`).set(bals[base] - qty);
        }

        // إضافة الطلب إلى خزنة الوسيط (البوت)
        db.ref('orders/' + currentPair).push({
            uid: user.uid,
            price: price,
            qty: qty,
            side: side,
            time: Date.now()
        });

        Swal.fire({title: 'تم التأمين', text: 'تم استلام الأصول من قبلك وهي في خزنة البوت الآن حتى مطابقة السعر', icon: 'success', timer: 2000});
    }

    // --- إدارة الأرصدة والعملات ---
    function syncBalances() {
        db.ref(`users/${user.uid}/balances`).on('value', snap => {
            const bals = snap.val() || {};
            const list = document.getElementById('balances-list');
            list.innerHTML = '';
            
            const coins = ['SDM', ...Object.keys(bals).filter(k => k !== 'SDM')];
            coins.forEach(c => {
                list.innerHTML += `
                    <div class="bal-card">
                        <div style="display:flex; justify-content:space-between;">
                            <b>${c}</b> <span class="num">${(bals[c] || 0).toFixed(c === 'SDM' ? 2 : 4)}</span>
                        </div>
                    </div>`;
            });

            const currentBase = currentPair.split('_')[0];
            const currentQuote = currentPair.split('_')[1];
            document.getElementById('user-bal').innerText = (side === 'buy' ? (bals[currentQuote] || 0) : (bals[currentBase] || 0)).toFixed(2);
            document.getElementById('bal-sym').innerText = (side === 'buy' ? currentQuote : currentBase);
        });
    }

    function loadCoins() {
        db.ref('coins').on('value', snap => {
            const coinsData = snap.val() || { "MRK": {name:"Maker"}, "SDM": {name:"Stable"} };
            const sel = document.getElementById('pair-selector');
            sel.innerHTML = '';
            Object.keys(coinsData).forEach(c => {
                if(c !== 'SDM') sel.innerHTML += `<option value="${c}_SDM">${c}/SDM</option>`;
            });
        });
    }

    // --- وظائف الأدمن ---
    function adminDeposit() {
        const uid = document.getElementById('target-uid').value;
        const amount = parseFloat(document.getElementById('dep-amount').value);
        if(uid && amount) {
            db.ref(`users/${uid}/balances/SDM`).transaction(b => (b || 0) + amount);
            Swal.fire('تم', 'تم شحن رصيد المستخدم بنجاح', 'success');
        }
    }

    function addNewCoin() {
        const sym = document.getElementById('new-coin-sym').value.toUpperCase();
        const name = document.getElementById('new-coin-name').value;
        if(sym && name) db.ref('coins/' + sym).set({name});
    }

    // --- UI Helpers ---
    function renderOrderBook(orders) {
        const asksList = document.getElementById('asks-list');
        const bidsList = document.getElementById('bids-list');
        asksList.innerHTML = ''; bidsList.innerHTML = '';
        
        const bids = []; const asks = [];
        Object.values(orders).forEach(o => { if(o.side === 'buy') bids.push(o); else asks.push(o); });
        
        asks.sort((a,b) => a.price - b.price).slice(0, 10).forEach(o => {
            asksList.innerHTML += `<div class="ob-row" onclick="setPrice(${o.price})"><span style="color:var(--red)" class="num">${o.price.toFixed(2)}</span><span class="num">${o.qty}</span></div>`;
        });
        bids.sort((a,b) => b.price - a.price).slice(0, 10).forEach(o => {
            bidsList.innerHTML += `<div class="ob-row" onclick="setPrice(${o.price})"><span style="color:var(--green)" class="num">${o.price.toFixed(2)}</span><span class="num">${o.qty}</span></div>`;
        });
    }

    function setPrice(p) { document.getElementById('order-price').value = p; }
    function setSide(s) {
        side = s;
        document.getElementById('t-buy').className = `tab buy ${s==='buy'?'active':''}`;
        document.getElementById('t-sell').className = `tab sell ${s==='sell'?'active':''}`;
        document.getElementById('exec-btn').style.background = s === 'buy' ? 'var(--green)' : 'var(--red)';
        document.getElementById('exec-btn').innerText = s === 'buy' ? 'تأمين الشراء عبر البوت' : 'تأمين البيع عبر البوت';
        syncBalances();
    }
    function nav(id, btn) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        btn.classList.add('active');
    }
    function changePair() { currentPair = document.getElementById('pair-selector').value; initSystem(); }
</script>
</body>
</html>

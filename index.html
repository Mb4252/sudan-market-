<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø´Ø§Ù…Ù„Ø© ğŸ‡¸ğŸ‡©</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --navy: #131921; --orange: #febd69; --bg: #f0f2f5; --blue: #1a73e8; --green: #2ecc71; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); padding-bottom: 70px; direction: rtl; }
        .hidden { display: none !important; }
        
        /* Header & Search */
        header { background: var(--navy); padding: 10px; position: sticky; top: 0; z-index: 1000; color: white; }
        .search-container { background: white; border-radius: 8px; margin: 8px 10px; display: flex; overflow: hidden; }
        .search-container input { border: none; flex: 1; padding: 10px; outline: none; }
        
        /* Slider */
        .slider-box { width: 100%; height: 160px; overflow: hidden; position: relative; background: #000; }
        .slider-box img { width: 100%; height: 100%; object-fit: cover; position: absolute; opacity: 0; transition: 1s ease-in-out; }
        .slider-box img.active { opacity: 1; }

        /* Navigation */
        .nav-bar { display: flex; justify-content: space-between; padding: 10px 15px; background: #232f3e; color: white; align-items: center; }
        
        /* Grid & Cards */
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 15px; }
        .card { background: white; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; border: 1px solid #ddd; }
        .card span { font-size: 35px; display: block; margin-bottom: 5px; }
        
        /* Posts */
        .post { background: white; margin: 15px; border-radius: 15px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.1); position: relative; }
        .post-header { padding: 10px; display: flex; align-items: center; border-bottom: 1px solid #eee; }
        .post-header img { width: 45px; height: 45px; border-radius: 50%; margin-left: 10px; border: 2px solid var(--orange); cursor: pointer; }
        .sold-label { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-20deg); background: rgba(255,0,0,0.9); color: white; padding: 15px 30px; font-size: 28px; font-weight: bold; border: 4px solid white; z-index: 20; border-radius: 10px; pointer-events: none; }

        /* Status & Badges */
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-left: 5px; }
        .online { background: #2ecc71; }
        .offline { background: #95a5a6; }
        .status-text { font-size: 11px; color: #7f8c8d; }
        .badge-trusted { color: #2980b9; font-size: 11px; font-weight: bold; border: 1px solid #2980b9; padding: 1px 4px; border-radius: 4px; }
        .badge-good { color: #27ae60; font-size: 11px; font-weight: bold; }
        .star-rating { color: #f1c40f; cursor: pointer; font-size: 18px; margin-right: 5px; }

        /* Action Buttons */
        .action-btns { display: flex; gap: 8px; margin-top: 12px; }
        .btn-buy { background: var(--green); color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; font-weight: bold; flex: 1; font-size: 14px; }
        .btn-wa { background: #25d366; color: white; border: none; padding: 10px; border-radius: 6px; cursor: pointer; text-decoration: none; font-size: 14px; text-align: center; flex: 1; display: flex; align-items: center; justify-content: center; font-weight: bold; }

        /* Chat Styles */
        #chat-view { background: #e5ddd5; min-height: 80vh; display: flex; flex-direction: column; }
        .msg-box { flex: 1; padding: 15px; overflow-y: auto; }
        .msg { padding: 8px 12px; border-radius: 8px; margin-bottom: 5px; max-width: 80%; width: fit-content; }
        .msg.sent { background: #dcf8c6; margin-right: auto; }
        .msg.received { background: white; margin-left: auto; }

        /* Auth Boxes */
        .auth-card { background: white; width: 90%; max-width: 400px; margin: 30px auto; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        input, select, textarea { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
        .btn-main { background: var(--blue); color: white; border: none; padding: 14px; width: 100%; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; }

        .bottom-tabs { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; padding: 10px 0; z-index: 1000; }
        .tab-btn { flex: 1; text-align: center; font-size: 12px; cursor: pointer; color: #555; }
        
        /* Search results styling */
        .search-res-title { padding: 10px; background: var(--orange); color: #000; font-weight: bold; margin: 10px; border-radius: 5px; }
    </style>
</head>
<body onload="initApp()">

<div id="auth-screen">
    <div class="auth-card" id="signup-box">
        <h3>ÙØªØ­ Ø­Ø³Ø§Ø¨ ÙÙŠ Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† ğŸ‡¸ğŸ‡©</h3>
        <label for="u-file">
            <img id="u-preview" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" style="width:80px; height:80px; border-radius:50%; cursor:pointer; border:2px solid #ddd">
        </label>
        <input type="file" id="u-file" class="hidden" accept="image/*" onchange="handleImg(this, 'user')">
        <input type="text" id="u-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
        <input type="tel" id="u-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (ÙˆØ§ØªØ³Ø§Ø¨)">
        <select id="u-state">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</option>
            <option>Ø§Ù„Ø®Ø±Ø·ÙˆÙ…</option><option>Ø§Ù„Ø¬Ø²ÙŠØ±Ø©</option><option>Ø§Ù„Ø¨Ø­Ø± Ø§Ù„Ø£Ø­Ù…Ø±</option><option>Ù†Ù‡Ø± Ø§Ù„Ù†ÙŠÙ„</option>
            <option>Ø§Ù„Ø´Ù…Ø§Ù„ÙŠØ©</option><option>Ø§Ù„Ù‚Ø¶Ø§Ø±Ù</option><option>ÙƒØ³Ù„Ø§</option><option>Ø³Ù†Ø§Ø±</option>
            <option>Ø§Ù„Ù†ÙŠÙ„ Ø§Ù„Ø£Ø¨ÙŠØ¶</option><option>Ø§Ù„Ù†ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ù‚</option><option>Ø´Ù…Ø§Ù„ ÙƒØ±Ø¯ÙØ§Ù†</option><option>Ø¬Ù†ÙˆØ¨ ÙƒØ±Ø¯ÙØ§Ù†</option>
            <option>ØºØ±Ø¨ ÙƒØ±Ø¯ÙØ§Ù†</option><option>Ø´Ù…Ø§Ù„ Ø¯Ø§Ø±ÙÙˆØ±</option><option>Ø¬Ù†ÙˆØ¨ Ø¯Ø§Ø±ÙÙˆØ±</option><option>Ø´Ø±Ù‚ Ø¯Ø§Ø±ÙÙˆØ±</option>
            <option>ØºØ±Ø¨ Ø¯Ø§Ø±ÙÙˆØ±</option><option>ÙˆØ³Ø· Ø¯Ø§Ø±ÙÙˆØ±</option>
        </select>
        <input type="password" id="u-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
        <button class="btn-main" onclick="register()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
        <p onclick="toggleAuth(true)" style="margin-top:15px; cursor:pointer">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„</p>
    </div>

    <div class="auth-card hidden" id="login-box">
        <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
        <input type="tel" id="l-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        <input type="password" id="l-pass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
        <button class="btn-main" onclick="login()">Ø¯Ø®ÙˆÙ„</button>
        <p onclick="toggleAuth(false)" style="margin-top:15px; cursor:pointer">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù†</p>
    </div>
</div>

<div id="app-screen" class="hidden">
    <header>
        <div style="font-weight:bold; font-size:18px">Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† Ø§Ù„ÙƒØ¨ÙŠØ±</div>
        <div class="search-container">
            <input type="text" id="app-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ØŒ ØªØ§Ø¬Ø±ØŒ ÙˆØµÙØŒ Ø£Ùˆ Ù‚Ø³Ù…..." oninput="runSearch()">
        </div>
    </header>

    <div class="slider-box" id="slider">
        <img src="https://images.unsplash.com/photo-1555529669-e69e7aa0ba9a?q=80&w=600" class="active">
        <img src="https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?q=80&w=600">
        <img src="https://images.unsplash.com/photo-1498050108023-c5249f4df085?q=80&w=600">
    </div>

    <div class="nav-bar">
        <span onclick="goBack()" style="cursor:pointer">ğŸ”™ Ø±Ø¬ÙˆØ¹</span>
        <b id="title-text">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</b>
        <span onclick="logout()" style="color:red; cursor:pointer">Ø®Ø±ÙˆØ¬</span>
    </div>

    <div id="home-view" class="view"><div class="grid" id="main-grid"></div></div>
    <div id="sub-view" class="view hidden"><div class="grid" id="sub-grid"></div></div>
    
    <div id="feed-view" class="view hidden">
        <div id="publish-area" style="padding:15px; background:white; margin:10px; border-radius:12px; box-shadow:0 2px 5px #ccc">
            <input type="text" id="p-title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†">
            <input type="number" id="p-price" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø¬.Ø³)">
            <textarea id="p-desc" placeholder="ÙˆØµÙ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø§Ù„ØªÙØµÙŠÙ„..."></textarea>
            <button onclick="document.getElementById('p-file').click()" style="background:#666; color:white; border:none; padding:10px; border-radius:5px; width:100%">ğŸ“¸ Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬</button>
            <input type="file" id="p-file" class="hidden" accept="image/*" onchange="handleImg(this, 'post')">
            <button id="pub-btn" class="btn-main" onclick="publish()" style="margin-top:10px; background:var(--orange); color:#000; display:none">Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¢Ù†</button>
        </div>
        <div id="posts-area"></div>
    </div>

    <div id="profile-view" class="view hidden">
        <div id="my-info" style="text-align:center; padding:20px; background:white"></div>
        <div id="my-posts"></div>
    </div>

    <div id="chat-view" class="view hidden">
        <div id="chat-with-name" style="padding:10px; background:white; font-weight:bold; border-bottom:1px solid #ddd"></div>
        <div id="msg-area" class="msg-box"></div>
        <div style="display:flex; padding:10px; background:white">
            <input id="msg-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." style="margin:0">
            <button onclick="sendMsg()" style="width:70px; background:var(--green); color:white; border:none; border-radius:8px; margin-right:5px">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

    <div class="bottom-tabs">
        <div class="tab-btn" onclick="showTab('home')">ğŸ <br>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="tab-btn" onclick="showTab('profile')">ğŸ‘¤<br>Ù…Ù„ÙÙŠ</div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let me = null, history = ['home'], curC = '', curS = '', userPic = '', postPic = '', activeChat = null;

    const data = {
        "Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„Ø§Øª": {i: "ğŸ“±", s: ["Ù‡ÙˆÙ†Ø±", "Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬", "Ø¢ÙŠÙÙˆÙ†", "ØªÙƒÙ†Ùˆ", "Ø´Ø§ÙˆÙ…ÙŠ"]},
        "Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª": {i: "ğŸš—", s: ["ØªÙˆÙŠÙˆØªØ§", "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ", "ÙƒÙŠØ§", "Ø£ÙƒØ³Ù†Øª", "Ø¨ÙˆÙƒØ³"]},
        "Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª": {i: "ğŸ ", s: ["Ø´Ù‚Ù‚ Ù„Ù„Ø¥ÙŠØ¬Ø§Ø±", "Ø¨ÙŠÙˆØª Ù„Ù„Ø¨ÙŠØ¹", "Ø£Ø±Ø§Ø¶ÙŠ", "Ù…ÙƒØ§ØªØ¨"]},
        "Ø§Ù„Ù…Ù„Ø§Ø¨Ø³": {i: "ğŸ‘•", s: ["Ø±Ø¬Ø§Ù„ÙŠ", "Ù†Ø³Ø§Ø¦ÙŠ", "Ø£Ø·ÙØ§Ù„", "Ø£Ø­Ø°ÙŠØ©"]},
        "Ø£Ø¯ÙˆØ§Øª Ù…Ù†Ø²Ù„ÙŠØ©": {i: "ğŸ“º", s: ["Ø«Ù„Ø§Ø¬Ø§Øª", "Ù…ÙƒÙŠÙØ§Øª", "ØºØ³Ø§Ù„Ø§Øª", "Ø´Ø§Ø´Ø§Øª"]},
        "Ø§Ù„Ù…ØºÙ„Ù‚ ÙˆØ§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡": {i: "âš¡", s: ["Ø£Ø¯ÙˆØ§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¡", "Ø³Ø¨Ø§ÙƒØ©", "Ø¨Ù†Ø§Ø¡", "Ù†Ù‚Ø§Ø´Ø©"]},
        "Ø£Ø¬Ù‡Ø²Ø© ÙƒÙ…Ø¨ÙŠÙˆØªØ±": {i: "ğŸ’»", s: ["Ù„Ø§Ø¨ØªÙˆØ¨Ø§Øª", "Ø·Ø§Ø¨Ø¹Ø§Øª", "Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª"]},
        "Ø®Ø¯Ù…Ø§Øª": {i: "ğŸ› ï¸", s: ["ØµÙŠØ§Ù†Ø©", "ØªÙˆØµÙŠÙ„", "Ø­Ù„Ø§Ù‚", "Ø®ÙŠØ§Ø·"]},
        "ÙˆØ¸Ø§Ø¦Ù": {i: "ğŸ’¼", s: ["Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…Ù„", "ÙØ±Øµ Ø¹Ù…Ù„"]},
        "Ø£Ø«Ø§Ø«": {i: "ğŸ›‹ï¸", s: ["Ø³Ø±Ø§ÙŠØ±", "Ø¯ÙˆØ§Ù„ÙŠØ¨", "Ø·Ø§ÙˆÙ„Ø§Øª"]},
        "Ø­ÙŠÙˆØ§Ù†Ø§Øª": {i: "ğŸ‘", s: ["Ø®Ø±Ø§Ù", "Ø¯ÙˆØ§Ø¬Ù†", "Ø£Ø±Ø§Ù†Ø¨"]},
        "Ø¯Ø±Ø§Ø¬Ø§Øª": {i: "ğŸï¸", s: ["Ù…ÙˆØ§ØªØ±", "Ø¹Ø¬Ù„Ø§Øª", "ØªÙƒØªÙƒ"]},
        "ØªØ¬Ù…ÙŠÙ„": {i: "ğŸ’„", s: ["Ø¹Ø·ÙˆØ±", "Ù…ÙƒÙŠØ§Ø¬", "ÙƒØ±ÙŠÙ…Ø§Øª"]},
        "Ø£Ù„Ø¹Ø§Ø¨": {i: "ğŸ®", s: ["Ø¨Ù„Ø§ÙŠ Ø³ØªÙŠØ´Ù†", "Ø£Ù„Ø¹Ø§Ø¨ Ø£Ø·ÙØ§Ù„"]},
        "Ø²Ø±Ø§Ø¹Ø©": {i: "ğŸŒ±", s: ["Ø¨Ø°ÙˆØ±", "Ø£Ø³Ù…Ø¯Ø©", "Ù…Ø¹Ø¯Ø§Øª"]},
        "Ù…Ø¹Ø¯Ø§Øª Ø·Ø¨ÙŠØ©": {i: "ğŸ¥", s: ["Ø£Ø¬Ù‡Ø²Ø© Ø¶ØºØ·", "ÙƒØ±Ø§Ø³ÙŠ"]},
        "Ø±Ø­Ù„Ø§Øª": {i: "ğŸšŒ", s: ["ØªØ°Ø§ÙƒØ±", "Ø³ÙØ±ÙŠØ§Øª"]},
        "ÙƒØªØ¨": {i: "ğŸ“š", s: ["Ù…Ø¯Ø±Ø³ÙŠØ©", "Ø±ÙˆØ§ÙŠØ§Øª"]},
        "Ù…Ø¹Ø¯Ø§Øª Ù…ØµØ§Ù†Ø¹": {i: "ğŸ­", s: ["Ù…ÙˆÙ„Ø¯Ø§Øª", "Ø¢Ù„Ø§Øª"]},
        "Ø£Ø®Ø±Ù‰": {i: "ğŸ“¦", s: ["Ù…Ù†ÙˆØ¹Ø§Øª"]}
    };

    function initApp() {
        const s = localStorage.getItem('user_sd');
        if(s) { 
            me = JSON.parse(s); 
            start(); 
            updateStatus();
            listenToOrders();
        }
        renderHome();
        runSlider();
    }

    function updateStatus() {
        if(!me) return;
        db.ref('users/' + me.p + '/lastSeen').set("online");
        db.ref('users/' + me.p + '/lastSeen').onDisconnect().set(Date.now());
    }

    function listenToOrders() {
        db.ref('orders/' + me.p).on('child_added', snap => {
            const order = snap.val();
            if(order && !order.read) {
                const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3');
                audio.play().catch(() => {});
                Swal.fire('Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯! ğŸ””', `Ø§Ù„Ø²Ø¨ÙˆÙ† ${order.fromName} ÙŠØ±ÙŠØ¯ Ø´Ø±Ø§Ø¡: ${order.item}`, 'info');
                db.ref('orders/' + me.p + '/' + snap.key).update({read: true});
            }
        });
    }

    function formatTime(ts) {
        if(ts === "online") return '<span class="status-dot online"></span> Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†';
        const diff = Math.floor((Date.now() - ts) / 1000);
        if(diff < 60) return "Ù…Ù†Ø° Ù‚Ù„ÙŠÙ„";
        if(diff < 3600) return `Ù…Ù†Ø° ${Math.floor(diff/60)} Ø¯Ù‚ÙŠÙ‚Ø©`;
        if(diff < 86400) return `Ù…Ù†Ø° ${Math.floor(diff/3600)} Ø³Ø§Ø¹Ø©`;
        return "Ù…Ù†Ø° Ø£ÙŠØ§Ù…";
    }

    function handleImg(input, mode) {
        if(input.files[0]) {
            const r = new FileReader();
            r.onload = e => {
                if(mode === 'user') { userPic = e.target.result; document.getElementById('u-preview').src = e.target.result; }
                else { 
                    postPic = e.target.result; 
                    document.getElementById('pub-btn').style.display = 'block';
                    Swal.fire({
                        title: 'ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­',
                        text: 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ù†Ø´Ø± Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø£Ùˆ Ø²ÙŠØ§Ø±Ø© Ù…Ù„ÙÙƒ Ø§Ù„Ø´Ø®ØµÙŠ',
                        icon: 'success',
                        showCancelButton: true,
                        confirmButtonText: 'Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ',
                        cancelButtonText: 'Ø¥ØºÙ„Ø§Ù‚'
                    }).then(res => { if(res.isConfirmed) showTab('profile'); });
                }
            };
            r.readAsDataURL(input.files[0]);
        }
    }

    function register() {
        const n = document.getElementById('u-name').value, p = document.getElementById('u-phone').value,
              st = document.getElementById('u-state').value, ps = document.getElementById('u-pass').value;
        if(!n || !p || !ps || !userPic) return Swal.fire('Ø®Ø·Ø£', 'Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙˆØµÙˆØ±ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ©', 'error');

        db.ref('users').once('value', snapshot => {
            let exists = false;
            snapshot.forEach(child => { if(child.key === p || (child.val() && child.val().n === n)) exists = true; });
            if(exists) return Swal.fire('Ø®Ø·Ø£', 'Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹!', 'error');

            db.ref('users/'+p).set({n, p, st, ps, pic: userPic, ratingCount: 0, lastSeen: Date.now()}).then(() => {
                Swal.fire('ØªÙ… Ø¨Ù†Ø¬Ø§Ø­', 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†', 'success'); toggleAuth(true);
            });
        });
    }

    function login() {
        const p = document.getElementById('l-phone').value, ps = document.getElementById('l-pass').value;
        db.ref('users/'+p).once('value', s => {
            const d = s.val();
            if(d && d.ps === ps) { 
                me = d; 
                localStorage.setItem('user_sd', JSON.stringify(d)); 
                start();
                updateStatus();
                listenToOrders();
            }
            else Swal.fire('ÙØ´Ù„', 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø±Ù‚Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±', 'error');
        });
    }

    function start() { document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('app-screen').classList.remove('hidden'); }
    
    function logout() { 
        localStorage.removeItem('user_sd'); 
        me = null;
        document.getElementById('app-screen').classList.add('hidden');
        document.getElementById('auth-screen').classList.remove('hidden');
        toggleAuth(true); 
    }

    function renderHome() {
        document.getElementById('main-grid').innerHTML = Object.keys(data).map(k => `
            <div class="card" onclick="openSub('${k}')">
                <span>${data[k].i}</span>
                <b>${k}</b>
            </div>`).join('');
    }

    function openSub(k) {
        curC = k; document.getElementById('title-text').innerText = k;
        hide(); document.getElementById('sub-view').classList.remove('hidden');
        document.getElementById('sub-grid').innerHTML = data[k].s.map(s => `
            <div class="card" onclick="openFeed('${k}','${s}')">
                <span>${data[k].i}</span>
                <b>${s}</b>
            </div>`).join('');
        history.push('sub');
    }

    function openFeed(c, s) {
        curC = c; curS = s; document.getElementById('title-text').innerText = s;
        hide(); 
        document.getElementById('feed-view').classList.remove('hidden');
        document.getElementById('publish-area').classList.remove('hidden');
        loadPosts(s); history.push('feed');
    }

    function publish() {
        const t = document.getElementById('p-title').value, pr = document.getElementById('p-price').value, d = document.getElementById('p-desc').value;
        if(!t || !postPic) return;
        const key = db.ref('posts').push().key;
        db.ref('posts/'+key).set({
            id: key, t, pr, d, img: postPic, uN: me.n, uP: me.p, uPic: me.pic, sub: curS, time: Date.now(), sold: false
        }).then(() => {
            Swal.fire('Ù†Ø¬Ø§Ø­', 'ØªÙ… Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†Ùƒ Ø¨Ù†Ø¬Ø§Ø­', 'success');
            document.getElementById('p-title').value = ''; document.getElementById('p-price').value = '';
            document.getElementById('p-desc').value = ''; document.getElementById('pub-btn').style.display = 'none'; postPic = '';
        });
    }

    function loadPosts(sub, target='posts-area', filterP=null) {
        db.ref('posts').on('value', snap => {
            const area = document.getElementById(target); if(!area) return; area.innerHTML = '';
            snap.forEach(child => {
                const i = child.val();
                if((filterP && i.uP === filterP) || (!filterP && i.sub === sub)) {
                    renderSinglePost(i, area);
                }
            });
        });
    }

    function renderSinglePost(i, area) {
        db.ref('users/'+i.uP).once('value', uSnap => {
            const uData = uSnap.val() || {};
            const statusLine = formatTime(uData.lastSeen);
            const rCount = uData.ratingCount || 0;
            let badge = '';
            if(rCount >= 100) badge = '<span class="badge-trusted">ØªØ§Ø¬Ø± Ù…ÙˆØ«ÙˆÙ‚</span>';
            else if(rCount >= 50) badge = '<span class="badge-good">ØªØ§Ø¬Ø± Ø¬ÙŠØ¯</span>';

            let btn = i.uP === me.p ? `<b style="float:left; cursor:pointer" onclick="manage('${i.id}',${i.sold})">â‹®</b>` : '';
            
            let actions = i.uP !== me.p ? `
            <div class="action-btns">
                <button class="btn-buy" onclick="orderNow('${i.uP}', '${i.t}', '${i.uN}')">Ø´Ø±Ø§Ø¡ ÙˆØ¯Ø±Ø¯Ø´Ø© ğŸ›’</button>
                <a class="btn-wa" href="https://wa.me/${i.uP}" target="_blank">ÙˆØ§ØªØ³Ø§Ø¨ ğŸ’¬</a>
            </div>` : '';

            area.insertAdjacentHTML('afterbegin', `
                <div class="post">
                    ${i.sold ? '<div class="sold-label">ØªÙ… Ø§Ù„Ø¨ÙŠØ¹</div>' : ''}
                    <div class="post-header">
                        <img src="${i.uPic}" onclick="visitUser('${i.uP}')">
                        <div style="flex:1">
                            <b onclick="visitUser('${i.uP}')" style="cursor:pointer">${i.uN}</b> ${badge} 
                            <span class="star-rating" onclick="addRating('${i.uP}')">â˜…</span>
                            <div class="status-text">${statusLine}</div>
                        </div>
                        ${btn}
                    </div>
                    <img src="${i.img}" style="width:100%">
                    <div style="padding:15px">
                        <b>${i.t}</b> - <span style="color:green; font-weight:bold">${i.pr} Ø¬.Ø³</span>
                        <p>${i.d}</p>
                        ${actions}
                    </div>
                    <div style="padding:10px; background:#f9f9f9">
                        <div id="coms-${i.id}"></div>
                        <div style="display:flex; gap:5px; margin-top:10px">
                            <input id="ci-${i.id}" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ..." style="margin:0">
                            <button onclick="addCom('${i.id}')" style="width:60px; background:var(--navy); color:white; border:none; border-radius:5px">Ø§Ø±Ø³Ù„</button>
                        </div>
                    </div>
                </div>`);
            getComs(i.id);
        });
    }

    function runSearch() {
        const q = document.getElementById('app-search').value.toLowerCase().trim();
        if(!q) { renderHome(); return; }

        hide();
        const feedView = document.getElementById('feed-view');
        feedView.classList.remove('hidden');
        document.getElementById('publish-area').classList.add('hidden'); // Ø¥Ø®ÙØ§Ø¡ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù†Ø´Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø¨Ø­Ø«
        const area = document.getElementById('posts-area');
        area.innerHTML = `<div class="search-res-title">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†: ${q}</div>`;

        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
        Object.keys(data).forEach(cat => {
            if(cat.includes(q)) {
                area.insertAdjacentHTML('beforeend', `<div class="card" style="margin:10px" onclick="openSub('${cat}')"><span>${data[cat].i}</span> Ù‚Ø³Ù…: ${cat} (Ø§Ø¶ØºØ· Ù„Ù„Ø¹Ø±Ø¶)</div>`);
            }
            data[cat].s.forEach(sub => {
                if(sub.includes(q)) {
                    area.insertAdjacentHTML('beforeend', `<div class="card" style="margin:10px" onclick="openFeed('${cat}','${sub}')"><span>${data[cat].i}</span> ÙØ±Ø¹: ${sub} (Ø§Ø¶ØºØ· Ù„Ù„Ø¹Ø±Ø¶)</div>`);
                }
            });
        });

        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„ÙˆØµÙØŒ Ø§Ù„ØªØ§Ø¬Ø±)
        db.ref('posts').once('value', s => {
            let found = false;
            s.forEach(child => {
                const p = child.val();
                if(p.t.toLowerCase().includes(q) || p.d.toLowerCase().includes(q) || p.uN.toLowerCase().includes(q) || (p.sub && p.sub.includes(q))) {
                    renderSinglePost(p, area);
                    found = true;
                }
            });
            if(!found && area.innerHTML.includes('Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«')) {
                // Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù†Ø´ÙˆØ±Ø§ØªØŒ Ù„ÙƒÙ† Ø±Ø¨Ù…Ø§ ÙˆØ¬Ø¯Øª Ø£Ù‚Ø³Ø§Ù… ÙÙˆÙ‚
            }
        });
    }

    function orderNow(sellerPhone, itemName, sellerName) {
        db.ref('orders/' + sellerPhone).push({
            fromName: me.n, fromPhone: me.p, item: itemName, time: Date.now(), read: false
        });
        openChat(sellerPhone, sellerName);
    }

    function openChat(phone, name) {
        activeChat = me.p < phone ? me.p + "_" + phone : phone + "_" + me.p;
        hide();
        document.getElementById('chat-view').classList.remove('hidden');
        document.getElementById('chat-with-name').innerText = "Ø¯Ø±Ø¯Ø´Ø© Ù…Ø¹: " + name;
        db.ref('chats/' + activeChat).on('value', s => {
            const area = document.getElementById('msg-area');
            area.innerHTML = '';
            s.forEach(m => {
                const msg = m.val();
                const cls = msg.sender === me.p ? 'sent' : 'received';
                area.innerHTML += `<div class="msg ${cls}">${msg.text}</div>`;
            });
            area.scrollTop = area.scrollHeight;
        });
        history.push('chat');
    }

    function sendMsg() {
        const txt = document.getElementById('msg-input').value;
        if(!txt) return;
        db.ref('chats/' + activeChat).push({ sender: me.p, text: txt, time: Date.now() });
        document.getElementById('msg-input').value = '';
    }

    function addRating(targetPhone) {
        if(targetPhone === me.p) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ‚ÙŠÙŠÙ… Ù†ÙØ³Ùƒ', 'info');
        db.ref('ratings/' + targetPhone + '/' + me.p).once('value', s => {
            if(s.exists()) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ù‚Ø¯ Ù‚ÙŠÙ…Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®Øµ Ù…Ø³Ø¨Ù‚Ø§Ù‹', 'warning');
            db.ref('ratings/' + targetPhone + '/' + me.p).set(true).then(() => {
                db.ref('users/' + targetPhone + '/ratingCount').transaction(c => (c || 0) + 1);
                Swal.fire('Ø´ÙƒØ±Ø§Ù‹', 'ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù†Ø¬Ù…Ø© Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØ§Ø¬Ø±', 'success');
            });
        });
    }

    function visitUser(phone) {
        db.ref('users/'+phone).once('value', s => {
            const u = s.val();
            hide(); document.getElementById('profile-view').classList.remove('hidden');
            document.getElementById('my-info').innerHTML = `
                <img src="${u.pic}" style="width:80px; height:80px; border-radius:50%"><br>
                <h3>${u.n}</h3><p>ğŸ“ ${u.st}</p>
                <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª: ${u.ratingCount || 0}</p>
            `;
            loadPosts(null, 'my-posts', phone);
            history.push('profile');
        });
    }

    function manage(id, sold) {
        Swal.fire({
            title: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±',
            showDenyButton: true, confirmButtonText: sold ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨ÙŠØ¹' : 'ØªÙ… Ø§Ù„Ø¨ÙŠØ¹ âœ…', denyButtonText: 'Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† ğŸ—‘ï¸'
        }).then(r => {
            if(r.isConfirmed) db.ref('posts/'+id).update({sold: !sold});
            else if(r.isDenied) db.ref('posts/'+id).remove();
        });
    }

    function addCom(id) { const v = document.getElementById('ci-'+id).value; if(v) { db.ref('comments/'+id).push({n: me.n, t: v}); document.getElementById('ci-'+id).value=''; } }
    function getComs(id) { db.ref('comments/'+id).on('value', s => { const b = document.getElementById('coms-'+id); if(!b) return; b.innerHTML=''; s.forEach(c => { b.innerHTML += `<div style="font-size:12px; margin-bottom:5px"><b>${c.val().n}:</b> ${c.val().t}</div>`; }); }); }

    function showTab(t) {
        hide(); document.getElementById(t+'-view').classList.remove('hidden');
        if(t === 'profile') {
            document.getElementById('my-info').innerHTML = `<img src="${me.pic}" style="width:80px; height:80px; border-radius:50%"><br><h3>${me.n}</h3><p>ğŸ“ ${me.st}</p>`;
            loadPosts(null, 'my-posts', me.p);
        } else { renderHome(); history=['home']; document.getElementById('title-text').innerText="Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"; }
    }

    function goBack() {
        if(history.length > 1) {
            history.pop(); const l = history[history.length-1];
            if(l === 'home') showTab('home'); 
            else if(l === 'sub') openSub(curC);
            else if(l === 'feed') openFeed(curC, curS);
        }
    }

    function hide() { document.querySelectorAll('.view').forEach(v => v.classList.add('hidden')); }
    function toggleAuth(l) { document.getElementById('signup-box').classList.toggle('hidden', l); document.getElementById('login-box').classList.toggle('hidden', !l); }
    function runSlider() { let n = 0; const imgs = document.querySelectorAll('#slider img'); setInterval(() => { if(imgs.length){ imgs[n].classList.remove('active'); n = (n + 1) % imgs.length; imgs[n].classList.add('active'); } }, 3000); }
</script>
</body>
</html>

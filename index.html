<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SDM Market Pro | المتجر المتكامل</title>
    
    <!-- الخطوط والأيقونات -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- المكتبات -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            --bg-main: #101419;
            --bg-card: #1e2329;
            --bg-input: #2b3139;
            --primary: #fcd535; 
            --text-white: #eaecef;
            --text-gray: #848e9c;
            --green: #0ecb81; 
            --red: #f6465d; 
            --border: #2b3139;
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Tajawal', sans-serif; 
            margin: 0; 
            background: var(--bg-main); 
            color: var(--text-white); 
            padding-bottom: 50px; 
            overflow-x: hidden; 
            user-select: none;
        }

        /* --- Header --- */
        header { 
            background: var(--bg-card); 
            padding: 12px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 1px solid var(--border); 
            position: sticky; top: 0; z-index: 100;
        }
        .logo { font-weight: 800; color: var(--primary); font-size: 18px; letter-spacing: 1px; }
        .bal-badge { background: var(--bg-input); padding: 5px 12px; border-radius: 6px; font-size: 13px; font-weight: bold; border: 1px solid var(--border); }
        .bal-badge span#u-curr { color: var(--primary); margin-right: 3px; }

        /* --- Price Display --- */
        .price-area { text-align: center; padding: 20px 0; background: var(--bg-main); border-bottom: 1px solid var(--border); }
        .big-price { font-size: 36px; font-weight: 800; color: var(--green); margin: 0; letter-spacing: 1px; direction: ltr; }
        .sub-price { font-size: 12px; color: var(--text-gray); margin-top: 5px; }

        /* --- Trade Grid Layout --- */
        .trade-container { display: grid; grid-template-columns: 1.3fr 0.7fr; gap: 4px; margin-top: 5px; }

        /* --- Form Section (Left) --- */
        .trade-form { background: var(--bg-card); padding: 15px; }
        
        .tabs { display: flex; background: var(--bg-main); margin-bottom: 15px; border-radius: 6px; padding: 3px; }
        .tab { flex: 1; text-align: center; padding: 10px; cursor: pointer; color: var(--text-gray); font-weight: bold; font-size: 14px; border-radius: 4px; transition: 0.2s; }
        .tab.buy.active { background: var(--green); color: white; }
        .tab.sell.active { background: var(--red); color: white; }

        .inp-box { position: relative; margin-bottom: 12px; }
        .inp-box span { position: absolute; left: 12px; top: 13px; font-size: 12px; font-weight: bold; color: var(--text-gray); pointer-events: none; }
        .inp-box label { position: absolute; right: 12px; top: 13px; font-size: 11px; color: var(--text-gray); pointer-events: none; }
        .big-input { width: 100%; background: var(--bg-input); border: 1px solid transparent; padding: 12px 12px 12px 50px; color: white; font-size: 16px; font-weight: bold; border-radius: 6px; text-align: left; height: 48px; transition: 0.2s; direction: ltr; }
        .big-input:focus { border-color: var(--primary); background: #343a40; }

        .pct-btns { display:flex; gap:6px; margin-bottom:15px; }
        .pct-btn { flex:1; background:var(--bg-input); border:1px solid var(--border); color:var(--text-gray); padding:6px; border-radius:4px; font-size:11px; cursor:pointer; transition:0.2s; }
        .pct-btn:hover { background: #343a40; color: white; }

        .btn-submit { width: 100%; padding: 14px; border: none; font-weight: 800; color: white; cursor: pointer; border-radius: 6px; margin-top: 5px; font-size: 16px; transition: 0.2s; }
        .btn-submit:active { transform: scale(0.98); }
        .btn-submit.buy { background: var(--green); box-shadow: 0 4px 12px rgba(14, 203, 129, 0.2); }
        .btn-submit.sell { background: var(--red); box-shadow: 0 4px 12px rgba(246, 70, 93, 0.2); }

        /* --- Order Book (Right) --- */
        .book { background: var(--bg-card); font-size: 11px; border-left: 1px solid var(--border); }
        .book-header { padding: 8px; text-align: center; color: var(--text-gray); font-size: 10px; border-bottom: 1px solid var(--border); }
        .row { display: flex; justify-content: space-between; padding: 4px 8px; cursor: pointer; position: relative; height: 24px; align-items: center; overflow: hidden; }
        .row:hover { background: rgba(255,255,255,0.05); }
        .bar { position: absolute; top:0; right:0; height:100%; opacity: 0.15; transition: width 0.3s; }
        .price-txt { font-family: monospace; font-weight: bold; z-index: 1; }
        .amt-txt { color: white; z-index: 1; opacity: 0.8; }
        
        /* --- My Orders --- */
        .my-orders { margin-top: 5px; background: var(--bg-card); padding: 15px; min-height: 200px; }
        .mo-title { font-size: 13px; font-weight: bold; margin-bottom: 15px; color: var(--text-gray); border-bottom: 1px solid var(--border); padding-bottom: 10px; display:flex; align-items:center; gap:8px; }
        .mo-row { display: flex; justify-content: space-between; align-items: center; background: var(--bg-main); padding: 12px; margin-bottom: 8px; border-radius: 6px; font-size: 12px; border: 1px solid var(--border); }
        .btn-cancel { background: rgba(246, 70, 93, 0.15); color: var(--red); border: 1px solid var(--red); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 11px; font-weight: bold; }

        /* --- Auth Screen --- */
        #auth-screen { position: fixed; inset: 0; background: var(--bg-main); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .login-btn { margin-top: 20px; padding: 12px 25px; border-radius: 25px; border: none; font-weight: bold; cursor: pointer; background: white; color: black; display: flex; align-items: center; gap: 10px; font-size: 16px; }
        
        .hidden { display: none !important; }
        
        /* Helper for sweetalert dark mode */
        div:where(.swal2-container) div:where(.swal2-popup) { background: #1e2329 !important; color: #fff !important; border: 1px solid #2b3139; }
        
        /* Scrollbar Hide */
        ::-webkit-scrollbar { width: 0; background: transparent; }
    </style>
</head>
<body>

<!-- شاشة الدخول -->
<div id="auth-screen">
    <i class="fas fa-chart-line" style="font-size: 60px; color: var(--primary); margin-bottom: 20px;"></i>
    <h2 style="color:var(--primary); margin:0;">SDM MARKET PRO</h2>
    <p style="color:var(--text-gray); margin-top:10px;">منصة التداول الاحترافية</p>
    <button class="login-btn" onclick="login()">
        <i class="fab fa-google"></i> تسجيل دخول
    </button>
</div>

<!-- التطبيق -->
<div id="app" class="hidden">
    <header>
        <div class="logo">SDM PRO <i class="fas fa-bolt" style="color:var(--primary); font-size:12px;"></i></div>
        <div class="bal-badge">
            <span id="u-bal">0.00</span> 
            <span id="u-curr">SDM</span>
        </div>
        <div onclick="logout()" style="color:var(--red); font-size:18px; cursor:pointer; margin-right:10px;"><i class="fas fa-sign-out-alt"></i></div>
    </header>

    <div class="price-area">
        <div class="big-price" id="m-price">0.0500</div>
        <div class="sub-price">≈ السعر الحالي (SDM)</div>
    </div>

    <div class="trade-container">
        <!-- يمين: النموذج -->
        <div class="trade-form">
            <div class="tabs">
                <div id="t-buy" class="tab buy active" onclick="setMode('buy')">شراء</div>
                <div id="t-sell" class="tab sell" onclick="setMode('sell')">بيع</div>
            </div>

            <div class="inp-box">
                <label>السعر</label><span>SDM</span>
                <input type="number" id="i-price" class="big-input" placeholder="0.0000" step="0.0001">
            </div>
            <div class="inp-box">
                <label>الكمية</label><span>MRK</span>
                <input type="number" id="i-amount" class="big-input" placeholder="0.00">
            </div>

            <!-- أزرار النسبة المئوية -->
            <div class="pct-btns">
                <div class="pct-btn" onclick="setPct(0.25)">25%</div>
                <div class="pct-btn" onclick="setPct(0.50)">50%</div>
                <div class="pct-btn" onclick="setPct(0.75)">75%</div>
                <div class="pct-btn" onclick="setPct(1.00)">100%</div>
            </div>

            <div style="font-size:11px; margin-bottom:10px; color:var(--text-gray); display:flex; justify-content:space-between; align-items:center;">
                <span>الإجمالي المتوقع:</span>
                <span style="color:white; font-size:14px; font-weight:bold;"><span id="total-txt">0.00</span> SDM</span>
            </div>

            <button id="btn-do" class="btn-submit buy" onclick="placeOrder()">شراء MRK</button>
        </div>

        <!-- يسار: دفتر الطلبات -->
        <div class="book">
            <div class="book-header">دفتر الأوامر (Order Book)</div>
            
            <!-- طلبات البيع (أحمر) -->
            <div id="asks" style="height:140px; overflow-y:scroll; display:flex; flex-direction:column-reverse; border-bottom: 1px solid var(--border);"></div>
            
            <div style="text-align:center; padding:4px; color:var(--primary); font-weight:bold; font-size:12px; background:rgba(252, 213, 53, 0.1);">Spread</div>
            
            <!-- طلبات الشراء (أخضر) -->
            <div id="bids" style="height:140px; overflow-y:scroll;"></div>
        </div>
    </div>

    <!-- قسم طلباتي -->
    <div class="my-orders">
        <div class="mo-title">
            <i class="fas fa-list-alt" style="color:var(--primary)"></i> 
            طلباتي المفتوحة
        </div>
        <div id="my-orders-list">
            <div style="text-align:center; color:var(--text-gray); padding:20px;">جاري التحميل...</div>
        </div>
    </div>

</div>

<script>
    // --- 1. إعدادات فايربيس ---
    const firebaseConfig = {
      apiKey: "AIzaSyAI_mUhuPNoO-XC0Q-VNoWft8UWFbAbIGg",
      authDomain: "sudan-market-6b122.firebaseapp.com",
      databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com",
      projectId: "sudan-market-6b122",
      storageBucket: "sudan-market-6b122.firebasestorage.app",
      messagingSenderId: "66729481566",
      appId: "1:66729481566:web:93393f28dc22d32cceebcf"
    };
    
    // تهيئة فايربيس
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // --- 2. المتغيرات العامة ---
    let user = null;
    let mode = 'buy'; // الوضع الحالي (شراء/بيع)
    let marketPrice = 0.05; // السعر الابتدائي

    // --- 3. إدارة الدخول والخروج ---
    function login() { 
        auth.signInWithPopup(new firebase.auth.GoogleAuthProvider())
            .catch(e => Swal.fire('خطأ', e.message, 'error')); 
    }
    
    function logout() { 
        auth.signOut().then(() => location.reload()); 
    }

    // مراقب حالة المستخدم
    auth.onAuthStateChanged(u => {
        if(u) {
            // جلب بيانات المستخدم من قاعدة البيانات
            db.ref('users/'+u.uid).on('value', s => {
                if(s.exists()){
                    user = s.val();
                    user.uid = u.uid;
                    initApp();
                } else {
                    // إنشاء مستخدم جديد إذا لم يكن موجوداً
                    const newUser = {
                        n: u.displayName,
                        email: u.email,
                        pic: u.photoURL,
                        sdmBalance: 0,
                        mrkBalance: 0,
                        role: 'user'
                    };
                    db.ref('users/'+u.uid).set(newUser).then(() => {
                        user = newUser;
                        user.uid = u.uid;
                        initApp();
                    });
                }
            });
        } else {
            // إظهار شاشة الدخول
            document.getElementById('auth-screen').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }
    });

    // --- 4. تهيئة التطبيق ---
    function initApp() {
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        
        updateUI();
        listenToMarket();
        listenToMyOrders();
        
        // تفعيل الحساب التلقائي عند الكتابة
        document.getElementById('i-price').addEventListener('input', updateTotal);
        document.getElementById('i-amount').addEventListener('input', updateTotal);
    }

    // --- 5. وظائف الواجهة والمنطق ---
    function updateUI() {
        if(!user) return;
        // تحديث عرض الرصيد حسب الوضع
        const balEl = document.getElementById('u-bal');
        const curEl = document.getElementById('u-curr');
        
        if(mode === 'buy') {
            balEl.innerText = (user.sdmBalance || 0).toFixed(2);
            curEl.innerText = 'SDM';
        } else {
            balEl.innerText = (user.mrkBalance || 0).toFixed(4);
            curEl.innerText = 'MRK';
        }
    }

    function setMode(m) {
        mode = m;
        const btn = document.getElementById('btn-do');
        
        // تبديل التبويبات (الألوان)
        document.getElementById('t-buy').classList.toggle('active', m === 'buy');
        document.getElementById('t-sell').classList.toggle('active', m === 'sell');
        
        // تحديث شكل الزر والنصوص
        btn.className = `btn-submit ${m}`;
        btn.innerText = m === 'buy' ? 'شراء MRK' : 'بيع MRK';
        
        updateUI();
        updateTotal();
    }

    function updateTotal() {
        const p = parseFloat(document.getElementById('i-price').value) || 0;
        const a = parseFloat(document.getElementById('i-amount').value) || 0;
        document.getElementById('total-txt').innerText = (p * a).toFixed(2);
    }

    // حساب النسبة المئوية (25%, 50%...)
    function setPct(pct) {
        const p = parseFloat(document.getElementById('i-price').value) || marketPrice;
        
        if(mode === 'buy') {
            // في حالة الشراء: نحسب كم MRK يمكن شراؤه برصيد SDM
            const maxSdm = (user.sdmBalance || 0) * pct;
            if(p > 0) document.getElementById('i-amount').value = (maxSdm / p).toFixed(4);
        } else {
            // في حالة البيع: نحسب نسبة من رصيد MRK
            document.getElementById('i-amount').value = ((user.mrkBalance || 0) * pct).toFixed(4);
        }
        
        if(!document.getElementById('i-price').value) document.getElementById('i-price').value = marketPrice;
        updateTotal();
    }

    // --- 6. تنفيذ الأوامر ---
    async function placeOrder() {
        const price = parseFloat(document.getElementById('i-price').value);
        const amount = parseFloat(document.getElementById('i-amount').value);
        const total = price * amount;

        // التحقق من صحة المدخلات
        if(!price || !amount || price <= 0 || amount <= 0) return Swal.fire('تنبيه', 'أدخل بيانات صحيحة', 'warning');
        
        // التحقق من الرصيد
        if(mode === 'buy' && (user.sdmBalance || 0) < total) return Swal.fire('خطأ', 'رصيد SDM غير كاف', 'error');
        if(mode === 'sell' && (user.mrkBalance || 0) < amount) return Swal.fire('خطأ', 'رصيد MRK غير كاف', 'error');

        Swal.showLoading();
        
        try {
            // 1. خصم الرصيد (تجميد المبلغ)
            if(mode === 'buy') {
                await db.ref('users/'+user.uid+'/sdmBalance').set((user.sdmBalance || 0) - total);
            } else {
                await db.ref('users/'+user.uid+'/mrkBalance').set((user.mrkBalance || 0) - amount);
            }

            // 2. إرسال الطلب للسوق
            const orderData = {
                uP: user.uid,
                price: price,
                amount: amount,
                total: total,
                type: mode,
                status: 'pending', // حالة الانتظار
                date: firebase.database.ServerValue.TIMESTAMP
            };
            
            await db.ref('market/orders/' + mode).push(orderData);
            
            Swal.fire({ icon: 'success', title: 'تم وضع الأمر', timer: 1500, showConfirmButton: false });
            
            // تصفير حقل الكمية فقط
            document.getElementById('i-amount').value = '';
            updateTotal();
            
        } catch(e) {
            Swal.fire('خطأ', e.message, 'error');
        }
    }

    // إلغاء الطلب
    async function cancelOrder(type, key, amount, total) {
        Swal.fire({
            title: 'إلغاء الأمر؟',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'نعم',
            cancelButtonText: 'لا'
        }).then(async res => {
            if(res.isConfirmed) {
                try {
                    // تحديث الحالة إلى ملغي
                    await db.ref(`market/orders/${type}/${key}`).update({ status: 'cancelled' });
                    
                    // استرداد الرصيد للمستخدم
                    if(type === 'buy') {
                        await db.ref('users/'+user.uid+'/sdmBalance').set((user.sdmBalance || 0) + total);
                    } else {
                        await db.ref('users/'+user.uid+'/mrkBalance').set((user.mrkBalance || 0) + amount);
                    }
                    Swal.fire('تم', 'تم الإلغاء واسترداد الرصيد', 'success');
                } catch(e) {
                    Swal.fire('خطأ', 'حدث خطأ أثناء الإلغاء', 'error');
                }
            }
        });
    }

    // --- 7. مراقبة البيانات الحية ---
    function listenToMarket() {
        // مراقبة السعر الحالي
        db.ref('market/stats/lastPrice').on('value', s => {
            marketPrice = s.val() || 0.05;
            const priceEl = document.getElementById('m-price');
            priceEl.innerText = marketPrice.toFixed(4);
            // تغيير لون السعر بناء على الحركة (تجميلي بسيط)
            priceEl.style.color = 'var(--text-white)';
            setTimeout(() => priceEl.style.color = 'var(--green)', 300);
        });

        // مراقبة طلبات البيع (Asks) - نرتبها تصاعدياً
        db.ref('market/orders/sell').orderByChild('price').limitToFirst(20).on('value', s => {
            renderBook('asks', s, 'asc');
        });

        // مراقبة طلبات الشراء (Bids) - نرتبها تنازلياً (الأعلى سعراً أولاً)
        db.ref('market/orders/buy').orderByChild('price').limitToLast(20).on('value', s => {
            renderBook('bids', s, 'desc');
        });
    }

    // دالة رسم دفتر الأوامر
    function renderBook(elId, snap, dir) {
        const list = document.getElementById(elId);
        let html = '';
        let arr = [];
        
        // تحويل البيانات لمصفوفة
        snap.forEach(c => {
            const o = c.val();
            if(o.status === 'pending') arr.push(o);
        });

        // ترتيب العرض
        if(dir === 'desc') arr.reverse(); 

        // حساب الحد الأقصى لرسم الشريط الخلفي (Depth Bar)
        const maxAmt = Math.max(...arr.map(o => o.amount), 1);

        arr.forEach(o => {
            const color = elId === 'asks' ? 'var(--red)' : 'var(--green)';
            const barW = (o.amount / maxAmt) * 100; // عرض الشريط بالنسبة للكمية
            
            html += `
            <div class="row" onclick="fillInput(${o.price})">
                <div class="bar" style="width:${barW}%; background:${color}"></div>
                <span class="price-txt" style="color:${color}">${o.price.toFixed(4)}</span>
                <span class="amt-txt">${o.amount.toFixed(2)}</span>
            </div>`;
        });
        list.innerHTML = html;
    }

    // عند الضغط على أي طلب في الدفتر، نملأ السعر تلقائياً
    function fillInput(price) {
        document.getElementById('i-price').value = price;
        updateTotal();
    }

    // مراقبة "طلباتي"
    function listenToMyOrders() {
        const renderMyOrders = (snap, type) => {
            let html = '';
            snap.forEach(c => {
                const o = c.val();
                // عرض الطلبات المعلقة الخاصة بالمستخدم الحالي فقط
                if(o.uP === user.uid && o.status === 'pending') {
                    html += `
                    <div class="mo-row">
                        <div style="display:flex; flex-direction:column;">
                            <span style="color:${type==='buy'?'var(--green)':'var(--red)'}; font-weight:bold;">
                                ${type==='buy'?'شراء':'بيع'} ${o.amount.toFixed(2)} MRK
                            </span>
                            <span style="color:var(--text-gray);">بسعر ${o.price.toFixed(4)}</span>
                        </div>
                        <button class="btn-cancel" onclick="cancelOrder('${type}', '${c.key}', ${o.amount}, ${o.total})">إلغاء</button>
                    </div>`;
                }
            });
            return html;
        };

        // دمج طلبات الشراء والبيع في قائمة واحدة
        db.ref('market/orders/buy').orderByChild('uP').equalTo(user.uid).on('value', s => {
            const buyHtml = renderMyOrders(s, 'buy');
            db.ref('market/orders/sell').orderByChild('uP').equalTo(user.uid).on('value', s2 => {
                const sellHtml = renderMyOrders(s2, 'sell');
                const finalHtml = (buyHtml + sellHtml) || '<div style="text-align:center; padding:20px; color:var(--text-gray)">لا توجد طلبات مفتوحة</div>';
                document.getElementById('my-orders-list').innerHTML = finalHtml;
            });
        });
    }
</script>
</body>
</html>

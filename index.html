<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SDM Market | Ø¬ÙˆÙ‡Ø±Ø© Ø³ÙˆÙ„Ø§Ù†Ø§ ğŸ‡¸ğŸ‡©</title>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª Ø®Ø§Ø±Ø¬ÙŠØ© -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({
          appId: "74a3085c-32b9-4c35-bc32-e67c3a2506c3",
        });
      });
    </script>
    
    <!-- Ù…ÙƒØªØ¨Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³ (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <!-- Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --navy: #0d1117; --gold: #ffc107; --blue: #007bff; --bg: #f4f6f9; --green: #28a745; --red: #dc3545; --white: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); padding-bottom: 75px; direction: rtl; user-select: none; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }
        
        header { background: var(--navy); color: white; padding: 10px 15px; display: flex; flex-direction: column; gap: 10px; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid var(--gold); }
        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .search-container { position: relative; width: 100%; }
        .search-container input { width: 100%; padding: 8px 35px 8px 10px; border-radius: 20px; border: none; font-size: 14px; background: rgba(255,255,255,0.15); color: white; margin: 0; outline: none; transition: 0.3s; }
        .search-container input:focus { background: rgba(255,255,255,0.25); }
        .search-container i { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #ddd; }

        #dev-alert-bar { background: linear-gradient(90deg, #c0392b, #e74c3c); color: white; padding: 8px; text-align: center; font-size: 13px; font-weight: bold; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 0.95; } 50% { opacity: 1; } 100% { opacity: 0.95; } }

        /* ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
        .slider-container { position: relative; width: 100%; height: 200px; overflow: hidden; margin-bottom: 15px; border-radius: 0 0 15px 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); background: #000; }
        #slider-img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.5s; cursor: pointer; }
        .slider-overlay { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.5); color: #fff; padding: 5px; text-align: center; font-size: 12px; }
        
        /* Ø²Ø± ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¢Ø¯Ù…Ù† */
        .edit-slider-btn { 
            position: absolute; top: 15px; left: 15px; 
            background: rgba(0, 0, 0, 0.7); color: var(--gold); 
            padding: 8px 15px; border-radius: 20px; cursor: pointer; 
            z-index: 100; font-size: 14px; border: 1px solid var(--gold); 
            display: flex; align-items: center; gap: 5px; font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        .slider-dots {
            position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 5px; z-index: 10;
        }
        .dot { width: 8px; height: 8px; background: rgba(255,255,255,0.5); border-radius: 50%; }
        .dot.active { background: var(--gold); }

        .publish-container { background: var(--white); margin: 15px; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #eef; }
        .publish-container h4 { font-size: 22px; color: var(--navy); margin-bottom: 15px; border-right: 4px solid var(--blue); padding-right: 10px; }
        .publish-container input, .publish-container textarea { border: 1.5px solid #eee; transition: 0.3s; font-size: 15px; }
        .publish-container input:focus { border-color: var(--blue); outline: none; box-shadow: 0 0 8px rgba(0,123,255,0.2); }

        .welcome-msg { position: absolute; top: 110px; left: 10px; font-size: 12px; background: rgba(13, 17, 23, 0.8); color: white; padding: 5px 10px; border-radius: 20px; z-index: 999; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px; }
        
        .card { background: white; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; border: 1px solid #eee; transition: 0.3s; position: relative; }
        .card:hover { transform: translateY(-5px); border-color: var(--gold); }
        .edit-cat-btn { position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.7); color: var(--gold); border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; z-index: 10; border: 1px solid var(--gold); }
        .cat-custom-img { width: 50px; height: 50px; object-fit: cover; margin-bottom: 10px; border-radius: 10px; }

        .btn-main { background: var(--blue); color: white; border: none; padding: 14px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; transition: 0.3s; }
        .btn-guest { background: #6c757d; margin-top: 10px; width: 100%; padding: 12px; border:none; color: white; border-radius: 10px; font-weight: bold; cursor: pointer; }
        .btn-google { background: #db4437; color: white; box-shadow: 0 4px 10px rgba(219, 68, 55, 0.3); display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        .bottom-tabs { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; padding: 10px 0; z-index: 1000; }
        .tab-btn { flex: 1; text-align: center; color: #555; cursor: pointer; font-size: 11px; }
        .tab-btn i { font-size: 20px; display: block; margin-bottom: 2px; }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        
        .transfer-input { width: 100%; padding: 15px !important; margin: 10px 0; border: 2px solid #ddd !important; border-radius: 12px !important; font-size: 18px !important; text-align: center; box-sizing: border-box; background: #fdfdfd; }
        .transfer-input:focus { border-color: var(--blue) !important; background: #fff; }

        .post { background: white; margin: 15px; border-radius: 15px; overflow: hidden; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #eee; }
        .post-img-container { position: relative; width: 100%; height: 220px; }
        .sold-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(220, 53, 69, 0.8); color: white; display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: bold; z-index: 5; }
        .price-tag { color: var(--green); font-weight: 800; font-size: 18px; }
        .old-price { text-decoration: line-through; color: var(--red); font-size: 14px; margin-left: 10px; }
        .post-options { position: absolute; top: 12px; left: 12px; color: white; background: rgba(0,0,0,0.6); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; }
        .post-time { font-size: 11px; color: #999; }
        .seller-info { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; border-bottom: 1px solid #f9f9f9; padding-bottom: 8px; cursor: pointer; }
        .btn-whatsapp { background: #25d366; color: white; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; border-radius: 10px; margin-top: 10px; font-weight: bold; width: 100%; box-sizing: border-box; }

        .wallet-card { background: linear-gradient(135deg, #0d1117, #1e3a8a); color: white; padding: 25px; margin: 15px; border-radius: 20px; text-align: center; position: relative; overflow: hidden; }
        .sdm-logo { width: 70px; height: 70px; border-radius: 50%; border: 2px solid var(--gold); margin-bottom: 10px; object-fit: cover; }
        
        .admin-panel { background: #fff; margin: 15px; padding: 15px; border-radius: 15px; border: 2px solid var(--red); }
        .admin-notify-bar { background: #fff3cd; border: 2px solid var(--gold); margin: 15px; padding: 15px; border-radius: 15px; }

        .game-panel { background: #ffffff; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin: 15px; border: 2px solid #2563eb; }
        
        .search-hidden { display: none !important; }
        .badge-good { background-color: #3498db; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 5px; }
        .badge-super { background-color: #f1c40f; color: black; padding: 2px 6px; border-radius: 4px; font-size: 10px; margin-right: 5px; font-weight: bold; border: 1px solid #d4ac0d; }
    </style>
</head>
<body>

<div id="auth-screen" class="hidden">
    <div style="padding:40px; text-align:center; height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; background: #f0f2f5;">
        <img src="https://i.ibb.co/3ykXvBv/SDM-Coin.jpg" style="width:100px; height:100px; border-radius:50%; margin-bottom:20px; border:3px solid var(--gold);">
        <h2 style="color:var(--navy); margin-bottom:10px;">Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† & SDM ğŸª™</h2>
        <p style="color:#666; margin-bottom:30px;">Ø¨ÙŠØ¹ØŒ Ø§Ø´ØªØ±ÙŠØŒ ÙˆØªØ¯Ø§ÙˆÙ„ Ø¨Ø£Ù…Ø§Ù†</p>
        <div id="login-box" style="width:100%; max-width:350px;">
            <button class="btn-main btn-google" onclick="loginWithGoogle()"><i class="fab fa-google"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Google</button>
            <button class="btn-guest" onclick="enterGuestMode()">Ø²ÙŠØ§Ø±Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙƒØ²Ø§Ø¦Ø± ğŸ‘€</button>
        </div>
        <p style="margin-top:20px; font-size:12px; color:#888;">Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ù„Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¹Ù†ÙŠ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…</p>
    </div>
</div>

<div id="app-screen" class="hidden">
    <header>
        <div class="header-top">
            <span onclick="goBack()" style="cursor:pointer; font-size:20px;">ğŸ”™</span>
            <b id="head-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</b>
            <div style="display:flex; align-items:center;">
                <div class="online-dot" style="width:10px; height:10px; background:#2ecc71; border-radius:50%; margin-left:5px;"></div>
                <span id="u-stars" style="color:var(--gold)">â­0</span>
            </div>
        </div>
        <div class="search-container">
            <i class="fas fa-search"></i>
            <input type="text" id="store-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬ØŒ Ù„Ø¹Ø¨Ø©ØŒ Ø®Ø¯Ù…Ø©..." oninput="filterContent(this.value)">
        </div>
    </header>

    <div id="dev-alert-bar"></div>
    <div id="admin-notifications-area"></div>
    <div id="welcome-container"></div>
    
    <div id="content-area"></div>

    <div class="bottom-tabs">
        <div class="tab-btn" onclick="nav('home')"><i class="fas fa-home"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="tab-btn" onclick="checkGuestAccess('wallet')"><i class="fas fa-wallet" style="color:blue"></i>SDM</div>
        <div class="tab-btn" onclick="checkGuestAccess('games')"><i class="fas fa-gamepad" style="color:purple"></i>Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</div>
        <div class="tab-btn" onclick="checkGuestAccess('vip')"><i class="fas fa-gem" style="color:gold"></i>VIP</div>
        <div class="tab-btn" onclick="checkGuestAccess('profile')"><i class="fas fa-user-circle"></i>Ù…Ù„ÙÙŠ</div>
    </div>
</div>

<script>
    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³ ---
    const firebaseConfig = {
      apiKey: "AIzaSyAI_mUhuPNoO-XC0Q-VNoWft8UWFbAbIGg",
      authDomain: "sudan-market-6b122.firebaseapp.com",
      databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com",
      projectId: "sudan-market-6b122",
      storageBucket: "sudan-market-6b122.firebasestorage.app",
      messagingSenderId: "66729481566",
      appId: "1:66729481566:web:93393f28dc22d32cceebcf",
      measurementId: "G-L4SDJWKPK5"
    };
    
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    const ADMIN_EMAIL_ADDRESS = "mb425262@gmail.com";
    const SDM_PRICE = 1000;
    let me = null;
    let hStack = ['home'];
    let curC = '', curS = '';
    let tempImg = '', tempBuyImg = '', userPic = 'https://via.placeholder.com/150';
    let isGuest = false; 
    let sliderInterval;
    const sdmCoinImage = "https://i.ibb.co/3ykXvBv/SDM-Coin.jpg"; 
    // Ù…ØµÙÙˆÙØ© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 3 ØµÙˆØ± ÙƒØ­Ø¯ Ø£Ø¯Ù†Ù‰ (Ø³ÙŠØªÙ… Ø¬Ù„Ø¨Ù‡Ø§ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
    let sliderImages = [sdmCoinImage, sdmCoinImage, sdmCoinImage]; 
    let currentSliderIndex = 0;

    const cats = {
        "Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„Ø§Øª": {i:"mobile-alt", s:["Ø¢ÙŠÙÙˆÙ†","Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬","Ø´Ø§ÙˆÙ…ÙŠ","Ø¨ÙƒØ³Ù„","Ù‡ÙˆØ§ÙˆÙŠ"]},
        "Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª": {i:"car", s:["ØªÙˆÙŠÙˆØªØ§","Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ","BYD","Ø£ÙƒØ³Ù†Øª","Ø±ÙƒØ´Ø§Øª"]},
        "Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª": {i:"home", s:["Ø´Ù‚Ù‚ Ù„Ù„Ø§ÙŠØ¬Ø§Ø±","Ø¨ÙŠÙˆØª Ù„Ù„Ø¨ÙŠØ¹","Ù…Ø²Ø§Ø±Ø¹","Ø§Ø±Ø§Ø¶ÙŠ"]},
        "Ø£Ø¬Ù‡Ø²Ø© Ù…Ù†Ø²Ù„ÙŠØ©": {i:"tv", s:["Ø´Ø§Ø´Ø§Øª","Ø«Ù„Ø§Ø¬Ø§Øª","Ù…ÙƒÙŠÙØ§Øª","ØºØ³Ø§Ù„Ø§Øª"]},
        "Ø§Ù„ØªØ¹Ø¯ÙŠÙ†": {i:"hammer", s:[]}, 
        "Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±": {i:"laptop", s:["Ù„Ø§Ø¨ØªÙˆØ¨Ø§Øª","Ø·Ø§Ø¨Ø¹Ø§Øª","Ø§ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª"]},
        "Ø£Ø«Ø§Ø« Ù…Ù†Ø²Ù„": {i:"chair", s:["ØºØ±Ù Ù†ÙˆÙ…","Ø³Ø±Ø§ÙŠØ±","ÙƒØ±Ø§Ø³ÙŠ","Ø·Ø§ÙˆÙ„Ø§Øª"]},
        "Ù…Ù„Ø§Ø¨Ø³ Ø±Ø¬Ø§Ù„ÙŠØ©": {i:"tshirt", s:["Ù‚Ù…ØµØ§Ù†","Ø¨Ù†Ø§Ø·ÙŠÙ„","Ø§Ø­Ø°ÙŠØ©","Ø¬Ù„Ø§Ø¨ÙŠØ¨"]},
        "Ù…Ù„Ø§Ø¨Ø³ Ù†Ø³Ø§Ø¦ÙŠØ©": {i:"female", s:["ØªÙŠØ§Ø¨","ÙØ³Ø§ØªÙŠÙ†","Ø´Ù†Ø·","Ù…ÙƒÙŠØ§Ø¬"]},
        "Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø£Ø·ÙØ§Ù„": {i:"baby", s:["Ù…Ù„Ø§Ø¨Ø³ Ø§Ø·ÙØ§Ù„","Ø§Ù„Ø¹Ø§Ø¨","Ø¹Ø±Ø¨Ø§Øª Ø§Ø·ÙØ§Ù„"]},
        "Ø§Ù„Ø°Ù‡Ø¨ ÙˆØ§Ù„Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª": {i:"gem", s:["Ø®ÙˆØ§ØªÙ…","Ø³Ù„Ø§Ø³Ù„","Ø§Ø·Ù‚Ù… Ø°Ù‡Ø¨"]},
        "Ø­ÙŠÙˆØ§Ù†Ø§Øª": {i:"paw", s:["Ø§ØºÙ†Ø§Ù…","Ø·ÙŠÙˆØ±","Ù‚Ø·Ø·","Ø®ÙŠÙˆÙ„"]},
        "Ø®Ø¯Ù…Ø§Øª Ù…Ù‡Ù†ÙŠØ©": {i:"tools", s:["ÙƒÙ‡Ø±Ø¨Ø§Ø¡","Ø³Ø¨Ø§ÙƒØ©","Ø­Ø¯Ø§Ø¯Ø©","Ù†Ù‚Ø§Ø´Ø©"]},
        "Ù…Ø·Ø§Ø¹Ù…": {i:"utensils", s:["ÙˆØ¬Ø¨Ø§Øª Ø³Ø±ÙŠØ¹Ø©","Ø­Ù„ÙˆÙŠØ§Øª","Ø¹ØµØ§Ø¦Ø±"]},
        "Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø¬Ù…Ø§Ù„": {i:"heartbeat", s:["Ø¹Ø·ÙˆØ±","ÙƒØ±ÙŠÙ…Ø§Øª","Ù…Ø¹Ø¯Ø§Øª Ø·Ø¨ÙŠØ©"]},
        "ÙƒØªØ¨ ÙˆØ£Ø¯ÙˆØ§Øª": {i:"book", s:["Ø±ÙˆØ§ÙŠØ§Øª","ÙƒØªØ¨ Ø¹Ù„Ù…ÙŠØ©","Ù‚Ø±Ø·Ø§Ø³ÙŠØ©"]},
        "Ø³ÙŠØ§Ø­Ø© ÙˆØ³ÙØ±": {i:"plane", s:["ØªØ°Ø§ÙƒØ± Ø·ÙŠØ±Ø§Ù†","ØªØ£Ø´ÙŠØ±Ø§Øª","ÙÙ†Ø§Ø¯Ù‚"]},
        "Ù…Ù†ÙˆØ¹Ø§Øª": {i:"box-open", s:["Ø§ØºØ±Ø§Ø¶ Ø§Ø®Ø±Ù‰"]}
    };

    const officialRates = {
        pubg: [ { name: "60 UC", sdm: 4 }, { name: "325 UC", sdm: 20 }, { name: "660 UC", sdm: 40 } ],
        ff: [ { name: "100 Ø¬ÙˆÙ‡Ø±Ø©", sdm: 4 }, { name: "530 Ø¬ÙˆÙ‡Ø±Ø©", sdm: 20 }, { name: "1080 Ø¬ÙˆÙ‡Ø±Ø©", sdm: 40 } ]
    };

    // --- Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ù…Ø§ÙŠØ© (XSS Protection) ---
    function escapeHtml(text) {
        if (!text) return text;
        return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    // --- 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
    auth.onAuthStateChanged(user => {
        if (user) {
            const uid = user.uid;
            db.ref('users/' + uid).once('value', snap => {
                if(snap.exists()) {
                    let u = snap.val();
                    // ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¢Ø¯Ù…Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    if (user.email === ADMIN_EMAIL_ADDRESS && u.role !== 'admin') {
                        u.role = 'admin';
                        db.ref('users/' + uid).update({ role: 'admin' });
                    }
                    if (u.bannedUntil && u.bannedUntil > Date.now()) {
                        Swal.fire('Ù…Ø­Ø¸ÙˆØ±', 'ØªÙ… Ø­Ø¸Ø± Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø¤Ù‚ØªØ§Ù‹.', 'error').then(() => auth.signOut());
                        return;
                    }
                    me = u;
                    startApp(uid);
                } else {
                    const initialRole = (user.email === ADMIN_EMAIL_ADDRESS) ? 'admin' : 'user';
                    const newUser = { n: user.displayName || 'Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯', p: uid, email: user.email, pic: user.photoURL, sdmBalance: 0, rating: 0, vipStatus: 'none', role: initialRole, reportCount: 0, wa: '' };
                    db.ref('users/' + uid).set(newUser).then(() => { me = newUser; startApp(uid); });
                }
            });
        } else {
            if(!isGuest) {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        }
    });

    function loginWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(error => Swal.fire('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', error.message, 'error'));
    }

    function doLogout() {
        auth.signOut().then(() => location.reload());
    }

    function enterGuestMode() {
        isGuest = true;
        me = { n: 'Ø²Ø§Ø¦Ø±', p: 'guest', role: 'guest', sdmBalance: 0 };
        document.getElementById('auth-screen').classList.add('hidden');
        document.getElementById('app-screen').classList.remove('hidden');
        document.getElementById('u-stars').innerText = "Ø²Ø§Ø¦Ø±";
        listenForDevAlerts();
        render('home');
    }

    function compressImage(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const MAX_WIDTH = 800;
                    const scaleSize = MAX_WIDTH / img.width;
                    if (scaleSize >= 1) { resolve(event.target.result); return; }
                    canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                }
            };
        });
    }

    async function encode(i, t) {
        if(!i.files[0]) return;
        try {
            Swal.fire({ title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...', didOpen: () => Swal.showLoading(), allowOutsideClick: false, showConfirmButton: false, timer: 1000 });
            const compressed = await compressImage(i.files[0]);
            if(t === 'user') {
                userPic = compressed;
                if(me && !isGuest) {
                     db.ref('users/'+me.p).update({ pic: userPic });
                     const view = document.getElementById('profile-img-view');
                     if(view) view.src = userPic;
                }
            } else if(t === 'buy') { tempBuyImg = compressed; }
            else if(t === 'coin-setting') { tempImg = compressed; }
            else { tempImg = compressed; }
        } catch(e) { console.error(e); Swal.fire('Ø®Ø·Ø£', 'ÙØ´Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©', 'error'); }
    }

    function checkGuestAccess(view, extra) {
        if (isGuest) {
            Swal.fire({ title: 'ØªÙ†Ø¨ÙŠÙ‡', text: 'ØªØªØ·Ù„Ø¨ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ØªØ³Ø¬ÙŠÙ„Ø§Ù‹.', icon: 'info', showCancelButton: true, confirmButtonText: 'Ø¯Ø®ÙˆÙ„' }).then((res) => {
                if(res.isConfirmed) location.reload();
            });
            return;
        }
        nav(view, extra);
    }

    function startApp(uid) {
        isGuest = false;
        hStack = ['home'];
        
        db.ref('users/' + uid).on('value', snap => {
            const val = snap.val();
            if (!val) return; 
            if (val.bannedUntil && val.bannedUntil > Date.now()) {
                Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø­Ø³Ø§Ø¨Ùƒ Ù…Ø­Ø¸ÙˆØ±', 'error').then(() => doLogout());
                return;
            }

            me = val;
            me.p = uid;
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            if (!me.wa) promptWhatsApp();
            checkVipExpiry();
            listenForUserAlerts();
            listenForDevAlerts();
            checkForBroadcastMessage();
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù„Ù„Ø¢Ø¯Ù…Ù† (Ù„ÙƒÙ† Ø¨Ø¯ÙˆÙ† ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø­Ø³Ø§Ø¨ÙŠØ© Ø¢Ù„ÙŠØ§Ù‹ Ù„Ø£Ù† Ø§Ù„Ø¨ÙˆØª ÙŠÙ‚ÙˆÙ… Ø¨Ù‡Ø§)
            if(me.role === "admin" && me.email === ADMIN_EMAIL_ADDRESS) {
                listenForAdminTasks();
                listenForReportNotifications();
            }
            if(me.role === "admin") setTimeout(initDeveloperLogic, 1000);
            render('home');
        });
        db.ref('users/' + uid).update({ lastSeen: Date.now() });
    }

    // --- ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±ÙˆØ¨ÙˆØªØ§Øª Ø§Ù„Ø¢Ù„ÙŠØ© (Transfer Robot & Rating Robot) Ù„ØªØ±Ùƒ Ø§Ù„Ù…Ø¬Ø§Ù„ Ù„Ø¨ÙˆØª Ø¨Ø§ÙŠØ«ÙˆÙ† ---

    async function promptWhatsApp() {
        const { value: wa } = await Swal.fire({ title: 'Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨', input: 'tel', inputPlaceholder: '0xxxxxxxxx', allowOutsideClick: false });
        if (wa) db.ref('users/'+me.p).update({ wa: wa });
    }

    function checkForBroadcastMessage() {
        db.ref('settings/broadcast').on('value', snap => {
            const data = snap.val();
            if (data && data.text) {
                const lastMsgId = localStorage.getItem('last_broadcast_id');
                if (lastMsgId != data.id) {
                    Swal.fire({ title: 'Ø±Ø³Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…Ø·ÙˆØ± ğŸ“¢', text: data.text, icon: 'info' }).then(() => localStorage.setItem('last_broadcast_id', data.id));
                }
            }
        });
    }

    function sendBroadcastMessage() {
        if(me.role !== 'admin') return;
        Swal.fire({ title: 'Ù†Ø´Ø± Ø±Ø³Ø§Ù„Ø©', input: 'textarea', showCancelButton: true }).then(res => {
            if(res.value) { db.ref('settings/broadcast').set({ text: res.value, id: Date.now() }); Swal.fire('ØªÙ…','','success'); }
        });
    }

    function listenForDevAlerts() {
        const bar = document.getElementById('dev-alert-bar');
        db.ref('settings/globalAlert').on('value', snap => {
            const msg = snap.val();
            if(msg) {
                bar.style.display = 'block';
                bar.innerHTML = `ğŸ“¢ ${escapeHtml(msg)} ${(!isGuest && me.role === 'admin') ? '<i class="fas fa-edit" onclick="editDevAlert()"></i>' : ''}`;
            } else { bar.style.display = 'none'; }
        });
    }

    function editDevAlert() {
        if (me.role !== "admin") return;
        Swal.fire({ title: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡', input: 'text', showCancelButton: true }).then(res => {
            if(res.isConfirmed) db.ref('settings/globalAlert').set(res.value);
        });
    }

    function filterContent(query) {
        query = query.toLowerCase();
        document.querySelectorAll('.post, .card').forEach(item => {
            if (item.classList.contains('admin-item') && (!me || me.role !== 'admin')) { item.classList.add('search-hidden'); return; }
            if (item.innerText.toLowerCase().includes(query)) item.classList.remove('search-hidden');
            else item.classList.add('search-hidden');
        });
    }

    function listenForAdminTasks() {
        if (me.role !== "admin") return;
        db.ref('coin_requests').orderByChild('status').equalTo('pending').on('value', snap => {
            const area = document.getElementById('admin-notifications-area');
            if(hStack[hStack.length-1] !== 'home') { area.innerHTML = ""; return; }
            area.innerHTML = "";
            snap.forEach(child => {
                const req = child.val();
                area.innerHTML += `
                    <div class="admin-notify-bar admin-item">
                        <p><b>ğŸ”” Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡</b>: ${escapeHtml(req.uN)} | ${req.qty} SDM</p>
                        <img src="${req.img}" style="width:100%; border-radius:10px; cursor:pointer;" onclick="Swal.fire({imageUrl:'${req.img}'})">
                        <div style="display:flex; gap:10px; margin-top:5px;">
                            <button class="btn-main" style="background:var(--green); margin:0;" onclick="approvePurchase('${child.key}', '${req.uP}', ${req.qty})">Ù…ÙˆØ§ÙÙ‚</button>
                            <button class="btn-main" style="background:var(--red); margin:0;" onclick="rejectPurchase('${child.key}', '${req.uP}')">Ø±ÙØ¶</button>
                        </div>
                    </div>`;
            });
        });
    }

    function listenForReportNotifications() {
        if (me.role !== "admin") return;
        db.ref('users').orderByChild('reportCount').startAt(20).on('value', snap => {
            const area = document.getElementById('admin-notifications-area');
            snap.forEach(child => {
                const u = child.val();
                if (!u.adminHandled) {
                    area.innerHTML += `
                    <div class="admin-notify-bar admin-item" style="border-color:red; background:#ffe6e6">
                        <p><b>ğŸš¨ ØªØ¬Ø§ÙˆØ² Ø¨Ù„Ø§ØºØ§Øª</b>: ${escapeHtml(u.n)} (${u.reportCount})</p>
                        <button class="btn-main" style="background:black" onclick="adminBanUser('${u.p}', 'delete')">Ø­Ø°Ù</button>
                        <button class="btn-main" style="background:var(--red)" onclick="adminBanUser('${u.p}', 'custom')">Ø­Ø¸Ø±</button>
                        <button class="btn-main" style="background:gray" onclick="ignoreReport('${u.p}')">ØªØ¬Ø§Ù‡Ù„</button>
                    </div>`;
                }
            });
        });
    }

    async function adminBanUser(uid, action) {
        if (me.role !== "admin") return;
        if (action === 'delete') {
            if(confirm('Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ')) { await db.ref('users/'+uid).remove(); Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù','','success'); }
        } else if (action === 'custom') {
            const { value: days } = await Swal.fire({ title: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…ØŸ', input: 'number' });
            if (days) {
                await db.ref('users/'+uid).update({ bannedUntil: Date.now() + (days * 86400000), adminHandled: true });
                Swal.fire('ØªÙ… Ø§Ù„Ø­Ø¸Ø±','','success');
            }
        }
    }

    function ignoreReport(uid) {
        if (me.role !== "admin") return;
        db.ref('users/'+uid).update({ adminHandled: true });
        render('home'); 
    }

    async function approvePurchase(id, up, qty) {
        if (me.role !== "admin") return;
        const uSnap = await db.ref('users/'+up).once('value');
        const bal = uSnap.val().sdmBalance || 0;
        await db.ref('users/'+up).update({ sdmBalance: bal + Number(qty) });
        await db.ref('coin_requests/'+id).update({ status: 'approved', date: Date.now() });
        const opId = "BUY-" + Math.random().toString(36).substr(2, 6).toUpperCase();
        await db.ref('transactions').push({ opId, amount: qty, sender: 'admin', senderName: 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©', receiver: up, receiverName: uSnap.val().n, date: Date.now(), involves: [up, me.p], type: 'purchase' });
        await db.ref('alerts/'+up).push({ msg: `âœ… ØªÙ… Ø´Ø±Ø§Ø¡ ${qty} SDM`, type: 'success' });
        Swal.fire('ØªÙ…','','success');
    }

    async function rejectPurchase(id, up) {
        if (me.role !== "admin") return;
        await db.ref('coin_requests/'+id).update({ status: 'rejected' });
        await db.ref('alerts/'+up).push({ msg: `âŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡`, type: 'error' });
        Swal.fire('ØªÙ… Ø§Ù„Ø±ÙØ¶','','info');
    }

    function initDeveloperLogic() {
        if (me.role !== "admin") return;
        db.ref('game_orders').orderByChild('status').equalTo('pending').on('value', snap => {
            const container = document.getElementById('orders-list-container');
            if(!container) return;
            container.innerHTML = "";
            snap.forEach(child => {
                const o = child.val();
                let desc = o.gameType === 'VIP_SUB' ? `<span style="color:gold">ğŸ’ VIP (${o.package})</span>` : `<b>${o.gameType}</b> (${o.package}) <br> ID: ${o.playerId}`;
                container.innerHTML += `
                    <div class="order-card admin-item">
                        <b>Ø§Ù„Ø¹Ù…ÙŠÙ„:</b> ${escapeHtml(o.uN)}<br>${desc}<br>
                        <div style="color:blue">Øª: ${o.cost} SDM</div>
                        <div class="admin-btns">
                            <button class="btn-main" style="background:green" onclick="confirmOrder('${child.key}', '${o.uP}', ${o.cost}, '${o.gameType}', '${o.package}')">Ù‚Ø¨ÙˆÙ„ âœ…</button>
                            <button class="btn-main" style="background:red" onclick="rejectOrder('${child.key}', '${o.uP}')">Ø±ÙØ¶ âŒ</button>
                        </div>
                    </div>`;
            });
        });
    }

    async function confirmOrder(key, uid, cost, type, packDetails) {
        if (me.role !== "admin") return;
        const uSnap = await db.ref('users/'+uid).once('value');
        if(!uSnap.exists()) return;
        const u = uSnap.val();
        if((u.sdmBalance || 0) < cost) { Swal.fire('ÙØ´Ù„', 'Ø±ØµÙŠØ¯ ØºÙŠØ± ÙƒØ§Ù', 'error'); return; }
        await db.ref('users/'+uid).update({ sdmBalance: u.sdmBalance - cost });
        if(type === 'VIP_SUB') {
            await db.ref('users/'+uid).update({ vipStatus: 'active', vipExpiry: Date.now() + (parseInt(packDetails) * 86400000) });
        }
        await db.ref('game_orders/' + key).update({ status: 'done' });
        db.ref('alerts/' + uid).push({ msg: type === 'VIP_SUB' ? "ğŸ’ ØªÙ… ØªÙØ¹ÙŠÙ„ VIP" : "âœ… ØªÙ… Ø§Ù„Ø´Ø­Ù†", type: "success" });
        Swal.fire("Ù†Ø¬Ø§Ø­", "", "success");
    }

    async function rejectOrder(key, uid) {
        if (me.role !== "admin") return;
        await db.ref('game_orders/' + key).update({ status: 'rejected' });
        db.ref('alerts/' + uid).push({ msg: "âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨", type: "error" });
        Swal.fire("ØªÙ… Ø§Ù„Ø±ÙØ¶", "", "info");
    }

    function listenForUserAlerts() {
        if(isGuest) return;
        db.ref('alerts/'+me.p).on('child_added', snap => {
            const data = snap.val();
            if(data.isReceipt) showReceiptModal(data);
            else Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', escapeHtml(data.msg), data.type);
            snap.ref.remove();
        });
    }

    function showReceiptModal(data) {
        Swal.fire({
            html: `
            <div class="receipt-container">
                <div class="receipt-header-new"><h3 style="margin:0; color:var(--blue);">Ø¥Ø´Ø¹Ø§Ø± SDM</h3></div>
                <div class="receipt-row"><span>Ø±Ù‚Ù…:</span> <span>${data.opId}</span></div>
                <div class="receipt-row"><span>Ù…Ù†:</span> <span>${escapeHtml(data.senderName)}</span></div>
                <div class="receipt-row"><span>Ø¥Ù„Ù‰:</span> <span>${escapeHtml(data.receiverName)}</span></div>
                <div class="receipt-row"><span>Ø§Ù„Ù…Ø¨Ù„Øº:</span> <span style="color:green">${data.amount} SDM</span></div>
                <div class="receipt-row"><span>Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> <span>${data.time}</span></div>
            </div>`,
            showConfirmButton: true, confirmButtonText: 'Ø¥ØºÙ„Ø§Ù‚'
        });
    }

    function timeSince(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return "Ù…Ù†Ø° Ø³Ù†Ø©";
        interval = seconds / 2592000;
        if (interval > 1) return "Ù…Ù†Ø° " + Math.floor(interval) + " Ø´Ù‡Ø±";
        interval = seconds / 86400;
        if (interval > 1) return "Ù…Ù†Ø° " + Math.floor(interval) + " ÙŠÙˆÙ…";
        interval = seconds / 3600;
        if (interval > 1) return "Ù…Ù†Ø° " + Math.floor(interval) + " Ø³Ø§Ø¹Ø©";
        interval = seconds / 60;
        if (interval > 1) return "Ù…Ù†Ø° " + Math.floor(interval) + " Ø¯Ù‚ÙŠÙ‚Ø©";
        return "Ø§Ù„Ø¢Ù†";
    }

    function showWelcome() {
        const hour = new Date().getHours();
        const container = document.getElementById('welcome-container');
        if(hStack[hStack.length-1] === 'home' && me && !isGuest) {
            container.innerHTML = `<div class="welcome-msg">${hour < 12 ? "ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±" : "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±"}ØŒ ${escapeHtml(me.n)} âœ¨</div>`;
        } else { container.innerHTML = ""; }
    }

    function nav(v, e) { 
        if(v === 'sub' && e === 'Ø§Ù„ØªØ¹Ø¯ÙŠÙ†') { Swal.fire('Ù‚Ø±ÙŠØ¨Ø§Ù‹', 'Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ† â›ï¸', 'info'); return; }
        hStack.push(v); render(v, e); 
    }
    function goBack() { if(hStack.length > 1) { hStack.pop(); render(hStack[hStack.length-1]); } }

    function render(view, extra) {
        const area = document.getElementById('content-area');
        const adminArea = document.getElementById('admin-notifications-area');
        
        if (sliderInterval) clearInterval(sliderInterval);
        if(view !== 'home') adminArea.innerHTML = "";

        showWelcome();
        if(me) document.getElementById('u-stars').innerText = isGuest ? "Ø²Ø§Ø¦Ø±" : `â­${(me.rating || 0).toFixed(1)}`;
        document.getElementById('head-title').innerText = (view==='wallet'?"Ù…Ø­ÙØ¸Ø©":(view==='games'?"Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨":(view==='vip'?"VIP":(view==='profile'?"Ø§Ù„Ù…Ù„Ù":"Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"))));

        if(view === 'home') {
            db.ref('settings').on('value', snap => {
                const s = snap.val() || {};
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ 3 ØµÙˆØ± ÙÙŠ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø±
                sliderImages = (s.sliderImages && s.sliderImages.length >= 3) ? s.sliderImages : [sdmCoinImage, sdmCoinImage, sdmCoinImage];
                
                area.innerHTML = `
                    <div class="slider-container" onclick="handleSliderClick()">
                        <img id="slider-img" src="${sliderImages[0]}">
                        <div class="slider-overlay">Ø§Ù„Ù…Ø­ÙØ¸Ø©</div>
                        <div class="slider-dots">
                            <div class="dot active" id="dot-0"></div>
                            <div class="dot" id="dot-1"></div>
                            <div class="dot" id="dot-2"></div>
                        </div>
                        ${(!isGuest && me.role === 'admin') ? `<div class="edit-slider-btn" onclick="updateCurrentSliderImg()">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>` : ''}
                    </div>
                    ${(!isGuest && me.role === 'admin') ? `<button class="btn-main" style="background:#6f42c1; margin:10px;" onclick="sendBroadcastMessage()">ğŸ“¢ Ù†Ø´Ø± Ø±Ø³Ø§Ù„Ø©</button>` : ''}
                    <div id="vip-slider"></div>
                    <div class="grid">
                        ${Object.keys(cats).map(k=> {
                            const ci = (s.categories && s.categories[k]) ? s.categories[k].img : null;
                            const eb = (!isGuest && me.role === 'admin') ? `<div class="edit-cat-btn" onclick="event.stopPropagation(); updateCategoryImg('${k}')"><i class="fas fa-edit"></i></div>` : '';
                            return `<div class="card" onclick="nav('sub','${k}')">${eb} ${ci ? `<img src="${ci}" class="cat-custom-img">` : `<i class="fas fa-${cats[k].i}" style="font-size:24px; color:var(--blue); margin-bottom:10px;"></i>`} <br><b>${k}</b></div>`;
                        }).join('')}
                    </div>`;
                startSlider();
            });
            loadVipHome();
        } else if(view === 'sub') {
            curC = extra || curC;
            area.innerHTML = `<div class="grid">${cats[curC].s.map(s=>`<div class="card" onclick="nav('feed','${s}')"><b>${s}</b></div>`).join('')}</div>`;
        } else if(view === 'feed') {
            curS = extra || curS;
            area.innerHTML = `${!isGuest ? `<div class="publish-container"><h4>ğŸ“ Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†: ${curS}</h4><input id="pt" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"><input id="pp" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± (SDM)"><input id="p-whatsapp" type="tel" placeholder="ÙˆØ§ØªØ³Ø§Ø¨" value="${me.wa || ''}"><textarea id="pd" placeholder="Ø§Ù„ÙˆØµÙ"></textarea><input type="file" onchange="encode(this, 'post')"><button class="btn-main" onclick="publish('posts')">Ù†Ø´Ø±</button></div>` : ''}<div id="posts-list"></div>`;
            loadPosts('posts', curS);
        } else if(view === 'wallet') renderWallet(area);
        else if(view === 'vip') renderVip(area);
        else if(view === 'profile') renderProfile(area, extra || me.p);
        else if(view === 'games') renderGames(area);
    }

    function startSlider() {
        const imgEl = document.getElementById('slider-img');
        if(!imgEl) return;
        
        currentSliderIndex = 0;
        imgEl.src = sliderImages[0];
        updateDots(0);

        // Ø§Ù„ØªØºÙŠÙŠØ± ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
        sliderInterval = setInterval(() => {
            const el = document.getElementById('slider-img');
            if(!el) return;
            currentSliderIndex = (currentSliderIndex + 1) % 3; // ØªØ¯ÙˆÙŠØ± Ø¨ÙŠÙ† 0ØŒ 1ØŒ 2
            
            el.style.opacity = 0;
            setTimeout(() => { 
                el.src = sliderImages[currentSliderIndex]; 
                el.style.opacity = 1; 
                updateDots(currentSliderIndex);
            }, 300);
        }, 5000);
    }

    function updateDots(idx) {
        document.querySelectorAll('.dot').forEach(d => d.classList.remove('active'));
        const activeDot = document.getElementById(`dot-${idx}`);
        if(activeDot) activeDot.classList.add('active');
    }

    function handleSliderClick() { 
        if (me && me.role === 'admin') return; // Ø§Ù„Ø¢Ø¯Ù…Ù† Ù„Ø§ ÙŠØ¶ØºØ· Ù„Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        if (sliderImages[currentSliderIndex] === sdmCoinImage) checkGuestAccess('wallet'); 
    }
    
    // Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø´ÙƒÙ„ ÙØ±Ø¯ÙŠ
    async function updateCurrentSliderImg() {
        if (me.role !== 'admin') return;
        event.stopPropagation();
        
        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± Ù…Ø¤Ù‚ØªØ§Ù‹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        clearInterval(sliderInterval);

        Swal.fire({ 
            title: `ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø±Ù‚Ù… ${currentSliderIndex + 1}`, 
            html: '<input type="file" id="single-slider-input" class="swal2-file" accept="image/*">', 
            showCancelButton: true, 
            confirmButtonText: 'Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±',
            preConfirm: () => {
                const f = document.getElementById('single-slider-input').files[0];
                if (!f) return null;
                return compressImage(f);
            }
        }).then((res) => {
            if (res.value) {
                // ØªØ­Ø¯ÙŠØ« Ù…ØµÙÙˆÙØ© Ø§Ù„ØµÙˆØ± ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙ‚Ø·
                let newImages = [...sliderImages];
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¨Ø­Ø¬Ù… 3
                while(newImages.length < 3) newImages.push(sdmCoinImage);
                
                newImages[currentSliderIndex] = res.value;
                
                db.ref('settings/sliderImages').set(newImages).then(() => {
                    Swal.fire('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«', 'ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
                });
            }
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø±
            startSlider();
        });
    }

    async function updateCategoryImg(catName) {
        if (me.role !== 'admin') return;
        Swal.fire({ title: `ØµÙˆØ±Ø©: ${catName}`, html: '<input type="file" id="cat-img-input" accept="image/*" class="swal2-file">', showCancelButton: true, preConfirm: () => {
            const f = document.getElementById('cat-img-input').files[0];
            return f ? compressImage(f) : null;
        }}).then((res) => { if (res.value) db.ref(`settings/categories/${catName}`).set({ img: res.value }); });
    }

    function renderGames(area) {
        area.innerHTML = `
            <div class="game-panel">
                <div class="game-header"><i class="fas fa-gamepad" style="font-size:40px; color:#2563eb;"></i><h2>Ø´Ø­Ù† Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</h2></div>
                <select id="active-game" onchange="loadCorrectPacks()"><option value="pubg">Ø¨Ø¨Ø¬ÙŠ (UC)</option><option value="ff">ÙØ±ÙŠ ÙØ§ÙŠØ± (Gems)</option></select>
                <input type="text" id="p-id-input" placeholder="ID Ø§Ù„Ù„Ø§Ø¹Ø¨">
                <select id="p-pack-input"></select>
                <button class="btn-main" style="background:#2563eb" onclick="sendOrderToDeveloper()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
            </div>
            <div style="background:white; padding:15px; margin:15px; border-radius:15px;"><h4><i class="fas fa-history"></i> Ø§Ù„Ø³Ø¬Ù„</h4><div id="game-history-container">ØªØ­Ù…ÙŠÙ„...</div></div>
            <div id="developer-area" class="hidden"><div class="admin-orders"><h3>Ø·Ù„Ø¨Ø§Øª</h3><div id="orders-list-container"></div></div></div>`;
        loadCorrectPacks(); loadGameHistory(); 
        if(me.role === "admin") { document.getElementById('developer-area').classList.remove('hidden'); initDeveloperLogic(); }
    }

    function loadGameHistory() {
        db.ref('game_orders').orderByChild('uP').equalTo(me.p).limitToLast(10).on('value', snap => {
            const c = document.getElementById('game-history-container');
            if(!c) return;
            let html = `<table style="width:100%"><thead><tr><th>Ø§Ù„Ù†ÙˆØ¹</th><th>SDM</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>`;
            let has = false;
            snap.forEach(ch => { has=true; const o=ch.val(); html+=`<tr><td>${o.gameType==='VIP_SUB'?'VIP':o.gameType}</td><td>${o.cost}</td><td>${o.status==='done'?'âœ…':(o.status==='rejected'?'âŒ':'â³')}</td></tr>`; });
            c.innerHTML = has ? html+"</tbody></table>" : "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯</p>";
        });
    }

    function loadCorrectPacks() {
        const g = document.getElementById('active-game').value;
        const p = document.getElementById('p-pack-input');
        p.innerHTML = "";
        officialRates[g].forEach(r => p.innerHTML += `<option value="${r.sdm}">${r.name} - ${r.sdm} SDM</option>`);
    }

    async function sendOrderToDeveloper() {
        const game = document.getElementById('active-game').value;
        const pid = document.getElementById('p-id-input').value;
        const packEl = document.getElementById('p-pack-input');
        const cost = parseInt(packEl.value);
        if (!pid) return Swal.fire("ØªÙ†Ø¨ÙŠÙ‡", "Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¢ÙŠØ¯ÙŠ", "warning");
        if (me.sdmBalance < cost) return Swal.fire("ÙØ´Ù„", "Ø±ØµÙŠØ¯Ùƒ Ù„Ø§ ÙŠÙƒÙÙŠ", "error");
        await db.ref('game_orders').push({ uP: me.p, uN: me.n, gameType: game, playerId: pid, package: packEl.options[packEl.selectedIndex].text, cost, status: 'pending', date: Date.now() });
        Swal.fire("ØªÙ…", "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©", "success");
    }

    function loadPosts(path, subFilter) {
        db.ref(path).on('value', snap => {
            const list = document.getElementById(path === 'posts' ? 'posts-list' : 'vip-slider-inner');
            if(!list) return;
            list.innerHTML = "";
            snap.forEach(c => {
                const p = c.val();
                if(subFilter && p.sub !== subFilter) return;
                const isMy = (me && (p.uP === me.p || me.role === "admin"));
                const rb = (!isGuest && p.uP !== me.p) ? `<i class="fas fa-star rate-btn" onclick="rateUser('${p.uP}')" title="Ù‚ÙŠÙ‘Ù…"></i>` : '';
                list.innerHTML += `
                <div class="post">
                    ${isMy ? `<i class="fas fa-ellipsis-v post-options" onclick="showPostMenu('${path}', '${c.key}', '${p.t}', '${p.pr}', '${p.d}')"></i>` : ''}
                    <div class="post-img-container">${p.status === 'sold' ? '<div class="sold-overlay">ØªÙ… Ø§Ù„Ø¨ÙŠØ¹</div>' : ''}<img src="${p.img}" style="width:100%; height:100%; object-fit:cover"></div>
                    <div style="padding:15px">
                        <div class="seller-info" onclick="checkGuestAccess('profile', '${p.uP}')"><img src="${p.uPic||'https://via.placeholder.com/50'}" style="width:30px; height:30px; border-radius:50%"> <span>${escapeHtml(p.uN)} ${rb} <span style="color:var(--gold); font-size:10px;">â­${p.uStars||0}</span></span></div>
                        <h2 style="margin:5px 0; font-size:20px;">${escapeHtml(p.t)}</h2>
                        <div>${p.oldPr?`<span class="old-price">${p.oldPr}</span>`:''} <span class="price-tag">${p.pr} SDM</span></div>
                        <p style="font-size:14px; color:#444;">${escapeHtml(p.d)}</p>
                        ${p.vExpiry ? `<div style="font-size:12px; color:var(--red);">ğŸ•’ ÙŠÙ†ØªÙ‡ÙŠ: ${new Date(p.vExpiry).toLocaleDateString()}</div>` : ''}
                        <div class="post-time">${timeSince(p.date)}</div>
                        <div style="display:flex; gap:10px; margin-top:10px;"><a href="https://wa.me/${p.wa||p.uP}" target="_blank" class="btn-whatsapp"><i class="fab fa-whatsapp"></i> ÙˆØ§ØªØ³Ø§Ø¨</a></div>
                        ${(!isGuest && p.uP !== me.p) ? `<button class="btn-main" style="background:var(--red); font-size:12px; padding:5px;" onclick="reportItem('${p.uP}', '${c.key}', '${p.t}')">ğŸš© Ø¥Ø¨Ù„Ø§Øº</button>` : ''}
                        <div class="comment-box" style="margin-top:15px"><div id="comments-${c.key}"></div>${!isGuest?`<div style="display:flex; gap:5px; margin-top:5px;"><input id="ci-${c.key}" placeholder="ØªØ¹Ù„ÙŠÙ‚..." style="font-size:12px;"><button onclick="addComment('${path}', '${c.key}')" style="width:45px;"><i class="fas fa-paper-plane"></i></button></div>`:''}</div>
                    </div>
                </div>`;
                loadComments(path, c.key);
            });
        });
    }

    function showPostMenu(path, id, t, pr, d) {
        Swal.fire({ title: 'Ø¥Ø¯Ø§Ø±Ø©', showCancelButton: true, confirmButtonText: 'ØªØ¹Ø¯ÙŠÙ„', denyButtonText: 'Ø­Ø°Ù', showDenyButton: true, footer: `<button class="btn-main" style="background:green" onclick="markSold('${path}','${id}')">ØªÙ… Ø§Ù„Ø¨ÙŠØ¹</button>`, preConfirm: () => {
            Swal.fire({ title: 'ØªØ¹Ø¯ÙŠÙ„', html: `<input id="np" value="${pr}"><textarea id="nd">${d}</textarea>`, preConfirm: () => db.ref(`${path}/${id}`).update({ pr: document.getElementById('np').value, d: document.getElementById('nd').value }) });
        }}).then(r => { if(r.isDenied) db.ref(`${path}/${id}`).remove(); });
    }

    function markSold(path, id) { db.ref(`${path}/${id}`).update({ status: 'sold' }); Swal.close(); }
    
    async function reportItem(uid, pid, t) { if(confirm(`Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† ${t}ØŸ`)) { db.ref('reports').push({ postId: pid, offender: uid, reporter: me.p, date: Date.now() }); handleReport(uid); } }
    async function reportUser(uid) { if(isGuest) return checkGuestAccess('profile'); if(confirm('Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ')) { db.ref('user_reports').push({ offender: uid, reporter: me.p, date: Date.now() }); handleReport(uid); } }
    async function handleReport(uid) {
        const s = await db.ref('users/'+uid).once('value');
        if(s.exists()) { await db.ref('users/'+uid).update({ reportCount: (s.val().reportCount||0)+1 }); Swal.fire('ØªÙ… Ø§Ù„Ø¥Ø¨Ù„Ø§Øº','','success'); }
    }

    function addComment(path, id) {
        const txt = document.getElementById(`ci-${id}`).value;
        if(!txt) return;
        db.ref(`${path}/${id}/comments`).push({ uN: me.n, uP: me.p, txt: txt, date: Date.now() });
        document.getElementById(`ci-${id}`).value = "";
    }

    function loadComments(path, id) {
        db.ref(`${path}/${id}/comments`).limitToLast(5).on('value', snap => {
            const d = document.getElementById(`comments-${id}`);
            if(!d) return; d.innerHTML = "";
            snap.forEach(c => { const x=c.val(); d.innerHTML+=`<div style="font-size:12px"><b>${escapeHtml(x.uN)}:</b> ${escapeHtml(x.txt)}</div>`; });
        });
    }

    function renderWallet(area) {
        db.ref('settings/coinImg').on('value', snap => {
            const ci = snap.val() || sdmCoinImage;
            area.innerHTML = `
                <div class="wallet-card"><img src="${ci}" class="sdm-logo">${(me.role === "admin") ? '<br><input type="file" onchange="updateCoinImg(this)" style="font-size:10px;">' : ''}<h1 style="font-size:32px; margin:10px 0;">${me.sdmBalance} SDM</h1><p style="font-size:14px; color:var(--gold)">1 SDM â‰ˆ ${SDM_PRICE} Ø¬.Ø³</p><button class="btn-main" style="background:var(--green); border:2px solid #fff;" onclick="showTransfer()">ğŸ’¸ ØªØ­ÙˆÙŠÙ„</button></div>
                <div id="transactions-history" style="padding:15px; background:#fff; margin:15px; border-radius:15px;"><h4><i class="fas fa-history"></i> Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª</h4><div id="trans-list" style="max-height:200px; overflow-y:auto; font-size:12px;"></div></div>
                ${(me.role === "admin") ? `<div class="admin-panel" id="admin-reqs"><h4>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡</h4></div>` : ''}
                <div style="padding:15px; background:#fff; margin:15px; border-radius:15px;"><h3>Ø´Ø±Ø§Ø¡ SDM</h3><p style="font-size:13px; color:#666;">Ø¨Ù†Ùƒ Ø§Ù„Ø®Ø±Ø·ÙˆÙ…: <b>4426148</b> (Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¹Ø·ÙŠ)</p><input id="buy-qty" type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" oninput="document.getElementById('bc').innerText=this.value*${SDM_PRICE}"><div id="bc"></div><input type="file" id="buy-img" onchange="encode(this, 'buy')"><button class="btn-main" onclick="requestCoins()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button></div>`;
            if(me.role === "admin") loadAdminRequests();
            loadTransactions();
        });
    }

    function loadTransactions() {
        db.ref('transactions').orderByChild('involves').on('value', snap => {
            const l = document.getElementById('trans-list'); if(!l) return; l.innerHTML = "";
            let i = []; snap.forEach(c => { let v=c.val(); v.key=c.key; if(v.involves && v.involves.includes(me.p)) i.unshift(v); });
            if(i.length===0) l.innerHTML="<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯</p>";
            i.forEach(t => {
                const s = t.sender === me.p;
                let ed = me.role==='admin'?`<i class="fas fa-edit" style="color:blue" onclick="editTransaction('${t.key}',${t.amount})"></i>`:'';
                l.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee;"><b>${t.type==='purchase'?'ğŸ“¥ Ø´Ø­Ù†':'ğŸ” ØªØ­ÙˆÙŠÙ„'}</b>: ${s?`Ø¥Ù„Ù‰ ${escapeHtml(t.receiverName)}`:`Ù…Ù† ${escapeHtml(t.senderName)}`} (${t.amount} SDM) ${ed}</div>`;
            });
        });
    }

    async function editTransaction(k, old) {
        if(me.role!=='admin') return;
        const {value:n} = await Swal.fire({title:'ØªØ¹Ø¯ÙŠÙ„', input:'number', inputValue:old});
        if(n) { await db.ref('transactions/'+k).update({amount:Number(n)}); Swal.fire('ØªÙ…','','success'); }
    }

    function loadAdminRequests() {
        db.ref('coin_requests').orderByChild('status').equalTo('pending').on('value', snap => {
            const d = document.getElementById('admin-reqs'); if(!d) return; d.innerHTML = "<h4>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡</h4>";
            snap.forEach(c => { const r=c.val(); d.innerHTML+=`<div class="admin-item"><p>${escapeHtml(r.uN)} (${r.qty})</p><img src="${r.img}" style="width:50px" onclick="Swal.fire({imageUrl:'${r.img}'})"><button onclick="approvePurchase('${c.key}','${r.uP}',${r.qty})">âœ…</button><button onclick="rejectPurchase('${c.key}','${r.uP}')">âŒ</button></div>`; });
        });
    }

    function showTransfer() {
        Swal.fire({
            title: 'ØªØ­ÙˆÙŠÙ„',
            html: `<div class="transfer-box"><input id="tr-p" class="transfer-input" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙ„Ù…" oninput="checkRecipient(this.value)"><div id="rec-name"></div><input id="tr-a" type="number" class="transfer-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº"></div>`,
            showCancelButton: true, confirmButtonText: 'Ø¥Ø±Ø³Ø§Ù„', preConfirm: () => {
                const p = document.getElementById('tr-p').value.trim(), a = document.getElementById('tr-a').value;
                if (!p || !a || p===me.p) return false; return {p, a};
            }
        }).then(async res => {
            if (!res.isConfirmed) return;
            const { p, a } = res.value; const amount = Number(a);
            if (me.sdmBalance < amount) return Swal.fire('Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ', '', 'error');
            await db.ref('transfer_queue').push({ sender: me.p, receiver: p, amount: amount, timestamp: firebase.database.ServerValue.TIMESTAMP });
            Swal.fire('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...', 'success');
        });
    }

    async function checkRecipient(uid) {
        if(uid.length > 5) {
            const s = await db.ref('users/'+uid).once('value');
            const el = document.getElementById('rec-name');
            if(s.exists()) el.innerHTML = `<span style="color:green">âœ… ${escapeHtml(s.val().n)}</span>`; else el.innerHTML = `âŒ`;
        }
    }

    function renderVip(area) {
        if (me.vipStatus === 'active') area.innerHTML = `<div class="publish-container"><h4>ğŸ’ Ù†Ø´Ø± VIP</h4><input id="v-t" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"><div style="display:flex; gap:10px;"><input id="v-old-pr" placeholder="Ù‚Ø¯ÙŠÙ…"><input id="v-pr" placeholder="Ø¬Ø¯ÙŠØ¯"></div><input id="v-wa" placeholder="ÙˆØ§ØªØ³Ø§Ø¨" value="${me.wa||''}"><textarea id="v-d" placeholder="ÙˆØµÙ"></textarea><input type="file" onchange="encode(this, 'post')"><button class="btn-main" onclick="publish('vip_posts')">Ù†Ø´Ø±</button></div>`;
        else area.innerHTML = `<div style="text-align:center;"><h3>VIP</h3><p>Ø±ØµÙŠØ¯Ùƒ: ${me.sdmBalance}</p><div class="grid"><div class="card" onclick="subVip(1, 1)">ÙŠÙˆÙ… (1)</div><div class="card" onclick="subVip(7, 7)">Ø£Ø³Ø¨ÙˆØ¹ (7)</div></div></div>`;
    }

    async function subVip(d, c) {
        if(me.sdmBalance < c) return Swal.fire('Ø±ØµÙŠØ¯Ùƒ Ù„Ø§ ÙŠÙƒÙÙŠ','','error');
        await db.ref('game_orders').push({ uP: me.p, uN: me.n, gameType: 'VIP_SUB', playerId: me.p, package: d, cost: c, status: 'pending', date: Date.now() });
        Swal.fire('ØªÙ… Ø§Ù„Ø·Ù„Ø¨','','success');
    }

    async function checkVipExpiry() { } 

    function publish(path) {
        if(isGuest) return checkGuestAccess('publish');
        const isVip = path === 'vip_posts';
        const t = (isVip ? document.getElementById('v-t') : document.getElementById('pt')).value;
        const pr = (isVip ? document.getElementById('v-pr') : document.getElementById('pp')).value;
        const oldPr = (isVip ? document.getElementById('v-old-pr').value : null);
        const d = (isVip ? document.getElementById('v-d') : document.getElementById('pd')).value;
        const wa = (isVip ? document.getElementById('v-wa') : document.getElementById('p-whatsapp')).value;
        if(!t || !pr || !tempImg) return Swal.fire('Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©','','warning');
        const data = { t, pr, oldPr, d, wa, img: tempImg, uP: me.p, uN: me.n, uPic: me.pic || 'https://via.placeholder.com/150', uStars: me.rating || 0, date: Date.now(), status: 'active' };
        if(isVip) data.vExpiry = me.vipExpiry; else data.sub = curS;
        db.ref(path).push(data);
        Swal.fire('ØªÙ… Ø§Ù„Ù†Ø´Ø±','','success'); tempImg='';
        isVip ? nav('home') : render('feed', curS);
    }

    function loadVipHome() {
        const s = document.getElementById('vip-slider'); if(!s) return;
        s.innerHTML = `<h4 style="margin:15px; color:var(--navy);">ğŸ’ VIP</h4><div id="vip-slider-inner" style="display:flex; overflow-x:auto; padding:10px;"></div>`;
        loadPosts('vip_posts', null);
    }

    function renderProfile(area, uid) {
        db.ref('users/'+uid).once('value', snap => {
            const u = snap.val(); if (!u) return;
            const isMe = (me && uid === me.p);
            const r = u.rating || 0;
            area.innerHTML = `
                <div style="text-align:center; padding:30px;">
                    <img src="${u.pic || 'https://via.placeholder.com/150'}" id="profile-img-view" style="width:120px; height:120px; border-radius:50%; border:4px solid var(--blue); object-fit:cover;">
                    ${isMe ? '<br><label style="color:blue">ØªØºÙŠÙŠØ± Ø§Ù„ØµÙˆØ±Ø© <input type="file" onchange="encode(this, \'user\')" style="display:none"></label>' : ''}
                    <h2>${escapeHtml(u.n)}</h2><p style="color:var(--gold);">â­ ${r.toFixed(1)}</p>
                    ${r>=50?'<span class="badge-good">ØªØ§Ø¬Ø± Ù…ÙˆØ«ÙˆÙ‚</span>':''}
                    ${isMe ? `<div style="background:#fff; padding:10px; margin:10px;">ÙƒÙˆØ¯: <b>${u.p}</b> <button onclick="navigator.clipboard.writeText('${u.p}')">Ù†Ø³Ø®</button></div>` : ''}
                    ${!isMe && !isGuest ? `<button class="btn-main" style="background:var(--gold); color:black; width:auto;" onclick="rateUser('${uid}')">â­ ØªÙ‚ÙŠÙŠÙ…</button> <button class="btn-main" style="background:var(--red); width:auto;" onclick="reportUser('${uid}')">ğŸš© Ø¥Ø¨Ù„Ø§Øº</button>` : ''}
                    ${isMe ? `<div style="background:#fff; padding:20px; margin-top:20px;"><h3>${u.sdmBalance} SDM</h3></div> <button class="btn-main" style="background:var(--red);" onclick="doLogout()">Ø®Ø±ÙˆØ¬</button>` : ''}
                </div>`;
        });
    }

    // --- ØªØ¹Ø¯ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (ÙŠØ±Ø³Ù„ Ù„Ù„Ø·Ø§Ø¨ÙˆØ±) ---
    async function rateUser(uid) {
        if(isGuest) return checkGuestAccess('profile');
        if(uid === me.p) return Swal.fire('Ø®Ø·Ø£', 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ‚ÙŠÙŠÙ… Ù†ÙØ³Ùƒ', 'error');
        const { value: stars } = await Swal.fire({ title: 'ØªÙ‚ÙŠÙŠÙ…', input: 'select', inputOptions: { '1':'â­','2':'â­â­','3':'â­â­â­','4':'â­â­â­â­','5':'â­â­â­â­â­' }, showCancelButton: true });
        if(stars) {
            await db.ref('rating_queue').push({ rater: me.p, target: uid, stars: Number(stars) });
            Swal.fire('ØªÙ…', 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚ÙŠÙŠÙ…Ùƒ Ù„Ù„Ø§Ø¹ØªÙ…Ø§Ø¯', 'success');
        }
    }

    function updateCoinImg(input) {
        if (me.role !== 'admin') return;
        if(!input.files[0]) return;
        encode(input, 'coin-setting').then(() => setTimeout(() => { if(tempImg) { db.ref('settings/coinImg').set(tempImg); Swal.fire('ØªÙ…','','success'); }}, 500));
    }

    function requestCoins() {
        const qty = document.getElementById('buy-qty').value;
        if(!qty || !tempBuyImg) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØµÙˆØ±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù…Ø·Ù„ÙˆØ¨Ø§Ù†','warning');
        db.ref('coin_requests').push({ uP: me.p, uN: me.n, qty, img: tempBuyImg, status: 'pending', date: Date.now() });
        Swal.fire('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„','','success');
    }
</script>
</body>
</html>

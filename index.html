<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø®Ø§Ø±Ù‚ | Ù†Ø¸Ø§Ù… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©</title>
    
    <!-- Ø®Ø·ÙˆØ· Ø¹Ø±Ø¨ÙŠØ© -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- TensorFlow.js Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ù…Ø­Ù„ÙŠ -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    
    <!-- Tesseract.js Ù„Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù†ØµÙˆØµ Ù…Ù† Ø§Ù„ØµÙˆØ± -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.0/dist/tesseract.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <style>
        :root {
            --bg-dark: #0a0a1a;
            --bg-darker: #050510;
            --bg-card: #151530;
            --primary: #00f5ff;
            --primary-dark: #00b4d8;
            --accent: #ff006e;
            --accent-light: #ff4da6;
            --neon-blue: #00f5ff;
            --neon-purple: #9d4edd;
            --neon-green: #00ff9d;
            --neon-yellow: #ffd166;
            --neon-red: #ff4757;
            --text-main: #ffffff;
            --text-secondary: #b8b8d1;
            --text-dim: #8a8aa3;
            --gradient-ai: linear-gradient(135deg, #00f5ff 0%, #9d4edd 50%, #ff006e 100%);
            --gradient-dark: linear-gradient(180deg, #0a0a1a 0%, #050510 100%);
            --gradient-card: linear-gradient(145deg, #151530 0%, #101025 100%);
            --shadow-glow: 0 0 30px rgba(0, 245, 255, 0.3);
            --shadow-heavy: 0 10px 40px rgba(0, 0, 0, 0.5);
            --shadow-accent: 0 0 25px rgba(255, 0, 110, 0.4);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }

        body {
            background: var(--gradient-dark);
            color: var(--text-main);
            min-height: 100vh;
            direction: rtl;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(0, 245, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(157, 78, 221, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(255, 0, 110, 0.05) 0%, transparent 50%);
            z-index: -1;
        }

        .hidden {
            display: none !important;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--gradient-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-content {
            text-align: center;
        }

        .ai-loader {
            width: 80px;
            height: 80px;
            border: 4px solid transparent;
            border-top: 4px solid var(--neon-blue);
            border-right: 4px solid var(--neon-purple);
            border-bottom: 4px solid var(--accent);
            border-left: 4px solid var(--neon-green);
            border-radius: 50%;
            animation: spin 1.5s linear infinite;
            margin: 0 auto 30px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        #login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .login-container {
            width: 100%;
            max-width: 500px;
            background: var(--gradient-card);
            border-radius: 30px;
            padding: 50px 40px;
            border: 3px solid rgba(0, 245, 255, 0.15);
            box-shadow: var(--shadow-glow), var(--shadow-heavy);
            position: relative;
            z-index: 1;
            backdrop-filter: blur(10px);
        }

        /* Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© */
        #app-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
        header {
            background: rgba(10, 10, 25, 0.95);
            backdrop-filter: blur(20px);
            padding: 20px 30px;
            border-bottom: 2px solid rgba(0, 245, 255, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ */
        .sidebar {
            width: 280px;
            background: var(--gradient-card);
            border-left: 2px solid rgba(0, 245, 255, 0.15);
            padding: 20px;
            overflow-y: auto;
            height: calc(100vh - 90px);
            position: sticky;
            top: 90px;
        }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */
        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            max-height: calc(100vh - 90px);
        }

        /* Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            background: rgba(10, 10, 25, 0.7);
            border: 2px solid rgba(0, 245, 255, 0.3);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--neon-blue);
            box-shadow: 0 0 15px rgba(0, 245, 255, 0.4);
        }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--gradient-ai);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .btn-secondary {
            background: rgba(0, 245, 255, 0.1);
            color: var(--neon-blue);
            border: 2px solid var(--neon-blue);
        }

        .btn-secondary:hover {
            background: rgba(0, 245, 255, 0.2);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: rgba(255, 0, 110, 0.1);
            color: var(--accent);
            border: 2px solid var(--accent);
        }

        .btn-danger:hover {
            background: rgba(255, 0, 110, 0.2);
            transform: translateY(-2px);
        }

        /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª */
        .quiz-card {
            background: var(--gradient-card);
            border-radius: 20px;
            padding: 20px;
            margin: 15px 0;
            border: 2px solid rgba(0, 245, 255, 0.2);
            transition: transform 0.3s;
            cursor: pointer;
        }

        .quiz-card:hover {
            transform: translateY(-5px);
            border-color: var(--neon-blue);
            box-shadow: var(--shadow-glow);
        }

        /* Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± */
        .quiz-modal {
            background: var(--gradient-card);
            border-radius: 20px;
            padding: 30px;
            max-width: 700px;
            margin: 50px auto;
            border: 3px solid rgba(0, 245, 255, 0.3);
        }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø¬Ø³ÙŠÙ…Ø§Øª */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -2;
        }

        .particle {
            position: absolute;
            background: var(--neon-blue);
            border-radius: 50%;
            animation: floatParticle 15s infinite linear;
        }

        @keyframes floatParticle {
            0% {
                transform: translateY(100vh) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(100px) rotate(360deg);
                opacity: 0;
            }
        }

        /* Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„ØªÙ‚Ø¯Ù… */
        .progress-area {
            margin: 20px 0;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-ai);
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        /* Ø´Ø¬Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª */
        .skill-tree {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 20px 0;
        }

        .skill-node {
            background: rgba(0, 245, 255, 0.1);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid rgba(0, 245, 255, 0.3);
            position: relative;
        }

        .skill-node.unlocked {
            border-color: var(--neon-green);
            background: rgba(0, 255, 157, 0.1);
        }

        /* Ø±ØªØ¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… */
        .user-rank {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(157, 78, 221, 0.1);
            padding: 10px 20px;
            border-radius: 25px;
            border: 2px solid rgba(157, 78, 221, 0.3);
        }

        /* Ø£Ù‚Ø³Ø§Ù… Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
        .dashboard-section {
            background: var(--gradient-card);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid rgba(0, 245, 255, 0.15);
        }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø±ÙƒØ© */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .action-btn {
            background: rgba(0, 245, 255, 0.1);
            border: 2px solid rgba(0, 245, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: rgba(0, 245, 255, 0.2);
            border-color: var(--neon-blue);
            transform: translateY(-5px);
            box-shadow: var(--shadow-glow);
        }

        /* Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØªØ¨ÙˆÙŠØ¨ */
        .tab-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 12px 24px;
            background: rgba(0, 245, 255, 0.1);
            border: none;
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: var(--gradient-ai);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù†Øµ */
        .text-area {
            min-height: 200px;
            max-height: 400px;
            resize: vertical;
            font-size: 16px;
            line-height: 1.6;
        }

        /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² */
        .achievement-card {
            background: linear-gradient(135deg, rgba(255,215,102,0.1), rgba(255,215,102,0.05));
            border: 2px solid rgba(255,215,102,0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 10px;
            text-align: center;
            transition: transform 0.3s;
        }

        .achievement-card:hover {
            transform: scale(1.05);
        }

        /* Ø³Ø¤Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± */
        .question-item {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid rgba(0, 245, 255, 0.1);
            transition: all 0.3s;
        }

        .question-text {
            font-size: 18px;
            margin-bottom: 15px;
            color: white;
            font-weight: 500;
        }

        .option-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 12px 15px;
            margin: 8px 0;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .option-item:hover {
            background: rgba(0, 245, 255, 0.1);
            border-color: var(--neon-blue);
        }

        .option-item.selected {
            background: rgba(0, 245, 255, 0.2);
            border-color: var(--neon-blue);
            box-shadow: 0 0 10px rgba(0, 245, 255, 0.3);
        }

        .option-item.correct {
            background: rgba(0, 255, 157, 0.2);
            border-color: var(--neon-green);
            box-shadow: 0 0 10px rgba(0, 255, 157, 0.3);
        }

        .option-item.wrong {
            background: rgba(255, 0, 110, 0.2);
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(255, 0, 110, 0.3);
        }

        /* Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø© */
        .image-preview-container {
            border: 2px dashed rgba(0, 245, 255, 0.3);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            transition: all 0.3s;
            cursor: pointer;
        }

        .image-preview-container:hover {
            border-color: var(--neon-blue);
            background: rgba(0, 245, 255, 0.05);
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            margin-top: 15px;
            display: none;
        }

        /* Ø¥Ø´Ø¹Ø§Ø±Ø§Øª */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--gradient-card);
            border-radius: 15px;
            padding: 15px 25px;
            border-left: 5px solid var(--neon-blue);
            box-shadow: var(--shadow-heavy);
            z-index: 3000;
            animation: slideInRight 0.3s ease;
            max-width: 400px;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.error {
            border-left-color: var(--accent);
        }

        .notification.success {
            border-left-color: var(--neon-green);
        }

        .notification.warning {
            border-left-color: var(--neon-yellow);
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .main-content {
                flex-direction: column;
            }
            
            .content-area {
                padding: 20px;
            }
            
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .login-container {
                padding: 30px 20px;
                margin: 20px;
            }
            
            .action-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
        @media (min-width: 1200px) {
            .main-content {
                display: flex;
                gap: 20px;
                max-width: 1400px;
                margin: 0 auto;
                width: 100%;
            }
        }

        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…ØªÙˆÙ‡Ø¬Ø© */
        .glow-text {
            text-shadow: 0 0 10px currentColor;
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 10px currentColor; }
            to { text-shadow: 0 0 20px currentColor; }
        }

        /* ØªØ­Ù…ÙŠÙ„ */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--neon-blue);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        /* Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
        .result-card {
            background: var(--gradient-card);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            border: 2px solid var(--neon-green);
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: var(--gradient-ai);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            font-weight: bold;
            margin: 0 auto;
            box-shadow: 0 0 30px rgba(0, 245, 255, 0.4);
        }

        /* ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª */
        .answer-feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
        }

        .correct-answer {
            background: rgba(0, 255, 157, 0.1);
            border: 1px solid var(--neon-green);
            color: var(--neon-green);
        }

        .wrong-answer {
            background: rgba(255, 0, 110, 0.1);
            border: 1px solid var(--accent);
            color: var(--accent-light);
        }

        .explanation {
            background: rgba(0, 245, 255, 0.1);
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            margin-top: 5px;
            padding: 8px;
            border-radius: 6px;
            font-size: 13px;
        }

        /* Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØµØ­ÙŠØ­ ÙˆØ§Ù„Ø®Ø·Ø£ */
        .answer-status {
            display: inline-block;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-left: 10px;
            text-align: center;
            line-height: 24px;
            font-weight: bold;
        }

        .answer-status.correct {
            background: var(--neon-green);
            color: white;
        }

        .answer-status.wrong {
            background: var(--accent);
            color: white;
        }

        /* Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ‚Ø¯Ù… */
        .progress-counter {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }

        .counter-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--text-secondary);
        }

        .counter-item.active {
            color: var(--neon-blue);
        }

        /* Ù…Ù†Ø·Ù‚Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ */
        .text-analysis {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid rgba(0, 245, 255, 0.2);
        }

        .analysis-result {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .analysis-item {
            text-align: center;
            padding: 10px;
            background: rgba(0, 245, 255, 0.05);
            border-radius: 10px;
        }

        .analysis-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--neon-blue);
        }

        .analysis-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* ÙƒÙ„Ù…Ø© Ø®Ù„Ø·Ø© */
        .chaos-warning {
            background: rgba(255, 0, 110, 0.1);
            border: 2px solid var(--accent);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
            color: var(--accent-light);
        }

        /* Ø§Ù„ØªØ°ÙŠÙŠÙ„ */
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-dim);
            font-size: 12px;
            margin-top: 40px;
            border-top: 1px solid rgba(0, 245, 255, 0.1);
        }
    </style>
</head>
<body>
    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div id="loading-screen">
        <div class="loading-content">
            <div class="ai-loader"></div>
            <div style="color: var(--neon-blue); font-size: 24px; font-weight: 700; margin: 20px 0;">
                Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø®Ø§Ø±Ù‚
            </div>
            <div class="progress-bar" style="width: 300px; margin: 20px auto;">
                <div class="progress-fill" id="loading-progress" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="login-screen" class="hidden">
        <div class="login-container">
            <div style="text-align: center; margin-bottom: 40px;">
                <i class="fas fa-brain" style="font-size: 80px; background: var(--gradient-ai); -webkit-background-clip: text; -webkit-text-fill-color: transparent;"></i>
                <h1 style="font-size: 42px; background: var(--gradient-ai); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 20px 0;">Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø®Ø§Ø±Ù‚</h1>
                <p style="color: var(--text-secondary); font-size: 18px;">Ù†Ø¸Ø§Ù… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ±</p>
            </div>
            
            <div class="form-group">
                <input type="email" id="login-email" class="form-control" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            </div>
            
            <div class="form-group">
                <input type="password" id="login-password" class="form-control" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            </div>
            
            <button class="btn btn-primary" onclick="login()" style="width: 100%; margin: 20px 0; padding: 15px;">
                <i class="fas fa-sign-in-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
            </button>
            
            <button class="btn btn-secondary" onclick="showRegister()" style="width: 100%; padding: 15px;">
                <i class="fas fa-user-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
            </button>
            
            <div style="text-align: center; margin-top: 30px; color: var(--text-dim);">
                <p>Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø°ÙƒÙŠØ©</p>
            </div>
        </div>
    </div>

    <!-- Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="app-screen" class="hidden">
        <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± -->
        <!-- Ø§Ø³ØªØ¨Ø¯Ù„ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù€ header Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ù‡Ø°Ø§ -->
<header>
    <div class="header-content">
        <div style="display: flex; align-items: center; gap: 15px;">
            <!-- Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ø¶ÙŠÙ Ù‡Ù†Ø§ -->
            <button id="back-button" class="btn btn-secondary hidden" onclick="goBack()" style="padding: 10px 15px; border-radius: 50%; width: 45px; height: 45px; justify-content: center;">
                <i class="fas fa-arrow-right"></i>
            </button>

            <div style="width: 50px; height: 50px; background: var(--gradient-ai); border-radius: 15px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-brain" style="color: white; font-size: 24px;"></i>
            </div>
            <div>
                <h2 style="background: var(--gradient-ai); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;">Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø®Ø§Ø±Ù‚</h2>
                <p style="color: var(--text-secondary); font-size: 12px; margin: 0;">Ù†Ø¸Ø§Ù… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠ</p>
            </div>
        </div>
        <!-- Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ Ø§Ù„Ù‡ÙŠØ¯Ø± (Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…) ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ -->

        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <div class="main-content">
            <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ -->
            <div class="sidebar" id="sidebar">
                <h3 style="color: var(--neon-blue); margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid rgba(0,245,255,0.2);">
                    <i class="fas fa-th-large"></i> Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </h3>
                
                <div class="action-btn" onclick="navigateTo('dashboard')">
                    <i class="fas fa-home" style="color: var(--neon-blue);"></i>
                    <div>
                        <div style="font-weight: bold; color: white;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
                        <div style="color: var(--text-secondary); font-size: 12px;">Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…</div>
                    </div>
                </div>
                
                <div class="action-btn" onclick="navigateTo('generator')"

                    <i class="fas fa-file-alt" style="color: var(--neon-green);"></i>
                    <div>
                        <div style="font-weight: bold; color: white;">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±</div>
                        <div style="color: var(--text-secondary); font-size: 12px;">ØªÙˆÙ„ÙŠØ¯ Ø§Ø®ØªØ¨Ø§Ø± Ø°ÙƒÙŠ Ø¬Ø¯ÙŠØ¯</div>
                    </div>
                </div>
                
                <div class="action-btn" onclick="navigateTo('history')"
                    <i class="fas fa-history" style="color: var(--neon-purple);"></i>
                    <div>
                        <div style="font-weight: bold; color: white;">Ø³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</div>
                        <div style="color: var(--text-secondary); font-size: 12px;">Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
                    </div>
                </div>
                
                <div class="action-btn" navigateTo('library')
                    <i class="fas fa-book" style="color: var(--neon-yellow);"></i>
                    <div>
                        <div style="font-weight: bold; color: white;">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</div>
                        <div style="color: var(--text-secondary); font-size: 12px;">Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¬Ø§Ù‡Ø²Ø©</div>
                    </div>
                </div>
                
                <div class="action-btn" navigateTo('progress')
                    <i class="fas fa-chart-line" style="color: var(--neon-blue);"></i>
                    <div>
                        <div style="font-weight: bold; color: white;">Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</div>
                        <div style="color: var(--text-secondary); font-size: 12px;">ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ£Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
                    </div>
                </div>
                
                <div class="action-btn" navigateTo('settings')
                    <i class="fas fa-cog" style="color: var(--text-secondary);"></i>
                    <div>
                        <div style="font-weight: bold; color: white;">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</div>
                        <div style="color: var(--text-secondary); font-size: 12px;">ØªØ®ØµÙŠØµ Ø§Ù„Ù†Ø¸Ø§Ù…</div>
                    </div>
                </div>
                
                <div style="margin-top: 40px;">
                    <h4 style="color: var(--neon-blue); margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(0,245,255,0.2);">
                        <i class="fas fa-brain"></i> Ø­Ø§Ù„Ø© Ø§Ù„Ø°ÙƒØ§Ø¡
                    </h4>
                    <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--text-secondary);">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø°ÙƒØ§Ø¡:</span>
                            <span id="ai-intelligence" style="color: var(--neon-green); font-weight: bold;">IQ: 180</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--text-secondary);">Ø§Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…Ø®Ø²Ù†Ø©:</span>
                            <span id="ai-knowledge" style="color: var(--neon-purple); font-weight: bold;">1.2TB</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Ù‚ÙˆØ© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©:</span>
                            <span id="ai-power" style="color: var(--neon-blue); font-weight: bold;">âˆ</span>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(0,245,255,0.2);">
                    <div style="text-align: center; color: var(--text-dim); font-size: 12px;">
                        <p>Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø®Ø§Ø±Ù‚ v2.0</p>
                        <p>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2024</p>
                    </div>
                </div>
            </div>

            <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
            <div class="content-area" id="content-area">
                <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>
        </div>
    </div>

    <!-- ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„Ø¬Ø³ÙŠÙ…Ø§Øª -->
    <div class="particles" id="particles"></div>

    <script>
        // =============== [ Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø®Ø§Ø±Ù‚ ] ===============
        const firebaseConfig = {
            apiKey: "AIzaSyAI_mUhuPNoO-XC0Q-VNoWft8UWFbAbIGg",
            authDomain: "sudan-market-6b122.firebaseapp.com",
            databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com",
            projectId: "sudan-market-6b122",
            storageBucket: "sudan-market-6b122.firebasestorage.app",
            messagingSenderId: "66729481566",
            appId: "1:66729481566:web:93393f28dc22d32cceebcf"
        };

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        let auth, db, storage, currentUser = null;
        let userData = {};
        let currentTest = null;
        let currentAnswers = [];
        let testSystem = null;
        let chaosCount = 0;
        let lastChaosTime = 0;
        const CHAOS_LIMIT = 3;
        const CHAOS_RESET_TIME = 60000; // 60 Ø«Ø§Ù†ÙŠØ©

        // =============== [ 1. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ] ===============
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø®Ø§Ø±Ù‚...');
            
            // ØªÙ‡ÙŠØ¦Ø© Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
            simulateLoading();
            
            // ØªÙ‡ÙŠØ¦Ø© Firebase
            await initializeFirebase();
            
            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            initializeUI();
            
            // ÙØ­Øµ Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            checkUserSession();
            
            console.log('âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„!');
        });

        async function simulateLoading() {
            const progressBar = document.getElementById('loading-progress');
            let progress = 0;
            
            const steps = [
                {text: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...', progress: 20},
                {text: 'Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©...', progress: 40},
                {text: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªØ¹Ù„Ù… Ø§Ù„Ø¢Ù„ÙŠ...', progress: 60},
                {text: 'Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ù†Ø¸Ø§Ù… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...', progress: 80},
                {text: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…...', progress: 100}
            ];
            
            for (let i = 0; i < steps.length; i++) {
                await new Promise(resolve => setTimeout(resolve, 400));
                progress = steps[i].progress;
                progressBar.style.width = `${progress}%`;
            }
            
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
                checkUserSession();
            }, 500);
        }

        async function initializeFirebase() {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                auth = firebase.auth();
                db = firebase.database();
                storage = firebase.storage();
                
                // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        await loadUserData();
                        showAppScreen();
                    } else {
                        showLoginScreen();
                    }
                });
                
                console.log('âœ… Firebase Ù…Ù‡ÙŠØ£');
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:', error);
                // ÙˆØ¶Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ Ø¨Ø¯ÙˆÙ† Firebase
                console.log('âš ï¸ Ø§Ù„Ø¹Ù…Ù„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ');
                showAppScreen();
            }
        }

        function initializeUI() {
    createParticles();
    setupKeyboardShortcuts();
    testSystem = new TestSystem();
    
    // Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ù‡Ùˆ Ø§Ù„Ø°ÙŠ ÙŠØªØ°ÙƒØ± Ù…ÙƒØ§Ù†Ùƒ Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
    const lastPage = localStorage.getItem('last_active_page') || 'dashboard';
    navigateTo(lastPage, false);
}

        // =============== [ 2. Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ] ===============
        async function loadUserData() {
            if (!currentUser) return;
            
            try {
                const snapshot = await db.ref(`users/${currentUser.uid}`).once('value');
                userData = snapshot.val() || {};
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯Ø§Ù‹ØŒ Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                if (!userData.createdAt) {
                    userData = {
                        email: currentUser.email,
                        name: currentUser.email.split('@')[0],
                        createdAt: new Date().toISOString(),
                        lastLogin: new Date().toISOString(),
                        stats: {
                            testsTaken: 0,
                            testsCreated: 0,
                            averageScore: 0,
                            totalXP: 0,
                            level: 1,
                            streak: 1,
                            bestScore: 0
                        },
                        preferences: {
                            theme: 'dark',
                            language: 'ar',
                            notifications: true
                        },
                        tests: [],
                        achievements: []
                    };
                    
                    await saveUserData();
                }
                
                // ØªØ­Ø¯ÙŠØ« Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„
                userData.lastLogin = new Date().toISOString();
                await saveUserData();
                
                // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                updateUserUI();
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
                // Ø¨ÙŠØ§Ù†Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ
                userData = {
                    email: 'demo@example.com',
                    name: 'Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ',
                    stats: {
                        testsTaken: 0,
                        testsCreated: 0,
                        averageScore: 0,
                        totalXP: 0,
                        level: 1,
                        streak: 1,
                        bestScore: 0
                    }
                };
                updateUserUI();
            }
        }

        async function saveUserData() {
            if (!currentUser || !userData) return;
            
            try {
                await db.ref(`users/${currentUser.uid}`).set(userData);
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
            }
        }

        function updateUserUI() {
    // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const nameElem = document.getElementById('user-name');
    if (nameElem) nameElem.textContent = userData.name || 'Ù…Ø³ØªØ®Ø¯Ù…';

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± (ÙÙˆÙ‚)
    const levelElem = document.getElementById('user-level');
    if (levelElem) levelElem.textContent = `Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${userData.stats?.level || 1}`;

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ IQ ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
    const iqElem = document.getElementById('ai-intelligence');
    if (iqElem) {
        const currentLevel = userData.stats?.level || 1;
        const iq = 180 + (currentLevel * 5); 
        iqElem.textContent = `IQ: ${iq}`;
    }
}

        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error');
                return;
            }
            
            showLoading('Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...');
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showNotification('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø®Ø§Ø±Ù‚!', 'success');
                
                localStorage.setItem('ai_system_email', email);
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
                
                // ÙˆØ¶Ø¹ ØªØ¬Ø±ÙŠØ¨ÙŠ
                if (error.code === 'auth/network-request-failed') {
                    showNotification('âœ… ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ', 'success');
                    currentUser = { email: email, uid: 'demo_' + Date.now() };
                    await loadUserData();
                    showAppScreen();
                } else {
                    let message = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
                    
                    switch(error.code) {
                        case 'auth/user-not-found':
                            message = 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';
                            break;
                        case 'auth/wrong-password':
                            message = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©';
                            break;
                        case 'auth/invalid-email':
                            message = 'Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­';
                            break;
                    }
                    
                    showNotification(message, 'error');
                }
            }
            
            hideLoading();
        }

        async function logout() {
            try {
                await auth.signOut();
                showNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                showLoginScreen();
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬:', error);
                currentUser = null;
                userData = {};
                showLoginScreen();
            }
        }

        function showRegister() {
            Swal.fire({
                title: 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯',
                html: `
                    <input type="text" id="register-name" class="swal2-input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" dir="rtl">
                    <input type="email" id="register-email" class="swal2-input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" dir="rtl">
                    <input type="password" id="register-password" class="swal2-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" dir="rtl">
                    <input type="password" id="register-confirm" class="swal2-input" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" dir="rtl">
                `,
                confirmButtonText: 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                showCancelButton: true,
                focusConfirm: false,
                preConfirm: async () => {
                    const name = document.getElementById('register-name').value;
                    const email = document.getElementById('register-email').value;
                    const password = document.getElementById('register-password').value;
                    const confirm = document.getElementById('register-confirm').value;
                    
                    if (!name || !email || !password || !confirm) {
                        Swal.showValidationMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
                        return false;
                    }
                    
                    if (password !== confirm) {
                        Swal.showValidationMessage('ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†');
                        return false;
                    }
                    
                    if (password.length < 6) {
                        Swal.showValidationMessage('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                        return false;
                    }
                    
                    showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...');
                    
                    try {
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        const user = userCredential.user;
                        
                        await db.ref(`users/${user.uid}`).set({
                            email: email,
                            name: name,
                            createdAt: new Date().toISOString(),
                            lastLogin: new Date().toISOString(),
                            stats: {
                                testsTaken: 0,
                                testsCreated: 0,
                                averageScore: 0,
                                totalXP: 0,
                                level: 1,
                                streak: 1,
                                bestScore: 0
                            },
                            preferences: {
                                theme: 'dark',
                                language: 'ar',
                                notifications: true
                            },
                            tests: [],
                            achievements: []
                        });
                        
                        hideLoading();
                        return user;
                        
                    } catch (error) {
                        hideLoading();
                        Swal.showValidationMessage(error.message);
                        return false;
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                }
            });
        }

        // =============== [ 3. Ù†Ø¸Ø§Ù… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠ ] ===============
        // =============== [ ØªØ­Ø¯ÙŠØ« Ù†Ø¸Ø§Ù… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ] ===============
       // =============== [ 3. Ù†Ø¸Ø§Ù… ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ù…Ø·ÙˆØ± ] ===============
class TestSystem {
    constructor() {
        this.tests = new Map();
        this.usedSentences = new Set();
        this.usedKeywords = new Set(); // Ø°Ø§ÙƒØ±Ø© Ù„Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
    }

    async generateTestFromText(text, options = {}) {
        this.usedSentences.clear();
        this.usedKeywords.clear(); // ØªØµÙÙŠØ± Ø°Ø§ÙƒØ±Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¹Ù†Ø¯ ÙƒÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯
        
        const analysis = await this.analyzeText(text);
        
        if (analysis.sentences.length < 3) {
            throw new Error("Ø§Ù„Ù†Øµ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ ÙˆÙ„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…Ù„ ÙƒØ§Ù…Ù„Ø© ÙƒØ§ÙÙŠØ©.");
        }

        const questions = this.generateHighQualityQuestions(analysis, options);

        const test = {
            id: 'test_' + Date.now(),
            title: options.title || analysis.topics[0]?.name || "Ø§Ø®ØªØ¨Ø§Ø± Ø°ÙƒÙŠ",
            questions: questions,
            analysis: analysis,
            settings: {
                difficulty: options.difficulty || 'medium',
                passingScore: 70,
                timeLimit: Math.max(5, Math.ceil(questions.length * 1.5)),
                generatedAt: new Date().toISOString()
            }
        };

        this.tests.set(test.id, test);
        await this.updateUserStats(test); // ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø£Ùˆ Ø§Ø­Ø°Ù Ø§Ù„Ø³Ø·Ø±
        return test;
    }

    async analyzeText(text) {
        let cleanText = text.replace(/\s+/g, ' ').trim();
        // ØªÙ‚Ø³ÙŠÙ… Ø£Ø°ÙƒÙ‰ Ù„Ù„Ø¬Ù…Ù„ (ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø¦ÙˆÙŠØ©)
        const rawSentences = cleanText.match(/[^.ØŸ!]+[.ØŸ!]+/g) || [cleanText];
        
        const sentences = rawSentences
            .map(s => s.trim())
            .filter(s => s.length > 25 && !s.includes('http')); // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø¬Ù…Ù„ Ø§Ù„Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹

        const keywords = this.extractKeywords(cleanText);

        return {
            fullText: cleanText,
            sentences: sentences,
            keywords: keywords,
            topics: this.identifyTopics(cleanText, keywords)
        };
    }

    extractKeywords(text) {
        // Ù‚Ø§Ø¦Ù…Ø© ÙƒÙ„Ù…Ø§Øª Ù…Ø³ØªØ¨Ø¹Ø¯Ø© Ù…ÙˆØ³Ø¹Ø© Ø¬Ø¯Ø§Ù‹ Ù„Ø¶Ù…Ø§Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
        const stopWords = [
            'Ù…Ù†', 'ÙÙŠ', 'Ø¹Ù„Ù‰', 'Ø¥Ù„Ù‰', 'Ø£Ù†', 'ÙƒØ§Ù†', 'Ù‡Ø°Ø§', 'Ù‡Ø°Ù‡', 'ØªÙ…', 'Ø¹Ù†', 'Ù…Ø¹', 'Ø¨ÙŠÙ†', 
            'Ø°Ù„Ùƒ', 'Ø§Ù„ØªÙŠ', 'Ø§Ù„Ø°ÙŠ', 'ÙˆÙ‡Ùˆ', 'ÙˆÙ‡ÙŠ', 'ÙØ¥Ù†', 'Ø­ÙŠØ«', 'Ù†Ø­Ùˆ', 'Ù„Ø¯Ù‰', 'Ø¹Ù†Ø¯', 'Ù„ÙƒÙ†',
            'ÙƒÙ…Ø§', 'Ø£ÙŠØ¶Ø§', 'Ø®Ù„Ø§Ù„', 'Ø¶Ù…Ù†', 'ØªØ­Øª', 'ÙÙˆÙ‚', 'Ù…Ù†Ø°', 'Ø¨Ø¹Ø¯', 'Ù‚Ø¨Ù„', 'ÙƒÙ„', 'Ø¨Ø¹Ø¶',
            'Ø¨Ø´ÙƒÙ„', 'ØµÙˆØ±Ø©', 'Ø¹Ø¨Ø§Ø±Ø©', 'ØªÙƒÙˆÙ†', 'ÙŠÙƒÙˆÙ†', 'ÙŠÙ…ÙƒÙ†', 'ÙŠØ¬Ø¨', 'Ø£Ø¬Ù„', 'ØºÙŠØ±', 'Ø¬Ø¯Ø§',
            'Ø£ÙƒØ«Ø±', 'Ø£Ù‚Ù„', 'Ø­ÙˆÙ„', 'Ø¬Ù…ÙŠØ¹', 'Ù†ÙØ³', 'Ù…Ø«Ù„', 'Ù„Ø£Ù†', 'Ø¨Ø³Ø¨Ø¨', 'Ø¹Ù†Ø¯Ù…Ø§', 'Ø­ØªÙ‰',
            'ÙƒÙˆÙƒØ¨', 'Ø§Ù„ÙƒÙˆØ§ÙƒØ¨', 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©', 'Ù†Ø¸Ø§Ù…', 'Ø¹Ù…Ù„ÙŠØ©', 'ØªØ³Ù…Ù‰', 'ÙŠØ³Ù…Ù‰' // ÙƒÙ„Ù…Ø§Øª Ø¹Ø§Ù…Ø© Ø¬Ø¯Ø§Ù‹ Ù†Ø±ÙŠØ¯ ØªØ¬Ù†Ø¨Ù‡Ø§
        ];
        
        const words = text.split(/\s+/);
        const freq = {};
        
        words.forEach(w => {
            // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒÙ„Ù…Ø©
            let word = w.replace(/[^\u0621-\u064A]/g, ''); 
            // Ø´Ø±Ø·: Ø§Ù„ÙƒÙ„Ù…Ø© Ø£Ø·ÙˆÙ„ Ù…Ù† 3 Ø£Ø­Ø±Ù ÙˆÙ„ÙŠØ³Øª ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯Ø§Øª
            if (word.length > 3 && !stopWords.includes(word)) {
                freq[word] = (freq[word] || 0) + 1;
            }
        });

        // ØªØ±ØªÙŠØ¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø·ÙˆÙ„ (Ø§Ù„Ø£Ø·ÙˆÙ„ ØºØ§Ù„Ø¨Ø§Ù‹ Ø£Ù‡Ù… Ø¹Ù„Ù…ÙŠØ§Ù‹) Ø«Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±
        return Object.entries(freq)
            .sort((a, b) => b[0].length - a[0].length || b[1] - a[1]) 
            .slice(0, 40) // Ù†Ø£Ø®Ø° Ø£ÙØ¶Ù„ 40 ÙƒÙ„Ù…Ø©
            .map(e => e[0]);
    }

    identifyTopics(text, keywords) {
        return keywords.slice(0, 5).map(k => ({ name: k, confidence: 0.8 }));
    }

    generateHighQualityQuestions(analysis, options) {
        const questions = [];
        const count = options.count || 10;
        // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©ØŒ Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        const allowedTypes = options.types && options.types.length > 0 
                             ? options.types 
                             : ['multiple_choice', 'true_false'];

        // Ø®Ù„Ø· Ø§Ù„Ø¬Ù…Ù„
        const availableSentences = [...analysis.sentences].sort(() => 0.5 - Math.random());

        for (let sentence of availableSentences) {
            if (questions.length >= count) break;
            if (this.usedSentences.has(sentence)) continue;

            // Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø³Ø¤Ø§Ù„ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©
            const type = allowedTypes[Math.floor(Math.random() * allowedTypes.length)];
            let q = null;

            if (type === 'multiple_choice') {
                q = this.createSmartMCQ(sentence, analysis);
            } else if (type === 'true_false') {
                q = this.createSmartTF(sentence, analysis);
            } else if (type === 'short_answer') {
                q = this.createSmartShortAnswer(sentence, analysis);
            }

            if (q) {
                questions.push(q);
                this.usedSentences.add(sentence);
            }
        }
        return questions;
    }

    // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø£ÙØ¶Ù„ ÙƒÙ„Ù…Ø© Ù…ÙØªØ§Ø­ÙŠØ© ÙÙŠ Ø§Ù„Ø¬Ù…Ù„Ø© Ù„Ù… ØªØ³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„
    selectBestKeyword(sentence, analysis) {
        // Ù†Ø¬Ø¯ ÙƒÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù…Ù„Ø©
        const candidates = analysis.keywords.filter(k => sentence.includes(k));
        
        // Ù†Ø±ØªØ¨Ù‡Ø§: Ø§Ù„Ø£Ø·ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ (ØºØ§Ù„Ø¨Ø§Ù‹ Ù…ØµØ·Ù„Ø­Ø§Øª Ø¹Ù„Ù…ÙŠØ©)ØŒ Ø«Ù… Ù†Ø³ØªØ¨Ø¹Ø¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹
        const bestWord = candidates
            .sort((a, b) => b.length - a.length)
            .find(k => !this.usedKeywords.has(k)); // Ù†Ø®ØªØ§Ø± ÙˆØ§Ø­Ø¯Ø© Ù„Ù… ØªØ³ØªØ®Ø¯Ù…

        return bestWord;
    }

    createSmartMCQ(sentence, analysis) {
        const targetKeyword = this.selectBestKeyword(sentence, analysis);
        
        if (!targetKeyword) return null; // Ù„Ù… Ù†Ø¬Ø¯ ÙƒÙ„Ù…Ø© Ù…Ù…ÙŠØ²Ø© Ø¬Ø¯ÙŠØ¯Ø©

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙƒÙ„Ù…Ø© Ù„Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø±Ù‡Ø§
        this.usedKeywords.add(targetKeyword);

        const questionText = `Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©: "${sentence.replace(targetKeyword, '.......')}"`;

        // Ø®ÙŠØ§Ø±Ø§Øª Ø°ÙƒÙŠØ©: Ù†Ø®ØªØ§Ø± ÙƒÙ„Ù…Ø§Øª Ø£Ø®Ø±Ù‰ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù†Øµ ÙˆÙ„ÙƒÙ† Ù„ÙŠØ³Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù…Ù„Ø©
        let distractors = analysis.keywords
            .filter(k => k !== targetKeyword && !sentence.includes(k))
            .sort(() => 0.5 - Math.random())
            .slice(0, 3);

        // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø®ÙŠØ§Ø±Ø§Øª ÙƒØ§ÙÙŠØ©ØŒ Ù†Ù„ØºÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„
        if (distractors.length < 3) return null;

        const options = [targetKeyword, ...distractors];
        const shuffled = this.shuffleWithIndex(options, targetKeyword);

        return {
            type: 'multiple_choice',
            text: questionText,
            options: shuffled.items,
            correctAnswer: shuffled.correctIndex,
            explanation: `Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ù‡ÙŠ "${targetKeyword}".`,
            points: 2
        };
    }

    createSmartTF(sentence, analysis) {
        const isTrue = Math.random() > 0.5;
        let statement = sentence;
        let explanation = "Ø§Ù„Ø¹Ø¨Ø§Ø±Ø© ØµØ­ÙŠØ­Ø© ÙˆÙ…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ù†Øµ.";

        if (!isTrue) {
            const targetKeyword = this.selectBestKeyword(sentence, analysis);
            // Ù†Ø­ØªØ§Ø¬ ÙƒÙ„Ù…Ø© Ø¨Ø¯ÙŠÙ„Ø© Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù†Øµ
            const fakeKeyword = analysis.keywords.find(k => k !== targetKeyword && !sentence.includes(k));
            
            if (targetKeyword && fakeKeyword) {
                this.usedKeywords.add(targetKeyword); // Ù†Ø³Ø¬Ù„Ù‡Ø§ Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù† Ø³Ø¤Ø§Ù„ ØµØ­ ÙˆØ®Ø·Ø£
                statement = sentence.replace(targetKeyword, fakeKeyword);
                explanation = `Ø®Ø·Ø£. Ø§Ù„Ù†Øµ Ø§Ù„ØµØ­ÙŠØ­ ÙŠØ°ÙƒØ± "${targetKeyword}" ÙˆÙ„ÙŠØ³ "${fakeKeyword}".`;
            } else {
                return null;
            }
        }

        return {
            type: 'true_false',
            text: `Ø¶Ø¹ Ø¹Ù„Ø§Ù…Ø© ØµØ­ Ø£Ùˆ Ø®Ø·Ø£: "${statement}"`,
            options: ['ØµØ­ÙŠØ­', 'Ø®Ø·Ø£'],
            correctAnswer: isTrue ? 0 : 1,
            explanation: explanation,
            points: 1
        };
    }

    createSmartShortAnswer(sentence, analysis) {
        const targetKeyword = this.selectBestKeyword(sentence, analysis);
        
        if (!targetKeyword) return null;

        this.usedKeywords.add(targetKeyword);

        return {
            type: 'short_answer',
            text: `Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙÙ‡Ù…Ùƒ Ù„Ù„Ù†ØµØŒ Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¬Ù…Ù„Ø© Ø¨Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©: "${sentence.replace(targetKeyword, '.......')}"`,
            options: [],
            correctAnswer: targetKeyword,
            explanation: `Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© Ù‡ÙŠ "${targetKeyword}".`,
            points: 3
        };
    }

    shuffleWithIndex(array, correctItem) {
        const items = [...array].sort(() => Math.random() - 0.5);
        return {
            items: items,
            correctIndex: items.indexOf(correctItem)
        };
    }

    async evaluateTest(testId, answers) {
        const test = this.tests.get(testId);
        let correctCount = 0;
        let earnedPoints = 0;
        let totalPoints = 0;

        const results = test.questions.map((q, i) => {
            let isCorrect = false;
            let userAnswerRaw = answers[i];

            if (q.type === 'short_answer') {
                if (userAnswerRaw) {
                    const normalizedUser = this.normalizeText(userAnswerRaw);
                    const normalizedCorrect = this.normalizeText(q.correctAnswer);
                    isCorrect = normalizedUser.includes(normalizedCorrect) || normalizedCorrect.includes(normalizedUser);
                }
            } else {
                isCorrect = parseInt(userAnswerRaw) === q.correctAnswer;
            }

            totalPoints += q.points;
            if (isCorrect) {
                correctCount++;
                earnedPoints += q.points;
            }
            
            let displayCorrectAnswer = '';
            if (q.type === 'true_false') displayCorrectAnswer = q.options[q.correctAnswer];
            else if (q.type === 'multiple_choice') displayCorrectAnswer = q.options[q.correctAnswer];
            else displayCorrectAnswer = q.correctAnswer;

            return {
                question: q.text,
                isCorrect: isCorrect,
                correctAnswer: displayCorrectAnswer,
                userAnswer: q.type === 'short_answer' ? (userAnswerRaw || 'Ù„Ù… ØªØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©') : (userAnswerRaw !== null ? q.options[userAnswerRaw] : 'Ù„Ù… ØªØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©'),
                explanation: q.explanation,
                earnedPoints: isCorrect ? q.points : 0
            };
        });

        const percentage = totalPoints > 0 ? (earnedPoints / totalPoints) * 100 : 0;
        await this.updateUserTestStats({ testId, percentage, passed: percentage >= 70 });

        return {
            percentage: percentage.toFixed(0),
            score: earnedPoints,
            totalPoints: totalPoints,
            correctAnswers: correctCount,
            totalQuestions: test.questions.length,
            passed: percentage >= test.settings.passingScore,
            results: results
        };
    }

    normalizeText(text) {
        if (!text) return "";
        return text.toString().trim()
            .replace(/[Ø£Ø¥Ø¢]/g, 'Ø§')
            .replace(/Ø©/g, 'Ù‡')
            .replace(/Ù‰/g, 'ÙŠ')
            .replace(/[Ù‹ÙŒÙÙÙÙÙ‘Ù’]/g, '')
            .toLowerCase();
    }

    // Ø¯ÙˆØ§Ù„ ÙˆÙ‡Ù…ÙŠØ© Ù„Ù…Ù†Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ
    async updateUserStats(test) { return true; }
    async updateUserTestStats(data) { return true; }
}
        // =============== [ 4. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ] ===============
        function showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
            document.getElementById('content-area').innerHTML = '';
        }

        function showAppScreen() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            loadDashboard();
        }

        // =============== [ 5. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ] ===============
        async function loadDashboard() {
            const content = `
                <div style="max-width: 1200px; margin: 0 auto;">
                    <h1 style="color: var(--neon-blue); margin-bottom: 30px; font-size: 36px;">
                        <i class="fas fa-home"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                    </h1>
                    
                    <div class="action-grid">
                        <div class="action-btn" onclick="loadTestGenerator()">
                            <div style="text-align: center;">
                                <i class="fas fa-plus-circle" style="font-size: 48px; color: var(--neon-green); margin-bottom: 15px;"></i>
                                <h3 style="color: white; margin-bottom: 10px;">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±</h3>
                                <p style="color: var(--text-secondary); font-size: 14px;">ØªÙˆÙ„ÙŠØ¯ Ø§Ø®ØªØ¨Ø§Ø± Ø°ÙƒÙŠ Ù…Ù† Ù†Øµ</p>
                            </div>
                        </div>
                        
                        <div class="action-btn" onclick="loadTestHistory()">
                            <div style="text-align: center;">
                                <i class="fas fa-history" style="font-size: 48px; color: var(--neon-purple); margin-bottom: 15px;"></i>
                                <h3 style="color: white; margin-bottom: 10px;">Ø³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h3>
                                <p style="color: var(--text-secondary); font-size: 14px;">Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</p>
                            </div>
                        </div>
                        
                        <div class="action-btn" onclick="loadTestLibrary()">
                            <div style="text-align: center;">
                                <i class="fas fa-book" style="font-size: 48px; color: var(--neon-yellow); margin-bottom: 15px;"></i>
                                <h3 style="color: white; margin-bottom: 10px;">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h3>
                                <p style="color: var(--text-secondary); font-size: 14px;">Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</p>
                            </div>
                        </div>
                        
                        <div class="action-btn" onclick="loadProgress()">
                            <div style="text-align: center;">
                                <i class="fas fa-chart-line" style="font-size: 48px; color: var(--neon-blue); margin-bottom: 15px;"></i>
                                <h3 style="color: white; margin-bottom: 10px;">Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</h3>
                                <p style="color: var(--text-secondary); font-size: 14px;">ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ£Ø­ØµØ§Ø¦ÙŠØ§Øª</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px; margin-top: 40px;">
                        <div class="dashboard-section">
                            <h3 style="color: var(--neon-blue); margin-bottom: 20px;">
                                <i class="fas fa-bolt"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹
                            </h3>
                            
                            <div class="form-group">
                                <textarea id="quick-test-text" class="form-control text-area" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ Ù‡Ù†Ø§... Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¨ØªØ­Ù„ÙŠÙ„Ù‡ ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ù‡Ù… Ø§Ù„Ù†Ù‚Ø§Ø· Ù„ØªÙˆÙ„ÙŠØ¯ Ø£Ø³Ø¦Ù„Ø© Ø°ÙƒÙŠØ© ØªØ±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·." rows="6"></textarea>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div>
                                    <label style="color: var(--text-secondary); display: block; margin-bottom: 8px;">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</label>
                                    <input type="range" id="quick-question-count" class="form-control" min="5" max="30" value="15" oninput="document.getElementById('quick-count-display').textContent = this.value + ' Ø³Ø¤Ø§Ù„'">
                                    <div id="quick-count-display" style="color: var(--neon-blue); text-align: center; margin-top: 5px; font-weight: bold;">15 Ø³Ø¤Ø§Ù„</div>
                                </div>
                                
                                <div>
                                    <label style="color: var(--text-secondary); display: block; margin-bottom: 8px;">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©</label>
                                    <select id="quick-difficulty" class="form-control">
                                        <option value="easy">Ø³Ù‡Ù„</option>
                                        <option value="medium" selected>Ù…ØªÙˆØ³Ø·</option>
                                        <option value="hard">ØµØ¹Ø¨</option>
                                    </select>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" onclick="quickGenerateTest()" style="width: 100%; padding: 15px; font-size: 16px;">
                                <i class="fas fa-magic"></i> ØªÙˆÙ„ÙŠØ¯ Ø§Ø®ØªØ¨Ø§Ø± Ø°ÙƒÙŠ
                            </button>
                        </div>
                        
                        <div class="dashboard-section">
                            <h3 style="color: var(--neon-green); margin-bottom: 20px;">
                                <i class="fas fa-chart-bar"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙƒ
                            </h3>
                            
                            <div style="margin-bottom: 25px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                    <span style="color: var(--text-secondary);">Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</span>
                                    <span style="color: var(--neon-blue); font-weight: bold; font-size: 18px;">${userData.stats?.level || 1}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                    <span style="color: var(--text-secondary);">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©:</span>
                                    <span style="color: var(--neon-green); font-weight: bold; font-size: 18px;">${userData.stats?.testsTaken || 0}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                    <span style="color: var(--text-secondary);">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø´Ø£Ø©:</span>
                                    <span style="color: var(--neon-purple); font-weight: bold; font-size: 18px;">${userData.stats?.testsCreated || 0}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                    <span style="color: var(--text-secondary);">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù†ØªØ§Ø¦Ø¬:</span>
                                    <span style="color: var(--neon-yellow); font-weight: bold; font-size: 18px;">${(userData.stats?.averageScore || 0).toFixed(1)}%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©:</span>
                                    <span style="color: var(--neon-red); font-weight: bold; font-size: 18px;">${(userData.stats?.bestScore || 0).toFixed(1)}%</span>
                                </div>
                            </div>
                            
                            <div style="text-align: center; margin-top: 20px;">
                                <div class="score-circle" style="width: 100px; height: 100px; font-size: 32px; margin: 0 auto;">
                                    ${userData.stats?.level || 1}
                                </div>
                                <div style="color: var(--text-secondary); margin-top: 10px;">Ù…Ø³ØªÙˆØ§Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-section" style="margin-top: 30px;">
                        <h3 style="color: var(--neon-purple); margin-bottom: 20px;">
                            <i class="fas fa-trophy"></i> Ø£Ø­Ø¯Ø« Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª
                        </h3>
                        
                        ${(userData.achievements?.length > 0 ? `
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                ${userData.achievements.slice(0, 4).map(ach => `
                                    <div class="achievement-card">
                                        <i class="fas fa-trophy" style="font-size: 32px; color: var(--neon-yellow); margin-bottom: 10px;"></i>
                                        <div style="font-weight: bold; color: white; margin-bottom: 5px;">${ach.name}</div>
                                        <div style="color: var(--text-secondary); font-size: 12px;">${ach.description}</div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
                                <i class="fas fa-trophy" style="font-size: 48px; color: var(--text-dim); margin-bottom: 15px;"></i>
                                <div style="font-size: 16px; margin-bottom: 10px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø¨Ø¹Ø¯</div>
                                <div style="font-size: 14px;">Ø£Ù†Ø´Ø¦ ÙˆØ­Ù„ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù„ØªØ­ØµÙ„ Ø¹Ù„Ù‰ Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</div>
                            </div>
                        `)}
                    </div>
                </div>
            `;
            
            document.getElementById('content-area').innerHTML = content;
        }

        async function loadTestGenerator() {
            const content = `
                <div style="max-width: 900px; margin: 0 auto;">
                    <h1 style="color: var(--neon-blue); margin-bottom: 30px; font-size: 36px;">
                        <i class="fas fa-magic"></i> Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠ
                    </h1>
                    
                    <div class="tab-container">
                        <button class="tab-btn active" onclick="switchTestTab('text')">Ù…Ù† Ù†Øµ</button>
                        <button class="tab-btn" onclick="switchTestTab('image')">Ù…Ù† ØµÙˆØ±Ø©</button>
                        <button class="tab-btn" onclick="switchTestTab('topic')">Ù…Ù† Ù…ÙˆØ¶ÙˆØ¹</button>
                        button class="tab-btn" onclick="switchTestTab('manual')">Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ</button> <!-- Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± Ù‡Ù†Ø§ -->
                   </div>
                    </div>
                    
                    <div id="tab-content" style="background: var(--gradient-card); border-radius: 20px; padding: 30px; border: 2px solid rgba(0,245,255,0.2);">
                        ${await loadTextTabContent()}
                    </div>
                </div>
            `;
            
            document.getElementById('content-area').innerHTML = content;
        }

        async function loadTextTabContent() {
            return `
                <div id="text-tab-content">
                    <h3 style="color: var(--neon-blue); margin-bottom: 20px;">
                        <i class="fas fa-font"></i> Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ
                    </h3>
                    
                    <div class="form-group">
                        <textarea id="input-text" class="form-control text-area" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ Ù‡Ù†Ø§... ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„Ù†Øµ Ø¨Ø£ÙŠ Ø´ÙƒÙ„ (Ù…Ø±Ù‚Ù…ØŒ ÙÙ‚Ø±Ø§ØªØŒ Ø¹Ù†Ø§ÙˆÙŠÙ†ØŒ Ø¥Ù„Ø®). Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¨ØªØ­Ù„ÙŠÙ„Ù‡ ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ù‡Ù… Ø§Ù„Ù†Ù‚Ø§Ø· Ù„ØªÙˆÙ„ÙŠØ¯ Ø£Ø³Ø¦Ù„Ø© Ø°ÙƒÙŠØ© ØªØ±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·. 
                        
Ù…Ø«Ø§Ù„:
Ø§Ù„ØªÙ†ÙØ³ Ø§Ù„Ø®Ù„ÙˆÙŠ Ù‡Ùˆ Ø¹Ù…Ù„ÙŠØ© Ø­ÙŠÙˆÙŠØ© ØªÙ‚ÙˆÙ… Ø¨Ù‡Ø§ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ø§Ù‚Ø© Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ© Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ø§Ù„Ø¬Ù„ÙˆÙƒÙˆØ² Ø¥Ù„Ù‰ Ø·Ø§Ù‚Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (ATP). ØªØ­Ø¯Ø« Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù…ÙŠØªÙˆÙƒÙˆÙ†Ø¯Ø±ÙŠØ§ ÙˆØªØªØ·Ù„Ø¨ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†." rows="10"></textarea>
                        <div style="color: var(--text-dim); font-size: 12px; margin-top: 5px;">
                            Ø§Ù„Ù†Øµ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 100 ÙƒÙ„Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                        <div>
                            <label style="color: var(--text-secondary); display: block; margin-bottom: 8px;">
                                <i class="fas fa-question-circle"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                            </label>
                            <input type="range" id="question-count" class="form-control" min="5" max="30" value="15" oninput="document.getElementById('question-count-display').textContent = this.value + ' Ø³Ø¤Ø§Ù„'">
                            <div id="question-count-display" style="color: var(--neon-blue); text-align: center; margin-top: 5px; font-weight: bold;">15 Ø³Ø¤Ø§Ù„</div>
                        </div>
                        
                        <div>
                            <label style="color: var(--text-secondary); display: block; margin-bottom: 8px;">
                                <i class="fas fa-brain"></i> Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©
                            </label>
                            <select id="difficulty" class="form-control">
                                <option value="easy">Ø³Ù‡Ù„ (Ù…Ø¨ØªØ¯Ø¦)</option>
                                <option value="medium" selected>Ù…ØªÙˆØ³Ø· (Ù…ØªÙ‚Ø¯Ù…)</option>
                                <option value="hard">ØµØ¹Ø¨ (Ø®Ø¨ÙŠØ±)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <label style="color: var(--text-secondary); display: block; margin-bottom: 10px;">
                            <i class="fas fa-check-circle"></i> Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                        </label>
                        <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                            <label style="color: var(--text-secondary); cursor: pointer;">
                                <input type="checkbox" id="mcq-type" checked style="margin-left: 5px;"> Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯
                            </label>
                            <label style="color: var(--text-secondary); cursor: pointer;">
                                <input type="checkbox" id="tf-type" checked style="margin-left: 5px;"> ØµØ­ ÙˆØ®Ø·Ø£
                            </label>
                            <label style="color: var(--text-secondary); cursor: pointer;">
                                <input type="checkbox" id="sa-type" style="margin-left: 5px;"> Ø¥Ø¬Ø§Ø¨Ø© Ù‚ØµÙŠØ±Ø©
                            </label>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="generateTestFromText()" style="width: 100%; padding: 18px; font-size: 18px;">
                        <i class="fas fa-bolt"></i> ØªÙˆÙ„ÙŠØ¯ Ø§Ø®ØªØ¨Ø§Ø± Ø°ÙƒÙŠ
                    </button>
                    
                    <div style="margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.3); border-radius: 15px; border: 1px solid rgba(0,245,255,0.1);">
                        <h4 style="color: var(--neon-green); margin-bottom: 10px;">
                            <i class="fas fa-lightbulb"></i> ÙƒÙŠÙ ÙŠØ¹Ù…Ù„ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠØŸ
                        </h4>
                        <div style="color: var(--text-secondary); line-height: 1.6;">
                            <p>âœ“ ÙŠØ­Ù„Ù„ Ø§Ù„Ù†Øµ ÙˆÙŠØ³ØªØ®Ø±Ø¬ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙÙ‚Ø·</p>
                            <p>âœ“ ÙŠØ­Ø¯Ø¯ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ø£ÙÙƒØ§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</p>
                            <p>âœ“ ÙŠØ³ØªÙ‡Ø¯Ù Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ù‡Ù…Ø© ÙˆÙŠØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø´Ùˆ</p>
                            <p>âœ“ ÙŠÙˆÙ„Ø¯ Ø£Ø³Ø¦Ù„Ø© Ù…ØªÙ†ÙˆØ¹Ø© ØªØ¹ÙƒØ³ ÙÙ‡Ù… Ø§Ù„Ù…Ø­ØªÙˆÙ‰</p>
                            <p>âœ“ ÙŠØ¶Ù…Ù† ØªØºØ·ÙŠØ© Ø´Ø§Ù…Ù„Ø© Ù„Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</p>
                        </div>
                    </div>
                </div>
            `;
        }
        async function loadImageTabContent() {
    return `
        <div id="image-tab-content">
            <h3 style="color: var(--neon-green); margin-bottom: 20px;">
                <i class="fas fa-image"></i> Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ÙƒØªØ§Ø¨ Ø£Ùˆ Ø§Ù„Ù…Ù„Ø®Øµ
            </h3>
            
            <div class="image-preview-container" onclick="document.getElementById('image-file-input').click()" 
                 style="border: 2px dashed var(--neon-blue); padding: 40px; text-align: center; cursor: pointer; border-radius: 15px;">
                <i class="fas fa-cloud-upload-alt" style="font-size: 50px; color: var(--neon-blue); margin-bottom: 10px;"></i>
                <p>Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø±ÙØ¹ ØµÙˆØ±Ø© (PNG, JPG)</p>
                <input type="file" id="image-file-input" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
            </div>
            
            <div id="image-preview-area" style="margin-top: 20px; display: none; text-align: center;">
                <img id="preview-img" style="max-width: 100%; border-radius: 10px; border: 2px solid var(--neon-blue); max-height: 300px;">
                <p style="color: var(--text-secondary); margin-top: 10px;">ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­</p>
            </div>

            <div class="form-group" style="margin-top: 20px;">
                <label>Ù„ØºØ© Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„ØµÙˆØ±Ø©:</label>
                <select id="ocr-lang" class="form-control">
                    <option value="ara">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                    <option value="eng">Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</option>
                    <option value="ara+eng">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© + Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</option>
                </select>
            </div>
            
            <button class="btn btn-primary" id="ocr-btn" onclick="generateTestFromImage()" style="width: 100%; padding: 15px; margin-top: 20px;" disabled>
                <i class="fas fa-magic"></i> Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø© ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
            </button>
        </div>
    `;
}
        
        async function loadTopicTabContent() {
            return `
                <div id="topic-tab-content" style="display: none;">
                    <h3 style="color: var(--neon-purple); margin-bottom: 20px;">
                        <i class="fas fa-hashtag"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† Ù…ÙˆØ¶ÙˆØ¹
                    </h3>
                    
                    <div class="form-group">
                        <input type="text" id="topic-input" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ù…Ø«Ø§Ù„: Ø§Ù„ØªÙ†ÙØ³ Ø§Ù„Ø®Ù„ÙˆÙŠØŒ Ø§Ù„Ø­Ø±Ø¨ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ØŒ Ù†Ø¸Ø±ÙŠØ© Ø§Ù„ØªØ·ÙˆØ±)">
                    </div>
                    
                    <div class="form-group">
                        <label style="color: var(--text-secondary); display: block; margin-bottom: 8px;">
                            ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
                        </label>
                        <textarea id="topic-details" class="form-control" placeholder="ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ø£Ùˆ Ù†Ù‚Ø§Ø· Ù…Ø­Ø¯Ø¯Ø© ØªØ±ÙŠØ¯ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„ÙŠÙ‡Ø§..." rows="4"></textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                        <div>
                            <label style="color: var(--text-secondary); display: block; margin-bottom: 8px;">
                                Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙØµÙŠÙ„
                            </label>
                            <select id="topic-depth" class="form-control">
                                <option value="basic">Ø£Ø³Ø§Ø³ÙŠ</option>
                                <option value="intermediate" selected>Ù…ØªÙˆØ³Ø·</option>
                                <option value="advanced">Ù…ØªÙ‚Ø¯Ù…</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="color: var(--text-secondary); display: block; margin-bottom: 8px;">
                                Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
                            </label>
                            <input type="number" id="topic-question-count" class="form-control" value="15" min="5" max="30">
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="generateTestFromTopic()" style="width: 100%; padding: 18px; font-size: 18px;">
                        <i class="fas fa-brain"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ø®ØªØ¨Ø§Ø±
                    </button>
                </div>
            `;
        }

        function switchTestTab(tabName) {
    // 1. ØªØºÙŠÙŠØ± Ø´ÙƒÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    if (event) event.target.classList.add('active');
    
    const tabContent = document.getElementById('tab-content');
    
    // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
    if (tabName === 'text') loadTextTabContent().then(c => tabContent.innerHTML = c);
    else if (tabName === 'image') loadImageTabContent().then(c => tabContent.innerHTML = c);
    else if (tabName === 'topic') loadTopicTabContent().then(c => tabContent.innerHTML = c);
    else if (tabName === 'manual') loadManualTabContent().then(c => tabContent.innerHTML = c); // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
}

        async function generateTestFromText() {
            const text = document.getElementById('input-text')?.value;
            const questionCount = parseInt(document.getElementById('question-count')?.value || 15);
            const difficulty = document.getElementById('difficulty')?.value;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© "Ø®Ù„Ø·Ø©"
            if (checkChaosWord(text)) {
                showChaosWarning();
                return;
            }
            
            if (!text || text.length < 100) {
                showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ ÙŠØªÙƒÙˆÙ† Ù…Ù† 100 Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
                return;
            }
            
            try {
                const test = await testSystem.generateTestFromText(text, {
                    count: questionCount,
                    difficulty: difficulty,
                    title: 'Ø§Ø®ØªØ¨Ø§Ø± Ø°ÙƒÙŠ Ù…ÙˆÙ„Ø¯',
                    description: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø¯Ø®Ù„'
                });
                
                currentTest = test;
                currentAnswers = new Array(test.questions.length).fill(null);
                
                displayTest(test);
                showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
            }
        }

        async function generateTestFromImage() {
    const fileInput = document.getElementById('image-file-input');
    const langSelect = document.getElementById('ocr-language') || { value: 'ara' };
    
    if (!fileInput?.files[0]) {
        showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'error');
        return;
    }

    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†ØµÙˆØµ (Ù‚Ø¯ ÙŠØ³ØªØºØ±Ù‚ ÙˆÙ‚ØªØ§Ù‹)...');

    try {
        // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø§Ù…Ù„ Tesseract
        const worker = await Tesseract.createWorker();
        
        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (ara) Ø£Ùˆ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© (eng)
        await worker.loadLanguage(langSelect.value);
        await worker.initialize(langSelect.value);

        // ØªÙ†ÙÙŠØ° Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù†Øµ
        const { data: { text } } = await worker.recognize(fileInput.files[0]);
        
        // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ù„ Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
        await worker.terminate();

        hideLoading();

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬
        const cleanText = text.trim();

        if (cleanText.length < 50) {
            showNotification('Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ Ø£Ùˆ ØºÙŠØ± ÙˆØ§Ø¶Ø­. Ø­Ø§ÙˆÙ„ ØµÙˆØ±Ø© Ø£ÙˆØ¶Ø­.', 'warning');
            console.log("Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬:", cleanText); // Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
            return;
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ø¥Ù„Ù‰ Ø¯Ø§Ù„Ø© ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø¯Ø§Ù„Ø© Ø§Ù„Ù†ØµÙˆØµ Ù„ÙƒÙ† Ù†Ù…Ø±Ø± Ù„Ù‡Ø§ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©
        const test = await testSystem.generateTestFromText(cleanText, {
            count: 10,
            difficulty: 'medium',
            title: 'Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† ØµÙˆØ±Ø© (OCR)',
            description: 'ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‡Ø°Ø§ Ø§Ù„Ù†Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…Ø±ÙÙ‚Ø©.'
        });

        currentTest = test;
        currentAnswers = new Array(test.questions.length).fill(null);
        
        displayTest(test);
        showNotification('ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'success');

    } catch (error) {
        hideLoading();
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ OCR:', error);
        showNotification('ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª Ø§Ù„Ù„ØºØ©.', 'error');
    }
}

        async function generateTestFromTopic() {
            const topic = document.getElementById('topic-input')?.value;
            const details = document.getElementById('topic-details')?.value;
            const depth = document.getElementById('topic-depth')?.value;
            const questionCount = parseInt(document.getElementById('topic-question-count')?.value || 15);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© "Ø®Ù„Ø·Ø©"
            if (checkChaosWord(topic) || checkChaosWord(details)) {
                showChaosWarning();
                return;
            }
            
            if (!topic) {
                showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
                return;
            }
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ù†ØµÙŠ Ù…Ù† Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹
            const generatedText = await generateContentFromTopic(topic, details, depth);
            
            if (!generatedText) {
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰', 'error');
                return;
            }
            
            try {
                const test = await testSystem.generateTestFromText(generatedText, {
                    count: questionCount,
                    difficulty: depth === 'advanced' ? 'hard' : depth === 'basic' ? 'easy' : 'medium',
                    title: `Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ: ${topic}`,
                    description: details || `Ø§Ø®ØªØ¨Ø§Ø± ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø­ÙˆÙ„ Ù…ÙˆØ¶ÙˆØ¹: ${topic}`
                });
                
                currentTest = test;
                currentAnswers = new Array(test.questions.length).fill(null);
                
                displayTest(test);
                showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
            }
        }

        async function generateContentFromTopic(topic, details, depth) {
            showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø°ÙƒÙŠ...');
            
            // Ù…Ø­ØªÙˆÙ‰ Ù…Ø¹Ø±Ù Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹
            const contentTemplates = {
                'Ø§Ù„ØªÙ†ÙØ³ Ø§Ù„Ø®Ù„ÙˆÙŠ': `
                    Ø§Ù„ØªÙ†ÙØ³ Ø§Ù„Ø®Ù„ÙˆÙŠ Ù‡Ùˆ Ø¹Ù…Ù„ÙŠØ© Ø­ÙŠÙˆÙŠØ© Ø£Ø³Ø§Ø³ÙŠØ© ØªÙ‚ÙˆÙ… Ø¨Ù‡Ø§ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø·Ø§Ù‚Ø© Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ© Ø§Ù„Ù…Ø®Ø²Ù†Ø© ÙÙŠ Ø§Ù„Ø¬Ù„ÙˆÙƒÙˆØ² Ø¥Ù„Ù‰ Ø·Ø§Ù‚Ø© Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (ATP). 
                    
                    Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„ØªÙ†ÙØ³ Ø§Ù„Ø®Ù„ÙˆÙŠ:
                    1. Ø§Ù„ØªØ­Ù„Ù„ Ø§Ù„Ø³ÙƒØ±ÙŠ: ÙŠØ­Ø¯Ø« ÙÙŠ Ø§Ù„Ø³ÙŠØªÙˆØ¨Ù„Ø§Ø²Ù…ØŒ Ø­ÙŠØ« ÙŠØªÙ… ØªÙƒØ³ÙŠØ± Ø¬Ø²ÙŠØ¡ Ø§Ù„Ø¬Ù„ÙˆÙƒÙˆØ² Ø¥Ù„Ù‰ Ø¬Ø²ÙŠØ¦ÙŠÙ† Ù…Ù† Ø­Ù…Ø¶ Ø§Ù„Ø¨ÙŠØ±ÙˆÙÙŠÙƒ Ù…Ø¹ Ø¥Ù†ØªØ§Ø¬ ÙƒÙ…ÙŠØ© Ù‚Ù„ÙŠÙ„Ø© Ù…Ù† ATP.
                    2. Ø¯ÙˆØ±Ø© ÙƒØ±ÙŠØ¨Ø³: ØªØ­Ø¯Ø« ÙÙŠ Ø§Ù„Ù…ÙŠØªÙˆÙƒÙˆÙ†Ø¯Ø±ÙŠØ§ØŒ Ø­ÙŠØ« ÙŠØªÙ… Ø£ÙƒØ³Ø¯Ø© Ø­Ù…Ø¶ Ø§Ù„Ø¨ÙŠØ±ÙˆÙÙŠÙƒ Ù„Ø¥Ù†ØªØ§Ø¬ NADH ÙˆFADH2.
                    3. Ø³Ù„Ø³Ù„Ø© Ù†Ù‚Ù„ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†: ØªØ­Ø¯Ø« ÙÙŠ Ø§Ù„ØºØ´Ø§Ø¡ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù„Ù…ÙŠØªÙˆÙƒÙˆÙ†Ø¯Ø±ÙŠØ§ØŒ Ø­ÙŠØ« ÙŠØªÙ… Ø¥Ù†ØªØ§Ø¬ Ù…Ø¹Ø¸Ù… Ø¬Ø²ÙŠØ¦Ø§Øª ATP.
                    
                    Ø£Ù‡Ù…ÙŠØ© Ø§Ù„ØªÙ†ÙØ³ Ø§Ù„Ø®Ù„ÙˆÙŠ:
                    - Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ø·Ø§Ù‚Ø© Ù„Ù„Ø®Ù„Ø§ÙŠØ§
                    - Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø¯Ø±Ø¬Ø© Ø­Ø±Ø§Ø±Ø© Ø§Ù„Ø¬Ø³Ù…
                    - ØªÙˆÙÙŠØ± Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†ÙŠ Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø²ÙŠØ¦Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©
                `,
                'Ø§Ù„Ø­Ø±Ø¨ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰': `
                    Ø§Ù„Ø­Ø±Ø¨ Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ (1914-1918) ÙƒØ§Ù†Øª Ø­Ø±Ø¨Ø§Ù‹ Ø¹Ø§Ù„Ù…ÙŠØ© Ø´Ø§Ø±ÙƒØª ÙÙŠÙ‡Ø§ Ù…Ø¹Ø¸Ù… Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù„Ù…ØŒ ÙˆÙ‚Ø³Ù…Øª Ø§Ù„Ø¯ÙˆÙ„ Ø¥Ù„Ù‰ Ù‚ÙˆØªÙŠÙ† Ø±Ø¦ÙŠØ³ÙŠØªÙŠÙ†: Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±ÙƒØ² ÙˆØ¯ÙˆÙ„ Ø§Ù„Ø­Ù„ÙØ§Ø¡.
                    
                    Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„Ø­Ø±Ø¨:
                    1. Ø§Ù„ØªØ­Ø§Ù„ÙØ§Øª Ø§Ù„Ø¹Ø³ÙƒØ±ÙŠØ© Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø©
                    2. Ø³Ø¨Ø§Ù‚ Ø§Ù„ØªØ³Ù„Ø­
                    3. Ø§Ù„Ù‚ÙˆÙ…ÙŠØ© Ø§Ù„Ù…ØªØ·Ø±ÙØ©
                    4. Ø§ØºØªÙŠØ§Ù„ Ø§Ù„Ø£Ø±Ø´ÙŠØ¯ÙˆÙ‚ ÙØ±Ø§Ù†Ø² ÙØ±Ø¯ÙŠÙ†Ø§Ù†Ø¯
                    
                    Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:
                    - Ø³Ù‚ÙˆØ· Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ§Øª Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ù†Ù…Ø³Ø§ÙˆÙŠØ© Ø§Ù„Ù…Ø¬Ø±ÙŠØ© ÙˆØ§Ù„Ø¹Ø«Ù…Ø§Ù†ÙŠØ©
                    - Ù…Ø¹Ø§Ù‡Ø¯Ø© ÙØ±Ø³Ø§ÙŠ ÙˆØ§Ù„Ø¹Ù‚ÙˆØ¨Ø§Øª Ø¹Ù„Ù‰ Ø£Ù„Ù…Ø§Ù†ÙŠØ§
                    - Ù†Ø´Ø£Ø© Ø¹ØµØ¨Ø© Ø§Ù„Ø£Ù…Ù…
                    - ØªØºÙŠØ±Ø§Øª Ø¬ÙŠÙˆØ³ÙŠØ§Ø³ÙŠØ© ÙƒØ¨Ø±Ù‰ ÙÙŠ Ø£ÙˆØ±ÙˆØ¨Ø§ ÙˆØ§Ù„Ø´Ø±Ù‚ Ø§Ù„Ø£ÙˆØ³Ø·
                `,
                'Ù†Ø¸Ø±ÙŠØ© Ø§Ù„ØªØ·ÙˆØ±': `
                    Ù†Ø¸Ø±ÙŠØ© Ø§Ù„ØªØ·ÙˆØ± Ù‡ÙŠ Ø§Ù„Ù†Ø¸Ø±ÙŠØ© Ø§Ù„Ø¹Ù„Ù…ÙŠØ© Ø§Ù„ØªÙŠ ØªÙØ³Ø± ØªÙ†ÙˆØ¹ Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„Ø­ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø±Ø¶ Ø¹Ø¨Ø± Ø§Ù„Ø²Ù…Ù† Ø§Ù„Ø¬ÙŠÙˆÙ„ÙˆØ¬ÙŠ.
                    
                    Ø§Ù„Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:
                    1. Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ: Ø§Ù„Ø¨Ù‚Ø§Ø¡ Ù„Ù„Ø£ØµÙ„Ø­
                    2 Ø§Ù„ØªÙƒÙŠÙ: Ù‚Ø¯Ø±Ø© Ø§Ù„ÙƒØ§Ø¦Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ØªÙƒÙŠÙ Ù…Ø¹ Ø¨ÙŠØ¦ØªÙ‡Ø§
                    3. Ø§Ù„ØªÙ†ÙˆØ¹ Ø§Ù„Ø¬ÙŠÙ†ÙŠ: Ø§Ù„Ø§Ø®ØªÙ„Ø§ÙØ§Øª Ø¨ÙŠÙ† Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„ÙˆØ§Ø­Ø¯
                    4. Ø§Ù„Ø§Ù†ØªÙˆØ§Ø¹: ØªÙƒÙˆÙ† Ø£Ù†ÙˆØ§Ø¹ Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ø¨Ø± Ø§Ù„Ø²Ù…Ù†
                    
                    Ø£Ø¯Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªØ·ÙˆØ±:
                    - Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­ÙÙˆØ±ÙŠ
                    - Ø§Ù„ØªØ´Ø§Ø¨Ù‡ Ø§Ù„ØªØ´Ø±ÙŠØ­ÙŠ
                    - Ø§Ù„Ø£Ø¯Ù„Ø© Ø§Ù„Ø¬ÙŠÙ†ÙŠØ©
                    - Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ù„Ù„ÙƒØ§Ø¦Ù†Ø§Øª
                `
            };
            
            // Ù…Ø­Ø§ÙƒØ§Ø© ÙˆÙ‚Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            hideLoading();
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙÙŠ Ø§Ù„Ù‚ÙˆØ§Ù„Ø¨ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡
            if (contentTemplates[topic]) {
                return contentTemplates[topic] + (details ? `\n\nØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©: ${details}` : '');
            }
            
            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ø£Ù†Ø´Ø¦ Ù…Ø­ØªÙˆÙ‰ Ø¹Ø§Ù…
            return `
                ${topic} Ù‡Ùˆ Ù…ÙˆØ¶ÙˆØ¹ Ù…Ù‡Ù… ÙÙŠ Ù…Ø¬Ø§Ù„ Ø§Ù„Ù…Ø¹Ø±ÙØ©. 
                
                ÙŠØ¹ØªØ¨Ø± ${topic} Ù…Ù† Ø§Ù„Ù…ÙˆØ§Ø¶ÙŠØ¹ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„ØªÙŠ ØªØ¯Ø±Ø³ ÙÙŠ Ø§Ù„Ø¹Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ØªØ®ØµØµØ§Øª Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ©. 
                
                Ù…Ù† Ø£Ù‡Ù… Ø¬ÙˆØ§Ù†Ø¨ ${topic}:
                1. Ø§Ù„Ù…Ø¨Ø§Ø¯Ø¦ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                2. Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                3. Ø§Ù„Ø£Ù‡Ù…ÙŠØ© Ø§Ù„Ø¹Ù„Ù…ÙŠØ©
                4. Ø§Ù„ØªØ·ÙˆØ± Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ
                
                ${details ? `\nØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©: ${details}` : ''}
            `;
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewDiv = document.getElementById('image-preview');
                const previewImg = document.getElementById('preview-img');
                const generateBtn = document.getElementById('generate-image-btn');
                
                previewImg.src = e.target.result;
                previewDiv.style.display = 'block';
                generateBtn.disabled = false;
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            const fileInput = document.getElementById('image-file-input');
            const previewDiv = document.getElementById('image-preview');
            const generateBtn = document.getElementById('generate-image-btn');
            
            fileInput.value = '';
            previewDiv.style.display = 'none';
            generateBtn.disabled = true;
        }

        function displayTest(test) {
            const content = `
                <div style="max-width: 900px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h1 style="color: var(--neon-blue); margin: 0; font-size: 32px;">
                            <i class="fas fa-file-alt"></i> ${test.title}
                        </h1>
                        <div>
                            <button class="btn btn-secondary" onclick="loadTestGenerator()" style="margin-left: 10px;">
                                <i class="fas fa-arrow-right"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯
                            </button>
                            <button class="btn btn-primary" onclick="showTestAnalysis()">
                                <i class="fas fa-chart-bar"></i> ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ
                            </button>
                        </div>
                    </div>
                    
                    <div style="background: var(--gradient-card); border-radius: 20px; padding: 25px; margin-bottom: 30px; border: 2px solid rgba(0,245,255,0.2);">
                        <h3 style="color: var(--neon-blue); margin-bottom: 20px;">
                            <i class="fas fa-info-circle"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div>
                                <div style="color: var(--text-secondary); font-size: 14px;">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</div>
                                <div style="color: white; font-size: 28px; font-weight: bold;">${test.questions.length}</div>
                            </div>
                            
                            <div>
                                <div style="color: var(--text-secondary); font-size: 14px;">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©</div>
                                <div style="color: var(--neon-green); font-size: 28px; font-weight: bold;">
                                    ${test.settings.difficulty === 'easy' ? 'Ø³Ù‡Ù„' : 
                                      test.settings.difficulty === 'medium' ? 'Ù…ØªÙˆØ³Ø·' : 'ØµØ¹Ø¨'}
                                </div>
                            </div>
                            
                            <div>
                                <div style="color: var(--text-secondary); font-size: 14px;">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø¯Ø±</div>
                                <div style="color: var(--neon-purple); font-size: 28px; font-weight: bold;">${test.settings.timeLimit} Ø¯Ù‚ÙŠÙ‚Ø©</div>
                            </div>
                            
                            <div>
                                <div style="color: var(--text-secondary); font-size: 14px;">Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ø¬Ø§Ø­</div>
                                <div style="color: var(--neon-yellow); font-size: 28px; font-weight: bold;">${test.settings.passingScore}%</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(0,245,255,0.1);">
                            <div style="color: var(--text-secondary); margin-bottom: 10px;">ÙˆØµÙ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</div>
                            <div style="color: white;">${test.description}</div>
                        </div>
                    </div>
                    
                    <div class="progress-counter">
                        <div class="counter-item ${currentAnswers.filter(a => a !== null && a !== '').length > 0 ? 'active' : ''}">
                            <i class="fas fa-check-circle"></i>
                            <span>ØªÙ…Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</span>
                            <span id="answered-count">0</span>
                        </div>
                        <div class="counter-item">
                            <i class="fas fa-clock"></i>
                            <span>Ø§Ù„ÙˆÙ‚Øª</span>
                            <span>${test.settings.timeLimit}:00</span>
                        </div>
                        <div class="counter-item">
                            <i class="fas fa-star"></i>
                            <span>Ø§Ù„Ù†Ù‚Ø§Ø·</span>
                            <span id="total-points">0</span>
                        </div>
                    </div>
                    
                    <div id="questions-container" style="margin-bottom: 30px;"></div>
                    
                    <div style="background: var(--gradient-card); border-radius: 20px; padding: 25px; border: 2px solid rgba(0,245,255,0.2);">
                        <h3 style="color: var(--neon-blue); margin-bottom: 20px;">
                            <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
                        </h3>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="color: var(--text-secondary);">
                                <span id="answered-percentage">0%</span> Ù…Ù† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØªÙ…Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„ÙŠÙ‡Ø§
                            </div>
                            <button class="btn btn-primary" onclick="submitTest()" style="padding: 15px 30px; font-size: 18px;">
                                <i class="fas fa-check-circle"></i> Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ§Ù„ØªØµØ­ÙŠØ­
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('content-area').innerHTML = content;
            displayQuestions(test.questions);
            updateAnswerCount();
        }

        function displayQuestions(questions) {
            const container = document.getElementById('questions-container');
            let html = '<h3 style="color: var(--neon-blue); margin-bottom: 25px;"><i class="fas fa-question-circle"></i> Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>';
            
            questions.forEach((question, index) => {
                html += `
                    <div class="question-item" id="question-${index}">
                        <div class="question-text">
                            <span style="color: var(--neon-blue); font-weight: bold;">Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}:</span>
                            ${question.text}
                            <span style="color: var(--text-dim); font-size: 14px; display: block; margin-top: 5px;">
                                (${question.points} Ù†Ù‚Ø·Ø©) | ${question.type === 'multiple_choice' ? 'Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯' : 
                                 question.type === 'true_false' ? 'ØµØ­/Ø®Ø·Ø£' : 
                                 question.type === 'short_answer' ? 'Ø¥Ø¬Ø§Ø¨Ø© Ù‚ØµÙŠØ±Ø©' : 'Ù…Ù„Ø¡ Ø§Ù„ÙØ±Ø§Øº'}
                            </span>
                        </div>
                        
                        ${question.type === 'multiple_choice' ? `
                            <div class="options-container">
                                ${question.options.map((option, optIndex) => `
                                    <div class="option-item" onclick="selectAnswer(${index}, ${optIndex})" id="option-${index}-${optIndex}">
                                        ${String.fromCharCode(1633 + optIndex)}) ${option}
                                    </div>
                                `).join('')}
                            </div>
                        ` : question.type === 'true_false' ? `
                            <div style="display: flex; gap: 15px; margin-top: 15px;">
                                <button class="btn ${currentAnswers[index] === 0 ? 'btn-primary' : 'btn-secondary'}" onclick="selectAnswer(${index}, 0)" style="flex: 1;">
                                    <i class="fas fa-check"></i> ØµØ­ÙŠØ­
                                </button>
                                <button class="btn ${currentAnswers[index] === 1 ? 'btn-primary' : 'btn-secondary'}" onclick="selectAnswer(${index}, 1)" style="flex: 1;">
                                    <i class="fas fa-times"></i> Ø®Ø·Ø£
                                </button>
                            </div>
                        ` : question.type === 'short_answer' ? `
                            <div style="margin-top: 15px;">
                                <textarea id="answer-${index}" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§..." rows="3" oninput="selectAnswer(${index}, this.value)"></textarea>
                            </div>
                        ` : `
                            <div style="margin-top: 15px;">
                                <input type="text" id="answer-${index}" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©..." oninput="selectAnswer(${index}, this.value)">
                            </div>
                        `}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function selectAnswer(questionIndex, answer) {
            currentAnswers[questionIndex] = answer;
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯
            const question = currentTest.questions[questionIndex];
            if (question.type === 'multiple_choice') {
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
                for (let i = 0; i < question.options.length; i++) {
                    const optionElement = document.getElementById(`option-${questionIndex}-${i}`);
                    if (optionElement) {
                        optionElement.classList.remove('selected');
                    }
                }
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù„Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
                const selectedOption = document.getElementById(`option-${questionIndex}-${answer}`);
                if (selectedOption) {
                    selectedOption.classList.add('selected');
                }
            } else if (question.type === 'true_false') {
                // ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµØ­/Ø®Ø·Ø£
                const trueBtn = document.querySelector(`#question-${questionIndex} .btn:nth-child(1)`);
                const falseBtn = document.querySelector(`#question-${questionIndex} .btn:nth-child(2)`);
                
                trueBtn.className = `btn ${answer === 0 ? 'btn-primary' : 'btn-secondary'}`;
                falseBtn.className = `btn ${answer === 1 ? 'btn-primary' : 'btn-secondary'}`;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø¬Ø§Ø¨Ø©
            updateAnswerCount();
        }

        function updateAnswerCount() {
            const answered = currentAnswers.filter(answer => answer !== null && answer !== '').length;
            const total = currentTest.questions.length;
            const percentage = Math.round((answered / total) * 100);
            
            document.getElementById('answered-count').textContent = answered;
            document.getElementById('answered-percentage').textContent = `${percentage}%`;
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            let potentialPoints = 0;
            currentTest.questions.forEach((question, index) => {
                if (currentAnswers[index] !== null && currentAnswers[index] !== '') {
                    potentialPoints += question.points;
                }
            });
            document.getElementById('total-points').textContent = potentialPoints;
            
            // ØªØºÙŠÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ø¹Ø¯Ø§Ø¯
            const countElement = document.getElementById('answered-count');
            if (percentage >= 80) {
                countElement.style.color = 'var(--neon-green)';
            } else if (percentage >= 50) {
                countElement.style.color = 'var(--neon-yellow)';
            } else {
                countElement.style.color = 'var(--neon-red)';
            }
        }

        async function submitTest() {
    const answered = currentAnswers.filter(answer => answer !== null && answer !== '').length;
    const total = currentTest.questions.length;
    
    if (answered === 0) {
        showNotification('Ù„Ù… ØªÙ‚Ù… Ø¨Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ø¨Ø¹Ø¯', 'error');
        return;
    }
    
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù…...');
    
    try {
        const evaluation = await testSystem.evaluateTest(currentTest.id, currentAnswers);
        
        // --- Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØ§Ù„Ù…Ø³ØªÙˆÙ‰ Ù‡Ù†Ø§ ---
        await handleUserProgress(evaluation);
        
        hideLoading();
        displayResults(evaluation);
        
    } catch (error) {
        hideLoading();
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:', error);
        showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØµØ­ÙŠØ­ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
    }
}

        function displayResults(evaluation) {
            const content = `
                <div style="max-width: 800px; margin: 0 auto;">
                    <h1 style="color: var(--neon-blue); margin-bottom: 30px; font-size: 36px; text-align: center;">
                        <i class="fas fa-trophy"></i> Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    </h1>
                    
                    <div class="result-card" style="text-align: center; padding: 40px;">
                        <div class="score-circle" style="margin: 0 auto 30px; background: ${evaluation.passed ? 'var(--gradient-ai)' : 'linear-gradient(135deg, #ff006e 0%, #ff4757 100%)'};">
                            ${evaluation.percentage}%
                        </div>
                        
                        <h2 style="color: ${evaluation.passed ? 'var(--neon-green)' : 'var(--accent)'}; margin-bottom: 20px; font-size: 28px;">
                            ${evaluation.passed ? 'ğŸ‰ Ù†Ø§Ø¬Ø­ - Ø£Ø­Ø³Ù†Øª!' : 'âŒ ØºÙŠØ± Ù†Ø§Ø¬Ø­ - Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰'}
                        </h2>
                        
                        <div style="font-size: 20px; color: white; margin-bottom: 25px;">
                            ${evaluation.correctAnswers} Ù…Ù† ${evaluation.totalQuestions} Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div>
                                <div style="color: var(--text-secondary);">Ø§Ù„Ø¯Ø±Ø¬Ø©</div>
                                <div style="color: var(--neon-blue); font-size: 24px; font-weight: bold;">${evaluation.score}/${evaluation.totalPoints}</div>
                            </div>
                            
                            <div>
                                <div style="color: var(--text-secondary);">Ø§Ù„Ù†Ø³Ø¨Ø©</div>
                                <div style="color: var(--neon-green); font-size: 24px; font-weight: bold;">${evaluation.percentage}%</div>
                            </div>
                            
                            <div>
                                <div style="color: var(--text-secondary);">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</div>
                                <div style="color: var(--neon-purple); font-size: 24px; font-weight: bold;">${evaluation.correctAnswers}</div>
                            </div>
                            
                            <div>
                                <div style="color: var(--text-secondary);">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ø¬Ø§Ø­</div>
                                <div style="color: var(--neon-yellow); font-size: 24px; font-weight: bold;">${currentTest.settings.passingScore}%</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <button class="btn btn-primary" onclick="loadDashboard()" style="margin-right: 15px; padding: 12px 25px;">
                                <i class="fas fa-home"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                            </button>
                            <button class="btn btn-secondary" onclick="reviewAnswers(evaluation)" style="padding: 12px 25px;">
                                <i class="fas fa-eye"></i> Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
                            </button>
                        </div>
                    </div>
                    
                    <div style="margin-top: 40px;">
                        <h3 style="color: var(--neon-blue); margin-bottom: 20px;">
                            <i class="fas fa-chart-line"></i> ØªÙ‚Ø¯Ù…Ùƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ
                        </h3>
                        
                        <div style="background: var(--gradient-card); border-radius: 15px; padding: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                                <div>
                                    <div style="color: var(--text-secondary);">Ù…Ø³ØªÙˆØ§Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ:</div>
                                    <div style="color: white; font-size: 20px; font-weight: bold;">${userData.stats?.level || 1}</div>
                                </div>
                                
                                <div>
                                    <div style="color: var(--text-secondary);">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·:</div>
                                    <div style="color: var(--neon-green); font-size: 20px; font-weight: bold;">${userData.stats?.totalXP || 0}</div>
                                </div>
                                
                                <div>
                                    <div style="color: var(--text-secondary);">Ù…ØªÙˆØ³Ø· Ù†ØªØ§Ø¦Ø¬Ùƒ:</div>
                                    <div style="color: var(--neon-purple); font-size: 20px; font-weight: bold;">${(userData.stats?.averageScore || 0).toFixed(1)}%</div>
                                </div>
                                
                                <div>
                                    <div style="color: var(--text-secondary);">Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©:</div>
                                    <div style="color: var(--neon-yellow); font-size: 20px; font-weight: bold;">${(userData.stats?.bestScore || 0).toFixed(1)}%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('content-area').innerHTML = content;
        }

        function reviewAnswers(evaluation) {
            let reviewContent = `
                <div style="max-width: 900px; margin: 0 auto;">
                    <h1 style="color: var(--neon-blue); margin-bottom: 30px;">
                        <i class="fas fa-search"></i> Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
                    </h1>
                    
                    <div style="margin-bottom: 30px; text-align: center;">
                        <div style="display: inline-block; background: var(--gradient-card); padding: 20px 40px; border-radius: 15px;">
                            <div style="color: var(--text-secondary);">Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</div>
                            <div style="color: var(--neon-green); font-size: 36px; font-weight: bold;">${evaluation.percentage}%</div>
                        </div>
                    </div>
            `;
            
            evaluation.results.forEach((result, index) => {
                const question = currentTest.questions[index];
                const isCorrect = result.isCorrect;
                
                reviewContent += `
                    <div class="question-item" style="border-color: ${isCorrect ? 'var(--neon-green)' : 'var(--accent)'};">
                        <div class="question-text">
                            <span style="color: var(--neon-blue); font-weight: bold;">Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1}:</span>
                            ${question.text}
                            <span style="color: ${isCorrect ? 'var(--neon-green)' : 'var(--accent)'}; display: block; margin-top: 5px;">
                                ${isCorrect ? 'âœ“ Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©' : 'âœ— Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©'} (${result.earnedPoints}/${question.points} Ù†Ù‚Ø·Ø©)
                            </span>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <div class="answer-feedback ${isCorrect ? 'correct-answer' : 'wrong-answer'}">
                                <strong>Ø¥Ø¬Ø§Ø¨ØªÙƒ:</strong> ${result.userAnswer || 'Ù„Ù… ØªØªÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©'}
                            </div>
                            
                            ${!isCorrect ? `
                                <div class="answer-feedback correct-answer" style="margin-top: 10px;">
                                    <strong>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</strong> ${result.correctAnswer}
                                </div>
                            ` : ''}
                            
                            <div class="explanation" style="margin-top: 10px;">
                                <strong>Ø´Ø±Ø­:</strong> ${result.explanation}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            reviewContent += `
                    <div style="text-align: center; margin-top: 50px;">
                        <button class="btn btn-primary" onclick="loadDashboard()">
                            <i class="fas fa-home"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('content-area').innerHTML = reviewContent;
        }

        function showTestAnalysis() {
            if (!currentTest || !currentTest.analysis) {
                showNotification('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­Ù„ÙŠÙ„', 'error');
                return;
            }
            
            const analysis = currentTest.analysis;
            
            Swal.fire({
                title: 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ',
                html: `
                    <div style="text-align: right; direction: rtl;">
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--neon-blue);">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„:</h4>
                            <div class="analysis-result">
                                <div class="analysis-item">
                                    <div class="analysis-value">${analysis.wordCount}</div>
                                    <div class="analysis-label">ÙƒÙ„Ù…Ø©</div>
                                </div>
                                <div class="analysis-item">
                                    <div class="analysis-value">${analysis.sentenceCount}</div>
                                    <div class="analysis-label">Ø¬Ù…Ù„Ø©</div>
                                </div>
                                <div class="analysis-item">
                                    <div class="analysis-value">${analysis.paragraphCount}</div>
                                    <div class="analysis-label">ÙÙ‚Ø±Ø©</div>
                                </div>
                                <div class="analysis-item">
                                    <div class="analysis-value">${analysis.topics.length}</div>
                                    <div class="analysis-label">Ù…ÙˆØ¶ÙˆØ¹</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--neon-green);">Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©:</h4>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
                                ${analysis.keywords.slice(0, 15).map(keyword => `
                                    <span style="background: rgba(0,245,255,0.1); padding: 5px 10px; border-radius: 15px; color: var(--neon-blue); font-size: 12px;">
                                        ${keyword}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: var(--neon-purple);">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:</h4>
                            <div style="margin-top: 10px;">
                                ${analysis.topics.map(topic => `
                                    <div style="margin-bottom: 8px;">
                                        <span style="color: white;">${topic.name}</span>
                                        <div style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; margin-top: 5px;">
                                            <div style="background: var(--neon-purple); height: 100%; width: ${topic.confidence * 100}%; border-radius: 3px;"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="color: var(--neon-yellow);">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµØ¹ÙˆØ¨Ø©:</h4>
                            <div style="text-align: center; margin-top: 10px;">
                                <span style="color: ${analysis.difficulty === 'easy' ? 'var(--neon-green)' : 
                                                     analysis.difficulty === 'medium' ? 'var(--neon-yellow)' : 
                                                     'var(--accent)'}; font-size: 24px; font-weight: bold;">
                                    ${analysis.difficulty === 'easy' ? 'Ø³Ù‡Ù„' : 
                                      analysis.difficulty === 'medium' ? 'Ù…ØªÙˆØ³Ø·' : 'ØµØ¹Ø¨'}
                                </span>
                            </div>
                        </div>
                    </div>
                `,
                width: 600,
                confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
                customClass: {
                    popup: 'rtl-popup'
                }
            });
        }

        async function loadTestHistory() {
            const tests = userData.tests || [];
            
            const content = `
                <div style="max-width: 1000px; margin: 0 auto;">
                    <h1 style="color: var(--neon-blue); margin-bottom: 30px; font-size: 36px;">
                        <i class="fas fa-history"></i> Ø³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
                    </h1>
                    
                    <div style="background: var(--gradient-card); border-radius: 20px; padding: 30px; margin-bottom: 30px; border: 2px solid rgba(0,245,255,0.2);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="color: var(--neon-blue); margin: 0;">
                                <i class="fas fa-list"></i> Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
                            </h3>
                            <div style="color: var(--text-secondary);">
                                ${tests.length} Ø§Ø®ØªØ¨Ø§Ø±
                            </div>
                        </div>
                        
                        ${tests.length > 0 ? `
                            <div style="max-height: 500px; overflow-y: auto; padding-right: 10px;">
                                ${tests.map((test, index) => `
                                    <div class="quiz-card" onclick="viewTestHistory('${test.id}')">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                            <div>
                                                <div style="font-weight: bold; color: white; font-size: 18px;">${test.title || 'Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</div>
                                                <div style="color: var(--text-secondary); font-size: 12px;">
                                                    ${new Date(test.date).toLocaleDateString('ar-SA', {
                                                        year: 'numeric',
                                                        month: 'long',
                                                        day: 'numeric',
                                                        hour: '2-digit',
                                                        minute: '2-digit'
                                                    })}
                                                </div>
                                            </div>
                                            <div>
                                                ${test.status === 'completed' ? `
                                                    <div style="background: ${test.score >= 70 ? 'var(--neon-green)' : 'var(--accent)'}; 
                                                        padding: 5px 15px; border-radius: 20px; color: white; font-weight: bold;">
                                                        ${test.score}%
                                                    </div>
                                                    <div style="color: var(--text-secondary); font-size: 11px; text-align: center; margin-top: 5px;">
                                                        ${test.result === 'Ù†Ø§Ø¬Ø­' ? 'Ù†Ø§Ø¬Ø­' : 'Ø±Ø§Ø³Ø¨'}
                                                    </div>
                                                ` : `
                                                    <div style="background: rgba(0,245,255,0.2); padding: 5px 15px; border-radius: 20px; color: var(--neon-blue);">
                                                        ØªØ­Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
                                                    </div>
                                                `}
                                            </div>
                                        </div>
                                        
                                        ${test.status === 'completed' ? `
                                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,245,255,0.1);">
                                                <div style="color: var(--text-secondary); font-size: 12px;">
                                                    ${test.questionCount} Ø³Ø¤Ø§Ù„
                                                </div>
                                                <div style="color: var(--text-secondary); font-size: 12px;">
                                                    ${test.completedAt ? new Date(test.completedAt).toLocaleDateString('ar-SA') : ''}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div style="text-align: center; padding: 50px; color: var(--text-secondary);">
                                <i class="fas fa-history" style="font-size: 64px; margin-bottom: 20px; color: var(--text-dim);"></i>
                                <h3 style="color: var(--text-secondary); margin-bottom: 15px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø³Ø§Ø¨Ù‚Ø©</h3>
                                <p>Ø£Ù†Ø´Ø¦ Ø§Ø®ØªØ¨Ø§Ø±Ùƒ Ø§Ù„Ø£ÙˆÙ„ Ù„ÙŠØ±Ø¯ Ù‡Ù†Ø§ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„</p>
                                <button class="btn btn-primary" onclick="loadTestGenerator()" style="margin-top: 20px;">
                                    <i class="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯
                                </button>
                            </div>
                        `}
                    </div>
                </div>
            `;
            
            document.getElementById('content-area').innerHTML = content;
        }

        function viewTestHistory(testId) {
            showNotification('Ù…ÙŠØ²Ø© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±', 'info');
        }

        async function loadTestLibrary() {
            const sampleTests = [
                {
                    id: 'sample1',
                    title: 'Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø¹Ø§Ù…Ø©',
                    description: 'Ø£Ø³Ø¦Ù„Ø© Ù…ØªÙ†ÙˆØ¹Ø© ÙÙŠ Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©',
                    difficulty: 'medium',
                    questions: 15,
                    time: 25,
                    subject: 'Ø¹Ù„ÙˆÙ…'
                },
                {
                    id: 'sample2',
                    title: 'Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø±Ø¨ÙŠ',
                    description: 'Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙˆØ§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ',
                    difficulty: 'medium',
                    questions: 20,
                    time: 30,
                    subject: 'ØªØ§Ø±ÙŠØ®'
                },
                {
                    id: 'sample3',
                    title: 'Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©',
                    description: 'Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ§Ù„Ù‡Ù†Ø¯Ø³Ø©',
                    difficulty: 'easy',
                    questions: 10,
                    time: 20,
                    subject: 'Ø±ÙŠØ§Ø¶ÙŠØ§Øª'
                },
                {
                    id: 'sample4',
                    title: 'Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§',
                    description: 'Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© ÙˆØ§Ù„Ø¨Ø´Ø±ÙŠØ©',
                    difficulty: 'hard',
                    questions: 25,
                    time: 35,
                    subject: 'Ø¬ØºØ±Ø§ÙÙŠØ§'
                }
            ];
            
            const content = `
                <div style="max-width: 1000px; margin: 0 auto;">
                    <h1 style="color: var(--neon-blue); margin-bottom: 30px; font-size: 36px;">
                        <i class="fas fa-book"></i> Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
                    </h1>
                    
                    <div style="background: var(--gradient-card); border-radius: 20px; padding: 30px; margin-bottom: 30px; border: 2px solid rgba(0,245,255,0.2);">
                        <h3 style="color: var(--neon-blue); margin-bottom: 25px;">
                            <i class="fas fa-star"></i> Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¬Ø§Ù‡Ø²Ø©
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            ${sampleTests.map(test => `
                                <div class="quiz-card" onclick="startSampleTest('${test.id}')">
                                    <div style="font-weight: bold; color: white; font-size: 18px; margin-bottom: 10px;">${test.title}</div>
                                    <div style="color: var(--text-secondary); margin-bottom: 15px; font-size: 14px;">${test.description}</div>
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="color: var(--text-dim); font-size: 12px;">Ø§Ù„ØµØ¹ÙˆØ¨Ø©</div>
                                            <div style="color: ${test.difficulty === 'easy' ? 'var(--neon-green)' : 
                                                          test.difficulty === 'medium' ? 'var(--neon-yellow)' : 
                                                          'var(--accent)'}; font-weight: bold;">
                                                ${test.difficulty === 'easy' ? 'Ø³Ù‡Ù„' : 
                                                  test.difficulty === 'medium' ? 'Ù…ØªÙˆØ³Ø·' : 'ØµØ¹Ø¨'}
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <div style="color: var(--text-dim); font-size: 12px;">Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</div>
                                            <div style="color: var(--neon-blue); font-weight: bold;">${test.questions}</div>
                                        </div>
                                        
                                        <div>
                                            <div style="color: var(--text-dim); font-size: 12px;">Ø§Ù„ÙˆÙ‚Øª</div>
                                            <div style="color: var(--neon-purple); font-weight: bold;">${test.time} Ø¯</div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(0,245,255,0.1);">
                                        <span style="color: var(--text-secondary); font-size: 12px;">${test.subject}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="background: var(--gradient-card); border-radius: 20px; padding: 30px; border: 2px solid rgba(0,245,255,0.2);">
                        <h3 style="color: var(--neon-green); margin-bottom: 20px;">
                            <i class="fas fa-lightbulb"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø®ØµØµØ©
                        </h3>
                        <div style="color: var(--text-secondary); margin-bottom: 25px; line-height: 1.6;">
                            Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø®ØµØµØ© ØªÙ†Ø§Ø³Ø¨ Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©. 
                            Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø£Ù‡Ù… Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØªÙˆÙ„ÙŠØ¯ Ø£Ø³Ø¦Ù„Ø© Ø°ÙƒÙŠØ©.
                        </div>
                        <button class="btn btn-primary" onclick="loadTestGenerator()" style="padding: 15px 30px;">
                            <i class="fas fa-magic"></i> Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('content-area').innerHTML = content;
        }

        function startSampleTest(testId) {
            // ÙÙŠ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠØŒ Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø§Ø®ØªØ¨Ø§Ø±Ø§Ù‹ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
            const sampleTest = {
                id: 'sample_test',
                title: 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø¹Ø§Ù…Ø©',
                description: 'Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ Ø§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø¹Ø§Ù…Ø© ÙŠØªØ¶Ù…Ù† Ø£Ø³Ø¦Ù„Ø© Ù…ØªÙ†ÙˆØ¹Ø©',
                questions: [
                    {
                        id: 'q1',
                        type: 'multiple_choice',
                        text: 'Ù…Ø§ Ù‡Ùˆ Ø§Ù„ØºØ§Ø² Ø§Ù„Ø°ÙŠ ØªØ´ØªØ¹Ù„ ÙÙŠÙ‡ Ø§Ù„Ù…ÙˆØ§Ø¯ØŸ',
                        options: ['Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†', 'Ø§Ù„Ù‡ÙŠØ¯Ø±ÙˆØ¬ÙŠÙ†', 'Ø§Ù„Ù†ØªØ±ÙˆØ¬ÙŠÙ†', 'Ø«Ø§Ù†ÙŠ Ø£ÙƒØ³ÙŠØ¯ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†'],
                        correctAnswer: 0,
                        explanation: 'Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ† Ù‡Ùˆ ØºØ§Ø² ÙŠØ³Ø§Ø¹Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø´ØªØ¹Ø§Ù„.',
                        difficulty: 'easy',
                        points: 1
                    },
                    {
                        id: 'q2',
                        type: 'true_false',
                        text: 'Ø§Ù„Ù…Ø§Ø¡ ÙŠØªÙƒÙˆÙ† Ù…Ù† Ø°Ø±ØªÙŠ Ù‡ÙŠØ¯Ø±ÙˆØ¬ÙŠÙ† ÙˆØ°Ø±Ø© Ø£ÙƒØ³Ø¬ÙŠÙ†',
                        options: ['ØµØ­ÙŠØ­', 'Ø®Ø·Ø£'],
                        correctAnswer: 0,
                        explanation: 'Ø§Ù„ØµÙŠØºØ© Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ© Ù„Ù„Ù…Ø§Ø¡ Ù‡ÙŠ Hâ‚‚O Ø£ÙŠ Ø°Ø±ØªÙŠ Ù‡ÙŠØ¯Ø±ÙˆØ¬ÙŠÙ† ÙˆØ°Ø±Ø© Ø£ÙƒØ³Ø¬ÙŠÙ†.',
                        difficulty: 'easy',
                        points: 1
                    },
                    {
                        id: 'q3',
                        type: 'multiple_choice',
                        text: 'Ø£ÙŠ Ù…Ù† Ø§Ù„ÙƒÙˆØ§ÙƒØ¨ Ø§Ù„ØªØ§Ù„ÙŠØ© ÙŠØ¹Ø±Ù Ø¨Ø§Ù„ÙƒÙˆÙƒØ¨ Ø§Ù„Ø£Ø­Ù…Ø±ØŸ',
                        options: ['Ø§Ù„Ù…Ø±ÙŠØ®', 'Ø§Ù„Ø²Ù‡Ø±Ø©', 'Ø§Ù„Ù…Ø´ØªØ±ÙŠ', 'Ø²Ø­Ù„'],
                        correctAnswer: 0,
                        explanation: 'Ø§Ù„Ù…Ø±ÙŠØ® ÙŠØ¹Ø±Ù Ø¨Ø§Ù„ÙƒÙˆÙƒØ¨ Ø§Ù„Ø£Ø­Ù…Ø± Ø¨Ø³Ø¨Ø¨ Ù„ÙˆÙ†Ù‡ Ø§Ù„Ù…Ø§Ø¦Ù„ Ù„Ù„Ø­Ù…Ø±Ø©.',
                        difficulty: 'medium',
                        points: 2
                    }
                ],
                settings: {
                    difficulty: 'medium',
                    timeLimit: 30,
                    passingScore: 70,
                    questionCount: 3,
                    generatedAt: new Date().toISOString()
                }
            };
            
            currentTest = sampleTest;
            currentAnswers = new Array(sampleTest.questions.length).fill(null);
            displayTest(sampleTest);
            showNotification('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠ', 'success');
        }

        async function loadProgress() {
            const stats = userData.stats || {};
            
            const content = `
                <div style="max-width: 1000px; margin: 0 auto;">
                    <h1 style="color: var(--neon-blue); margin-bottom: 30px; font-size: 36px;">
                        <i class="fas fa-chart-line"></i> Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ
                    </h1>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; margin-bottom: 40px;">
                        <div class="dashboard-section">
                            <h3 style="color: var(--neon-blue); margin-bottom: 20px;">
                                <i class="fas fa-trophy"></i> Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªÙ‚Ø¯Ù…
                            </h3>
                            <div style="text-align: center;">
                                <div class="score-circle" style="margin: 0 auto 20px;">
                                    ${stats.level || 1}
                                </div>
                                <div style="color: white; font-size: 20px; font-weight: bold; margin-bottom: 10px;">Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${stats.level || 1}</div>
                                <div style="color: var(--text-secondary);">${stats.totalXP || 0} Ù†Ù‚Ø·Ø© Ø®Ø¨Ø±Ø©</div>
                                
                                <div style="margin-top: 20px;">
                                    <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 5px;">Ø§Ù„ØªÙ‚Ø¯Ù… Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ ${(stats.level || 1) + 1}</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${((stats.totalXP || 0) % 100)}%"></div>
                                    </div>
                                    <div style="color: var(--text-dim); font-size: 11px; margin-top: 5px;">${((stats.totalXP || 0) % 100)}/100 Ù†Ù‚Ø·Ø©</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-section">
                            <h3 style="color: var(--neon-green); margin-bottom: 20px;">
                                <i class="fas fa-chart-bar"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                            </h3>
                            <div style="margin-bottom: 25px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(0,245,255,0.1);">
                                    <span style="color: var(--text-secondary);">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©:</span>
                                    <span style="color: var(--neon-green); font-weight: bold;">${stats.testsTaken || 0}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(0,245,255,0.1);">
                                    <span style="color: var(--text-secondary);">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø´Ø£Ø©:</span>
                                    <span style="color: var(--neon-blue); font-weight: bold;">${stats.testsCreated || 0}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(0,245,255,0.1);">
                                    <span style="color: var(--text-secondary);">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù†ØªØ§Ø¦Ø¬:</span>
                                    <span style="color: var(--neon-purple); font-weight: bold;">${(stats.averageScore || 0).toFixed(1)}%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©:</span>
                                    <span style="color: var(--neon-yellow); font-weight: bold;">${(stats.bestScore || 0).toFixed(1)}%</span>
                                </div>
                            </div>
                            
                            <div style="margin-top: 20px; text-align: center;">
                                <div style="color: var(--text-secondary); margin-bottom: 10px;">Ù…Ø¹Ø¯Ù„ Ù†Ø¬Ø§Ø­Ùƒ</div>
                                <div class="score-circle" style="width: 80px; height: 80px; font-size: 24px; margin: 0 auto;">
                                    ${(stats.averageScore || 0).toFixed(0)}%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-section" style="margin-bottom: 30px;">
                        <h3 style="color: var(--neon-purple); margin-bottom: 20px;">
                            <i class="fas fa-award"></i> Ø§Ù„Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©
                        </h3>
                        <div style="color: var(--text-secondary); line-height: 1.8; font-size: 14px;">
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <i class="fas fa-check-circle" style="color: var(--neon-green); margin-left: 10px;"></i>
                                <span>Ø¥Ù†Ø´Ø§Ø¡ 5 Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø°ÙƒÙŠØ©</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <i class="fas fa-check-circle" style="color: ${(stats.testsTaken || 0) >= 10 ? 'var(--neon-green)' : 'var(--text-dim)'}; margin-left: 10px;"></i>
                                <span>Ø­Ù„ 10 Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø¨Ù†Ø³Ø¨Ø© Ù†Ø¬Ø§Ø­ 80% ÙØ£ÙƒØ«Ø±</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <i class="fas fa-check-circle" style="color: ${(stats.level || 1) >= 5 ? 'var(--neon-green)' : 'var(--text-dim)'}; margin-left: 10px;"></i>
                                <span>Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 5</span>
                            </div>
                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                <i class="fas fa-check-circle" style="color: ${(stats.totalXP || 0) >= 500 ? 'var(--neon-green)' : 'var(--text-dim)'}; margin-left: 10px;"></i>
                                <span>Ø§ÙƒØªØ³Ø§Ø¨ 500 Ù†Ù‚Ø·Ø© Ø®Ø¨Ø±Ø©</span>
                            </div>
                            <div style="display: flex; align-items: center;">
                                <i class="fas fa-check-circle" style="color: var(--text-dim); margin-left: 10px;"></i>
                                <span>ÙØªØ­ 3 Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('content-area').innerHTML = content;
        }

        async function loadSettings() {
            const content = `
                <div style="max-width: 800px; margin: 0 auto;">
                    <h1 style="color: var(--neon-blue); margin-bottom: 30px; font-size: 36px;">
                        <i class="fas fa-cog"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                    </h1>
                    
                    <div class="dashboard-section" style="margin-bottom: 30px;">
                        <h3 style="color: var(--neon-blue); margin-bottom: 25px;">
                            <i class="fas fa-user"></i> Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
                        </h3>
                        
                        <div class="form-group">
                            <label style="color: var(--text-secondary); display: block; margin-bottom: 8px;">Ø§Ù„Ø§Ø³Ù…</label>
                            <input type="text" id="profile-name" class="form-control" value="${userData.name || ''}">
                        </div>
                        
                        <div class="form-group">
                            <label style="color: var(--text-secondary); display: block; margin-bottom: 8px;">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                            <input type="email" class="form-control" value="${userData.email || ''}" disabled>
                        </div>
                        
                        <button class="btn btn-primary" onclick="updateProfile()" style="width: 100%; padding: 15px; margin-top: 10px;">
                            <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
                        </button>
                    </div>
                    
                    <div class="dashboard-section" style="margin-bottom: 30px;">
                        <h3 style="color: var(--neon-green); margin-bottom: 25px;">
                            <i class="fas fa-palette"></i> Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª
                        </h3>
                        
                        <div class="form-group">
                            <label style="color: var(--text-secondary); display: block; margin-bottom: 8px;">Ø§Ù„Ù„ØºØ©</label>
                            <select id="pref-language" class="form-control">
                                <option value="ar" selected>Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                                <option value="en">Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label style="color: var(--text-secondary); display: block; margin-bottom: 8px;">Ø§Ù„ÙˆØ¶Ø¹</label>
                            <select id="pref-theme" class="form-control">
                                <option value="dark" selected>Ø¯Ø§ÙƒÙ†</option>
                                <option value="light">ÙØ§ØªØ­</option>
                            </select>
                        </div>
                        
                        <div style="margin-top: 20px;">
                            <label style="color: var(--text-secondary); cursor: pointer; display: flex; align-items: center;">
                                <input type="checkbox" id="pref-notifications" ${userData.preferences?.notifications ? 'checked' : ''} style="margin-left: 10px;">
                                ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
                            </label>
                        </div>
                        
                        <button class="btn btn-secondary" onclick="updatePreferences()" style="width: 100%; padding: 15px; margin-top: 20px;">
                            <i class="fas fa-check"></i> ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª
                        </button>
                    </div>
                    
                    <div class="dashboard-section">
                        <h3 style="color: var(--accent); margin-bottom: 25px;">
                            <i class="fas fa-shield-alt"></i> Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙˆØ§Ù„Ø£Ù…Ø§Ù†
                        </h3>
                        
                        <div style="color: var(--text-secondary); margin-bottom: 20px;">
                            <p>ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø£Ùˆ Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ù…Ù† Ù‡Ù†Ø§.</p>
                        </div>
                        
                        <button class="btn btn-secondary" onclick="changePassword()" style="width: 100%; padding: 15px; margin-bottom: 15px;">
                            <i class="fas fa-key"></i> ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                        </button>
                        
                        <button class="btn btn-danger" onclick="deleteAccount()" style="width: 100%; padding: 15px;">
                            <i class="fas fa-trash"></i> Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('content-area').innerHTML = content;
        }

        // =============== [ 6. Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ] ===============
        function showNotification(message, type = 'info') {
            // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø³Ø§Ø¨Ù‚Ø©
            const oldNotifications = document.querySelectorAll('.notification');
            oldNotifications.forEach(notif => notif.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            let icon = 'â„¹ï¸';
            if (type === 'success') icon = 'âœ…';
            if (type === 'error') icon = 'âŒ';
            if (type === 'warning') icon = 'âš ï¸';
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 20px;">${icon}</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function showLoading(message = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...') {
            Swal.fire({
                title: message,
                allowOutsideClick: false,
                showConfirmButton: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
        }

        function hideLoading() {
            Swal.close();
        }

        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                
                const size = Math.random() * 6 + 2;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.animationDelay = `${Math.random() * 15}s`;
                particle.style.animationDuration = `${Math.random() * 10 + 15}s`;
                
                const colors = ['var(--neon-blue)', 'var(--neon-purple)', 'var(--neon-green)', 'var(--accent)'];
                particle.style.background = colors[Math.floor(Math.random() * colors.length)];
                particle.style.opacity = Math.random() * 0.4 + 0.1;
                
                container.appendChild(particle);
            }
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl + N: Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯
                if (e.ctrlKey && e.key === 'n') {
                    e.preventDefault();
                    loadTestGenerator();
                }
                
                // Ctrl + D: Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                if (e.ctrlKey && e.key === 'd') {
                    e.preventDefault();
                    loadDashboard();
                }
                
                // Ctrl + H: Ø³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
                if (e.ctrlKey && e.key === 'h') {
                    e.preventDefault();
                    loadTestHistory();
                }
                
                // Ctrl + Q: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
                if (e.ctrlKey && e.key === 'q') {
                    e.preventDefault();
                    logout();
                }
            });
        }

        function checkUserSession() {
            const savedEmail = localStorage.getItem('ai_system_email');
            if (savedEmail) {
                document.getElementById('login-email').value = savedEmail;
                document.getElementById('login-password').focus();
            }
        }

        function checkChaosWord(text) {
            if (!text) return false;
            
            const now = Date.now();
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¥Ø°Ø§ Ù…Ø±Øª ÙØªØ±Ø© Ø²Ù…Ù†ÙŠØ© Ø·ÙˆÙŠÙ„Ø©
            if (now - lastChaosTime > CHAOS_RESET_TIME) {
                chaosCount = 0;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ÙƒÙ„Ù…Ø© "Ø®Ù„Ø·Ø©"
            if (text.toLowerCase().includes('Ø®Ù„Ø·Ø©')) {
                chaosCount++;
                lastChaosTime = now;
                
                if (chaosCount >= CHAOS_LIMIT) {
                    return true;
                }
            }
            
            return false;
        }

        function showChaosWarning() {
            const warning = `
                <div class="chaos-warning">
                    <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                    <div style="font-weight: bold; margin-bottom: 5px;">ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­</div>
                    <div style="font-size: 14px;">
                        Ù„Ù‚Ø¯ Ø§Ø³ØªØ®Ø¯Ù…Øª ÙƒÙ„Ù…Ø© "Ø®Ù„Ø·Ø©" Ø£ÙƒØ«Ø± Ù…Ù† ${CHAOS_LIMIT} Ù…Ø±Ø§Øª Ø®Ù„Ø§Ù„ Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©.
                        <br>
                        ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.
                    </div>
                </div>
            `;
            
            document.getElementById('content-area').innerHTML = warning + document.getElementById('content-area').innerHTML;
            
            showNotification('ØªÙ… ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­. ÙŠØ¬Ø¨ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯.', 'error');
        }

        async function updateProfile() {
            const name = document.getElementById('profile-name').value;
            
            if (!name) {
                showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…', 'error');
                return;
            }
            
            userData.name = name;
            await saveUserData();
            
            updateUserUI();
            showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        async function updatePreferences() {
            const language = document.getElementById('pref-language').value;
            const theme = document.getElementById('pref-theme').value;
            const notifications = document.getElementById('pref-notifications').checked;
            
            userData.preferences = {
                language: language,
                theme: theme,
                notifications: notifications
            };
            
            await saveUserData();
            showNotification('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙØ¶ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        async function changePassword() {
            Swal.fire({
                title: 'Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ØªØ­Øª Ø§Ù„ØªØ·ÙˆÙŠØ±',
                text: 'ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…ØªØ§Ø­ ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø¹ Ø§ØªØµØ§Ù„ Firebase.',
                icon: 'info',
                confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹'
            });
        }

        async function deleteAccount() {
            const confirm = await Swal.fire({
                title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                text: 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ ÙˆÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ.',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                reverseButtons: true,
                confirmButtonColor: '#ff006e'
            });
            
            if (confirm.isConfirmed) {
                try {
                    if (currentUser && auth) {
                        await db.ref(`users/${currentUser.uid}`).remove();
                        await currentUser.delete();
                    }
                    
                    showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                    showLoginScreen();
                } catch (error) {
                    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨:', error);
                    showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨', 'error');
                }
            }
        }

        async function quickGenerateTest() {
            const text = document.getElementById('quick-test-text')?.value;
            const questionCount = parseInt(document.getElementById('quick-question-count')?.value || 10);
            const difficulty = document.getElementById('quick-difficulty')?.value;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© "Ø®Ù„Ø·Ø©"
            if (checkChaosWord(text)) {
                showChaosWarning();
                return;
            }
            
            if (!text || text.length < 50) {
                showNotification('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ ÙƒØ§ÙÙŠ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
                return;
            }
            
            try {
                const test = await testSystem.generateTestFromText(text, {
                    count: questionCount,
                    difficulty: difficulty,
                    title: 'Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹',
                    description: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙˆÙ„Ø¯ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹'
                });
                
                currentTest = test;
                currentAnswers = new Array(test.questions.length).fill(null);
                
                displayTest(test);
                showNotification('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø±ÙŠØ¹:', error);
                showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'error');
            }
        }

        // =============== [ 7. ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù… ] ===============
        window.login = login;
        window.logout = logout;
        window.showRegister = showRegister;
        window.loadDashboard = loadDashboard;
        window.loadTestGenerator = loadTestGenerator;
        window.loadTestHistory = loadTestHistory;
        window.loadTestLibrary = loadTestLibrary;
        window.loadProgress = loadProgress;
        window.loadSettings = loadSettings;
        window.switchTestTab = switchTestTab;
        window.generateTestFromText = generateTestFromText;
        window.generateTestFromImage = generateTestFromImage;
        window.generateTestFromTopic = generateTestFromTopic;
        window.handleImageUpload = handleImageUpload;
        window.clearImage = clearImage;
        window.selectAnswer = selectAnswer;
        window.submitTest = submitTest;
        window.reviewAnswers = reviewAnswers;
        window.updateProfile = updateProfile;
        window.updatePreferences = updatePreferences;
        window.changePassword = changePassword;
        window.deleteAccount = deleteAccount;
        window.quickGenerateTest = quickGenerateTest;
        window.startSampleTest = startSampleTest;
        window.viewTestHistory = viewTestHistory;
        window.showTestAnalysis = showTestAnalysis;
        window.addManualQuestionField = addManualQuestionField;
        window.generateManualTest = generateManualTest;

        console.log('ğŸš€ Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø®Ø§Ø±Ù‚ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„!');
        console.log('ğŸ“Š Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ¯Ø¹Ù…:');
        console.log('- ØªÙˆÙ„ÙŠØ¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø°ÙƒÙŠØ© Ù…Ù† Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©');
        console.log('- ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ ÙˆØ§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø© ÙÙ‚Ø·');
        console.log('- ØªØ¬Ù†Ø¨ Ø§Ù„Ø­Ø´Ùˆ ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ù‡Ù…Ø©');
        console.log('- ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© ØµØ­/Ø®Ø·Ø£ Ù…Ø¹ Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„ÙÙˆØ±ÙŠ');
        console.log('- Ù†Ø¸Ø§Ù… Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙˆØ§Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ø°ÙƒÙŠØ©');
        console.log('- ÙˆØ§Ø¬Ù‡Ø© Ø¹Ø±Ø¨ÙŠØ© ÙƒØ§Ù…Ù„Ø© ÙˆØªØµÙ…ÙŠÙ… Ø¹ØµØ±ÙŠ');
                // --- ÙƒÙˆØ¯ Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ù‚Ù„ ÙˆØ§Ù„Ø°Ø§ÙƒØ±Ø© ---
let navigationHistory = []; 
let currentPage = localStorage.getItem('last_active_page') || 'dashboard'; 

async function navigateTo(pageName, saveToHistory = true) {
    if (saveToHistory && currentPage !== pageName) {
        navigationHistory.push(currentPage);
    }
    currentPage = pageName;
    localStorage.setItem('last_active_page', pageName); 

    // Ø¥Ø¸Ù‡Ø§Ø± Ø³Ù‡Ù… Ø§Ù„Ø±Ø¬ÙˆØ¹ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
    const backBtn = document.getElementById('back-button');
    if (backBtn) {
        if (navigationHistory.length > 0) backBtn.classList.remove('hidden');
        else backBtn.classList.add('hidden');
    }

    // Ù†Ø¯Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„ÙØªØ­ Ø§Ù„ØµÙØ­Ø§Øª
    if (pageName === 'dashboard') loadDashboard();
    else if (pageName === 'generator') loadTestGenerator();
    else if (pageName === 'history') loadTestHistory();
    else if (pageName === 'library') loadTestLibrary();
    else if (pageName === 'progress') loadProgress();
    else if (pageName === 'settings') loadSettings();
}

function goBack() {
    if (navigationHistory.length > 0) {
        const previousPage = navigationHistory.pop();
        navigateTo(previousPage, false);
    }
}

// ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ù„Ø¹Ù…Ù„ Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
window.navigateTo = navigateTo;
window.goBack = goBack;
        async function handleUserProgress(evaluation) {
    if (!userData.stats) userData.stats = { totalXP: 0, level: 1, testsTaken: 0, averageScore: 0, bestScore: 0 };
    if (!userData.tests) userData.tests = [];

    // 1. Ø­Ø³Ø§Ø¨ Ù†Ù‚Ø§Ø· Ø§Ù„Ø®Ø¨Ø±Ø© (XP)
    let gainedXP = 50; // Ù†Ù‚Ø§Ø· Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
    if (evaluation.passed) gainedXP += 50; // Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
    
    // Ù…ÙƒØ§ÙØ£Ø© Ø®Ø§ØµØ© Ù„Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© 100%
    let isPerfect = parseFloat(evaluation.percentage) === 100;
    if (isPerfect) {
        gainedXP += 200; // Ù…ÙƒØ§ÙØ£Ø© Ø¶Ø®Ù…Ø© Ù„Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©
    }

    // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    userData.stats.totalXP = (userData.stats.totalXP || 0) + gainedXP;
    userData.stats.testsTaken = (userData.stats.testsTaken || 0) + 1;
    
    // ØªØ­Ø¯ÙŠØ« Ø£ÙØ¶Ù„ Ø¯Ø±Ø¬Ø©
    if (parseFloat(evaluation.percentage) > (userData.stats.bestScore || 0)) {
        userData.stats.bestScore = parseFloat(evaluation.percentage);
    }

    // 3. Ù†Ø¸Ø§Ù… Ø±ÙØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª (ÙƒÙ„ 500 Ù†Ù‚Ø·Ø© Ù…Ø³ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯)
    const oldLevel = userData.stats.level || 1;
    const newLevel = Math.floor(userData.stats.totalXP / 500) + 1;
    
    if (newLevel > oldLevel) {
        userData.stats.level = newLevel;
        // Ø¥Ø´Ø¹Ø§Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
        setTimeout(() => {
            Swal.fire({
                title: 'ğŸ‰ Ù…Ø³ØªÙˆÙ‰ Ø¬Ø¯ÙŠØ¯!',
                text: `Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${newLevel}`,
                icon: 'success',
                confirmButtonText: 'Ø±Ø§Ø¦Ø¹'
            });
        }, 1500);
    }

    // 4. Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    const testRecord = {
        id: currentTest.id,
        title: currentTest.title,
        score: evaluation.percentage,
        correctAnswers: evaluation.correctAnswers,
        totalQuestions: evaluation.totalQuestions,
        date: new Date().toISOString(),
        result: evaluation.passed ? 'Ù†Ø§Ø¬Ø­' : 'Ø±Ø§Ø³Ø¨',
        status: 'completed'
    };
    
    userData.tests.unshift(testRecord); // Ø¥Ø¶Ø§ÙØ© ÙÙŠ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©

    // 5. Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase ÙˆØ§Ù„Ù…ØªØµÙØ­
    await saveUserData();
    updateUserUI(); // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ù…Ø³ØªÙˆÙ‰ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± ÙÙˆØ±Ø§Ù‹
    
    if (isPerfect) {
        showNotification('ğŸ† Ù…Ø°Ù‡Ù„! Ø¯Ø±Ø¬Ø© ÙƒØ§Ù…Ù„Ø© ÙˆÙ…ÙƒØ§ÙØ£Ø© XP Ù…Ø¶Ø§Ø¹ÙØ©!', 'success');
    }
}
        // Ø¯Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ
async function loadManualTabContent() {
    return `
        <div id="manual-tab-content">
            <h3 style="color: var(--neon-blue); margin-bottom: 20px;"><i class="fas fa-edit"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± ÙŠØ¯ÙˆÙŠ</h3>
            <div class="form-group">
                <input type="text" id="manual-test-title" class="form-control" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ù…Ø«Ù„Ø§Ù‹: Ù…Ø±Ø§Ø¬Ø¹Ø© Ù†Ù‡Ø§Ø¦ÙŠØ©)">
            </div>
            <div id="manual-questions-list">
                <div class="manual-q-item" style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(0,245,255,0.2);">
                    <input type="text" class="form-control q-text" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§..." style="margin-bottom: 10px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" class="form-control q-opt" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©">
                        <input type="text" class="form-control q-opt" placeholder="Ø®ÙŠØ§Ø± Ø®Ø·Ø£ 1">
                        <input type="text" class="form-control q-opt" placeholder="Ø®ÙŠØ§Ø± Ø®Ø·Ø£ 2">
                        <input type="text" class="form-control q-opt" placeholder="Ø®ÙŠØ§Ø± Ø®Ø·Ø£ 3">
                    </div>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="addManualQuestionField()" style="width: 100%; margin-bottom: 15px;">+ Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¢Ø®Ø±</button>
            <button class="btn btn-primary" onclick="generateManualTest()" style="width: 100%; padding: 15px;">Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†</button>
        </div>
    `;
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯
function addManualQuestionField() {
    const div = document.createElement('div');
    div.className = "manual-q-item";
    div.style = "background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(0,245,255,0.2);";
    div.innerHTML = `
        <input type="text" class="form-control q-text" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§..." style="margin-bottom: 10px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="text" class="form-control q-opt" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©">
            <input type="text" class="form-control q-opt" placeholder="Ø®ÙŠØ§Ø± Ø®Ø·Ø£ 1">
            <input type="text" class="form-control q-opt" placeholder="Ø®ÙŠØ§Ø± Ø®Ø·Ø£ 2">
            <input type="text" class="form-control q-opt" placeholder="Ø®ÙŠØ§Ø± Ø®Ø·Ø£ 3">
        </div>
    `;
    document.getElementById('manual-questions-list').appendChild(div);
}

// Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ù…Ø§ ÙƒØªØ¨ØªÙ‡ Ø¥Ù„Ù‰ Ø§Ø®ØªØ¨Ø§Ø± Ø­Ù‚ÙŠÙ‚ÙŠ
async function generateManualTest() {
    const title = document.getElementById('manual-test-title').value || "Ø§Ø®ØªØ¨Ø§Ø± ÙŠØ¯ÙˆÙŠ";
    const items = document.querySelectorAll('.manual-q-item');
    const questions = [];

    items.forEach(item => {
        const text = item.querySelector('.q-text').value;
        const opts = Array.from(item.querySelectorAll('.q-opt')).map(i => i.value).filter(v => v !== "");
        if (text && opts.length >= 2) {
            const correctText = opts[0]; // Ø§Ù„Ø£ÙˆÙ„ Ù‡Ùˆ Ø§Ù„ØµØ­ÙŠØ­ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            const shuffled = [...opts].sort(() => Math.random() - 0.5); // Ø®Ù„Ø·Ù‡Ù…
            questions.push({
                type: 'multiple_choice',
                text: text,
                options: shuffled,
                correctAnswer: shuffled.indexOf(correctText),
                explanation: "Ø³Ø¤Ø§Ù„ ÙŠØ¯ÙˆÙŠ",
                points: 2
            });
        }
    });

    if (questions.length === 0) return showNotification('Ø£Ø¶Ù Ø³Ø¤Ø§Ù„Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!', 'error');

    currentTest = { id: 'm_'+Date.now(), title: title, questions: questions, settings: { difficulty: 'manual', passingScore: 70 } };
    currentAnswers = new Array(questions.length).fill(null);
    displayTest(currentTest);
}
        // 1. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ÙˆÙ…Ø¹Ø§ÙŠÙ†ØªÙ‡Ø§
function handleImageUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('preview-img').src = e.target.result;
            document.getElementById('image-preview-area').style.display = 'block';
            document.getElementById('ocr-btn').disabled = false; // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø±
        }
        reader.readAsDataURL(file);
    }
}

// 2. Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Ø§Ø®ØªØ¨Ø§Ø±
async function generateTestFromImage() {
    const fileInput = document.getElementById('image-file-input');
    const lang = document.getElementById('ocr-lang').value;
    
    if (!fileInput.files[0]) return;

    showLoading('Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ...');

    try {
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Tesseract.js Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ
        const result = await Tesseract.recognize(
            fileInput.files[0],
            lang,
            { logger: m => console.log(m) } // Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
        );

        const extractedText = result.data.text;

        if (extractedText.length < 50) {
            hideLoading();
            showNotification('Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø¬ÙˆØ¯Ø© Ø§Ù„ØµÙˆØ±Ø©', 'error');
            return;
        }

        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ¨Ø¯Ø¡ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ù„Ø¯ÙŠÙƒ
        showLoading('ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ! Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...');
        
        const test = await testSystem.generateTestFromText(extractedText, {
            count: 10,
            difficulty: 'medium',
            title: 'Ø§Ø®ØªØ¨Ø§Ø± Ù…Ù† ØµÙˆØ±Ø© Ù…Ø³ØªØ®Ø±Ø¬Ø©'
        });

        currentTest = test;
        currentAnswers = new Array(test.questions.length).fill(null);
        
        hideLoading();
        displayTest(test);
        showNotification('ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­!', 'success');

    } catch (error) {
        hideLoading();
        console.error('OCR Error:', error);
        showNotification('ÙØ´Ù„ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
    }
}
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø°ÙƒÙŠ | Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨</title>
    
    <!-- Ø®Ø·ÙˆØ· Ø¹Ø±Ø¨ÙŠØ© -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;500;800&display=swap" rel="stylesheet">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    
    <!-- UI Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* ========== Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ========== */
        :root {
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.95);
            --primary: #3b82f6;
            --accent: #f59e0b;
            --neon-blue: #00f3ff;
            --text-main: #f8fafc;
            --text-sec: #94a3b8;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --red: #ef4444; 
            --green: #10b981; 
            --purple: #8b5cf6;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
        }
        
        body {
            font-family: 'Tajawal', sans-serif; 
            margin: 0;
            background: radial-gradient(circle at top, #1e293b, #0f172a); 
            color: var(--text-main);
            padding-bottom: 90px;
            min-height: 100vh;
            user-select: none;
            overflow-x: hidden;
        }

        .hidden { display: none !important; }
        
        /* ========== Ø§Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ø¨Ø­Ø« ========== */
        header {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(12px);
            padding: 15px 20px;
            position: sticky; 
            top: 0; 
            z-index: 1000;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .header-top { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            width: 100%; 
            margin-bottom: 10px;
        }
        
        .search-container { 
            position: relative; 
            width: 100%; 
        }
        
        .search-container input {
            width: 100%; 
            padding: 12px 45px 12px 15px;
            border-radius: 15px; 
            border: 1px solid var(--border);
            font-size: 14px; 
            background: var(--glass); 
            color: white;
            transition: 0.3s; 
            font-family: 'Tajawal';
        }
        
        .search-container input:focus { 
            background: rgba(255,255,255,0.1); 
            border-color: var(--neon-blue); 
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); 
        }
        
        .search-container i { 
            position: absolute; 
            right: 15px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: var(--accent); 
        }

        /* ========== Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ø¬Ø±ÙŠØ¯ ========== */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 15px; 
            padding: 15px; 
        }
        
        .card { 
            background: var(--bg-card); 
            border-radius: 18px; 
            padding: 20px; 
            text-align: center; 
            border: 1px solid var(--border); 
            transition: 0.3s; 
            position: relative; 
            overflow: hidden; 
            backdrop-filter: blur(5px); 
            color: var(--text-main); 
            cursor: pointer;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .card:active { transform: scale(0.96); }
        
        .card:hover { 
            border-color: var(--neon-blue); 
            box-shadow: 0 5px 20px rgba(0, 243, 255, 0.15); 
            transform: translateY(-5px); 
        }
        
        .card i { 
            font-size: 32px; 
            margin-bottom: 10px; 
            background: linear-gradient(45deg, #fff, #aaa); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
        }
        
        .card-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: var(--accent);
            color: black;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 10px;
            font-weight: bold;
        }

        /* ========== Ø§Ù„Ø£Ø²Ø±Ø§Ø± ========== */
        .btn-main { 
            background: linear-gradient(90deg, var(--primary), #2563eb); 
            color: white; 
            border: none; 
            padding: 15px; 
            width: 100%; 
            border-radius: 12px; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 16px; 
            margin-top: 10px; 
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); 
            transition: 0.3s; 
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-main:hover { opacity: 0.9; }
        
        .btn-secondary { 
            background: transparent; 
            border: 1px solid var(--text-sec); 
            color: var(--text-sec); 
            width: 100%; 
            padding: 12px; 
            border-radius: 10px; 
            margin-top: 10px; 
            cursor: pointer; 
        }
        
        .btn-danger { 
            background: var(--red); 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 10px; 
            cursor: pointer; 
        }
        
        .btn-success { 
            background: var(--green); 
            color: white; 
            border: none; 
            padding: 12px; 
            border-radius: 10px; 
            cursor: pointer; 
        }

        /* ========== Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ========== */
        input, textarea, select { 
            width: 100%; 
            padding: 15px; 
            margin: 8px 0; 
            background: rgba(0,0,0,0.2); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            color: white; 
            font-family: 'Tajawal'; 
            box-sizing: border-box; 
        }
        
        input:focus, textarea:focus, select:focus { 
            border-color: var(--accent); 
            outline: none; 
            background: rgba(0,0,0,0.4); 
        }

        /* ========== Ø§Ù„Ù…Ù†Ø´ÙˆØ±Ø§Øª ÙˆØ§Ù„ÙƒØªØ¨ ========== */
        .post { 
            background: var(--bg-card); 
            margin: 15px; 
            border-radius: 20px; 
            overflow: hidden; 
            border: 1px solid var(--border); 
            animation: fadeIn 0.5s ease; 
            position: relative; 
        }
        
        .book-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border);
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .book-cover {
            width: 80px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            border: 1px solid var(--accent);
        }
        
        .grade-badge {
            background: var(--purple);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 5px;
        }

        /* ========== Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ© ========== */
        .bottom-tabs {
            position: fixed; 
            bottom: 20px; 
            left: 20px; 
            right: 20px; 
            background: rgba(30, 41, 59, 0.95); 
            backdrop-filter: blur(15px); 
            border-radius: 25px; 
            display: flex; 
            justify-content: space-around; 
            padding: 12px 0; 
            box-shadow: var(--shadow);
            border: 1px solid var(--border); 
            z-index: 1000;
        }
        
        .tab-btn { 
            color: var(--text-sec); 
            text-align: center; 
            font-size: 10px; 
            transition: 0.3s; 
            position: relative; 
            flex: 1; 
            cursor: pointer; 
        }
        
        .tab-btn i { 
            font-size: 22px; 
            margin-bottom: 4px; 
            display: block; 
            transition: 0.3s; 
        }
        
        .tab-btn.active { color: var(--neon-blue); }
        .tab-btn.active i { transform: translateY(-5px); text-shadow: 0 0 10px var(--neon-blue); }

        /* ========== Ø´Ø§Ø´Ø§Øª Ø®Ø§ØµØ© ========== */
        .live-room {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 20px;
            margin: 15px;
            color: white;
        }
        
        .payment-method {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid var(--green);
        }
        
        .admin-panel {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid var(--red);
            border-radius: 15px;
            padding: 20px;
            margin: 15px;
        }

        /* ========== Ø§Ù„ØªØ­Ù…ÙŠÙ„ ========== */
        .loading { 
            text-align: center; 
            padding: 40px; 
            color: var(--text-sec); 
        }
        
        .loading-spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ========== Ù…ØªØ¬Ø§ÙˆØ¨ ========== */
        @media (max-width: 768px) {
            .grid { grid-template-columns: repeat(2, 1fr); }
            .bottom-tabs { left: 10px; right: 10px; bottom: 10px; }
            .card { padding: 15px; min-height: 130px; }
            .card i { font-size: 28px; }
        }
        
        @media (max-width: 480px) {
            .grid { grid-template-columns: 1fr; }
            header { padding: 12px 15px; }
        }
    </style>
</head>
<body>
<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
<div id="main-preloader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#0f172a; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:99999;">
    <div class="loading-spinner"></div>
    <p style="color:white; font-family:'Tajawal'; margin-top:15px; font-size:18px;">Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ ÙŠØ¬Ù‡Ø² Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ…...</p>
</div>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
<div id="register-screen" class="hidden">
    <div style="padding:40px; text-align:center; height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div style="width:120px; height:120px; border-radius:50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display:flex; align-items:center; justify-content:center; margin-bottom:30px;">
            <i class="fas fa-graduation-cap" style="font-size:50px; color:white;"></i>
        </div>
        <h1 style="font-size: 42px; margin-bottom:10px; background: linear-gradient(45deg, var(--neon-blue), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight:800;">Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø°ÙƒÙŠ</h1>
        <p style="color:var(--text-sec); margin-bottom:40px; font-size:16px;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</p>
        
        <div style="width:100%; max-width:400px;">
            <button class="btn-main" onclick="showStudentForm()" style="margin-bottom:15px;">
                <i class="fas fa-user-graduate"></i> Ø£Ù†Ø§ Ø·Ø§Ù„Ø¨
            </button>
            
            <button class="btn-secondary" onclick="showTeacherForm()">
                <i class="fas fa-chalkboard-teacher"></i> Ø£Ù†Ø§ Ø£Ø³ØªØ§Ø°
            </button>
        </div>
    </div>
</div>

<!-- Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ -->
<div id="student-form" class="hidden">
    <div style="padding:20px;">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:30px;">
            <button class="btn-secondary" onclick="backToRegister()" style="width:auto; padding:10px 15px;">
                <i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹
            </button>
            <h2 style="color:var(--neon-blue); margin:0;">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø·Ø§Ù„Ø¨</h2>
        </div>
        
        <div style="background:var(--bg-card); padding:25px; border-radius:20px;">
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-user"></i> Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *
                </label>
                <input type="text" id="student-name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„" required>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-calendar"></i> Ø¹Ù…Ø±Ùƒ *
                </label>
                <select id="student-age" required>
                    <option value="">Ø§Ø®ØªØ± Ø¹Ù…Ø±Ùƒ</option>
                    <option value="6">6 Ø³Ù†ÙˆØ§Øª</option>
                    <option value="7">7 Ø³Ù†ÙˆØ§Øª</option>
                    <option value="8">8 Ø³Ù†ÙˆØ§Øª</option>
                    <option value="9">9 Ø³Ù†ÙˆØ§Øª</option>
                    <option value="10">10 Ø³Ù†ÙˆØ§Øª</option>
                    <option value="11">11 Ø³Ù†ÙˆØ§Øª</option>
                    <option value="12">12 Ø³Ù†ÙˆØ§Øª</option>
                    <option value="13">13 Ø³Ù†ÙˆØ§Øª</option>
                    <option value="14">14 Ø³Ù†ÙˆØ§Øª</option>
                    <option value="15">15 Ø³Ù†ÙˆØ§Øª</option>
                    <option value="16">16 Ø³Ù†ÙˆØ§Øª</option>
                    <option value="17">17 Ø³Ù†ÙˆØ§Øª</option>
                    <option value="18">18 Ø³Ù†Ø© ÙØ£ÙƒØ«Ø±</option>
                </select>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-graduation-cap"></i> Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ *
                </label>
                <select id="student-grade" required>
                    <option value="">Ø§Ø®ØªØ± ØµÙÙƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</option>
                    <option value="Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                    <option value="Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                    <option value="Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                    <option value="Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                    <option value="Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                    <option value="Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                    <option value="Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø·">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø·</option>
                    <option value="Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ù…ØªÙˆØ³Ø·">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ù…ØªÙˆØ³Ø·</option>
                    <option value="Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø·">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø·</option>
                    <option value="Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                    <option value="Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                    <option value="Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                </select>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-book"></i> Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ÙØ¶Ù„Ø© *
                </label>
                <div id="favorite-subjects" style="display:grid; grid-template-columns:repeat(2, 1fr); gap:10px;">
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" value="Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª" class="subject-checkbox">
                        <span>Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" value="Ø§Ù„Ø¹Ù„ÙˆÙ…" class="subject-checkbox">
                        <span>Ø§Ù„Ø¹Ù„ÙˆÙ…</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" value="Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©" class="subject-checkbox">
                        <span>Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" value="Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©" class="subject-checkbox">
                        <span>Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" value="Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª" class="subject-checkbox">
                        <span>Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª</span>
                    </label>
                    <label style="display:flex; align-items:center; gap:8px;">
                        <input type="checkbox" value="Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©" class="subject-checkbox">
                        <span>Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</span>
                    </label>
                </div>
            </div>
            
            <button class="btn-main" onclick="registerStudent()">
                <i class="fas fa-check"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø·Ø§Ù„Ø¨
            </button>
        </div>
    </div>
</div>

<!-- Ù†Ù…ÙˆØ°Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø³ØªØ§Ø° -->
<div id="teacher-form" class="hidden">
    <div style="padding:20px;">
        <div style="display:flex; align-items:center; gap:15px; margin-bottom:30px;">
            <button class="btn-secondary" onclick="backToRegister()" style="width:auto; padding:10px 15px;">
                <i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹
            </button>
            <h2 style="color:var(--neon-blue); margin:0;">ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø§Ø¨ Ø£Ø³ØªØ§Ø°</h2>
        </div>
        
        <div style="background:var(--bg-card); padding:25px; border-radius:20px;">
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-user"></i> Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ *
                </label>
                <input type="text" id="teacher-name" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„" required>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-book"></i> Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© *
                </label>
                <select id="teacher-subject" required>
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ØªÙŠ ØªØ¯Ø±Ø³Ù‡Ø§</option>
                    <option value="Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª">Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option>
                    <option value="Ø§Ù„Ø¹Ù„ÙˆÙ…">Ø§Ù„Ø¹Ù„ÙˆÙ…</option>
                    <option value="Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                    <option value="Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©">Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</option>
                    <option value="Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡">Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡</option>
                    <option value="Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡">Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡</option>
                    <option value="Ø§Ù„Ø£Ø­ÙŠØ§Ø¡">Ø§Ù„Ø£Ø­ÙŠØ§Ø¡</option>
                    <option value="Ø§Ù„ØªØ§Ø±ÙŠØ®">Ø§Ù„ØªØ§Ø±ÙŠØ®</option>
                    <option value="Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§">Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§</option>
                    <option value="Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©">Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</option>
                    <option value="Ø§Ù„Ø­Ø§Ø³ÙˆØ¨">Ø§Ù„Ø­Ø§Ø³ÙˆØ¨</option>
                </select>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-graduation-cap"></i> Ø§Ù„ØµÙÙˆÙ Ø§Ù„ØªÙŠ ØªØ¯Ø±Ø³Ù‡Ø§ *
                </label>
                <select id="teacher-grades" multiple style="height:120px;">
                    <option value="Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ</option>
                    <option value="Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                    <option value="Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                    <option value="Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                    <option value="Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                    <option value="Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                    <option value="Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                    <option value="Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø·">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø·</option>
                    <option value="Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ù…ØªÙˆØ³Ø·">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ù…ØªÙˆØ³Ø·</option>
                    <option value="Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø·">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø·</option>
                    <option value="Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                    <option value="Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                    <option value="Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                </select>
                <small style="color:var(--text-sec);">Ø§Ø¶ØºØ· Ctrl Ù„ØªØ­Ø¯ÙŠØ¯ Ø£ÙƒØ«Ø± Ù…Ù† ØµÙ</small>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-phone"></i> Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„ØªÙˆØ§ØµÙ„ *
                </label>
                <input type="tel" id="teacher-whatsapp" placeholder="Ù…Ø«Ø§Ù„: 0912345678" required>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-id-card"></i> ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ø®ØµÙŠØ© Ø£Ùˆ Ø§Ù„Ø±Ø®ØµØ© *
                </label>
                <input type="file" id="teacher-id" accept="image/*" required>
                <small style="color:var(--text-sec);">Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ù…Ù†</small>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--accent);">
                    <i class="fas fa-bank"></i> Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø¨Ù†ÙƒÙŠ
                </label>
                <input type="text" id="teacher-account" placeholder="Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            </div>
            
            <button class="btn-main" onclick="registerTeacher()">
                <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            </button>
            
            <div style="margin-top:20px; padding:15px; background:rgba(245, 158, 11, 0.1); border-radius:10px;">
                <p style="color:var(--accent); font-size:14px; margin:0;">
                    <i class="fas fa-info-circle"></i> Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ù…Ù† Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div id="app-screen" class="hidden">
    <header>
        <div class="header-top">
            <span onclick="handleBackButton()" style="cursor:pointer; font-size:22px; color:var(--text-sec); width:30px; height:30px; display:flex; align-items:center; justify-content:center;">
                <i class="fas fa-arrow-right"></i>
            </span>
            <span id="head-title" style="font-weight: 800; font-size: 20px; color: var(--text-main); text-align:center; flex:1;">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
            <div id="user-badge" style="background:rgba(255,255,255,0.1); padding:5px 12px; border-radius:15px; display:flex; align-items:center; gap:8px; cursor:pointer;" onclick="nav('profile')">
                <i class="fas fa-user" style="color:var(--accent); font-size:14px;"></i>
                <span id="u-stars" style="font-size:14px; font-weight:bold;">0.0</span>
            </div>
        </div>
        <div class="search-container" id="main-search">
            <i class="fas fa-search"></i>
            <input type="text" id="store-search" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙƒØªØ¨ØŒ Ø§Ù„ÙØµÙˆÙ„ØŒ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©..." oninput="debounceFilter(this.value)">
        </div>
    </header>

    <div id="content-area"></div>

    <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠØ© -->
    <div class="bottom-tabs">
        <div class="tab-btn active" onclick="nav('home'); highlightTab(this)">
            <i class="fas fa-home"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        </div>
        <div class="tab-btn" onclick="nav('grades'); highlightTab(this)">
            <i class="fas fa-graduation-cap"></i>Ø§Ù„ÙØµÙˆÙ„
        </div>
        <div class="tab-btn" onclick="nav('library'); highlightTab(this)">
            <i class="fas fa-book"></i>Ø§Ù„Ù…ÙƒØªØ¨Ø©
        </div>
        <div class="tab-btn" onclick="nav('ai_assistant'); highlightTab(this)">
            <i class="fas fa-robot"></i>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ
        </div>
        <div class="tab-btn" onclick="nav('live'); highlightTab(this)">
            <i class="fas fa-video"></i>Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
        </div>
    </div>
</div>

<!-- Ù…Ù„Ù ØµÙˆØªÙŠ Ù„Ù„Ø´Ø±Ø­ -->
<audio id="voiceExplanation" style="display:none;"></audio>

<script>
// ==================== [ 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ] ====================
const firebaseConfig = {
    apiKey: "AIzaSyAI_mUhuPNoO-XC0Q-VNoWft8UWFbAbIGg",
    authDomain: "sudan-market-6b122.firebaseapp.com",
    databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com",
    projectId: "sudan-market-6b122",
    storageBucket: "sudan-market-6b122.firebasestorage.app",
    messagingSenderId: "66729481566",
    appId: "1:66729481566:web:93393f28dc22d32cceebcf",
    measurementId: "G-XXXXXXXXXX"
};

// ØªÙ‡ÙŠØ¦Ø© Firebase
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.database();
const storage = firebase.storage();

// ==================== [ 2. Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ] ====================
const ADMIN_EMAIL = "mb425262@gmail.com";
const ADMIN_BANK_ACCOUNT = "4426148";
const WEEKLY_SUBSCRIPTION_PRICE = 7000; // 7000 Ø¬Ù†ÙŠÙ‡
const FREE_TRIAL_DAYS = 1;

let me = null;
let hStack = ['home'];
let isGuest = false;
let currentBookId = null;
let selectedChapter = '';
let currentQuiz = null;
let currentLiveRoom = null;
let currentVoice = null;

// ==================== [ 3. ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ] ====================
function initializeApp() {
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    auth.onAuthStateChanged((user) => {
        if (user) {
            // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
            loadUserData(user.uid);
        } else {
            // Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            showRegisterScreen();
        }
    });
}

function showRegisterScreen() {
    document.getElementById('main-preloader').classList.add('hidden');
    document.getElementById('register-screen').classList.remove('hidden');
}

function backToRegister() {
    document.getElementById('student-form').classList.add('hidden');
    document.getElementById('teacher-form').classList.add('hidden');
    document.getElementById('register-screen').classList.remove('hidden');
}

function showStudentForm() {
    document.getElementById('register-screen').classList.add('hidden');
    document.getElementById('student-form').classList.remove('hidden');
}

function showTeacherForm() {
    document.getElementById('register-screen').classList.add('hidden');
    document.getElementById('teacher-form').classList.remove('hidden');
}

// ==================== [ 4. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ ] ====================
async function registerStudent() {
    const name = document.getElementById('student-name').value.trim();
    const age = document.getElementById('student-age').value;
    const grade = document.getElementById('student-grade').value;
    
    if (!name || !age || !grade) {
        showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
        return;
    }
    
    // Ø¬Ù…Ø¹ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ÙØ¶Ù„Ø©
    const favoriteSubjects = [];
    document.querySelectorAll('.subject-checkbox:checked').forEach(cb => {
        favoriteSubjects.push(cb.value);
    });
    
    if (favoriteSubjects.length === 0) {
        showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø§Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
        return;
    }
    
    try {
        showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨...');
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù‡ÙˆÙ„
        const result = await auth.signInAnonymously();
        const user = result.user;
        
        // Ø­Ø³Ø§Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©
        const freeUntil = Date.now() + (FREE_TRIAL_DAYS * 24 * 60 * 60 * 1000);
        
        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
        await db.ref('users/' + user.uid).set({
            name: name,
            uid: user.uid,
            age: age,
            grade: grade,
            role: 'student',
            favoriteSubjects: favoriteSubjects,
            joinDate: Date.now(),
            freeTrial: true,
            freeUntil: freeUntil,
            balance: 0,
            subscription: null,
            totalSpent: 0,
            aiQuizzesCount: 0,
            booksDownloaded: 0,
            liveSessionsAttended: 0
        });
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ
        await db.ref('free_trials/' + user.uid).set({
            userId: user.uid,
            startDate: Date.now(),
            endDate: freeUntil,
            used: true
        });
        
        hideLoading();
        loadUserData(user.uid);
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ' + error.message);
    }
}

// ==================== [ 5. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø³ØªØ§Ø° ] ====================
async function registerTeacher() {
    const name = document.getElementById('teacher-name').value.trim();
    const subject = document.getElementById('teacher-subject').value;
    const whatsapp = document.getElementById('teacher-whatsapp').value.trim();
    const idFile = document.getElementById('teacher-id').files[0];
    const account = document.getElementById('teacher-account').value.trim();
    
    if (!name || !subject || !whatsapp || !idFile) {
        showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
        return;
    }
    
    // Ø¬Ù…Ø¹ Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    const grades = [];
    const gradeSelect = document.getElementById('teacher-grades');
    for (let i = 0; i < gradeSelect.options.length; i++) {
        if (gradeSelect.options[i].selected) {
            grades.push(gradeSelect.options[i].value);
        }
    }
    
    if (grades.length === 0) {
        grades.push('Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ');
    }
    
    try {
        showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„...');
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù‡ÙˆÙ„
        const result = await auth.signInAnonymously();
        const user = result.user;
        
        // Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
        const fileRef = storage.ref(`teacher_ids/${user.uid}_${Date.now()}_${idFile.name}`);
        const uploadTask = fileRef.put(idFile);
        
        await new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
                null,
                (error) => reject(error),
                async () => {
                    const idUrl = await uploadTask.snapshot.ref.getDownloadURL();
                    resolve(idUrl);
                }
            );
        });
        
        const idUrl = await uploadTask.snapshot.ref.getDownloadURL();
        
        // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³ØªØ§Ø° (ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©)
        await db.ref('users/' + user.uid).set({
            name: name,
            uid: user.uid,
            role: 'pending_teacher',
            subject: subject,
            grades: grades,
            whatsapp: whatsapp,
            bankAccount: account || null,
            idUrl: idUrl,
            joinDate: Date.now(),
            status: 'pending', // Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¯Ù…Ù†
            balance: 0,
            totalEarnings: 0
        });
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¥Ø¯Ù…Ù†
        await db.ref('admin_notifications').push({
            type: 'teacher_registration',
            userId: user.uid,
            userName: name,
            subject: subject,
            whatsapp: whatsapp,
            idUrl: idUrl,
            timestamp: Date.now(),
            status: 'pending'
        });
        
        hideLoading();
        
        Swal.fire({
            title: 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!',
            html: `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­<br>
                   <strong>Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ù…Ù† Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©</strong><br>
                   <small>Ø³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø±Ùƒ Ø¹Ù†Ø¯ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø£Ùˆ Ø§Ù„Ø±ÙØ¶</small>`,
            icon: 'success',
            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
            background: '#1e293b',
            color: '#fff'
        }).then(() => {
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ø§Ù†ØªØ¸Ø§Ø±
            location.reload();
        });
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ' + error.message);
    }
}

// ==================== [ 6. ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ] ====================
function loadUserData(uid) {
    db.ref('users/' + uid).on('value', async (snap) => {
        if (snap.exists()) {
            me = snap.val();
            me.uid = uid;
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø³ØªØ§Ø°
            if (me.role === 'pending_teacher') {
                await checkTeacherStatus(uid);
                return;
            }
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£Ø³ØªØ§Ø° Ù…Ø±ÙÙˆØ¶
            if (me.role === 'rejected_teacher') {
                Swal.fire({
                    title: 'ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ',
                    text: 'ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„Ùƒ ÙƒØ£Ø³ØªØ§Ø°. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙƒØ·Ø§Ù„Ø¨ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ.',
                    icon: 'error',
                    confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
                    background: '#1e293b',
                    color: '#fff'
                }).then(() => {
                    auth.signOut();
                    location.reload();
                });
                return;
            }
            
            // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            updateUI();
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            document.getElementById('main-preloader').classList.add('hidden');
            document.getElementById('register-screen').classList.add('hidden');
            document.getElementById('student-form').classList.add('hidden');
            document.getElementById('teacher-form').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
            nav('home');
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„
            db.ref('users/' + uid + '/online').set(true);
            db.ref('users/' + uid + '/online').onDisconnect().set(false);
        }
    });
}

async function checkTeacherStatus(uid) {
    const statusSnap = await db.ref('users/' + uid + '/status').once('value');
    const status = statusSnap.val();
    
    if (status === 'approved') {
        // ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
        me.role = 'teacher';
        loadUserData(uid); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    } else if (status === 'rejected') {
        // ØªÙ… Ø§Ù„Ø±ÙØ¶
        me.role = 'rejected_teacher';
        loadUserData(uid); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    } else {
        // Ù„Ø§ ÙŠØ²Ø§Ù„ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©
        showTeacherWaitingScreen();
    }
}

function showTeacherWaitingScreen() {
    document.getElementById('main-preloader').classList.add('hidden');
    
    Swal.fire({
        title: 'Ø¬Ø§Ø±ÙŠ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ',
        html: `Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„Ùƒ ÙƒØ£Ø³ØªØ§Ø° Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø­Ø§Ù„ÙŠØ§Ù‹<br>
               <strong>Ø³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø±Ùƒ ÙÙˆØ± Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</strong><br>
               <small>Ù‚Ø¯ ØªØ³ØªØºØ±Ù‚ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø­ØªÙ‰ 24 Ø³Ø§Ø¹Ø©</small>`,
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'Ø§Ù†ØªØ¸Ø§Ø±',
        cancelButtonText: 'ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬',
        background: '#1e293b',
        color: '#fff'
    }).then((result) => {
        if (result.dismiss === Swal.DismissReason.cancel) {
            auth.signOut();
            location.reload();
        } else {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
            setTimeout(() => checkTeacherStatus(me.uid), 30000);
        }
    });
}

// ==================== [ 7. Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ù‚Ù„ ] ====================
function nav(view, extra) {
    hStack.push(view);
    const area = document.getElementById('content-area');
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
    const titles = {
        'home': 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
        'grades': 'Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©',
        'library': 'Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©',
        'ai_assistant': 'Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ',
        'live': 'ØºØ±Ù Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±',
        'profile': 'Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ',
        'admin': 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…',
        'add_book': 'Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯',
        'book_detail': 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨',
        'subscription': 'Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø¯ÙØ¹'
    };
    document.getElementById('head-title').innerText = titles[view] || view;
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
    if (view === 'home') {
        renderHome();
    } else if (view === 'grades') {
        renderGrades();
    } else if (view === 'library') {
        renderLibrary();
    } else if (view === 'ai_assistant') {
        renderAIAssistant();
    } else if (view === 'live') {
        renderLiveRooms();
    } else if (view === 'profile') {
        renderProfile();
    } else if (view === 'admin') {
        renderAdminPanel();
    } else if (view === 'add_book') {
        renderAddBook();
    } else if (view === 'subscription') {
        renderSubscription();
    } else if (view === 'book_detail') {
        if (extra) loadBookDetail(extra);
    }
    
    highlightTab(document.querySelector(`[onclick*="${view}"]`));
}

function highlightTab(el) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    if (el) el.classList.add('active');
}

function handleBackButton() {
    if (hStack.length > 1) {
        hStack.pop();
        const prevView = hStack[hStack.length - 1];
        nav(prevView);
    } else {
        Swal.fire({
            title: 'ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬',
            text: 'Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø®Ø±ÙˆØ¬',
            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
            background: '#1e293b',
            color: '#fff'
        }).then(result => {
            if (result.isConfirmed) {
                auth.signOut();
                location.reload();
            }
        });
    }
}

// ==================== [ 8. ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ] ====================
function updateUI() {
    // ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const balanceText = me.balance ? me.balance.toFixed(1) + ' Ø¬.Ø³' : 'Ù…Ø¬Ø§Ù†ÙŠ';
    document.getElementById('u-stars').innerText = balanceText;
    
    // ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ø¯Ø¬ Ø§Ù„Ø²Ø§Ø¦Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¬Ø§Ù†ÙŠ
    if (me.freeTrial && me.freeUntil > Date.now()) {
        const hoursLeft = Math.ceil((me.freeUntil - Date.now()) / (1000 * 60 * 60));
        document.getElementById('u-stars').innerText = `ØªØ¬Ø±Ø¨Ø© ${hoursLeft}Ø³`;
    }
}

// ==================== [ 9. Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ] ====================
function debounce(func, wait = 300) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function formatDate(timestamp) {
    if (!timestamp) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) return 'Ø§Ù„Ø¢Ù†';
    if (diff < 3600000) return `Ù‚Ø¨Ù„ ${Math.floor(diff / 60000)} Ø¯Ù‚ÙŠÙ‚Ø©`;
    if (diff < 86400000) return `Ù‚Ø¨Ù„ ${Math.floor(diff / 3600000)} Ø³Ø§Ø¹Ø©`;
    
    return date.toLocaleDateString('ar-SA');
}

function showLoading(message = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...') {
    Swal.fire({
        title: message,
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading(),
        background: '#1e293b',
        color: '#fff'
    });
}

function hideLoading() {
    Swal.close();
}

function showSuccess(message) {
    Swal.fire({
        title: 'ØªÙ… Ø¨Ù†Ø¬Ø§Ø­!',
        text: message,
        icon: 'success',
        confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
        background: '#1e293b',
        color: '#fff'
    });
}

function showError(message) {
    Swal.fire({
        title: 'Ø®Ø·Ø£!',
        text: message,
        icon: 'error',
        confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
        background: '#1e293b',
        color: '#fff'
    });
}

// ==================== [ 10. Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ] ====================
function renderHome() {
    const area = document.getElementById('content-area');
    const isFreeTrial = me.freeTrial && me.freeUntil > Date.now();
    const hoursLeft = isFreeTrial ? Math.ceil((me.freeUntil - Date.now()) / (1000 * 60 * 60)) : 0;
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:20px; padding:25px; color:white; margin-bottom:25px;">
                <h2 style="margin-top:0;">Ù…Ø±Ø­Ø¨Ø§Ù‹ ${me.name} ğŸ‘‹</h2>
                <p>${me.role === 'teacher' ? 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ø£Ø³ØªØ§Ø° ' + me.subject : 'Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø±Ø­Ù„Ø© Ø§Ù„ØªØ¹Ù„Ù… Ù…Ø¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ'}</p>
                ${isFreeTrial ? `
                    <div style="background:rgba(255,255,255,0.2); padding:10px; border-radius:10px; margin-top:10px;">
                        <small>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù† Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠ: ${hoursLeft} Ø³Ø§Ø¹Ø©</small>
                    </div>
                ` : ''}
            </div>
            
            <div class="grid">
                <div class="card" onclick="nav('grades')">
                    <div class="card-badge">ğŸ“š</div>
                    <i class="fas fa-graduation-cap" style="color:#3b82f6"></i>
                    <b>Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</b>
                    <p style="font-size:12px; color:var(--text-sec)">${me.grade || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ'}</p>
                </div>
                
                <div class="card" onclick="nav('library')">
                    <div class="card-badge">ğŸ“–</div>
                    <i class="fas fa-book" style="color:#f59e0b"></i>
                    <b>Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</b>
                    <p style="font-size:12px; color:var(--text-sec)">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</p>
                </div>
                
                <div class="card" onclick="nav('ai_assistant')">
                    <div class="card-badge">ğŸ¤–</div>
                    <i class="fas fa-robot" style="color:#8b5cf6"></i>
                    <b>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</b>
                    <p style="font-size:12px; color:var(--text-sec)">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø°ÙƒÙŠØ©</p>
                </div>
                
                <div class="card" onclick="nav('live')">
                    <div class="card-badge">ğŸ“¹</div>
                    <i class="fas fa-video" style="color:#ef4444"></i>
                    <b>Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</b>
                    <p style="font-size:12px; color:var(--text-sec)">Ø¯Ø±ÙˆØ³ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</p>
                </div>
                
                ${me.role === 'admin' ? `
                <div class="card" onclick="nav('admin')" style="border:2px solid var(--red);">
                    <div class="card-badge" style="background:var(--red);">âš™ï¸</div>
                    <i class="fas fa-cogs" style="color:var(--red)"></i>
                    <b>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</b>
                    <p style="font-size:12px; color:var(--text-sec)">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</p>
                </div>
                ` : ''}
                
                <div class="card" onclick="nav('subscription')">
                    <div class="card-badge" style="background:var(--green);">ğŸ’³</div>
                    <i class="fas fa-crown" style="color:var(--green)"></i>
                    <b>Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</b>
                    <p style="font-size:12px; color:var(--text-sec)">Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù†</p>
                </div>
            </div>
            
            ${me.role === 'teacher' ? `
            <div style="margin-top:30px; padding:20px; background:rgba(139, 92, 246, 0.1); border-radius:15px; border:2px solid var(--purple);">
                <h3 style="color:var(--purple);"><i class="fas fa-chalkboard-teacher"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø³ØªØ§Ø°</h3>
                <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:15px;">
                    <button class="btn-main" onclick="createLiveRoom()" style="background:var(--purple);">
                        <i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¨Ø«
                    </button>
                    <button class="btn-secondary" onclick="showTeacherStats()">
                        <i class="fas fa-chart-line"></i> Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                    </button>
                </div>
            </div>
            ` : ''}
            
            <div style="margin-top:30px;">
                <h3><i class="fas fa-fire" style="color:var(--accent);"></i> Ø£Ø­Ø¯Ø« Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ø¶Ø§ÙØ©</h3>
                <div id="recent-books" class="loading">
                    <div class="loading-spinner"></div>
                    <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ¨...</div>
                </div>
            </div>
        </div>`;
    
    loadRecentBooks();
}

// ==================== [ 11. Ù…ÙƒØªØ¨Ø© Ø§Ù„ÙƒØªØ¨ ] ====================
function renderLibrary() {
    const area = document.getElementById('content-area');
    const canAddBooks = me.role === 'admin' || me.role === 'teacher';
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="color:var(--neon-blue);"><i class="fas fa-book"></i> Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</h2>
                ${canAddBooks ? `
                <button class="btn-main" onclick="nav('add_book')" style="width:auto; padding:10px 20px;">
                    <i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨
                </button>
                ` : ''}
            </div>
            
            <div style="margin:20px 0;">
                <input type="text" id="book-search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ÙƒØªØ§Ø¨ØŒ Ù…Ø¤Ù„ÙØŒ Ø£Ùˆ Ù…Ø§Ø¯Ø©..." 
                       style="width:100%;" oninput="debounceSearch(this.value)">
            </div>
            
            <div id="books-list" class="loading">
                <div class="loading-spinner"></div>
                <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø©...</div>
            </div>
        </div>`;
    
    loadAllBooks();
}

function loadAllBooks() {
    const container = document.getElementById('books-list');
    if (!container) return;
    
    db.ref('books').limitToLast(20).on('value', snap => {
        const books = snap.val();
        container.innerHTML = '';
        
        if (!books || Object.keys(books).length === 0) {
            container.innerHTML = `
                <div style="text-align:center; padding:40px; color:var(--text-sec);">
                    <i class="fas fa-book" style="font-size:48px; margin-bottom:15px; opacity:0.5;"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø¨Ø¹Ø¯</p>
                    ${me.role === 'admin' ? `
                    <button class="btn-main" onclick="nav('add_book')" style="margin-top:15px; width:auto;">
                        <i class="fas fa-plus"></i> Ø£Ø¶Ù Ø£ÙˆÙ„ ÙƒØªØ§Ø¨
                    </button>
                    ` : ''}
                </div>`;
            return;
        }
        
        let booksArray = Object.entries(books).map(([id, book]) => ({ id, ...book }));
        booksArray.reverse(); // Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
        
        booksArray.forEach(book => {
            const isFree = !book.price || book.price === 0;
            const priceText = isFree ? 'Ù…Ø¬Ø§Ù†ÙŠ' : `${book.price} Ø¬.Ø³`;
            const canDownload = isFree || me.balance >= book.price || 
                              (me.freeTrial && me.freeUntil > Date.now());
            
            container.innerHTML += `
                <div class="book-card">
                    <div style="width:80px; height:100px; background:var(--accent); border-radius:10px; display:flex; align-items:center; justify-content:center;">
                        <i class="fas fa-book-open" style="font-size:32px; color:white;"></i>
                    </div>
                    <div style="flex:1;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <div>
                                <div style="font-weight:bold; font-size:16px; margin-bottom:5px;">${book.title}</div>
                                <div style="font-size:12px; color:var(--text-sec); margin-bottom:5px;">
                                    <i class="fas fa-user"></i> ${book.author}
                                </div>
                            </div>
                            <span style="background:${isFree ? 'var(--green)' : 'var(--accent)'}; color:${isFree ? 'white' : 'black'}; padding:3px 8px; border-radius:5px; font-size:11px; font-weight:bold;">
                                ${priceText}
                            </span>
                        </div>
                        
                        <div style="font-size:11px; color:var(--text-sec); margin-top:8px;">
                            <span class="grade-badge">${book.grade}</span>
                            <span style="background:rgba(59, 130, 246, 0.2); color:var(--primary); padding:3px 8px; border-radius:5px; margin-right:5px;">
                                ${book.subject}
                            </span>
                        </div>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:8px;">
                        <button class="btn-main" style="padding:8px 12px; font-size:12px;" 
                                onclick="nav('book_detail', '${book.id}')" ${!canDownload ? 'disabled style="opacity:0.5;"' : ''}>
                            <i class="fas fa-eye"></i> ${canDownload ? 'Ø¹Ø±Ø¶' : 'ØºÙŠØ± Ù…ØªØ§Ø­'}
                        </button>
                    </div>
                </div>`;
        });
    });
}

// ==================== [ 12. Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ ] ====================
function renderAddBook() {
    if (me.role !== 'admin' && me.role !== 'teacher') {
        nav('home');
        return;
    }
    
    const area = document.getElementById('content-area');
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:30px;">
                <button class="btn-secondary" onclick="nav('library')" style="width:auto; padding:10px 15px;">
                    <i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹
                </button>
                <h2 style="color:var(--neon-blue); margin:0;">Ø¥Ø¶Ø§ÙØ© ÙƒØªØ§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
            </div>
            
            <div style="background:var(--bg-card); padding:25px; border-radius:20px;">
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; color:var(--accent);">
                        <i class="fas fa-heading"></i> Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨ *
                    </label>
                    <input type="text" id="book-title" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨" required>
                </div>
                
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; color:var(--accent);">
                        <i class="fas fa-user"></i> Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ù„Ù *
                    </label>
                    <input type="text" id="book-author" placeholder="Ø§Ø³Ù… Ù…Ø¤Ù„Ù Ø§Ù„ÙƒØªØ§Ø¨" required>
                </div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:20px;">
                    <div>
                        <label style="display:block; margin-bottom:8px; color:var(--accent);">
                            <i class="fas fa-graduation-cap"></i> Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ *
                        </label>
                        <select id="book-grade" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
                            <option value="Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                            <option value="Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                            <option value="Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                            <option value="Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                            <option value="Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                            <option value="Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                            <option value="Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø·">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ù…ØªÙˆØ³Ø·</option>
                            <option value="Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ù…ØªÙˆØ³Ø·">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ù…ØªÙˆØ³Ø·</option>
                            <option value="Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø·">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø·</option>
                            <option value="Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                            <option value="Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                            <option value="Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ø«Ø§Ù†ÙˆÙŠ</option>
                        </select>
                    </div>
                    
                    <div>
                        <label style="display:block; margin-bottom:8px; color:var(--accent);">
                            <i class="fas fa-book-open"></i> Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© *
                        </label>
                        <select id="book-subject" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø§Ø¯Ø©</option>
                            <option value="Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª">Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</option>
                            <option value="Ø§Ù„Ø¹Ù„ÙˆÙ…">Ø§Ù„Ø¹Ù„ÙˆÙ…</option>
                            <option value="Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©">Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                            <option value="Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©">Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©</option>
                            <option value="Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª">Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª</option>
                            <option value="Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©">Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; color:var(--accent);">
                        <i class="fas fa-link"></i> Ø±Ø§Ø¨Ø· Ø§Ù„ÙƒØªØ§Ø¨ (URL) *
                    </label>
                    <input type="url" id="book-url" placeholder="https://example.com/book.pdf" required>
                    <small style="color:var(--text-sec);">Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨ (PDF)</small>
                </div>
                
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; color:var(--accent);">
                        <i class="fas fa-tag"></i> Ø§Ù„Ø³Ø¹Ø± (Ø¬.Ø³)
                    </label>
                    <input type="number" id="book-price" placeholder="0 Ù„Ù„Ù…Ø¬Ø§Ù†ÙŠ" min="0" value="0">
                </div>
                
                <div style="margin-bottom:20px;">
                    <label style="display:block; margin-bottom:8px; color:var(--accent);">
                        <i class="fas fa-align-left"></i> ÙˆØµÙ Ø§Ù„ÙƒØªØ§Ø¨
                    </label>
                    <textarea id="book-description" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ± Ù„Ù„ÙƒØªØ§Ø¨..." rows="3"></textarea>
                </div>
                
                <button class="btn-main" onclick="addBook()">
                    <i class="fas fa-check"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØªØ§Ø¨
                </button>
            </div>
        </div>`;
}

async function addBook() {
    const title = document.getElementById('book-title').value.trim();
    const author = document.getElementById('book-author').value.trim();
    const grade = document.getElementById('book-grade').value;
    const subject = document.getElementById('book-subject').value;
    const bookUrl = document.getElementById('book-url').value.trim();
    const price = parseInt(document.getElementById('book-price').value) || 0;
    const description = document.getElementById('book-description').value.trim();
    
    if (!title || !author || !grade || !subject || !bookUrl) {
        showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
        return;
    }
    
    try {
        showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØªØ§Ø¨...');
        
        const bookData = {
            title: title,
            author: author,
            grade: grade,
            subject: subject,
            bookUrl: bookUrl,
            price: price,
            description: description || null,
            addedBy: me.uid,
            addedByName: me.name,
            addedDate: Date.now(),
            downloads: 0,
            status: me.role === 'admin' ? 'approved' : 'pending'
        };
        
        const bookRef = db.ref('books').push();
        await bookRef.set(bookData);
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£Ø³ØªØ§Ø°ØŒ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¥Ø¯Ù…Ù†
        if (me.role === 'teacher') {
            await db.ref('admin_notifications').push({
                type: 'book_pending',
                userId: me.uid,
                userName: me.name,
                bookId: bookRef.key,
                bookTitle: title,
                timestamp: Date.now(),
                status: 'pending'
            });
        }
        
        hideLoading();
        
        if (me.role === 'admin') {
            showSuccess('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒØªØ§Ø¨ Ø¨Ù†Ø¬Ø§Ø­');
            nav('library');
        } else {
            Swal.fire({
                title: 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!',
                text: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙƒØªØ§Ø¨ Ù„Ù„Ø¥Ø¯Ù…Ù† Ù„Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',
                icon: 'success',
                confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
                background: '#1e293b',
                color: '#fff'
            }).then(() => {
                nav('library');
            });
        }
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
    }
}

// ==================== [ 13. ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨ ] ====================
async function loadBookDetail(bookId) {
    const bookSnap = await db.ref(`books/${bookId}`).once('value');
    const book = bookSnap.val();
    
    if (!book) {
        showError('Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        nav('library');
        return;
    }
    
    const isFree = !book.price || book.price === 0;
    const canDownload = isFree || me.balance >= book.price || 
                       (me.freeTrial && me.freeUntil > Date.now());
    
    const area = document.getElementById('content-area');
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
                <button class="btn-secondary" onclick="nav('library')" style="width:auto; padding:10px 15px;">
                    <i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹
                </button>
                <h2 style="color:var(--neon-blue); margin:0;">${book.title}</h2>
            </div>
            
            <div style="background:var(--bg-card); border-radius:20px; padding:25px;">
                <div style="margin-bottom:25px;">
                    <h3 style="color:var(--accent); margin-top:0;"><i class="fas fa-info-circle"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙƒØªØ§Ø¨</h3>
                    <div style="line-height:2.5;">
                        <div style="display:flex;">
                            <strong style="width:120px; color:var(--text-sec);">Ø§Ù„Ù…Ø¤Ù„Ù:</strong>
                            <span>${book.author}</span>
                        </div>
                        <div style="display:flex;">
                            <strong style="width:120px; color:var(--text-sec);">Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ:</strong>
                            <span>${book.grade}</span>
                        </div>
                        <div style="display:flex;">
                            <strong style="width:120px; color:var(--text-sec);">Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</strong>
                            <span>${book.subject}</span>
                        </div>
                        <div style="display:flex;">
                            <strong style="width:120px; color:var(--text-sec);">Ø§Ù„Ø³Ø¹Ø±:</strong>
                            <span style="color:${isFree ? 'var(--green)' : 'var(--accent)'}; font-weight:bold;">
                                ${isFree ? 'Ù…Ø¬Ø§Ù†ÙŠ' : book.price + ' Ø¬.Ø³'}
                            </span>
                        </div>
                        <div style="display:flex;">
                            <strong style="width:120px; color:var(--text-sec);">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¶Ø§ÙØ©:</strong>
                            <span>${formatDate(book.addedDate)}</span>
                        </div>
                    </div>
                </div>
                
                ${book.description ? `
                <div style="margin-bottom:25px;">
                    <h4 style="color:var(--text-sec);"><i class="fas fa-align-left"></i> ÙˆØµÙ Ø§Ù„ÙƒØªØ§Ø¨</h4>
                    <p style="color:var(--text-main); line-height:1.8;">
                        ${book.description}
                    </p>
                </div>
                ` : ''}
                
                <div style="display:flex; gap:10px; margin-top:30px;">
                    <button class="btn-main" onclick="downloadBook('${bookId}', '${book.bookUrl}', ${book.price || 0})" 
                            ${!canDownload ? 'disabled style="opacity:0.5;"' : ''}
                            style="flex:1;">
                        <i class="fas fa-download"></i> ${isFree ? 'ØªØ­Ù…ÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ' : `Ø´Ø±Ø§Ø¡ Ùˆ ØªØ­Ù…ÙŠÙ„ (${book.price} Ø¬.Ø³)`}
                    </button>
                    
                    ${(me.role === 'admin') ? `
                    <button class="btn-danger" onclick="deleteBook('${bookId}')" style="width:auto; padding:10px 20px;">
                        <i class="fas fa-trash"></i> Ø­Ø°Ù
                    </button>
                    ` : ''}
                </div>
            </div>
        </div>`;
}

async function downloadBook(bookId, bookUrl, price) {
    if (!bookUrl) {
        showError('Ø±Ø§Ø¨Ø· Ø§Ù„ÙƒØªØ§Ø¨ ØºÙŠØ± Ù…ØªÙˆÙØ±');
        return;
    }
    
    const isFree = price === 0;
    const canDownload = isFree || me.balance >= price || 
                       (me.freeTrial && me.freeUntil > Date.now());
    
    if (!canDownload) {
        showError('Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ Ù„Ø´Ø±Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ÙƒØªØ§Ø¨');
        nav('subscription');
        return;
    }
    
    if (!isFree) {
        // Ø®ØµÙ… Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ø±ØµÙŠØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨
        const confirm = await Swal.fire({
            title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø±Ø§Ø¡',
            html: `Ø³Ø¹Ø± Ø§Ù„ÙƒØªØ§Ø¨: <strong>${price} Ø¬.Ø³</strong><br>
                   Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø±ØµÙŠØ¯Ùƒ`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ø´Ø±Ø§Ø¡ ÙˆØªØ­Ù…ÙŠÙ„',
            cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
            background: '#1e293b',
            color: '#fff'
        });
        
        if (!confirm.isConfirmed) return;
        
        showLoading('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø´Ø±Ø§Ø¡...');
        
        try {
            const newBalance = me.balance - price;
            await db.ref(`users/${me.uid}/balance`).set(newBalance);
            me.balance = newBalance;
            updateUI();
            
            // ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡
            await db.ref(`purchases/${me.uid}/${Date.now()}`).set({
                type: 'book',
                bookId: bookId,
                price: price,
                timestamp: Date.now()
            });
            
            // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ø£Ø³ØªØ§Ø° Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙƒØªØ§Ø¨ Ù…Ø¯ÙÙˆØ¹Ø§Ù‹
            if (price > 0) {
                const bookSnap = await db.ref(`books/${bookId}/addedBy`).once('value');
                const teacherId = bookSnap.val();
                
                if (teacherId && teacherId !== me.uid) {
                    const teacherSnap = await db.ref(`users/${teacherId}`).once('value');
                    const teacher = teacherSnap.val();
                    
                    if (teacher && teacher.role === 'teacher') {
                        const teacherEarnings = (teacher.totalEarnings || 0) + price;
                        await db.ref(`users/${teacherId}/totalEarnings`).set(teacherEarnings);
                    }
                }
            }
            
            hideLoading();
            
        } catch (error) {
            hideLoading();
            showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡: ' + error.message);
            return;
        }
    }
    
    // Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªÙ†Ø²ÙŠÙ„Ø§Øª
    await db.ref(`books/${bookId}/downloads`).transaction(current => (current || 0) + 1);
    
    // ÙØªØ­ Ø§Ù„ÙƒØªØ§Ø¨
    window.open(bookUrl, '_blank');
    
    showSuccess('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨...');
}

// ==================== [ 14. Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ ] ====================
function renderAIAssistant() {
    const area = document.getElementById('content-area');
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); border-radius:20px; padding:25px; color:white; margin-bottom:25px;">
                <h2 style="margin-top:0;"><i class="fas fa-robot"></i> Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ</h2>
                <p>Ø£Ù†Ø´Ø¦ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø°ÙƒÙŠØ© Ù…Ù† Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</p>
            </div>
            
            <div id="ai-interface">
                <div style="background:var(--bg-card); padding:20px; border-radius:15px; margin:20px 0;">
                    <h4><i class="fas fa-cogs" style="color:var(--accent);"></i> Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h4>
                    
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin:15px 0;">
                        <div>
                            <label style="display:block; margin-bottom:8px; color:var(--text-sec);">
                                <i class="fas fa-book"></i> Ø§Ù„Ù…Ø§Ø¯Ø©:
                            </label>
                            <select id="ai-subject" class="swal2-input">
                                ${(me.favoriteSubjects || ['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø§Ù„Ø¹Ù„ÙˆÙ…', 'Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©']).map(subject => 
                                    `<option value="${subject}">${subject}</option>`
                                ).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label style="display:block; margin-bottom:8px; color:var(--text-sec);">
                                <i class="fas fa-layer-group"></i> Ø§Ù„ÙØµÙ„:
                            </label>
                            <select id="ai-chapter" class="swal2-input">
                                <option value="1">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</option>
                                <option value="2">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                                <option value="3">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                                <option value="4">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
                                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display:block; margin-bottom:8px; color:var(--text-sec);">
                                <i class="fas fa-question-circle"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©:
                            </label>
                            <select id="ai-question-count" class="swal2-input">
                                <option value="5">5 Ø£Ø³Ø¦Ù„Ø©</option>
                                <option value="10" selected>10 Ø£Ø³Ø¦Ù„Ø©</option>
                                <option value="15">15 Ø£Ø³Ø¦Ù„Ø©</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn-main" onclick="generateAIQuiz()" 
                            style="background:linear-gradient(90deg, #8b5cf6, #7c3aed);">
                        <i class="fas fa-magic"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø°ÙƒÙŠ
                    </button>
                </div>
            </div>
            
            <div id="quiz-results"></div>
            
            <div style="margin-top:30px; padding:20px; background:var(--bg-card); border-radius:15px;">
                <h4><i class="fas fa-lightbulb" style="color:var(--accent);"></i> ÙƒÙŠÙ ÙŠØ¹Ù…Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠØŸ</h4>
                <ul style="color:var(--text-sec); padding-right:20px; line-height:1.8;">
                    <li>ÙŠÙ†Ø´Ø¦ Ø£Ø³Ø¦Ù„Ø© ØªÙ†Ø§Ø³Ø¨ Ù…Ø³ØªÙˆØ§Ùƒ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</li>
                    <li>ÙŠØºØ·ÙŠ Ø¬Ù…ÙŠØ¹ Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ù…Ø­Ø¯Ø¯</li>
                    <li>ÙŠÙ‚Ø¯Ù… ØªÙ‚Ø±ÙŠØ±Ø§Ù‹ Ù…ÙØµÙ„Ø§Ù‹ Ø¹Ù† Ø£Ø¯Ø§Ø¦Ùƒ</li>
                    <li>ÙŠØ­ÙØ¸ Ù†ØªØ§Ø¦Ø¬Ùƒ Ù„ØªØªØ¨Ø¹ ØªÙ‚Ø¯Ù…Ùƒ</li>
                </ul>
            </div>
        </div>`;
}
// Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¯Ø§Ø®Ù„ Ù…Ù„Ù HTML
async function generateAIQuiz() {
    const subject = document.getElementById('ai-subject').value;
    const chapter = document.getElementById('ai-chapter').value;
    const count = parseInt(document.getElementById('ai-question-count').value);
    
    showLoading('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø£Ø³Ø¦Ù„Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©...');
    
    try {
        // Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø®Ù„ÙÙŠ (server.js)
        const response = await fetch('/api/generate-quiz', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ subject, chapter, count })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù…Ù† GPT
            currentQuiz = {
                id: `quiz_${Date.now()}`,
                subject: subject,
                chapter: chapter,
                questions: data.questions, // Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
                generatedAt: Date.now(),
                userAnswers: {},
                score: 0
            };
            hideLoading();
            displayAIQuiz(currentQuiz.questions);
        } else {
            throw new Error('ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©');
        }
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
    }
}


function displayAIQuiz(questions) {
    let quizHtml = `
        <div style="background:var(--bg-card); border-radius:20px; padding:25px; margin:20px 0; border:2px solid var(--purple);">
            <h3 style="color:var(--purple); margin-top:0;">
                <i class="fas fa-robot"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø°ÙƒÙŠ ÙÙŠ ${currentQuiz.subject}
            </h3>
            <p style="color:var(--text-sec);">
                Ø§Ù„ÙØµÙ„: ${currentQuiz.chapter === 'all' ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØµÙˆÙ„' : 'Ø§Ù„ÙØµÙ„ ' + currentQuiz.chapter} â€¢ 
                ${questions.length} Ø³Ø¤Ø§Ù„
            </p>
            
            <div id="quiz-questions-container" style="margin:25px 0;">`;
    
    questions.forEach((q, index) => {
        quizHtml += `
            <div style="background:rgba(0,0,0,0.2); border-radius:15px; padding:20px; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h5 style="color:var(--text-main); margin:0;">
                        <span style="background:var(--primary); color:white; padding:5px 10px; border-radius:5px; margin-left:10px;">${index + 1}</span>
                        ${q.question}
                    </h5>
                    <span style="background:rgba(139, 92, 246, 0.3); color:var(--purple); padding:3px 8px; border-radius:5px; font-size:11px;">
                        ${q.type}
                    </span>
                </div>
                
                ${q.options.map((option, optIndex) => `
                    <div class="quiz-option" onclick="selectAIAnswer(${index}, ${optIndex})" 
                         style="background:rgba(255,255,255,0.05); border:1px solid var(--border); border-radius:10px; padding:12px; margin-bottom:8px; cursor:pointer; transition:0.3s;">
                        <span style="margin-left:10px; font-weight:bold; color:var(--accent);">${String.fromCharCode(1632 + optIndex + 1)}.</span>
                        ${option}
                    </div>
                `).join('')}
            </div>`;
    });
    
    quizHtml += `
            </div>
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-main" onclick="submitAIQuiz()" style="background:var(--green);">
                    <i class="fas fa-check-circle"></i> Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
                </button>
                <button class="btn-main" onclick="generateAIQuiz()" style="background:var(--purple);">
                    <i class="fas fa-redo"></i> Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ø¯ÙŠØ¯
                </button>
            </div>
        </div>`;
    
    document.getElementById('quiz-results').innerHTML = quizHtml;
}

function selectAIAnswer(questionIndex, optionIndex) {
    const questionCard = document.querySelectorAll('#quiz-questions-container > div')[questionIndex];
    const options = questionCard.querySelectorAll('.quiz-option');
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚
    options.forEach(opt => {
        opt.style.background = 'rgba(255,255,255,0.05)';
        opt.style.borderColor = 'var(--border)';
    });
    
    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
    options[optionIndex].style.background = 'rgba(59, 130, 246, 0.2)';
    options[optionIndex].style.borderColor = 'var(--primary)';
    
    // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©
    currentQuiz.userAnswers[questionIndex] = optionIndex;
}

async function submitAIQuiz() {
    if (!currentQuiz || !currentQuiz.questions) return;
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø©
    let score = 0;
    const totalQuestions = currentQuiz.questions.length;
    
    currentQuiz.questions.forEach((q, index) => {
        if (currentQuiz.userAnswers[index] === q.correctAnswer) {
            score++;
        }
    });
    
    const percentage = Math.round((score / totalQuestions) * 100);
    
    // Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    await db.ref(`ai_quizzes/${me.uid}/${currentQuiz.id}`).update({
        completed: true,
        score: score,
        totalQuestions: totalQuestions,
        percentage: percentage,
        submittedAt: Date.now()
    });
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
    Swal.fire({
        title: 'ğŸ‰ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±',
        html: `
            <div style="text-align:center;">
                <div style="font-size:60px; color:${percentage >= 70 ? 'var(--green)' : percentage >= 50 ? 'var(--accent)' : 'var(--red)'}; font-weight:bold; margin:20px 0;">
                    ${percentage}%
                </div>
                <div style="font-size:24px; margin:10px 0;">
                    ${score} Ù…Ù† ${totalQuestions} Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©
                </div>
                <div style="font-size:16px; color:var(--text-sec); margin:15px 0;">
                    ${percentage >= 70 ? 'Ù…Ù…ØªØ§Ø²! ğŸ‘ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø¯Ù‚ÙŠÙ‚Ø©' : 
                      percentage >= 50 ? 'Ø¬ÙŠØ¯ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­Ø³Ù† Ø¨Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¯Ø±Ø§Ø³Ø©' : 
                      'ØªØ­ØªØ§Ø¬ Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…Ø°Ø§ÙƒØ±Ø©ØŒ Ù„Ø§ ØªÙŠØ£Ø³!'}
                </div>
            </div>
        `,
        icon: 'success',
        confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
        background: '#1e293b',
        color: '#fff'
    });
}

// ==================== [ 15. ØºØ±Ù Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ] ====================
function renderLiveRooms() {
    const area = document.getElementById('content-area');
    const canCreateRooms = me.role === 'admin' || me.role === 'teacher';
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius:20px; padding:25px; color:white; margin-bottom:25px;">
                <h2 style="margin-top:0;"><i class="fas fa-video"></i> ØºØ±Ù Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h2>
                <p>Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ø¯Ø±ÙˆØ³ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø£ÙØ¶Ù„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</p>
            </div>
            
            ${canCreateRooms ? `
            <div style="margin-bottom:25px;">
                <button class="btn-main" onclick="createLiveRoom()" style="background:var(--green);">
                    <i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¨Ø« Ø¬Ø¯ÙŠØ¯Ø©
                </button>
            </div>
            ` : ''}
            
            <div id="live-rooms" class="loading">
                <div class="loading-spinner"></div>
                <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ ØºØ±Ù Ø§Ù„Ø¨Ø«...</div>
            </div>
        </div>`;
    
    loadLiveRooms();
}

function loadLiveRooms() {
    const container = document.getElementById('live-rooms');
    if (!container) return;
    
    db.ref('live_rooms').orderByChild('startTime').limitToLast(20).on('value', snap => {
        const rooms = snap.val();
        container.innerHTML = '';
        
        if (!rooms) {
            container.innerHTML = `
                <div style="text-align:center; padding:40px; color:var(--text-sec);">
                    <i class="fas fa-video-slash" style="font-size:48px; margin-bottom:15px; opacity:0.5;"></i>
                    <p>Ù„Ø§ ØªÙˆØ¬Ø¯ ØºØ±Ù Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± Ø­Ø§Ù„ÙŠØ§Ù‹</p>
                    ${(me.role === 'admin' || me.role === 'teacher') ? `
                    <button class="btn-main" onclick="createLiveRoom()" style="margin-top:15px;">
                        <i class="fas fa-plus"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø£ÙˆÙ„ ØºØ±ÙØ© Ø¨Ø«
                    </button>
                    ` : ''}
                </div>`;
            return;
        }
        
        const now = Date.now();
        Object.entries(rooms).reverse().forEach(([roomId, room]) => {
            const isActive = room.status === 'active' && room.endTime > now;
            const isUpcoming = room.status === 'scheduled' && room.startTime > now;
            const isEnded = room.status === 'ended' || room.endTime <= now;
            
            let statusBadge = '';
            if (isActive) {
                statusBadge = '<span style="background:var(--green); color:white; padding:3px 10px; border-radius:15px; font-size:11px;">ğŸ”´ Ù…Ø¨Ø§Ø´Ø± Ø§Ù„Ø¢Ù†</span>';
            } else if (isUpcoming) {
                statusBadge = '<span style="background:var(--accent); color:black; padding:3px 10px; border-radius:15px; font-size:11px;">â° Ù‚Ø±ÙŠØ¨Ø§Ù‹</span>';
            } else {
                statusBadge = '<span style="background:var(--text-sec); color:white; padding:3px 10px; border-radius:15px; font-size:11px;">Ø§Ù†ØªÙ‡Ù‰</span>';
            }
            
            const canJoin = (isActive || isUpcoming) && 
                           (room.price === 0 || me.balance >= room.price || 
                            (me.freeTrial && me.freeUntil > Date.now()));
            
            container.innerHTML += `
                <div class="live-room" style="background: ${isActive ? 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)' : 
                                                    isUpcoming ? 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)' : 
                                                    'linear-gradient(135deg, #64748b 0%, #475569 100%)'};">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <h3 style="margin-top:0; margin-bottom:10px;">${room.title}</h3>
                            <p style="opacity:0.9; margin-bottom:10px;">${room.description || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ'}</p>
                            
                            <div style="display:flex; gap:15px; font-size:12px; margin-bottom:10px;">
                                <div>
                                    <i class="fas fa-chalkboard-teacher"></i> ${room.teacherName}
                                </div>
                                <div>
                                    <i class="fas fa-book"></i> ${room.subject || 'Ø¹Ø§Ù…'}
                                </div>
                                <div>
                                    <i class="fas fa-graduation-cap"></i> ${room.grade || 'Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ'}
                                </div>
                            </div>
                        </div>
                        ${statusBadge}
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                        <div style="font-size:12px;">
                            <i class="fas fa-clock"></i> 
                            ${isActive ? 'ÙŠÙ†ØªÙ‡ÙŠ ' : isUpcoming ? 'ÙŠØ¨Ø¯Ø£ ' : 'Ø§Ù†ØªÙ‡Ù‰ '}
                            ${formatDate(isActive ? room.endTime : room.startTime)}
                        </div>
                        
                        <div>
                            ${!isEnded ? `
                            <button class="btn-main" onclick="${canJoin ? `joinLiveRoom('${roomId}', ${room.price})` : 'showRoomPayment(' + room.price + ')'}" 
                                    style="width:auto; padding:10px 20px; background:white; color:${room.price > 0 ? 'black' : '#ef4444'};">
                                <i class="fas fa-play"></i> ${room.price > 0 ? `${room.price} Ø¬.Ø³` : 'Ø§Ù†Ø¶Ù… Ù…Ø¬Ø§Ù†Ø§Ù‹'}
                            </button>
                            ` : ''}
                            
                            ${(me.role === 'admin' || me.uid === room.teacherId) ? `
                            <button class="btn-secondary" onclick="manageLiveRoom('${roomId}')" style="width:auto; padding:10px 15px; margin-right:10px;">
                                <i class="fas fa-cog"></i> Ø¥Ø¯Ø§Ø±Ø©
                            </button>
                            ` : ''}
                        </div>
                    </div>
                </div>`;
        });
    });
}

async function createLiveRoom() {
    if (me.role !== 'admin' && me.role !== 'teacher') {
        showError('ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£Ø³ØªØ§Ø°Ø§Ù‹ Ù„Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¨Ø«');
        return;
    }
    
    const { value: formValues } = await Swal.fire({
        title: 'Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¨Ø« Ø¬Ø¯ÙŠØ¯Ø©',
        html: `
            <input id="live-title" class="swal2-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¯Ø±Ø³ *" required>
            <textarea id="live-description" class="swal2-input" placeholder="ÙˆØµÙ Ø§Ù„Ø¯Ø±Ø³" rows="3"></textarea>
            <input id="live-price" class="swal2-input" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø¬.Ø³) - 0 Ù„Ù„Ù…Ø¬Ø§Ù†ÙŠ *" type="number" min="0" value="0" required>
            <input id="live-link" class="swal2-input" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø« (Youtube, Zoom, etc.) *" required>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <input id="live-start" class="swal2-input" placeholder="ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡" type="datetime-local">
                <input id="live-duration" class="swal2-input" placeholder="Ø§Ù„Ù…Ø¯Ø© (Ø¯Ù‚ÙŠÙ‚Ø©)" type="number" min="30" value="60">
            </div>
        `,
        confirmButtonText: 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©',
        showCancelButton: true,
        background: '#1e293b',
        color: '#fff',
        preConfirm: () => {
            const title = document.getElementById('live-title').value;
            const description = document.getElementById('live-description').value;
            const price = parseInt(document.getElementById('live-price').value) || 0;
            const link = document.getElementById('live-link').value;
            const startTime = document.getElementById('live-start').value;
            const duration = parseInt(document.getElementById('live-duration').value) || 60;
            
            if (!title || !link) {
                Swal.showValidationMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                return false;
            }
            
            const startTimestamp = startTime ? new Date(startTime).getTime() : Date.now() + 600000; // 10 Ø¯Ù‚Ø§Ø¦Ù‚ Ù…Ù† Ø§Ù„Ø¢Ù†
            const endTime = startTimestamp + (duration * 60000);
            
            return {
                title,
                description,
                price,
                link,
                startTime: startTimestamp,
                endTime,
                duration
            };
        }
    });
    
    if (!formValues) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø§Ù„Ø¨Ø«...');
    
    try {
        const roomId = `room_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        await db.ref(`live_rooms/${roomId}`).set({
            id: roomId,
            title: formValues.title,
            description: formValues.description || null,
            price: formValues.price,
            link: formValues.link,
            teacherId: me.uid,
            teacherName: me.name,
            teacherAccount: me.bankAccount || null,
            startTime: formValues.startTime,
            endTime: formValues.endTime,
            duration: formValues.duration,
            status: formValues.startTime > Date.now() ? 'scheduled' : 'active',
            createdAt: Date.now(),
            participants: 0,
            maxParticipants: 100,
            subject: me.subject || null,
            grade: me.grades ? me.grades[0] : null
        });
        
        hideLoading();
        showSuccess('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø§Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­');
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©: ' + error.message);
    }
}

async function joinLiveRoom(roomId, price) {
    const roomSnap = await db.ref(`live_rooms/${roomId}`).once('value');
    const room = roomSnap.val();
    
    if (!room) {
        showError('ØºØ±ÙØ© Ø§Ù„Ø¨Ø« ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
        return;
    }
    
    const now = Date.now();
    if (room.status !== 'active' && room.startTime > now) {
        showError('ØºØ±ÙØ© Ø§Ù„Ø¨Ø« Ù„Ù… ØªØ¨Ø¯Ø£ Ø¨Ø¹Ø¯');
        return;
    }
    
    if (room.endTime <= now) {
        showError('ØºØ±ÙØ© Ø§Ù„Ø¨Ø« Ø§Ù†ØªÙ‡Øª');
        return;
    }
    
    if (price > 0) {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¯ÙØ¹
        const paymentSnap = await db.ref(`room_payments/${roomId}_${me.uid}`).once('value');
        const hasPaid = paymentSnap.exists() && paymentSnap.val().confirmed === true;
        
        if (!hasPaid) {
            const confirm = await Swal.fire({
                title: 'Ø¯ÙØ¹ Ù…Ø·Ù„ÙˆØ¨',
                html: `Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„: <strong>${price} Ø¬.Ø³</strong><br>
                       ÙŠØ¬Ø¨ Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ©`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                background: '#1e293b',
                color: '#fff'
            });
            
            if (confirm.isConfirmed) {
                await payForLiveRoom(roomId, price, room);
            }
            return;
        }
    }
    
    // ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„Ø¨Ø«
    window.open(room.link, '_blank');
    
    // Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ†
    await db.ref(`live_rooms/${roomId}/participants`).transaction(current => (current || 0) + 1);
    
    // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨
    await db.ref(`room_participants/${roomId}/${me.uid}`).set({
        userName: me.name,
        joinedAt: Date.now()
    });
    
    showSuccess('ØªÙ… Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø¥Ù„Ù‰ ØºØ±ÙØ© Ø§Ù„Ø¨Ø« Ø¨Ù†Ø¬Ø§Ø­');
}

async function payForLiveRoom(roomId, price, room) {
    if (me.balance < price) {
        showError(`Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙŠ. ØªØ­ØªØ§Ø¬ ${price} Ø¬.Ø³`);
        nav('subscription');
        return;
    }
    
    const confirm = await Swal.fire({
        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹',
        html: `Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„: <strong>${price} Ø¬.Ø³</strong><br>
               Ø³ÙŠØªÙ… Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø±ØµÙŠØ¯Ùƒ`,
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        background: '#1e293b',
        color: '#fff'
    });
    
    if (!confirm.isConfirmed) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹...');
    
    try {
        // Ø®ØµÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ù…Ù† Ø§Ù„Ø·Ø§Ù„Ø¨
        const newBalance = me.balance - price;
        await db.ref(`users/${me.uid}/balance`).set(newBalance);
        me.balance = newBalance;
        updateUI();
        
        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ (Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø£Ø³ØªØ§Ø°)
        const paymentId = `pay_${Date.now()}`;
        await db.ref(`room_payments/${roomId}_${me.uid}`).set({
            paymentId: paymentId,
            roomId: roomId,
            roomTitle: room.title,
            userId: me.uid,
            userName: me.name,
            amount: price,
            timestamp: Date.now(),
            confirmed: false, // ÙŠØ­ØªØ§Ø¬ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø£Ø³ØªØ§Ø°
            status: 'pending'
        });
        
        // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø£Ø³ØªØ§Ø°
        await db.ref(`notifications/${room.teacherId}/${paymentId}`).set({
            type: 'room_payment',
            paymentId: paymentId,
            roomId: roomId,
            roomTitle: room.title,
            studentId: me.uid,
            studentName: me.name,
            amount: price,
            timestamp: Date.now(),
            read: false,
            actionRequired: true
        });
        
        hideLoading();
        
        Swal.fire({
            title: 'ØªÙ… Ø§Ù„Ø¯ÙØ¹!',
            html: `ØªÙ… Ø®ØµÙ… ${price} Ø¬.Ø³ Ù…Ù† Ø±ØµÙŠØ¯Ùƒ<br>
                   <strong>Ø¨Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø£Ø³ØªØ§Ø° Ù„Ù„Ø¯Ø®ÙˆÙ„</strong><br>
                   <small>Ø³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø±Ùƒ Ø¹Ù†Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯</small>`,
            icon: 'success',
            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
            background: '#1e293b',
            color: '#fff'
        });
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¯ÙØ¹: ' + error.message);
    }
}

function showRoomPayment(price) {
    Swal.fire({
        title: 'Ø¯ÙØ¹ Ù…Ø·Ù„ÙˆØ¨',
        html: `Ø³Ø¹Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„: <strong>${price} Ø¬.Ø³</strong><br>
               ÙŠØ¬Ø¨ Ø´Ø­Ù† Ø±ØµÙŠØ¯Ùƒ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„Ø§Ù†Ø¶Ù…Ø§Ù…`,
        icon: 'warning',
        confirmButtonText: 'Ø´Ø­Ù† Ø§Ù„Ø±ØµÙŠØ¯',
        background: '#1e293b',
        color: '#fff'
    }).then(() => {
        nav('subscription');
    });
}

// ==================== [ 16. Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ] ====================
function renderSubscription() {
    const area = document.getElementById('content-area');
    const isFreeTrial = me.freeTrial && me.freeUntil > Date.now();
    const hoursLeft = isFreeTrial ? Math.ceil((me.freeUntil - Date.now()) / (1000 * 60 * 60)) : 0;
    
    area.innerHTML = `
        <div style="padding:20px; text-align:center;">
            <h2 style="color:var(--accent);"><i class="fas fa-crown"></i> Ø®Ø·Ø· Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h2>
            <p style="color:var(--text-sec); margin-bottom:30px;">Ø§Ø®ØªØ± Ø§Ù„Ø®Ø·Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ø§Ø­ØªÙŠØ§Ø¬Ø§ØªÙƒ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</p>
            
            ${isFreeTrial ? `
            <div style="background:linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding:20px; border-radius:15px; color:white; margin-bottom:25px;">
                <h3 style="margin-top:0;"><i class="fas fa-gift"></i> Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ© Ù†Ø´Ø·Ø©</h3>
                <p>Ù…ØªØ¨Ù‚ÙŠ ${hoursLeft} Ø³Ø§Ø¹Ø© Ù…Ù† Ø§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©</p>
            </div>
            ` : ''}
            
            <div class="grid">
                <div class="card" style="border:2px solid var(--accent); transform: scale(1.05);">
                    <div style="position:absolute; top:10px; left:10px; background:var(--accent); color:black; padding:3px 8px; border-radius:5px; font-size:10px; font-weight:bold;">
                        Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹
                    </div>
                    <h3>Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h3>
                    <div style="font-size:42px; font-weight:bold; color:var(--accent);">7,000 Ø¬.Ø³</div>
                    <p style="font-size:12px; color:var(--text-sec);">7 Ø£ÙŠØ§Ù… ÙƒØ§Ù…Ù„Ø©</p>
                    <ul style="text-align:right; padding-right:15px; color:var(--text-sec); font-size:12px; line-height:1.8;">
                        <li>Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</li>
                        <li>Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø°ÙƒÙŠØ© ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©</li>
                        <li>Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø«ÙˆØ« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©</li>
                        <li>ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</li>
                        <li>Ø¯Ø¹Ù… ÙÙ†ÙŠ Ù…ØªØ®ØµØµ</li>
                    </ul>
                    <button class="btn-main" onclick="subscribeWeekly()" 
                            style="background:var(--accent); color:black;">
                        Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù†
                    </button>
                </div>
                
                <div class="card" style="border:2px solid var(--purple);">
                    <h3>Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3>
                    <div style="font-size:32px; font-weight:bold; color:var(--purple);">25,000 Ø¬.Ø³</div>
                    <p style="font-size:12px; color:var(--text-sec);">30 ÙŠÙˆÙ…Ø§Ù‹ (ÙˆÙØ± 3,000 Ø¬.Ø³)</p>
                    <ul style="text-align:right; padding-right:15px; color:var(--text-sec); font-size:12px; line-height:1.8;">
                        <li>ÙƒÙ„ Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</li>
                        <li>Ø®ØµÙ… 20% Ø¹Ù„Ù‰ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</li>
                        <li>Ø£ÙˆÙ„ÙˆÙŠØ© ÙÙŠ ØºØ±Ù Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</li>
                        <li>ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ø¯Ø§Ø¡ Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</li>
                    </ul>
                    <button class="btn-main" onclick="subscribeMonthly()" 
                            style="background:var(--purple);">
                        Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù†
                    </button>
                </div>
                
                <div class="card" style="border:2px solid var(--green);">
                    <h3>Ø§Ù„Ø³Ù†ÙˆÙŠ</h3>
                    <div style="font-size:32px; font-weight:bold; color:var(--green);">240,000 Ø¬.Ø³</div>
                    <p style="font-size:12px; color:var(--text-sec);">365 ÙŠÙˆÙ…Ø§Ù‹ (ÙˆÙØ± 60,000 Ø¬.Ø³)</p>
                    <ul style="text-align:right; padding-right:15px; color:var(--text-sec); font-size:12px; line-height:1.8;">
                        <li>ÙƒÙ„ Ù…Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠ</li>
                        <li>Ø®ØµÙ… 30% Ø¹Ù„Ù‰ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</li>
                        <li>Ø­Ø³Ø§Ø¨ Ø£Ø³ØªØ§Ø° Ù…Ø¬Ø§Ù†ÙŠ (Ø¥Ø°Ø§ Ù…Ø¤Ù‡Ù„)</li>
                        <li>Ø¯Ø¹Ù… ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ù…Ø¯Ø§Ø± Ø§Ù„Ø³Ø§Ø¹Ø©</li>
                    </ul>
                    <button class="btn-main" onclick="subscribeYearly()" 
                            style="background:var(--green);">
                        Ø§Ø´ØªØ±Ùƒ Ø§Ù„Ø¢Ù†
                    </button>
                </div>
            </div>
            
            <div style="margin-top:40px; text-align:right; padding:20px; background:var(--bg-card); border-radius:15px;">
                <h4 style="color:var(--neon-blue);"><i class="fas fa-university"></i> Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹:</h4>
                <div class="payment-method">
                    <div style="padding:15px; background:rgba(0,0,0,0.3); border-radius:10px; margin:10px 0;">
                        <p style="color:var(--accent); font-weight:bold; font-size:20px;">Ø¨Ù†Ùƒ Ø§Ù„Ø®Ø±Ø·ÙˆÙ…</p>
                        <p style="color:var(--neon-blue); font-size:24px; font-weight:bold; margin:10px 0;">${ADMIN_BANK_ACCOUNT}</p>
                        <p style="color:var(--text-sec); font-size:14px;">Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¯Ù…Ù† - ${ADMIN_EMAIL}</p>
                    </div>
                    
                    <p style="margin-top:20px;"><strong>Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¯ÙØ¹:</strong></p>
                    <ol style="color:var(--text-sec); padding-right:20px; line-height:2;">
                        <li>Ù‚Ù… Ø¨Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ø¹Ù„Ø§Ù‡</li>
                        <li>Ø§Ø­ÙØ¸ ØµÙˆØ±Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ</li>
                        <li>Ø£Ø±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Ù‹ Ù„Ù„Ø¥Ø¯Ù…Ù† Ù…Ø¹ ØµÙˆØ±Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„</li>
                        <li>Ø§Ù†ØªØ¸Ø± ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¯Ù…Ù† (Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©)</li>
                        <li>Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§ÙƒÙƒ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</li>
                    </ol>
                </div>
                
                <button class="btn-main" onclick="sendPaymentNotification()" style="margin-top:20px;">
                    <i class="fas fa-paper-plane"></i> Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¯ÙØ¹ Ù„Ù„Ø¥Ø¯Ù…Ù†
                </button>
            </div>
        </div>`;
}

async function subscribeWeekly() {
    await processSubscription('weekly', 7000, 7);
}

async function subscribeMonthly() {
    await processSubscription('monthly', 25000, 30);
}

async function subscribeYearly() {
    await processSubscription('yearly', 240000, 365);
}

async function processSubscription(plan, price, days) {
    const planNames = {
        'weekly': 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ',
        'monthly': 'Ø§Ù„Ø´Ù‡Ø±ÙŠ', 
        'yearly': 'Ø§Ù„Ø³Ù†ÙˆÙŠ'
    };
    
    const confirm = await Swal.fire({
        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ',
        html: `Ø§Ù„Ø®Ø·Ø©: <strong>${planNames[plan]}</strong><br>
               Ø§Ù„Ø³Ø¹Ø±: <strong>${price.toLocaleString()} Ø¬.Ø³</strong><br>
               Ø§Ù„Ù…Ø¯Ø©: <strong>${days} ÙŠÙˆÙ…</strong>`,
        icon: 'info',
        showCancelButton: true,
        confirmButtonText: 'ØªØ£ÙƒÙŠØ¯ ÙˆÙ…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø¯ÙØ¹',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        background: '#1e293b',
        color: '#fff'
    });
    
    if (!confirm.isConfirmed) return;
    
    // Ù‡Ù†Ø§ Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø¥Ø¯Ù…Ù†
    sendPaymentNotification(plan, price);
}

async function sendPaymentNotification(plan, price) {
    const { value: receipt } = await Swal.fire({
        title: 'Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø¯ÙØ¹',
        input: 'text',
        inputLabel: 'Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ù†ÙƒÙŠ Ø£Ùˆ Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ *',
        inputPlaceholder: 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„',
        showCancelButton: true,
        confirmButtonText: 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        background: '#1e293b',
        color: '#fff',
        inputValidator: (value) => {
            if (!value) {
                return 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„';
            }
        }
    });
    
    if (!receipt) return;
    
    const { value: amount } = await Swal.fire({
        title: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹',
        input: 'number',
        inputLabel: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ Ù‚Ù…Øª Ø¨ØªØ­ÙˆÙŠÙ„Ù‡ *',
        inputPlaceholder: 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº',
        showCancelButton: true,
        confirmButtonText: 'ØªØ£ÙƒÙŠØ¯',
        cancelButtonText: 'Ø±Ø¬ÙˆØ¹',
        background: '#1e293b',
        color: '#fff',
        inputValidator: (value) => {
            if (!value || value <= 0) {
                return 'Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­';
            }
        }
    });
    
    if (!amount) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±...');
    
    try {
        const notificationId = `sub_${Date.now()}`;
        
        await db.ref('admin_notifications').push({
            type: 'subscription_payment',
            userId: me.uid,
            userName: me.name,
            plan: plan,
            amount: parseInt(amount),
            expectedAmount: price,
            receipt: receipt,
            timestamp: Date.now(),
            status: 'pending',
            actionRequired: true
        });
        
        hideLoading();
        
        Swal.fire({
            title: 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±!',
            html: `ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¯ÙØ¹ Ù„Ù„Ø¥Ø¯Ù…Ù†<br>
                   <strong>Ø§Ù„Ù…Ø¨Ù„Øº: ${parseInt(amount).toLocaleString()} Ø¬.Ø³</strong><br>
                   <small>Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ø¨Ø¹Ø¯ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¯Ù…Ù†</small>`,
            icon: 'success',
            confirmButtonText: 'Ø­Ø³Ù†Ø§Ù‹',
            background: '#1e293b',
            color: '#fff'
        });
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±: ' + error.message);
    }
}

// ==================== [ 17. Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ ] ====================
function renderProfile() {
    const area = document.getElementById('content-area');
    const isFreeTrial = me.freeTrial && me.freeUntil > Date.now();
    
    area.innerHTML = `
        <div style="padding:20px; text-align:center;">
            <div style="position:relative; display:inline-block;">
                <div style="width:120px; height:120px; border-radius:50%; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); display:flex; align-items:center; justify-content:center; border:4px solid var(--neon-blue);">
                    <i class="fas fa-user" style="font-size:50px; color:white;"></i>
                </div>
                ${me.role === 'teacher' ? `
                <div style="position:absolute; bottom:10px; right:-10px; background:var(--purple); color:white; padding:5px 10px; border-radius:15px; font-size:12px; font-weight:bold;">
                    <i class="fas fa-chalkboard-teacher"></i> Ø£Ø³ØªØ§Ø°
                </div>
                ` : ''}
            </div>
            
            <h2 style="margin-top:15px;">${me.name}</h2>
            <p style="color:var(--text-sec);">
                ${me.role === 'teacher' ? `Ø£Ø³ØªØ§Ø° ${me.subject}` : `Ø·Ø§Ù„Ø¨ ${me.grade || ''}`}
            </p>
            
            <div style="display:flex; justify-content:center; gap:10px; margin:20px 0; flex-wrap:wrap;">
                <div style="background:rgba(59, 130, 246, 0.1); padding:15px; border-radius:15px; min-width:100px;">
                    <div style="font-size:14px; color:var(--text-sec);">Ø§Ù„Ø±ØµÙŠØ¯</div>
                    <div style="font-size:20px; font-weight:bold; color:var(--primary);">
                        ${me.balance ? me.balance.toLocaleString() : '0'} Ø¬.Ø³
                    </div>
                </div>
                
                <div style="background:rgba(245, 158, 11, 0.1); padding:15px; border-radius:15px; min-width:100px;">
                    <div style="font-size:14px; color:var(--text-sec);">Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</div>
                    <div style="font-size:20px; font-weight:bold; color:${me.subscription ? 'var(--green)' : 'var(--accent)'}">
                        ${me.subscription ? 'Ù…ÙØ¹Ù„' : isFreeTrial ? 'ØªØ¬Ø±Ø¨Ø©' : 'ØºÙŠØ± Ù…ÙØ¹Ù„'}
                    </div>
                </div>
            </div>
            
            <div style="background:var(--bg-card); padding:20px; border-radius:15px; margin:20px 0; text-align:right;">
                <h4 style="color:var(--neon-blue); margin-top:0;"><i class="fas fa-chart-line"></i> Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙƒ</h4>
                
                <div style="margin:15px 0;">
                    <div style="display:flex; justify-content:space-between; margin:10px 0;">
                        <span style="color:var(--text-sec);">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠØ©:</span>
                        <span style="font-weight:bold; color:var(--accent);">${me.aiQuizzesCount || 0}</span>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; margin:10px 0;">
                        <span style="color:var(--text-sec);">Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ø­Ù…Ù„Ø©:</span>
                        <span style="font-weight:bold; color:var(--green);">${me.booksDownloaded || 0}</span>
                    </div>
                    
                    <div style="display:flex; justify-content:space-between; margin:10px 0;">
                        <span style="color:var(--text-sec);">Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±:</span>
                        <span style="font-weight:bold; color:var(--purple);">${me.liveSessionsAttended || 0}</span>
                    </div>
                    
                    ${isFreeTrial ? `
                    <div style="display:flex; justify-content:space-between; margin:10px 0;">
                        <span style="color:var(--text-sec);">Ø§Ù„ØªØ¬Ø±Ø¨Ø© ØªÙ†ØªÙ‡ÙŠ Ø¨Ø¹Ø¯:</span>
                        <span style="font-weight:bold; color:var(--accent);">
                            ${Math.ceil((me.freeUntil - Date.now()) / (1000 * 60 * 60))} Ø³Ø§Ø¹Ø©
                        </span>
                    </div>
                    ` : ''}
                    
                    <div style="display:flex; justify-content:space-between; margin:10px 0;">
                        <span style="color:var(--text-sec);">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…:</span>
                        <span style="font-weight:bold;">${formatDate(me.joinDate)}</span>
                    </div>
                </div>
            </div>
            
            ${me.role === 'teacher' ? `
            <div style="background:rgba(139, 92, 246, 0.1); padding:20px; border-radius:15px; margin:20px 0; text-align:right; border:2px solid var(--purple);">
                <h4 style="color:var(--purple); margin-top:0;"><i class="fas fa-money-bill-wave"></i> Ø£Ø±Ø¨Ø§Ø­Ùƒ</h4>
                <div style="font-size:32px; font-weight:bold; color:var(--purple); text-align:center; margin:15px 0;">
                    ${(me.totalEarnings || 0).toLocaleString()} Ø¬.Ø³
                </div>
                ${me.bankAccount ? `
                <p style="color:var(--text-sec);">Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨Ùƒ: <strong>${me.bankAccount}</strong></p>
                ` : `
                <button class="btn-secondary" onclick="updateBankAccount()" style="margin-top:10px;">
                    <i class="fas fa-edit"></i> Ø¥Ø¶Ø§ÙØ© Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨
                </button>
                `}
            </div>
            ` : ''}
            
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-main" onclick="nav('subscription')" style="background:var(--green); flex:1;">
                    <i class="fas fa-crown"></i> ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ
                </button>
                
                <button class="btn-main" onclick="doLogout()" style="background:var(--red); flex:1;">
                    <i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
                </button>
            </div>
        </div>`;
}

async function updateBankAccount() {
    const { value: account } = await Swal.fire({
        title: 'ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨',
        input: 'text',
        inputLabel: 'Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø¨Ù†ÙƒÙŠ Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­',
        inputPlaceholder: 'Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨Ùƒ',
        showCancelButton: true,
        confirmButtonText: 'Ø­ÙØ¸',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        background: '#1e293b',
        color: '#fff'
    });
    
    if (!account) return;
    
    showLoading('Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø³Ø§Ø¨...');
    
    try {
        await db.ref(`users/${me.uid}/bankAccount`).set(account);
        me.bankAccount = account;
        
        hideLoading();
        showSuccess('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­');
        
    } catch (error) {
        hideLoading();
        showError('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«: ' + error.message);
    }
}

function doLogout() {
    Swal.fire({
        title: 'ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬',
        text: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø®Ø±ÙˆØ¬',
        cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
        background: '#1e293b',
        color: '#fff'
    }).then(result => {
        if (result.isConfirmed) {
            auth.signOut();
            location.reload();
        }
    });
}

// ==================== [ 18. Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ] ====================
function renderAdminPanel() {
    if (me.role !== 'admin') {
        nav('home');
        return;
    }
    
    const area = document.getElementById('content-area');
    
    area.innerHTML = `
        <div style="padding:20px;">
            <div class="admin-panel">
                <h2 style="color:var(--red);"><i class="fas fa-crown"></i> Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¥Ø¯Ù…Ù†</h2>
                <p style="color:var(--text-sec);">Ù…Ø±Ø­Ø¨Ø§ ${me.name}</p>
            </div>
            
            <div style="margin:25px 0;">
                <h3><i class="fas fa-tasks" style="color:var(--accent);"></i> Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</h3>
                <div class="grid">
                    <div class="card" onclick="managePendingBooks()">
                        <i class="fas fa-book" style="color:var(--primary)"></i>
                        <b>Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ù…Ù†ØªØ¸Ø±Ø©</b>
                        <p style="font-size:12px; color:var(--text-sec)">Ù…Ø±Ø§Ø¬Ø¹Ø© ÙƒØªØ¨ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</p>
                    </div>
                    
                    <div class="card" onclick="managePendingTeachers()">
                        <i class="fas fa-users" style="color:var(--green)"></i>
                        <b>Ø§Ù„Ø£Ø³Ø§ØªØ°Ø© Ø§Ù„Ù…Ù†ØªØ¸Ø±ÙŠÙ†</b>
                        <p style="font-size:12px; color:var(--text-sec)">Ø·Ù„Ø¨Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©</p>
                    </div>
                    
                    <div class="card" onclick="managePendingPayments()">
                        <i class="fas fa-money-bill-wave" style="color:var(--accent)"></i>
                        <b>Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</b>
                        <p style="font-size:12px; color:var(--text-sec)">Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØºØ±Ù Ø¨Ø«</p>
                    </div>
                    
                    <div class="card" onclick="showSystemStats()">
                        <i class="fas fa-chart-bar" style="color:var(--purple)"></i>
                        <b>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</b>
                        <p style="font-size:12px; color:var(--text-sec)">Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†ØŒ ÙƒØªØ¨ØŒ Ø£Ø±Ø¨Ø§Ø­</p>
                    </div>
                </div>
            </div>
            
            <div style="background:var(--bg-card); padding:20px; border-radius:15px; margin:25px 0;">
                <h4><i class="fas fa-university" style="color:var(--accent);"></i> Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¯Ù…Ù†</h4>
                <div style="padding:15px; background:rgba(0,0,0,0.3); border-radius:10px; margin-top:10px;">
                    <p><strong>Ø¨Ù†Ùƒ Ø§Ù„Ø®Ø±Ø·ÙˆÙ…:</strong></p>
                    <p style="color:var(--neon-blue); font-size:24px; font-weight:bold; text-align:center; margin:10px 0;">
                        ${ADMIN_BANK_ACCOUNT}
                    </p>
                    <p style="color:var(--text-sec); font-size:12px; text-align:center;">
                        ${ADMIN_EMAIL}
                    </p>
                </div>
            </div>
        </div>`;
}

// ==================== [ 19. ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒØªØ¨ Ø§Ù„Ø­Ø¯ÙŠØ«Ø© ] ====================
function loadRecentBooks() {
    const container = document.getElementById('recent-books');
    if (!container) return;
    
    db.ref('books').orderByChild('addedDate').limitToLast(3).on('value', snap => {
        const books = snap.val();
        container.innerHTML = '';
        
        if (!books) {
            container.innerHTML = '<p style="text-align:center; padding:20px; color:var(--text-sec);">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØªØ¨ Ø­Ø¯ÙŠØ«Ø©</p>';
            return;
        }
        
        Object.entries(books).reverse().forEach(([bookId, book]) => {
            const isFree = !book.price || book.price === 0;
            
            container.innerHTML += `
                <div class="post" style="margin-bottom:10px;">
                    <div style="display:flex; align-items:center; padding:15px;">
                        <div style="width:50px; height:70px; background:var(--accent); border-radius:8px; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-book-open" style="font-size:24px; color:white;"></i>
                        </div>
                        <div style="flex:1; margin-right:15px;">
                            <div style="font-weight:bold; font-size:14px;">${book.title}</div>
                            <div style="font-size:11px; color:var(--text-sec);">
                                <i class="fas fa-user"></i> ${book.author}
                            </div>
                            <div style="font-size:10px; color:var(--accent); margin-top:3px;">
                                <i class="fas fa-graduation-cap"></i> ${book.grade} â€¢ ${book.subject}
                            </div>
                        </div>
                        <span style="background:${isFree ? 'var(--green)' : 'var(--accent)'}; color:${isFree ? 'white' : 'black'}; padding:3px 8px; border-radius:5px; font-size:11px;">
                            ${isFree ? 'Ù…Ø¬Ø§Ù†ÙŠ' : book.price + ' Ø¬.Ø³'}
                        </span>
                    </div>
                </div>`;
        });
    });
}

// ==================== [ 20. Ø§Ù„Ø¨Ø­Ø« ] ====================
const debounceSearch = debounce(function(query) {
    const container = document.getElementById('books-list');
    if (!container) return;
    
    db.ref('books').once('value').then(snap => {
        const books = snap.val();
        container.innerHTML = '';
        
        if (!books) return;
        
        const searchTerm = query.toLowerCase();
        Object.keys(books).forEach(bookId => {
            const book = books[bookId];
            const title = book.title.toLowerCase();
            const author = book.author.toLowerCase();
            const subject = book.subject.toLowerCase();
            const grade = book.grade.toLowerCase();
            
            if (title.includes(searchTerm) || author.includes(searchTerm) || 
                subject.includes(searchTerm) || grade.includes(searchTerm)) {
                
                const isFree = !book.price || book.price === 0;
                
                container.innerHTML += `
                    <div class="book-card">
                        <div style="width:80px; height:100px; background:var(--accent); border-radius:10px; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-book-open" style="font-size:32px; color:white;"></i>
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight:bold; font-size:16px; margin-bottom:5px;">${book.title}</div>
                            <div style="font-size:12px; color:var(--text-sec); margin-bottom:5px;">
                                <i class="fas fa-user"></i> ${book.author}
                            </div>
                            <div style="font-size:11px; color:var(--text-sec); margin-top:8px;">
                                <span class="grade-badge">${book.grade}</span>
                                <span style="background:rgba(59, 130, 246, 0.2); color:var(--primary); padding:3px 8px; border-radius:5px; margin-right:5px;">
                                    ${book.subject}
                                </span>
                            </div>
                        </div>
                        <button class="btn-main" style="padding:8px 12px; font-size:12px;" 
                                onclick="nav('book_detail', '${bookId}')">
                            <i class="fas fa-eye"></i> Ø¹Ø±Ø¶
                        </button>
                    </div>`;
            }
        });
    });
}, 500);

const debounceFilter = debounce(function(query) {
    debounceSearch(query);
}, 300);

// ==================== [ 21. Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ] ====================
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        initializeApp();
    }, 1000);
});

// Ø¬Ø¹Ù„ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ØªØ§Ø­Ø© Ø¹Ø§Ù„Ù…ÙŠØ§Ù‹
window.nav = nav;
window.showStudentForm = showStudentForm;
window.showTeacherForm = showTeacherForm;
window.backToRegister = backToRegister;
window.registerStudent = registerStudent;
window.registerTeacher = registerTeacher;
window.handleBackButton = handleBackButton;
window.generateAIQuiz = generateAIQuiz;
window.selectAIAnswer = selectAIAnswer;
window.submitAIQuiz = submitAIQuiz;
window.createLiveRoom = createLiveRoom;
window.joinLiveRoom = joinLiveRoom;
window.showRoomPayment = showRoomPayment;
window.subscribeWeekly = subscribeWeekly;
window.subscribeMonthly = subscribeMonthly;
window.subscribeYearly = subscribeYearly;
window.sendPaymentNotification = sendPaymentNotification;
window.updateBankAccount = updateBankAccount;
window.doLogout = doLogout;
window.addBook = addBook;
window.downloadBook = downloadBook;
    // --- Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙƒØ§Ù† Ù†Ø§Ù‚ØµØ§Ù‹ ÙˆÙ‡Ùˆ Ø³Ø¨Ø¨ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ---
function renderGrades() {
    const area = document.getElementById('content-area');
    area.innerHTML = `
        <div style="padding:20px;">
             <div style="display:flex; align-items:center; gap:15px; margin-bottom:25px;">
                <button class="btn-secondary" onclick="nav('home')" style="width:auto; padding:10px 15px;">
                    <i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹
                </button>
                <h2 style="color:var(--neon-blue); margin:0;">Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h2>
            </div>
            <div class="grid">
                <div class="card" onclick="showError('Ù‚Ø±ÙŠØ¨Ø§Ù‹')">
                    <i class="fas fa-school" style="color:var(--primary)"></i>
                    <b>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</b>
                </div>
                 <div class="card" onclick="showError('Ù‚Ø±ÙŠØ¨Ø§Ù‹')">
                    <i class="fas fa-school" style="color:var(--accent)"></i>
                    <b>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</b>
                </div>
            </div>
        </div>`;
}
</script>
</body>
</html>

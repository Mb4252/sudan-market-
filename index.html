<!DOCTYPE html>
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "74a3085c-32b9-4c35-bc32-e67c3a2506c3",
    });
  });
</script>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDM Market | Ø¬ÙˆÙ‡Ø±Ø© Ø³ÙˆÙ„Ø§Ù†Ø§ ğŸ‡¸ğŸ‡©</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --navy: #0d1117; --gold: #ffc107; --blue: #007bff; --bg: #f4f6f9; --green: #28a745; --red: #dc3545; --white: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--bg); padding-bottom: 75px; direction: rtl; }
        .hidden { display: none !important; }
        header { background: var(--navy); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; border-bottom: 2px solid var(--gold); }
        
        .publish-container { background: var(--white); margin: 15px; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: 1px solid #eef; }
        .publish-container h4 { font-size: 22px; color: var(--navy); margin-bottom: 15px; border-right: 4px solid var(--blue); padding-right: 10px; }
        .publish-container input, .publish-container textarea { border: 1.5px solid #eee; transition: 0.3s; font-size: 15px; }
        .publish-container input:focus { border-color: var(--blue); outline: none; box-shadow: 0 0 8px rgba(0,123,255,0.2); }

        .welcome-msg { position: absolute; top: 60px; left: 10px; font-size: 12px; background: rgba(13, 17, 23, 0.8); color: white; padding: 5px 10px; border-radius: 20px; z-index: 999; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px; }
        .card { background: white; border-radius: 12px; padding: 15px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; border: 1px solid #eee; transition: 0.3s; }
        .card:hover { transform: translateY(-5px); border-color: var(--gold); }
        
        .btn-main { background: var(--blue); color: white; border: none; padding: 14px; width: 100%; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 16px; transition: 0.3s; }
        .btn-main:active { transform: scale(0.98); }
        .btn-whatsapp { background: #25d366; color: white; text-decoration: none; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px; border-radius: 10px; margin-top: 10px; font-weight: bold; width: 100%; box-sizing: border-box; }

        .bottom-tabs { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #ddd; padding: 10px 0; z-index: 1000; }
        .tab-btn { flex: 1; text-align: center; color: #555; cursor: pointer; font-size: 11px; }
        .tab-btn i { font-size: 20px; display: block; margin-bottom: 2px; }
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        
        .post { background: white; margin: 15px; border-radius: 15px; overflow: hidden; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border: 1px solid #eee; }
        .post-img-container { position: relative; width: 100%; height: 220px; }
        .sold-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(220, 53, 69, 0.8); color: white; display: flex; align-items: center; justify-content: center; font-size: 26px; font-weight: bold; z-index: 5; }
        .price-tag { color: var(--green); font-weight: 800; font-size: 18px; }
        .old-price { text-decoration: line-through; color: var(--red); font-size: 14px; margin-left: 10px; }
        .post-options { position: absolute; top: 12px; left: 12px; color: white; background: rgba(0,0,0,0.6); width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; }
        .post-time { font-size: 11px; color: #999; }
        .seller-info { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; border-bottom: 1px solid #f9f9f9; padding-bottom: 8px; cursor: pointer; }
        .seller-name { font-weight: bold; font-size: 13px; color: var(--navy); }

        .online-dot { width: 10px; height: 10px; background: #2ecc71; border-radius: 50%; display: inline-block; margin-left: 5px; border: 1px solid white; }
        .wallet-card { background: linear-gradient(135deg, #0d1117, #1e3a8a); color: white; padding: 25px; margin: 15px; border-radius: 20px; text-align: center; position: relative; overflow: hidden; }
        .sdm-logo { width: 70px; height: 70px; border-radius: 50%; border: 2px solid var(--gold); margin-bottom: 10px; object-fit: cover; }
        
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø·ÙˆØ± */
        .receipt-container { background: #fff; border: 1px solid #eee; border-radius: 15px; padding: 20px; font-family: 'Segoe UI', sans-serif; text-align: right; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.1); overflow: hidden; }
        .receipt-header-new { border-bottom: 2px dashed #ddd; padding-bottom: 10px; margin-bottom: 15px; text-align: center; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; border-bottom: 1px solid #f9f9f9; padding-bottom: 4px; }
        .receipt-label { color: #777; font-size: 13px; }
        .receipt-value { font-weight: bold; color: var(--navy); font-size: 14px; }
        .receipt-stamp-pro { position: absolute; bottom: 15px; left: 15px; width: 90px; height: 90px; border: 4px double rgba(0, 123, 255, 0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; transform: rotate(-15deg); color: var(--blue); font-weight: 900; font-size: 10px; text-align: center; text-transform: uppercase; pointer-events: none; }
        .receipt-stamp-pro::after { content: "ORIGINAL \A SUDAN MARKET \A SECURE"; white-space: pre; }

        .comment-box { border-top: 1px solid #eee; padding: 10px; background: #fafafa; font-size: 13px; }
        .comment-item { margin-bottom: 5px; padding: 5px; border-bottom: 1px dashed #ddd; }
        .admin-panel { background: #fff; margin: 15px; padding: 15px; border-radius: 15px; border: 2px solid var(--red); }
        .admin-notify-bar { background: #fff3cd; border: 2px solid var(--gold); margin: 15px; padding: 15px; border-radius: 15px; }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø¬Ù…Ù„ */
        .transfer-box { padding: 10px; border-radius: 15px; }
        .input-group-custom { position: relative; margin-bottom: 15px; }
        .input-group-custom i { position: absolute; right: 12px; top: 15px; color: var(--blue); }
        .input-group-custom input { padding-right: 40px !important; border: 2px solid #f0f0f0; }
        .input-group-custom input:focus { border-color: var(--blue); }
    </style>
</head>
<body>

<div id="auth-screen" class="hidden">
    <div style="padding:40px; text-align:center;">
        <h2 style="color:var(--navy)">Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† & SDM ğŸª™</h2>
        <div id="login-box">
            <input id="lp" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
            <textarea id="lw" placeholder="Ø§Ù„Ù€ 12 ÙƒÙ„Ù…Ø©" rows="2"></textarea>
            <button class="btn-main" onclick="doLogin()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            <p onclick="showReg()" style="color:var(--blue); cursor:pointer; margin-top:15px;">Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ÙØ¸Ø© Ø¬Ø¯ÙŠØ¯Ø©</p>
        </div>
        <div id="reg-box" class="hidden">
            <input id="rn" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
            <input id="rp" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
            <p style="font-size:12px;">ØµÙˆØ±Ø© Ø´Ø®ØµÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</p>
            <input type="file" onchange="encode(this, 'user')">
            <button class="btn-main" style="background:var(--green)" onclick="generateNewPhrase()">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</button>
            <div id="phrase-result" class="hidden">
                <div style="background:#fff3cd; padding:15px; margin:10px; border-radius:10px;">
                    <div id="p-text" style="font-family:monospace; word-break: break-all; margin-bottom:10px;"></div>
                    <button class="btn-main" style="margin:5px 0; background:var(--blue);" onclick="copyPhrase()">Ù†Ø³Ø® Ø§Ù„ÙƒÙ„Ù…Ø§Øª</button>
                    <p style="color:red; font-weight:bold; font-size:13px;">âš ï¸ Ø¥Ø°Ø§ Ø¶Ø§Ø¹Øª Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¶Ø§Ø¹ Ø§Ù„Ø­Ø³Ø§Ø¨ØŒ Ø§Ø­ØªÙØ¸ Ø¨Ù‡ Ø¬ÙŠØ¯Ø§Ù‹!</p>
                </div>
                <button class="btn-main" onclick="finalizeReg()">Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
            </div>
            <p onclick="showLog()" style="color:var(--blue); cursor:pointer; margin-top:15px;">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¯Ø®ÙˆÙ„</p>
        </div>
    </div>
</div>

<div id="app-screen" class="hidden">
    <header>
        <span onclick="goBack()" style="cursor:pointer; font-size:20px;">ğŸ”™</span>
        <b id="head-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</b>
        <div style="display:flex; align-items:center;">
            <div class="online-dot"></div>
            <span id="u-stars" style="color:var(--gold)">â­0</span>
        </div>
    </header>

    <div id="admin-notifications-area"></div>
    <div id="welcome-container"></div>
    <div id="content-area"></div>

    <div class="bottom-tabs">
        <div class="tab-btn" onclick="nav('home')"><i class="fas fa-home"></i>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="tab-btn" onclick="nav('games')"><i class="fas fa-gamepad" style="color:red"></i>Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</div>
        <div class="tab-btn" onclick="nav('wallet')"><i class="fas fa-wallet" style="color:blue"></i>SDM</div>
        <div class="tab-btn" onclick="nav('vip')"><i class="fas fa-gem" style="color:gold"></i>VIP</div>
        <div class="tab-btn" onclick="nav('profile')"><i class="fas fa-user-circle"></i>Ù…Ù„ÙÙŠ</div>
    </div>
</div>

<script>
    const firebaseConfig = { databaseURL: "https://sudan-market-6b122-default-rtdb.firebaseio.com" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const ADMIN_PH = "0126205674", ADMIN_NAME = "Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¹Ø·ÙŠ", SDM_PRICE = 1000, ADMIN_SECRET = "7mood";
    let me = null, hStack = ['home'], curC = '', curS = '', tempImg = '', userPic = 'https://via.placeholder.com/150';

    (function checkAuth() {
        const saved = localStorage.getItem('sdm_active');
        if(saved) {
            db.ref('users/' + saved).once('value', snap => {
                if(snap.exists()) {
                    me = snap.val();
                    startApp(saved);
                } else {
                    document.getElementById('auth-screen').classList.remove('hidden');
                }
            });
        } else {
            document.getElementById('auth-screen').classList.remove('hidden');
        }
    })();

    function startApp(phone) {
        db.ref('users/' + phone).on('value', snap => {
            me = snap.val();
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            checkVipExpiry();
            listenForUserAlerts();
            if(me.p === ADMIN_PH) listenForAdminTasks();
            render(hStack[hStack.length-1]);
        });
        db.ref('users/' + phone).update({ lastSeen: Date.now() });
    }

    function listenForAdminTasks() {
        db.ref('coin_requests').orderByChild('status').equalTo('pending').on('value', snap => {
            const area = document.getElementById('admin-notifications-area');
            if(hStack[hStack.length-1] !== 'home') { area.innerHTML = ""; return; }
            area.innerHTML = "";
            snap.forEach(child => {
                const req = child.val();
                area.innerHTML += `
                    <div class="admin-notify-bar">
                        <p><b>ğŸ”” Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯</b></p>
                        <p>Ø§Ù„Ø§Ø³Ù…: ${req.uN} | Ø§Ù„ÙƒÙ…ÙŠØ©: ${req.qty} SDM</p>
                        <img src="${req.img}" style="width:100%; border-radius:10px; margin:10px 0; cursor:pointer;" onclick="Swal.fire({imageUrl:'${req.img}'})">
                        <div style="display:flex; gap:10px;">
                            <button class="btn-main" style="background:var(--green); margin:0;" onclick="approvePurchase('${child.key}', '${req.uP}', ${req.qty})">Ù…ÙˆØ§ÙÙ‚</button>
                            <button class="btn-main" style="background:var(--red); margin:0;" onclick="rejectPurchase('${child.key}', '${req.uP}')">Ø±ÙØ¶</button>
                        </div>
                    </div>`;
            });
        });
    }

    async function approvePurchase(id, up, qty) {
        const uSnap = await db.ref('users/'+up).once('value');
        const bal = uSnap.val().sdmBalance || 0;
        await db.ref('users/'+up).update({ sdmBalance: bal + Number(qty) });
        await db.ref('coin_requests/'+id).update({ status: 'approved' });
        await db.ref('alerts/'+up).push({ msg: `âœ… ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ ÙˆØ¥Ø¶Ø§ÙØ© ${qty} SDM Ù„Ø­Ø³Ø§Ø¨Ùƒ`, type: 'success' });
        Swal.fire('ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„','ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­','success');
    }

    async function rejectPurchase(id, up) {
        await db.ref('coin_requests/'+id).update({ status: 'rejected' });
        await db.ref('alerts/'+up).push({ msg: `âŒ Ø¹Ø°Ø±Ø§Ù‹ØŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©`, type: 'error' });
        Swal.fire('ØªÙ… Ø§Ù„Ø±ÙØ¶','ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„Ø±ÙØ¶','info');
    }

    function listenForUserAlerts() {
        db.ref('alerts/'+me.p).on('child_added', snap => {
            const data = snap.val();
            if(data.isReceipt) {
                showReceiptModal(data);
            } else {
                Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', data.msg, data.type);
            }
            snap.ref.remove();
        });
    }

    function showReceiptModal(data) {
        Swal.fire({
            html: `
            <div class="receipt-container">
                <div class="receipt-header-new">
                    <h3 style="margin:0; color:var(--blue);">Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† | SDM</h3>
                    <small style="color:#888">Ø¥Ø´Ø¹Ø§Ø± ØªØ­ÙˆÙŠÙ„ Ø±Ø³Ù…ÙŠ</small>
                </div>
                <div class="receipt-row"><span class="receipt-label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</span> <span class="receipt-value">${data.opId}</span></div>
                <div class="receipt-row"><span class="receipt-label">Ø§Ù„Ù…Ø±Ø³Ù„:</span> <span class="receipt-value">${data.senderName}</span></div>
                <div class="receipt-row"><span class="receipt-label">Ø§Ù„Ù…Ø³ØªÙ„Ù…:</span> <span class="receipt-value">${data.receiverName}</span></div>
                <div class="receipt-row"><span class="receipt-label">Ø§Ù„Ù…Ø¨Ù„Øº:</span> <span class="receipt-value" style="color:var(--green)">${data.amount} SDM</span></div>
                <div class="receipt-row"><span class="receipt-label">Ø§Ù„ØªØ§Ø±ÙŠØ®:</span> <span class="receipt-value">${data.time}</span></div>
                <div style="margin-top:20px; text-align:center; color:#999; font-size:10px;">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ùƒ Ø´Ø¨ÙƒØ© SDM Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚Ø©</div>
                <div class="receipt-stamp-pro"></div>
            </div>`,
            showConfirmButton: true,
            confirmButtonText: 'Ø¥ØºÙ„Ø§Ù‚',
            background: 'transparent'
        });
    }

    function timeSince(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        let interval = seconds / 31536000;
        if (interval > 1) return "Ù…Ù†Ø° Ø³Ù†Ø©";
        interval = seconds / 2592000;
        if (interval > 1) return "Ù…Ù†Ø° " + Math.floor(interval) + " Ø´Ù‡Ø±";
        interval = seconds / 86400;
        if (interval > 1) return "Ù…Ù†Ø° " + Math.floor(interval) + " ÙŠÙˆÙ…";
        interval = seconds / 3600;
        if (interval > 1) return "Ù…Ù†Ø° " + Math.floor(interval) + " Ø³Ø§Ø¹Ø©";
        interval = seconds / 60;
        if (interval > 1) return "Ù…Ù†Ø° " + Math.floor(interval) + " Ø¯Ù‚ÙŠÙ‚Ø©";
        return "Ø§Ù„Ø¢Ù†";
    }

    function showWelcome() {
        const hour = new Date().getHours();
        let greet = hour < 12 ? "ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±" : "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±";
        const container = document.getElementById('welcome-container');
        if(hStack[hStack.length-1] === 'home' && me) {
            container.innerHTML = `<div class="welcome-msg">${greet}ØŒ ${me.n} âœ¨</div>`;
        } else { container.innerHTML = ""; }
    }

    function showReg() { document.getElementById('login-box').classList.add('hidden'); document.getElementById('reg-box').classList.remove('hidden'); }
    function showLog() { document.getElementById('reg-box').classList.add('hidden'); document.getElementById('login-box').classList.remove('hidden'); }

    async function generateNewPhrase() {
        const n = document.getElementById('rn').value.trim(), p = document.getElementById('rp').value.trim();
        if(!n || !p) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª','warning');
        
        const snapP = await db.ref('users/'+p).once('value');
        const snapN = await db.ref('users').orderByChild('n').equalTo(n).once('value');
        
        if(snapP.exists()) return Swal.fire('Ø®Ø·Ø£','Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹','error');
        if(snapN.exists()) return Swal.fire('Ø®Ø·Ø£','Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„ Ø´Ø®Øµ Ø¢Ø®Ø±','error');

        const words = ["nile","blue","gold","sdm","sudan","safe","tech","moon","palm","star","sun","fast"];
        const regPhrase = Array.from({length:12}, () => words[Math.floor(Math.random()*12)]).join(" ");
        document.getElementById('p-text').innerText = regPhrase;
        document.getElementById('phrase-result').classList.remove('hidden');
        window.tempPhrase = regPhrase;
    }

    function copyPhrase() {
        const pText = document.getElementById('p-text').innerText;
        navigator.clipboard.writeText(pText).then(() => {
            Swal.fire('ØªÙ… Ø§Ù„Ù†Ø³Ø®', 'ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
        });
    }

    function finalizeReg() {
        const n = document.getElementById('rn').value, p = document.getElementById('rp').value;
        db.ref('users/'+p).set({ n, p, phrase: window.tempPhrase, sdmBalance: 0, rating: 0, vipStatus: 'none', pic: userPic, ratedBy: [] });
        Swal.fire('ØªÙ…','Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø§Ù„Ø¢Ù†','success').then(showLog);
    }

    async function doLogin() {
        const p = document.getElementById('lp').value, w = document.getElementById('lw').value.trim();
        
        if(p === ADMIN_PH && w === ADMIN_SECRET) {
            localStorage.setItem('sdm_active', p);
            location.reload();
            return;
        }

        const snap = await db.ref('users/'+p).once('value');
        if(snap.exists() && snap.val().phrase === w) { localStorage.setItem('sdm_active', p); startApp(p); }
        else { Swal.fire('Ø®Ø·Ø£','Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©','error'); }
    }

    function nav(v, e) { hStack.push(v); render(v, e); }
    function goBack() { if(hStack.length > 1) { hStack.pop(); render(hStack[hStack.length-1]); } }

    function render(view, extra) {
        const area = document.getElementById('content-area');
        const adminArea = document.getElementById('admin-notifications-area');
        if(view !== 'home') adminArea.innerHTML = "";
        
        showWelcome();
        document.getElementById('u-stars').innerText = `â­${me ? (me.rating || 0) : 0}`;
        document.getElementById('head-title').innerText = view === 'home' ? 'Ø³ÙˆÙ‚ SDM Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ' : (view === 'wallet' ? 'Ù…Ø­ÙØ¸Ø© SDM' : 'Ø³ÙˆÙ‚ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†');

        if(view === 'home') {
            area.innerHTML = `<div id="vip-slider"></div><div class="grid">${Object.keys(cats).map(k=>`<div class="card" onclick="nav('sub','${k}')"><i class="fas fa-${cats[k].i}" style="font-size:24px; color:var(--blue); margin-bottom:10px;"></i><br><b>${k}</b></div>`).join('')}</div>`;
            loadVipHome();
        } else if(view === 'sub') {
            curC = extra || curC;
            area.innerHTML = `<div class="grid">${cats[curC].s.map(s=>`<div class="card" onclick="nav('feed','${s}')"><b>${s}</b></div>`).join('')}</div>`;
        } else if(view === 'feed') {
            curS = extra || curS;
            area.innerHTML = `
                <div class="publish-container">
                    <h4>ğŸ“ Ø£Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù†Ùƒ ÙÙŠ ${curS}</h4>
                    <input id="pt" placeholder="Ù…Ø§Ø°Ø§ ØªÙˆØ¯ Ø£Ù† ØªØ¨ÙŠØ¹ØŸ (Ø®Ø· ÙƒØ¨ÙŠØ± ÙˆØ¬Ø°Ø§Ø¨)">
                    <input id="pp" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¨Ù€ SDM">
                    <input id="p-whatsapp" type="number" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„ØªÙˆØ§ØµÙ„ (0xxxxxxxxx)">
                    <textarea id="pd" placeholder="Ø£Ø¶Ù ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø¯Ù‚Ø©..." rows="3"></textarea>
                    <div style="font-size:12px; margin-bottom:5px; color:#666">ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬:</div>
                    <input type="file" onchange="encode(this, 'post')">
                    <button class="btn-main" onclick="publish('posts')">Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¢Ù†</button>
                </div><div id="posts-list"></div>`;
            loadPosts('posts', curS);
        } else if(view === 'wallet') renderWallet(area);
        else if(view === 'games') renderGames(area);
        else if(view === 'vip') renderVip(area);
        else if(view === 'profile') renderProfile(area, extra || me.p);
    }

    function loadPosts(path, subFilter) {
        db.ref(path).on('value', snap => {
            const list = document.getElementById(path === 'posts' ? 'posts-list' : 'vip-slider-inner');
            if(!list) return;
            list.innerHTML = "";
            snap.forEach(c => {
                const p = c.val();
                if(subFilter && p.sub !== subFilter) return;
                
                const isMyPost = (p.uP === me.p || me.p === ADMIN_PH);
                const soldClass = p.status === 'sold' ? '<div class="sold-overlay">ØªÙ… Ø§Ù„Ø¨ÙŠØ¹</div>' : '';
                
                let postHTML = `
                <div class="post">
                    ${isMyPost ? `<i class="fas fa-ellipsis-v post-options" onclick="showPostMenu('${path}', '${c.key}', '${p.t}', '${p.pr}', '${p.d}')"></i>` : ''}
                    <div class="post-img-container">
                        ${soldClass}
                        <img src="${p.img}" style="width:100%; height:100%; object-fit:cover">
                    </div>
                    <div style="padding:15px">
                        <div class="seller-info" onclick="nav('profile', '${p.uP}')">
                            <img src="${p.uPic || 'https://via.placeholder.com/50'}" style="width:30px; height:30px; border-radius:50%">
                            <span class="seller-name">${p.uN} <span style="color:var(--gold); font-size:10px;">â­${p.uStars || 0}</span></span>
                        </div>
                        <h2 style="margin:5px 0; font-size:20px; color:var(--navy)">${p.t}</h2>
                        <div style="margin-bottom:5px;">
                            ${p.oldPr ? `<span class="old-price">${p.oldPr} SDM</span>` : ''}
                            <span class="price-tag">${p.pr} SDM</span>
                        </div>
                        <p style="font-size:14px; color:#444; line-height:1.5">${p.d}</p>
                        ${p.vExpiry ? `<div style="font-size:12px; color:var(--red); margin-bottom:5px;">ğŸ•’ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ù†Ø´Ø±: ${new Date(p.vExpiry).toLocaleDateString()}</div>` : ''}
                        <div class="post-time">${timeSince(p.date)}</div>
                        
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <a href="https://wa.me/249${p.wa || p.uP}" target="_blank" class="btn-whatsapp">
                                <i class="fab fa-whatsapp"></i> ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
                            </a>
                        </div>
                        <button class="btn-main" style="background:var(--red); font-size:12px; padding:5px;" onclick="reportItem('${c.key}', '${p.t}')">Ø¥Ø¨Ù„Ø§Øº</button>

                        <div class="comment-box" style="margin-top:15px">
                            <div id="comments-${c.key}"></div>
                            <div style="display:flex; gap:5px; margin-top:5px;">
                                <input id="ci-${c.key}" placeholder="Ø£Ø¶Ù ØªØ¹Ù„ÙŠÙ‚Ùƒ..." style="padding:8px; margin:0; font-size:12px;">
                                <button onclick="addComment('${path}', '${c.key}')" style="width:45px; border-radius:8px; border:none; background:var(--blue); color:white;"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>`;
                list.innerHTML += postHTML;
                loadComments(path, c.key);
            });
        });
    }

    function showPostMenu(path, id, t, pr, d) {
        Swal.fire({
            title: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±',
            showCancelButton: true,
            confirmButtonText: 'ØªØ¹Ø¯ÙŠÙ„',
            denyButtonText: 'Ø­Ø°Ù Ø§Ù„Ù…Ù†Ø´ÙˆØ±',
            showDenyButton: true,
            footer: `<button class="btn-main" style="background:var(--green); margin:0" onclick="markSold('${path}','${id}')">ØªØ­Ø¯ÙŠØ¯ ÙƒÙ€ "ØªÙ… Ø§Ù„Ø¨ÙŠØ¹"</button>`,
            preConfirm: () => {
                Swal.fire({
                    title: 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª',
                    html: `<input id="new-pr" class="swal2-input" value="${pr}" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯"><textarea id="new-d" class="swal2-textarea" placeholder="Ø§Ù„ÙˆØµÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯">${d}</textarea>`,
                    confirmButtonText: 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª',
                    preConfirm: () => {
                        const nPr = document.getElementById('new-pr').value;
                        const nD = document.getElementById('new-d').value;
                        db.ref(`${path}/${id}`).update({ pr: nPr, d: nD });
                    }
                });
            }
        }).then((result) => {
            if (result.isDenied) {
                db.ref(`${path}/${id}`).remove();
                Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù', 'ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­', 'success');
            }
        });
    }

    function markSold(path, id) {
        db.ref(`${path}/${id}`).update({ status: 'sold' });
        Swal.fire('ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ«','ØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ù…Ø¨Ø§Ø¹','success');
    }

    function reportItem(id, title) {
        Swal.fire('ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨Ù„Ø§Øº', `Ø´ÙƒØ±Ø§Ù‹ Ù„ÙƒØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ù†Ø´ÙˆØ±: ${title}`, 'info');
        db.ref('reports').push({ postId: id, reporter: me.p, date: Date.now() });
    }

    function addComment(path, id) {
        const txt = document.getElementById(`ci-${id}`).value;
        if(!txt) return;
        db.ref(`${path}/${id}/comments`).push({ uN: me.n, uP: me.p, txt: txt, date: Date.now() });
        document.getElementById(`ci-${id}`).value = "";
    }

    function loadComments(path, id) {
        db.ref(`${path}/${id}/comments`).limitToLast(5).on('value', snap => {
            const div = document.getElementById(`comments-${id}`);
            if(!div) return;
            div.innerHTML = "";
            snap.forEach(c => {
                const com = c.val();
                div.innerHTML += `<div class="comment-item" onclick="nav('profile','${com.uP}')" style="cursor:pointer"><b>${com.uN}:</b> ${com.txt}</div>`;
            });
        });
    }

    function renderWallet(area) {
        db.ref('settings/coinImg').on('value', snap => {
            const coinImg = snap.val() || "https://i.ibb.co/3ykXvBv/SDM-Coin.jpg";
            area.innerHTML = `
                <div class="wallet-card">
                    <img src="${coinImg}" class="sdm-logo">
                    ${me.p === ADMIN_PH ? '<br><input type="file" onchange="updateCoinImg(this)">' : ''}
                    <h1 style="font-size:32px; margin:10px 0;">${me.sdmBalance} SDM</h1>
                    <p style="font-size:14px; color:var(--gold)">1 SDM â‰ˆ ${SDM_PRICE} Ø¬.Ø³</p>
                    <button class="btn-main" style="background:var(--green); border:2px solid #fff;" onclick="showTransfer()">ğŸ’¸ ØªØ­ÙˆÙŠÙ„ Ø¯Ø§Ø®Ù„ÙŠ Ø³Ø±ÙŠØ¹</button>
                </div>
                
                <div id="transactions-history" style="padding:15px; background:#fff; margin:15px; border-radius:15px; box-shadow:0 5px 15px rgba(0,0,0,0.05);">
                    <h4 style="margin-top:0;"><i class="fas fa-history"></i> Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h4>
                    <div id="trans-list" style="max-height:200px; overflow-y:auto; font-size:12px;"></div>
                </div>

                ${me.p === ADMIN_PH ? `<div class="admin-panel" id="admin-reqs"><h4>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h4></div>` : ''}
                
                <div style="padding:15px; background:#fff; margin:15px; border-radius:15px;">
                    <h3>Ø´Ø±Ø§Ø¡ Ø±ØµÙŠØ¯ SDM</h3>
                    <p style="font-size:13px; color:#666;">Ù‚Ù… Ø¨Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ø¨Ù†Ùƒ Ø§Ù„Ø®Ø±Ø·ÙˆÙ… ÙˆØ£Ø±ÙÙ‚ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±:</p>
                    <div style="background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:10px;">
                        <p>Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨: <b>4426148</b><br>Ø§Ù„Ø§Ø³Ù…: <b>Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¹Ø·ÙŠ</b></p>
                    </div>
                    <input id="buy-qty" type="number" placeholder="ÙƒÙ… Ø¹Ø¯Ø¯ Ø­Ø¨Ø§Øª SDMØŸ" oninput="document.getElementById('buy-cost').innerText='Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©: '+(this.value*${SDM_PRICE})+' Ø¬.Ø³'">
                    <div id="buy-cost" style="margin-bottom:10px; font-weight:bold; color:var(--blue);"></div>
                    <input type="file" id="buy-img" onchange="encode(this, 'buy')">
                    <button class="btn-main" onclick="requestCoins()">Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø´Ø±Ø§Ø¡ Ù„Ù„Ù…Ø·ÙˆØ±</button>
                </div>`;
            if(me.p === ADMIN_PH) loadAdminRequests();
            loadTransactions();
        });
    }

    function loadTransactions() {
        db.ref('transactions').orderByChild('involves').equalTo(me.p).limitToLast(10).on('value', snap => {
            const list = document.getElementById('trans-list');
            if(!list) return;
            list.innerHTML = "";
            let items = [];
            snap.forEach(c => { items.unshift(c.val()); });
            if(items.length === 0) list.innerHTML = "<p style='color:#ccc; text-align:center;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¨Ø¹Ø¯</p>";
            items.forEach(t => {
                const isSent = t.sender === me.p;
                list.innerHTML += `
                    <div style="padding:8px; border-bottom:1px solid #f5f5f5; display:flex; justify-content:space-between;">
                        <span>${isSent ? 'ğŸ“¤ Ø¥Ù„Ù‰: '+t.receiverName : 'ğŸ“¥ Ù…Ù†: '+t.senderName}</span>
                        <b style="color:${isSent ? 'red':'green'}">${isSent ? '-':'+'}${t.amount} SDM</b>
                    </div>`;
            });
        });
    }

    function loadAdminRequests() {
        db.ref('coin_requests').orderByChild('status').equalTo('pending').on('value', snap => {
            const div = document.getElementById('admin-reqs');
            if(!div) return;
            div.innerHTML = "<h4>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</h4>";
            snap.forEach(c => {
                const r = c.val();
                div.innerHTML += `
                    <div style="border-bottom:1px solid #eee; padding:10px;">
                        <p>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${r.uN} (${r.uP})<br>Ø§Ù„ÙƒÙ…ÙŠØ©: ${r.qty} Ø­Ø¨Ø©</p>
                        <img src="${r.img}" style="width:100px; cursor:pointer" onclick="Swal.fire({imageUrl: '${r.img}'})">
                        <br>
                        <button onclick="approvePurchase('${c.key}', '${r.uP}', ${r.qty})" style="background:green; color:white;">Ù…ÙˆØ§ÙÙ‚</button>
                        <button onclick="rejectPurchase('${c.key}', '${r.uP}')" style="background:red; color:white;">Ø±ÙØ¶</button>
                    </div>`;
            });
        });
    }

    function showTransfer() {
        Swal.fire({
            title: 'ØªØ­ÙˆÙŠÙ„ Ø³Ø±ÙŠØ¹ ÙˆØ¢Ù…Ù†',
            html: `
            <div class="transfer-box">
                <div class="input-group-custom">
                    <i class="fas fa-phone"></i>
                    <input id="tr-p" type="number" class="swal2-input" placeholder="Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³ØªÙ„Ù…" oninput="checkRecipient(this.value)">
                </div>
                <div id="rec-name" style="font-size:14px; margin-bottom:10px; font-weight:bold;"></div>
                <div class="input-group-custom">
                    <i class="fas fa-coins"></i>
                    <input id="tr-a" type="number" class="swal2-input" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ­ÙˆÙŠÙ„Ù‡Ø§">
                </div>
            </div>`,
            showCancelButton: true,
            confirmButtonText: 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¢Ù† ğŸš€',
            preConfirm: () => {
                const p = document.getElementById('tr-p').value, a = document.getElementById('tr-a').value;
                if (!p || !a) { Swal.showValidationMessage('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø©'); return false; }
                if (p === me.p) { Swal.showValidationMessage('Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù†ÙØ³Ùƒ'); return false; }
                return { p, a };
            }
        }).then(async res => {
            if (!res.isConfirmed) return;
            const { p, a } = res.value;
            const amount = Number(a);
            if (me.sdmBalance < amount) return Swal.fire('Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ', '', 'error');
            
            const s = await db.ref('users/' + p).once('value');
            if (!s.exists()) return Swal.fire('Ø§Ù„Ù…Ø³ØªÙ„Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ù„Ø¯ÙŠÙ†Ø§', '', 'error');
            const receiverData = s.val();

            const opId = "SDM-" + Math.random().toString(36).substr(2, 9).toUpperCase();
            const timeNow = new Date().toLocaleString('ar-EG');

            // ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
            await db.ref('users/' + me.p).update({ sdmBalance: me.sdmBalance - amount });
            await db.ref('users/' + p).update({ sdmBalance: (receiverData.sdmBalance || 0) + amount });

            const receiptData = {
                isReceipt: true,
                opId: opId,
                senderName: me.n,
                receiverName: receiverData.n,
                amount: amount,
                time: timeNow,
                type: 'success'
            };

            // Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
            db.ref('transactions').push({
                opId, amount, sender: me.p, senderName: me.n, receiver: p, receiverName: receiverData.n, date: Date.now(), involves: [me.p, p]
            });

            // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ø³ØªÙ„Ù…
            await db.ref('alerts/' + p).push(receiptData);
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ù…Ø±Ø³Ù„ ÙÙˆØ±Ø§Ù‹
            showReceiptModal(receiptData);
        });
    }

    async function checkRecipient(ph) {
        if(ph.length >= 10) {
            const s = await db.ref('users/'+ph).once('value');
            const el = document.getElementById('rec-name');
            if(s.exists()){
                el.innerHTML = `<span style="color:green"><i class="fas fa-check-circle"></i> Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ«ÙˆÙ‚: ${s.val().n}</span>`;
            } else {
                el.innerHTML = `<span style="color:red"><i class="fas fa-times-circle"></i> Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø³Ø¬Ù„</span>`;
            }
        } else { document.getElementById('rec-name').innerText = ""; }
    }

    function renderGames(area) {
        let html = `
            <div class="publish-container" style="text-align:center;">
                <h4 style="color: var(--navy);">ğŸ® Ù…ØªØ¬Ø± SDM Ù„Ù„Ø´Ø­Ù† Ø§Ù„Ø°ÙƒÙŠ</h4>
                <p style="font-size: 11px; color: #666;">Ø³Ø¹Ø± Ø§Ù„Ø­Ø¨Ø© = 1000 Ø¬.Ø³</p>
                
                <select id="game-selection" onchange="calculateItems()" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px;">
                    <option value="ff">Ø¬ÙˆØ§Ù‡Ø± ÙØ±ÙŠ ÙØ§ÙŠØ± (1 Ø­Ø¨Ø© = 100)</option>
                    <option value="pubg">Ø´Ø¯Ø§Øª Ø¨Ø¨Ø¬ÙŠ (1.5 Ø­Ø¨Ø© = 60)</option>
                </select>

                <input type="number" id="sdm-input" oninput="calculateItems()" placeholder="ÙƒÙ… Ø­Ø¨Ø© SDM Ø³ØªØ¯ÙØ¹ØŸ" style="width:100%; padding:12px; margin-bottom:10px; border-radius:10px;">

                <div id="result-display" style="background:#f0f7ff; padding:15px; border-radius:12px; margin-bottom:10px; font-weight:bold; color:var(--navy);">
                    Ø³ØªØ­ØµÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰: <span id="items-count">0</span>
                </div>

                <input type="text" id="player-id" placeholder="Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ù„Ø§Ø¹Ø¨" style="width:100%; padding:12px; margin-bottom:15px; border-radius:10px;">

                <button onclick="sendOrderToOwner()" class="btn-main" style="background:#F25d36; color:white; border:none; width:100%; padding:12px; border-radius:15px; font-weight:bold;">
                    ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ÙˆØªØ¬Ù…ÙŠØ¯ Ø§Ù„Ø±ØµÙŠØ¯ ğŸ’
                </button>`;

        if (me && me.p === ADMIN_PH) { 
            html += `
                <div style="margin-top:20px; padding:10px; border:1px dashed red; border-radius:10px; background:#fff5f5;">
                    <p style="font-size:11px; color:red; font-weight:bold;">ğŸ›  Ù„ÙˆØ­Ø© Ø´Ø­Ù† Ø§Ù„Ù…Ø·ÙˆØ±:</p>
                    <a href="https://shop2game.com" target="_blank" style="font-size:12px; color:blue; text-decoration:underline;">Ù…ÙˆÙ‚Ø¹ ÙØ±ÙŠ ÙØ§ÙŠØ± Ø§Ù„Ø±Ø³Ù…ÙŠ</a> | 
                    <a href="https://www.midasbuy.com" target="_blank" style="font-size:12px; color:blue; text-decoration:underline;">Ù…ÙˆÙ‚Ø¹ Ø¨Ø¨Ø¬ÙŠ Ø§Ù„Ø±Ø³Ù…ÙŠ</a>
                </div>
                <div style="margin-top:20px; border-top:2px solid #eee; padding-top:10px;">
                    <h4 style="color:red; font-size:14px;">ğŸ›  Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©:</h4>
                    <div id="admin-orders-list"></div>
                </div>`;

            db.ref('game_orders').orderByChild('status').equalTo('pending').on('value', snap => {
                let h = '';
                snap.forEach(c => {
                    const o = c.val();
                    h += `
                        <div style="background:#f9f9f9; padding:10px; border-radius:10px; margin-bottom:10px; border:1px solid #ddd; color:#333;">
                            <p style="font-size:12px;">ğŸ‘¤ <b>Ø§Ù„Ù„Ø§Ø¹Ø¨:</b> ${o.uN} (${o.uP})</p>
                            <p style="font-size:12px;">ğŸ® <b>Ø§Ù„Ø·Ù„Ø¨:</b> ${o.reward} (ID: ${o.playerID})</p>
                            <div style="display:flex; gap:10px; margin-top:10px;">
                                <button onclick="processOrder('${c.key}', 'approve', '${o.uP}', ${o.amount})" style="background:green; color:white; border:none; padding:8px; border-radius:8px; flex:1; font-weight:bold; cursor:pointer;">Ù…ÙˆØ§ÙÙ‚ âœ…</button>
                                <button onclick="processOrder('${c.key}', 'reject', '${o.uP}', ${o.amount})" style="background:red; color:white; border:none; padding:8px; border-radius:8px; flex:1; font-weight:bold; cursor:pointer;">Ø±ÙØ¶ âŒ</button>
                            </div>
                        </div>`;
                });
                const listDiv = document.getElementById('admin-orders-list');
                if(listDiv) listDiv.innerHTML = h || '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>';
            });
        }
        html += '</div>';
        area.innerHTML = html;                     
    }

    function renderVip(area) {
        if (me.vipStatus === 'active') {
            area.innerHTML = `
                <div class="publish-container">
                    <h4 style="color:var(--gold);">ğŸ’ Ù†Ø´Ø± Ø¹Ø±Ø¶ VIP</h4>
                    <input id="v-t" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ø±Ø¶">
                    <div style="display:flex; gap:10px;">
                        <input id="v-old-pr" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…">
                        <input id="v-pr" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø± Ø¨Ø¹Ø¯ Ø§Ù„ØªØ®ÙÙŠØ¶">
                    </div>
                    <input id="v-wa" type="number" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„Ù„ØªÙˆØ§ØµÙ„">
                    <textarea id="v-d" placeholder="ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶"></textarea>
                    <input type="file" onchange="encode(this, 'post')">
                    <button class="btn-main" style="background:var(--gold); color:black;" onclick="publish('vip_posts')">Ù†Ø´Ø± Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„Ù€ VIP</button>
                </div>`;
        } else {
            area.innerHTML = `
                <div style="padding:20px; text-align:center;">
                    <i class="fas fa-crown" style="font-size:50px; color:var(--gold);"></i>
                    <h3>Ø§Ø´ØªØ±Ø§Ùƒ VIP</h3>
                    <p>Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${me.sdmBalance} SDM</p>
                    <div class="grid">
                        <div class="card" onclick="subVip(1, 1)">ÙŠÙˆÙ… (1 SDM)</div>
                        <div class="card" onclick="subVip(7, 7)">Ø£Ø³Ø¨ÙˆØ¹ (7 SDM)</div>
                    </div>
                </div>`;
        }
    }

    async function subVip(d, c) {
        if(me.sdmBalance < c) return Swal.fire('Ø¹Ø°Ø±Ø§Ù‹','Ø±ØµÙŠØ¯Ùƒ Ù„Ø§ ÙŠÙƒÙÙŠ','error');
        const exp = Date.now() + (d * 86400000);
        await db.ref('users/'+me.p).update({ sdmBalance: me.sdmBalance - c, vipStatus: 'active', vipExpiry: exp });
        Swal.fire('Ù…Ø¨Ø±ÙˆÙƒ!','Ø£ØµØ¨Ø­Øª VIP','success');
    }

    async function checkVipExpiry() {
        if(me && me.vipStatus === 'active' && Date.now() > me.vipExpiry) {
            await db.ref('users/'+me.p).update({ vipStatus: 'none' });
            const vipSnap = await db.ref('vip_posts').orderByChild('uP').equalTo(me.p).once('value');
            vipSnap.forEach(child => { child.ref.remove(); });
            Swal.fire('Ø§Ù†ØªÙ‡Ù‰ Ø§Ø´ØªØ±Ø§Ùƒ VIP', 'ØªÙ… Ø­Ø°Ù Ù…Ù†Ø´ÙˆØ±Ø§ØªÙƒ Ø§Ù„Ù…Ù…ÙŠØ²Ø©ØŒ Ø§Ø´ØªØ±Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ù„Ù„Ù†Ø´Ø±', 'warning');
        }
    }

    function publish(path) {
        const isVip = path === 'vip_posts';
        const t = (isVip ? document.getElementById('v-t') : document.getElementById('pt')).value;
        const pr = (isVip ? document.getElementById('v-pr') : document.getElementById('pp')).value;
        const oldPr = (isVip ? document.getElementById('v-old-pr').value : null);
        const d = (isVip ? document.getElementById('v-d') : document.getElementById('pd')).value;
        const wa = (isVip ? document.getElementById('v-wa') : document.getElementById('p-whatsapp')).value;
        
        if(!t || !pr || !tempImg) return Swal.fire('Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©','ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„ØµÙˆØ±Ø©','warning');
        
        const data = { 
            t, pr, oldPr, d, wa, img: tempImg, 
            uP: me.p, uN: me.n, 
            uPic: me.pic || 'https://via.placeholder.com/150',
            uStars: me.rating || 0,
            date: Date.now(), status: 'active' 
        };
        if(isVip) {
            data.vExpiry = me.vipExpiry;
        } else {
            data.sub = curS;
        }
        
        db.ref(path).push(data);
        Swal.fire('ØªÙ… Ø§Ù„Ù†Ø´Ø±','','success');
        isVip ? nav('home') : render('feed', curS);
    }

    function loadVipHome() {
        const slider = document.getElementById('vip-slider');
        if(!slider) return;
        slider.innerHTML = `<h4 style="margin:15px; color:var(--navy);"><i class="fas fa-star" style="color:var(--gold)"></i> Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù€ VIP</h4><div id="vip-slider-inner" style="display:flex; overflow-x:auto; padding:10px;"></div><hr style="border:0; border-top:1px solid #eee;">`;
        loadPosts('vip_posts', null);
    }

    function renderProfile(area, ph) {
        db.ref('users/'+ph).once('value', snap => {
            const u = snap.val();
            const isMe = (ph === me.p);
            area.innerHTML = `
                <div style="text-align:center; padding:30px;">
                    <img src="${u.pic || 'https://via.placeholder.com/150'}" id="profile-img-view" style="width:120px; height:120px; border-radius:50%; border:4px solid var(--blue); object-fit:cover; margin-bottom:15px;">
                    ${isMe ? '<input type="file" onchange="updateProfilePic(this)" style="font-size:10px;">' : ''}
                    <h2 style="margin:0">${u.n}</h2>
                    <p style="color:var(--gold); font-size:18px;">â­ ${u.rating || 0} ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØ§Ø¬Ø±</p>
                    
                    ${!isMe ? `<button class="btn-main" style="background:var(--gold); color:black" onclick="rateUser('${ph}')">ØªÙ‚ÙŠÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø¬Ø±</button>` : ''}
                    
                    <div style="background:#fff; padding:20px; border-radius:15px; margin-top:20px;">
                        <p style="margin:5px 0; color:#666">Ø§Ù„Ø±ØµÙŠØ¯</p>
                        <h3 style="margin:0; color:var(--blue)">${u.sdmBalance} SDM</h3>
                    </div>
                    ${isMe ? `<button class="btn-main" style="background:var(--red); margin-top:30px;" onclick="doLogout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>` : ''}
                </div>`;
        });
    }

    async function rateUser(ph) {
        const uSnap = await db.ref('users/'+ph).once('value');
        const userData = uSnap.val();
        const ratedBy = userData.ratedBy || [];
        if(ratedBy.includes(me.p)) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','Ù„Ù‚Ø¯ Ù‚Ù…Øª Ø¨ØªÙ‚ÙŠÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„Ø´Ø®Øµ Ù…Ø³Ø¨Ù‚Ø§Ù‹','info');
        const { value: stars } = await Swal.fire({
            title: 'ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªØ§Ø¬Ø±',
            input: 'select',
            inputOptions: { '1':'â­','2':'â­â­','3':'â­â­â­','4':'â­â­â­â­','5':'â­â­â­â­â­' },
            inputPlaceholder: 'Ø§Ø®ØªØ± Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø¬ÙˆÙ…',
            showCancelButton: true
        });
        if(stars) {
            ratedBy.push(me.p);
            const newRating = ((userData.rating || 0) + Number(stars)) / (ratedBy.length === 1 ? 1 : 2);
            db.ref('users/'+ph).update({ rating: newRating.toFixed(1), ratedBy: ratedBy });
            Swal.fire('Ø´ÙƒØ±Ø§Ù‹','ØªÙ… Ø­ÙØ¸ ØªÙ‚ÙŠÙŠÙ…Ùƒ','success');
        }
    }

    function updateProfilePic(input) {
        if(!input.files[0]) return;
        const r = new FileReader(); r.readAsDataURL(input.files[0]);
        r.onload = e => {
            db.ref('users/'+me.p).update({ pic: e.target.result });
            document.getElementById('profile-img-view').src = e.target.result;
        };
    }

    function doLogout() { localStorage.removeItem('sdm_active'); location.reload(); }

    function requestCoins() {
        const qty = document.getElementById('buy-qty').value;
        if(!qty || !window.tempBuyImg) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡','ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙ…ÙŠØ© ÙˆØµÙˆØ±Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±','warning');
        db.ref('coin_requests').push({ uP: me.p, uN: me.n, qty, img: window.tempBuyImg, status: 'pending', date: Date.now() });
        Swal.fire('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„','Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ Ù…Ù† Ù‚Ø¨Ù„ Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ù…Ø¹Ø·ÙŠ','success');
    }

    function encode(i, t) {
        if(!i.files[0]) return;
        const r = new FileReader(); r.readAsDataURL(i.files[0]);
        r.onload = e => { 
            if(t==='user') userPic=e.target.result; 
            else if(t==='buy') window.tempBuyImg=e.target.result; 
            else tempImg=e.target.result; 
        };
    }

    const cats = {
        "Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„Ø§Øª": {i:"mobile-alt", s:["Ø¢ÙŠÙÙˆÙ†","Ø³Ø§Ù…Ø³ÙˆÙ†Ø¬","Ø´Ø§ÙˆÙ…ÙŠ","Ø¨ÙƒØ³Ù„","Ù‡ÙˆØ§ÙˆÙŠ"]},
        "Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª": {i:"car", s:["ØªÙˆÙŠÙˆØªØ§","Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ","BYD","Ø£ÙƒØ³Ù†Øª","Ø±ÙƒØ´Ø§Øª"]},
        "Ø§Ù„Ø¹Ù‚Ø§Ø±Ø§Øª": {i:"home", s:["Ø´Ù‚Ù‚ Ù„Ù„Ø§ÙŠØ¬Ø§Ø±","Ø¨ÙŠÙˆØª Ù„Ù„Ø¨ÙŠØ¹","Ù…Ø²Ø§Ø±Ø¹","Ø§Ø±Ø§Ø¶ÙŠ"]},
        "Ø£Ø¬Ù‡Ø²Ø© Ù…Ù†Ø²Ù„ÙŠØ©": {i:"tv", s:["Ø´Ø§Ø´Ø§Øª","Ø«Ù„Ø§Ø¬Ø§Øª","Ù…ÙƒÙŠÙØ§Øª","ØºØ³Ø§Ù„Ø§Øª"]},
        "Ø§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±": {i:"laptop", s:["Ù„Ø§Ø¨ØªÙˆØ¨Ø§Øª","Ø·Ø§Ø¨Ø¹Ø§Øª","Ø§ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª"]},
        "Ø£Ø«Ø§Ø« Ù…Ù†Ø²Ù„": {i:"chair", s:["ØºØ±Ù Ù†ÙˆÙ…","Ø³Ø±Ø§ÙŠØ±","ÙƒØ±Ø§Ø³ÙŠ","Ø·Ø§ÙˆÙ„Ø§Øª"]},
        "Ù…Ù„Ø§Ø¨Ø³ Ø±Ø¬Ø§Ù„ÙŠØ©": {i:"tshirt", s:["Ù‚Ù…ØµØ§Ù†","Ø¨Ù†Ø§Ø·ÙŠÙ„","Ø§Ø­Ø°ÙŠØ©","Ø¬Ù„Ø§Ø¨ÙŠØ¨"]},
        "Ù…Ù„Ø§Ø¨Ø³ Ù†Ø³Ø§Ø¦ÙŠØ©": {i:"female", s:["ØªÙŠØ§Ø¨","ÙØ³Ø§ØªÙŠÙ†","Ø´Ù†Ø·","Ù…ÙƒÙŠØ§Ø¬"]},
        "Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø£Ø·ÙØ§Ù„": {i:"baby", s:["Ù…Ù„Ø§Ø¨Ø³ Ø§Ø·ÙØ§Ù„","Ø§Ù„Ø¹Ø§Ø¨","Ø¹Ø±Ø¨Ø§Øª Ø§Ø·ÙØ§Ù„"]},
        "Ø§Ù„Ø°Ù‡Ø¨ ÙˆØ§Ù„Ù…Ø¬ÙˆÙ‡Ø±Ø§Øª": {i:"gem", s:["Ø®ÙˆØ§ØªÙ…","Ø³Ù„Ø§Ø³Ù„","Ø§Ø·Ù‚Ù… Ø°Ù‡Ø¨"]},
        "Ø­ÙŠÙˆØ§Ù†Ø§Øª": {i:"paw", s:["Ø§ØºÙ†Ø§Ù…","Ø·ÙŠÙˆØ±","Ù‚Ø·Ø·","Ø®ÙŠÙˆÙ„"]},
        "Ø®Ø¯Ù…Ø§Øª Ù…Ù‡Ù†ÙŠØ©": {i:"tools", s:["ÙƒÙ‡Ø±Ø¨Ø§Ø¡","Ø³Ø¨Ø§ÙƒØ©","Ø­Ø¯Ø§Ø¯Ø©","Ù†Ù‚Ø§Ø´Ø©"]},
        "Ù…Ø·Ø§Ø¹Ù…": {i:"utensils", s:["ÙˆØ¬Ø¨Ø§Øª Ø³Ø±ÙŠØ¹Ø©","Ø­Ù„ÙˆÙŠØ§Øª","Ø¹ØµØ§Ø¦Ø±"]},
        "Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø¬Ù…Ø§Ù„": {i:"heartbeat", s:["Ø¹Ø·ÙˆØ±","ÙƒØ±ÙŠÙ…Ø§Øª","Ù…Ø¹Ø¯Ø§Øª Ø·Ø¨ÙŠØ©"]},
        "ÙƒØªØ¨ ÙˆØ£Ø¯ÙˆØ§Øª": {i:"book", s:["Ø±ÙˆØ§ÙŠØ§Øª","ÙƒØªØ¨ Ø¹Ù„Ù…ÙŠØ©","Ù‚Ø±Ø·Ø§Ø³ÙŠØ©"]},
        "Ø³ÙŠØ§Ø­Ø© ÙˆØ³ÙØ±": {i:"plane", s:["ØªØ°Ø§ÙƒØ± Ø·ÙŠØ±Ø§Ù†","ØªØ£Ø´ÙŠØ±Ø§Øª","ÙÙ†Ø§Ø¯Ù‚"]},
        "ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠØ§ SDM": {i:"microchip", s:["ØªØ¹Ø¯ÙŠÙ†","Ø§Ø³ØªØ´Ø§Ø±Ø§Øª ØªÙ‚Ù†ÙŠØ©"]},
        "Ù…Ù†ÙˆØ¹Ø§Øª": {i:"box-open", s:["Ø§ØºØ±Ø§Ø¶ Ø§Ø®Ø±Ù‰"]}
    };

    function calculateItems() {
        const sdmInput = document.getElementById('sdm-input');
        const display = document.getElementById('items-count');
        const gameSelect = document.getElementById('game-selection');

        if (!sdmInput || !display || !gameSelect) return;

        const sdm = parseFloat(sdmInput.value) || 0;
        const type = gameSelect.value;
        let res = 0;

        if (sdm < 18) {
            display.innerText = "Ø£Ù‚Ù„ ÙƒÙ…ÙŠØ© 18 SDM";
            return;
        }

        if (type === "ff") {
            res = Math.floor(sdm * 29.45);
            display.innerText = res + " Ø¬ÙˆÙ‡Ø±Ø©";
        } else {
            res = Math.floor(sdm * 18.06);
            display.innerText = res + " Ø´Ø¯Ø© UC";
        }
    }

    function sendOrderToOwner() {
        const sdmInput = document.getElementById('sdm-input');
        const id = document.getElementById('player-id').value;
        const resText = document.getElementById('items-count').innerText;
        const game = document.getElementById('game-selection').value;
        const sdmAmount = parseFloat(sdmInput.value) || 0;

        if (sdmAmount < 18) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ø£Ù‚Ù„ ÙƒÙ…ÙŠØ© Ù‡ÙŠ 18 SDM', 'info');
        if (!me || me.sdmBalance < sdmAmount) return Swal.fire('Ø®Ø·Ø£', 'Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ', 'error');
        if (!id) return Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ID Ø§Ù„Ù„Ø§Ø¹Ø¨', 'error');

        Swal.fire({
            title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨',
            text: `Ø³ÙŠØªÙ… ØªØ¬Ù…ÙŠØ¯ ${sdmAmount} SDM Ù„Ø­ÙŠÙ† Ø§Ù„ØªÙ†ÙÙŠØ°`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'ØªØ£ÙƒÙŠØ¯'
        }).then(result => {
            if (result.isConfirmed) {
                db.ref('users/' + me.p).update({ 
                    sdmBalance: me.sdmBalance - sdmAmount, 
                    frozenSDM: (me.frozenSDM || 0) + sdmAmount 
                });

                db.ref('game_orders').push({
                    uN: me.n, uP: me.p, game: game, playerID: id,
                    amount: sdmAmount, reward: resText, status: 'pending', date: Date.now()
                });
                Swal.fire('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', '', 'success');
            }
        });
    }

    function processOrder(key, action, phone, amount) {
        const userRef = db.ref('users/' + phone);
        userRef.once('value').then(snap => {
            const d = snap.val() || {};
            const currentFrozen = Number(d.frozenSDM || 0);
            const currentBalance = Number(d.sdmBalance || 0);
            const orderAmount = Number(amount);

            if (action === 'approve') {
                userRef.update({ 
                    frozenSDM: Math.max(0, currentFrozen - orderAmount) 
                }).then(() => {
                    db.ref('game_orders/' + key).update({ status: 'completed' });
                    Swal.fire('ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ âœ…', 'ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­', 'success');
                });
            } else {
                userRef.update({
                    sdmBalance: currentBalance + orderAmount,
                    frozenSDM: Math.max(0, currentFrozen - orderAmount)
                }).then(() => {
                    db.ref('game_orders/' + key).remove();
                    Swal.fire('ØªÙ… Ø§Ù„Ø±ÙØ¶ âŒ', 'Ø£Ø¹ÙŠØ¯ Ø±ØµÙŠØ¯ SDM Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…', 'info');
                });
            }
        });
    }
</script>
</body>
</html>
